<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Admin - Bug Reports</title>

  <!-- Styles & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/ADMIN/feedbacks/feedback.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* ===== SAME FILTER BAR STYLES AS YOUR OTHER PAGES ===== */
    .filter-wrap { border-radius: 16px; overflow: hidden; box-shadow: 0 6px 22px rgba(0,0,0,.08); background: #fff; }
    .filter-head { background: #5a1f0f; color: #ffd9b3; padding: 10px 16px; display: flex; align-items: center; gap: 10px; font-weight: 700; border-top-left-radius: 16px; border-top-right-radius: 16px; }
    .filter-head .bi { color: #ffbb66; font-size: 1.05rem; }
    .filter-body { padding: 14px; display: grid; grid-template-columns: 1fr 200px 220px; gap: 10px; align-items: center; }
    .search-field { position: relative; }
    .search-field .bi-search { position: absolute; top: 50%; left: 12px; transform: translateY(-50%); opacity: .6; }
    .search-field input { padding-left: 36px; border-radius: 10px !important; border: 1px solid #eee; height: 40px; background: #fff; }
    .filter-body select { border-radius: 10px !important; border: 1px solid #eee !important; height: 40px; background: #fff; }

    /* Sortable headers (exact behavior) */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable .arrow { opacity: .5; margin-left: .25rem; }
    th.sortable.active .arrow { opacity: 1; }

    @media (max-width: 992px) { .filter-body { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 576px) { .filter-body { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Sidebar logic + header initials -->
    <script>
      // Helpers to compute initials and a nice tooltip label
      function getInitials(info = {}) {
        const f = (info.firstName || "").trim();
        const l = (info.lastName  || "").trim();
        const u = (info.username  || "").trim();
        const e = (info.email     || "").trim();

        if (f || l) {
          let letters = "";
          if (f) letters += f[0];
          if (l) letters += l[0];
          else if (f.length > 1) letters += f[1];
          return letters.toUpperCase().slice(0,2) || "UU";
        }
        if (u) {
          const cleaned = u.replace(/[^A-Za-z0-9]/g, "").toUpperCase();
          return (cleaned || "UU").slice(0,2);
        }
        if (e && e.includes("@")) {
          const local = e.split("@")[0].replace(/[^A-Za-z0-9]/g, "").toUpperCase();
          return (local || "UU").slice(0,2);
        }
        return "UU";
      }
      function bestFull(info = {}) {
        const full = [info.firstName, info.middleName, info.lastName].filter(Boolean).join(" ").trim();
        return full || info.username || info.email || "User";
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetch("/ADMIN/components/test.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;

            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");
            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }

            document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
              toggle.addEventListener('click', e => {
                e.preventDefault();
                const parent = toggle.closest('.has-submenu');
                parent.classList.toggle('open');
                toggle.setAttribute('aria-expanded', String(toggle.getAttribute('aria-expanded') !== 'true'));
              });
            });
          })
          .catch(err => console.error("Failed to load sidebar:", err));

        // Header user (show INITIALS with tooltip full name/username/email)
        let userData = null;
        try { userData = JSON.parse(localStorage.getItem("user")) || JSON.parse(sessionStorage.getItem("user")); } catch {}
        if (!userData) {
          window.location.href = "../login/login.html";
          return;
        }
        const el = document.getElementById("Username");
        if (el) {
          el.textContent = getInitials(userData);
          el.title = bestFull(userData);
        }
      });
    </script>

    <!-- Main -->
    <div class="main">
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Title -->
      <section class="content px-4">
        <h2 class="mt-4 mb-1 fw-bold text-center">Bug Report Inbox</h2>
        <p class="text-muted text-center mb-3">View all submitted issues, suggestions, and system-related reports from users.</p>

        <!-- ===== Filter Bar (EXACT STRUCTURE) ===== -->
        <div class="container-fluid px-0 mb-3">
          <div class="filter-wrap">
            <div class="filter-head">
              <i class="bi bi-exclamation-circle"></i>
              <span>Reports</span>
            </div>
            <div class="filter-body">
              <!-- Search -->
              <div class="search-field">
                <i class="bi bi-search"></i>
                <input id="filterSearch" type="text" class="form-control" placeholder="Search by title, sender, message..." />
              </div>

              <!-- Status -->
              <select id="filterStatus" class="form-select">
                <option value="all" selected>All Statuses</option>
                <option value="pending">Pending</option>
                <option value="resolved">Resolved</option>
                <option value="open">Open</option>
              </select>

              <!-- Sort -->
              <select id="filterSort" class="form-select">
                <option value="dateDesc" selected>Sort: Date (Newest → Oldest)</option>
                <option value="dateAsc">Sort: Date (Oldest → Newest)</option>
                <option value="titleAsc">Sort: Title (A → Z)</option>
                <option value="titleDesc">Sort: Title (Z → A)</option>
                <option value="statusResolvedFirst">Sort: Status (Resolved → Pending/Open)</option>
                <option value="statusPendingFirst">Sort: Status (Pending/Open → Resolved)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- (Optional) Alert like the others -->
        <div id="bugAlert" class="alert alert-success d-none" role="alert"></div>

        <!-- ===== Table Wrapper (EXACT STRUCTURE) ===== -->
        <div class="container-fluid px-0">
          <div class="table-responsive shadow bg-white rounded p-4" style="max-width: 100%; width: 100%;">
            <table class="table table-bordered align-middle text-center w-100">
              <thead class="table-light">
                <tr>
                  <th class="sortable" data-sort="index"># <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="title">Bug Title <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="sender">Sender <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="date">Date <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="type">Type <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="status">Status <span class="arrow">↕</span></th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody id="feedbackTable">
                <tr><td colspan="7">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Bug Report Modal (unchanged structure) -->
  <div class="modal fade" id="viewBugModal" tabindex="-1" aria-labelledby="viewBugModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewBugModalLabel">Bug Report Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="bugDetailsBody"></div>
        <div class="modal-footer flex-column flex-md-row gap-2">
          <textarea id="itReply" class="form-control" placeholder="Add IT response..." rows="2"></textarea>
          <div class="w-100 d-flex justify-content-end gap-2">
            <button id="reopenBtn" class="btn btn-warning d-none" type="button">Reopen</button>
            <button id="markResolvedBtn" class="btn btn-success d-none" type="button">Mark as Resolved</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- App Alert Modal -->
<div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div id="appAlertHeader" class="modal-header">
        <h5 class="modal-title" id="appAlertTitle">Notice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div id="appAlertBody" class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>


  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  function showAppAlert(message, { title = "Notice", variant = "primary" } = {}) {
    const header = document.getElementById("appAlertHeader");
    const titleEl = document.getElementById("appAlertTitle");
    const bodyEl  = document.getElementById("appAlertBody");

    header.className = "modal-header";
    const bg = {
      primary:  "bg-primary text-white",
      success:  "bg-success text-white",
      danger:   "bg-danger text-white",
      warning:  "bg-warning",
    }[variant] || "bg-primary text-white";
    header.classList.add(...bg.split(" "));

    titleEl.textContent = title;
    bodyEl.textContent  = message;

    bootstrap.Modal.getOrCreateInstance(document.getElementById("appAlertModal")).show();
  }
</script>


  <!-- Page JS (same filter/sort behavior as other pages; API unchanged) -->
  <script>
    const API_BASE = "http://localhost:5000/api";
    const BACKEND_BASE = "http://localhost:5000";

    let currentBugId = null;
    let allBugs = [];

    /* ===== Helpers (dates identical logic) ===== */
    function toMillis(v) {
      if (!v) return 0;
      if (v._seconds) return v._seconds * 1000;
      if (typeof v?.toMillis === "function") return v.toMillis();
      const n = Number(v);
      if (!Number.isNaN(n)) return n;
      const t = new Date(v).getTime();
      return Number.isNaN(t) ? 0 : t;
    }
    function toDisplayDate(v) { const ms = toMillis(v); return ms ? new Date(ms).toLocaleString() : ""; }
    function titleCase(s) { return String(s || "").toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); }

    // drop-in helper (put near your other helpers)
function hideModalThen(modalEl, next) {
  const inst = bootstrap.Modal.getOrCreateInstance(modalEl);
  const onHidden = () => {
    modalEl.removeEventListener('hidden.bs.modal', onHidden);
    next();
  };
  modalEl.addEventListener('hidden.bs.modal', onHidden);
  inst.hide();
}


    /* ===== Filter + Sort state (same pattern) ===== */
    const tableBody = document.getElementById("feedbackTable");
    const elSearch  = document.getElementById("filterSearch");
    const elStatus  = document.getElementById("filterStatus");
    const elSort    = document.getElementById("filterSort");

    let sortKey = 'index';
    let sortDir = 'asc';

    function statusRank(s) {
      const v = String(s || 'pending').toLowerCase();
      if (v === 'resolved') return 0;
      if (v === 'open')     return 1;
      return 2; // pending/others
    }

    function applyFiltersArray(list){
      const q = (elSearch.value || '').toLowerCase().trim();
      const statusVal = (elStatus.value || 'all').toLowerCase();

      return list.filter(bug => {
        const bugStatusLc = String(bug.status || "pending").toLowerCase();
        if (statusVal !== "all" && bugStatusLc !== statusVal) return false;

        if (!q) return true;
        const hay = [
          bug.title, bug.createdBy, bug.description, bug.severity
        ].map(v => (v || '').toString().toLowerCase()).join(' ');
        return hay.includes(q);
      });
    }

    function sortByDropdown(a, b) {
      const mode = elSort.value;
      const aTitle = (a.title || '').toLowerCase();
      const bTitle = (b.title || '').toLowerCase();
      const aDate = toMillis(a.createdAt);
      const bDate = toMillis(b.createdAt);
      const aStatus = statusRank(a.status);
      const bStatus = statusRank(b.status);

      if (mode === 'dateDesc') return bDate - aDate;
      if (mode === 'dateAsc')  return aDate - bDate;
      if (mode === 'titleAsc') return aTitle.localeCompare(bTitle);
      if (mode === 'titleDesc')return bTitle.localeCompare(aTitle);
      if (mode === 'statusResolvedFirst') return aStatus - bStatus;
      if (mode === 'statusPendingFirst')  return bStatus - aStatus;
      return 0;
    }

    function sortByHeader(a, b) {
      let av, bv;
      switch (sortKey) {
        case 'index':  av=a.__index;                bv=b.__index; break;
        case 'title':  av=(a.title||'').toLowerCase();  bv=(b.title||'').toLowerCase(); break;
        case 'sender': av=(a.createdBy||'').toLowerCase(); bv=(b.createdBy||'').toLowerCase(); break;
        case 'date':   av=toMillis(a.createdAt);    bv=toMillis(b.createdAt); break;
        case 'type':   av=(a.severity||'').toLowerCase();  bv=(b.severity||'').toLowerCase(); break;
        case 'status': av=statusRank(a.status);     bv=statusRank(b.status); break;
        default:       av=a.__index;                bv=b.__index;
      }
      if (av===bv) return 0;
      const d = av>bv ? 1 : -1;
      return (sortDir==='asc') ? d : -d;
    }

    function renderBugTable(list){
      tableBody.innerHTML = '';

      const filtered = applyFiltersArray(list);
      const sorted = filtered.sort((a,b)=>{
        const d = sortByDropdown(a,b);
        return d !== 0 ? d : sortByHeader(a,b);
      });

      if (!sorted.length){
        tableBody.innerHTML = '<tr><td colspan="7">No matching reports.</td></tr>';
        return;
      }

      sorted.forEach((bug, i) => {
        const statusLc = String(bug.status || "Pending").toLowerCase();
        let badgeClass = "badge-pending";
        if (statusLc === "resolved") badgeClass = "badge-resolved";
        else if (statusLc === "open") badgeClass = "badge-open";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${(bug.title && String(bug.title).trim()) ? bug.title : "No Title"}</td>
          <td>${bug.createdBy && bug.createdBy !== "Anonymous" ? bug.createdBy : "Anonymous"}</td>
          <td>${toDisplayDate(bug.createdAt)}</td>
          <td>${titleCase(bug.severity || "Bug")}</td>
          <td><span class="badge badge-status ${badgeClass}">${bug.status || "Pending"}</span></td>
          <td class="text-primary" style="cursor:pointer;">View</td>
        `;
        row.addEventListener("click", () => showBugModal(bug));
        tableBody.appendChild(row);
      });
    }

    /* ===== Modal + Status update (unchanged) ===== */
    function showBugModal(bug) {
      currentBugId = bug.id;

      const statusLc = String(bug.status || "Pending").toLowerCase();
      const badgeClass = statusLc === "resolved" ? "badge-resolved"
                      : statusLc === "open" ? "badge-open"
                      : "badge-pending";

      const sender = bug.createdBy && bug.createdBy !== "Anonymous" ? bug.createdBy : "Anonymous";
      const dateStr = toDisplayDate(bug.createdAt);

      // Screenshot handling
      let screenshotHtml = "<em>No screenshot provided.</em>";
      let localScreenshotUrl = null;
      try { if (bug.id) localScreenshotUrl = localStorage.getItem(`bugScreenshotUrl_${bug.id}`); } catch {}
      if (localScreenshotUrl) {
        screenshotHtml = `<img src="${localScreenshotUrl}" class="img-fluid mt-2 border rounded" style="max-height: 300px;"/>`;
      } else if (bug.screenshotPath && /\.(jpe?g|png|gif|webp)$/i.test(bug.screenshotPath)) {
        const imgSrc = bug.screenshotPath.startsWith('/uploads/')
          ? BACKEND_BASE + bug.screenshotPath
          : bug.screenshotPath;
        screenshotHtml = `<img src="${imgSrc}" class="img-fluid mt-2 border rounded" style="max-height: 300px;"/>`;
      }

      const bugTitle = (bug.title && String(bug.title).trim()) ? bug.title : "No Title";
      document.getElementById("viewBugModalLabel").textContent = bugTitle;
      document.getElementById("bugDetailsBody").innerHTML = `
        <p><strong>Bug Title:</strong> ${bugTitle}</p>
        <p><strong>Sender:</strong> ${sender}</p>
        <p><strong>Submitted:</strong> ${dateStr}</p>
        <p><strong>Severity:</strong> ${bug.severity || "Bug"}</p>
        <p><strong>Status:</strong> <span class="badge badge-status ${badgeClass}">${bug.status || "Pending"}</span></p>
        <p><strong>Message:</strong></p>
        <div class="bg-light border rounded p-2">${bug.description || "No message."}</div>
        <p class="mt-3"><strong>Screenshot:</strong><br>${screenshotHtml}</p>
      `;

      document.getElementById("itReply").value = bug.reply || "";

      // Show/hide action buttons
      document.getElementById("markResolvedBtn").classList.toggle("d-none", statusLc === "resolved");
      document.getElementById("reopenBtn").classList.toggle("d-none", statusLc !== "resolved");

      new bootstrap.Modal(document.getElementById("viewBugModal")).show();
    }

  // REPLACE your updateBugStatus with this version
function updateBugStatus(status) {
  if (!currentBugId) return;
  const reply = document.getElementById("itReply").value.trim();

  fetch(`${API_BASE}/bug-reports/${currentBugId}/status`, {
    method: "PATCH",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status, reply })
  })
    .then(res => res.json())
    .then(result => {
      const viewEl = document.getElementById("viewBugModal");

      if (result.success) {
        // close the bug-details modal first, THEN show alert
        hideModalThen(viewEl, () => {
          showAppAlert(
            `Bug report has been marked as ${status}.`,
            { title: "Success", variant: "success" }
          );

          // reload AFTER the alert is dismissed
          const alertEl = document.getElementById("appAlertModal");
          const onAlertHidden = () => {
            alertEl.removeEventListener('hidden.bs.modal', onAlertHidden);
            location.reload();
          };
          alertEl.addEventListener('hidden.bs.modal', onAlertHidden);
        });
      } else {
        // also avoid overlap on errors
        hideModalThen(viewEl, () => {
          showAppAlert("Failed to update status.", { title: "Error", variant: "danger" });
        });
      }
    })
    .catch(err => {
      console.error("Status update failed:", err);
      // close first to avoid stacking
      const viewEl = document.getElementById("viewBugModal");
      hideModalThen(viewEl, () => {
        showAppAlert("Server error while updating status.", { title: "Error", variant: "danger" });
      });
    });
}



    document.getElementById("markResolvedBtn").addEventListener("click", () => updateBugStatus("Resolved"));
    document.getElementById("reopenBtn").addEventListener("click", () => updateBugStatus("Pending"));

    /* ===== Fetch + Normalize (unchanged) ===== */
    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        credentials: "include",
        headers: { "Accept": "application/json", ...(options.headers || {}) },
        ...options
      });
      const text = await res.text();
      let json = {};
      try { json = JSON.parse(text); } catch {}
      if (!res.ok) {
        console.error("Fetch failed", res.status, text);
        throw new Error(json?.message || json?.error || `HTTP ${res.status}`);
      }
      return json;
    }

    function normalizeBugs(raw) {
      let list = [];
      if (Array.isArray(raw)) list = raw;
      else if (Array.isArray(raw?.reports)) list = raw.reports;
      else if (Array.isArray(raw?.bugs)) list = raw.bugs;
      else if (Array.isArray(raw?.data)) list = raw.data;
      else if (Array.isArray(raw?.items)) list = raw.items;
      else if (Array.isArray(raw?.result)) list = raw.result;
      else if (raw?.success && Array.isArray(raw?.payload)) list = raw.payload;

      if (!list.length && raw && typeof raw === "object") {
        const firstArray = Object.values(raw).find(v => Array.isArray(v));
        if (firstArray) list = firstArray;
      }

      return list.map((b, i) => {
        const id = b.id || b._id || b.reportId || b.ticketId || b.key;
        const title = b.title || b.subject || b.summary || "";
        const description = b.description || b.message || b.details || b.body || "";
        const createdAt = b.createdAt || b.created_at || b.timestamp || b.created || b.date;
        const createdBy = b.createdBy || b.sender || b.user || b.author || b.reporter || "Anonymous";
        const severity = b.severity || b.type || b.category || "Bug";
        const status = b.status || b.state || "Pending";
        const screenshotPath = b.screenshotPath || b.screenshot || b.screenshotUrl || b.attachment || b.imageUrl;

        return { id, title, description, createdAt, createdBy, severity, status, screenshotPath, __index: i, ...b };
      });
    }

    // Initial load
    (async function loadBugReports() {
      try {
        const data = await fetchJSON(`${API_BASE}/bug-reports`);
        allBugs = normalizeBugs(data);
        renderBugTable(allBugs);
      } catch (err) {
        console.error("❌ Failed to load bug reports:", err);
        tableBody.innerHTML = '<tr><td colspan="7">Error loading reports.</td></tr>';
      }
    })();

    // Wire filters + header sorting (exact pattern)
    elSearch.addEventListener('input', () => renderBugTable(allBugs));
    elStatus.addEventListener('change', () => renderBugTable(allBugs));
    elSort.addEventListener('change', () => renderBugTable(allBugs));

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-sort');
          if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
          else { sortKey = key; sortDir = 'asc'; }

          document.querySelectorAll('th.sortable').forEach(h => h.classList.remove('active'));
          th.classList.add('active');
          const arrow = th.querySelector('.arrow');
          if (arrow) arrow.textContent = (sortDir === 'asc') ? '▲' : '▼';
          document.querySelectorAll('th.sortable').forEach(h => {
            if (h !== th) {
              const s = h.querySelector('.arrow');
              if (s) s.textContent = '↕';
            }
          });

          renderBugTable(allBugs);
        });
      });
    });

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/ADMIN/login/login.html";
    }
  </script>
</body>
</html>
