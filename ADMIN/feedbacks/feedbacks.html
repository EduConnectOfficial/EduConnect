<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Admin - Bug Reports</title>

  <!-- Styles & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/ADMIN/feedbacks/feedback.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    .filter-wrap {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 6px 22px rgba(0, 0, 0, .08);
      background: #fff;
    }

    .filter-head {
      background: #5a1f0f;
      color: #ffd9b3;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
    }

    .filter-head .bi {
      color: #ffbb66;
      font-size: 1.05rem;
    }

    .filter-body {
      padding: 14px;
      display: grid;
      grid-template-columns: 1fr 200px 220px;
      gap: 10px;
      align-items: center;
    }

    .search-field {
      position: relative;
    }

    .search-field .bi-search {
      position: absolute;
      top: 50%;
      left: 12px;
      transform: translateY(-50%);
      opacity: .6;
    }

    .search-field input {
      padding-left: 36px;
      border-radius: 10px !important;
      border: 1px solid #eee;
      height: 40px;
      background: #fff;
    }

    .filter-body select {
      border-radius: 10px !important;
      border: 1px solid #eee !important;
      height: 40px;
      background: #fff;
    }

    th.sortable {
      cursor: pointer;
      user-select: none;
    }

    th.sortable .arrow {
      opacity: .5;
      margin-left: .25rem;
    }

    th.sortable.active .arrow {
      opacity: 1;
    }

    @media (max-width: 992px) {
      .filter-body {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 576px) {
      .filter-body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <script>
      function getInitials(info = {}) {
        const f = (info.firstName || "").trim();
        const l = (info.lastName || "").trim();
        const u = (info.username || "").trim();
        const e = (info.email || "").trim();
        if (f || l) {
          let letters = "";
          if (f) letters += f[0];
          if (l) letters += l[0];
          else if (f.length > 1) letters += f[1];
          return letters.toUpperCase().slice(0, 2) || "UU";
        }
        if (u) return (u.replace(/[^A-Za-z0-9]/g, "").toUpperCase() || "UU").slice(0, 2);
        if (e && e.includes("@")) return (e.split("@")[0].replace(/[^A-Za-z0-9]/g, "").toUpperCase() || "UU").slice(0, 2);
        return "UU";
      }
      function bestFull(info = {}) {
        const full = [info.firstName, info.middleName, info.lastName].filter(Boolean).join(" ").trim();
        return full || info.username || info.email || "User";
      }
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/ADMIN/components/test.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;
            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");
            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }
            document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
              toggle.addEventListener('click', e => {
                e.preventDefault();
                const parent = toggle.closest('.has-submenu');
                parent.classList.toggle('open');
                toggle.setAttribute('aria-expanded', String(toggle.getAttribute('aria-expanded') !== 'true'));
              });
            });
          });
        let userData = null;
        try { userData = JSON.parse(localStorage.getItem("user")) || JSON.parse(sessionStorage.getItem("user")); } catch { }
        if (!userData) { window.location.href = "../login/login.html"; return; }
        const el = document.getElementById("Username");
        if (el) { el.textContent = getInitials(userData); el.title = bestFull(userData); }
      });
    </script>

    <div class="main">
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn"><i class="fas fa-user-circle"></i><span id="Username" class="username"
            style="font-size:14px;"></span></button>
      </header>

      <section class="content px-4">
        <h2 class="mt-4 mb-1 fw-bold text-center">Bug Report Inbox</h2>
        <p class="text-muted text-center mb-3">View all submitted issues, suggestions, and system-related reports from
          users.</p>

        <div class="container-fluid px-0 mb-3">
          <div class="filter-wrap">
            <div class="filter-head"><i class="bi bi-exclamation-circle"></i><span>Reports</span></div>
            <div class="filter-body">
              <div class="search-field"><i class="bi bi-search"></i><input id="filterSearch" type="text"
                  class="form-control" placeholder="Search by title, sender, message..." /></div>
              <select id="filterStatus" class="form-select">
                <option value="all" selected>All Statuses</option>
                <option value="pending">Pending</option>
                <option value="resolved">Resolved</option>
                <option value="open">Open</option>
              </select>
              <select id="filterSort" class="form-select">
                <option value="dateDesc" selected>Sort: Date (Newest → Oldest)</option>
                <option value="dateAsc">Sort: Date (Oldest → Newest)</option>
                <option value="titleAsc">Sort: Title (A → Z)</option>
                <option value="titleDesc">Sort: Title (Z → A)</option>
                <option value="statusResolvedFirst">Sort: Status (Resolved → Pending/Open)</option>
                <option value="statusPendingFirst">Sort: Status (Pending/Open → Resolved)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="container-fluid px-0">
          <div class="table-responsive shadow bg-white rounded p-4">
            <table class="table table-bordered align-middle text-center w-100">
              <thead class="table-light">
                <tr>
                  <th class="sortable" data-sort="index"># <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="title">Bug Title <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="sender">Sender <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="date">Date <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="type">Type <span class="arrow">↕</span></th>
                  <th class="sortable" data-sort="status">Status <span class="arrow">↕</span></th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody id="feedbackTable">
                <tr>
                  <td colspan="7">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Bug Report Modal -->
  <div class="modal fade" id="viewBugModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewBugModalLabel">Bug Report Details</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="bugDetailsBody"></div>
        <div class="modal-footer flex-column flex-md-row gap-2">
          <textarea id="itReply" class="form-control" placeholder="Add IT response..." rows="2"></textarea>
          <div class="w-100 d-flex justify-content-end gap-2">
            <button id="reopenBtn" class="btn btn-warning d-none" type="button">Reopen</button>
            <button id="markResolvedBtn" class="btn btn-success d-none" type="button">Mark as Resolved</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- App Alert Modal -->
  <div class="modal fade" id="appAlertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div id="appAlertHeader" class="modal-header">
          <h5 class="modal-title" id="appAlertTitle">Notice</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div id="appAlertBody" class="modal-body"></div>
        <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function showAppAlert(msg, { title = "Notice", variant = "primary" } = {}) { const h = document.getElementById("appAlertHeader"), t = document.getElementById("appAlertTitle"), b = document.getElementById("appAlertBody"); h.className = "modal-header"; const bg = { primary: "bg-primary text-white", success: "bg-success text-white", danger: "bg-danger text-white", warning: "bg-warning" }[variant] || "bg-primary text-white"; h.classList.add(...bg.split(" ")); t.textContent = title; b.textContent = msg; bootstrap.Modal.getOrCreateInstance(document.getElementById("appAlertModal")).show(); }
    const API_BASE = "http://localhost:5000/api"; let currentBugId = null, allBugs = [];
    function toMillis(v) { if (!v) return 0; if (v._seconds) return v._seconds * 1000; if (typeof v?.toMillis === "function") return v.toMillis(); const n = Number(v); if (!Number.isNaN(n)) return n; const t = new Date(v).getTime(); return Number.isNaN(t) ? 0 : t; }
    function toDisplayDate(v) { const ms = toMillis(v); return ms ? new Date(ms).toLocaleString() : ""; }
    function titleCase(s) { return String(s || "").toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); }
    function hideModalThen(m, n) { const i = bootstrap.Modal.getOrCreateInstance(m); const h = () => { m.removeEventListener("hidden.bs.modal", h); n(); }; m.addEventListener("hidden.bs.modal", h); i.hide(); }
    const tableBody = document.getElementById("feedbackTable"), elSearch = document.getElementById("filterSearch"), elStatus = document.getElementById("filterStatus"), elSort = document.getElementById("filterSort");
    let sortKey = "index", sortDir = "asc";
    function statusRank(s) { const v = String(s || "pending").toLowerCase(); if (v === "resolved") return 0; if (v === "open") return 1; return 2; }
    function applyFiltersArray(list) { const q = (elSearch.value || "").toLowerCase().trim(); const st = (elStatus.value || "all").toLowerCase(); return list.filter(b => { const lc = String(b.status || "pending").toLowerCase(); if (st !== "all" && lc !== st) return false; if (!q) return true; const hay = [b.title, b.createdBy, b.description, b.severity].map(v => (v || "").toString().toLowerCase()).join(" "); return hay.includes(q); }); }
    function sortByDropdown(a, b) { const m = elSort.value, A = (a.title || "").toLowerCase(), B = (b.title || "").toLowerCase(), dA = toMillis(a.createdAt), dB = toMillis(b.createdAt), sA = statusRank(a.status), sB = statusRank(b.status); if (m === "dateDesc") return dB - dA; if (m === "dateAsc") return dA - dB; if (m === "titleAsc") return A.localeCompare(B); if (m === "titleDesc") return B.localeCompare(A); if (m === "statusResolvedFirst") return sA - sB; if (m === "statusPendingFirst") return sB - sA; return 0; }
    function sortByHeader(a, b) { let av, bv; switch (sortKey) { case "index": av = a.__index; bv = b.__index; break; case "title": av = (a.title || "").toLowerCase(); bv = (b.title || "").toLowerCase(); break; case "sender": av = (a.createdBy || "").toLowerCase(); bv = (b.createdBy || "").toLowerCase(); break; case "date": av = toMillis(a.createdAt); bv = toMillis(b.createdAt); break; case "type": av = (a.severity || "").toLowerCase(); bv = (b.severity || "").toLowerCase(); break; case "status": av = statusRank(a.status); bv = statusRank(b.status); break; default: av = a.__index; bv = b.__index; }if (av === bv) return 0; const d = av > bv ? 1 : -1; return sortDir === "asc" ? d : -d; }
    function renderBugTable(list) { tableBody.innerHTML = ""; const f = applyFiltersArray(list), s = f.sort((a, b) => { const d = sortByDropdown(a, b); return d !== 0 ? d : sortByHeader(a, b); }); if (!s.length) { tableBody.innerHTML = '<tr><td colspan="7">No matching reports.</td></tr>'; return; } s.forEach((bug, i) => { const lc = String(bug.status || "Pending").toLowerCase(); let badge = "badge-pending"; if (lc === "resolved") badge = "badge-resolved"; else if (lc === "open") badge = "badge-open"; const r = document.createElement("tr"); r.innerHTML = `<td>${i + 1}</td><td>${bug.title?.trim() || "No Title"}</td><td>${bug.createdBy && bug.createdBy !== "Anonymous" ? bug.createdBy : "Anonymous"}</td><td>${toDisplayDate(bug.createdAt)}</td><td>${titleCase(bug.severity || "Bug")}</td><td><span class="badge badge-status ${badge}">${bug.status || "Pending"}</span></td><td class="text-primary" style="cursor:pointer;">View</td>`; r.addEventListener("click", () => showBugModal(bug)); tableBody.appendChild(r); }); }
    function showBugModal(bug) { currentBugId = bug.id; const lc = String(bug.status || "Pending").toLowerCase(), badge = lc === "resolved" ? "badge-resolved" : lc === "open" ? "badge-open" : "badge-pending"; const sender = bug.createdBy && bug.createdBy !== "Anonymous" ? bug.createdBy : "Anonymous"; const dateStr = toDisplayDate(bug.createdAt); let screenshotHtml = "<em>No screenshot provided.</em>"; if (bug.screenshot?.downloadUrl) { screenshotHtml = `<img src="${bug.screenshot.downloadUrl}" class="img-fluid mt-2 border rounded" style="max-height:300px;"/>`; } const title = bug.title?.trim() || "No Title"; document.getElementById("viewBugModalLabel").textContent = title; document.getElementById("bugDetailsBody").innerHTML = `<p><strong>Bug Title:</strong> ${title}</p><p><strong>Sender:</strong> ${sender}</p><p><strong>Submitted:</strong> ${dateStr}</p><p><strong>Severity:</strong> ${bug.severity || "Bug"}</p><p><strong>Status:</strong> <span class="badge badge-status ${badge}">${bug.status || "Pending"}</span></p><p><strong>Message:</strong></p><div class="bg-light border rounded p-2">${bug.description || "No message."}</div><p class="mt-3"><strong>Screenshot:</strong><br>${screenshotHtml}</p>`; document.getElementById("itReply").value = bug.reply || ""; document.getElementById("markResolvedBtn").classList.toggle("d-none", lc === "resolved"); document.getElementById("reopenBtn").classList.toggle("d-none", lc !== "resolved"); new bootstrap.Modal(document.getElementById("viewBugModal")).show(); }
    function updateBugStatus(st) { if (!currentBugId) return; const reply = document.getElementById("itReply").value.trim(); fetch(`${API_BASE}/bug-reports/${currentBugId}/status`, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ status: st, reply }) }).then(r => r.json()).then(res => { const m = document.getElementById("viewBugModal"); if (res.success) { hideModalThen(m, () => { showAppAlert(`Bug report has been marked as ${st}.`, { title: "Success", variant: "success" }); const a = document.getElementById("appAlertModal"); const h = () => { a.removeEventListener("hidden.bs.modal", h); location.reload(); }; a.addEventListener("hidden.bs.modal", h); }); } else { hideModalThen(m, () => showAppAlert("Failed to update status.", { title: "Error", variant: "danger" })); } }).catch(e => { console.error("Status update failed:", e); hideModalThen(document.getElementById("viewBugModal"), () => showAppAlert("Server error while updating status.", { title: "Error", variant: "danger" })); }); }
    document.getElementById("markResolvedBtn").addEventListener("click", () => updateBugStatus("Resolved"));
    document.getElementById("reopenBtn").addEventListener("click", () => updateBugStatus("Pending"));
    async function fetchJSON(url, opt = {}) { const r = await fetch(url, { headers: { "Accept": "application/json", ...(opt.headers || {}) }, ...opt }); const t = await r.text(); let j = {}; try { j = JSON.parse(t); } catch { } if (!r.ok) throw new Error(j?.message || `HTTP ${r.status}`); return j; }
    function normalizeBugs(raw) { let l = []; if (Array.isArray(raw)) l = raw; else if (Array.isArray(raw?.reports)) l = raw.reports; else if (Array.isArray(raw?.bugs)) l = raw.bugs; else if (Array.isArray(raw?.data)) l = raw.data; return l.map((b, i) => ({ id: b.id || b._id, title: b.title || "", description: b.description || "", createdAt: b.createdAt, createdBy: b.createdBy || "Anonymous", severity: b.severity || "Bug", status: b.status || "Pending", screenshot: b.screenshot || null, __index: i, ...b })); }
    (async () => { try { const d = await fetchJSON(`${API_BASE}/bug-reports`); allBugs = normalizeBugs(d); renderBugTable(allBugs); } catch (e) { console.error("❌ Failed to load bug reports:", e); tableBody.innerHTML = '<tr><td colspan="7">Error loading reports.</td></tr>'; } })();
    elSearch.addEventListener("input", () => renderBugTable(allBugs)); elStatus.addEventListener("change", () => renderBugTable(allBugs)); elSort.addEventListener("change", () => renderBugTable(allBugs));
    document.querySelectorAll("th.sortable").forEach(th => { th.addEventListener("click", () => { const k = th.getAttribute("data-sort"); if (sortKey === k) sortDir = sortDir === "asc" ? "desc" : "asc"; else { sortKey = k; sortDir = "asc"; } document.querySelectorAll("th.sortable").forEach(h => h.classList.remove("active")); th.classList.add("active"); const arrow = th.querySelector(".arrow"); if (arrow) arrow.textContent = sortDir === "asc" ? "▲" : "▼"; renderBugTable(allBugs); }); });
    function logoutUser() { localStorage.clear(); sessionStorage.clear(); window.location.href = "/ADMIN/login/login.html"; }
  </script>
</body>

</html>