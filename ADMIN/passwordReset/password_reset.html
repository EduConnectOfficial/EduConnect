<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Admin — Request Password Reset</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- (Optional) Your styles -->
  <link rel="stylesheet" href="reset.css" />

  <style>
    /* Make absolutely sure the modal sits above any custom elements */
    .modal { z-index: 2000; }
    .modal-backdrop { z-index: 1990; }

    /* Ensure readable header text for all variants, including warning/info/light */
    .modal-header.bg-warning,
    .modal-header.bg-info,
    .modal-header.bg-light { color: #1f1f1f; }
    .modal-header.bg-primary,
    .modal-header.bg-success,
    .modal-header.bg-danger,
    .modal-header.bg-secondary,
    .modal-header.bg-dark { color: #fff; }
  </style>
</head>
<body class="bg-light">

  <!-- Logos (optional) -->
  <div class="top-logo text-center brand my-3">
    <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
    <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo" />
  </div>

  <div class="container d-flex flex-column justify-content-center align-items-center vh-100">
    <div class="card p-4 shadow" style="max-width: 400px; width: 100%;">
      <h4 class="text-center mb-4">Reset Your Password</h4>

      <form id="resetForm" novalidate>
        <div class="mb-3">
          <label for="email" class="form-label text-dark">Enter your email</label>
          <input type="email" class="form-control" id="email" placeholder="you@example.com" required />
        </div>

        <div id="error" class="text-danger small mb-2"></div>

        <button id="sendBtn" type="submit" class="btn login-btn text-white w-100" style="background:#7A2810;">
          Send Code
        </button>
      </form>

      <p class="text-center mt-3 mb-0">
        <a href="/ADMIN/login/login.html">Back to Login</a>
      </p>
    </div>
  </div>

  <!-- App Alert Modal (Bootstrap) -->
  <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div id="appAlertHeader" class="modal-header">
          <h5 class="modal-title" id="appAlertTitle">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="appAlertBody" class="modal-body text-dark"></div>
        <div class="modal-footer">
          <button id="appAlertOk" type="button" class="btn btn-upload" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (required for modal usage in showAppAlert) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Small helper to show a Bootstrap modal alert
    // Redirect support: pass onOkRedirectTo to redirect AFTER user closes via OK
    function showAppAlert(message, {
      title = "Notice",
      variant = "primary",
      onOkRedirectTo = null,
      autoHideMs = null   // optional: auto-hide after N ms
    } = {}) {
      const header = document.getElementById("appAlertHeader");
      const titleEl = document.getElementById("appAlertTitle");
      const bodyEl = document.getElementById("appAlertBody");
      const okBtn = document.getElementById("appAlertOk");

      // Reset header classes then apply bg + text color
      header.className = "modal-header";
      const bgClass = {
        primary: "bg-primary",
        success: "bg-success",
        danger: "bg-danger",
        warning: "bg-warning",
        info: "bg-info",
        secondary: "bg-secondary",
        dark: "bg-dark",
        light: "bg-light"
      }[variant] || "bg-primary";
      header.classList.add(bgClass);

      titleEl.textContent = title;
      bodyEl.textContent = message;

      const modalEl = document.getElementById("appAlertModal");
      const m = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: true, keyboard: true });

      // Clean up any previous handlers to avoid stacking
      okBtn.replaceWith(okBtn.cloneNode(true));
      const newOkBtn = document.getElementById("appAlertOk");

      // If we want to redirect after OK/close, hook into hidden event
      const handleHidden = () => {
        modalEl.removeEventListener('hidden.bs.modal', handleHidden);
        if (onOkRedirectTo) window.location.href = onOkRedirectTo;
      };

      if (onOkRedirectTo) {
        modalEl.addEventListener('hidden.bs.modal', handleHidden);
      }

      newOkBtn.addEventListener('click', () => {
        m.hide();
      });

      m.show();

      // Optional auto-hide (fallback) so users still move on if they don't press OK
      if (autoHideMs && Number.isFinite(autoHideMs)) {
        setTimeout(() => {
          // Only hide if still visible to avoid double work
          const isShown = modalEl.classList.contains('show');
          if (isShown) m.hide();
        }, autoHideMs);
      }
    }

    // Request-reset flow:
    // 1) POST /send-reset-code with { email }
    // 2) On success, stash email and move to verify_code.html AFTER modal
    const API_BASE = "http://localhost:5000";

    document.getElementById("resetForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const emailInput = document.getElementById("email");
      const email = emailInput.value.trim().toLowerCase();
      const errorDiv = document.getElementById("error");
      const sendBtn = document.getElementById("sendBtn");

      errorDiv.textContent = "";

      if (!email) {
        errorDiv.textContent = "Please enter your email.";
        emailInput.focus();
        return;
      }

      // Disable button while sending
      sendBtn.disabled = true;
      const originalText = sendBtn.textContent;
      sendBtn.textContent = "Sending…";

      try {
        const res = await fetch(`${API_BASE}/send-reset-code`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          throw new Error(data.error || data.message || "Failed to send code.");
        }

        // Save email for the next step
        sessionStorage.setItem("resetEmail", email);

        // Show success modal and redirect AFTER user closes it (or after 1500ms)
        showAppAlert("Verification code sent to your email.", {
          variant: "success",
          title: "Code Sent",
          onOkRedirectTo: "/ADMIN/passwordReset/verify_code.html",
          autoHideMs: 1500
        });

      } catch (err) {
        console.error(err);
        const msg = err.message || "Server error.";
        errorDiv.textContent = msg;
        showAppAlert(msg, { variant: "danger", title: "Error" });
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
      }
    });
  </script>
</body>
</html>
