<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Admin - Verify Code</title>

  <!-- OPTIONAL: If backend is a different Railway service, set this -->
  <!-- <meta name="api-base" content="https://YOUR-BACKEND.up.railway.app"> -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="signup1.css" />
</head>

<body>
  <!-- Top Logo -->
  <div class="top-logo text-center brand">
    <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
    <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo" />
  </div>
  
  <!-- Verification Form -->
  <div class="login-container">
    <div class="login-box text-center">
      <h4 class="mb-2">Enter Verification Code</h4>
      <p id="sentTo" class="mb-3 text-white muted"></p>

      <form id="verifyCodeForm" novalidate>
        <div class="otp-container">
          <input type="text" maxlength="1" class="otp-input" inputmode="numeric" autocomplete="one-time-code"/>
          <input type="text" maxlength="1" class="otp-input" inputmode="numeric"/>
          <input type="text" maxlength="1" class="otp-input" inputmode="numeric"/>
          <input type="text" maxlength="1" class="otp-input" inputmode="numeric"/>
          <input type="text" maxlength="1" class="otp-input" inputmode="numeric"/>
          <input type="text" maxlength="1" class="otp-input" inputmode="numeric"/>
        </div>

        <div id="verificationError" class="text-danger mb-3"></div>

        <button id="verifyBtn" type="submit" class="btn login-btn w-100 mb-2">Verify</button>

        <div class="d-flex justify-content-center gap-2 align-items-center">
          <span class="text-white">Didn't receive the code?</span>
          <a href="#" id="resendCode">Resend</a>
          <span id="resendTimer" class="text-white-50 small"></span>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="successModalLabel">Success</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">User verified and registered successfully.</p>
          <div class="mb-2">
            <div class="fw-semibold">Your User ID:</div>
            <div><code class="bg-light px-2 py-1 d-inline-block" id="successUserId">—</code></div>
          </div>
          <div>
            <div class="fw-semibold">Your Admin ID:</div>
            <div><code class="bg-light px-2 py-1 d-inline-block" id="successAdminId">—</code></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" id="successOkBtn" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="feedbackModalLabel">Notification</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="feedbackModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ---------------- API base detection (Railway-friendly) ---------------- */
    (function decideApiBase(){
      const meta = document.querySelector('meta[name="api-base"]');
      const metaBase = meta && meta.getAttribute('content') ? meta.getAttribute('content').trim() : null;
      const manual  = (typeof window.API_URL === 'string' && window.API_URL.trim()) ? window.API_URL.trim() : null;
      const isLocal = (h) => ['localhost','127.0.0.1'].includes(h);
      const sanitize=(u)=>(u||'').replace(/\/+$/,'');
      let base = metaBase || manual || (isLocal(location.hostname) ? 'http://localhost:5000' : '');
      if (!isLocal(location.hostname) && base && base.startsWith('http://')) {
        base = base.replace(/^http:\/\//i,'https://');
      }
      window.API_BASE = sanitize(base);
    })();

    /* --------- Cross-origin credentials mode (cookies across domains) --------- */
    function computeCredentialsMode() {
      try {
        if (!API_BASE) return 'same-origin';
        const api = new URL(API_BASE, location.href);
        return api.origin === location.origin ? 'same-origin' : 'include';
      } catch { return 'same-origin'; }
    }
    const FETCH_CREDENTIALS = computeCredentialsMode();

    /* ---------------- Endpoint fallbacks (cover common mounts) ---------------- */
    const ENDPOINTS = {
      verifyCode() {
        return [
          `${API_BASE}/verify-code`,
          `${API_BASE}/api/verify-code`,
          `${API_BASE}/api/admin/verify-code`,
          `${API_BASE}/api/auth/verify-code`,
        ];
      },
      resendCode() {
        return [
          `${API_BASE}/resend-code`,
          `${API_BASE}/api/resend-code`,
          `${API_BASE}/api/admin/resend-code`,
          `${API_BASE}/api/auth/resend-code`,
        ];
      }
    };

    function hint(url, resp){
      let h='';
      if(!resp) h='Network/CORS error. If backend is separate, set <meta name="api-base" ...> and enable CORS.';
      else if(resp.status===404) h='404 Not Found – check route/mount path.';
      else if(resp.status===403) h='403 Forbidden – CORS/auth.';
      console.warn('[Admin Verify]',{url,status:resp?.status,hint:h});
      return h;
    }

    async function fetchJSONFallback(urls, options) {
      let lastErr=null;
      for(const url of urls){
        try{
          const r = await fetch(url, { ...options, credentials: FETCH_CREDENTIALS, mode:'cors' });
          if (r.status === 404) { hint(url,r); continue; }
          let json = {}; try { json = await r.json(); } catch {}
          return { response: r, json };
        } catch (e) {
          lastErr=e; hint(url,null);
        }
      }
      throw lastErr || new Error('All endpoints failed');
    }

    /* ---------------- Elements ---------------- */
    const inputs = Array.from(document.querySelectorAll(".otp-input"));
    const verifyForm = document.getElementById("verifyCodeForm");
    const verifyBtn = document.getElementById("verifyBtn");
    const verificationError = document.getElementById("verificationError");
    const resendLink = document.getElementById("resendCode");
    const resendTimer = document.getElementById("resendTimer");
    const sentTo = document.getElementById("sentTo");

    const email = sessionStorage.getItem("pendingEmail");

    // Masked "sent to" line
    if (email) {
      const masked = email.replace(/(^.).*(@.*$)/, (_, a, b) => a + "••••" + b);
      sentTo.textContent = `We sent a 6-digit code to ${masked}. Please enter it below.`;
    } else {
      sentTo.textContent = "We sent a 6-digit code to your email. Please enter it below.";
    }

    const joinCode = () => inputs.map(i => i.value.trim()).join("");

    // OTP behaviour (digits only, paste support, arrows/backspace nav)
    inputs.forEach((input, i) => {
      input.addEventListener("beforeinput", (e) => {
        if (e.inputType === "insertText" && !/^\d$/.test(e.data)) e.preventDefault();
      });

      input.addEventListener("input", () => {
        input.value = input.value.replace(/\D/g, "");
        if (input.value.length === 1 && i < inputs.length - 1) inputs[i + 1].focus();
        verificationError.textContent = "";
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !input.value && i > 0) inputs[i - 1].focus();
        if (e.key === "ArrowLeft" && i > 0) inputs[i - 1].focus();
        if (e.key === "ArrowRight" && i < inputs.length - 1) inputs[i + 1].focus();
      });

      input.addEventListener("paste", (e) => {
        const text = (e.clipboardData || window.clipboardData).getData("text");
        if (/^\d{6}$/.test(text)) {
          e.preventDefault();
          for (let k = 0; k < 6; k++) inputs[k].value = text[k];
          inputs[5].focus();
        }
      });
    });

    // Resend cooldown
    let cooldown = 0;
    let timerId = null;
    function setResendState(active) {
      if (active) {
        resendLink.classList.remove("disabled-link");
        resendTimer.textContent = "";
      } else {
        resendLink.classList.add("disabled-link");
      }
    }
    function startCooldown(seconds = 60) {
      if (timerId) clearInterval(timerId);
      cooldown = seconds;
      setResendState(false);
      updateTimer();
      timerId = setInterval(updateTimer, 1000);
    }
    function updateTimer() {
      if (cooldown <= 0) {
        clearInterval(timerId);
        timerId = null;
        resendTimer.textContent = "";
        setResendState(true);
        return;
      }
      resendTimer.textContent = `(${cooldown}s)`;
      cooldown -= 1;
    }

    // Modals
    function showSuccessModal({ userId = null, adminId = null, redirectTo = null, autoCloseMs = null }) {
      const el = document.getElementById("successModal");
      const m  = new bootstrap.Modal(el);

      document.getElementById("successUserId").textContent  = userId  || "—";
      document.getElementById("successAdminId").textContent = adminId || "—";

      document.getElementById("successOkBtn").onclick = () => { if (redirectTo) window.location.href = redirectTo; };
      el.addEventListener("hidden.bs.modal", function onHidden() {
        el.removeEventListener("hidden.bs.modal", onHidden);
        if (redirectTo) window.location.href = redirectTo;
      });

      m.show();

      if (autoCloseMs && Number.isFinite(autoCloseMs)) {
        setTimeout(() => {
          m.hide();
          if (redirectTo) window.location.href = redirectTo;
        }, autoCloseMs);
      }
    }

    function showFeedbackModal(message, title = "Notification") {
      document.getElementById("feedbackModalLabel").textContent = title;
      document.getElementById("feedbackModalBody").textContent  = message;
      new bootstrap.Modal(document.getElementById("feedbackModal")).show();
    }

    // Submit verification
    verifyForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const code = joinCode();

      if (!/^\d{6}$/.test(code)) {
        verificationError.textContent = "Please enter a valid 6-digit code.";
        inputs[0].focus();
        return;
      }
      if (!email) {
        verificationError.textContent = "Email not found. Please register again.";
        return;
      }

      verificationError.textContent = "";
      verifyBtn.disabled = true;
      const prevHTML = verifyBtn.innerHTML;
      verifyBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Verifying...`;

      try {
        const { response, json: data } = await fetchJSONFallback(
          ENDPOINTS.verifyCode(),
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, code })
          }
        );

        if (response.ok) {
          // read ids (either top-level or nested under data.user)
          const userId  = data.userId  || (data.user && data.user.userId);
          const adminId = data.adminId || (data.user && data.user.adminId);

          if (userId)  sessionStorage.setItem("verifiedUserId", userId);
          if (adminId) sessionStorage.setItem("adminId", adminId);

          // clean pending state
          sessionStorage.removeItem("pendingEmail");
          sessionStorage.removeItem("pendingUserData");

          // success modal then redirect
          showSuccessModal({
            userId,
            adminId,
            redirectTo: "/ADMIN/login/login.html"
          });

        } else {
          // Common failure status handling
          if (response.status === 410) {
            verificationError.textContent = data.error || "Code expired. Please request a new one.";
          } else if (response.status === 429) {
            verificationError.textContent = data.error || "Too many attempts. Please wait and try again.";
          } else {
            verificationError.textContent = data.error || "Invalid or expired code.";
          }
          if (!timerId) startCooldown(30);
        }
      } catch (err) {
        console.error(err);
        verificationError.textContent = "Failed to connect to server. If backend is separate, set <meta name=\"api-base\" ...> and enable CORS.";
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = prevHTML;
      }
    });

    // Resend code
    document.getElementById("resendCode").addEventListener("click", async (e) => {
      e.preventDefault();
      if (resendLink.classList.contains("disabled-link")) return;
      if (!email) {
        verificationError.textContent = "Missing email from session.";
        return;
      }
      try {
        setResendState(false);
        const { response, json: data } = await fetchJSONFallback(
          ENDPOINTS.resendCode(),
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
          }
        );
        if (response.ok) {
          showFeedbackModal("New verification code sent to your email.", "Code Resent");
          inputs.forEach(i => i.value = "");
          inputs[0].focus();
          startCooldown(60);
        } else {
          setResendState(true);
          showFeedbackModal(data?.error || "Could not resend code.", "Resend Failed");
        }
      } catch (error) {
        console.error(error);
        setResendState(true);
        showFeedbackModal("Server error while resending verification code.", "Server Error");
      }
    });

    // Init
    window.addEventListener("DOMContentLoaded", () => {
      inputs[0].focus();
      startCooldown(30);
    });
  </script>
</body>
</html>
