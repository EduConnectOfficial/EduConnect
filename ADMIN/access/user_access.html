<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Admin - User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="/ADMIN/access/access.css" />
</head>

<body>

  <div class="dashboard">
    <div id="sidebar-container"></div>

    <!-- Sidebar Script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/ADMIN/components/test.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;

            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");

            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }

            document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
              toggle.addEventListener('click', e => {
                e.preventDefault();
                const parent = toggle.closest('.has-submenu');
                parent.classList.toggle('open');
                toggle.setAttribute('aria-expanded', String(toggle.getAttribute('aria-expanded') !== 'true'));
              });
            });
          })
          .catch(err => console.error("Failed to load sidebar:", err));
      });
    </script>

    <!-- Main -->
    <div class="main">
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <section class="content px-4">
        <h2 class="mt-4 mb-3 fw-bold text-center">User Management List</h2>
        <div class="container-fluid px-4">
          <!-- ✅ Alert Container -->
          <div id="userAlert" class="alert alert-success d-none" role="alert"></div>

          <div class="table-responsive shadow bg-white rounded p-4">
            <table class="table table-bordered align-middle text-center w-100">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Username</th>
                  <th>First Name</th>
                  <th>Middle Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Account Status</th>
                  <th>Role</th>
                  <th>Edit</th>
                </tr>
              </thead>
              <tbody id="userTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ✅ Status Confirmation Modal -->
  <div class="modal fade" id="statusConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Account Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="statusModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmStatusBtn" class="btn btn-primary">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Edit Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="editUserForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User Info</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body px-4">
          <div class="mb-3"><label class="form-label-text">Username</label><input type="text" class="form-control"
              id="editUsername" required /></div>
          <div class="mb-3"><label class="form-label-text">First Name</label><input type="text" class="form-control"
              id="editFirstName" required /></div>
          <div class="mb-3"><label class="form-label-text">Middle Name</label><input type="text" class="form-control"
              id="editMiddleName" /></div>
          <div class="mb-3"><label class="form-label-text">Last Name</label><input type="text" class="form-control"
              id="editLastName" required /></div>
        </div>
        <div class="modal-footer px-4">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ✅ Delete Confirmation Modal -->
  <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="deleteModalBody">Are you sure you want to delete this user?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const userData = JSON.parse(localStorage.getItem("user"));
    if (!userData || !userData.username) {
      window.location.href = "../login/login.html";
    } else {
      document.getElementById("Username").textContent = userData.username;
    }
  </script>

  <!-- ✅ JS Script -->
<script>
  const API_BASE = 'http://localhost:5000/api/users';

  // small helper to fetch JSON and throw on non-JSON/HTTP errors
  async function getJSON(url, options = {}) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status}: ${text.slice(0,120)}`);
    }
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('application/json')) {
      const text = await res.text();
      throw new Error(`Expected JSON, got ${ct}. Body: ${text.slice(0,120)}`);
    }
    return res.json();
  }

  let selectedUser = null;
  let selectedRow = null;
  let newStatus = false;

  const tableBody = document.getElementById("userTableBody");

  const editFirstName = document.getElementById("editFirstName");
  const editMiddleName = document.getElementById("editMiddleName");
  const editLastName = document.getElementById("editLastName");
  const editUsername = document.getElementById("editUsername");

  // helper: email masking
  function maskEmail(email) {
    if (!email || !email.includes("@")) return email;
    const [local, domain] = email.split("@");
    const parts = domain.split(".");
    const maskedLocal = local[0] + "*".repeat(Math.max(local.length - 1, 0));
    const domainName = parts.slice(0, -1).join(".");
    const maskedDomainName = domainName ? (domainName[0] + "*".repeat(Math.max(domainName.length - 1, 0))) : "";
    const tld = parts[parts.length - 1] || "";
    return maskedLocal + "@" + (maskedDomainName ? (maskedDomainName + ".") : "") + tld;
  }

  async function loadUsers() {
    try {
      const data = await getJSON(`${API_BASE}`);
      // backend returns { success, users:[...] }; but also tolerate old shape
      const users = Array.isArray(data?.users) ? data.users : (Array.isArray(data) ? data : []);
      if (!users.length) {
        tableBody.innerHTML = `<tr><td colspan="9">No users found.</td></tr>`;
        return;
      }

      tableBody.innerHTML = "";
      let displayIndex = 0;

      users.forEach((user) => {
        // prefer explicit flags; fall back to presence of IDs
        const isTeacher = (user?.isTeacher === true) || Boolean(user?.teacherId);
        const isStudent = (user?.isStudent === true) || Boolean(user?.studentId);

        // only show Teacher/Student in this list
        if (!isTeacher && !isStudent) return;

        const isActive = user.active ?? true;
        let role = '—';
        if (isTeacher && isStudent) role = 'Teacher & Student';
        else if (isTeacher) role = 'Teacher';
        else if (isStudent) role = 'Student';

        displayIndex += 1;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${displayIndex}</td>
          <td>${user.username || ""}</td>
          <td>${user.firstName || ""}</td>
          <td>${user.middleName || ""}</td>
          <td>${user.lastName || ""}</td>
          <td>${maskEmail(user.email || "")}</td>
          <td><span class="badge ${isActive ? 'bg-success' : 'bg-secondary'} status-badge">${isActive ? 'Active' : 'Inactive'}</span></td>
          <td>${role}</td>
          <td>
            <div class="btn-group gap-2" role="group">
              <button class="btn btn-sm btn-warning edit-btn">Edit <i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-danger delete-btn">Delete <i class="fas fa-trash-alt"></i></button>
              <button class="btn btn-sm ${isActive ? 'btn-secondary' : 'btn-success'} toggle-btn">${isActive ? 'Deactivate' : 'Reactivate'}</button>
            </div>
          </td>
        `;

        const toggleButton = row.querySelector(".toggle-btn");
        const editButton = row.querySelector(".edit-btn");
        const deleteButton = row.querySelector(".delete-btn");

        // Toggle status
        toggleButton.addEventListener("click", () => {
          selectedUser = user;
          selectedRow = row;
          newStatus = !user.active;
          document.getElementById("statusModalBody").textContent =
            `Are you sure you want to ${newStatus ? 'reactivate' : 'deactivate'} the account of ${user.username}?`;

          new bootstrap.Modal(document.getElementById("statusConfirmModal")).show();

          document.getElementById("confirmStatusBtn").onclick = async () => {
            try {
              const result = await getJSON(`${API_BASE}/${encodeURIComponent(user.userId)}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ active: newStatus })
              });

              if (result.success) {
                user.active = newStatus;
                const badge = row.querySelector(".status-badge");
                badge.textContent = user.active ? "Active" : "Inactive";
                badge.className = `badge ${user.active ? 'bg-success' : 'bg-secondary'} status-badge`;

                toggleButton.textContent = user.active ? "Deactivate" : "Reactivate";
                toggleButton.className = `btn btn-sm ${user.active ? 'btn-secondary' : 'btn-success'} toggle-btn`;

                bootstrap.Modal.getInstance(document.getElementById("statusConfirmModal")).hide();
              } else {
                alert("Failed to update status.");
              }
            } catch (err) {
              console.error("❌ Error:", err);
              alert("Server error.");
            }
          };
        });

        // Edit button
        editButton.addEventListener("click", () => {
          selectedUser = user;
          selectedRow = row;
          editFirstName.value = user.firstName || '';
          editMiddleName.value = user.middleName || '';
          editLastName.value = user.lastName || '';
          editUsername.value = user.username || '';
          new bootstrap.Modal(document.getElementById("editUserModal")).show();
        });

        // Delete button
        deleteButton.addEventListener("click", () => {
          selectedUser = user;
          selectedRow = row;

          document.getElementById("deleteModalBody").textContent =
            `Are you sure you want to permanently delete ${user.username}?`;

          const oldBtn = document.getElementById("confirmDeleteBtn");
          const newBtn = oldBtn.cloneNode(true);
          oldBtn.parentNode.replaceChild(newBtn, oldBtn);

          newBtn.addEventListener("click", async () => {
            try {
              const result = await getJSON(`${API_BASE}/${encodeURIComponent(user.userId)}`, {
                method: 'DELETE'
              });

              if (result.success) {
                selectedRow.remove();
                bootstrap.Modal.getInstance(document.getElementById("deleteUserModal")).hide();

                const alertBox = document.getElementById("userAlert");
                alertBox.textContent = "User deleted successfully.";
                alertBox.classList.remove("d-none");
                setTimeout(() => alertBox.classList.add("d-none"), 3000);
              } else {
                alert("Failed to delete user.");
              }
            } catch (err) {
              console.error("❌ Delete failed:", err);
              alert("Server error while deleting.");
            }
          });

          new bootstrap.Modal(document.getElementById("deleteUserModal")).show();
        });

        tableBody.appendChild(row);
      });
    } catch (err) {
      console.error("❌ Failed to load users:", err);
      tableBody.innerHTML = `<tr><td colspan="9">Error loading users.</td></tr>`;
    }
  }

  // Edit form submit
  document.getElementById("editUserForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!selectedUser) return;

    const updatedData = {
      firstName: editFirstName.value.trim(),
      middleName: editMiddleName.value.trim(),
      lastName: editLastName.value.trim(),
      username: editUsername.value.trim()
    };

    try {
      const result = await getJSON(`${API_BASE}/${encodeURIComponent(selectedUser.userId)}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      });

      if (result.success) {
        // update row
        selectedRow.children[1].textContent = updatedData.username;
        selectedRow.children[2].textContent = updatedData.firstName;
        selectedRow.children[3].textContent = updatedData.middleName;
        selectedRow.children[4].textContent = updatedData.lastName;

        bootstrap.Modal.getInstance(document.getElementById("editUserModal")).hide();

        const alertBox = document.getElementById("userAlert");
        alertBox.textContent = "User information updated successfully!";
        alertBox.classList.remove("d-none");
        setTimeout(() => alertBox.classList.add("d-none"), 3000);
      } else {
        alert("Failed to update user info.");
      }
    } catch (err) {
      console.error("❌ Update failed:", err);
      alert("Server error while updating.");
    }
  });

  // kick it off
  loadUsers();
</script>

 <script>
    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/ADMIN/login/login.html";
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
