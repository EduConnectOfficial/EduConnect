<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Admin - Profile Management</title>

  <!-- OPTIONAL: If backend is a different Railway service, set this -->
  <!-- <meta name="api-base" content="https://YOUR-BACKEND.up.railway.app"> -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="profile.css" />

  <script>
    /* =========================
       EARLY ADMIN SESSION GUARD
       ========================= */
    function _coerceBool(v){ if(v===true||v===1)return true; if(typeof v==="string"){const s=v.trim().toLowerCase(); return s==="true"||s==="1"||s==="yes";} return false; }
    function _hasAdminRole(u){
      if(!u||typeof u!=="object") return false;
      if(_coerceBool(u.isAdmin)) return true;
      if(typeof u.role==="string" && u.role.toLowerCase()==="admin") return true;
      if(Array.isArray(u.roles) && u.roles.map(r=>String(r).toLowerCase()).includes("admin")) return true;
      if(u.claims && (_coerceBool(u.claims.admin) || String(u.claims.role||"").toLowerCase()==="admin")) return true;
      return false;
    }
    (function guard(){
      let user=null; try{ user=JSON.parse(localStorage.getItem("user")||"null"); }catch{}
      if(!_hasAdminRole(user)){
        localStorage.clear(); sessionStorage.clear();
        window.location.replace("/ADMIN/login/login.html"); return;
      }
      // Normalize and expose
      user.isAdmin = true;
      localStorage.setItem("user", JSON.stringify(user));
      window.__ADMIN_USER__ = user;
    })();
  </script>
</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <header class="header-top">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" placeholder="Search..." aria-label="Search" />
          <i class="fas fa-search"></i>
        </div>

        <button class="profile-btn" type="button">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username"></span>
        </button>
      </header>

      <!-- Profile Section -->
      <section class="content">
        <div class="ui-card section mb-3">
          <h2 class="fw-bold mb-3">Profile Management</h2>
          <form id="profileForm" class="row g-4" enctype="multipart/form-data">
            <div class="col-12 text-center">
              <img id="profilePreview" src="/assets/default-avatar.png"
                   class="rounded-circle mb-3" width="120" height="120" style="object-fit:cover;"
                   alt="Profile Picture" loading="lazy" decoding="async" />
              <div class="d-flex justify-content-center">
                <input type="file" id="profilePic" name="profilePic"
                       accept="image/png, image/jpeg, image/webp"
                       class="form-control w-auto" />
              </div>
            </div>
            <div class="col-md-4">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" id="firstName" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label for="middleName" class="form-label">Middle Name</label>
              <input type="text" id="middleName" class="form-control" />
            </div>
            <div class="col-md-4">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" id="lastName" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label for="username" class="form-label">Username</label>
              <input type="text" id="username" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label for="email" class="form-label">Email (readonly)</label>
              <input type="email" id="email" class="form-control" readonly />
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-amber">Update Profile</button>
              <button type="button" class="btn btn-amber-outline ms-2" data-bs-toggle="modal"
                      data-bs-target="#changePasswordModal">Change Password</button>
            </div>
          </form>
        </div>

        <!-- Change Password Modal -->
        <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Change Password</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
              <form id="changePasswordForm">
                <div class="mb-3"><label class="form-label">Current Password</label>
                  <input type="password" class="form-control" id="currentPassword" required autocomplete="current-password" />
                </div>
                <div class="mb-3"><label class="form-label">New Password</label>
                  <input type="password" class="form-control" id="newPassword" required minlength="8" autocomplete="new-password" />
                </div>
                <div class="mb-3"><label class="form-label">Confirm New Password</label>
                  <input type="password" class="form-control" id="confirmPassword" required minlength="8" autocomplete="new-password" />
                </div>
                <ul class="list-unstyled mt-2" id="pwCriteria">
                  <li id="pwLength"><i class="bi bi-x-circle text-danger me-2"></i>Minimum 8 characters</li>
                  <li id="pwUpper"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 uppercase letter</li>
                  <li id="pwNumber"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 number</li>
                  <li id="pwSpecial"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 special character</li>
                  <li id="pwMatch"><i class="bi bi-x-circle text-danger me-2"></i>Passwords match</li>
                </ul>
                <div class="form-check text-start mb-2">
                  <input class="form-check-input" type="checkbox" id="toggleChangePw" />
                  <label class="form-check-label" for="toggleChangePw">Show Password</label>
                </div>
                <div id="changePasswordMsg" class="mb-2" style="display:none;" aria-live="polite"></div>
                <button type="submit" class="btn btn-amber">Change Password</button>
              </form>
            </div>
          </div></div>
        </div>

        <!-- App Alert Modal -->
        <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div id="appAlertHeader" class="modal-header">
              <h5 class="modal-title" id="appAlertTitle">Notice</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="appAlertBody" class="modal-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
          </div></div>
        </div>

      </section>
    </div>
  </div>

  <!-- Sidebar JS -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/ADMIN/components/test.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              toggle.setAttribute('aria-expanded', String(!(toggle.getAttribute('aria-expanded') === 'true')));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Alert helper -->
  <script>
    function showAppAlert(message, { title = "Notice", variant = "primary" } = {}) {
      const header = document.getElementById("appAlertHeader");
      const titleEl = document.getElementById("appAlertTitle");
      const bodyEl  = document.getElementById("appAlertBody");

      header.className = "modal-header";
      const bg = {
        primary:"bg-primary text-white", success:"bg-success text-white",
        danger:"bg-danger text-white", warning:"bg-warning",
        info:"bg-info", secondary:"bg-secondary text-white",
        dark:"bg-dark text-white", light:"bg-light"
      }[variant] || "bg-primary text-white";
      header.classList.add(...bg.split(" "));

      titleEl.textContent = title;
      bodyEl.textContent  = message;
      bootstrap.Modal.getOrCreateInstance(document.getElementById("appAlertModal")).show();
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Profile + Auth Logic (Railway-ready) -->
  <script>
    /* =========================
       API base (Railway-friendly) & fetch helpers
       ========================= */
    (function decideApiBase(){
      const meta = document.querySelector('meta[name="api-base"]');
      const metaBase = meta && meta.getAttribute('content') ? meta.getAttribute('content').trim() : null;
      const manual  = (typeof window.API_URL === 'string' && window.API_URL.trim()) ? window.API_URL.trim() : null;
      const isLocal = (h) => ['localhost','127.0.0.1'].includes(h);
      const sanitize=(u)=>(u||'').replace(/\/+$/,'');
      let base = metaBase || manual || (isLocal(location.hostname) ? 'http://localhost:5000' : '');
      if (!isLocal(location.hostname) && base && base.startsWith('http://')) base = base.replace(/^http:\/\//i,'https://');
      window.API_BASE = sanitize(base);
    })();

    function computeCredentialsMode() {
      try {
        if (!API_BASE) return 'same-origin';
        const api = new URL(API_BASE, location.href);
        return api.origin === location.origin ? 'same-origin' : 'include';
      } catch { return 'same-origin'; }
    }
    const FETCH_CREDENTIALS = computeCredentialsMode();

    const DEFAULT_AVATAR = "/assets/default-avatar.png";

    function isAbsoluteUrl(u){ return /^https?:\/\//i.test(u||""); }
    function backendResolve(u) {
      if (!u) return DEFAULT_AVATAR;
      if (isAbsoluteUrl(u)) return u;
      // If it starts with '/', resolve against API_BASE origin (if provided) otherwise same origin
      const base = API_BASE || '';
      if (u.startsWith('/')) return base ? (new URL(u, base)).toString() : u;
      return u;
    }
    function resolveURL(u, { cacheBust = false } = {}) {
      const final = backendResolve(u);
      if (!cacheBust) return final;
      const sep = final.includes("?") ? "&" : "?";
      return `${final}${sep}t=${Date.now()}`;
    }
    function authHeaders(extra = {}) {
      const token = localStorage.getItem("authToken");
      return { ...(token ? { "Authorization": `Bearer ${token}` } : {}), ...extra };
    }

    // Generic fallback fetcher
    function hint(url, resp){
      let h='';
      if(!resp) h='Network/CORS error. If backend is separate, set <meta name="api-base" ...> and enable CORS.';
      else if(resp.status===404) h='404 Not Found – check route/mount path.';
      else if(resp.status===403) h='403 Forbidden – CORS/auth.';
      console.warn('[Admin Profile]',{url,status:resp?.status,hint:h});
      return h;
    }
    async function fetchJSONFallback(urls, options) {
      let lastErr=null;
      for(const url of urls){
        try{
          const r = await fetch(url, { ...options, credentials: FETCH_CREDENTIALS, mode:'cors' });
          if (r.status === 404) { hint(url,r); continue; }
          let json = {}; try { json = await r.json(); } catch {}
          return { response: r, json };
        } catch (e) {
          lastErr=e; hint(url,null);
        }
      }
      throw lastErr || new Error('All endpoints failed');
    }

    /* =========================
       Endpoint fallbacks
       ========================= */
    const ENDPOINTS = {
      user(userId) {
        return [
          `${API_BASE}/api/users/${userId}`,
          `${API_BASE}/users/${userId}`,
          `${API_BASE}/api/admin/users/${userId}`,
          `${API_BASE}/api/auth/users/${userId}`,
        ];
      },
      updateProfile(userId) {
        return [
          `${API_BASE}/api/users/${userId}/profile`,
          `${API_BASE}/users/${userId}/profile`,
          `${API_BASE}/api/admin/users/${userId}/profile`,
          `${API_BASE}/api/auth/users/${userId}/profile`,
        ];
      },
      changePassword(userId) {
        return [
          `${API_BASE}/api/users/${userId}/change-password`,
          `${API_BASE}/users/${userId}/change-password`,
          `${API_BASE}/api/admin/users/${userId}/change-password`,
          `${API_BASE}/api/auth/users/${userId}/change-password`,
        ];
      },
      login() {
        return [
          `${API_BASE}/api/login`,
          `${API_BASE}/login`,
          `${API_BASE}/api/admin/login`,
          `${API_BASE}/api/auth/login`,
        ];
      }
    };

    /* =========================
       Guard: must have userId
       ========================= */
    const storedUser = (function(){
      try { return JSON.parse(localStorage.getItem("user")||"{}"); } catch { return {}; }
    })();
    if (!storedUser || !storedUser.userId) {
      window.location.href = "/ADMIN/login/login.html";
    }
    const userId = encodeURIComponent(storedUser.userId);

    /* =========================
       Header initials
       ========================= */
    function getInitials(info = {}) {
      const f = (info.firstName || "").trim();
      const l = (info.lastName || "").trim();
      if (f && l) return (f[0] + l[0]).toUpperCase();
      const u = (info.username || info.email || "U").trim();
      return (u[0] || "U").toUpperCase();
    }
    function bestFull(info = {}) {
      return [info.firstName, info.middleName, info.lastName].filter(Boolean).join(" ").trim()
          || info.username || info.email || "User";
    }
    const UsernameEl = document.getElementById("Username");
    if (UsernameEl) {
      UsernameEl.textContent = getInitials(storedUser);
      UsernameEl.title = bestFull(storedUser);
    }

    /* =========================
       Elements & avatar fallback
       ========================= */
    const profilePicInput = document.getElementById("profilePic");
    const profilePreview  = document.getElementById("profilePreview");
    let previewUrl; let avatarErrorHandled = false;
    profilePreview.addEventListener("error", () => {
      if (avatarErrorHandled) return;
      avatarErrorHandled = true;
      profilePreview.src = DEFAULT_AVATAR;
    });

    // Local preview & validation
    const MAX_MB = 5;
    const VALID_TYPES = ["image/png", "image/jpeg", "image/webp"];
    profilePicInput.addEventListener("change", () => {
      const f = profilePicInput.files[0];
      if (!f) return;
      if (!VALID_TYPES.includes(f.type)) {
        showAppAlert("Please choose a PNG, JPG, or WEBP image.", { variant: "warning" });
        profilePicInput.value = ""; return;
      }
      if (f.size > MAX_MB * 1024 * 1024) {
        showAppAlert(`Image too large. Max size is ${MAX_MB} MB.`, { variant: "warning" });
        profilePicInput.value = ""; return;
      }
      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(f);
      profilePreview.src = previewUrl;
    });
    window.addEventListener("beforeunload", () => previewUrl && URL.revokeObjectURL(previewUrl));

    /* =========================
       Load current user
       ========================= */
    (async () => {
      try {
        const { response, json } = await fetchJSONFallback(
          ENDPOINTS.user(userId),
          { headers: authHeaders() }
        );
        if (!response.ok) {
          if (response.status === 401) { logoutUser(); return; }
          throw new Error(`HTTP ${response.status} ${response.statusText}`);
        }
        const { success, user } = json || {};
        if (!success || !user) throw new Error("User not found");

        document.getElementById("firstName").value = user.firstName || "";
        document.getElementById("middleName").value = user.middleName || "";
        document.getElementById("lastName").value  = user.lastName || "";
        document.getElementById("username").value  = user.username || "";
        document.getElementById("email").value     = user.email || "";

        UsernameEl.textContent = getInitials(user);
        UsernameEl.title = bestFull(user);

        if (user.photoURL) {
          profilePreview.src = resolveURL(user.photoURL, { cacheBust: true });
          storedUser.photoURL = user.photoURL;
        } else {
          profilePreview.src = DEFAULT_AVATAR;
        }

        // persist safe fields
        storedUser.username = user.username ?? storedUser.username;
        storedUser.firstName = user.firstName ?? storedUser.firstName;
        storedUser.middleName = user.middleName ?? storedUser.middleName;
        storedUser.lastName = user.lastName ?? storedUser.lastName;
        storedUser.email = user.email ?? storedUser.email;
        localStorage.setItem("user", JSON.stringify(storedUser));
      } catch (err) {
        console.error("❌ Error fetching user:", err);
        showAppAlert("Could not load your profile. Please refresh the page.", { variant: "danger", title: "Load Error" });
      }
    })();

    /* =========================
       Update profile
       ========================= */
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData();
      fd.append("firstName", document.getElementById("firstName").value);
      fd.append("middleName", document.getElementById("middleName").value);
      fd.append("lastName",  document.getElementById("lastName").value);
      fd.append("username",  document.getElementById("username").value);
      if (profilePicInput.files.length) fd.append("profilePic", profilePicInput.files[0]);

      try {
        const { response, json: out } = await fetchJSONFallback(
          ENDPOINTS.updateProfile(userId),
          { method: "POST", headers: authHeaders(), body: fd } // no explicit Content-Type for FormData
        );

        if (!response.ok || !out?.success) {
          if (response.status === 401) { logoutUser(); return; }
          showAppAlert(out?.message || `❌ Failed to update profile.`, { variant: "danger", title: "Update Failed" });
          return;
        }

        const u = out.updatedUser || out.user || {};
        // header & local cache
        UsernameEl.textContent = getInitials(u);
        UsernameEl.title = bestFull(u);

        if (u.photoURL) {
          profilePreview.src = resolveURL(u.photoURL, { cacheBust: true });
          storedUser.photoURL = u.photoURL;
        }
        storedUser.username   = u.username   ?? storedUser.username;
        storedUser.firstName  = u.firstName  ?? storedUser.firstName;
        storedUser.middleName = u.middleName ?? storedUser.middleName;
        storedUser.lastName   = u.lastName   ?? storedUser.lastName;
        storedUser.email      = u.email      ?? storedUser.email;
        localStorage.setItem("user", JSON.stringify(storedUser));

        showAppAlert("✅ Profile updated successfully!", { variant: "success", title: "Success" });
      } catch (err) {
        console.error("❌ Profile update failed:", err);
        showAppAlert("❌ Profile update failed. Please try again.", { variant: "danger", title: "Network Error" });
      }
    });

    /* =========================
       Change Password (+ auto re-login)
       ========================= */
    const newPw = document.getElementById("newPassword");
    const confirmPw = document.getElementById("confirmPassword");
    const msgDiv = document.getElementById("changePasswordMsg");

    function setMsg(text, color){ msgDiv.textContent=text; msgDiv.style.display="block"; msgDiv.style.color=color; }
    function clearMsg(){ msgDiv.textContent=""; msgDiv.style.display="none"; msgDiv.style.removeProperty("color"); }
    function checkRow(el, ok){
      const i = el.querySelector("i");
      i.classList.toggle("bi-check-circle", ok);
      i.classList.toggle("text-success", ok);
      i.classList.toggle("bi-x-circle", !ok);
      i.classList.toggle("text-danger", !ok);
    }
    function livePw(){
      const p = newPw.value||"";
      checkRow(document.getElementById("pwLength"),  p.length>=8);
      checkRow(document.getElementById("pwUpper"),   /[A-Z]/.test(p));
      checkRow(document.getElementById("pwNumber"),  /\d/.test(p));
      checkRow(document.getElementById("pwSpecial"), /[^A-Za-z0-9]/.test(p));
      checkRow(document.getElementById("pwMatch"),   p === (confirmPw.value||"") && p!=="");
    }
    newPw.addEventListener("input", livePw);
    confirmPw.addEventListener("input", livePw);

    document.getElementById("toggleChangePw").addEventListener("change", function () {
      const t = this.checked ? "text" : "password";
      document.getElementById("currentPassword").type = t;
      newPw.type = t; confirmPw.type = t;
    });

    function persistAuth(obj) {
      const user = obj?.user || obj?.data?.user || obj?.data || obj;
      const token = obj?.token || obj?.accessToken || obj?.jwt || obj?.data?.token || null;
      if (user) localStorage.setItem("user", JSON.stringify({ ...user, token }));
      if (token) localStorage.setItem("authToken", token);
    }
    async function smartLogin({ email, username, password }) {
      const bodies = [];
      if (email)    bodies.push({ email, password },    { identifier: email,    password });
      if (username) bodies.push({ username, password }, { identifier: username, password });
      const creds  = ["include","same-origin","omit"];
      for (const url of ENDPOINTS.login()) for (const b of bodies) for (const c of creds) {
        try {
          const r = await fetch(url, { method:"POST", credentials:c, headers:{ "Content-Type":"application/json" }, body: JSON.stringify(b) });
          let j={}; try{ j=await r.json(); }catch{}
          const okUser = j?.user || j?.data?.user || (j?.success && (j?.user || j?.data));
          if (r.ok && okUser) { persistAuth(j); return j; }
        } catch {}
      }
      throw new Error("All login attempts failed");
    }

    document.getElementById("changePasswordForm").addEventListener("submit", async (e) => {
      e.preventDefault(); clearMsg();
      const currentPassword = document.getElementById("currentPassword").value;
      const newPassword     = newPw.value;
      const confirmPassword = confirmPw.value;

      if (newPassword.length < 8)            return setMsg("New password must be at least 8 characters.", "red");
      if (!/[A-Z]/.test(newPassword))         return setMsg("New password must contain at least 1 uppercase letter.", "red");
      if (!/\d/.test(newPassword))            return setMsg("New password must contain at least 1 number.", "red");
      if (!/[^A-Za-z0-9]/.test(newPassword))  return setMsg("New password must contain at least 1 special character.", "red");
      if (newPassword !== confirmPassword)    return setMsg("New passwords do not match.", "red");

      try {
        const { response, json: result } = await fetchJSONFallback(
          ENDPOINTS.changePassword(userId),
          {
            method: "POST",
            headers: authHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify({ currentPassword, newPassword })
          }
        );

        if (!response.ok || !result?.success) {
          if (response.status === 401) { logoutUser(); return; }
          return setMsg(result?.error || `HTTP ${response.status}`, "red");
        }

        // Auto re-login
        const latestEmail    = document.getElementById("email").value     || storedUser.email    || null;
        const latestUsername = document.getElementById("username").value  || storedUser.username || null;
        try {
          await smartLogin({ email: latestEmail, username: latestUsername, password: newPassword });
          setMsg("Password changed!", "green");
          setTimeout(() => {
            bootstrap.Modal.getOrCreateInstance(document.getElementById("changePasswordModal")).hide();
            document.getElementById("changePasswordForm").reset();
            clearMsg();
          }, 1200);
        } catch {
          setMsg("Password changed, but auto-login failed. Please log in again.", "red");
        }
      } catch (err) {
        console.error("Change password error:", err);
        setMsg(err.message || "Unexpected error occurred.", "red");
      }
    });

    /* =========================
       Logout helper
       ========================= */
    function logoutUser() {
      localStorage.clear(); sessionStorage.clear();
      window.location.href = "/ADMIN/login/login.html";
    }
  </script>
</body>
</html>
