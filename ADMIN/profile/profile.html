<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Admin - Profile Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="profile.css" />
  <style>
    :root {
      --bg: #f6f8fa;
      --text: #1f2328;
      --muted: #6a737d;
      --card: #ffffff;
      --border: #e5e7eb;
      --brand-dark-1: #4A1A0C;
      --brand-dark-2: #7A2810;
      --accent-1: #FF6A00;
      --accent-2: #B03C10;
      --radius: 14px;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text)
    }

    .dashboard {
      display: flex;
      min-height: 100vh
    }

    .main {
      margin-left: 70px;
      width: calc(100% - 70px);
      transition: margin-left .3s, width .3s;
      display: flex;
      flex-direction: column
    }

    .sidebar:hover~.main {
      margin-left: 220px;
      width: calc(100% - 220px)
    }

    .logo-header {
      height: 44px
    }

    .search-box {
      position: relative;
      flex: 1;
      max-width: 520px;
      margin: 0 20px
    }

    .search-box input {
      border: none;
      border-radius: 999px;
      padding: .6rem .9rem .6rem 1rem
    }

    .search-box i {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #d7dadf
    }

    .profile-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer
    }

    .profile-btn .username {
      font-size: 14px
    }

    .content {
      padding: 24px
    }

    .ui-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 22px rgba(0, 0, 0, .08)
    }

    .ui-card.section {
      padding: 18px
    }

    .btn-amber {
      background: linear-gradient(to bottom, var(--accent-1), var(--accent-2));
      color: #fff;
      border: none
    }

    .btn-amber:hover {
      filter: brightness(1.06);
      color: #fff
    }

    .btn-amber-outline {
      background: #fff;
      color: var(--accent-2);
      border: 1px solid var(--accent-2)
    }

    .btn-amber-outline:hover {
      background: linear-gradient(to bottom, var(--accent-1), var(--accent-2));
      color: #fff;
      border-color: transparent
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--accent-2) !important;
      box-shadow: 0 0 0 .2rem rgba(255, 106, 0, .18) !important
    }

    .modal-header {
      background: linear-gradient(90deg, var(--brand-dark-1), var(--brand-dark-2));
      color: #FFD8A9;
      border-bottom: none
    }

    .modal-content {
      border-radius: 12px;
      border: 1px solid var(--border)
    }

    .modal-footer {
      border-top: 1px solid var(--border)
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Profile Section -->
      <section class="content">
        <div class="ui-card section mb-3">
          <h2 class="fw-bold mb-3">Profile Management</h2>
          <form id="profileForm" class="row g-4" enctype="multipart/form-data">
            <div class="col-12 text-center">
              <img id="profilePreview" src="/assets/default-avatar.png" class="rounded-circle mb-3" width="120"
                height="120" style="object-fit:cover;" alt="Profile Picture"
                onerror="this.src='/assets/default-avatar.png'" />
              <div class="d-flex justify-content-center">
                <input type="file" id="profilePic" name="profilePic" accept="image/*" class="form-control w-auto" />
              </div>
            </div>
            <div class="col-md-4">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" id="firstName" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label for="middleName" class="form-label">Middle Name</label>
              <input type="text" id="middleName" class="form-control" />
            </div>
            <div class="col-md-4">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" id="lastName" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label for="username" class="form-label">Username</label>
              <input type="text" id="username" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label for="email" class="form-label">Email (readonly)</label>
              <input type="email" id="email" class="form-control" readonly />
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-amber">Update Profile</button>
              <button type="button" class="btn btn-amber-outline ms-2" data-bs-toggle="modal"
                data-bs-target="#changePasswordModal">Change Password</button>
            </div>
          </form>
        </div>

        <!-- Change Password Modal -->
        <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="changePasswordForm">
                  <div class="mb-3">
                    <label for="currentPassword" class="form-label">Current Password</label>
                    <input type="password" class="form-control" id="currentPassword" required />
                  </div>
                  <div class="mb-3">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" class="form-control" id="newPassword" required minlength="8" />
                  </div>
                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                    <input type="password" class="form-control" id="confirmPassword" required minlength="8" />
                  </div>
                  <ul class="list-unstyled mt-2" id="pwCriteria">
                    <li id="pwLength"><i class="bi bi-x-circle text-danger me-2"></i>Minimum 8 characters</li>
                    <li id="pwUpper"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 uppercase letter</li>
                    <li id="pwNumber"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 number</li>
                    <li id="pwSpecial"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 special character</li>
                    <li id="pwMatch"><i class="bi bi-x-circle text-danger me-2"></i>Passwords match</li>
                  </ul>
                  <div class="form-check text-start mb-2">
                    <input class="form-check-input" type="checkbox" id="toggleChangePw" />
                    <label class="form-check-label" for="toggleChangePw">Show Password</label>
                  </div>
                  <div id="changePasswordMsg" class="mb-2" style="display:none;"></div>
                  <button type="submit" class="btn btn-amber">Change Password</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- App Alert Modal -->
        <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div id="appAlertHeader" class="modal-header">
                <h5 class="modal-title" id="appAlertTitle">Notice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div id="appAlertBody" class="modal-body"></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
              </div>
            </div>
          </div>
        </div>


      </section>
    </div>
  </div>

  <!-- Sidebar JS -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/ADMIN/components/test.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              toggle.setAttribute('aria-expanded', String(!(toggle.getAttribute('aria-expanded') === 'true')));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <script>
  function showAppAlert(message, { title = "Notice", variant = "primary" } = {}) {
    const header = document.getElementById("appAlertHeader");
    const titleEl = document.getElementById("appAlertTitle");
    const bodyEl  = document.getElementById("appAlertBody");

    // reset header style then apply variant
    header.className = "modal-header";
    const bg = {
      primary:  "bg-primary text-white",
      success:  "bg-success text-white",
      danger:   "bg-danger text-white",
      warning:  "bg-warning",
      info:     "bg-info",
      secondary:"bg-secondary text-white",
      dark:     "bg-dark text-white",
      light:    "bg-light"
    }[variant] || "bg-primary text-white";
    header.classList.add(...bg.split(" "));

    titleEl.textContent = title;
    bodyEl.textContent  = message;

    bootstrap.Modal.getOrCreateInstance(document.getElementById("appAlertModal")).show();
  }
</script>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Profile + Auth Logic -->
  <script>
    const SERVER_BASE = "http://localhost:5000";
    const API = `${SERVER_BASE}/api`;

    // Redirect if not logged in
    const storedUser = JSON.parse(localStorage.getItem("user"));
    if (!storedUser || !storedUser.userId) {
      window.location.href = "/ADMIN/login/login.html";
    }
    const userId = encodeURIComponent(storedUser.userId);

    // Helper: compute initials with smart fallbacks
    function getInitials(info = {}) {
      const f = (info.firstName || "").trim();
      const l = (info.lastName || "").trim();
      const u = (info.username || "").trim();
      const e = (info.email || "").trim();

      if (f || l) {
        let letters = "";
        if (f) letters += f[0];
        if (l) letters += l[0];
        else if (f.length > 1) letters += f[1]; // fallback: second char of first name
        letters = letters.toUpperCase();
        if (letters.length >= 2) return letters.slice(0, 2);
        return (letters + "U").slice(0, 2);
      }
      if (u) {
        const cleaned = u.replace(/[^A-Za-z0-9]/g, "").toUpperCase();
        if (cleaned) return (cleaned + "U").slice(0, 2);
      }
      if (e && e.includes("@")) {
        const local = e.split("@")[0].replace(/[^A-Za-z0-9]/g, "").toUpperCase();
        if (local) return (local + "U").slice(0, 2);
      }
      return "UU";
    }
    function bestFull(info = {}) {
      return [info.firstName, info.middleName, info.lastName].filter(Boolean).join(" ").trim()
        || info.username
        || info.email
        || "User";
    }

    // Header initials
    const UsernameEl = document.getElementById("Username");
    if (UsernameEl) {
      UsernameEl.textContent = getInitials(storedUser);
      UsernameEl.title = bestFull(storedUser);
    }

    // Elements
    const profilePicInput = document.getElementById("profilePic");
    const profilePreview = document.getElementById("profilePreview");

    // Preview selected image
    profilePicInput.addEventListener("change", () => {
      const f = profilePicInput.files[0];
      if (f) profilePreview.src = URL.createObjectURL(f);
    });

    // Load current user
    (async () => {
      try {
        const res = await fetch(`${API}/users/${userId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { success, user } = await res.json();
        if (!success || !user) throw new Error("User not found");

        document.getElementById("firstName").value = user.firstName || "";
        document.getElementById("middleName").value = user.middleName || "";
        document.getElementById("lastName").value = user.lastName || "";
        document.getElementById("username").value = user.username || "";
        document.getElementById("email").value = user.email || "";

        // Update header initials + title from fresh user data
        if (UsernameEl) {
          UsernameEl.textContent = getInitials(user);
          UsernameEl.title = bestFull(user);
        }

        // Keep local cache aligned
        if (user.username) storedUser.username = user.username;
        if (user.firstName) storedUser.firstName = user.firstName;
        if (user.middleName !== undefined) storedUser.middleName = user.middleName || "";
        if (user.lastName) storedUser.lastName = user.lastName;
        if (user.email) storedUser.email = user.email;

        if (user.photoURL) {
          profilePreview.src = `${SERVER_BASE}${user.photoURL}?t=${Date.now()}`;
          storedUser.photoURL = user.photoURL;
        }
        localStorage.setItem("user", JSON.stringify(storedUser));
      } catch (err) {
        console.error("❌ Error fetching user:", err);
      }
    })();

    // Update profile
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData();
      fd.append("firstName", document.getElementById("firstName").value);
      fd.append("middleName", document.getElementById("middleName").value);
      fd.append("lastName", document.getElementById("lastName").value);
      fd.append("username", document.getElementById("username").value);
      if (profilePicInput.files.length) fd.append("profilePic", profilePicInput.files[0]);

      try {
        const res = await fetch(`${API}/users/${userId}/profile`, { method: "POST", body: fd });
        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) throw new Error("Non-JSON response");
        const out = await res.json();

        if (res.ok && out.success) {
          showAppAlert("✅ Profile updated successfully!");
          const u = out.updatedUser || {};

          // Update header initials + title from updated data
          const merged = {
            ...storedUser,
            ...u
          };
          if (UsernameEl) {
            UsernameEl.textContent = getInitials(merged);
            UsernameEl.title = bestFull(merged);
          }

          // Persist updates locally
          if (u.username !== undefined) storedUser.username = u.username;
          if (u.firstName !== undefined) storedUser.firstName = u.firstName;
          if (u.middleName !== undefined) storedUser.middleName = u.middleName;
          if (u.lastName !== undefined) storedUser.lastName = u.lastName;
          if (u.email !== undefined) storedUser.email = u.email;

          if (u.photoURL) {
            profilePreview.src = `${SERVER_BASE}${u.photoURL}?t=${Date.now()}`;
            storedUser.photoURL = u.photoURL;
          }
          localStorage.setItem("user", JSON.stringify(storedUser));
        } else {
          showAppAlert(out?.message || "❌ Failed to update profile.");
        }
      } catch (err) {
        console.error("❌ Profile update failed:", err);
        showAppAlert("❌ Profile update failed.");
      }
    });

    // ===== Auth helpers (robust auto-login) =====
    function persistAuth(obj) {
      const user = obj?.user || obj?.data?.user || obj?.data || obj;
      const token = obj?.token || obj?.accessToken || obj?.jwt || obj?.data?.token || null;
      if (user) localStorage.setItem("user", JSON.stringify({ ...user, token }));
      if (token) localStorage.setItem("authToken", token);
    }

    async function smartLogin({ email, username, password }) {
      const bodies = [];
      if (email) { bodies.push({ email, password }, { identifier: email, password }); }
      if (username) { bodies.push({ username, password }, { identifier: username, password }); }

      const routes = [
        `${API}/login`,
        `${API}/auth/login`,
        `${SERVER_BASE}/login`,
        `${SERVER_BASE}/auth/login`,
      ];

      const creds = ["include", "omit"]; // cookie session + token style
      const errors = [];

      for (const url of routes) {
        for (const body of bodies) {
          for (const credentials of creds) {
            try {
              const r = await fetch(url, {
                method: "POST",
                credentials,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
              });
              const text = await r.text();
              let json = {};
              try { json = JSON.parse(text); } catch { }

              const okUser = json?.user || json?.data?.user || (json?.success && (json?.user || json?.data));
              if (r.ok && okUser) {
                persistAuth(json);
                return json;
              }
              errors.push(`${credentials}@${url} -> ${r.status} ${json?.error || text.slice(0, 120)}`);
            } catch (e) {
              errors.push(`${url} (${credentials}) -> ${e.message}`);
            }
          }
        }
      }
      throw new Error(errors.join(" | "));
    }

    // ===== Change Password (with !important coloring) =====
    const newPw = document.getElementById("newPassword");
    const confirmPw = document.getElementById("confirmPassword");
    const msgDiv = document.getElementById("changePasswordMsg");

    function setMsg(text, color) {
      msgDiv.textContent = text;
      msgDiv.style.display = "block";
      msgDiv.style.setProperty("color", color, "important");
    }
    function clearMsg() {
      msgDiv.textContent = "";
      msgDiv.style.display = "none";
      msgDiv.style.removeProperty("color");
    }

    function tick(el, ok) {
      const i = el.querySelector("i");
      i.classList.toggle("bi-check-circle", ok);
      i.classList.toggle("text-success", ok);
      i.classList.toggle("bi-x-circle", !ok);
      i.classList.toggle("text-danger", !ok);
    }
    function livePw() {
      const p = newPw.value;
      tick(document.getElementById("pwLength"), p.length >= 8);
      tick(document.getElementById("pwUpper"), /[A-Z]/.test(p));
      tick(document.getElementById("pwNumber"), /\d/.test(p));
      tick(document.getElementById("pwSpecial"), /[^A-Za-z0-9]/.test(p));
      tick(document.getElementById("pwMatch"), p === confirmPw.value && p !== "");
    }
    newPw.addEventListener("input", livePw);
    confirmPw.addEventListener("input", livePw);

    document.getElementById("toggleChangePw").addEventListener("change", function () {
      const t = this.checked ? "text" : "password";
      document.getElementById("currentPassword").type = t;
      newPw.type = t; confirmPw.type = t;
    });

    document.getElementById("changePasswordForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg();

      const currentPassword = document.getElementById("currentPassword").value;
      const newPassword = newPw.value;
      const confirmPassword = confirmPw.value;

      if (newPassword.length < 8) return setMsg("New password must be at least 8 characters.", "red");
      if (!/[A-Z]/.test(newPassword)) return setMsg("New password must contain at least 1 uppercase letter.", "red");
      if (!/\d/.test(newPassword)) return setMsg("New password must contain at least 1 number.", "red");
      if (!/[^A-Za-z0-9]/.test(newPassword)) return setMsg("New password must contain at least 1 special character.", "red");
      if (newPassword !== confirmPassword) return setMsg("New passwords do not match.", "red");

      try {
        const res = await fetch(`${API}/users/${userId}/change-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ currentPassword, newPassword }),
        });
        const ct = res.headers.get("content-type") || "";
        const result = ct.includes("application/json") ? await res.json() : { success: false, error: "Non-JSON response" };
        if (!res.ok || !result.success) return setMsg(result?.error || `HTTP ${res.status}`, "red");

        const latestEmail = document.getElementById("email").value || storedUser.email || null;
        const latestUsername = document.getElementById("username").value || storedUser.username || null;

        try {
          await smartLogin({ email: latestEmail, username: latestUsername, password: newPassword });
          setMsg("Password changed!", "green");
          setTimeout(() => {
            bootstrap.Modal.getOrCreateInstance(document.getElementById("changePasswordModal")).hide();
            document.getElementById("changePasswordForm").reset();
            clearMsg();
          }, 1200);
        } catch (loginErr) {
          console.error("Follow-up login failed:", loginErr);
          setMsg("Password changed, but auto-login failed. Please log in again.", "red");
        }
      } catch (err) {
        console.error("Change password error:", err);
        setMsg(err.message || "Unexpected error occurred.", "red");
      }
    });

    // Logout helper
    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/ADMIN/login/login.html";
    }
  </script>
</body>

</html>