<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Teacher - Course Upload</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <!-- Your original CSS -->
  <link rel="stylesheet" href="../courses/course.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main">
       <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box position-relative">
          <input type="text" class="form-control" placeholder="Search..."/>
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>


      <!-- Upload Form -->
      <div class="upload-container mt-3 p-4">
        <div class="form-card">
          <h2 class="mb-4">Course Management - Upload Course</h2>
          <form id="courseUploadForm">
            <div class="mb-3">
              <label for="courseTitle" class="form-label">Course Title</label>
              <input type="text" class="form-control" id="courseTitle" placeholder="Enter course title" required />
            </div>

            <div class="mb-3">
              <label for="courseCategory" class="form-label">Category</label>
              <input type="text" class="form-control" id="courseCategory" placeholder="e.g. Beginner, Intermediate"
                required />
            </div>

            <div class="mb-3">
              <label for="courseDescription" class="form-label">Course Description</label>
              <textarea class="form-control" id="courseDescription" rows="4"
                placeholder="Write a short course description..." required></textarea>
            </div>

            <!-- New Assign-to-Classes Section -->
            <div class="mb-3">
              <label class="form-label">Assign to Classes</label>
              <div id="assignedClassesContainer" class="row g-3">
                <!-- JS will inject one col/card per class -->
              </div>
              <div class="text-white mt-3">Click a card to select which classes get access.</div>
            </div>

            <button type="submit" class="btn btn-upload w-100">Upload Course</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar + Dropdown Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sidebar = document.querySelector(".sidebar"),
                dash    = document.querySelector(".dashboard");
          if (sidebar && dash) {
            sidebar.addEventListener("mouseenter", () => dash.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dash.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const p = toggle.closest('.has-submenu');
              p.classList.toggle('open');
              toggle.setAttribute('aria-expanded', String(!JSON.parse(toggle.getAttribute('aria-expanded'))));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Main Logic -->
  <script>
    const API = "http://localhost:5000";
    const userData = JSON.parse(localStorage.getItem("user")) || {};

    // Redirect if not logged in
    if (!userData.username) {
      window.location.href = "../login/login.html";
    }
    document.getElementById("Username").textContent = userData.username;

    // 1) Fetch teacher's classes and render as selectable cards
    async function loadClasses() {
      try {
        const res = await fetch(`${API}/api/classes?teacherId=${encodeURIComponent(userData.userId)}`);
        const { classes, success } = await res.json();
        if (!success) return;

        const container = document.getElementById("assignedClassesContainer");
        classes.forEach(c => {
          // col wrapper
          const col = document.createElement("div");
          col.className = "col-6 col-md-4";

          // the card itself
          const card = document.createElement("div");
          card.className = "card ";
          card.style.cursor = "pointer";

          // hidden checkbox
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.value = c.id;
          chk.className = "d-none";
          card.appendChild(chk);

          // content
          const body = document.createElement("div");
          body.className = "card-body";
          body.innerHTML = `
            <h5 class="card-title">${c.name}</h5>
            <p class="card-text mb-0">Grade ${c.gradeLevel}, Section ${c.section}</p>
          `;
          card.appendChild(body);

          // toggle selection
          card.addEventListener("click", () => {
            const isChecked = !chk.checked;
            chk.checked = isChecked;
            card.classList.toggle("border-primary", isChecked);
            card.classList.toggle("bg-light", isChecked);
          });

          col.appendChild(card);
          container.appendChild(col);
        });
      } catch (e) {
        console.error("Could not load classes:", e);
      }
    }
    loadClasses();

    // 2) Submit form
    document.getElementById("courseUploadForm").addEventListener("submit", async e => {
      e.preventDefault();

      const payload = {
        title:       document.getElementById("courseTitle").value.trim(),
        category:    document.getElementById("courseCategory").value.trim(),
        description: document.getElementById("courseDescription").value.trim(),
        uploadedBy:  userData.userId,   // better for filtering/ownership later
        assignedClasses: Array.from(
          document.querySelectorAll("#assignedClassesContainer input:checked")
        ).map(i => i.value)
      };

      try {
        const res = await fetch(`${API}/upload-course`, {
          method:  "POST",
          headers: { "Content-Type": "application/json" },
          body:    JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
          alert("‚úÖ Course uploaded!");
          window.location.href = "../courses/course_list.html";
        } else {
          alert("‚ùå " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("üö® Server error");
      }
    });

     function logoutUser() {
      localStorage.removeItem('user');
      window.location.href = '/TEACHER/login/login.html';
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
