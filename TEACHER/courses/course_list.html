<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduConnect Teacher - Course List</title>

  <!-- OPTIONAL: set if backend is a separate Railway service -->
  <!-- <meta name="api-base" content="https://your-backend.up.railway.app"> -->

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Shared styles -->
  <link rel="stylesheet" href="../dashboard/dashboard.css" />
  <link rel="stylesheet" href="course_list.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/components/sidebar.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;
            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");
            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }
            document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
              toggle.addEventListener('click', e => {
                e.preventDefault();
                const parent = toggle.closest('.has-submenu');
                parent.classList.toggle('open');
                const expanded = toggle.getAttribute('aria-expanded') === 'true';
                toggle.setAttribute('aria-expanded', String(!expanded));
              });
            });
          }).catch(err => console.error("Failed to load sidebar:", err));
      });
    </script>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input id="searchBox" type="text" placeholder="Search my courses..." aria-label="Search courses" />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn" onclick="logoutUser()">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <section class="content">
        <h1 class="page-title">My Courses</h1>

        <!-- Controls -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-journal-text"></i> Your Courses</h2>
            <div class="ui-subtext">Use filters to narrow results. Scheduled courses are visible to you and labelled.
            </div>
          </div>

          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-4 col-xl-4">
              <label class="form-label">Category</label>
              <select id="categoryFilter" class="form-select" aria-label="Filter by category">
                <option value="">All categories</option>
              </select>
            </div>

            <div class="col-12 col-md-3 col-xl-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort courses">
                <option value="num_asc" selected>Course # (1 → 999)</option>
                <option value="num_desc">Course # (999 → 1)</option>
                <option value="az">Title A → Z</option>
                <option value="new">Newest first</option>
                <option value="publishSoon">Publish date (soonest)</option>
              </select>
            </div>

            <div class="col-12 col-md-5 col-xl-3">
              <label class="form-label">Show</label>
              <div class="segmented" role="tablist" aria-label="Course visibility">
                <button id="btnActive" class="seg-btn is-active" role="tab" aria-selected="true">Active</button>
                <button id="btnArchived" class="seg-btn is-archived" role="tab" aria-selected="false">Archived</button>
                <button id="btnAll" class="seg-btn is-all" role="tab" aria-selected="false">All</button>
              </div>
            </div>

            <div class="col-12 col-xl-2 d-flex justify-content-xl-end">
              <button class="btn btn-amber w-100 w-xl-auto mt-2 mt-xl-0" onclick="window.location.href='course.html'">
                <i class="bi bi-plus-lg me-1"></i> Add Course
              </button>
            </div>
          </div>
        </div>

        <!-- Count pills -->
        <div class="pill-row">
          <span id="activeCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-check-circle me-1"></i><span id="activeCount">0</span> Active
          </span>
          <span id="archivedCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-archive me-1"></i><span id="archivedCount">0</span> Archived
          </span>
        </div>

        <!-- List -->
        <div id="courseList" class="row g-4"></div>
      </section>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="editCourseForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editCourseModalLabel">Edit Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCourseId" />
          <div class="mb-3">
            <label for="editTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="editTitle" required />
          </div>
          <div class="mb-3">
            <label for="editCategory" class="form-label">Category</label>
            <input type="text" class="form-control" id="editCategory" required />
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" rows="3"></textarea>
          </div>

          <!-- NEW: Publish At -->
          <div class="mb-3">
            <label for="editPublishAt" class="form-label">Publish At (optional)</label>
            <input type="datetime-local" class="form-control" id="editPublishAt" />
            <div class="form-text">
              Leave blank to publish immediately. Your local time will be saved (Philippines time if that’s your device
              timezone).
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Assign to Classes</label>
            <div id="editAssignedClassesContainer" class="row g-2"></div>
            <div class="text-muted mt-1" style="font-size:13px;">
              Check/uncheck to assign or remove classes for this course.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-amber">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Archive / Unarchive Modal -->
  <div class="modal fade" id="archiveCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="archiveCourseId" />
          <p id="archiveModalText" class="mb-0"></p>
          <div class="mt-2 small text-muted">
            Archiving hides this course’s modules and quizzes from teachers and students. You can unarchive later.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">No, cancel</button>
          <button id="confirmArchiveBtn" type="button" class="btn btn-amber">Yes, proceed</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Modal (Type-to-confirm Course Title) -->
  <div class="modal fade" id="deleteCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content confirm-no-copy">
        <div class="modal-header">
          <h5 class="modal-title">Delete Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="deleteCourseBody"></div>
        <div class="modal-footer">
          <input type="hidden" id="deleteCourseId" />
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" type="button" class="btn btn-danger" disabled>
            <i class="bi bi-trash3 me-1"></i>Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic INFO Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Header initials -->
  <script>
    (function initHeaderInitials() {
      try {
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;
        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return;
        }
        window.currentUser = u;

        const initials = (function (u) {
          const fn = (u.firstName || '').trim(), ln = (u.lastName || '').trim();
          if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
          const nameish = (u.username || u.displayName || u.name || '').trim();
          if (nameish) {
            const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ').split(/[\s._-]+/).filter(Boolean);
            if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
            return parts[0][0].toUpperCase();
          }
          const em = (u.email || '').trim(); return em ? em[0].toUpperCase() : 'U';
        })(u);

        window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("Username");
          if (!el) return;
          el.textContent = initials;
          const full = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username || u.email || 'Profile';
          el.setAttribute('title', full);
          el.setAttribute('aria-label', full);
        });
      } catch (e) {
        console.error('initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
      }
    })();
  </script>

  <!-- Page Script -->
  <script>
    /* ========= Railway-friendly API base ========= */
    function resolveApiBase() {
      const meta = document.querySelector('meta[name="api-base"]');
      if (meta && meta.content) return meta.content.replace(/\/+$/, '');
      if (window.__API_BASE__) return String(window.__API_BASE__).replace(/\/+$/, '');
      const host = location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') return 'http://127.0.0.1:5000';
      // same-origin in production (Railway)
      return '';
    }
    const API_BASE = resolveApiBase();
    const api = (path) => `${API_BASE}${path}`;

    // Info modal helper
    const infoModalEl = document.getElementById('infoModal');
    const infoModal = new bootstrap.Modal(infoModalEl);
    function showInfo(title = 'Notice', html = '') {
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').innerHTML = html;
      infoModal.show();
    }

    // State
    let allCourses = [];
    let archiveFilter = 'active'; // 'active' | 'archived' | 'all'
    let currentSort = 'num_asc';
    let currentCategory = '';

    function debounce(fn, delay = 200) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); }; }
    function escapeHtml(s) { return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])) }
    function tsToDate(ts) {
      if (!ts) return null;
      if (typeof ts.toDate === 'function') { try { return ts.toDate(); } catch { } }
      if (ts._seconds != null) return new Date(ts._seconds * 1000 + (ts._nanoseconds ? Math.floor(ts._nanoseconds / 1e6) : 0));
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d;
    }
    function tsToMs(ts) { const d = tsToDate(ts); return d ? d.getTime() : null; }

    function buildCategoryOptions() {
      const sel = document.getElementById('categoryFilter');
      const cats = Array.from(new Set(allCourses.map(c => (c.category || '').trim()).filter(Boolean))).sort((a, b) => a.localeCompare(b));
      sel.innerHTML = '<option value="">All categories</option>' + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }

    async function refreshCoursePills() {
      try {
        const u = window.currentUser;
        if (!u?.userId) return;
        const url = api(`/api/courses?uploadedBy=${encodeURIComponent(u.userId)}&includeArchived=true`);
        const r = await fetch(url);
        const payload = await r.json();
        const courses = Array.isArray(payload) ? payload : (payload.courses || []);
        const activeCount = courses.filter(c => !c.archived).length;
        const archivedCount = courses.filter(c => c.archived).length;
        document.getElementById('activeCount').textContent = String(activeCount);
        document.getElementById('archivedCount').textContent = String(archivedCount);
      } catch (err) {
        console.error('refreshCoursePills error:', err);
        document.getElementById('activeCount').textContent = '0';
        document.getElementById('archivedCount').textContent = '0';
      }
    }

    async function loadCourses() {
      try {
        const u = window.currentUser;
        const url = api(`/api/courses?uploadedBy=${encodeURIComponent(u.userId)}&includeArchived=true`);
        const res = await fetch(url);
        const payload = await res.json();
        const courses = Array.isArray(payload) ? payload : (payload.courses || []);

        // normalize + keep publishAt
        allCourses = courses.map(c => ({
          id: c.id,
          title: c.title || 'Untitled',
          description: c.description || '',
          category: c.category || '',
          courseNumber: c.courseNumber || null,
          archived: !!c.archived,
          createdAt: c.createdAt || null,
          publishAt: c.publishAt || null
        }));

        buildCategoryOptions();
        applyFiltersAndRender();
        refreshCoursePills();
      } catch (e) {
        console.error(e);
        showInfo('Load Error', 'Failed to load courses.');
      }
    }

    function applyFiltersAndRender() {
      const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();

      let list = allCourses.filter(c => {
        const matchesSearch = !q ||
          (c.title || '').toLowerCase().includes(q) ||
          (c.category || '').toLowerCase().includes(q) ||
          String(c.courseNumber || '').toLowerCase().includes(q);

        const isArchived = !!c.archived;
        const matchesArchive =
          archiveFilter === 'all' ||
          (archiveFilter === 'active' && !isArchived) ||
          (archiveFilter === 'archived' && isArchived);

        const matchesCategory = !currentCategory || (c.category || '') === currentCategory;

        return matchesSearch && matchesArchive && matchesCategory;
      });

      // Sort
      if (currentSort === 'num_asc') {
        list.sort((a, b) => (Number(a.courseNumber) || 0) - (Number(b.courseNumber) || 0));
      } else if (currentSort === 'num_desc') {
        list.sort((a, b) => (Number(b.courseNumber) || 0) - (Number(a.courseNumber) || 0));
      } else if (currentSort === 'az') {
        list.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      } else if (currentSort === 'new') {
        list.sort((a, b) => (tsToMs(b.createdAt) ?? 0) - (tsToMs(a.createdAt) ?? 0));
      } else if (currentSort === 'publishSoon') {
        // Put scheduled first by soonest publishAt; items without publishAt go to the end
        list.sort((a, b) => {
          const am = tsToMs(a.publishAt) ?? Infinity;
          const bm = tsToMs(b.publishAt) ?? Infinity;
          return am - bm;
        });
      }

      renderCourses(list);
    }

    function renderCourses(courses) {
      const list = document.getElementById("courseList");
      list.innerHTML = '';

      if (!courses.length) {
        list.innerHTML = `
          <div class="col-12">
            <div class="empty-card text-center p-5">
              <div class="mb-2"><i class="bi bi-inbox" style="font-size:2rem; opacity:.6;"></i></div>
              <h5 class="mb-1">No courses found</h5>
              <div class="text-muted">Try adjusting your search or filters.</div>
            </div>
          </div>`;
        return;
      }

      const now = Date.now();

      courses.forEach(c => {
        const isArchived = !!c.archived;
        const pubDate = tsToDate(c.publishAt);
        const isScheduled = !!(pubDate && pubDate.getTime() > now);

        const archivedBadge = isArchived
          ? `<span class="badge-soft ms-2" title="Archived" style="border-color:#999;color:#555;background:linear-gradient(90deg,rgba(0,0,0,.06),rgba(0,0,0,.06));">
               <i class="bi bi-archive"></i> Archived
             </span>` : '';

        const scheduledBadge = isScheduled
          ? `<span class="badge-soft ms-2" title="Scheduled publish time">
               <i class="bi bi-clock-history"></i> Scheduled: ${pubDate.toLocaleString()}
             </span>` : '';

        const col = document.createElement('div');
        col.className = 'col-sm-6 col-lg-4 col-xxl-3';
        col.innerHTML = `
          <div class="course-card">
            <div>
              <h5 class="course-title">${escapeHtml(c.title || 'Untitled')}</h5>
              <div class="mb-2">
                <span class="badge-soft"><i class="bi bi-collection"></i> Course #${c.courseNumber || '—'}</span>
                ${archivedBadge}
                ${scheduledBadge}
              </div>
              <p class="mb-1"><strong>Category:</strong> ${escapeHtml(c.category || '—')}</p>
              <p class="course-meta mb-0">${escapeHtml(c.description || 'No description provided.')}</p>
            </div>
            <div class="course-actions d-flex justify-content-between pt-3 mt-3">
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-amber edit-btn" data-id="${c.id}"><i class="bi bi-pencil-square me-1"></i>Edit</button>
                <button class="btn btn-sm ${isArchived ? 'btn-outline-secondary' : 'btn-outline-warning'} archive-btn"
                        data-id="${c.id}" data-archived="${isArchived}">
                  <i class="bi ${isArchived ? 'bi-archive' : 'bi-archive-fill'} me-1"></i>${isArchived ? 'Unarchive' : 'Archive'}
                </button>
              </div>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${c.id}">
                <i class="bi bi-trash3 me-1"></i>Delete
              </button>
            </div>
          </div>`;
        list.appendChild(col);
      });
    }

    // Search (debounced)
    document.getElementById('searchBox').addEventListener('input', debounce(applyFiltersAndRender, 200));
    // Controls
    document.getElementById('sortBy').addEventListener('change', e => { currentSort = e.target.value; applyFiltersAndRender(); });
    document.getElementById('categoryFilter').addEventListener('change', e => { currentCategory = e.target.value || ''; applyFiltersAndRender(); });
    function setSegmentedActive(which) {
      archiveFilter = which;
      const btnActive = document.getElementById('btnActive');
      const btnArchived = document.getElementById('btnArchived');
      const btnAll = document.getElementById('btnAll');
      [btnActive, btnArchived, btnAll].forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected', 'false'); });
      if (which === 'active') { btnActive.classList.add('is-active'); btnActive.setAttribute('aria-selected', 'true'); }
      if (which === 'archived') { btnArchived.classList.add('is-active'); btnArchived.setAttribute('aria-selected', 'true'); }
      if (which === 'all') { btnAll.classList.add('is-active'); btnAll.setAttribute('aria-selected', 'true'); }
      applyFiltersAndRender();
    }
    document.getElementById('btnActive').addEventListener('click', () => setSegmentedActive('active'));
    document.getElementById('btnArchived').addEventListener('click', () => setSegmentedActive('archived'));
    document.getElementById('btnAll').addEventListener('click', () => setSegmentedActive('all'));

    // Edit / Archive / Delete interactions
    document.getElementById("courseList").addEventListener("click", async e => {
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.dataset.id;

      // EDIT
      if (btn.classList.contains("edit-btn")) {
        let course;
        try {
          const r = await fetch(api(`/api/courses/${id}`));
          const j = await r.json();
          course = j.course || j;
        } catch {
          showInfo('Load Error', 'Failed to load course.');
          return;
        }

        document.getElementById("editCourseId").value = course.id;
        document.getElementById("editTitle").value = course.title || '';
        document.getElementById("editCategory").value = course.category || '';
        document.getElementById("editDescription").value = course.description || '';

        // publishAt -> datetime-local value (local time)
        const pAt = (course.publishAt && (course.publishAt._seconds != null))
          ? new Date(course.publishAt._seconds * 1000 + (course.publishAt._nanoseconds ? Math.floor(course.publishAt._nanoseconds / 1e6) : 0))
          : (course.publishAt ? new Date(course.publishAt) : null);

        const dtInput = document.getElementById('editPublishAt');
        if (pAt && !isNaN(pAt.getTime())) {
          const pad = n => String(n).padStart(2, '0');
          const v = `${pAt.getFullYear()}-${pad(pAt.getMonth() + 1)}-${pad(pAt.getDate())}T${pad(pAt.getHours())}:${pad(pAt.getMinutes())}`;
          dtInput.value = v;
        } else {
          dtInput.value = '';
        }

        const cont = document.getElementById("editAssignedClassesContainer");
        cont.innerHTML = '';
        try {
          const r2 = await fetch(api(`/api/classes?teacherId=${encodeURIComponent(window.currentUser.userId)}`));
          const { success, classes } = await r2.json();
          if (success && Array.isArray(classes)) {
            classes.forEach(cls => {
              const col = document.createElement('div');
              col.className = 'col-12';
              col.innerHTML = `
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="cls_${cls.id}" value="${cls.id}">
                  <label class="form-check-label" for="cls_${cls.id}">${cls.name} (${cls.gradeLevel}-${cls.section})</label>
                </div>`;
              cont.appendChild(col);

              const chk = col.querySelector('input');
              if (Array.isArray(course.assignedClasses) &&
                course.assignedClasses.map(String).includes(String(cls.id))) {
                chk.checked = true;
              }
            });
          } else {
            cont.innerHTML = '<div class="text-danger">No classes found.</div>';
          }
        } catch { cont.innerHTML = '<div class="text-danger">Error loading classes.</div>'; }

        new bootstrap.Modal(document.getElementById("editCourseModal")).show();
      }

      // DELETE (open modal with type-to-confirm)
      if (btn.classList.contains("delete-btn")) {
        openDeleteModal(id);
      }

      // ARCHIVE / UNARCHIVE
      if (btn.classList.contains("archive-btn")) {
        const isArchived = btn.getAttribute('data-archived') === 'true';
        openArchiveModal(id, isArchived);
      }
    });

    // Save Edit
    document.getElementById("editCourseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editCourseId").value;

      const dtVal = document.getElementById('editPublishAt').value; // "YYYY-MM-DDTHH:mm"
      let publishAt = null;
      if (dtVal) {
        const d = new Date(dtVal);
        if (!isNaN(d.getTime())) publishAt = d.toISOString();
      }

      const body = {
        title: document.getElementById("editTitle").value.trim(),
        category: document.getElementById("editCategory").value.trim(),
        description: document.getElementById("editDescription").value.trim(),
        assignedClasses: Array.from(document.querySelectorAll("#editAssignedClassesContainer input[type=checkbox]:checked"))
          .map(chk => chk.value),
        publishAt
      };

      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      const prev = btn.innerHTML; btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';

      try {
        const r = await fetch(api(`/api/courses/${id}`), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if (j.success) {
          bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
          await loadCourses();
        } else {
          showInfo('Update Failed', `Update failed: ${j.message || 'Unknown error'}.`);
        }
      } catch (err) {
        console.error(err);
        showInfo('Server Error', 'A server error occurred while updating the course.');
      } finally {
        btn.disabled = false; btn.innerHTML = prev;
      }
    });

    // Archive modal open
    function openArchiveModal(id, isArchived) {
      document.getElementById('archiveCourseId').value = id;
      document.getElementById('archiveModalText').textContent =
        isArchived
          ? "Unarchive this course? It will become visible again to you and your students where applicable."
          : "Archive this course? Its modules and quizzes will be hidden from teachers and students.";
      new bootstrap.Modal(document.getElementById('archiveCourseModal')).show();
    }
    // Confirm archive/unarchive
    document.getElementById('confirmArchiveBtn').addEventListener('click', async () => {
      const id = document.getElementById('archiveCourseId').value;
      const course = allCourses.find(c => String(c.id) === String(id));
      const makeArchived = course ? !course.archived : true;

      try {
        const r = await fetch(api(`/api/courses/${id}/${makeArchived ? 'archive' : 'unarchive'}`), { method: 'POST' });
        const j = await r.json();
        if (j.success) {
          bootstrap.Modal.getInstance(document.getElementById('archiveCourseModal')).hide();
          await loadCourses();
          await refreshCoursePills();
        } else {
          showInfo('Action Failed', `Action failed: ${j.message || 'Unknown error'}.`);
        }
      } catch (err) {
        console.error(err);
        showInfo('Server Error', 'A server error occurred while performing this action.');
      }
    });

    // ===== Delete Modal (Course Title type-to-confirm) =====
    function blockCopyHandlers(e) { e.preventDefault(); }
    function attachCopyBlockers(el) {
      el.addEventListener('copy', blockCopyHandlers);
      el.addEventListener('cut', blockCopyHandlers);
      el.addEventListener('contextmenu', blockCopyHandlers);
      return () => {
        el.removeEventListener('copy', blockCopyHandlers);
        el.removeEventListener('cut', blockCopyHandlers);
        el.removeEventListener('contextmenu', blockCopyHandlers);
      };
    }

    function openDeleteModal(id) {
      const course = allCourses.find(c => String(c.id) === String(id));
      const expected = course ? String(course.title || '') : '';

      document.getElementById('deleteCourseId').value = id;

      const body = document.getElementById('deleteCourseBody');
      body.innerHTML = `
        <p class="mb-2">Are you sure you want to <strong>permanently delete</strong> this course? This cannot be undone.</p>
        <div class="small text-muted mb-3">Tip: If you only want to hide the course, use <strong>Archive</strong> instead.</div>

        <div class="mb-2">
          Confirm by typing the <strong>Course Title</strong> exactly (case-sensitive).
        </div>
        <div class="alert alert-danger py-2 small mb-2" title="Copy disabled in this area">
          Type exactly: <code>${escapeHtml(expected)}</code>
        </div>

        <input type="text" class="form-control" id="deleteConfirmInput"
               placeholder="Type Course Title here" autocomplete="off" />

        <div class="invalid-feedback">
          Input does not match. Please type <strong>${escapeHtml(expected)}</strong> to proceed.
        </div>
        <div class="valid-feedback">
          ✓ Input matches
        </div>
      `;

      const modalEl = document.getElementById('deleteCourseModal');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const input = document.getElementById('deleteConfirmInput');

      confirmBtn.disabled = true; // start disabled

      const detach = attachCopyBlockers(modalEl);

      const onInput = () => {
        const match = (input.value.trim() === expected);
        input.classList.toggle('is-valid', match);
        input.classList.toggle('is-invalid', !match);
        confirmBtn.disabled = !match;
      };
      input.addEventListener('input', onInput);

      // cleanup when modal hides
      modalEl.addEventListener('hidden.bs.modal', function onHide() {
        modalEl.removeEventListener('hidden.bs.modal', onHide);
        input.removeEventListener('input', onInput);
        detach();
        confirmBtn.disabled = false; // reset
      }, { once: true });

      new bootstrap.Modal(modalEl).show();
      setTimeout(() => { input.focus(); onInput(); }, 120);
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      const id = document.getElementById('deleteCourseId').value;
      const btn = document.getElementById('confirmDeleteBtn');
      if (btn.disabled) return; // guard

      const prevHTML = btn.innerHTML; btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Deleting...';

      try {
        const r = await fetch(api(`/api/courses/${id}`), { method: 'DELETE' });
        const j = await r.json();
        if (j.success) {
          bootstrap.Modal.getInstance(document.getElementById('deleteCourseModal')).hide();
          await loadCourses();
          await refreshCoursePills();
        } else {
          showInfo('Delete Failed', `Delete failed: ${j.message || 'Unknown error'}.`);
        }
      } catch (err) {
        console.error(err);
        showInfo('Server Error', 'A server error occurred while deleting the course.');
      } finally {
        btn.disabled = false; btn.innerHTML = prevHTML;
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCourses();
      await refreshCoursePills();
    });

    function logoutUser() {
      localStorage.removeItem('user');
      window.location.href = '/TEACHER/login/login.html';
    }
  </script>
</body>

</html>
