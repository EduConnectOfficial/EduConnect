<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Sign Up</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="signup1.css" />
</head>
<body>
  <!-- Top Logo -->
  <div class="top-logo text-center brand">
    <!-- CSIS logo beside EduConnect -->
    <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
    <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo" />
  </div>


 <!-- Signup Container -->
<div class="login-container">
  <div class="login-box text-center">
    <img src="/assets/signup_text.png" alt="Login" class="img-fluid mb-4" style="max-width: 200px;" />

    <form id="signupStep1Form" novalidate>
      <!-- Username -->
      <div class="mb-3 text-start">
        <label for="username" class="form-label">Username</label>
        <input type="text" id="username" class="form-control" placeholder="Choose a username" required />
        <div id="usernameTaken" class="small mt-1"></div>
      </div>

      <!-- First Name -->
      <div class="mb-3 text-start">
        <label for="firstName" class="form-label">First Name</label>
        <input type="text" id="firstName" class="form-control" placeholder="Enter your first name" required />
      </div>

      <!-- Middle Name -->
      <div class="mb-3 text-start">
        <label for="middleName" class="form-label">Middle Name</label>
        <input type="text" id="middleName" class="form-control" placeholder="Enter your middle name (optional)" />
      </div>

      <!-- Last Name -->
      <div class="mb-3 text-start">
        <label for="lastName" class="form-label">Last Name</label>
        <input type="text" id="lastName" class="form-control" placeholder="Enter your last name" required />
      </div>

      <!-- Email -->
      <div class="mb-3 text-start">
        <label for="email" class="form-label">Email</label>
        <input type="email" id="email" class="form-control" placeholder="Enter your email address" required />
        <div id="emailTaken" class="small mt-1"></div>
      </div>

      <!-- Password -->
      <div class="mb-3 text-start">
        <label for="password" class="form-label">Password</label>
        <input type="password" id="password" class="form-control" placeholder="Create a password" required />
      </div>

      <!-- Confirm Password -->
      <div class="mb-3 text-start">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <input type="password" id="confirmPassword" class="form-control" placeholder="Re-enter your password" required />
        <ul class="list-unstyled mt-2" id="passwordCriteria">
          <li id="lengthCheck"><i class="bi bi-x-circle text-danger me-2"></i>Minimum 8 characters</li>
          <li id="uppercaseCheck"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 uppercase letter</li>
          <li id="numberCheck"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 number</li>
          <li id="specialCharCheck"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 special character</li>
          <li id="matchCheck"><i class="bi bi-x-circle text-danger me-2"></i>Passwords match</li>
        </ul>
      </div>

      <!-- Show/Hide Password -->
      <div class="form-check text-start mb-3">
        <input class="form-check-input" type="checkbox" id="togglePassword" />
        <label class="form-check-label" for="togglePassword">Show Password</label>
      </div>

      <!-- Error Messages -->
      <div id="passwordError" class="text-danger mb-2"></div>
      <div id="signupError" class="text-danger mb-3"></div>

      <!-- Submit -->
      <button type="submit" id="submitBtn" class="btn login-btn w-100 mb-3" disabled>Submit</button>
    </form>

    <p class="options text-white">
      Already have an account? <a href="../login/login.html">Login</a>
    </p>
  </div>
</div>


  <!-- Success Modal (uses your modal CSS) -->
  <div class="modal fade" id="signupModal" tabindex="-1" aria-hidden="true" aria-labelledby="signupModalLabel">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="signupModalLabel" class="modal-title">
            <i class="bi bi-envelope-check me-2"></i>Verify your email
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          We sent a verification code to <strong><span id="modalEmail"></span></strong>.
          Please check your inbox to continue.
        </div>
        <div class="modal-footer">
          <button type="button" id="goVerifyBtn" class="btn btn-primary">Go to verification</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "http://localhost:5000";

    // Elements
    const usernameInput = document.getElementById("username");
    const usernameTakenDiv = document.getElementById("usernameTaken");
    const emailInput = document.getElementById("email");
    const emailTakenDiv = document.getElementById("emailTaken");
    const submitBtn = document.getElementById("submitBtn");
    const signupForm = document.getElementById("signupStep1Form");

    const firstNameInput = document.getElementById("firstName");
    const middleNameInput = document.getElementById("middleName");
    const lastNameInput = document.getElementById("lastName");
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirmPassword");
    const passwordErrorDiv = document.getElementById("passwordError");
    const signupErrorDiv = document.getElementById("signupError");

    const lengthCheck = document.getElementById("lengthCheck");
    const uppercaseCheck = document.getElementById("uppercaseCheck");
    const specialCharCheck = document.getElementById("specialCharCheck");
    const numberCheck = document.getElementById("numberCheck");
    const matchCheck = document.getElementById("matchCheck");

    // Modal refs
    const modalEl = document.getElementById("signupModal");
    const modalEmailEl = document.getElementById("modalEmail");
    const goVerifyBtn = document.getElementById("goVerifyBtn");
    const verifyModal = new bootstrap.Modal(modalEl, { backdrop: "static", keyboard: false });

    // Mask email helper
    function maskEmail(email) {
      if (!email || !email.includes("@")) return email;
      const [local, domain] = email.split("@");
      if (local.length <= 2) return local[0] + "•••@" + domain;
      return local.slice(0, 2) + "•••@" + domain;
    }

    function showVerifyModal(email) {
      modalEmailEl.textContent = maskEmail(email || "");
      verifyModal.show();
    }

    goVerifyBtn.addEventListener("click", () => {
      window.location.href = "/TEACHER/signUp/verification.html";
    });
    modalEl.addEventListener("hidden.bs.modal", () => {
      window.location.href = "/TEACHER/signUp/verification.html";
    });

    // State
    let isUsernameOk = false;
    let isEmailOk = false;
    let usernameController = null;
    let emailController = null;

    // Show/hide password
    document.getElementById("togglePassword").addEventListener("change", () => {
      const t = document.getElementById("togglePassword").checked ? "text" : "password";
      passwordInput.type = t;
      confirmPasswordInput.type = t;
    });

    // helpers
    function setStatus(el, { text = "", ok = null } = {}) {
      el.textContent = text;
      el.classList.remove("text-success", "text-danger");
      if (ok === true) el.classList.add("text-success");
      if (ok === false) el.classList.add("text-danger");
    }
    const trimmed = v => (v || "").trim();
    const normalizeUsername = v => trimmed(v).replace(/\s+/g, "");
    const normalizeEmail = v => trimmed(v).toLowerCase();
    function debounce(fn, ms=350){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

    // availability checks with cancellation
    async function checkUsername() {
      const u = normalizeUsername(usernameInput.value);
      isUsernameOk = false;
      setStatus(usernameTakenDiv, { text: "", ok: null });
      if (!u) { updateSubmitState(); return; }

      if (usernameController) usernameController.abort();
      usernameController = new AbortController();

      try {
        setStatus(usernameTakenDiv, { text: "Checking...", ok: null });
        const res = await fetch(`${API_BASE}/check-username?username=${encodeURIComponent(u)}`, {
          signal: usernameController.signal
        });
        const js = await res.json();
        if (js.taken) {
          isUsernameOk = false;
          setStatus(usernameTakenDiv, { text: "❌ Username already taken", ok: false });
        } else {
          isUsernameOk = true;
          setStatus(usernameTakenDiv, { text: "✅ Username available", ok: true });
        }
      } catch(e) {
        if (e.name !== "AbortError") {
          isUsernameOk = false;
          setStatus(usernameTakenDiv, { text: "Couldn’t verify username right now.", ok: false });
        }
      } finally {
        updateSubmitState();
      }
    }

    async function checkEmail() {
      const e = normalizeEmail(emailInput.value);
      isEmailOk = false;
      setStatus(emailTakenDiv, { text: "", ok: null });
      if (!e) { updateSubmitState(); return; }

      if (emailController) emailController.abort();
      emailController = new AbortController();

      try {
        setStatus(emailTakenDiv, { text: "Checking...", ok: null });
        const res = await fetch(`${API_BASE}/check-email?email=${encodeURIComponent(e)}`, {
          signal: emailController.signal
        });
        const js = await res.json();
        if (js.taken) {
          isEmailOk = false;
          setStatus(emailTakenDiv, { text: "❌ Email already taken", ok: false });
        } else {
          isEmailOk = true;
          setStatus(emailTakenDiv, { text: "✅ Email available", ok: true });
        }
      } catch(err) {
        if (err.name !== "AbortError") {
          isEmailOk = false;
          setStatus(emailTakenDiv, { text: "Couldn’t verify email right now.", ok: false });
        }
      } finally {
        updateSubmitState();
      }
    }

    const checkUsernameDebounced = debounce(checkUsername, 300);
    const checkEmailDebounced = debounce(checkEmail, 300);

    usernameInput.addEventListener("input", () => {
      usernameInput.value = normalizeUsername(usernameInput.value);
      checkUsernameDebounced();
    });
    usernameInput.addEventListener("blur", checkUsername);

    emailInput.addEventListener("input", checkEmailDebounced);
    emailInput.addEventListener("blur", () => {
      emailInput.value = normalizeEmail(emailInput.value);
      checkEmail();
    });

    // password criteria (live)
    function updateRequirement(el, cond) {
      const icon = el.querySelector("i");
      icon.classList.toggle("bi-check-circle", cond);
      icon.classList.toggle("text-success", cond);
      icon.classList.toggle("bi-x-circle", !cond);
      icon.classList.toggle("text-danger", !cond);
    }
    function meetsPasswordPolicy(pw, confirm) {
      const okLen = pw.length >= 8;
      const okUpper = /[A-Z]/.test(pw);
      const okNum = /\d/.test(pw);
      const okSpec = /[^A-Za-z0-9]/.test(pw);
      const okMatch = pw === confirm && pw !== "";
      updateRequirement(lengthCheck, okLen);
      updateRequirement(uppercaseCheck, okUpper);
      updateRequirement(numberCheck, okNum);
      updateRequirement(specialCharCheck, okSpec);
      updateRequirement(matchCheck, okMatch);
      return okLen && okUpper && okNum && okSpec && okMatch;
    }
    function validatePasswordLive() {
      meetsPasswordPolicy(passwordInput.value, confirmPasswordInput.value);
      updateSubmitState();
    }
    passwordInput.addEventListener("input", validatePasswordLive);
    confirmPasswordInput.addEventListener("input", validatePasswordLive);

    ["input","blur"].forEach(evt=>{
      [usernameInput, firstNameInput, lastNameInput, emailInput, passwordInput, confirmPasswordInput]
        .forEach(el => el.addEventListener(evt, updateSubmitState));
    });

    function allRequiredFilled(){
      return (
        normalizeUsername(usernameInput.value) &&
        trimmed(firstNameInput.value) &&
        trimmed(lastNameInput.value) &&
        trimmed(emailInput.value) &&
        trimmed(passwordInput.value) &&
        trimmed(confirmPasswordInput.value)
      );
    }
    function updateSubmitState(){
      const pwOk = meetsPasswordPolicy(passwordInput.value, confirmPasswordInput.value);
      submitBtn.disabled = !(allRequiredFilled() && isUsernameOk && isEmailOk && pwOk);
    }

    // submit
    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      signupErrorDiv.textContent = "";
      passwordErrorDiv.textContent = "";

      const username = normalizeUsername(usernameInput.value);
      const email = normalizeEmail(emailInput.value);
      const pw = passwordInput.value.trim();
      const cp = confirmPasswordInput.value.trim();

      if (!meetsPasswordPolicy(pw, cp)) {
        passwordErrorDiv.textContent = "Please meet all password requirements.";
        return;
      }
      if (!isUsernameOk || !isEmailOk) {
        signupErrorDiv.textContent = "Please resolve username/email availability first.";
        return;
      }

      const payload = {
        firstName: trimmed(firstNameInput.value),
        middleName: trimmed(middleNameInput.value),
        lastName: trimmed(lastNameInput.value),
        username,
        email,
        password: pw,
        active: true,
        isUser: true,
        isAdmin: false,
        isMobile: false,
        isTeacher: true,
        isStudent: false
      };

      submitBtn.disabled = true;
      const prevText = submitBtn.textContent;
      submitBtn.textContent = "Submitting...";

      try {
        const res = await fetch(`${API_BASE}/signup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const js = await res.json();

        if (!res.ok) {
          signupErrorDiv.textContent = js.error || "Signup failed.";
          submitBtn.disabled = false;
          submitBtn.textContent = prevText;
          return;
        }

        // store minimal info for verification step
        sessionStorage.setItem("pendingEmail", payload.email);
        sessionStorage.setItem("pendingUserData", JSON.stringify({
          firstName: payload.firstName,
          lastName: payload.lastName,
          username: payload.username
        }));

        // Show modal with masked email
        showVerifyModal(payload.email);

      } catch (err) {
        console.error(err);
        signupErrorDiv.textContent = "Could not connect to the server.";
        submitBtn.disabled = false;
        submitBtn.textContent = prevText;
      }
    });

    // Initial state
    submitBtn.disabled = true;
  </script>
</body>
</html>
