<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Teacher - Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="dashboard.css"/>
</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo"/>
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header"/>
        </div>
        <div class="search-box position-relative">
          <input type="text" class="form-control" placeholder="Search..."/>
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <section class="content">
        <h1 class="page-title">Teacher Dashboard</h1>

        <div id="summaryRow" class="d-flex flex-wrap gap-3 mb-4">
          <div class="card flex-fill bg-primary text-white p-3">
            <h6>Total Classes</h6>
            <h2 id="statClasses" class="skeleton" style="min-width:80px;min-height:32px"></h2>
          </div>
          <div class="card flex-fill bg-success text-white p-3">
            <h6>Total Students</h6>
            <h2 id="statStudents" class="skeleton" style="min-width:80px;min-height:32px"></h2>
          </div>
          <div class="card flex-fill bg-info text-white p-3">
            <h6>Modules Published</h6>
            <h2 id="statModules" class="skeleton" style="min-width:80px;min-height:32px"></h2>
          </div>
          <div class="card flex-fill bg-warning text-dark p-3">
            <h6>Quizzes Created</h6>
            <h2 id="statQuizzes" class="skeleton" style="min-width:80px;min-height:32px"></h2>
          </div>
          <div class="card flex-fill bg-danger text-white p-3">
            <h6>Pending Submissions</h6>
            <h2 id="statPending" class="skeleton" style="min-width:80px;min-height:32px"></h2>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-5">
          <button class="btn btn-outline-primary" onclick="location.href='/TEACHER/classes/class_list.html'">
            <i class="bi bi-file-earmark-plus-fill"></i> Create Class
          </button>
          <button class="btn btn-outline-success" onclick="location.href='/TEACHER/modules/select_Course.html'">
            <i class="bi bi-file-earmark-plus-fill"></i> New Module
          </button>
          <button class="btn btn-outline-info" onclick="location.href='/TEACHER/quizzes/quiz.html'">
            <i class="bi bi-patch-plus-fill"></i> New Quiz
          </button>
          <button class="btn btn-outline-warning" onclick="location.href='/TEACHER/announcements/announcements.html'">
            <i class="bi bi-megaphone-fill"></i> Post Announcement
          </button>
        </div>

        <h2 class="mb-3">My Classes</h2>
        <div class="table-responsive mb-5">
          <table class="table table-striped" id="classesOverview">
            <thead class="table-light">
              <tr>
                <th>Class</th>
                <th>Students</th>
                <th>Avg. Grade</th>
                <th>Completion %</th>
                <th>Next Due</th>
              </tr>
            </thead>
            <tbody id="classesTbody">
              <tr><td colspan="5" class="text-center text-muted py-4">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <h2 class="mb-3">Recent Submissions</h2>
        <div class="table-responsive mb-5">
          <table class="table table-striped" id="recentSubmissions">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>Class</th>
                <th>Title</th>
                <th>Submitted At</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="subsTbody">
              <tr><td colspan="6" class="text-center text-muted py-4">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <h2 class="mb-3">Performance Insights</h2>
        <div class="row gy-4 mb-5">
          <div class="col-md-4">
            <div class="card p-3 chart-card">
              <h6 id="quizPerfTitle">Quiz Performance (Avg % per Quiz)</h6>
              <div id="quizPerfHolder"><canvas id="quizPerfChart"></canvas></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card p-3 chart-card">
              <h6>Module Completion Rate</h6>
              <div class="chart-holder"><canvas id="completionRateChart"></canvas></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card p-3 chart-card">
              <h6>Time on Task</h6>
              <div class="chart-holder"><canvas id="timeOnTaskChart"></canvas></div>
            </div>
          </div>
        </div>

        <h2 class="mb-3">Upcoming Schedule</h2>
        <ul class="list-group mb-5" id="upcomingSchedule">
          <li class="list-group-item text-muted">Loading…</li>
        </ul>

        <h2 class="mb-3">Recent Announcements</h2>
        <ul class="list-group mb-5" id="announcementsSnapshot">
          <li class="list-group-item text-muted">Loading…</li>
        </ul>
      </section>
    </div>
  </div>

  <!-- API base: auto-detect (Railway same-origin), override via ?api=, localStorage.apiBase, or window.API_URL -->
  <script>
    (function decideApiBase(){
      const q = new URLSearchParams(location.search);
      const fromQuery = q.get('api');
      const fromLocal = localStorage.getItem('apiBase');
      const fromWindow = (typeof window.API_URL === 'string' && window.API_URL.trim()) ? window.API_URL.trim() : null;

      function isLocalHost(h){ return h === 'localhost' || h === '127.0.0.1'; }

      let base = '';
      if (fromQuery) {
        base = fromQuery;
        localStorage.setItem('apiBase', base); // remember override
      } else if (fromLocal) {
        base = fromLocal;
      } else if (fromWindow) {
        base = fromWindow;
      } else if (isLocalHost(location.hostname)) {
        base = 'http://localhost:5000';
      } else {
        base = ''; // Railway / production → same-origin
      }

      // normalize (trim trailing slash)
      base = base.replace(/\/+$/,'');
      window.API_BASE = base;

      // Optional: quick health ping to surface backend reachability in console
      const ping = (path) => fetch(path, { method: 'GET' }).then(r => r.ok).catch(() => false);
      const hp1 = (base ? `${base}/api/health` : '/api/health');
      const hp2 = (base ? `${base}/health`     : '/health');
      ping(hp1).then(ok => { if (!ok) return ping(hp2); });
      console.log('[api] base =', base || '(same-origin)');
    })();
  </script>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              toggle.setAttribute('aria-expanded', parent.classList.contains('open'));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Header initials + teacher gate -->
  <script>
    (function initHeaderInitials(){
      try{
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;

        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return;
        }
        window.currentUser = u;

        const initials = (function getInitials(u){
          const fn = (u.firstName || '').trim();
          const ln = (u.lastName  || '').trim();
          if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
          const nameish = (u.username || u.displayName || u.name || '').trim();
          if (nameish){
            const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
              .split(/[\s._-]+/).filter(Boolean);
            if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
            return parts[0][0].toUpperCase();
          }
          const em = (u.email || '').trim();
          return em ? em[0].toUpperCase() : 'U';
        })(u);

        window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("Username");
          if (!el) return;
          el.textContent = initials;
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
                        || u.username || u.email || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        });
      }catch(e){
        console.error('initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
      }
    })();
  </script>

  <!-- Dashboard logic -->
  <script>
    // -------- API helpers ----------
    function makeURLs(pathWithQuery) {
      const clean = (s) => s.replace(/\/+/g,'/');
      const p = String(pathWithQuery || '').replace(/^\/+/, '');
      const b = window.API_BASE || '';
      // Try "same path" and "/api/<path>" as fallback (covers your server routes)
      return [
        clean(`${b}/${p}`),
        clean(`${b}/api/${p}`)
      ];
    }

    async function fetchJSONFallback(pathsOrPath, options) {
      const paths = Array.isArray(pathsOrPath) ? pathsOrPath : [pathsOrPath];
      for (const p of paths) {
        try {
          const r = await fetch(p, options);
          if (r.status === 404) continue;     // try next form
          let js = {};
          try { js = await r.json(); } catch { js = {}; }
          return { response: r, json: js };
        } catch {
          // try next URL
        }
      }
      throw new Error('All endpoints failed');
    }

    // ---------- DOM refs ----------
    const elStatClasses  = document.getElementById('statClasses');
    const elStatStudents = document.getElementById('statStudents');
    const elStatModules  = document.getElementById('statModules');
    const elStatQuizzes  = document.getElementById('statQuizzes');
    const elStatPending  = document.getElementById('statPending');

    const classesTbody = document.getElementById('classesTbody');
    const subsTbody    = document.getElementById('subsTbody');
    const ulSchedule   = document.getElementById('upcomingSchedule');
    const ulAnn        = document.getElementById('announcementsSnapshot');

    // ---------- render helpers ----------
    function num(v){ return (typeof v === 'number' && !Number.isNaN(v)) ? v : 0; }
    function escapeHTML(str=''){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }

    function renderStats(stats={}){
      elStatClasses.textContent  = num(stats.totalClasses);  elStatClasses.classList.remove('skeleton');
      elStatStudents.textContent = num(stats.totalStudents); elStatStudents.classList.remove('skeleton');
      elStatModules.textContent  = num(stats.modulesPublished); elStatModules.classList.remove('skeleton');
      elStatQuizzes.textContent  = num(stats.quizzesCreated); elStatQuizzes.classList.remove('skeleton');
      elStatPending.textContent  = num(stats.pendingSubmissions); elStatPending.classList.remove('skeleton');
    }

    function renderClasses(rows=[]){
      if (!rows.length){
        classesTbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No classes yet.</td></tr>`;
        return;
      }
      classesTbody.innerHTML = rows.map(c => `
        <tr>
          <td>${escapeHTML(c.name || 'Class')}</td>
          <td>${c.studentCount ?? 0}</td>
          <td>${(c.avgGrade ?? 0)}%</td>
          <td>${(c.completionRate ?? 0)}%</td>
          <td>${escapeHTML(c.nextDue || '—')}</td>
        </tr>
      `).join('');
    }

    function statusToBadge(status){
      const map = {
        ungraded:'<span class="badge bg-danger">Ungraded</span>',
        late:'<span class="badge bg-warning text-dark">Late</span>',
        graded:'<span class="badge bg-success">Graded</span>',
        submitted:'<span class="badge bg-primary">Submitted</span>'
      };
      return map[String(status||'').toLowerCase()] || '<span class="badge bg-secondary">—</span>';
    }

    function fmtDT(v){
      if (!v) return '—';
      const ms = (() => {
        if (typeof v === 'number') return v;
        if (v && typeof v.toMillis === 'function') return v.toMillis();
        if (v && v._seconds) return v._seconds * 1000;
        const d = new Date(v); return isNaN(d.getTime()) ? null : d.getTime();
      })();
      return ms ? new Date(ms).toLocaleString() : '—';
    }
    function fmtDate(v){
      const ms = (() => {
        if (typeof v === 'number') return v;
        if (v && typeof v.toMillis === 'function') return v.toMillis();
        if (v && v._seconds) return v._seconds * 1000;
        const d = new Date(v); return isNaN(d.getTime()) ? null : d.getTime();
      })();
      return ms ? new Date(ms).toLocaleDateString() : '—';
    }

    function renderSubmissions(items=[]){
      if (!items.length){
        subsTbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No recent submissions.</td></tr>`;
        return;
      }
      subsTbody.innerHTML = items.map(s => `
        <tr>
          <td>${escapeHTML(s.studentName || 'Student')}</td>
          <td>${escapeHTML(s.className || '—')}</td>
          <td>${escapeHTML(s.title || '—')}</td>
          <td>${fmtDT(s.submittedAt)}</td>
          <td>${statusToBadge(s.status)}</td>
          <td>
            <a class="btn btn-sm btn-success"
               href="/TEACHER/assignment/grade_submission.html?assignmentId=${encodeURIComponent(s.assignmentId||'')}&courseId=${encodeURIComponent(s.courseId||'')}">
               Grade
            </a>
          </td>
        </tr>
      `).join('');
    }

    function renderSchedule(items=[]){
      if (!items.length){
        ulSchedule.innerHTML = `<li class="list-group-item text-muted">Nothing upcoming.</li>`;
        return;
      }
      ulSchedule.innerHTML = items.map(i => `<li class="list-group-item">${escapeHTML(i.date || '')} – ${escapeHTML(i.title || '')}</li>`).join('');
    }

    function renderAnnouncements(items=[]){
      if (!items.length){
        ulAnn.innerHTML = `<li class="list-group-item text-muted">No announcements yet.</li>`;
        return;
      }
      ulAnn.innerHTML = items.map(a => {
        const when = a.publishedAt ? fmtDate(a.publishedAt) : '—';
        const scope = a.className ? `(${escapeHTML(a.className)})` : '(All Classes)';
        return `<li class="list-group-item"><strong>${escapeHTML(a.title||'Announcement')}</strong> ${scope}<br/><small>Published: ${when}</small></li>`;
      }).join('');
    }

    const chartsMap = {};
    function upsertChart(canvasId, type, data, options){
      if (chartsMap[canvasId]) chartsMap[canvasId].destroy();
      const el = document.getElementById(canvasId);
      if (!el) return null;
      chartsMap[canvasId] = new Chart(el, { type, data, options: options || { responsive:true, maintainAspectRatio:false } });
      return chartsMap[canvasId];
    }

    function cleanQuizLabel(s, max=28){
      if (!s) return '—';
      let t = String(s)
        .replace(/^(Course|Lesson|Unit)\s*\d+\s*:\s*/i, '')
        .replace(/\s*\([^)]*\)\s*$/,'')
        .trim();
      if (t.length > max) t = t.slice(0, max-1) + '…';
      return t;
    }
    function setQuizHolderHeight(nLabels){
      const holder = document.getElementById('quizPerfHolder');
      if (!holder) return;
      const h = Math.max(220, Math.min(420, (nLabels * 36) + 40));
      holder.style.height = h + 'px';
    }

    async function renderQuizChart(teacherId) {
      const titleEl = document.getElementById('quizPerfTitle');
      try {
        const urls = makeURLs(`teacher/quiz-analytics?teacherId=${encodeURIComponent(teacherId)}`);
        const { json:data } = await fetchJSONFallback(urls, { method: 'GET' });

        const fullLabels = data?.byQuiz?.labels || [];
        const values     = data?.byQuiz?.avgScores || [];
        const displayLabels = fullLabels.map(l => cleanQuizLabel(l));

        titleEl.textContent = fullLabels.length ? 'Quiz Performance (Avg % per Quiz)' : 'Quiz Performance (no data)';
        setQuizHolderHeight((fullLabels.length || 3));

        upsertChart('quizPerfChart', 'bar', {
          labels: displayLabels.length ? displayLabels : ['No quizzes'],
          datasets: [{ label: 'Average Score (%)', data: values.length ? values : [0] }]
        }, {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 6, right: 8, top: 4, bottom: 4 } },
          scales: {
            x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' }, grid: { drawBorder: false } },
            y: { grid: { display: false }, ticks: { autoSkip: false, font: { size: 11 } } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => fullLabels[items[0].dataIndex] || items[0].label,
                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}%`
              }
            }
          }
        });
      } catch (e) {
        console.warn('quiz-analytics failed; using sample', e);
        const fullLabels = [
          'Course 1: The Foundation of Photography (4 modules)',
          'Lesson 1 (Exposure & the Exposure Triangle)',
          'Unit 1: Nature and Elements of Communication'
        ];
        const values = [80, 52, 93];
        const displayLabels = fullLabels.map(l => cleanQuizLabel(l));

        titleEl.textContent = 'Quiz Performance (sample)';
        setQuizHolderHeight(displayLabels.length);

        upsertChart('quizPerfChart', 'bar', {
          labels: displayLabels,
          datasets: [{ label:'Average Score (%)', data: values }]
        }, {
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          layout:{ padding:{ left:6, right:8, top:4, bottom:4 }},
          scales:{ x:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' } }, y:{ grid:{ display:false }, ticks:{ autoSkip:false, font:{ size:11 } } } },
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ title:(items)=>fullLabels[items[0].dataIndex] } } }
        });
      }
    }

    function renderCharts(chartsData={}){
      const cr = chartsData.completionRate || { labels:[], datasets:[{ label:'% Completion', data:[] }] };
      const tt = chartsData.timeOnTask     || { labels:[], datasets:[{ label:'Minutes', data:[] }] };
      upsertChart('completionRateChart', 'line', cr, { responsive:true, maintainAspectRatio:false });
      upsertChart('timeOnTaskChart',     'bar',  tt, { responsive:true, maintainAspectRatio:false });
    }

    async function loadDashboard(){
      try{
        if (!window.currentUser?.userId) throw new Error("Missing currentUser.userId");

        const urls = makeURLs(`teacher/dashboard-stats?teacherId=${encodeURIComponent(window.currentUser.userId)}`);
        const { response, json:js } = await fetchJSONFallback(urls, { method: 'GET' });

        if (!response.ok || !js.success){
          throw new Error(js.message || 'Failed to load dashboard data');
        }

        renderStats(js.stats || {});
        renderClasses(js.classes || []);
        renderSubmissions(js.submissions || []);
        renderCharts(js.chartsData || {});
        renderSchedule(js.schedule || []);
        renderAnnouncements(js.announcements || []);
        await renderQuizChart(window.currentUser.userId);
      }catch(err){
        console.error(err);
        renderStats({});
        classesTbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Failed to load classes.</td></tr>`;
        subsTbody.innerHTML    = `<tr><td colspan="6" class="text-center text-danger py-4">Failed to load submissions.</td></tr>`;
        ulSchedule.innerHTML   = `<li class="list-group-item text-danger">Failed to load schedule.</li>`;
        ulAnn.innerHTML        = `<li class="list-group-item text-danger">Failed to load announcements.</li>`;
        renderCharts({});
        await renderQuizChart(window.currentUser?.userId || '');
      }
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
