<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Teacher - Forum Threads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Sidebar / shared styles -->
  <link rel="stylesheet" href="forum_list.css" />

</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box position-relative">
          <input id="headerSearch" type="text" class="form-control" placeholder="Search threads..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title">Forum Threads</h1>

        <!-- Filters -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-funnel"></i> Filters</h2>
          </div>
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-6">
              <label class="form-label" for="courseFilter">Course</label>
              <select id="courseFilter" class="form-select">
                <option value="All">All</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="sortThreads">Sort by</label>
              <select id="sortThreads" class="form-select">
                <option value="newest">Newest</option>
                <option value="replies">Most Replies</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Threads List -->
        <div class="ui-card card-themed">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-chat-dots"></i> Recent Threads</h2>
            <div class="ui-card-title fw-normal" id="threadCount"></div>
          </div>
          <div id="forumThreads"></div>
        </div>
      </div> <!-- /content -->
    </div>
  </div>

  <!-- ===== Modals ===== -->

  <!-- CONFIRM MODAL -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(90deg,#4A1A0C,#7A2810);color:#FFD8A9">
          <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-amber" id="confirmOkBtn">Yes, continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- INFO MODAL -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(90deg,#4A1A0C,#7A2810);color:#FFD8A9">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">â€”</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-close-footer" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sidebar = document.querySelector(".sidebar"),
                dash    = document.querySelector(".dashboard");
          if (sidebar && dash) {
            sidebar.addEventListener("mouseenter", () => dash.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dash.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const p = toggle.closest('.has-submenu');
              p.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>
<script>
// ---- Auth guard + header initials (robust) ----
(function initHeaderInitials(){
  try{
    const raw = localStorage.getItem("user");
    const stored = raw ? JSON.parse(raw) : {};
    // support both shapes: {user:{...}} or {...}
    const u = stored.user || stored;

    // teacher gate
    if (!u?.userId || !u?.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
      return;
    }
    window.currentUser = u;

    const initials = getInitials(u);

    window.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("Username");
      if (!el) return;
      el.textContent = initials;                           // ðŸ‘ˆ initials only
      // Helpful tooltip/aria label with full name/username
      const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
                      || u.username
                      || u.email
                      || 'Profile';
      el.setAttribute('title', fullLabel);
      el.setAttribute('aria-label', fullLabel);
    });
  }catch(e){
    console.error('initHeaderInitials failed:', e);
    window.location.href = "/TEACHER/login/login.html";
  }

  // --- Helpers ---
  function getInitials(u){
    const fn = (u.firstName || '').trim();
    const ln = (u.lastName  || '').trim();
    if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

    // fall back to username-like fields
    const nameish = (u.username || u.displayName || u.name || '').trim();
    if (nameish){
      // split on space, dot, underscore, or hyphen
      const parts = nameish
        .replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
        .split(/[\s._-]+/)
        .filter(Boolean);

      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return parts[0][0].toUpperCase();
    }

    // last resort: first letter of email
    const em = (u.email || '').trim();
    return em ? em[0].toUpperCase() : 'U';
  }
})();
</script>

  <!-- Main page logic -->
  <script>
    const FORUM_API = (location.port === '5501') ? 'http://localhost:5000/api/forum' : '/api/forum';
    const MAIN_API  = (location.port === '5501') ? 'http://localhost:5000' : '';

    const qs = sel => document.querySelector(sel);
    function escapeHtml(str='') {
      return String(str).replace(/[&<>"']/g, s => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
      ));
    }
    function toLocal(dt) {
      if (!dt) return '';
      if (dt._seconds) return new Date(dt._seconds * 1000).toLocaleString();
      return new Date(dt).toLocaleString();
    }
    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await res.text();
        throw new Error(`Expected JSON, got ${res.status} ${res.statusText}. Body: ${text.slice(0,120)}`);
      }
      const json = await res.json();
      if (!res.ok || json.success === false) {
        throw new Error(json.message || `HTTP ${res.status}`);
      }
      return json;
    }

    // Auth (teacher check)
    const userData = JSON.parse(localStorage.getItem("user"));
    if (!userData || !userData.email || !userData.userId || !userData.isTeacher) {
      window.location.href = "../login/login.html";
    } else {
      qs("#Username").textContent = userData.username || userData.email || "Teacher";
    }

    let courses = [];
    let threads = [];

    async function loadCourses() {
      try {
        const j = await fetchJSON(`${MAIN_API}/api/courses`);
        courses = Array.isArray(j?.courses) ? j.courses : [];

        const courseFilter = qs("#courseFilter");
        courseFilter.innerHTML = `<option value="All">All</option>`;
        courses.forEach(c => {
          const code = c.courseNumber ?? c.code ?? c.number ?? null;
          const title = c.title || 'Untitled Course';
          const label = code ? `${code} â€” ${title}` : title;
          courseFilter.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(c.id)}">${escapeHtml(label)}</option>`);
        });
      } catch (err) {
        console.error('Failed to load courses:', err);
      }
    }

    function clientSort(arr, sortVal) {
      const copy = Array.isArray(arr) ? arr.slice() : [];
      if (sortVal === 'replies') {
        copy.sort((a,b) => (b.repliesCount || 0) - (a.repliesCount || 0));
      } else {
        copy.sort((a,b) => {
          const ta = (a.createdAt?._seconds ? a.createdAt._seconds*1000 : Date.parse(a.createdAt || 0)) || 0;
          const tb = (b.createdAt?._seconds ? b.createdAt._seconds*1000 : Date.parse(b.createdAt || 0)) || 0;
          return tb - ta;
        });
      }
      return copy;
    }

    async function loadThreads() {
      const filterVal = qs('#courseFilter').value;
      const headerSearchEl = qs('#headerSearch');
      const searchQ = headerSearchEl ? headerSearchEl.value : '';
      const sortVal = qs('#sortThreads').value || 'newest';

      const params = new URLSearchParams({
        courseId: filterVal !== 'All' ? filterVal : '',
        q: searchQ,
        sort: sortVal,
        limit: '50'
      });

      try {
        const j = await fetchJSON(`${FORUM_API}/threads?${params.toString()}`);
        threads = j.data || [];
        threads = clientSort(threads, sortVal);
        renderThreads();
      } catch (err) {
        console.error(err);
        qs('#forumThreads').innerHTML = `<div class="alert alert-warning">Forum API unreachable.</div>`;
        qs('#threadCount').textContent = '0 threads';
        // modal info instead of alert
        showInfo('Network Error', 'The forum service is currently unreachable. Please try again in a moment.');
      }
    }

    function renderThreads() {
      const wrap = qs('#forumThreads');
      const count = qs('#threadCount');
      wrap.innerHTML = '';
      count.textContent = `${threads.length} thread${threads.length !== 1 ? 's' : ''}`;

      if (!threads.length) {
        wrap.innerHTML = `<div class="alert alert-warning">No threads found.</div>`;
        return;
      }

      threads.forEach(t => {
        const div = document.createElement('div');
        div.className = 'thread thread-themed';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-1">
            <h3 class="thread-title">${escapeHtml(t.title || '')}</h3>
            <div class="d-flex gap-2">
              <button class="btn btn-amber view-btn" data-id="${t.id}">
                <i class="bi bi-eye"></i> View
              </button>
              <button class="btn btn-danger delete-btn" data-id="${t.id}">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
          <div class="thread-meta mb-2">
            Course: <strong>${escapeHtml(t.courseTitle || '')}</strong> â€¢
            Replies: ${t.repliesCount || 0} â€¢
            Posted: ${toLocal(t.createdAt)}
          </div>
        `;
        wrap.appendChild(div);
      });

      wrap.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          window.location.href = `forum_view.html?id=${id}`;
        });
      });

      wrap.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const ok = await showConfirm('Delete Thread', 'Delete this thread? This cannot be undone.');
          if (!ok) return;

          try {
            await fetchJSON(`${FORUM_API}/threads/${id}`, { method: 'DELETE' });
            await loadThreads();
            showInfo('Deleted', 'The thread has been deleted.');
          } catch (err) {
            console.error(err);
            showInfo('Delete Failed', 'Could not delete the thread. Please try again.');
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadCourses();
      await loadThreads();

      const headerSearch = qs('#headerSearch');
      if (headerSearch) headerSearch.addEventListener('input', loadThreads);

      qs('#courseFilter').addEventListener('change', loadThreads);
      qs('#sortThreads').addEventListener('change', loadThreads);
    });

    function logoutUser(){
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Modal helpers (after Bootstrap) -->
  <script>
    // Creates and shows an info modal
    function showInfo(title='Notice', html=''){
      const el = document.getElementById('infoModal');
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').innerHTML = html;
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      modal.show();
    }

    // Shows a confirm modal and resolves to true/false
    function showConfirm(title='Confirm Action', html='Are you sure?'){
      const el = document.getElementById('confirmModal');
      document.getElementById('confirmModalLabel').textContent = title;
      document.getElementById('confirmModalBody').innerHTML = html;

      const modal = bootstrap.Modal.getOrCreateInstance(el);
      const okBtn = document.getElementById('confirmOkBtn');

      return new Promise(resolve=>{
        const onOk = ()=>{ cleanup(); modal.hide(); resolve(true); };
        const onCancel = ()=>{ cleanup(); resolve(false); };
        function cleanup(){
          okBtn.removeEventListener('click', onOk);
          el.removeEventListener('hidden.bs.modal', onCancel);
        }
        okBtn.addEventListener('click', onOk, { once:true });
        el.addEventListener('hidden.bs.modal', onCancel, { once:true });
        modal.show();
      });
    }
  </script>
</body>
</html>
