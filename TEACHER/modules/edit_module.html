<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Edit Module • EduConnect</title>

  <!-- Optional: set your backend explicitly when FE/BE are different Railway services -->
  <!-- <meta name="api-base" content="https://your-backend.up.railway.app"> -->

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Page theme -->
  <link rel="stylesheet" href="edit_module.css"/>
</head>
<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative" style="max-width:520px;">
          <input type="text" class="form-control" disabled placeholder="Edit Module"/>
          <i class="bi bi-pencil-square position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fs-2"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <section class="content container-fluid p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h1 class="page-title brand mb-0">Edit Module</h1>
          <div class="d-flex flex-wrap gap-2">
            <button id="btnBack" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</button>
            <button id="btnArchive" class="btn btn-outline-warning"><i class="bi bi-archive"></i> Archive</button>
            <button id="btnUnarchive" class="btn btn-outline-success d-none"><i class="bi bi-arrow-counterclockwise"></i> Unarchive</button>
            <button id="btnDelete" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Delete</button>
            <button id="btnSave" class="btn btn-amber">
              <span class="save-text">Save Changes</span>
              <span class="spinner-border spinner-border-sm ms-2 visually-hidden" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </div>

        <div class="row g-3">
          <!-- LEFT -->
          <div class="col-12 col-lg-8">
            <!-- Details -->
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-pencil-square"></i> Details</h2>
              </div>
              <div class="p-3">
                <div id="formError" class="text-danger mb-2" style="min-height:1rem;"></div>

                <div class="row g-3">
                  <div class="col-md-8">
                    <label class="form-label">Title</label>
                    <input type="text" id="titleInput" class="form-control" required />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Attachment Type</label>
                    <select id="moduleType" class="form-select" disabled>
                      <option value="file">File</option>
                      <option value="text">Video (URL)</option>
                      <option value="textonly">Text Only</option>
                    </select>
                  </div>
                </div>

                <input type="hidden" id="descHidden" value=" " />

                <!-- Lessons header / pager controls -->
                <div class="mt-3 d-flex justify-content-between align-items-center">
                  <label class="form-label mb-0 fw-semibold">Lessons (Sub Title, Content, and Attachment/Video URL)</label>
                  <div class="lesson-toolbar d-flex align-items-center gap-2 flex-wrap">
                    <span class="pager-chip"><span id="pageNow">1</span>/<span id="pageTotal">1</span></span>
                    <div id="stepDots" class="step-dots" aria-hidden="true"><span class="dot active"></span></div>
                    <div class="btn-group">
                      <button type="button" class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
                    </div>
                    <button type="button" class="btn btn-amber btn-sm" id="addLessonBtn">Add Lesson</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="removeLessonBtn">Remove</button>
                  </div>
                </div>

                <!-- Lessons container (paged) -->
                <div id="lessonPager" class="mt-2"></div>
              </div>
            </div>

            <!-- Assign to Classes (FILTERED to course) -->
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-people"></i> Assign to Classes</h2>
                <div class="ui-card-title fw-normal">Only classes enrolled in this course are shown.</div>
              </div>
              <div class="p-3">
                <div id="assigned-status" class="small-muted mb-2">Loading your classes…</div>
                <div id="assigned-empty" class="alert alert-warning py-2 px-3 mb-2" style="display:none;">
                  No classes linked to this course were found.
                </div>
                <div id="assignedClassesContainer" class="row g-3"></div>
                <div class="small-muted mt-2">Tip: click a card to toggle selection.</div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="col-12 col-lg-4">
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-info-circle"></i> Meta</h2>
              </div>
              <div class="p-3">
                <div class="mb-2"><span class="muted">Course:</span> <span id="metaCourse">—</span></div>
                <div class="mb-2"><span class="muted">Module #:</span> <span id="metaNumber">—</span></div>
                <div class="mb-2"><span class="muted">Created:</span> <span id="metaCreated">—</span></div>
                <div class="mb-2"><span class="muted">Last Updated:</span> <span id="metaUpdated">—</span></div>
                <div class="mb-2"><span class="muted">Status:</span> <span id="metaStatus" class="badge text-bg-success">Active</span></div>
              </div>
            </div>

            <!-- Publish & Visibility -->
            <div class="ui-card">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-megaphone"></i> Publish</h2>
              </div>
              <div class="p-3">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="publishedSwitch">
                  <label class="form-check-label" for="publishedSwitch">Published</label>
                </div>

                <div class="mb-2">
                  <label for="publishAtInput" class="form-label">Publish At (optional)</label>
                  <input type="datetime-local" id="publishAtInput" class="form-control" />
                  <div class="form-text">Set a date & time to schedule. Leave empty to publish immediately.</div>
                </div>

                <div class="d-flex gap-2">
                  <button id="btnPublishNow" class="btn btn-outline-primary btn-sm"><i class="bi bi-clock-history"></i> Set to Now</button>
                  <button id="btnClearSchedule" class="btn btn-outline-secondary btn-sm"><i class="bi bi-x-circle"></i> Clear</button>
                </div>

                <hr>
                <div class="small">
                  <div><span class="muted">Current:</span> <span id="metaPublishedState">—</span></div>
                  <div><span class="muted">Publish At:</span> <span id="metaPublishAt">—</span></div>
                  <div><span class="muted">Published At:</span> <span id="metaPublishedAt">—</span></div>
                </div>
              </div>
            </div>

            <div class="ui-card mt-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-lightbulb"></i> Tips</h2>
              </div>
              <div class="p-3">
                <ul class="mb-0">
                  <li>Use <em>Archive</em> to hide the module from students.</li>
                  <li>Use the switch above to publish/unpublish, and the scheduler to set a future date/time.</li>
                  <li>Files are shown only for <strong>File</strong> type; link URLs only for <strong>Video (URL)</strong>.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>
        <div class="modal-footer">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto d-flex gap-2">
            <button id="stageFromPreviewBtn" class="btn btn-outline-primary d-none">
              <i class="bi bi-cloud-plus me-1"></i> Stage selected
            </button>
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn-close-footer">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info / Confirm -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="infoTitle">Notice</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="infoBody">—</div>
      <div class="modal-footer"><button class="btn btn-amber" data-bs-dismiss="modal">OK</button></div>
    </div></div>
  </div>

  <!-- Generic confirm (reused for type-to-confirm) -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header text-white"><h5 class="modal-title" id="confirmTitle">Confirm</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="confirmBody">Are you sure?</div>
      <div class="modal-footer">
        <button class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmYesBtn" class="btn btn-danger">Yes</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* -------------------- CONFIG & SIDEBAR -------------------- */
    // Railway-friendly API base resolver
    const MAIN_API = (() => {
      const byMeta = document.querySelector('meta[name="api-base"]')?.getAttribute('content')?.trim();
      const byWindow = (typeof window !== 'undefined' && window.__API_BASE) ? String(window.__API_BASE).trim() : '';
      const byStorage = (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) ? localStorage.getItem('API_BASE').trim() : '';
      const onRailway = /\.railway\.app$/i.test(location.hostname);
      const chosen = byMeta || byWindow || byStorage || (onRailway ? location.origin : 'http://localhost:5000');
      return String(chosen).replace(/\/+$/, '');
    })();
    const API = MAIN_API + '/api';

    const FILE_LIMIT_MB = 300;
    const FILE_LIMIT_BYTES = FILE_LIMIT_MB * 1024 * 1024;

    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        });
    });

    /* -------------------- AUTH + HEADER INITIALS -------------------- */
    (function initHeaderInitials(){
      try{
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;
        if (!u?.userId || !u?.isTeacher) { window.location.href = "/TEACHER/login/login.html"; return; }
        window.currentUser = u;

        const initials = (function(u){
          const fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
          if(fn&&ln) return (fn[0]+ln[0]).toUpperCase();
          const nameish=(u.username||u.displayName||u.name||'').trim();
          if(nameish){ const parts=nameish.replace(/[^A-Za-z0-9 _.\-]+/g,' ').split(/[\s._-]+/).filter(Boolean);
            if(parts.length>=2) return (parts[0][0]+parts[1][0]).toUpperCase(); return parts[0][0].toUpperCase(); }
          const em=(u.email||'').trim(); return em?em[0].toUpperCase():'U';
        })(u);

        window.addEventListener("DOMContentLoaded", ()=>{
          const el=document.getElementById("Username"); if(!el) return; el.textContent=initials;
          const full=[u.firstName,u.middleName,u.lastName].filter(Boolean).join(' ').trim() || u.username || u.email || 'Profile';
          el.setAttribute('title', full); el.setAttribute('aria-label', full);
        });
      }catch(e){ console.error(e); window.location.href="/TEACHER/login/login.html"; }
    })();

    /* -------------------- HELPERS -------------------- */
    const qs = s => document.querySelector(s);
    const create = (tag, cls) => { const el = document.createElement(tag); if (cls) el.className = cls; return el; };
    const url = new URL(location.href);
    const moduleId = url.searchParams.get('moduleId') || '';
    const backCourseId = url.searchParams.get('courseId') || '';

    function showInfo(title, body){
      document.getElementById('infoTitle').textContent=title;
      document.getElementById('infoBody').innerHTML=body;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('infoModal')).show();
    }
    function confirmDanger(title, body){
      return new Promise(resolve=>{
        document.getElementById('confirmTitle').textContent=title;
        document.getElementById('confirmBody').innerHTML=body;
        const btn=document.getElementById('confirmYesBtn');
        const modal=bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal'));
        const onYes=()=>{ btn.removeEventListener('click',onYes); modal.hide(); resolve(true); };
        const onHide=()=>{ btn.removeEventListener('click',onYes); resolve(false); };
        btn.addEventListener('click',onYes,{once:true});
        document.getElementById('confirmModal').addEventListener('hidden.bs.modal', onHide, {once:true});
        modal.show();
      });
    }

    /* ===== Type-to-confirm helper (blocks copy/paste/drag/contextmenu) ===== */
    function showTypeToConfirm({ title, expected, placeholder='Type here', primaryText='Delete' }){
      return new Promise((resolve)=>{
        const modalEl = document.getElementById('confirmModal');
        const content = modalEl.querySelector('.modal-content');
        content.classList.add('confirm-themed');

        document.getElementById('confirmTitle').textContent = title || 'Confirm';
        const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;');
        const body = document.getElementById('confirmBody');
        body.innerHTML = `
          <p class="mb-2">
            Confirm you want to delete this by typing the exact <strong>Module Title</strong> (case-sensitive).
          </p>
          <div class="no-copy pill-danger mb-2" id="ttcPill">
            Type exactly: <strong id="ttcExpected">${esc(expected||'')}</strong>
          </div>
          <div class="mb-1">
            <input id="ttcInput" type="text" class="form-control is-invalid"
                   placeholder="${esc(placeholder)}" autocomplete="off"
                   autocapitalize="off" spellcheck="false">
          </div>
          <div id="ttcBad" class="invalid-msg no-copy">
            Input does not match. Please type <strong id="ttcBadExpected">${esc(expected||'')}</strong> to proceed.
          </div>
          <div id="ttcGood" class="valid-msg d-none">✓ Input matches</div>
        `;

        const okBtn = document.getElementById('confirmYesBtn');
        okBtn.textContent = primaryText;
        okBtn.className = 'btn btn-danger';
        okBtn.disabled = true;

        const cancelBtn = modalEl.querySelector('.btn-close-footer');

        const input = body.querySelector('#ttcInput');
        const badBox = body.querySelector('#ttcBad');
        const pill = body.querySelector('#ttcPill');
        const guardRoots = [modalEl, pill, badBox];

        const block = e => e.preventDefault();
        const blockKeys = e => {
          const k = (e.key || '').toLowerCase();
          if ((e.ctrlKey || e.metaKey) && (k === 'v' || k === 'x' || k === 'c' || k === 'a')) e.preventDefault();
        };
        const blockBeforeInput = e => {
          if ((e.inputType||'').toLowerCase().includes('insertfrompaste')) e.preventDefault();
        };

        guardRoots.forEach(node=>{
          ['copy','cut','contextmenu','dragstart','drop','dragover'].forEach(evt => node.addEventListener(evt, block));
        });
        input.addEventListener('paste', block);
        input.addEventListener('keydown', blockKeys);
        input.addEventListener('beforeinput', blockBeforeInput);

        const good = body.querySelector('#ttcGood');
        const expectedRaw = String(expected||'');
        function refresh(){
          const ok = (input.value === expectedRaw);
          okBtn.disabled = !ok;
          input.classList.toggle('is-valid', ok);
          input.classList.toggle('is-invalid', !ok);
          badBox.classList.toggle('d-none', ok);
          good.classList.toggle('d-none', !ok);
        }
        input.addEventListener('input', refresh);
        setTimeout(()=> input.focus(), 60);

        let confirmed = false;
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        const onOk = () => { if (!okBtn.disabled){ confirmed = true; modal.hide(); } };
        const onCancel = () => { modal.hide(); };
        const onHidden = () => { cleanup(); resolve(confirmed); };

        function cleanup(){
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
          modalEl.removeEventListener('hidden.bs.modal', onHidden);

          guardRoots.forEach(node=>{
            ['copy','cut','contextmenu','dragstart','drop','dragover'].forEach(evt => node.removeEventListener(evt, block));
          });
          input.removeEventListener('paste', block);
          input.removeEventListener('keydown', blockKeys);
          input.removeEventListener('beforeinput', blockBeforeInput);
          input.removeEventListener('input', refresh);
        }

        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
        modalEl.addEventListener('hidden.bs.modal', onHidden, { once:true });
        modal.show();
      });
    }

    // Redirect native alerts to brand modal
    (function attachBrandAlert(){
      const escInline = (s) => String(s ?? '').replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
      window.alert = (msg) => showInfo('Notice', escInline(msg));
    })();

    // Timestamp/date helpers
    function tsToMs(ts){
      if(!ts) return null;
      const s=ts._seconds??ts.seconds;
      const ns=ts._nanoseconds??ts.nanoseconds??0;
      if(typeof s==='number') return (s*1000)+Math.floor(ns/1e6);
      if(typeof ts==='number') return ts;
      const d=new Date(ts); return isNaN(d.getTime())?null:d.getTime();
    }
    function msToLocal(ms){ return ms ? new Date(ms).toLocaleString() : '—'; }

    function dateToLocalInputValue(d){
      if(!d) return '';
      const pad = n => String(n).padStart(2,'0');
      const y=d.getFullYear(), m=pad(d.getMonth()+1), day=pad(d.getDate()), h=pad(d.getHours()), min=pad(d.getMinutes());
      return `${y}-${m}-${day}T${h}:${min}`;
    }
    function localInputValueToDate(v){
      if(!v) return null;
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }

    const formatKB = b => `${Math.round(b / 102.4) / 10} KB`;
    const escHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // Preview helpers
    function extFromUrl(u=''){ const clean=String(u).split('?')[0].split('#')[0]; const parts=clean.split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function extFromName(n=''){ const parts=String(n).split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function isYouTubeUrl(url=''){ try{const u=new URL(url);const h=u.hostname.replace(/^www\./,'').toLowerCase();return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);}catch{return false;} }
    function toYouTubeEmbed(url=''){ try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();let id='';let start=u.searchParams.get('start')||u.searchParams.get('t')||'';if(start&&/^\d+s$/.test(start))start=parseInt(start,10);if(start&&/^\d+$/.test(start))start=parseInt(start,10);if(!Number.isFinite(start))start=''; if(host==='youtu.be'){id=(u.pathname||'').replace(/^\//,'').split('/')[0];} else { if(u.pathname.startsWith('/embed/')) id=u.pathname.split('/')[2]||''; if(!id) id=u.searchParams.get('v')||''; } if(!id) return null; const base=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`; const qs=new URLSearchParams(); qs.set('rel','0'); if(start) qs.set('start', String(start)); return `${base}?${qs.toString()}`; }catch{return null;} }
    function kindFrom({url='', name='', mime=''}) {
      const ext = (extFromUrl(url) || extFromName(name)).toLowerCase();
      if (isYouTubeUrl(url)) return 'youtube';
      if ((mime||'').startsWith('image/') || ['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
      if (mime === 'application/pdf' || ext === 'pdf') return 'pdf';
      if ((mime||'').startsWith('video/') || ['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
      if ((mime||'').startsWith('audio/') || ['mp3','wav','m4a','ogg','aac','flac'].includes(ext)) return 'audio';
      if ((mime||'').startsWith('text/') || ['txt','csv','log'].includes(ext)) return 'text';
      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
      return 'other';
    }
    function extractStoragePath(obj = {}) {
      if (obj.storagePath) return String(obj.storagePath);
      if (obj.gsUri && obj.gsUri.startsWith('gs://')) {
        const parts = obj.gsUri.replace('gs://','').split('/'); parts.shift(); return parts.join('/');
      }
      if (obj.publicUrl && /storage\.googleapis\.com/i.test(obj.publicUrl)) {
        try { const u=new URL(obj.publicUrl); const parts=u.pathname.replace(/^\/+/, '').split('/'); parts.shift(); return parts.join('/'); } catch {}
      }
      if (obj.downloadUrl && /firebasestorage\.googleapis\.com/i.test(obj.downloadUrl)) {
        try { const u=new URL(obj.downloadUrl); if (u.pathname.includes('/o/')) { const enc = u.pathname.split('/o/')[1]; return decodeURIComponent(enc); } } catch {}
      }
      return '';
    }
    function pickHref(obj = {}) {
      return obj.downloadUrl || obj.publicUrl || obj.previewUrl ||
             (obj.url && /^https?:\/\//i.test(obj.url) ? obj.url : '') ||
             (obj.filePath ? API + String(obj.filePath) : '');
    }
    function pickName(obj = {}) {
      if (obj.__stagedName) return obj.__stagedName;
      const fromPath = (obj.storagePath || obj.filePath || '').split('/').pop();
      const fromUrl  = (obj.url || '').split('/').pop();
      return obj.fileName || obj.originalName || fromPath || fromUrl || 'file';
    }

    function setFileInfoUI(kind,url){
      const info=document.getElementById('fileInfoText');
      const hdr=document.getElementById('filePreviewModalLabel');
      const labelMap={youtube:'YouTube',video:'Video',audio:'Audio',image:'Image',pdf:'PDF',text:'Text/CSV',office:'Office Doc',other:'File'};
      let badge=document.getElementById('fileKindBadge'); if(!badge){badge=document.createElement('span');badge.id='fileKindBadge';badge.className='ms-2 badge rounded-pill';hdr.appendChild(badge);}
      badge.className='ms-2 badge rounded-pill bg-secondary-subtle text-secondary';
      badge.textContent=labelMap[kind]||'File';
      info.innerHTML=`<span class="text-muted">Type:</span> <strong>${labelMap[kind]||'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href=url||'#';
    }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function renderFilePreviewInto(container, {url, name='', mime='', isStaged=false}){
      container.innerHTML=''; showSpinner(true);
      const done=()=>showSpinner(false);
      const fallback=(msg)=>{ container.innerHTML=`<div class="preview-fallback"><div class="text-muted mb-2">${msg||'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; done(); };
      const kind = kindFrom({url, name, mime});
      if(kind==='youtube'){ const embed=toYouTubeEmbed(url); if(embed){container.innerHTML=`<div class="ratio ratio-16x9"><iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>`; done(); return;} return fallback('Couldn’t embed this YouTube link.'); }
      if(kind==='image'){ const img=new Image(); img.onload=done; img.onerror=()=>fallback('Image preview failed.'); img.src=url; container.appendChild(img); return; }
      if(kind==='pdf'){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('PDF preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(kind==='video'){ const v=document.createElement('video'); v.controls=true; v.onloadeddata=done; v.onerror=()=>fallback('Video preview failed.'); v.src=url; container.appendChild(v); return; }
      if(kind==='audio'){ const a=document.createElement('audio'); a.controls=true; a.onloadeddata=done; a.onerror=()=>fallback('Audio preview failed.'); a.src=url; container.appendChild(a); return; }
      if(kind==='text'){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Text preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(kind==='office' && url.startsWith('blob:')){ return fallback('Office documents cannot be previewed until they’re uploaded.'); }
      if(kind==='office'){ const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Office preview failed.'); iframe.src=gview; container.appendChild(iframe); return; }
      const obj=document.createElement('object'); obj.data=url; obj.type=mime||'application/octet-stream'; obj.onload=done; obj.onerror=()=>fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(done,1200);
    }

    let currentPreviewRevoke = null;
    let previewStageCtx = null; // { idx, files: File[] }
    const stageFromPreviewBtn = document.getElementById('stageFromPreviewBtn');
    function showStageBtn(show, label){
      stageFromPreviewBtn.classList.toggle('d-none', !show);
      if (label) stageFromPreviewBtn.innerHTML = `<i class="bi bi-cloud-plus me-1"></i> ${label}`;
    }
    document.getElementById('filePreviewModal').addEventListener('hidden.bs.modal', ()=>{
      if (typeof currentPreviewRevoke === 'function') { try { currentPreviewRevoke(); } catch {} }
      currentPreviewRevoke = null; previewStageCtx = null; showStageBtn(false);
    });

    stageFromPreviewBtn.addEventListener('click', ()=>{
      if (!previewStageCtx) return;
      const { idx, files } = previewStageCtx;
      const oversize = (files||[]).find(f => typeof f.size === 'number' && f.size > FILE_LIMIT_BYTES);
      if (oversize) { showInfo('File too large', `❌ <strong>${oversize.name}</strong> exceeds <strong>${FILE_LIMIT_MB} MB</strong>.`); return; }
      files.forEach(f => { f.__uid = Math.random().toString(36).slice(2,10); stagedByLesson[idx].addFiles.push(f); });
      const input = document.querySelector(`.lesson-page[data-index="${idx}"] .lesson-file-input`); if (input) input.value = '';
      markDirty(); renderLesson(idx);
      bootstrap.Modal.getInstance(document.getElementById('filePreviewModal')).hide();
      showInfo('Staged','File(s) will be uploaded on Save.');
    });

    /* -------------------- Dirty guard -------------------- */
    let __dirty=false;
    function markDirty(){ __dirty = true; }
    function clearDirty(){ __dirty = false; }
    function isDirty(){
      if (__dirty) return true;
      for (const k in stagedByLesson) {
        const s = stagedByLesson[k];
        if (s.addFiles.length || s.addLinks.length || s.removeIds.size) return true;
      }
      return false;
    }
    window.addEventListener('beforeunload', (e)=>{ if(!isDirty()) return; e.preventDefault(); e.returnValue=''; });

    /* -------------------- Pager + Lesson builder -------------------- */
    const pager = { cur:0, pages:[] };
    const attachmentsByLesson = {}; // idx -> existing items[]
    const stagedByLesson = {};      // idx -> { addFiles:[], addLinks:[], removeIds:Set }

    function ensureLessonState(idx){
      if (!attachmentsByLesson[idx]) attachmentsByLesson[idx] = [];
      if (!stagedByLesson[idx]) stagedByLesson[idx] = { addFiles:[], addLinks:[], removeIds:new Set() };
    }

    function badgeForType(t){
      if (t==='link') return `<span class="badge-soft badge-link"><i class="bi bi-link-45deg"></i> Link</span>`;
      return `<span class="badge-soft badge-file"><i class="bi bi-file-earmark"></i> File</span>`;
    }
    function chip(text, cls=''){ return `<span class="badge-soft ${cls}" style="font-size:.72rem">${text}</span>`; }

    function buildLessonPage(idx){
      ensureLessonState(idx);

      const wrap = create('div','lesson-page card card-body mb-3'); wrap.dataset.index=idx;

      // Sub Title + Content
      const sub = create('input','form-control mb-2 lesson-subtitle'); sub.placeholder='Lesson Sub Title (optional)';
      const cont = create('textarea','form-control mb-3 lesson-content'); cont.rows=3; cont.placeholder='Lesson Content...';

      sub.addEventListener('input', markDirty);
      cont.addEventListener('input', markDirty);

      // Upload file(s)
      const fileRow = create('div','row align-items-end ctrl-row mb-2 file-row');
      fileRow.innerHTML = `
        <div class="col-12 col-md-8 col-left">
          <label class="form-label">Upload file(s)</label>
          <input type="file" class="form-control lesson-file-input" multiple>
          <div class="form-text">You can select multiple files. Each up to your configured limit.</div>
        </div>
        <div class="col-12 col-md-4 col-right d-grid d-md-flex gap-2">
          <button class="btn btn-outline-secondary btn-prev-files"><i class="bi bi-eye"></i> Preview Selected</button>
          <button class="btn btn-outline-primary btn-stage-files"><i class="bi bi-cloud-plus"></i> Stage Files</button>
        </div>
      `;

      // Add a link row
      const linkRow = create('div','row align-items-end ctrl-row mb-2 link-row');
      linkRow.innerHTML = `
        <div class="col-12 col-md-8 col-left">
          <label class="form-label">Add a link</label>
          <input type="url" class="form-control lesson-link-input" placeholder="https://…">
          <div class="form-text">Paste a public URL (Docs, YouTube, etc.).</div>
        </div>
        <div class="col-12 col-md-4 col-right d-grid d-md-flex gap-2">
          <button class="btn btn-outline-secondary btn-prev-link"><i class="bi bi-eye"></i> Preview</button>
          <button class="btn btn-outline-secondary btn-stage-link"><i class="bi bi-link-45deg"></i> Stage Link</button>
        </div>
      `;

      // Attachments list
      const list = create('ul','file-list'); list.id = `filesList_${idx}`;

      // -------- Events (file) --------
      const fileInput = fileRow.querySelector('.lesson-file-input');
      fileInput.addEventListener('change', ()=>{
        markDirty();
        const fs = fileInput.files;
        if (!fs || !fs.length) return;
        const first = fs[0];
        const blobUrl = URL.createObjectURL(first);
        currentPreviewRevoke = () => URL.revokeObjectURL(blobUrl);
        const label = fs.length === 1 ? 'Stage selected file' : `Stage selected (${fs.length})`;
        openPreviewModalWithMeta({
          url: blobUrl,
          title: first.name,
          mime: first.type || '',
          isStaged: true,
          stageContext: { idx, files: Array.from(fs) },
          stageLabel: label
        });
      });

      fileRow.querySelector('.btn-prev-files').addEventListener('click', (e)=>{
        e.preventDefault();
        const fs = fileInput.files;
        if (!fs || !fs.length) { showInfo('Nothing selected','Choose one or more files first.'); return; }
        const f = fs[0]; const blobUrl=URL.createObjectURL(f); currentPreviewRevoke=()=>URL.revokeObjectURL(blobUrl);
        const label = fs.length === 1 ? 'Stage selected file' : `Stage selected (${fs.length})`;
        openPreviewModalWithMeta({url:blobUrl,title:f.name,mime:f.type||'',isStaged:true, stageContext:{ idx, files:Array.from(fs) }, stageLabel: label});
      });

      fileRow.querySelector('.btn-stage-files').addEventListener('click', (e)=>{
        e.preventDefault();
        const fs = fileInput.files;
        if (!fs || !fs.length) { showInfo('Nothing to Stage','Please choose one or more files.'); return; }
        let oversize = null;
        Array.from(fs).forEach(f=>{ if (f.size > FILE_LIMIT_BYTES) oversize = {name:f.name, size:f.size}; });
        if (oversize) { showInfo('File too large', `❌ <strong>${oversize.name}</strong> exceeds <strong>${FILE_LIMIT_MB} MB</strong>.`); return; }
        Array.from(fs).forEach(f=>{ f.__uid=Math.random().toString(36).slice(2,10); stagedByLesson[idx].addFiles.push(f); });
        fileInput.value='';
        markDirty(); renderLesson(idx); showInfo('Staged','File(s) will be uploaded on Save.');
      });

      // -------- Events (link) --------
      linkRow.querySelector('.btn-prev-link').addEventListener('click', (e)=>{
        e.preventDefault();
        const val = (linkRow.querySelector('.lesson-link-input').value||'').trim();
        if (!val) { showInfo('No link entered','Paste a URL first.'); return; }
        openPreviewModalWithMeta({url:val,title:val,mime:''});
      });
      linkRow.querySelector('.btn-stage-link').addEventListener('click', (e)=>{
        e.preventDefault();
        const val = (linkRow.querySelector('.lesson-link-input').value||'').trim();
        if (!val) { showInfo('No Link','Please paste a URL.'); return; }
        stagedByLesson[idx].addLinks.push(val);
        linkRow.querySelector('.lesson-link-input').value='';
        markDirty(); renderLesson(idx); showInfo('Staged','Link will be added on Save.');
      });

      // Assemble
      wrap.appendChild(sub);
      wrap.appendChild(cont);
      wrap.appendChild(fileRow);
      wrap.appendChild(linkRow);
      wrap.appendChild(list);

      function syncLessonTypeUI(){
        const type = document.getElementById('moduleType').value;
        if (type === 'file'){ fileRow.style.display=''; linkRow.style.display='none'; }
        else if (type === 'text'){ fileRow.style.display='none'; linkRow.style.display=''; }
        else { fileRow.style.display='none'; linkRow.style.display='none'; }
      }
      syncLessonTypeUI();

      wrap.syncLessonTypeUI = syncLessonTypeUI;
      return wrap;
    }

    function renderLesson(idx){
      ensureLessonState(idx);
      const list = document.getElementById(`filesList_${idx}`);
      const cur = attachmentsByLesson[idx];
      const staged = stagedByLesson[idx];

      const view = [];
      for (const a of (cur||[])) {
        const id = String(a.id||'');
        const isRemoved = id && staged.removeIds.has(id);
        view.push({ ...a, __pendingRemoval: !!isRemoved });
      }
      for (const f of (staged.addFiles||[])){
        view.push({ id:`__staged_file_${f.__uid}`, type:'file', __staged:true, __stagedName:f.name });
      }
      for (const link of (staged.addLinks||[])){
        view.push({ id:`__staged_link_${btoa(link).slice(0,12)}`, type:'link', url:link, __staged:true, __stagedName:link });
      }

      if (!view.length) { list.innerHTML=`<li class="text-muted">No files or links.</li>`; return; }

      list.innerHTML = view.map(att=>{
        let baseName = pickName(att);
        let nameHtml = `<a href="javascript:void(0)" data-act="preview">${baseName}</a>`;
        if (att.__pendingRemoval) nameHtml = `<span class="name-removed">${baseName}</span>`;
        let stagedChip = att.__staged ? chip('Staged','badge-stage') : '';
        let removalChip = att.__pendingRemoval ? chip('Pending removal','badge-removal') : '';

        let controls = `
          <button class="btn btn-outline-secondary btn-sm btn-icon" data-act="preview" title="Preview"><i class="bi bi-eye"></i></button>`;
        if (!att.__staged && att.type !== 'link') {
          controls += `
            <label class="btn btn-outline-secondary btn-sm mb-0 btn-icon" title="Stage replace">
              <i class="bi bi-arrow-repeat"></i>
              <input type="file" class="d-none input-replace" data-id="${att.id}">
            </label>`;
        }
        if (!att.__staged) {
          controls += `<button class="btn btn-outline-danger btn-sm btn-icon btn-stage-delete" data-id="${att.id}" title="Stage delete"><i class="bi bi-trash"></i></button>`;
        } else {
          controls += `<button class="btn btn-outline-danger btn-sm btn-icon btn-unstage" data-id="${att.id}" title="Remove from staging"><i class="bi bi-x-lg"></i></button>`;
        }

        return `
          <li class="file-item" data-id="${att.id}" data-type="${att.type}">
            ${badgeForType(att.type)}
            <div class="file-name">${nameHtml}</div>
            ${stagedChip}${removalChip}
            <div class="d-flex align-items-center gap-1">${controls}</div>
          </li>`;
      }).join('');

      // delegates
      list.querySelectorAll('[data-act="preview"]').forEach(el=>{
        el.addEventListener('click', ()=>{
          const li = el.closest('.file-item'); if(!li) return;
          const id = li.getAttribute('data-id');
          const item = (function(){
            const found = (attachmentsByLesson[idx]||[]).find(a=>String(a.id)===String(id));
            if (found) return found;
            const st = stagedByLesson[idx];
            if (id.startsWith('__staged_file_')) {
              const f = st.addFiles.find(f=>`__staged_file_${f.__uid}`===id);
              if (!f) return null;
              const blobUrl=URL.createObjectURL(f); currentPreviewRevoke=()=>URL.revokeObjectURL(blobUrl);
              openPreviewModalWithMeta({url:blobUrl,title:f.name,mime:f.type||'',isStaged:true, stageContext:{ idx, files:[f] }, stageLabel:'Stage selected file'});
              return null;
            }
            if (id.startsWith('__staged_link_')) {
              const link = st.addLinks.find(l=>`__staged_link_${btoa(l).slice(0,12)}`===id);
              if (link) openPreviewModalWithMeta({url:link,title:link,mime:'',isStaged:true});
              return null;
            }
            return null;
          })();
          if (item){
            const direct = pickHref(item);
            const sp = extractStoragePath(item);
            if (direct && /firebasestorage\.googleapis\.com\/v0\/b\//i.test(direct)) {
              openPreviewModalWithMeta({url:direct,title:pickName(item),mime:item.mime||''}); return;
            }
            if (!sp){ if (direct) openPreviewModalWithMeta({url:direct,title:pickName(item),mime:item.mime||''}); return; }
            fetch(`${API}/attachments/signed?path=${encodeURIComponent(sp)}`)
              .then(r=>r.json().catch(()=>null).then(js=>({ok:r.ok, js})))
              .then(({ok,js})=>{
                if(ok && js?.success && js?.url) openPreviewModalWithMeta({url:js.url,title:pickName(item),mime:item.mime||''});
                else if (direct) openPreviewModalWithMeta({url:direct,title:pickName(item),mime:item.mime||''});
              })
              .catch(()=>{ if (direct) openPreviewModalWithMeta({url:direct,title:pickName(item),mime:item.mime||''}); });
          }
        });
      });

      list.querySelectorAll('.btn-stage-delete').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          if (id) { stagedByLesson[idx].removeIds.add(String(id)); markDirty(); renderLesson(idx); }
        });
      });
      list.querySelectorAll('.btn-unstage').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          if (id.startsWith('__staged_file_')) {
            stagedByLesson[idx].addFiles = stagedByLesson[idx].addFiles.filter(f=>`__staged_file_${f.__uid}`!==id);
          } else if (id.startsWith('__staged_link_')) {
            stagedByLesson[idx].addLinks = stagedByLesson[idx].addLinks.filter(l=>`__staged_link_${btoa(l).slice(0,12)}`!==id);
          }
          markDirty(); renderLesson(idx);
        });
      });
      list.querySelectorAll('.input-replace').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const file = inp.files && inp.files[0]; if (!file) return;
          if (file.size > FILE_LIMIT_BYTES) { showInfo('File too large', `❌ Selected file exceeds ${FILE_LIMIT_MB} MB.`); return; }
          const replaceId = inp.getAttribute('data-id');
          const f = file; f.__uid=Math.random().toString(36).slice(2,10);
          stagedByLesson[idx].addFiles.push(f);
          if (replaceId) stagedByLesson[idx].removeIds.add(String(replaceId));
          markDirty(); renderLesson(idx);

          const blobUrl=URL.createObjectURL(file); currentPreviewRevoke=()=>URL.revokeObjectURL(blobUrl);
          openPreviewModalWithMeta({url:blobUrl,title:file.name,mime:file.type||'',isStaged:true, stageContext:{ idx, files:[f] }, stageLabel:'Stage selected file'});
        });
      });
    }

    function addLesson(goToNew=true){
      const idx = pager.pages.length;
      const page = buildLessonPage(idx);
      pager.pages.push(page);
      document.getElementById('lessonPager').appendChild(page);
      ensureLessonState(idx);
      if (goToNew) {
        pager.cur = pager.pages.length - 1;
        renderPager();
        setTimeout(() => { page.scrollIntoView({behavior:'smooth',block:'center'}); }, 120);
      } else {
        renderPager();
      }
      renderLesson(idx);
      markDirty();
    }
    function removeCurrentLesson(){
      if (pager.pages.length <= 1) return;
      const idx = pager.cur;
      pager.pages[idx].remove();
      pager.pages.splice(idx,1);
      const oldAttachments = {...attachmentsByLesson};
      const oldStaged = {...stagedByLesson};
      for (const k in attachmentsByLesson) delete attachmentsByLesson[k];
      for (const k in stagedByLesson) delete stagedByLesson[k];
      pager.pages.forEach((p,i)=>{ p.dataset.index=i; attachmentsByLesson[i]=oldAttachments[i>=idx?i+1:i]||[]; stagedByLesson[i]=oldStaged[i>=idx?i+1:i]||{addFiles:[],addLinks:[],removeIds:new Set()}; });
      if (pager.cur >= pager.pages.length) pager.cur = pager.pages.length - 1;
      renderPager();
      pager.pages.forEach((_,i)=>renderLesson(i));
      markDirty();
    }
    function renderPager(){
      pager.pages.forEach((p,i)=>{
        p.classList.toggle('active', i===pager.cur);
        p.style.display = (i===pager.cur) ? '' : 'none';
      });
      document.getElementById('pageNow').textContent = pager.cur + 1;
      document.getElementById('pageTotal').textContent = pager.pages.length;

      const dots = document.getElementById('stepDots'); dots.innerHTML='';
      for (let i=0;i<pager.pages.length;i++){
        const d = create('span','dot'+(i===pager.cur?' active':'')); d.style.cursor = 'pointer'; d.title = `Go to lesson ${i+1}`;
        d.addEventListener('click',()=>{ pager.cur = i; renderPager(); });
        dots.appendChild(d);
      }
      pager.pages.forEach(p=>p.syncLessonTypeUI && p.syncLessonTypeUI());
    }
    document.getElementById('addLessonBtn').addEventListener('click', ()=>{ addLesson(true); });
    document.getElementById('removeLessonBtn').addEventListener('click', removeCurrentLesson);
    document.getElementById('prevBtn').addEventListener('click', ()=>{ if(pager.cur>0){ pager.cur--; renderPager(); }});
    document.getElementById('nextBtn').addEventListener('click', ()=>{ if(pager.cur<pager.pages.length-1){ pager.cur++; renderPager(); }});
    document.getElementById('moduleType').addEventListener('change', ()=>{ renderPager(); });

    /* -------------------- Assign-to-Classes (FILTERED) -------------------- */
    const assignedContainer = document.getElementById("assignedClassesContainer");
    const assignedStatus = document.getElementById("assigned-status");
    const assignedEmpty = document.getElementById("assigned-empty");
    let selectedClassIds = new Set();
    let initialAssigned = new Set();
    let eligibleClassIdSet = new Set();

    function escapeHTML(str='') {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function renderClassCards(classes) {
      assignedContainer.innerHTML = "";
      if (!classes.length) {
        assignedStatus.style.display = "none";
        assignedEmpty.style.display = "block";
        return;
      }
      classes.forEach(c => {
        const id = c.id || c._id || c.classId || "";
        const name = c.name || c.className || "Untitled Class";
        const grade = c.gradeLevel ?? c.grade ?? "—";
        const section = c.section ?? c.sectionName ?? "—";

        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-lg-4";

        const card = document.createElement("div");
        card.className = "card assign-card";
        card.tabIndex = 0;

        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.value = id;
        chk.className = "d-none";
        if (selectedClassIds.has(id)) {
          chk.checked = true;
          card.classList.add("selected");
        }
        card.appendChild(chk);

        const body = document.createElement("div");
        body.className = "card-body";
        body.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="card-title mb-1">${escapeHTML(name)}</h5>
            <i class="bi bi-check2-circle ms-2" style="opacity:.35;"></i>
          </div>
          <div class="small-muted">Grade ${escapeHTML(grade)} • Section ${escapeHTML(section)}</div>
        `;
        card.appendChild(body);

        function toggle() {
          const isChecked = !chk.checked;
          chk.checked = isChecked;
          card.classList.toggle("selected", isChecked);
          if (isChecked) selectedClassIds.add(id);
          else selectedClassIds.delete(id);
          const now = [...selectedClassIds].sort().join(',');
          const was = [...initialAssigned].sort().join(',');
          if (now !== was) markDirty();
        }
        card.addEventListener("click", e => {
          if (window.getSelection && String(window.getSelection()).length) return;
          toggle();
        });
        card.addEventListener("keydown", e => {
          if (e.key === " " || e.key === "Enter") { e.preventDefault(); toggle(); }
        });

        col.appendChild(card);
        assignedContainer.appendChild(col);
      });
      assignedStatus.style.display = "none";
      assignedEmpty.style.display = "none";
    }

    async function fetchCourseObject(courseId) {
      if (!courseId) return null;
      const candidates = [
        `${API}/courses/${encodeURIComponent(courseId)}`,
        `${API}/courses?courseId=${encodeURIComponent(courseId)}`
      ];
      for (const u of candidates) {
        try {
          const r = await fetch(u, { headers:{Accept:'application/json'} });
          if (!r.ok) continue;
          const j = await r.json();
          if (j && typeof j === 'object') {
            if (j.course && typeof j.course === 'object') return j.course;
            if (Array.isArray(j.courses)) {
              const hit = j.courses.find(c => (c.id || c._id) === courseId);
              return hit || j.courses[0] || null;
            }
            if (j.id || j._id || j.title || j.courseNumber) return j;
          }
        } catch {}
      }
      return null;
    }
    function collectIds(maybe) {
      const out = [];
      if (Array.isArray(maybe)) {
        for (const v of maybe) {
          if (typeof v === 'string') out.push(v);
          else if (v && typeof v === 'object') out.push(v.id || v._id || v.classId || v.value || v.key || null);
        }
      } else if (maybe && typeof maybe === 'object') {
        for (const k of Object.keys(maybe)) {
          const v = maybe[k];
          if (typeof v === 'string') out.push(v);
          else if (v && typeof v === 'object') out.push(v.id || v._id || v.classId || k);
          else out.push(k);
        }
      }
      return out.filter(Boolean).map(String);
    }
    async function loadCourseEligibleClassIds(courseId) {
      eligibleClassIdSet = new Set();
      const course = await fetchCourseObject(courseId);
      if (!course) return;
      const candidateFields = ['assignedClasses','assignedClassIds','classIds','classes','enrolledClasses','linkedClasses'];
      for (const f of candidateFields) {
        if (course[f] !== undefined) {
          collectIds(course[f]).forEach(id => eligibleClassIdSet.add(String(id)));
        }
      }
      for (const [k,v] of Object.entries(course)) {
        if (Array.isArray(v) && v.length && k.toLowerCase().includes('class')) {
          collectIds(v).forEach(id => eligibleClassIdSet.add(String(id)));
        }
      }
    }
    function classMatchesCourse(c, courseId) {
      const id = String(c.id || c._id || c.classId || '');
      if (!id) return false;
      if (eligibleClassIdSet.size > 0 && eligibleClassIdSet.has(id)) return true;
      if (String(c.courseId || '') === String(courseId)) return true;
      if (Array.isArray(c.courseIds) && c.courseIds.map(String).includes(String(courseId))) return true;
      if (Array.isArray(c.courses)) {
        const ids = c.courses.map(v => typeof v === 'string' ? v : (v?.id || v?._id));
        if (ids.map(String).includes(String(courseId))) return true;
      }
      return false;
    }

    async function loadTeacherClassesAndRender(courseId) {
      try {
        const teacherId = window.currentUser?.userId || window.currentUser?.id || window.currentUser?.uid || '';
        if (!teacherId) {
          assignedStatus.textContent = "Missing teacher ID in your session.";
          assignedStatus.classList.remove('small-muted');
          assignedStatus.classList.add('text-danger');
          return;
        }

        await loadCourseEligibleClassIds(courseId);

        const candidates = [
          `${API}/classes?teacherId=${encodeURIComponent(teacherId)}&courseId=${encodeURIComponent(courseId||'')}`,
          `${API}/classes?teacherId=${encodeURIComponent(teacherId)}`
        ];
        let classes=null, success=false;
        for (const u of candidates) {
          try {
            const r = await fetch(u, { headers:{Accept:'application/json'} });
            if (!r.ok) continue;
            const j = await r.json();
            const arr = j?.classes || j?.data || (Array.isArray(j) ? j : null);
            if (Array.isArray(arr)) { classes = arr; success = (j?.success === undefined ? true : !!j.success); break; }
          } catch {}
        }

        assignedContainer.innerHTML = "";
        assignedEmpty.style.display = "none";

        if (!classes) {
          assignedStatus.textContent = "Could not load your classes.";
          assignedStatus.classList.remove('small-muted');
          assignedStatus.classList.add('text-danger');
          return;
        }
        if (!success) {
          assignedStatus.textContent = "Could not load your classes.";
          assignedStatus.classList.remove('small-muted');
          assignedStatus.classList.add('text-danger');
          return;
        }

        const filtered = classes.filter(c => classMatchesCourse(c, courseId));
        renderClassCards(filtered);
      } catch (e) {
        console.error("Could not load classes:", e);
        assignedStatus.textContent = "Could not load your classes. Please refresh.";
        assignedStatus.classList.remove('small-muted');
        assignedStatus.classList.add('text-danger');
        showInfo('Network Error', 'Could not load your classes. Please refresh and try again.');
      }
    }

    /* -------------------- Publish UI refs -------------------- */
    const publishedSwitch = document.getElementById('publishedSwitch');
    const publishAtInput  = document.getElementById('publishAtInput');
    const btnPublishNow   = document.getElementById('btnPublishNow');
    const btnClearSchedule= document.getElementById('btnClearSchedule');
    const metaPublishedState = document.getElementById('metaPublishedState');
    const metaPublishAt   = document.getElementById('metaPublishAt');
    const metaPublishedAt = document.getElementById('metaPublishedAt');

    btnPublishNow.addEventListener('click', (e)=>{
      e.preventDefault();
      const now = new Date();
      publishAtInput.value = dateToLocalInputValue(now);
      markDirty();
    });
    btnClearSchedule.addEventListener('click', (e)=>{
      e.preventDefault();
      publishAtInput.value = '';
      markDirty();
    });
    publishedSwitch.addEventListener('change', markDirty);
    publishAtInput.addEventListener('change', markDirty);

    /* -------------------- Load module -------------------- */
    let initialModule=null;

    async function loadCourseTitle(cid){
      if (!cid) return;
      try{
        const r = await fetch(`${API}/courses/${encodeURIComponent(cid)}`);
        const js = await r.json().catch(()=>null);
        if (js && js.title) document.getElementById('metaCourse').textContent = js.title;
      }catch{}
    }
    async function loadModule(){
      if (!moduleId){ showInfo('Missing ID','No <code>moduleId</code> provided.'); return; }
      try{
        const res = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}?t=${Date.now()}`, { cache:'no-store' });
        const m = await res.json();
        if (!res.ok || m.success===false) throw new Error(m.message || 'Failed to load module');

        initialModule = m;
        document.querySelector('.page-title').textContent = `Edit Module ${m.moduleNumber ? `#${m.moduleNumber} – ` : ''}${m.title || ''}`;
        document.getElementById('metaNumber').textContent  = m.moduleNumber ?? '—';
        document.getElementById('metaCreated').textContent = msToLocal(tsToMs(m.createdAt));
        document.getElementById('metaUpdated').textContent = msToLocal(tsToMs(m.updatedAt));
        updateStatusBadge(m.archived === true);

        const published   = !!m.published;
        const publishAtMs = tsToMs(m.publishAt);
        const publishedAtMs = tsToMs(m.publishedAt);
        publishedSwitch.checked = published;
        publishAtInput.value = publishAtMs ? dateToLocalInputValue(new Date(publishAtMs)) : '';
        metaPublishedState.textContent = published ? 'Published' : 'Unpublished';
        metaPublishAt.textContent = publishAtMs ? msToLocal(publishAtMs) : '—';
        metaPublishedAt.textContent = publishedAtMs ? msToLocal(publishedAtMs) : '—';

        document.getElementById('titleInput').value = m.title || '';
        document.getElementById('moduleType').value = (m.type==='textonly'?'textonly':m.type||'file');

        const subs = Array.isArray(m.moduleSubTitles) ? m.moduleSubTitles : [];
        const descs= Array.isArray(m.moduleSubDescs) ? m.moduleSubDescs : [];
        const maxLessonsFromAttachments = Math.max(0, ...(Array.isArray(m.attachments)?m.attachments.map(a=>(a.lessonIdx??0)+1):[0]));
        const max = Math.max(subs.length, descs.length, maxLessonsFromAttachments, 1);
        document.getElementById('lessonPager').innerHTML=''; pager.pages=[];

        for (let i=0;i<max;i++) addLesson(false);
        pager.cur=0; renderPager();

        pager.pages.forEach((p,i)=>{
          p.querySelector('.lesson-subtitle').value = subs[i] || '';
          p.querySelector('.lesson-content').value  = descs[i] || '';
        });

        for (let i=0;i<max;i++){ ensureLessonState(i); attachmentsByLesson[i]=[]; stagedByLesson[i]={addFiles:[],addLinks:[],removeIds:new Set()}; }
        if (Array.isArray(m.attachments)){
          m.attachments.forEach(att=>{
            const idx = Number(att.lessonIdx ?? 0);
            ensureLessonState(idx);
            attachmentsByLesson[idx].push(att);
          });
        }
        pager.pages.forEach((_,i)=>renderLesson(i));

        selectedClassIds = new Set(Array.isArray(m.assignedClasses) ? m.assignedClasses.filter(Boolean) : []);
        initialAssigned = new Set(selectedClassIds);

        await loadCourseTitle(m.courseId || '');
        await loadTeacherClassesAndRender(m.courseId || backCourseId || '');

        clearDirty();
      }catch(e){ console.error(e); showInfo('Error', e.message || 'Failed to load module.'); }
    }

    function updateStatusBadge(archived){
      const metaStatus = document.getElementById('metaStatus');
      metaStatus.textContent = archived ? 'Archived' : 'Active';
      metaStatus.className = `badge ${archived?'text-bg-secondary':'text-bg-success'}`;
      document.getElementById('btnArchive').classList.toggle('d-none', archived);
      document.getElementById('btnUnarchive').classList.toggle('d-none', !archived);
    }

    /* -------------------- Save / Archive / Delete -------------------- */

    function collectLessonsForSave(){
      const subs=[], descs=[];
      pager.pages.forEach(p=>{
        subs.push(p.querySelector('.lesson-subtitle').value.trim());
        descs.push(p.querySelector('.lesson-content').value.trim());
      });

      function hasAny(i){
        if (subs[i] || descs[i]) return true;
        const cur = attachmentsByLesson[i]||[];
        const st  = stagedByLesson[i]||{addFiles:[],addLinks:[]};
        return cur.length>0 || st.addFiles.length>0 || st.addLinks.length>0;
      }
      let last=-1; for(let i=0;i<subs.length;i++){ if(hasAny(i)) last=i; }
      const trimmedSubs  = subs.slice(0, last+1);
      const trimmedDescs = descs.slice(0, last+1);
      return { subs: trimmedSubs, descs: trimmedDescs, count: Math.max(0,last+1) };
    }

    async function applySave(){
      const title = document.getElementById('titleInput').value.trim();
      if (!title){ document.getElementById('formError').textContent='Title is required.'; return; }
      document.getElementById('formError').textContent='';

      const { subs, descs, count } = collectLessonsForSave();

      const published = !!publishedSwitch.checked;
      const publishAtDate = localInputValueToDate(publishAtInput.value);
      const publishAtISO = publishAtDate ? publishAtDate.toISOString() : null;

      const assignedClasses = Array.from(selectedClassIds);

      const payload = {
        title,
        description: (document.getElementById('descHidden').value || " "),
        moduleSubTitles: subs,
        moduleSubDescs:  descs,
        lessonCount: count,
        assignedClasses,
        published,
        publishAt: publishAtISO
      };

      const upd = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}`, {
        method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const updJs = await upd.json().catch(()=>({}));
      if (!upd.ok || updJs.success===false) throw new Error(updJs.message || 'Failed to save details.');

      if (document.getElementById('moduleType').value === 'file'){
        const form = new FormData();
        let hasFiles=false;
        pager.pages.forEach((_,idx)=>{
          stagedByLesson[idx].addFiles.forEach(f=>{
            hasFiles=true;
            form.append('attachmentFiles', f);
            form.append('attachmentDescs', '');
            form.append('attachmentLessonIdx', String(idx));
          });
        });
        if (hasFiles){
          const up = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}/files`, { method:'POST', body: form });
          const upJs = await up.json().catch(()=>({}));
          if (!up.ok || upJs.success===false) throw new Error(upJs.message || 'Failed to upload attachments.');
        }
      }

      if (document.getElementById('moduleType').value === 'text'){
        const urls=[], descsJson=[], idxs=[];
        pager.pages.forEach((_,idx)=>{
          stagedByLesson[idx].addLinks.forEach(u=>{
            urls.push(u); descsJson.push(''); idxs.push(String(idx));
          });
        });
        if (urls.length){
          const add = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}/files`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ videoUrls: urls, videoDesc: descsJson, attachmentLessonIdx: idxs })
          });
          const addJs = await add.json().catch(()=>({}));
          if (!add.ok || addJs.success===false) throw new Error(addJs.message || 'Failed to add links.');
        }
      }

      for (const idx in stagedByLesson){
        for (const id of stagedByLesson[idx].removeIds){
          const del = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}/files/${encodeURIComponent(id)}`, { method:'DELETE' });
          const delJs = await del.json().catch(()=>({}));
          if (!del.ok || delJs.success===false) throw new Error(delJs.message || 'Failed to remove file/link.');
        }
      }

      await loadModule();
      clearDirty();
      showInfo('Success','Your changes (including publish settings, staged files/links, and class assignments) have been saved.');
    }

    const btnSave = document.getElementById('btnSave');
    const saveSpinner = btnSave.querySelector('.spinner-border');
    const saveText = btnSave.querySelector('.save-text');

    btnSave.addEventListener('click', async ()=>{
      btnSave.disabled = true; saveSpinner.classList.remove('visually-hidden'); saveText.textContent='Saving…';
      try{ await applySave(); }
      catch(e){ console.error(e); document.getElementById('formError').textContent = e.message || 'Server error while saving.'; }
      finally{ btnSave.disabled = false; saveSpinner.classList.add('visually-hidden'); saveText.textContent='Save Changes'; }
    });

    document.getElementById('btnArchive').addEventListener('click', async ()=>{
      if (!moduleId) return;
      const ok = await confirmDanger('Archive Module','Archive this module? It will be hidden from students.');
      if (!ok) return;
      try{
        const r = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}/archive`, { method:'PUT' });
        const js = await r.json().catch(()=>({}));
        if(!r.ok||js.success===false) throw new Error(js.message||'Failed to archive.');
        updateStatusBadge(true); showInfo('Archived','The module is now hidden from students.');
      }catch(e){ showInfo('Error', e.message||'Failed to archive.'); }
    });
    document.getElementById('btnUnarchive').addEventListener('click', async ()=>{
      if (!moduleId) return;
      try{
        const r = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}/unarchive`, { method:'PUT' });
        const js = await r.json().catch(()=>({}));
        if(!r.ok||js.success===false) throw new Error(js.message||'Failed to unarchive.');
        updateStatusBadge(false); showInfo('Unarchived','Students can see this module again.');
      }catch(e){ showInfo('Error', e.message||'Failed to unarchive.'); }
    });

    function computeBackUrl() {
      const cid = backCourseId || initialModule?.courseId || '';
      if (cid) return `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(cid)}`;
      return `/TEACHER/Modules/module_list.html`;
    }

    document.getElementById('btnBack').addEventListener('click', async ()=>{
      if (!isDirty()) {
        location.href = computeBackUrl();
        return;
      }
      const ok = await confirmDanger(
        'Leave without saving?',
        'You have unsaved changes (including staged files/links, class assignments, or publish settings). Leave without saving?'
      );
      if (ok) location.href = computeBackUrl();
    });

    /* ===== Delete with TYPE-TO-CONFIRM (Module Title, with no-copy hints) ===== */
    document.getElementById('btnDelete').addEventListener('click', async ()=>{
      if (!moduleId) return;

      let titleToMatch = initialModule?.title || '';
      if (!titleToMatch) {
        try {
          const r = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}`);
          const j = await r.json();
          titleToMatch = j?.title || '';
        } catch {}
      }

      let ok = false;
      if (titleToMatch) {
        ok = await showTypeToConfirm({
          title: 'Delete Module',
          expected: String(titleToMatch),
          placeholder: 'Type Module Title here',
          primaryText: 'Delete'
        });
      } else {
        ok = await confirmDanger('Delete Module','<strong>Permanently delete</strong> this module? This cannot be undone.');
      }
      if (!ok) return;

      try{
        const r = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}`, { method:'DELETE' });
        const js = await r.json().catch(()=>({}));
        if(!r.ok||js.success===false) throw new Error(js.message||'Failed to delete.');
        showInfo('Deleted','Module deleted.');
        setTimeout(()=>{ location.href = computeBackUrl(); }, 800);
      }catch(e){ showInfo('Error', e.message||'Failed to delete.'); }
    });

    function openPreviewModalWithMeta({url, title='File', mime='', isStaged=false, stageContext=null, stageLabel}){
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      const kind = kindFrom({url, name:title, mime});
      setFileInfoUI(kind, url);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), {url, name:title, mime, isStaged});
      previewStageCtx = stageContext || null;

      if (previewStageCtx && Array.isArray(previewStageCtx.files)) {
        const n = previewStageCtx.files.length || 1;
        showStageBtn(true, stageLabel || (n === 1 ? 'Stage selected file' : `Stage selected (${n})`));
      } else {
        showStageBtn(false);
      }
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    // Boot
    (function boot(){
      addLesson(false);
      loadModule();
    })();
  </script>
</body>
</html>
