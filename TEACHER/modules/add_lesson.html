<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EduConnect Teacher – Add Lessons (Paged)</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Keep your theme -->
  <link rel="stylesheet" href="list.css"/>
  <link rel="stylesheet" href="upload.css"/>

  <style>
    .inline-field { min-width: 260px; }
    .small-muted { color:#6c757d; font-size:.9rem; }
    .ui-card { background:#fff; border-radius: var(--card-radius, 14px); box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .ui-card-head { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border,#e5e7eb); background: #fff; border-radius: inherit; }
    .ui-card-title { margin:0; font-size:1.1rem; display:flex; align-items:center; gap:.5rem; }
    .page-title { margin-bottom:.75rem; }
    .lesson-page { border: 1px solid var(--border, #e9ecef); border-radius: 12px; }
    .step-dots .dot { display:inline-block; width:8px; height:8px; border-radius:999px; background:#d0d7e2; margin:0 3px; }
    .step-dots .dot.active { background: var(--brand-accent-1, #3b6bb4); }
    .pager-chip { font-size:.9rem; padding:.15rem .5rem; border: 1px solid #e5e7eb; border-radius:999px; color:#6c757d; }
    .badge-soft.badge-stage { background: rgba(255, 193, 7, .1); border: 1px dashed rgba(255, 193, 7, .6); color:#b08900; padding:.2rem .45rem; border-radius:999px; }
    .badge-soft.badge-file { background: rgba(59, 107, 180, .08); color:#3b6bb4; border:1px dashed rgba(59,107,180,.35); padding:.2rem .45rem; border-radius:999px; }
    .badge-soft.badge-link { background: rgba(25,135,84,.08); color:#198754; border:1px dashed rgba(25,135,84,.35); padding:.2rem .45rem; border-radius:999px; }
    .file-list { list-style:none; padding-left:0; margin:0; }
    .file-item { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem .75rem; border:1px dashed #e5e7eb; border-radius:12px; margin:.5rem 0; }
    .file-name { max-width: 56ch; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .spinner-wrap { display:none; align-items:center; justify-content:center; min-height:260px; }
    .preview-wrap iframe, .preview-wrap video, .preview-wrap audio, .preview-wrap img { width:100%; border:0; }
    .preview-fallback { text-align:center; padding:1rem; }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative" style="max-width:520px;">
          <input type="text" class="form-control" placeholder="Add lessons to an existing module…" disabled/>
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%); opacity:.35;"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid p-4">
        <h1 class="page-title">Add Lessons <span class="small-muted" id="moduleTitleTag">— Loading…</span></h1>

        <div class="ui-card card-themed mx-auto" style="max-width:1080px;">
          <div class="ui-card-head">
            <h2 class="ui-card-title">
              <i class="bi bi-plus-circle"></i>
              New Lessons (Paged)
            </h2>
            <div class="ui-subtext small-muted">Use Add Lesson to create more pages. Stage files/links below and assign to a target lesson.</div>
          </div>

          <div class="p-3">
            <!-- Module summary -->
            <div class="row g-3 mb-2">
              <div class="col-md-4">
                <div class="small-muted">Module</div>
                <div class="fw-semibold" id="modTitle">—</div>
              </div>
              <div class="col-md-4">
                <div class="small-muted">Module Type</div>
                <div class="fw-semibold" id="modType">—</div>
              </div>
              <div class="col-md-4">
                <div class="small-muted">Current lessons</div>
                <div class="fw-semibold"><span id="currentCount">—</span></div>
              </div>
            </div>

            <!-- Pager toolbar -->
            <div class="mt-3 d-flex justify-content-between align-items-center">
              <label class="form-label mb-0 fw-semibold">Lessons (Sub Title, Content)</label>
              <div class="lesson-toolbar">
                <span class="pager-chip"><span id="pageNow">1</span>/<span id="pageTotal">1</span></span>
                <div id="stepDots" class="step-dots" aria-hidden="true"><span class="dot active"></span></div>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
                </div>
                <button type="button" class="btn btn-amber btn-sm" id="addLessonBtn"><i class="bi bi-plus-lg"></i> Add Lesson</button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="removeLessonBtn"><i class="bi bi-trash"></i> Remove</button>
              </div>
            </div>

            <!-- Lessons container (paged) -->
            <div id="lessonPager" class="mt-2"></div>

            <!-- Staging UI -->
            <div class="ui-card mt-3" id="stagingCard">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-paperclip"></i> Attachments & Links</h2>
              </div>
              <div class="p-3">
                <!-- Target lesson selector -->
                <div class="row g-2 mb-2" id="targetLessonRow">
                  <div class="col-md-6">
                    <label class="form-label">Assign staged items to lesson</label>
                    <select id="targetLessonSelect" class="form-select" aria-label="Target lesson"></select>
                    <div class="hint mt-1 small-muted">Choose which new lesson the staged file/link belongs to.</div>
                  </div>
                </div>

                <!-- Upload area: files ONLY when moduleType=file -->
                <div id="fileSection">
                  <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-8">
                      <label class="form-label">Upload file(s)</label>
                      <input id="fileInput" type="file" multiple class="form-control" />
                      <div class="small-muted mt-1">Per-file limit: <strong>300 MB</strong>. Select multiple; preview before staging.</div>
                    </div>
                    <div class="col-md-4 d-grid d-sm-flex gap-2">
                      <button id="btnPreviewSelectedFiles" class="btn btn-outline-secondary w-100 w-sm-auto">
                        <i class="bi bi-eye"></i> Preview Selected
                      </button>
                      <button id="btnStageFiles" class="btn btn-outline-primary w-100 w-sm-auto">
                        <i class="bi bi-cloud-plus"></i> Stage Files
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Link area: ONLY when moduleType=text -->
                <div id="linkSection">
                  <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-8">
                      <label class="form-label">Add a link or video URL</label>
                      <input id="linkInput" type="url" class="form-control" placeholder="https://… (YouTube, Vimeo, Docs, etc.)" />
                      <div class="small-muted mt-1">Paste a public URL. YouTube links auto-embed in preview.</div>
                    </div>
                    <div class="col-md-4 d-grid d-sm-flex gap-2">
                      <button id="btnPreviewLink" class="btn btn-outline-secondary w-100 w-sm-auto">
                        <i class="bi bi-eye"></i> Preview
                      </button>
                      <button id="btnStageLink" class="btn btn-outline-secondary w-100 w-sm-auto">
                        <i class="bi bi-link-45deg"></i> Stage Link
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Staged list -->
                <ul id="filesList" class="file-list"></ul>
                <div class="form-text mt-2">
                  <strong>Staging:</strong> items marked with
                  <span class="badge-soft badge-stage">Staged</span>
                  will be uploaded/added when you click <strong>Add Lessons</strong>.
                </div>
              </div>
            </div>

            <!-- Error -->
            <div id="formError" class="text-danger mt-3" style="min-height:1.2rem;"></div>

            <!-- Actions -->
            <div class="d-flex justify-content-end gap-2 mt-4">
              <a id="backBtn" href="/TEACHER/Modules/module_list.html" class="btn btn-close-footer">← Back</a>
              <button id="submitBtn" type="button" class="btn btn-amber">
                <span class="submit-text">Add Lessons</span>
                <span class="spinner-border spinner-border-sm ms-2 visually-hidden" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>
        <div class="modal-footer">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto d-flex gap-2">
            <button id="stageFromPreviewBtn" class="btn btn-amber text-white d-none">
              <i class="bi bi-cloud-plus me-1"></i> Stage this item
            </button>
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-close-footer">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic INFO Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sb = document.querySelector(".sidebar");
          const db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Auth guard + header initials -->
  <script>
    (function initHeaderInitials(){
      try{
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;

        if (!u?.userId || !u?.isTeacher) { window.location.href = "/TEACHER/login/login.html"; return; }
        window.currentUser = u;

        const initials = (function(u){
          const fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
          if(fn&&ln) return (fn[0]+ln[0]).toUpperCase();
          const nameish=(u.username||u.displayName||u.name||'').trim();
          if(nameish){
            const parts=nameish.replace(/[^A-Za-z0-9 _.\-]+/g,' ').split(/[\s._-]+/).filter(Boolean);
            if(parts.length>=2) return (parts[0][0]+parts[1][0]).toUpperCase();
            return parts[0][0].toUpperCase();
          }
          const em=(u.email||'').trim();
          return em?em[0].toUpperCase():'U';
        })(u);

        window.addEventListener("DOMContentLoaded", ()=>{
          const el=document.getElementById("Username");
          if(!el) return;
          el.textContent=initials;
          const full=[u.firstName,u.middleName,u.lastName].filter(Boolean).join(' ').trim() || u.username || u.email || 'Profile';
          el.setAttribute('title', full);
          el.setAttribute('aria-label', full);
        });
      }catch(e){ console.error('initHeaderInitials failed:', e); window.location.href = "/TEACHER/login/login.html"; }
    })();
  </script>

  <!-- Page Logic -->
  <script>
    const API_BASE = "http://localhost:5000";
    const TEACHER_MAX_MB = 300;
    const TEACHER_MAX_BYTES = TEACHER_MAX_MB * 1024 * 1024;

    const urlParams = new URLSearchParams(window.location.search);
    const moduleId = urlParams.get("moduleId");

    // DOM
    const modTitleEl     = document.getElementById('modTitle');
    const modTypeEl      = document.getElementById('modType');
    const moduleTitleTag = document.getElementById('moduleTitleTag');
    const currentCountEl = document.getElementById('currentCount');

    const lessonPagerEl  = document.getElementById('lessonPager');
    const pageNowEl      = document.getElementById('pageNow');
    const pageTotalEl    = document.getElementById('pageTotal');
    const dotsEl         = document.getElementById('stepDots');
    const prevBtn        = document.getElementById('prevBtn');
    const nextBtn        = document.getElementById('nextBtn');
    const addLessonBtn   = document.getElementById('addLessonBtn');
    const removeLessonBtn= document.getElementById('removeLessonBtn');

    // staging DOM
    const stagingCard    = document.getElementById('stagingCard');
    const fileSection    = document.getElementById('fileSection');
    const linkSection    = document.getElementById('linkSection');
    const fileInput      = document.getElementById('fileInput');
    const btnPreviewSelectedFiles = document.getElementById('btnPreviewSelectedFiles');
    const btnStageFiles  = document.getElementById('btnStageFiles');
    const linkInput      = document.getElementById('linkInput');
    const btnPreviewLink = document.getElementById('btnPreviewLink');
    const btnStageLink   = document.getElementById('btnStageLink');
    const filesList      = document.getElementById('filesList');
    const targetLessonSelect = document.getElementById('targetLessonSelect');

    const formError  = document.getElementById('formError');
    const submitBtn  = document.getElementById('submitBtn');
    const spinner    = submitBtn.querySelector('.spinner-border');
    const submitText = submitBtn.querySelector('.submit-text');
    const backBtn    = document.getElementById('backBtn');

    // preview modal
    const stageFromPreviewBtn = document.getElementById('stageFromPreviewBtn');
    let currentPreviewRevoke = null;
    let previewStageCtx = null; // { mode:'file'|'link', files?:File[], url?:string }

    // state
    let courseIdForBack = '';
    let moduleType = 'file';           // 'file' | 'text' | 'textonly'
    let currentSubTitles = [];
    let currentSubDescs  = [];
    let baseLessonIdx = 0;             // where new lessons start (existing count)

    // new lessons pager
    const pager = { cur: 0, pages: [] };

    // staging
    let staged = {
      addFiles: [], // File with __lesson (local new index) + __uid
      addLinks: []  // {url, lesson}
    };

    /* ---------- Helpers (escape, kind, preview) ---------- */
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    async function safeJson(res){ try { return await res.json(); } catch { return null; } }

    function setFileInfoUI(kind,url){
      const info=document.getElementById('fileInfoText');
      const hdr=document.getElementById('filePreviewModalLabel');
      const labelMap={youtube:'YouTube',video:'Video',audio:'Audio',image:'Image',pdf:'PDF',text:'Text/CSV',office:'Office Doc',other:'File'};
      let badge=document.getElementById('fileKindBadge'); if(!badge){badge=document.createElement('span');badge.id='fileKindBadge';badge.className='ms-2 badge rounded-pill';hdr.appendChild(badge);}
      badge.className='ms-2 badge rounded-pill bg-secondary-subtle text-secondary';
      badge.textContent=labelMap[kind]||'File';
      info.innerHTML=`<span class="text-muted">Type:</span> <strong>${labelMap[kind]||'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href=url||'#';
    }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function isYouTubeUrl(url=''){ try{const u=new URL(url);const h=u.hostname.replace(/^www\./,'').toLowerCase();return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);}catch{return false;} }
    function toYouTubeEmbed(url=''){ try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();let id='';let start=u.searchParams.get('start')||u.searchParams.get('t')||'';if(start&&/^\d+s$/.test(start))start=parseInt(start,10);if(start&&/^\d+$/.test(start))start=parseInt(start,10);if(!Number.isFinite(start))start=''; if(host==='youtu.be'){id=(u.pathname||'').replace(/^\//,'').split('/')[0];} else { if(u.pathname.startsWith('/embed/')) id=u.pathname.split('/')[2]||''; if(!id) id=u.searchParams.get('v')||''; } if(!id) return null; const base=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`; const qs=new URLSearchParams(); qs.set('rel','0'); if(start) qs.set('start', String(start)); return `${base}?${qs.toString()}`; }catch{return null;} }
    function extFromUrl(u=''){ const clean=String(u).split('?')[0].split('#')[0]; const parts=clean.split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function extFromName(n=''){ const parts=String(n).split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function kindFrom({url='', name='', mime=''}) {
      const ext = (extFromUrl(url) || extFromName(name)).toLowerCase();
      if (isYouTubeUrl(url)) return 'youtube';
      if ((mime||'').startsWith('image/') || ['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
      if (mime === 'application/pdf' || ext === 'pdf') return 'pdf';
      if ((mime||'').startsWith('video/') || ['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
      if ((mime||'').startsWith('audio/') || ['mp3','wav','m4a','ogg','aac','flac'].includes(ext)) return 'audio';
      if ((mime||'').startsWith('text/') || ['txt','csv','log'].includes(ext)) return 'text';
      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
      return 'other';
    }
    function renderFilePreviewInto(container, {url, name='', mime=''}) {
      container.innerHTML=''; showSpinner(true);
      const fallback=(msg)=>{ container.innerHTML=`<div class="preview-fallback"><div class="text-muted mb-2">${msg||'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; showSpinner(false); };
      const kind=kindFrom({url,name,mime});
      if(kind==='youtube'){const embed=toYouTubeEmbed(url); if(embed){container.innerHTML=`<div class="ratio ratio-16x9"><iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>`; showSpinner(false); return;} return fallback('Couldn’t embed this YouTube link.');}
      if(kind==='image'){const img=new Image(); img.onload=()=>showSpinner(false); img.onerror=()=>fallback('Image preview failed.'); img.src=url; container.appendChild(img); return;}
      if(kind==='pdf'){const iframe=document.createElement('iframe'); iframe.onload=()=>showSpinner(false); iframe.onerror=()=>fallback('PDF preview failed.'); iframe.src=url; container.appendChild(iframe); return;}
      if(kind==='video'){const v=document.createElement('video'); v.controls=true; v.onloadeddata=()=>showSpinner(false); v.onerror=()=>fallback('Video preview failed.'); v.src=url; container.appendChild(v); return;}
      if(kind==='audio'){const a=document.createElement('audio'); a.controls=true; a.onloadeddata=()=>showSpinner(false); a.onerror=()=>fallback('Audio preview failed.'); a.src=url; container.appendChild(a); return;}
      if(kind==='text'){const iframe=document.createElement('iframe'); iframe.onload=()=>showSpinner(false); iframe.onerror=()=>fallback('Text preview failed.'); iframe.src=url; container.appendChild(iframe); return;}
      if(kind==='office' && url.startsWith('blob:')){ return fallback('Office documents cannot be previewed until they’re uploaded.'); }
      if(kind==='office'){ const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe=document.createElement('iframe'); iframe.onload=()=>showSpinner(false); iframe.onerror=()=>fallback('Office preview failed.'); iframe.src=gview; container.appendChild(iframe); return; }
      const obj=document.createElement('object'); obj.data=url; obj.type=mime||'application/octet-stream'; obj.onload=()=>showSpinner(false); obj.onerror=()=>fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(()=>showSpinner(false),1200);
    }

    function showInfo(title, body, opts={}){
      const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('infoModal'));
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').innerHTML = body;
      if (opts.onHidden) {
        const el = document.getElementById('infoModal');
        const handler = () => { el.removeEventListener('hidden.bs.modal', handler); opts.onHidden(); };
        el.addEventListener('hidden.bs.modal', handler, { once: true });
      }
      m.show();
      if (opts.autoHideMs) setTimeout(()=>m.hide(), opts.autoHideMs);
    }

    /* ---------- Build & render pager ---------- */
    function buildLessonPage(index){
      const wrap = document.createElement('div');
      wrap.className = 'lesson-page card card-body mb-3';
      wrap.dataset.index = index;

      const title = document.createElement('input');
      title.className = 'form-control mb-2 lesson-subtitle';
      title.placeholder = 'Lesson Sub Title (optional)';

      const cont = document.createElement('textarea');
      cont.className = 'form-control mb-2 lesson-content';
      cont.rows = 3;
      cont.placeholder = 'Lesson Content...';

      const modeHelp = document.createElement('div');
      modeHelp.className = 'small-muted';
      modeHelp.setAttribute('data-mode-help','');

      wrap.append(title, cont, modeHelp);
      return wrap;
    }

    function renderPager(){
      pager.pages.forEach((p,i)=> p.style.display = (i===pager.cur)?'':'none');
      pageNowEl.textContent = pager.cur + 1;
      pageTotalEl.textContent = pager.pages.length;

      dotsEl.innerHTML='';
      for(let i=0;i<pager.pages.length;i++){
        const d=document.createElement('span');
        d.className='dot'+(i===pager.cur?' active':'');
        d.addEventListener('click',()=>{ pager.cur=i; renderPager(); });
        dotsEl.appendChild(d);
      }

      // target lesson select (for staging)
      targetLessonSelect.innerHTML = '';
      for(let i=0;i<pager.pages.length;i++){
        const opt=document.createElement('option');
        opt.value=String(i);
        opt.textContent=`New Lesson ${baseLessonIdx + i + 1}`;
        if(i===pager.cur) opt.selected=true;
        targetLessonSelect.appendChild(opt);
      }

      syncLessonModeHelp();
      syncStagingVisibility();
      renderAttachments();
    }

    function syncLessonModeHelp(){
      pager.pages.forEach(p=>{
        const el = p.querySelector('[data-mode-help]');
        if(!el) return;
        if(moduleType==='file'){ el.textContent='Attach files below and assign them to this lesson via the dropdown.'; }
        else if(moduleType==='text'){ el.textContent='Add links below and assign them to this lesson via the dropdown.'; }
        else { el.textContent='Text-only lesson (no uploads).'; }
      });
    }

    function addLesson(goNew=true){
      const idx=pager.pages.length;
      const page=buildLessonPage(idx);
      pager.pages.push(page);
      lessonPagerEl.appendChild(page);
      if(goNew) pager.cur=pager.pages.length-1;
      renderPager();
    }
    function removeCurrentLesson(){
      if(pager.pages.length<=1) return;
      const page=pager.pages[pager.cur];
      page.remove();
      pager.pages.splice(pager.cur,1);
      if(pager.cur>=pager.pages.length) pager.cur=pager.pages.length-1;
      renderPager();
      // also purge staged items that were assigned to lessons >= new length
      staged.addFiles = staged.addFiles.filter(f => (f.__lesson ?? 0) < pager.pages.length);
      staged.addLinks = staged.addLinks.filter(l => (l.lesson ?? 0) < pager.pages.length);
      renderAttachments();
    }

    prevBtn.addEventListener('click',()=>{ if(pager.cur>0){pager.cur--; renderPager();} });
    nextBtn.addEventListener('click',()=>{ if(pager.cur<pager.pages.length-1){pager.cur++; renderPager();} });
    addLessonBtn.addEventListener('click',()=>addLesson(true));
    removeLessonBtn.addEventListener('click',removeCurrentLesson);

    /* ---------- Staging ---------- */
    function chip(text, cls=''){ return `<span class="badge-soft ${cls}" style="font-size:.72rem">${escapeHtml(text)}</span>`; }
    function badgeForType(att){
      if (att.type === 'link') return `<span class="badge-soft badge-link"><i class="bi bi-link-45deg"></i> Link</span>`;
      return `<span class="badge-soft badge-file"><i class="bi bi-file-earmark"></i> File</span>`;
    }
    function getStagedView(){
      const out=[];
      for(const f of staged.addFiles){
        out.push({ id:`__staged_file_${f.__uid}`, type:'file', __stagedName:f.name, lesson:f.__lesson });
      }
      for(const l of staged.addLinks){
        out.push({ id:`__staged_link_${btoa(l.url).slice(0,12)}`, type:'link', __stagedName:l.url, url:l.url, lesson:l.lesson });
      }
      return out;
    }
    function renderAttachments(){
      const view=getStagedView();
      if(!view.length){ filesList.innerHTML = `<li class="text-muted">Nothing staged yet.</li>`; return; }
      filesList.innerHTML = view.map(att=>{
        const left = `
          ${badgeForType(att)}
          <div class="file-name">
            <button type="button" class="btn btn-link p-0 align-baseline" data-act="preview" title="Preview">${escapeHtml(att.__stagedName||'')}</button>
          </div>
          ${chip('New Lesson '+ String(baseLessonIdx + (att.lesson??0) + 1))}
        `;
        const controls = `
          <button class="btn btn-outline-secondary btn-sm btn-icon" data-act="preview" title="Preview">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-outline-danger btn-sm btn-icon" data-act="unstage" title="Remove from staging">
            <i class="bi bi-x-lg"></i>
          </button>
        `;
        return `
          <li class="file-item" data-id="${escapeHtml(att.id)}" data-type="${att.type}">
            ${left}
            ${chip('Staged','badge-stage')}
            <div class="d-flex align-items-center gap-1">${controls}</div>
          </li>
        `;
      }).join('');
    }

    filesList.addEventListener('click', (e)=>{
      const li = e.target.closest('.file-item'); if (!li) return;
      const id = li.getAttribute('data-id');
      const type = li.getAttribute('data-type');
      const item = getStagedView().find(x => x.id === id);
      if (!item) return;

      if (e.target.closest('[data-act="preview"]')) {
        if (type === 'link') {
          openPreviewModalWithMeta({ url: item.__stagedName, title: item.__stagedName, mime:'' });
          return;
        }
        if (type === 'file') {
          const file = staged.addFiles.find(f => `__staged_file_${f.__uid}` === id);
          if (!file) return showInfo('Preview','Cannot preview this staged file.');
          const url = URL.createObjectURL(file); currentPreviewRevoke = ()=>URL.revokeObjectURL(url);
          openPreviewModalWithMeta({ url, title:file.name, mime:file.type||'' });
          return;
        }
      }

      if (e.target.closest('[data-act="unstage"]')) {
        if (type === 'file') staged.addFiles = staged.addFiles.filter(f => `__staged_file_${f.__uid}` !== id);
        if (type === 'link') {
          const it = getStagedView().find(x => x.id === id);
          if (it?.__stagedName) staged.addLinks = staged.addLinks.filter(l => l.url !== it.__stagedName);
        }
        renderAttachments();
      }
    });

    function showStageBtn(show,label){
      stageFromPreviewBtn.classList.toggle('d-none', !show);
      if (label) stageFromPreviewBtn.innerHTML = `<i class="bi bi-cloud-plus me-1"></i> ${label}`;
    }
    document.getElementById('filePreviewModal').addEventListener('hidden.bs.modal', ()=>{
      if (typeof currentPreviewRevoke === 'function') { try { currentPreviewRevoke(); } catch {} }
      currentPreviewRevoke = null;
      previewStageCtx = null;
      showStageBtn(false);
    });

    function openPreviewModalWithMeta({url, title='File', mime=''}) {
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      setFileInfoUI(kindFrom({url,name:title,mime}), url);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), {url,name:title,mime});
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    // pre-stage preview actions
    btnPreviewSelectedFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType !== 'file') return;
      const files = fileInput.files;
      if (!files || !files.length) { showInfo('Nothing selected','Choose one or more files first.'); return; }
      const f = files[0];
      const blobUrl = URL.createObjectURL(f);
      currentPreviewRevoke = ()=>URL.revokeObjectURL(blobUrl);
      openPreviewModalWithMeta({ url: blobUrl, title: f.name, mime: f.type || '' });
    });
    btnStageFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType !== 'file') return;
      const files = fileInput.files;
      if (!files || !files.length) { showInfo('Nothing to Stage','Please choose one or more files.'); return; }
      const tooBig = Array.from(files).find(f => f.size > TEACHER_MAX_BYTES);
      if (tooBig) { showInfo('Too large', `${escapeHtml(tooBig.name)} exceeds ${TEACHER_MAX_MB} MB.`); return; }
      const tgt = Number(targetLessonSelect.value || 0);
      Array.from(files).forEach(f => { f.__uid = Math.random().toString(36).slice(2,10); f.__lesson = tgt; staged.addFiles.push(f); });
      fileInput.value = '';
      renderAttachments();
      showInfo('Staged','File(s) are staged and will be uploaded on Add Lessons.');
    });

    btnPreviewLink.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType !== 'text') return;
      const val = (linkInput.value || '').trim();
      if (!val) { showInfo('No link entered','Paste a URL first.'); return; }
      openPreviewModalWithMeta({ url: val, title: val, mime:'' });
    });
    btnStageLink.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType !== 'text') return;
      const val = (linkInput.value || '').trim();
      if (!val) { showInfo('No Link','Please paste a URL.'); return; }
      const tgt = Number(targetLessonSelect.value || 0);
      staged.addLinks.push({ url: val, lesson: tgt });
      linkInput.value = '';
      renderAttachments();
      showInfo('Staged','Link will be added on Add Lessons.');
    });

    /* ---------- Visibility ---------- */
    function syncStagingVisibility(){
      const t = moduleType;
      if (t === 'file') {
        stagingCard.style.display = '';
        fileSection.style.display = '';
        linkSection.style.display = 'none';
      } else if (t === 'text') {
        stagingCard.style.display = '';
        fileSection.style.display = 'none';
        linkSection.style.display = '';
      } else { // textonly
        stagingCard.style.display = 'none';
      }
    }

    /* ---------- Load module ---------- */
    function computeLessonCount(obj={}){
      const subs  = Array.isArray(obj.moduleSubTitles) ? obj.moduleSubTitles.length : 0;
      const descs = Array.isArray(obj.moduleSubDescs) ? obj.moduleSubDescs.length : 0;
      const lc    = Number.isFinite(obj.lessonCount) ? obj.lessonCount : 0;
      return Math.max(lc, subs, descs);
    }

    async function loadModule(){
      if (!moduleId) {
        showInfo('Missing moduleId', 'No <strong>moduleId</strong> in the URL.');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const mod = await res.json();

        const title = mod.title || 'Untitled Module';
        const type  = (mod.type || 'file').toLowerCase();
        moduleType = type;
        courseIdForBack = mod.courseId || '';
        currentSubTitles = Array.isArray(mod.moduleSubTitles) ? mod.moduleSubTitles.slice() : [];
        currentSubDescs  = Array.isArray(mod.moduleSubDescs) ? mod.moduleSubDescs.slice() : [];

        baseLessonIdx = computeLessonCount(mod);

        modTitleEl.textContent = title;
        modTypeEl.textContent = (type === 'file' ? 'Files per lesson' : type === 'text' ? 'Video URLs per lesson' : 'Text only');
        moduleTitleTag.textContent = `— ${title}`;
        currentCountEl.textContent = String(baseLessonIdx);

        if (courseIdForBack) backBtn.href = `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(courseIdForBack)}`;

        // start with one lesson page
        addLesson(false);
        renderPager();
      } catch (e) {
        console.error(e);
        showInfo('Load Failed', 'Could not load the module details. Please go back and try again.');
      }
    }

    /* ---------- Submit ---------- */
    submitBtn.addEventListener('click', async ()=>{
      formError.textContent = '';

      // Collect new lessons data
      const newTitles = [];
      const newDescs  = [];
      for (let i=0;i<pager.pages.length;i++){
        const p = pager.pages[i];
        const sub = (p.querySelector('.lesson-subtitle')?.value || '').trim();
        const con = (p.querySelector('.lesson-content')?.value  || '').trim();
        if (!sub && !con) {
          formError.textContent = `Lesson ${i+1}: Please enter a Sub Title or Content.`;
          return;
        }
        newTitles.push(sub);
        newDescs.push(con);
      }

      // Validate staged sizes for file mode
      if (moduleType === 'file') {
        const tooLarge = staged.addFiles.find(f => f.size > TEACHER_MAX_BYTES);
        if (tooLarge) { formError.textContent = `Each file must be ≤ ${TEACHER_MAX_MB} MB. Too large: ${tooLarge.name}`; return; }
      }

      // UI lock
      submitBtn.disabled = true;
      spinner.classList.remove('visually-hidden');
      submitText.textContent = 'Adding…';

      try {
        // Step 1: PATCH arrays (append all)
        const patchRes = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            moduleSubTitles: currentSubTitles.concat(newTitles),
            moduleSubDescs:  currentSubDescs.concat(newDescs)
          })
        });
        const patchJson = await safeJson(patchRes);
        if (!patchRes.ok || patchJson?.success === false) {
          throw new Error(patchJson?.message || `PATCH failed (HTTP ${patchRes.status})`);
        }

        // Step 2: Upload all staged files/links mapped to final indices
        if (moduleType === 'file' && staged.addFiles.length) {
          const fd = new FormData();
          staged.addFiles.forEach(f => fd.append('attachmentFiles', f));
          staged.addFiles.forEach(f => fd.append('attachmentLessonIdx', String(baseLessonIdx + (f.__lesson || 0))));
          staged.addFiles.forEach(_ => fd.append('attachmentDescs', ''));
          const addRes = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}/files`, { method:'POST', body:fd });
          const addJson = await safeJson(addRes);
          if (!addRes.ok || addJson?.success === false) {
            throw new Error(addJson?.message || `Upload files failed (HTTP ${addRes.status})`);
          }
        }
        if (moduleType === 'text' && staged.addLinks.length) {
          const allLinks = staged.addLinks.map(l => l.url);
          const allIdxs  = staged.addLinks.map(l => baseLessonIdx + (l.lesson || 0));
          const addRes = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}/files`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              links: allLinks,
              attachmentLessonIdx: allIdxs,
              videoDesc: allLinks.map(_ => '')
            })
          });
          const addJson = await safeJson(addRes);
          if (!addRes.ok || addJson?.success === false) {
            throw new Error(addJson?.message || `Add links failed (HTTP ${addRes.status})`);
          }
        }

        const addedCount = newTitles.length;
        showInfo('Success', `✅ <strong>${escapeHtml(modTitleEl.textContent)}</strong><br/>Added <strong>${addedCount}</strong> lesson${addedCount>1?'s':''} (starting at Lesson ${baseLessonIdx + 1}).`, {
          autoHideMs: 900,
          onHidden: () => {
            if (courseIdForBack) {
              window.location.href = `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(courseIdForBack)}`;
            } else {
              window.location.href = `/TEACHER/Modules/module_list.html`;
            }
          }
        });

      } catch (err) {
        console.error(err);
        formError.textContent = err?.message || 'Failed to add lessons.';
        submitBtn.disabled = false;
        spinner.classList.add('visually-hidden');
        submitText.textContent = 'Add Lessons';
        return;
      }
    });

    // Boot
    (async function(){
      await loadModule();
    })();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
