<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <title>EduConnect Teacher - Module Content</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link rel="stylesheet" href="list.css" />

  <style>
    :root {
      --color-primary: #4A1A0C;
      --color-secondary: #7A2810;
      --color-bg: #f8fafc;
      --color-border: #e0e7ef;
      --color-text: #374151;
      --radius-card: 1.5rem;
      --shadow-light: 0 1.5px 6px rgba(30, 34, 90, 0.07);
      --shadow-strong: 0 6px 32px rgba(30, 34, 90, 0.13);
    }

    body { background-color: var(--color-bg); color: var(--color-text); }

    .dashboard{ display:flex; min-height:100vh; }
    .main{ margin-left:70px; width:calc(100% - 70px); transition:margin-left .3s,width .3s; }
    .dashboard.sidebar-expanded .main{ margin-left:220px; width:calc(100% - 220px); }

    main.container { padding-top: 2rem; padding-bottom: 2rem; }

    .module-content-card {
      background: #fff;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-strong), var(--shadow-light);
      padding: 2rem;
      max-width: 2000px;
      border: 1px solid var(--color-border);
    }

    .profile-btn { display:flex; align-items:center; gap:8px; background:none; border:none; color:#fff; }
    .profile-btn .username { font-size: 14px; }
    #dashboardUsername{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:999px; font-weight:800; background:#fff; color:var(--color-primary);
    }

    .module-title { color: var(--color-secondary); font-weight:700; font-size:2rem; margin-bottom:1rem; text-align:center; }

    .nav-pills { overflow-x:auto; white-space:nowrap; margin-bottom:1.5rem; padding-bottom:.5rem; border-bottom:1px solid var(--color-border); }
    .nav-pills .nav-item { display:inline-block; margin-right:.5rem; }
    .nav-pills .nav-link { border-radius:.75rem; padding:.5rem 1rem; font-weight:500; }
    .nav-pills .nav-link.active { background-color: var(--color-primary) !important; color:#fff; }

    .module-subtitle { color: var(--color-primary) !important; font-weight:600; font-size:1.3rem; margin-bottom:.5rem; }
    .module-desc, .main-desc { font-size:1rem; line-height:1.5; margin-bottom:1rem; }
    .main-desc { border-top:1px solid var(--color-border); padding-top:1.5rem; margin-top:2rem; }

    .attachment-item { background:#e3eafc; border-radius:.75rem; padding:1rem; margin-bottom:1rem; }
    .attachment-actions { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .attachment-item .small { font-size:.85rem; color:#6b7280; margin-top:.25rem; }

    /* ==== Full-screen-ish preview modal (matches your example) ==== */
    #filePreviewModal .modal-dialog { max-width: 96vw; }
    #filePreviewModal .modal-content {
      height: 92vh;
      display: flex;
      flex-direction: column;
    }
    #filePreviewModal .modal-body {
      flex: 1 1 auto;
      padding: 0;
      background: #f8fafc;
      position: relative;
    }
    .preview-wrap {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .preview-wrap iframe,
    .preview-wrap embed,
    .preview-wrap object,
    .preview-wrap img,
    .preview-wrap video,
    .preview-wrap audio {
      width: 100%;
      height: 100%;
      border: 0;
      object-fit: contain;
      background: #fff;
    }
    .preview-fallback {
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem;
      text-align: center;
    }
    #filePreviewFooter {
      display: flex;
      gap: .5rem;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .spinner-wrap {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff;
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/components/sidebar.html")
          .then(res => res.text())
          .then(html => { document.getElementById("sidebar-container").innerHTML = html; })
          .catch(()=>{});
      });
    </script>

    <!-- Main -->
    <div class="main">
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input id="searchBox" type="text" placeholder="Search my module..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn" type="button" title="Profile">
          <i class="fas fa-user-circle fa-2x" aria-hidden="true"></i>
          <span id="dashboardUsername" class="username ms-2 fw-semibold" aria-label="Profile"></span>
        </button>
      </header>

      <main class="container">
        <div id="moduleContent" class="module-content-card text-center text-muted">
          Loading module...
        </div>
      </main>
    </div>
  </div>

  <!-- Preview Modal (matches your provided structure) -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>

        <div class="modal-footer" id="filePreviewFooter">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto">
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-amber">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ========= CONFIG =========
    const API_BASE = "http://localhost:5000";
    const FILE_BASE = "http://127.0.0.1:5000";

    // ========= Auth header initials =========
    function initHeaderInitialsAndGuard() {
      try{
        const raw = localStorage.getItem("user") || "{}";
        const obj = JSON.parse(raw);
        const u = obj.user || obj;
        if (!u?.userId || !u?.isTeacher) { window.location.replace("/TEACHER/login/login.html"); return null; }

        const el = document.getElementById("dashboardUsername");
        if (el) {
          const fn=(u.firstName||"").trim(), ln=(u.lastName||"").trim();
          const initials = (fn && ln) ? (fn[0]+ln[0]).toUpperCase() : (u.email||"U")[0].toUpperCase();
          el.textContent = initials;
          el.setAttribute("title", [u.firstName,u.lastName].filter(Boolean).join(" ").trim() || u.username || u.email || "Profile");
        }
        return u;
      }catch(e){
        console.error(e);
        window.location.replace("/TEACHER/login/login.html");
        return null;
      }
    }

    // ========= Helpers: file kinds, YouTube detection =========
    function isYouTubeUrl(url = '') {
      try {
        const u = new URL(url);
        const h = u.hostname.replace(/^www\./, '').toLowerCase();
        return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);
      } catch { return false; }
    }
    function toYouTubeEmbed(url=''){
      try{
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./,'').toLowerCase();
        let id = '';
        let start = u.searchParams.get('start') || u.searchParams.get('t') || '';
        if (start && /^\d+s$/.test(start)) start = parseInt(start,10);
        if (start && /^\d+$/.test(start)) start = parseInt(start,10);
        if (!Number.isFinite(start)) start = '';
        if (host === 'youtu.be'){
          id = (u.pathname || '').replace(/^\//,'').split('/')[0];
        } else {
          if (u.pathname.startsWith('/embed/')) id = u.pathname.split('/')[2] || '';
          if (!id) id = u.searchParams.get('v') || '';
        }
        if (!id) return null;
        const base = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;
        const qs = new URLSearchParams(); qs.set('rel','0'); if (start) qs.set('start', String(start));
        return `${base}?${qs.toString()}`;
      }catch{ return null; }
    }
    function getExtFromUrl(url=''){
      const clean = String(url).split('?')[0].split('#')[0];
      const parts = clean.split('.'); return parts.length>1 ? parts.pop().toLowerCase() : '';
    }
    function kindFromUrl(url){
      if (isYouTubeUrl(url)) return 'youtube';
      const ext = getExtFromUrl(url);
      if (['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
      if (['mp3','wav','ogg','m4a','aac','flac'].includes(ext)) return 'audio';
      if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
      if (ext==='pdf') return 'pdf';
      if (['txt','csv','log'].includes(ext)) return 'text';
      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
      return 'other';
    }

    function setFileInfoUI(kind, url) {
      const info = document.getElementById('fileInfoText');
      const hdr  = document.getElementById('filePreviewModalLabel');
      const badgeId = 'fileKindBadge';

      const labelMap = {
        youtube:'YouTube', video:'Video', audio:'Audio', image:'Image',
        pdf:'PDF', text:'Text/CSV', office:'Office Doc', other:'File'
      };
      const colorMap = {
        youtube:'bg-danger-subtle text-danger', video:'bg-danger-subtle text-danger',
        audio:'bg-secondary-subtle text-secondary', image:'bg-success-subtle text-success',
        pdf:'bg-primary-subtle text-primary', text:'bg-info-subtle text-info',
        office:'bg-warning-subtle text-warning', other:'bg-dark-subtle text-dark'
      };

      let badge = document.getElementById(badgeId);
      if (!badge){
        badge = document.createElement('span');
        badge.id = badgeId;
        badge.className = 'ms-2 badge rounded-pill';
        hdr.appendChild(badge);
      }
      badge.className = 'ms-2 badge rounded-pill ' + (colorMap[kind] || colorMap.other);
      badge.textContent = labelMap[kind] || 'File';

      info.innerHTML = `<span class="text-muted">Type:</span> <strong>${labelMap[kind] || 'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href = url || '#';
    }

    function showSpinner(show) {
      document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none';
    }

    // Render into the big modal
    function renderFilePreviewInto(container, url) {
      container.innerHTML = '';
      showSpinner(true);

      const done = () => showSpinner(false);
      const kind = kindFromUrl(url);

      // YouTube embed
      if (kind === 'youtube') {
        const embed = toYouTubeEmbed(url);
        if (embed) {
          container.innerHTML = `
            <div class="ratio ratio-16x9">
              <iframe
                src="${embed}"
                title="YouTube video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
                style="border:0"></iframe>
            </div>
          `;
          done();
          return;
        }
        container.innerHTML = `
          <div class="preview-fallback">
            <div class="text-muted mb-2">Couldn’t embed this YouTube link.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        `;
        done();
        return;
      }

      const ext = getExtFromUrl(url);

      if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) {
        const img = new Image();
        img.onload = done;
        img.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Image preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a></div>`;
          done();
        };
        img.src = url;
        container.appendChild(img);
        return;
      }

      if (ext === 'pdf') {
        const iframe = document.createElement('iframe');
        iframe.title = 'PDF preview';
        iframe.onload = done;
        iframe.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">PDF preview failed (viewer blocked or CORS).</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a></div>`;
          done();
        };
        iframe.src = url;
        container.appendChild(iframe);
        return;
      }

      if (['mp4','webm','ogg'].includes(ext)) {
        const video = document.createElement('video');
        video.controls = true;
        video.onloadeddata = done;
        video.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Video preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a></div>`;
          done();
        };
        video.src = url;
        container.appendChild(video);
        return;
      }

      if (['mp3','wav','m4a','ogg'].includes(ext)) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.onloadeddata = done;
        audio.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Audio preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a></div>`;
          done();
        };
        audio.src = url;
        container.appendChild(audio);
        return;
      }

      if (['txt','csv','log'].includes(ext)) {
        const iframe = document.createElement('iframe');
        iframe.onload = done;
        iframe.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Text preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a></div>`;
          done();
        };
        iframe.src = url;
        container.appendChild(iframe);
        return;
      }

      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) {
        const gview = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;
        const iframe = document.createElement('iframe');
        iframe.title = 'Document preview';
        iframe.onload = done;
        iframe.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Office preview failed (Google Viewer blocked or CORS).</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a></div>`;
          done();
        };
        iframe.src = gview;
        container.appendChild(iframe);
        return;
      }

      // Last-resort object
      const obj = document.createElement('object');
      obj.data = url;
      obj.type = 'application/octet-stream';
      obj.onload = done;
      obj.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">This file type cannot be previewed here.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a></div>`;
        done();
      };
      container.appendChild(obj);
      setTimeout(() => { if (!obj.contentDocument) { /* heuristic */ } done(); }, 1200);
    }

    // ========= Page logic =========
    document.addEventListener("DOMContentLoaded", async () => {
      const user = initHeaderInitialsAndGuard();
      if (!user) return;

      const params = new URLSearchParams(location.search);
      const moduleId = params.get("moduleId");
      const subIdx = parseInt(params.get("subIdx"), 10) || 0;
      const container = document.getElementById("moduleContent");

      if (!moduleId) {
        container.innerHTML = '<div class="text-danger">No module selected.</div>';
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}`);
        const mod = await res.json();
        if (!mod || !mod.title) throw new Error("Module not found");

        let html = `<div class="module-title">${(mod.title||'')}</div><ul class="nav nav-pills" role="tablist">`;
        (mod.moduleSubTitles||[]).forEach((sub, i) => {
          html += `<li class="nav-item" role="presentation">
            <button class="nav-link${i===subIdx?' active':''}" id="tab-${i}" data-bs-toggle="pill" data-bs-target="#lesson-${i}" type="button" role="tab" aria-controls="lesson-${i}" aria-selected="${i===subIdx}">
              ${sub || "(No Title)"}
            </button></li>`;
        });
        html += `</ul><div class="tab-content">`;

        (mod.moduleSubTitles||[]).forEach((sub, i) => {
          const lessonAttachments = Array.isArray(mod.attachments) ? mod.attachments.filter(a => a.lessonIdx === i) : [];
          html += `
            <div class="tab-pane fade${i===subIdx?' show active':''}" id="lesson-${i}" role="tabpanel" aria-labelledby="tab-${i}">
              <h6 class="module-subtitle">${sub || "(No Title)"}</h6>
              <p class="module-desc">${
                (mod.moduleSubDescs && mod.moduleSubDescs[i])
                  ? String(mod.moduleSubDescs[i]).replace(/\n/g, "<br>")
                  : "<span class='text-muted'>(No Description)</span>"
              }</p>
              ${lessonAttachments.map((att, idx) => {
                const fileLabel = `File ${idx+1}`;
                const desc = att.videoDesc || att.description || "(no description)";
                const fname = (att.originalName || att.name || mod.title || "File").replace(/"/g, "&quot;");
                const url = att.url || (att.filePath ? (FILE_BASE + att.filePath) : '');
                const kind = url ? kindFromUrl(url) : 'other';
                const icon = kind==='youtube' ? '▶️' : (kind==='video' ? '🎬' : (att.url ? '🔗' : '📄'));
                const label = kind==='youtube' ? 'YouTube' : (kind==='video' ? 'Video' : (att.url ? 'Link' : 'File'));
                return `
                  <div class="attachment-item">
                    <div class="fw-bold mb-1">${icon} ${label} — ${fileLabel}</div>
                    <div class="attachment-actions">
                      <button class="btn btn-amber btn-sm file-preview-btn"
                              data-file-url="${(url||'').replace(/"/g,'&quot;')}"
                              data-file-name="${fname}">
                        <i class="bi bi-eye me-1"></i> Preview
                      </button>

                    </div>
                    <div class="small">${desc}</div>
                  </div>`;
              }).join('')}
            </div>`;
        });

        if (mod.description) {
          html += `
            <div class="main-desc">
              <strong class="text-primary">Main Description</strong>
              <p>${String(mod.description).replace(/\n/g,'<br>')}</p>
            </div>`;
        }

        html += `</div>`;
        container.classList.remove("text-center","text-muted");
        container.innerHTML = html;

        // Update URL when tab changes
        container.querySelectorAll('[data-bs-toggle="pill"]').forEach(btn=>{
          btn.addEventListener('shown.bs.tab', e=>{
            const idx = e.target.id.split('-')[1];
            history.replaceState(null, '', `?moduleId=${encodeURIComponent(moduleId)}&subIdx=${idx}`);
          });
        });

        // Delegated actions: preview (modal)
        container.addEventListener('click', (ev) => {
          const btn = ev.target.closest('.file-preview-btn');
          if (!btn) return;
          const fileUrl = btn.dataset.fileUrl || '';
          const fileName = btn.dataset.fileName || 'File';

          // header title + badge + footer link
          document.getElementById("filePreviewModalLabel").textContent = `${fileName} – Preview`;
          setFileInfoUI(kindFromUrl(fileUrl), fileUrl);

          // render content
          const content = document.getElementById("filePreviewContent");
          renderFilePreviewInto(content, fileUrl);

          // show modal
          new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
        });

      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="text-danger">Failed to load module content.</div>';
      }
    });

    // Sidebar hover expand
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");

          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(()=>{});
    });

    function logoutUser(){
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }
  </script>
</body>
</html>
