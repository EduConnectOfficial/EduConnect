<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>EduConnect Teacher – Module Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Optional: re-use your teacher theme -->
  <link rel="stylesheet" href="module_view.css" />

  <style>

  </style>
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" id="lessonSearch" placeholder="Search lessons in this module..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn" type="button">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <!-- Top meta strip (matches screenshot) -->
        <div class="ui-card card-themed mb-3 mt-3" id="moduleMeta" style="display:none;">
          <div class="ui-card-head">
            <h2 class="ui-card-title">
              <i class="bi bi-journal-text"></i>
              <span id="metaTitle">edit</span>
            </h2>

            <div class="d-flex align-items-center gap-2">
              <div class="text-name" id="metaCourse">Course: —</div>
              <a id="backToCourseBtn" class="btn btn-sm btn-amber-outline" href="#">
                <i class="bi bi-arrow-left"></i> Back to Modules
              </a>
            </div>
          </div>

          <div class="p-2 px-3 small">Lessons: <span id="metaLessons">0</span></div>
        </div>

        <div class="row g-3">
          <!-- Left: lessons list -->
          <div class="col-12 col-lg-4">
            <div class="card shadow border-0 rounded-4 viewer-card p-3">
              <h5 class="mb-2">Lessons</h5>
              <div id="lessonList" class="d-grid gap-2"></div>
            </div>
          </div>

          <!-- Right: lesson viewer -->
          <div class="col-12 col-lg-8">
            <div class="card shadow border-0 rounded-4 viewer-card p-3">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <span class="badge bg-primary me-2" id="moduleNumberBadge">Module #—</span>
                  <span class="badge lesson-pill" id="lessonIndexBadge">Lesson —</span>
                </div>
                <div class="lesson-nav">
                  <button id="prevLesson" class="btn btn-sm btn-amber-outline"><i class="bi bi-arrow-left"></i>
                    Prev</button>
                  <button id="nextLesson" class="btn btn-sm btn-amber-outline">Next <i
                      class="bi bi-arrow-right"></i></button>
                </div>
              </div>

              <h3 class="mt-3" id="lessonTitle">(No Title)</h3>
              <div class="safe-pre text-secondary" id="lessonBody">(No Content)</div>

              <hr class="my-3" />
              <h6 class="mb-2">Attachments</h6>
              <div id="attachments"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal (YouTube style) -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background:#5e2211; color:#ffd9be;">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">Open file – Preview</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center text-white">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>

        <div class="modal-footer" id="filePreviewFooter">
          <div class="small" id="fileInfoText">Type: <span id="fileTypeText">File</span></div>
          <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-amber">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(() => { });
    });
  </script>

  <!-- Page Logic -->
  <script>
    const API_BASE = 'http://localhost:5000';

    // Guard + initials for teacher header
    (function setUserHeader() {
      try {
        const raw = localStorage.getItem("user") || "{}";
        const uObj = JSON.parse(raw);
        const u = uObj.user || uObj;
        if (!u?.userId || !u?.isTeacher) {
          window.location.replace("/TEACHER/login/login.html");
          return;
        }
        const initials = (function (us) {
          const fn = (us.firstName || '').trim(), ln = (us.lastName || '').trim();
          if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
          const em = (us.email || '').trim(); return em ? em[0].toUpperCase() : 'U';
        })(u);
        const el = document.getElementById("Username");
        el.textContent = initials;
        const full = [u.firstName, u.lastName].filter(Boolean).join(' ').trim() || u.username || u.email || 'Teacher';
        el.title = full; el.setAttribute('aria-label', full);
      } catch { window.location.replace("/TEACHER/login/login.html"); }
    })();

    // Helpers
    function escapeHTML(str = '') {
      return String(str)
        .replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;').replaceAll("'", '&#039;');
    }
    function isYouTube(url = '') {
      try {
        const u = new URL(url);
        const h = u.hostname.replace(/^www\./, '').toLowerCase();
        return ['youtu.be', 'youtube.com', 'm.youtube.com', 'music.youtube.com', 'youtube-nocookie.com'].includes(h);
      } catch { return false; }
    }
    function ytEmbed(url = '') {
      try {
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./, '').toLowerCase();
        let id = '';
        let start = u.searchParams.get('start') || u.searchParams.get('t') || '';
        if (start && /^\d+s$/.test(start)) start = parseInt(start, 10);
        if (start && /^\d+$/.test(start)) start = parseInt(start, 10);
        if (!Number.isFinite(start)) start = '';
        if (host === 'youtu.be') id = u.pathname.replace(/^\//, '').split('/')[0];
        else {
          if (u.pathname.startsWith('/embed/')) id = u.pathname.split('/')[2] || '';
          if (!id) id = u.searchParams.get('v') || '';
        }
        if (!id) return null;
        const base = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;
        const qs = new URLSearchParams(); qs.set('rel', '0'); if (start) qs.set('start', String(start));
        return `${base}?${qs.toString()}`;
      } catch { return null; }
    }
    function extFromUrl(u = '') { const c = String(u).split('?')[0].split('#')[0]; const p = c.split('.'); return p.length > 1 ? p.pop().toLowerCase() : ''; }
    function kindFromUrl(url = '') {
      if (isYouTube(url)) return 'youtube';
      const ext = extFromUrl(url);
      if (['mp4', 'webm', 'ogg', 'ogv', 'mov'].includes(ext)) return 'video';
      if (['mp3', 'wav', 'm4a', 'ogg', 'aac', 'flac'].includes(ext)) return 'audio';
      if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) return 'image';
      if (ext === 'pdf') return 'pdf';
      if (['txt', 'csv', 'log'].includes(ext)) return 'text';
      if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(ext)) return 'office';
      return 'other';
    }

    // Preview modal rendering
    function setFileInfoUI(kind, url) {
      const map = { youtube: 'YouTube', video: 'Video', audio: 'Audio', image: 'Image', pdf: 'PDF', text: 'Text', office: 'Office Doc', other: 'Link' };
      document.getElementById('fileTypeText').textContent = map[kind] || 'Link';
      document.getElementById('openInNewTabBtn').href = url || '#';
    }
    function showSpinner(show) { document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }

    function renderFilePreviewInto(container, url) {
      container.innerHTML = ''; showSpinner(true);
      const done = () => showSpinner(false);
      const kind = kindFromUrl(url);

      if (kind === 'youtube') {
        const embed = ytEmbed(url);
        if (embed) {
          container.innerHTML = `
            <div class="ratio ratio-16x9">
              <iframe
                src="${embed}"
                title="YouTube video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
                style="border:0"></iframe>
            </div>`;
          return done();
        }
      }

      if (kind === 'image') {
        const img = new Image();
        img.onload = done; img.onerror = done; img.src = url; container.appendChild(img); return;
      }
      if (kind === 'pdf') {
        const iframe = document.createElement('iframe'); iframe.onload = done; iframe.onerror = done; iframe.src = url; container.appendChild(iframe); return;
      }
      if (kind === 'video') {
        const v = document.createElement('video'); v.controls = true; v.onloadeddata = done; v.onerror = done; v.src = url; container.appendChild(v); return;
      }
      if (kind === 'audio') {
        const a = document.createElement('audio'); a.controls = true; a.onloadeddata = done; a.onerror = done; a.src = url; container.appendChild(a); return;
      }
      if (kind === 'text') {
        const i = document.createElement('iframe'); i.onload = done; i.onerror = done; i.src = url; container.appendChild(i); return;
      }
      if (kind === 'office') {
        const gview = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;
        const i = document.createElement('iframe'); i.onload = done; i.onerror = done; i.src = gview; container.appendChild(i); return;
      }

      // Fallback
      const obj = document.createElement('object'); obj.data = url; obj.type = 'application/octet-stream'; obj.onload = done; obj.onerror = done; container.appendChild(obj);
      setTimeout(done, 1000);
    }

    // Page state
    const params = new URLSearchParams(window.location.search);
    const moduleId = params.get('moduleId');
    const startIdx = parseInt(params.get('subIdx') || '0', 10) || 0;
    let moduleDoc = null, currentIdx = 0, lessonCount = 0, courseId = null;

    // Fetch + render
    async function fetchModule() {
      if (!moduleId) {
        alert('No moduleId provided.');
        window.location.href = '/TEACHER/Modules/module_list.html';
        return;
      }

      const res = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}?t=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load module');
      moduleDoc = await res.json();
      courseId = moduleDoc.courseId || null;

      // Header meta
      document.getElementById('metaTitle').textContent = moduleDoc.title || 'edit';
      document.getElementById('moduleNumberBadge').textContent = `Module #${moduleDoc.moduleNumber || ''}`;

      // Back button target
      const back = document.getElementById('backToCourseBtn');
      if (courseId) back.href = `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(courseId)}`;
      else {
        back.addEventListener('click', (e) => {
          e.preventDefault();
          if (document.referrer) history.back();
          else location.href = '/TEACHER/Modules/module_list.html';
        });
      }

      // Course label
      try {
        if (courseId) {
          const cr = await fetch(`${API_BASE}/courses/${encodeURIComponent(courseId)}`);
          if (cr.ok) {
            const c = await cr.json();
            document.getElementById('metaCourse').textContent = `Course: ${c.title || '—'}`;
          }
        }
      } catch { }

      // Lesson arrays
      const subs = Array.isArray(moduleDoc.moduleSubTitles) ? moduleDoc.moduleSubTitles : [];
      const descs = Array.isArray(moduleDoc.moduleSubDescs) ? moduleDoc.moduleSubDescs : [];
      lessonCount = Math.max(moduleDoc.lessonCount || 0, subs.length, descs.length);
      document.getElementById('metaLessons').textContent = String(lessonCount);
      document.getElementById('moduleMeta').style.display = '';

      // Build list
      const list = document.getElementById('lessonList');
      list.innerHTML = '';
      for (let i = 0; i < lessonCount; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn btn-sm lesson-pill text-start ${i === startIdx ? 'active' : ''}`;
        btn.textContent = `${i + 1}. ${subs[i] || '(No Title)'}`;
        btn.addEventListener('click', () => showLesson(i));
        list.appendChild(btn);
      }

      showLesson(startIdx < lessonCount ? startIdx : 0);
    }

    function bestFileUrl(att) {
      if (att.previewUrl) return att.previewUrl;
      if (att.url) return att.url;
      if (att.publicUrl) return att.publicUrl;
      if (att.filePath) return `http://127.0.0.1:5000${att.filePath}`;
      return '';
    }

    function showLesson(idx) {
      currentIdx = Math.max(0, Math.min(idx, lessonCount - 1));
      document.querySelectorAll('#lessonList .lesson-pill').forEach((el, i) => {
        el.classList.toggle('active', i === currentIdx);
      });
      document.getElementById('lessonIndexBadge').textContent = `Lesson ${currentIdx + 1}`;

      const subs = moduleDoc.moduleSubTitles || [];
      const descs = moduleDoc.moduleSubDescs || [];
      const title = subs[currentIdx] || '(No Title)';
      const body = descs[currentIdx] || '(No Content)';
      document.getElementById('lessonTitle').textContent = title;
      document.getElementById('lessonBody').textContent = body;

      const wrap = document.getElementById('attachments');
      wrap.innerHTML = '';

      const atts = Array.isArray(moduleDoc.attachments)
        ? moduleDoc.attachments.filter(a => (a.lessonIdx ?? 0) === currentIdx)
        : [];

      if (!atts.length) {
        wrap.innerHTML = `<div class="text-muted">No attachments for this lesson.</div>`;
      } else {
        atts.forEach(att => {
          const item = document.createElement('div');
          item.className = 'attachment-item';

          const label = att.originalName || att.description || att.videoDesc || att.url || 'Open file';
          const url = bestFileUrl(att);

          // YouTube or external link
          if (att.url && isYouTube(att.url)) {
            item.innerHTML = `
              <span class="badge attachment-badge me-2">Video</span>
              <div class="ratio ratio-16x9 mt-1">
                <iframe class="video-embed" src="${ytEmbed(att.url) || att.url}" allowfullscreen></iframe>
              </div>
              ${(att.videoDesc ? `<div class="small text-muted mt-1">${escapeHTML(att.videoDesc)}</div>` : '')}
              <div class="mt-2">
                <button class="btn btn-sm btn-amber" type="button" data-open="${att.url}">
                  <i class="bi bi-eye me-1"></i> Preview
                </button>
              </div>
            `;
          } else {
            // File or generic link -> open in modal
            item.innerHTML = `
              <span class="badge attachment-badge me-2">File</span>
              <button class="btn btn-link p-0 text-decoration-none" type="button" data-open="${url}">
                ${escapeHTML(label)}
              </button>
              ${(att.description ? `<div class="small text-muted mt-1">${escapeHTML(att.description)}</div>` : '')}
            `;
          }

          // hook up preview
          item.querySelectorAll('[data-open]').forEach(btn => {
            btn.addEventListener('click', () => {
              const openUrl = btn.getAttribute('data-open');
              openPreview(openUrl, label);
            });
          });

          wrap.appendChild(item);
        });
      }

      document.getElementById('prevLesson').disabled = currentIdx <= 0;
      document.getElementById('nextLesson').disabled = currentIdx >= lessonCount - 1;
    }

    function openPreview(url, title = 'File') {
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      setFileInfoUI(kindFromUrl(url), url);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), url);
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    // Controls
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('prevLesson').addEventListener('click', () => showLesson(currentIdx - 1));
      document.getElementById('nextLesson').addEventListener('click', () => showLesson(currentIdx + 1));

      const searchTop = document.getElementById('lessonSearch');
      searchTop.addEventListener('input', () => {
        const q = searchTop.value.trim().toLowerCase();
        const subs = moduleDoc?.moduleSubTitles || [];
        const idx = subs.findIndex(s => (s || '').toLowerCase().includes(q));
        if (q && idx >= 0) showLesson(idx);
      });

      try { await fetchModule(); }
      catch (e) {
        console.error(e);
        alert('Failed to load module.');
        window.location.href = '/TEACHER/Modules/module_list.html';
      }
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>