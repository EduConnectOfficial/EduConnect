<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduConnect Teacher - Module Management</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- (Optional) your page-specific css -->
  <link rel="stylesheet" href="../modules/select_Course.css" />

</head>

<body>
  <div class="dashboard">
    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Sidebar + Dropdown Logic -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/components/sidebar.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;

            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");

            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }

            document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
              toggle.addEventListener('click', e => {
                e.preventDefault();
                const parent = toggle.closest('.has-submenu');
                parent.classList.toggle('open');
                const expanded = toggle.getAttribute('aria-expanded') === 'true';
                toggle.setAttribute('aria-expanded', String(!expanded));
              });
            });
          })
          .catch(err => console.error("Failed to load sidebar:", err));
      });
    </script>

    <!-- Main Content -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input id="searchBox" type="text" placeholder="Search my modules..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="dashboardUsername" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Course List Section -->
      <section class="content">
        <h2 class="page-title">Module Management — Uploaded Courses</h2>
        <div id="courseList" class="row g-4"></div>
      </section>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API = 'http://127.0.0.1:5000'; // keep as you had

    // auth
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    if (!userData || !userData.username) {
      window.location.href = "/TEACHER/login/login.html";
    } else {
      document.getElementById("dashboardUsername").textContent = userData.username;
    }

    // helpers
    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    async function safeJson(res){
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if (ct.includes('application/json')) { try { return await res.json(); } catch {} }
      const txt = await res.text().catch(()=>'');
      throw new Error(`Expected JSON, got ${ct || 'unknown'}: ${txt.slice(0,200)}`);
    }

    let allCourses = [];

    async function loadCourses() {
      const courseList = document.getElementById("courseList");
      courseList.innerHTML = `<div class="col-12"><div class="text-muted">Loading…</div></div>`;

      try {
        if (!userData?.userId) {
          courseList.innerHTML = `<div class="col-12 text-danger">Missing user ID. Please re-login.</div>`;
          return;
        }

        // fetch only courses uploaded by this teacher
        const res = await fetch(`${API}/courses?uploadedBy=${encodeURIComponent(userData.userId)}`);
        const payload = await safeJson(res);

        const courses = Array.isArray(payload) ? payload : (payload.courses || []);
        allCourses = courses.slice();
        renderCourses(allCourses);
      } catch (err) {
        console.error("Failed to load courses:", err);
        courseList.innerHTML = `<div class="col-12 text-danger">Error loading courses.</div>`;
      }
    }

    function renderCourses(courses) {
      const courseList = document.getElementById("courseList");
      courseList.innerHTML = "";

      if (!Array.isArray(courses) || courses.length === 0) {
        courseList.innerHTML = `<div class="col-12 text-muted">No courses available.</div>`;
        return;
      }

      // sort by courseNumber asc if available
      courses.sort((a, b) => (a.courseNumber || 0) - (b.courseNumber || 0));

      courses.forEach(course => {
        const col = document.createElement("div");
        col.className = "col-md-6 col-lg-4";

        const title = escapeHtml(course.title);
        const category = escapeHtml(course.category);
        const description = escapeHtml(course.description || "No description provided.");
        const courseNum = course.courseNumber ?? '—';
        const id = course.id;

        col.innerHTML = `
          <article class="course-card h-100">
            <div>
              <h5 class="course-title">${title}</h5>
              <div class="mb-2"><span class="badge-soft"><i class="bi bi-hash"></i> Course #${courseNum}</span></div>
              <p class="course-meta mb-1"><strong>Category:</strong> ${category || '—'}</p>
              <p class="mb-0">${description}</p>
            </div>

            <div class="mt-3 d-flex justify-content-end gap-2 course-actions">
              <a href="/TEACHER/Modules/upload_module.html?courseId=${encodeURIComponent(id)}" class="btn btn-amber btn-sm">
                <i class="bi bi-upload me-1"></i> Upload Module
              </a>
              <a href="/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(id)}" class="btn btn-amber-outline btn-sm">
                <i class="bi bi-journal-text me-1"></i> View Modules
              </a>
            </div>
          </article>
        `;
        courseList.appendChild(col);
      });
    }

    // live search
    document.getElementById('searchBox').addEventListener('input', (e) => {
      const q = e.target.value.trim().toLowerCase();
      const filtered = !q ? allCourses : allCourses.filter(c =>
        (c.title || '').toLowerCase().includes(q) ||
        (c.category || '').toLowerCase().includes(q) ||
        String(c.courseNumber || '').toLowerCase().includes(q)
      );
      renderCourses(filtered);
    });

    loadCourses();

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }
  </script>
</body>
</html>
