<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduConnect Teacher - Module Management</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- (Optional) your page-specific css -->
  <link rel="stylesheet" href="../modules/select_Course.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Sidebar loader -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/components/sidebar.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;
            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");
            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }
            document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
              toggle.addEventListener('click', e => {
                e.preventDefault();
                const parent = toggle.closest('.has-submenu');
                parent.classList.toggle('open');
                const expanded = toggle.getAttribute('aria-expanded') === 'true';
                toggle.setAttribute('aria-expanded', String(!expanded));
              });
            });
          })
          .catch(err => console.error("Failed to load sidebar:", err));
      });
    </script>

    <!-- Main Content -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input id="searchBox" type="text" placeholder="Search my courses..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn" type="button">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="dashboardUsername" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Course List Section -->
      <section class="content">
        <h1 class="page-title">Module Management â€” Select a Course</h1>

        <!-- ui-card controls -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-collection"></i> Your Courses</h2>
            <div class="ui-subtext">Everything shows up right away. Use filters if you need to narrow it down.</div>
          </div>

          <div class="row g-2 align-items-end">
            <!-- Sort -->
            <div class="col-12 col-md-4 col-xl-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort courses">
                <option value="num_asc" selected>Course # (1 â†’ 999)</option>
                <option value="num_desc">Course # (999 â†’ 1)</option>
                <option value="az">Title A â†’ Z</option>
                <option value="new">Newest first</option>
              </select>
            </div>

            <!-- Active / Archived / All -->
            <div class="col-12 col-md-6 col-xl-5">
              <label class="form-label">Show</label>
              <div class="segmented" role="tablist" aria-label="Course visibility">
                <button id="btnActive" class="seg-btn is-active" role="tab" aria-selected="true">Active</button>
                <button id="btnArchived" class="seg-btn is-archived" role="tab" aria-selected="false">Archived</button>
                <button id="btnAll" class="seg-btn is-all" role="tab" aria-selected="false">All</button>
              </div>
            </div>

            <div class="col-12 col-xl-4 d-flex justify-content-xl-end">
              <a class="btn btn-amber w-100 w-xl-auto mt-2 mt-xl-0" href="/TEACHER/courses/course.html">
                <i class="bi bi-plus-lg me-1"></i> Add Course
              </a>
            </div>
          </div>
        </div>

        <!-- ALWAYS-VISIBLE count pills (active & archived + total results) -->
        <div class="pill-row">
          <span id="activeCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-check-circle me-1"></i><span id="activeCount">0</span> Active
          </span>
          <span id="archivedCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-archive me-1"></i><span id="archivedCount">0</span> Archived
          </span>
        </div>

        <div id="courseList" class="row g-4"></div>
      </section>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = 'http://127.0.0.1:5000';

    // ---- Auth guard + header initials (robust, initials-only) ----
    const userData = (() => {
      try {
        const raw = localStorage.getItem("user") || "{}";
        const stored = JSON.parse(raw);
        const u = stored.user || stored;
        // Gate: must be a teacher with an id
        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return null; // stop further usage
        }
        // Set header initials
        const el = document.getElementById("dashboardUsername");
        if (el) {
          const initials = getInitials(u);
          el.textContent = initials; // ðŸ‘ˆ initials only
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username || u.email || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        }
        return u;
      } catch (e) {
        console.error('auth/initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
        return null;
      }

      function getInitials(u) {
        const fn = (u.firstName || '').trim();
        const ln = (u.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          const parts = nameish
            .replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
            .split(/[\s._-]+/)
            .filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }
        const em = (u.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();

    // helpers
    function escapeHtml(s) { return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
    async function safeJson(res) {
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) { try { return await res.json(); } catch { } }
      const txt = await res.text().catch(() => '');
      throw new Error(`Expected JSON, got ${ct || 'unknown'}: ${txt.slice(0, 200)}`);
    }
    function tsToMs(ts) {
      if (!ts) return null;
      const s = ts._seconds ?? ts.seconds; const ns = ts._nanoseconds ?? ts.nanoseconds ?? 0;
      if (typeof s === 'number') return s * 1000 + Math.floor(ns / 1e6);
      if (typeof ts === 'number') return ts;
      const d = new Date(ts); return isNaN(d) ? null : d.getTime();
    }

    // State
    let allCourses = [];
    let currentSort = 'num_asc';  // num_asc | num_desc | az | new
    let archiveFilter = 'active'; // active | archived | all

    // ALWAYS-visible pills: count active vs archived from full snapshot
    async function refreshCoursePills() {
      try {
        if (!userData?.userId) return;
        const url = `${API}/courses?uploadedBy=${encodeURIComponent(userData.userId)}&includeArchived=true`;
        const r = await fetch(url);
        const payload = await r.json();
        const courses = Array.isArray(payload) ? payload : (payload.courses || []);
        const activeCount = courses.filter(c => !c.archived).length;
        const archivedCount = courses.filter(c => c.archived).length;
        const activeEl = document.getElementById('activeCount');
        const archEl = document.getElementById('archivedCount');
        if (activeEl) activeEl.textContent = String(activeCount);
        if (archEl) archEl.textContent = String(archivedCount);
      } catch (err) {
        console.error('refreshCoursePills error:', err);
        const activeEl = document.getElementById('activeCount');
        const archEl = document.getElementById('archivedCount');
        if (activeEl) activeEl.textContent = '0';
        if (archEl) archEl.textContent = '0';
      }
    }

    // Load courses (include archived so we can filter locally)
    async function loadCourses() {
      const courseList = document.getElementById("courseList");
      courseList.innerHTML = `<div class="col-12"><div class="empty-card p-4 text-center text-muted">Loadingâ€¦</div></div>`;

      try {
        if (!userData?.userId) {
          courseList.innerHTML = `<div class="col-12 text-danger">Missing user ID. Please re-login.</div>`;
          return;
        }

        const res = await fetch(`${API}/courses?uploadedBy=${encodeURIComponent(userData.userId)}&includeArchived=true`);
        const payload = await safeJson(res);
        const courses = Array.isArray(payload) ? payload : (payload.courses || []);
        allCourses = courses.slice();

        applyFiltersAndRender();
        refreshCoursePills();
      } catch (err) {
        console.error("Failed to load courses:", err);
        courseList.innerHTML = `<div class="col-12 text-danger">Error loading courses.</div>`;
      }
    }

    function applyFiltersAndRender() {
      const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();

      let list = allCourses.filter(c => {
        const matchesSearch =
          !q ||
          (c.title || '').toLowerCase().includes(q) ||
          (c.category || '').toLowerCase().includes(q) ||
          String(c.courseNumber || '').toLowerCase().includes(q);

        const isArchived = !!c.archived;
        const matchesArchive =
          archiveFilter === 'all' ||
          (archiveFilter === 'active' && !isArchived) ||
          (archiveFilter === 'archived' && isArchived);

        return matchesSearch && matchesArchive;
      });

      // Sort
      if (currentSort === 'num_asc') {
        list.sort((a, b) => (Number(a.courseNumber) || 0) - (Number(b.courseNumber) || 0));
      } else if (currentSort === 'num_desc') {
        list.sort((a, b) => (Number(b.courseNumber) || 0) - (Number(a.courseNumber) || 0));
      } else if (currentSort === 'az') {
        list.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      } else if (currentSort === 'new') {
        list.sort((a, b) => (tsToMs(b.createdAt) ?? (Number(b.courseNumber) || 0)) - (tsToMs(a.createdAt) ?? (Number(a.courseNumber) || 0)));
      }

      renderCourses(list);
    }

    function renderCourses(courses) {
      const courseList = document.getElementById("courseList");
      courseList.innerHTML = "";

      if (!Array.isArray(courses) || courses.length === 0) {
        courseList.innerHTML = `
          <div class="col-12">
            <div class="empty-card text-center p-5">
              <div class="mb-2"><i class="bi bi-inbox" style="font-size:2rem; opacity:.6;"></i></div>
              <h5 class="mb-1">No courses found</h5>
              <div class="text-muted">Try adjusting your search or filters.</div>
            </div>
          </div>`;
        return;
      }

      courses.forEach(course => {
        const col = document.createElement("div");
        col.className = "col-md-6 col-lg-4 col-xxl-3";

        const title = escapeHtml(course.title || 'Untitled');
        const category = escapeHtml(course.category || '');
        const description = escapeHtml(course.description || "No description provided.");
        const courseNum = course.courseNumber ?? 'â€”';
        const id = course.id;
        const isArchived = !!course.archived;

        const archivedBadge = isArchived
          ? `<span class="pill-archived ms-2" title="Archived"><i class="bi bi-archive"></i> Archived</span>`
          : '';

        const uploadDisabled = isArchived ? 'link-disabled aria-disabled="true" tabindex="-1" onclick="return false;"' : '';

        col.innerHTML = `
          <article class="course-card h-100">
            <div>
              <h5 class="course-title">${title}</h5>
              <div class="mb-2">
                <span class="badge-soft"><i class="bi bi-hash"></i> Course #${courseNum}</span>
                ${archivedBadge}
              </div>
              <p class="course-meta mb-1"><strong>Category:</strong> ${category || 'â€”'}</p>
              <p class="mb-0">${description}</p>
            </div>

            <div class="mt-3 d-flex justify-content-end gap-2 course-actions">
              <a href="/TEACHER/Modules/upload_module.html?courseId=${encodeURIComponent(id)}"
                 class="btn btn-amber btn-sm ${uploadDisabled}">
                <i class="bi bi-upload me-1"></i> Upload Module
              </a>
              <a href="/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(id)}"
                 class="btn btn-amber-outline btn-sm">
                <i class="bi bi-journal-text me-1"></i> View Modules
              </a>
            </div>
          </article>
        `;
        courseList.appendChild(col);
      });
    }

    // Events
    document.getElementById('searchBox').addEventListener('input', () => applyFiltersAndRender());
    document.getElementById('sortBy').addEventListener('change', e => { currentSort = e.target.value; applyFiltersAndRender(); });

    // segmented filter (Active / Archived / All)
    function setSegmentedActive(which) {
      archiveFilter = which;
      const btnActive = document.getElementById('btnActive');
      const btnArchived = document.getElementById('btnArchived');
      const btnAll = document.getElementById('btnAll');
      [btnActive, btnArchived, btnAll].forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected', 'false'); });
      if (which === 'active') { btnActive.classList.add('is-active'); btnActive.setAttribute('aria-selected', 'true'); }
      if (which === 'archived') { btnArchived.classList.add('is-active'); btnArchived.setAttribute('aria-selected', 'true'); }
      if (which === 'all') { btnAll.classList.add('is-active'); btnAll.setAttribute('aria-selected', 'true'); }
      applyFiltersAndRender();
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnActive').addEventListener('click', () => setSegmentedActive('active'));
      document.getElementById('btnArchived').addEventListener('click', () => setSegmentedActive('archived'));
      document.getElementById('btnAll').addEventListener('click', () => setSegmentedActive('all'));
    });

    // Init
    loadCourses();

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }
  </script>
</body>

</html>