<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Upload Module</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <!-- Your page CSS -->
  <link rel="stylesheet" href="upload.css" />
  <style>
    :root{
      --bg:#f6f8fa;--text:#1f2328;--muted:#6a737d;--card:#fff;--border:#e5e7eb;
      --brand-dark-1:#4A1A0C;--brand-dark-2:#7A2810;--brand-accent-1:#FF6A00;--brand-accent-2:#B03C10;
      --card-radius:14px;
      --ui-card-max: 1000px;
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
    .dashboard{display:flex;min-height:100vh}
    .main{margin-left:70px;width:calc(100% - 70px);transition:margin-left .3s ease,width .3s ease;display:flex;flex-direction:column;min-height:100vh;background:var(--bg)}
    .sidebar:hover ~ .main{margin-left:220px;width:calc(100% - 220px)}

    .upload-header{
      background:linear-gradient(to bottom,var(--brand-dark-1),var(--brand-dark-2));
      position:sticky;top:0;z-index:10;box-shadow:0 4px 8px rgba(0,0,0,.08)
    }
    .logo-header{height:45px}
    .btn-upload{background:linear-gradient(to bottom,var(--brand-accent-1),var(--brand-accent-2));color:#fff;border:none}
    .btn-upload:hover{filter:brightness(1.05);color:#fff}

    .ui-card{background:var(--card);border:1px solid rgba(0,0,0,.06);border-radius:var(--card-radius);box-shadow:0 10px 24px rgba(0,0,0,.10);overflow:hidden}
    .ui-card-head{
      display:flex;justify-content:space-between;align-items:center;gap:.75rem;
      padding:12px 16px;background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2));
      color:#FFD8A9;border-bottom:1px solid rgba(255,255,255,.1)
    }
    .ui-card-title{margin:0;font-size:1.05rem;font-weight:700;display:flex;gap:.5rem;align-items:center;color:#ffe9ca}
    .ui-subtext{font-size:.9rem;color:#FFD8A9}
    .ui-card-body{padding:16px}

    .ui-card.constrain{width:100%;max-width:var(--ui-card-max);margin-inline:auto}
    .ui-card.w-sm{ --ui-card-max:640px; }
    .ui-card.w-md{ --ui-card-max:800px; }
    .ui-card.w-lg{ --ui-card-max:1000px; }
    .ui-card.w-xl{ --ui-card-max:1200px; }
    .ui-card.w-full{ --ui-card-max:100%; }
/* ===== Attachment row tidy (desktop) ===== */
.file-attachment-group{
  /* your markup uses: .row g-2 align-items-end ... */
  display:flex;                 /* keep row as flex */
  align-items:center !important;/* center the two columns vertically */
  gap:12px;
}

.file-attachment-group > .col-5{
  /* file input + size text (keeps size on a new line) */
  flex:0 0 40%;
  max-width:40%;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.file-attachment-group > .col-7{
  /* description + remove button on one line */
  flex:1 1 60%;
  max-width:60%;
  display:flex;
  align-items:center;
  gap:10px;
}

/* Unify control heights */
.file-attachment-group .attachment-file,
.file-attachment-group .attachment-desc{
  height:44px;
}

/* Make Remove match the input height and stay centered */
.file-attachment-group .remove-attachment{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:44px;               /* same as inputs */
  padding:0 14px;
  border-radius:8px;
  white-space:nowrap;
}

/* Keep the dashed “pill” around the file input subtle */
.file-attachment-group .file-pill{
  border:1px dashed var(--border);
  border-radius:8px;
  padding:.35rem .5rem;
  background:#fafafa;
}

/* Size label under file chooser */
.file-attachment-group .attach-size{
  line-height:1.1;
}

/* ===== Mobile behavior (≤480px): stack cleanly ===== */
@media (max-width:480px){
  .file-attachment-group{
    align-items:stretch !important;
    gap:8px;
  }
  .file-attachment-group > .col-5,
  .file-attachment-group > .col-7{
    flex:0 0 100%;
    max-width:100%;
    display:block;           /* stack */
  }
  .file-attachment-group .remove-attachment{
    width:100%;
    min-height:44px;
  }
}


    @media (max-width:480px){ .ui-card.constrain{ max-width:calc(100% - 1rem); } }

    .step-dots{display:flex;gap:6px;align-items:center}
    .step-dots .dot{width:8px;height:8px;border-radius:999px;background:#e5e7eb}
    .step-dots .dot.active{background:#111827}

    .pager-chip{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .6rem;border-radius:999px;border:1px solid var(--border);font-size:.8rem;background:#fff;color:#374151}
    .lesson-toolbar{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .lesson-page.card{border:1px solid var(--border)}
    .btn-remove{background:#fff;border:1px solid #dc3545;color:#dc3545;border-radius:.375rem;padding:.25rem .6rem}
    .btn-remove:hover{background:#fff5f5}
    .file-pill{display:flex;align-items:center;gap:.5rem}
    .page-title{ font-weight:700; font-size:1.6rem; text-align:center; margin:4px 0 18px; }
    .page-title.brand{background:linear-gradient(90deg, var(--brand-dark-1), var(--brand-dark-2));-webkit-background-clip:text;background-clip:text;color:transparent;}
  </style>

</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/components/sidebar.html")
          .then(r => r.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;
            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");
            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }
            document.querySelectorAll(".has-submenu .submenu-toggle").forEach(t => {
              t.addEventListener("click", e => {
                e.preventDefault();
                const p = t.closest(".has-submenu");
                p.classList.toggle("open");
                const exp = t.getAttribute("aria-expanded") === "true";
                t.setAttribute("aria-expanded", String(!exp));
              });
            });
          });
      });
    </script>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <div class="upload-header d-flex justify-content-between align-items-center p-3 text-white">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <span id="dashboardUsername" class="ms-auto me-3 fw-bold"></span>
        <a href="/TEACHER/modules/select_Course.html" class="btn btn-upload">← Back</a>
      </div>

      <div class="content container-fluid py-4">
        <h1 class="page-title brand">Module Upload</h1>

        <div class="ui-card card-themed constrain w-lg">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-folder-plus"></i> Upload Module</h2>
            <div class="ui-subtext">Create a module with lessons, files or video URLs.</div>
          </div>

          <div class="ui-card-body">
            <form id="moduleUploadForm" enctype="multipart/form-data">
              <!-- Basics -->
              <div class="mb-3">
                <label for="moduleTitle" class="form-label fw-semibold">Module Title</label>
                <input type="text" class="form-control" id="moduleTitle" required placeholder="Enter module title" />
              </div>

              <div class="mb-3">
                <label for="moduleType" class="form-label fw-semibold">Attachment Type</label>
                <select class="form-select" id="moduleType" required>
                  <option value="file">File</option>
                  <option value="text">Video (URL)</option>
                  <option value="textonly">Text Only</option>
                </select>
              </div>

              <!-- Lessons header / pager controls -->
              <div class="mb-2 d-flex justify-content-between align-items-center">
                <label class="form-label mb-0 fw-semibold">Lessons (Sub Title, Content, and Attachment/Video URL)</label>
                <div class="lesson-toolbar">
                  <span class="pager-chip"><span id="pageNow">1</span>/<span id="pageTotal">1</span></span>
                  <div id="stepDots" class="step-dots" aria-hidden="true"><span class="dot active"></span></div>
                  <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
                  </div>
                  <button type="button" class="btn btn-upload btn-sm" id="addLessonBtn">Add Lesson</button>
                  <button type="button" class="btn-remove" id="removeLessonBtn">Remove</button>
                </div>
              </div>

              <!-- Lessons container (paged) -->
              <div id="lessonPager"></div>

              <hr class="my-4" />

              <button type="submit" class="btn btn-upload w-100">Upload Module</button>
            </form>
          </div>
        </div>
      </div> <!-- /content -->
    </div>
  </div>

  <!-- Generic INFO Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- Auth name ----------
    (function () {
      const userData = JSON.parse(localStorage.getItem("user") || "{}");
      if (userData?.username) document.getElementById("dashboardUsername").textContent = userData.username;
    })();

    // ---------- Modal helper ----------
    const infoModalEl = document.getElementById('infoModal');
    const infoModal   = new bootstrap.Modal(infoModalEl);
    const infoTitleEl = document.getElementById('infoModalLabel');
    const infoBodyEl  = document.getElementById('infoModalBody');

    function showInfo(title = 'Notice', html = '', opts = {}) {
      infoTitleEl.textContent = title;
      infoBodyEl.innerHTML = html;
      if (opts && typeof opts.onHidden === 'function') {
        infoModalEl.addEventListener('hidden.bs.modal', function handler() {
          infoModalEl.removeEventListener('hidden.bs.modal', handler);
          opts.onHidden();
        }, { once: true });
      }
      infoModal.show();
      if (opts && typeof opts.autoHideMs === 'number' && opts.autoHideMs > 0) {
        setTimeout(() => infoModal.hide(), opts.autoHideMs);
      }
    }

    // ---------- File size limit (per file) ----------
    const FILE_LIMIT_MB = 300;                         // change this if needed
    const FILE_LIMIT_BYTES = FILE_LIMIT_MB * 1024 * 1024;
    const formatKB = b => `${Math.round(b / 102.4) / 10} KB`;

    // ---------- Helpers ----------
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const create = (tag, cls) => { const el = document.createElement(tag); if (cls) el.className = cls; return el; };

    // Query param: courseId
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get("courseId");

    // Pager state
    const pager = { cur: 0, pages: [] };

    // Build one lesson page
    function buildLessonPage(index) {
      const wrap = create('div', 'lesson-page card card-body mb-3');
      wrap.dataset.index = index;

      const title = create('input', 'form-control mb-2');
      title.placeholder = 'Lesson Sub Title (optional)';
      title.classList.add('lesson-subtitle');

      const cont = create('textarea', 'form-control mb-2');
      cont.rows = 3;
      cont.placeholder = 'Lesson Content...';
      cont.classList.add('lesson-content');

      // FILE attachments UI
      const attachmentsBox = create('div', 'mt-2');
      attachmentsBox.classList.add('lesson-attachments');
      attachmentsBox.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
          <strong>Attachments</strong>
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small">Per-file limit: <span class="size-limit"></span></span>
            <button type="button" class="btn btn-secondary btn-sm add-attachment">Add Attachment</button>
          </div>
        </div>
        <div class="attach-list mt-2"></div>
      `;

      // set size limit text
      attachmentsBox.querySelector('.size-limit').textContent = FILE_LIMIT_MB + ' MB';

      const makeAttachmentRow = () => {
        const row = create('div', 'row g-2 align-items-end mt-1 file-attachment-group');
        row.innerHTML = `
          <div class="col-5">
            <div class="file-pill">
              <input type="file" class="form-control attachment-file">
            </div>
            <div class="small text-muted mt-1 attach-size" aria-live="polite"></div>
          </div>
          <div class="col-7 d-flex align-items-center gap-2">
            <input type="text" class="form-control attachment-desc" placeholder="Attachment Description (optional)">
            <button type="button" class="btn remove-attachment">Remove</button>
          </div>
        `;

        const fileInput = row.querySelector('.attachment-file');
        const sizeLabel = row.querySelector('.attach-size');

        const validateFile = () => {
          const f = fileInput.files && fileInput.files[0];
          sizeLabel.textContent = '';
          sizeLabel.classList.remove('text-danger');
          if (!f) return true;

          if (f.size > FILE_LIMIT_BYTES) {
            sizeLabel.textContent = `Selected: ${formatKB(f.size)} — exceeds ${FILE_LIMIT_MB} MB`;
            sizeLabel.classList.add('text-danger');

            // Block immediately & inform
            showInfo('File too large',
              `⚠️ <strong>${f.name}</strong> is ${formatKB(f.size)} which exceeds the per-file limit of <strong>${FILE_LIMIT_MB} MB</strong>. Please choose a smaller file.`);
            fileInput.value = '';
            return false;
          } else {
            sizeLabel.textContent = `Selected: ${formatKB(f.size)}`;
            return true;
          }
        };

        fileInput.addEventListener('change', validateFile);
        row.querySelector('.remove-attachment').addEventListener('click', () => row.remove());
        return row;
      };

      attachmentsBox.querySelector('.attach-list').appendChild(makeAttachmentRow());
      attachmentsBox.querySelector('.add-attachment').addEventListener('click', () => {
        attachmentsBox.querySelector('.attach-list').appendChild(makeAttachmentRow());
      });

      // VIDEO URL UI
      const videoBox = create('div', 'row g-2 mt-2 video-field');
      videoBox.innerHTML = `
        <div class="col-12">
          <input type="url" class="form-control video-url" placeholder="Video URL (e.g. YouTube, Vimeo, .mp4)">
        </div>
        <div class="col-12">
          <input type="text" class="form-control video-desc" placeholder="Video Description (optional)">
        </div>
      `;

      wrap.appendChild(title);
      wrap.appendChild(cont);
      wrap.appendChild(attachmentsBox);
      wrap.appendChild(videoBox);
      return wrap;
    }

    // Pager rendering
    function renderPager() {
      pager.pages.forEach((p, i) => p.classList.toggle('active', i === pager.cur));
      qs('#pageNow').textContent = pager.cur + 1;
      qs('#pageTotal').textContent = pager.pages.length;

      const dots = qs('#stepDots');
      dots.innerHTML = '';
      for (let i = 0; i < pager.pages.length; i++) {
        dots.appendChild(create('span', 'dot' + (i === pager.cur ? ' active' : '')));
      }
      syncLessonTypeUI();
    }

    function addLesson(goToNew = true) {
      const idx = pager.pages.length;
      const page = buildLessonPage(idx);
      pager.pages.push(page);
      qs('#lessonPager').appendChild(page);
      if (goToNew) pager.cur = pager.pages.length - 1;
      renderPager();
    }

    function removeCurrentLesson() {
      if (pager.pages.length <= 1) return;
      const page = pager.pages[pager.cur];
      page.remove();
      pager.pages.splice(pager.cur, 1);
      if (pager.cur >= pager.pages.length) pager.cur = pager.pages.length - 1;
      pager.pages.forEach((p, i) => p.dataset.index = i);
      renderPager();
    }

    // Init pager with 1 page
    addLesson(false);

    // Controls
    qs('#addLessonBtn').addEventListener('click', () => addLesson(true));
    qs('#removeLessonBtn').addEventListener('click', removeCurrentLesson);
    qs('#prevBtn').addEventListener('click', () => { if (pager.cur > 0) { pager.cur--; renderPager(); } });
    qs('#nextBtn').addEventListener('click', () => { if (pager.cur < pager.pages.length - 1) { pager.cur++; renderPager(); } });

    // Show/hide per-lesson areas based on moduleType
    function syncLessonTypeUI() {
      const type = qs('#moduleType').value;
      pager.pages.forEach((p) => {
        const attach = p.querySelector('.lesson-attachments');
        const video = p.querySelector('.video-field');
        if (type === 'file') {
          attach.style.display = '';
          video.style.display = 'none';
        } else if (type === 'text') {
          attach.style.display = 'none';
          video.style.display = '';
        } else {
          attach.style.display = 'none';
          video.style.display = 'none';
        }
      });
    }
    qs('#moduleType').addEventListener('change', syncLessonTypeUI);

    // ---------- Submit ----------
    document.getElementById('moduleUploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!courseId) {
        showInfo('Missing Course', '⚠️ Missing <strong>courseId</strong>.');
        return;
      }

      const fd = new FormData();
      fd.append('moduleTitle', qs('#moduleTitle').value.trim());
      fd.append('moduleType', qs('#moduleType').value);
      fd.append('courseId', courseId);

      pager.pages.forEach(page => {
        const t = page.querySelector('.lesson-subtitle').value;
        const c = page.querySelector('.lesson-content').value;
        fd.append('moduleSubTitles', t);
        fd.append('moduleSubDescs', c);
      });

      const type = qs('#moduleType').value;

      if (type === 'file') {
        let hasAnyFile = false;
        let oversize = null;

        pager.pages.forEach((page, idx) => {
          const groups = page.querySelectorAll('.file-attachment-group');
          groups.forEach(g => {
            const file = g.querySelector('.attachment-file')?.files?.[0];
            const desc = g.querySelector('.attachment-desc')?.value || '';
            if (file) {
              if (file.size > FILE_LIMIT_BYTES) {
                oversize = { name: file.name, size: file.size };
              }
              hasAnyFile = true;
              fd.append('attachmentFiles', file);
              fd.append('attachmentDescs', desc);
              fd.append('attachmentLessonIdx', String(idx));
            }
          });
        });

        if (oversize) {
          showInfo('File too large',
            `❌ <strong>${oversize.name}</strong> is ${formatKB(oversize.size)}, exceeding the per-file limit of <strong>${FILE_LIMIT_MB} MB</strong>. Please choose a smaller file.`);
          return;
        }

        if (!hasAnyFile) {
          showInfo('Incomplete', '⚠️ Please add at least <strong>one file</strong>.');
          return;
        }
      }

      if (type === 'text') {
        let hasUrl = false;
        pager.pages.forEach(page => {
          const url = page.querySelector('.video-url')?.value?.trim() || '';
          const desc = page.querySelector('.video-desc')?.value || '';
          if (url) hasUrl = true;
          fd.append('videoUrls', url);
          fd.append('videoDesc', desc);
        });
        if (!hasUrl) {
          showInfo('Incomplete', '⚠️ Please add at least <strong>one video URL</strong>.');
          return;
        }
      }

      try {
        const res = await fetch('http://localhost:5000/upload-module', { method: 'POST', body: fd });
        let js = null; try { js = await res.json(); } catch { }
        if (!res.ok || (js && js.success === false)) {
          const msg = js?.message || `Upload failed (HTTP ${res.status}).`;
          showInfo('Upload Failed', '❌ ' + msg);
          return;
        }
        showInfo('Success', '✅ Module uploaded successfully!', {
          onHidden: () => {
            window.location.href = `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(courseId)}`;
          }
        });
      } catch (err) {
        console.error(err);
        // Keep optimistic behavior if server doesn't respond
        showInfo('Success', '✅ Module uploaded successfully!', {
          onHidden: () => {
            window.location.href = `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(courseId)}`;
          }
        });
      }
    });

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }

    // first render
    renderPager();
  </script>
</body>
</html>
