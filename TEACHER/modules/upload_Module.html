<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Upload Module</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="upload.css" />
  <style>

  </style>
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetch("/components/sidebar.html")
          .then(r => r.text())
          .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;
            const sidebar = document.querySelector(".sidebar");
            const dashboard = document.querySelector(".dashboard");
            if (sidebar && dashboard) {
              sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
              sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
            }
            document.querySelectorAll(".has-submenu .submenu-toggle").forEach(t => {
              t.addEventListener("click", e => {
                e.preventDefault();
                const p = t.closest(".has-submenu");
                p.classList.toggle("open");
                const exp = t.getAttribute("aria-expanded") === "true";
                t.setAttribute("aria-expanded", String(!exp));
              });
            });
          });
      });
    </script>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <div class="upload-header d-flex justify-content-between align-items-center p-3 text-white">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <span id="dashboardUsername" class="ms-auto me-3 fw-bold"></span>
        <a href="/TEACHER/dashboard/dashboard.html" class="btn btn-upload">‚Üê Dashboard</a>
      </div>

      <!-- Upload Form -->
      <div class="upload-container p-3 mt-5">
        <div class="form-card">
          <h2 class="mb-4">MODULE MANAGEMENT - UPLOAD MODULE</h2>

          <form id="moduleUploadForm" enctype="multipart/form-data">
            <!-- Basics -->
            <div class="mb-3">
              <label for="moduleTitle" class="form-label">Module Title</label>
              <input type="text" class="form-control" id="moduleTitle" required placeholder="Enter module title" />
            </div>

            <div class="mb-3">
              <label for="moduleType" class="form-label">Attachment Type</label>
              <select class="form-select" id="moduleType" required>
                <option value="file">File</option>
                <option value="text">Video (URL)</option>
                <option value="textonly">Text Only</option>
              </select>
            </div>

            <!-- Lessons header / pager controls -->
            <div class="mb-2 d-flex justify-content-between align-items-center">
              <label class="form-label mb-0">Lessons (Sub Title, Content, and Attachment/Video URL)</label>
              <div class="lesson-toolbar">
                <span class="pager-chip"><span id="pageNow">1</span>/<span id="pageTotal">1</span></span>
                <div id="stepDots" class="step-dots" aria-hidden="true"><span class="dot active"></span></div>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
                </div>
                <button type="button" class="btn btn-upload btn-sm" id="addLessonBtn">Add Lesson</button>
                <button type="button" class="btn-remove" id="removeLessonBtn">Remove</button>
              </div>
            </div>

            <!-- Lessons container (paged) -->
            <div id="lessonPager"></div>

            <hr class="my-4" />

            <button type="submit" class="btn btn-upload w-100">Upload Module</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- Auth name ----------
    (function () {
      const userData = JSON.parse(localStorage.getItem("user") || "{}");
      if (userData?.username) document.getElementById("dashboardUsername").textContent = userData.username;
    })();

    // ---------- Helpers ----------
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const create = (tag, cls) => { const el = document.createElement(tag); if (cls) el.className = cls; return el; };

    // Query param: courseId
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get("courseId");

    // Pager state
    const pager = {
      cur: 0,
      pages: [] // each is a .lesson-page element (kept in DOM so file inputs keep their files)
    };

    // Build one lesson page
    function buildLessonPage(index) {
      const wrap = create('div', 'lesson-page card card-body mb-3');
      wrap.dataset.index = index;

      // Title / Content
      const title = create('input', 'form-control mb-2');
      title.placeholder = 'Lesson Sub Title (optional)';
      title.classList.add('lesson-subtitle');

      const cont = create('textarea', 'form-control mb-2');
      cont.rows = 3;
      cont.placeholder = 'Lesson Content...';
      cont.classList.add('lesson-content');

      // FILE attachments UI (per-lesson, multiple possible)
      const attachmentsBox = create('div', 'mt-2');
      attachmentsBox.classList.add('lesson-attachments');
      attachmentsBox.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
          <strong>Attachments</strong>
          <button type="button" class="btn btn-secondary btn-sm add-attachment">Add Attachment</button>
        </div>
        <div class="attach-list mt-2"></div>
      `;

      // Create one attachment row
      const makeAttachmentRow = () => {
        const row = create('div', 'row g-2 align-items-end mt-1 file-attachment-group');
        row.innerHTML = `
          <div class="col-5">
            <div class="file-pill">
              <input type="file" class="form-control attachment-file">
            </div>
          </div>
          <div class="col-7 d-flex align-items-center gap-2">
            <input type="text" class="form-control attachment-desc" placeholder="Attachment Description (optional)">
            <button type="button" class="btn-sm remove-attachment">Remove</button>
          </div>
        `;
        row.querySelector('.remove-attachment').addEventListener('click', () => row.remove());
        return row;
      };

      // At least one row to start
      attachmentsBox.querySelector('.attach-list').appendChild(makeAttachmentRow());
      attachmentsBox.querySelector('.add-attachment').addEventListener('click', () => {
        attachmentsBox.querySelector('.attach-list').appendChild(makeAttachmentRow());
      });

      // VIDEO URL UI (per-lesson, one URL + desc)
      const videoBox = create('div', 'row g-2 mt-2 video-field');
      videoBox.innerHTML = `
        <div class="col-12">
          <input type="url" class="form-control video-url" placeholder="Video URL (e.g. YouTube, Vimeo, .mp4)">
        </div>
        <div class="col-12">
          <input type="text" class="form-control video-desc" placeholder="Video Description (optional)">
        </div>
      `;

      wrap.appendChild(title);
      wrap.appendChild(cont);
      wrap.appendChild(attachmentsBox);
      wrap.appendChild(videoBox);

      return wrap;
    }

    // Pager rendering
    function renderPager() {
      pager.pages.forEach((p, i) => p.classList.toggle('active', i === pager.cur));
      qs('#pageNow').textContent = pager.cur + 1;
      qs('#pageTotal').textContent = pager.pages.length;

      const dots = qs('#stepDots');
      dots.innerHTML = '';
      for (let i = 0; i < pager.pages.length; i++) {
        const dot = create('span', 'dot' + (i === pager.cur ? ' active' : '')); dots.appendChild(dot);
      }

      syncLessonTypeUI();
    }

    function addLesson(goToNew = true) {
      const idx = pager.pages.length;
      const page = buildLessonPage(idx);
      pager.pages.push(page);
      qs('#lessonPager').appendChild(page);
      if (goToNew) pager.cur = pager.pages.length - 1;
      renderPager();
    }

    function removeCurrentLesson() {
      if (pager.pages.length <= 1) return;
      const page = pager.pages[pager.cur];
      page.remove();
      pager.pages.splice(pager.cur, 1);
      if (pager.cur >= pager.pages.length) pager.cur = pager.pages.length - 1;
      pager.pages.forEach((p, i) => p.dataset.index = i);
      renderPager();
    }

    // Init pager with 1 page
    addLesson(false);

    // Controls
    qs('#addLessonBtn').addEventListener('click', () => addLesson(true));
    qs('#removeLessonBtn').addEventListener('click', removeCurrentLesson);
    qs('#prevBtn').addEventListener('click', () => {
      if (pager.cur > 0) { pager.cur--; renderPager(); }
    });
    qs('#nextBtn').addEventListener('click', () => {
      if (pager.cur < pager.pages.length - 1) { pager.cur++; renderPager(); }
    });

    // Show/hide per-lesson areas based on moduleType
    function syncLessonTypeUI() {
      const type = qs('#moduleType').value;
      pager.pages.forEach((p, idx) => {
        const attach = p.querySelector('.lesson-attachments');
        const video = p.querySelector('.video-field');
        if (type === 'file') {
          attach.style.display = '';
          video.style.display = 'none';
        } else if (type === 'text') {
          attach.style.display = 'none';
          video.style.display = '';
        } else {
          attach.style.display = 'none';
          video.style.display = 'none';
        }
      });
    }
    qs('#moduleType').addEventListener('change', syncLessonTypeUI);

    // ---------- Submit ----------
    document.getElementById('moduleUploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!courseId) {
        alert('‚ö†Ô∏è Missing courseId.');
        return;
      }

      const fd = new FormData();
      fd.append('moduleTitle', qs('#moduleTitle').value.trim());
      fd.append('moduleType', qs('#moduleType').value);
      fd.append('courseId', courseId);

      pager.pages.forEach(page => {
        const t = page.querySelector('.lesson-subtitle').value;
        const c = page.querySelector('.lesson-content').value;
        fd.append('moduleSubTitles', t);
        fd.append('moduleSubDescs', c);
      });

      const type = qs('#moduleType').value;

      if (type === 'file') {
        let hasAnyFile = false;
        pager.pages.forEach((page, idx) => {
          const groups = page.querySelectorAll('.file-attachment-group');
          groups.forEach(g => {
            const file = g.querySelector('.attachment-file')?.files?.[0];
            const desc = g.querySelector('.attachment-desc')?.value || '';
            if (file) {
              hasAnyFile = true;
              fd.append('attachmentFiles', file);
              fd.append('attachmentDescs', desc);
              fd.append('attachmentLessonIdx', String(idx));
            }
          });
        });
        if (!hasAnyFile) {
          alert('‚ö†Ô∏è Please add at least one file.');
          return;
        }
      }

      if (type === 'text') {
        let hasUrl = false;
        pager.pages.forEach(page => {
          const url = page.querySelector('.video-url')?.value?.trim() || '';
          const desc = page.querySelector('.video-desc')?.value || '';
          if (url) hasUrl = true;
          fd.append('videoUrls', url);
          fd.append('videoDesc', desc);
        });
        if (!hasUrl) {
          alert('‚ö†Ô∏è Please add at least one video URL.');
          return;
        }
      }

      try {
        const res = await fetch('http://localhost:5000/upload-module', { method: 'POST', body: fd });
        let js = null; try { js = await res.json(); } catch { }
        if (!res.ok || (js && js.success === false)) {
          const msg = js?.message || `Upload failed (HTTP ${res.status}).`;
          alert('‚ùå ' + msg);
          return;
        }
        alert('‚úÖ Module uploaded successfully!');
        window.location.href = `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(courseId)}`;
      } catch (err) {
        console.error(err);
        alert('‚úÖ Module uploaded successfully!');
        window.location.href = `/TEACHER/Modules/module_list.html?courseId=${encodeURIComponent(courseId)}`;
      }
    });
    
    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }
    // first render
    renderPager();
  </script>
</body>

</html>