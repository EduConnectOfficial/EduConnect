<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EduConnect Teacher – Upload Module</title>

  <!-- (Optional) If your backend is on another Railway service/domain, set it here -->
  <!-- <meta name="api-base" content="https://your-backend.up.railway.app"> -->

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="upload.css" />
  <style>
    .assign-card.selected { outline: 2px solid var(--brand-accent-1, #3b6bb4); }
    .small-muted { color: #6c757d; font-size: .9rem; }
    .btn-icon { width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; }
    .inline-field { min-width: 260px; }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative" style="max-width:520px;">
          <input type="text" id="searchBox" class="form-control" placeholder="Search modules..."/>
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold">T</span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid p-4">
        <h1 class="page-title">Module Upload</h1>

        <div class="ui-card card-themed mb-3 mx-auto" style="max-width:1080px;">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-folder-plus"></i> Upload Module</h2>
            <div class="ui-subtext">Create a module with lessons, choose classes, stage files/links, and publish now or at a scheduled time.</div>
          </div>

          <form id="moduleUploadForm" class="px-3 py-3" enctype="multipart/form-data" novalidate>
            <!-- Module basics -->
            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label">Module Title</label>
                <input type="text" id="moduleTitle" class="form-control" required placeholder="Enter module title"/>
              </div>
              <div class="col-md-4">
                <label class="form-label">Attachment Mode</label>
                <select id="moduleType" class="form-select" required>
                  <option value="file">Files per lesson</option>
                  <option value="text">Video URLs per lesson</option>
                  <option value="textonly">Text only</option>
                </select>
              </div>
            </div>

            <!-- Assign-to-Classes (FILTERED to course) -->
            <div class="mt-3">
              <label class="form-label fw-semibold">Assign to Classes</label>
              <div id="assigned-status" class="small-muted mb-2">Loading your classes…</div>
              <div id="assigned-empty" class="alert alert-warning py-2 px-3 mb-2" style="display:none;">
                No classes linked to this course were found.
              </div>
              <div id="assignedClassesContainer" class="row g-3"></div>
              <div class="small-muted mt-2">Only classes enrolled in this course are shown.</div>
            </div>

            <!-- Lessons header / pager controls -->
            <div class="mt-4 d-flex justify-content-between align-items-center">
              <label class="form-label mb-0 fw-semibold">Lessons (Sub Title, Content)</label>
              <div class="lesson-toolbar">
                <span class="pager-chip"><span id="pageNow">1</span>/<span id="pageTotal">1</span></span>
                <div id="stepDots" class="step-dots" aria-hidden="true"><span class="dot active"></span></div>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
                </div>
                <button type="button" class="btn btn-amber btn-sm" id="addLessonBtn"><i class="bi bi-plus-lg"></i> Add Lesson</button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="removeLessonBtn"><i class="bi bi-trash"></i> Remove</button>
              </div>
            </div>

            <!-- Lessons container (paged) -->
            <div id="lessonPager" class="mt-2"></div>

            <!-- Staging UI (depends on moduleType) -->
            <div class="ui-card mt-3" id="stagingCard">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-paperclip"></i> Attachments & Links</h2>
              </div>
              <div class="p-3">
                <!-- Target lesson selector -->
                <div class="row g-2 mb-2" id="targetLessonRow">
                  <div class="col-md-6">
                    <label class="form-label">Assign staged items to lesson</label>
                    <select id="targetLessonSelect" class="form-select" aria-label="Target lesson"></select>
                    <div class="hint mt-1">Choose which lesson the staged file/link belongs to.</div>
                  </div>
                </div>

                <!-- Upload area: files ONLY for moduleType=file -->
                <div id="fileSection">
                  <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-8">
                      <label class="form-label">Upload file(s)</label>
                      <input id="fileInput" type="file" multiple class="form-control" />
                      <div class="small-muted mt-1">Per-file limit: <strong>300 MB</strong>. Select multiple; preview before staging.</div>
                    </div>
                    <div class="col-md-4 d-grid d-sm-flex gap-2">
                      <button id="btnPreviewSelectedFiles" class="btn btn-outline-secondary w-100 w-sm-auto">
                        <i class="bi bi-eye"></i> Preview Selected
                      </button>
                      <button id="btnStageFiles" class="btn btn-outline-primary w-100 w-sm-auto">
                        <i class="bi bi-cloud-plus"></i> Stage Files
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Link area: ONLY for moduleType=text -->
                <div id="linkSection">
                  <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-8">
                      <label class="form-label">Add a link or video URL</label>
                      <input id="linkInput" type="url" class="form-control" placeholder="https://… (YouTube, Vimeo, Docs, etc.)" />
                      <div class="small-muted mt-1">Paste a public URL. YouTube links auto-embed in preview.</div>
                    </div>
                    <div class="col-md-4 d-grid d-sm-flex gap-2">
                      <button id="btnPreviewLink" class="btn btn-outline-secondary w-100 w-sm-auto">
                        <i class="bi bi-eye"></i> Preview
                      </button>
                      <button id="btnStageLink" class="btn btn-outline-secondary w-100 w-sm-auto">
                        <i class="bi bi-link-45deg"></i> Stage Link
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Staged list -->
                <ul id="filesList" class="file-list"></ul>
                <div class="form-text mt-2">
                  <strong>Staging:</strong> items marked with
                  <span class="badge-soft badge-stage">Staged</span>
                  will be uploaded/added when you click <strong>Upload</strong>.
                </div>
              </div>
            </div>

            <!-- Publish options (NOW vs SCHEDULE) -->
            <div class="ui-card mt-3" id="publishCard">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-broadcast"></i> Publish</h2>
              </div>
              <div class="p-3 d-flex align-items-center gap-4 flex-wrap">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="pubMode" id="pubNow" value="now" checked>
                  <label class="form-check-label" for="pubNow">Publish now</label>
                </div>
                <div class="form-check d-flex align-items-center gap-2">
                  <input class="form-check-input" type="radio" name="pubMode" id="pubSchedule" value="schedule">
                  <label class="form-check-label" for="pubSchedule">Schedule publish</label>
                  <input type="datetime-local" id="publishAt" class="form-control form-control-sm inline-field" disabled>
                </div>
                <div class="small-muted">Times use your device’s timezone.</div>
              </div>
            </div>

            <!-- Error -->
            <div id="formError" class="text-danger mt-3" style="min-height:1.2rem;"></div>

            <!-- Actions -->
            <div class="d-flex justify-content-end gap-2 mt-4">
              <a href="/TEACHER/modules/select_Course.html" class="btn btn-close-footer">← Back</a>
              <button id="submitBtn" type="submit" class="btn btn-amber">
                <span class="submit-text">Upload & Publish</span>
                <span class="spinner-border spinner-border-sm ms-2 visually-hidden" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>
        <div class="modal-footer">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto d-flex gap-2">
            <button id="stageFromPreviewBtn" class="btn btn-amber text-white d-none">
              <i class="bi bi-cloud-plus me-1"></i> Stage this item
            </button>
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-close-footer">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sb = document.querySelector(".sidebar");
          const db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Auth guard + header initial (single letter) + API resolver -->
  <script>
    /* ===== Railway-friendly API base resolver =====
       1) <meta name="api-base">, 2) window.__API_BASE, 3) localStorage.API_BASE,
       4) same origin on *.railway.app, 5) http://localhost:5000 (dev)
    ================================================= */
    const API = (() => {
      const byMeta = document.querySelector('meta[name="api-base"]')?.getAttribute('content')?.trim();
      const byWindow = (typeof window !== 'undefined' && window.__API_BASE) ? String(window.__API_BASE).trim() : '';
      const byStorage = (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) ? localStorage.getItem('API_BASE').trim() : '';
      const onRailway = /\.railway\.app$/i.test(location.hostname);
      const chosen = byMeta || byWindow || byStorage || (onRailway ? location.origin : 'http://localhost:5000');
      return String(chosen).replace(/\/+$/, '');
    })();

    function toApiUrl(pathOrUrl = '') {
      const s = String(pathOrUrl);
      if (/^https?:\/\/|^blob:/i.test(s)) return s;
      return API + (s.startsWith('/') ? s : '/' + s);
    }

    function logoutUser(){
      localStorage.clear();
      sessionStorage.clear();
      window.location.href="/TEACHER/login/login.html";
    }
    window.logoutUser = logoutUser;

    (function initHeaderInitials(){
      try{
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;

        if (!u?.userId || !u?.isTeacher) { window.location.href = "/TEACHER/login/login.html"; return; }
        window.currentUser = u;

      // ---- Auth guard + header initials (robust, initials-only) ----
    const userData = (() => {
      try {
        const raw = localStorage.getItem("user") || "{}";
        const stored = JSON.parse(raw);
        const u = stored.user || stored;
        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return null;
        }
        const el = document.getElementById("dashboardUsername");
        if (el) {
          const initials = getInitials(u);
          el.textContent = initials;
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username || u.email || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        }
        return u;
      } catch (e) {
        console.error('auth/initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
        return null;
      }

      function getInitials(u) {
        const fn = (u.firstName || '').trim();
        const ln = (u.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          const parts = nameish
            .replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
            .split(/[\s._-]+/)
            .filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }
        const em = (u.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();
      }catch(e){ console.error('initHeaderInitials failed:', e); window.location.href = "/TEACHER/login/login.html"; }
    })();
  </script>

  <!-- Page Logic -->
  <script>
    const TEACHER_MAX_MB = 300;
    const TEACHER_MAX_BYTES = TEACHER_MAX_MB * 1024 * 1024;

    /* ===== Utilities ===== */
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    function extFromUrl(u=''){ const clean=String(u).split('?')[0].split('#')[0]; const parts=clean.split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function extFromName(n=''){ const parts=String(n).split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function isYouTubeUrl(url=''){ try{const u=new URL(url);const h=u.hostname.replace(/^www\./,'').toLowerCase();return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);}catch{return false;} }
    function toYouTubeEmbed(url=''){ try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();let id='';let start=u.searchParams.get('start')||u.searchParams.get('t')||'';if(start&&/^\d+s$/.test(start))start=parseInt(start,10);if(start&&/^\d+$/.test(start))start=parseInt(start,10);if(!Number.isFinite(start))start=''; if(host==='youtu.be'){id=(u.pathname||'').replace(/^\//,'').split('/')[0];} else { if(u.pathname.startsWith('/embed/')) id=u.pathname.split('/')[2]||''; if(!id) id=u.searchParams.get('v')||''; } if(!id) return null; const base=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`; const qs=new URLSearchParams(); qs.set('rel','0'); if(start) qs.set('start', String(start)); return `${base}?${qs.toString()}`; }catch{return null;} }
    function kindFrom({url='', name='', mime=''}) {
      const ext = (extFromUrl(url) || extFromName(name)).toLowerCase();
      if (isYouTubeUrl(url)) return 'youtube';
      if ((mime||'').startsWith('image/') || ['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
      if (mime === 'application/pdf' || ext === 'pdf') return 'pdf';
      if ((mime||'').startsWith('video/') || ['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
      if ((mime||'').startsWith('audio/') || ['mp3','wav','m4a','ogg','aac','flac'].includes(ext)) return 'audio';
      if ((mime||'').startsWith('text/') || ['txt','csv','log'].includes(ext)) return 'text';
      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
      return 'other';
    }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function setFileInfoUI(kind,url){
      const info=document.getElementById('fileInfoText');
      const hdr=document.getElementById('filePreviewModalLabel');
      const labelMap={youtube:'YouTube',video:'Video',audio:'Audio',image:'Image',pdf:'PDF',text:'Text/CSV',office:'Office Doc',other:'File'};
      let badge=document.getElementById('fileKindBadge'); if(!badge){badge=document.createElement('span');badge.id='fileKindBadge';badge.className='ms-2 badge rounded-pill';hdr.appendChild(badge);}
      badge.className='ms-2 badge rounded-pill bg-secondary-subtle text-secondary';
      badge.textContent=labelMap[kind]||'File';
      info.innerHTML=`<span class="text-muted">Type:</span> <strong>${labelMap[kind]||'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href=url||'#';
    }
    function renderFilePreviewInto(container, {url, name='', mime='', isStaged=false}){
      container.innerHTML=''; showSpinner(true);
      const done=()=>showSpinner(false);
      const fallback=(msg)=>{ container.innerHTML=`<div class="preview-fallback"><div class="text-muted mb-2">${msg||'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; done(); };
      const kind = kindFrom({url, name, mime});
      if(kind==='youtube'){ const embed=toYouTubeEmbed(url); if(embed){container.innerHTML=`<div class="ratio ratio-16x9"><iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>`; done(); return;} return fallback('Couldn’t embed this YouTube link.'); }
      if(kind==='image'){ const img=new Image(); img.onload=done; img.onerror=()=>fallback('Image preview failed.'); img.src=url; container.appendChild(img); return; }
      if(kind==='pdf'){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('PDF preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(kind==='video'){ const v=document.createElement('video'); v.controls=true; v.onloadeddata=done; v.onerror=()=>fallback('Video preview failed.'); v.src=url; container.appendChild(v); return; }
      if(kind==='audio'){ const a=document.createElement('audio'); a.controls=true; a.onloadeddata=done; a.onerror=()=>fallback('Audio preview failed.'); a.src=url; container.appendChild(a); return; }
      if(kind==='text'){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Text preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(kind==='office' && url.startsWith('blob:')){ return fallback('Office documents cannot be previewed until they’re uploaded. Please Upload first, then preview in Edit.'); }
      if(kind==='office'){ const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Office preview failed (Google Viewer blocked).'); iframe.src=gview; container.appendChild(iframe); return; }
      const obj=document.createElement('object'); obj.data=url; obj.type=mime||'application/octet-stream'; obj.onload=done; obj.onerror=()=>fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(done,1200);
    }

    /* ======= COURSE-LINKED CLASSES FILTERING ======= */
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get("courseId");
    let eligibleClassIdSet = new Set();

    async function fetchCourseObject() {
      if (!courseId) return null;

      const candidates = [
        toApiUrl(`/api/courses/${encodeURIComponent(courseId)}`),
        toApiUrl(`/api/courses?courseId=${encodeURIComponent(courseId)}`),
        toApiUrl(`/courses/${encodeURIComponent(courseId)}`),
        toApiUrl(`/courses?courseId=${encodeURIComponent(courseId)}`)
      ];

      for (const url of candidates) {
        try {
          const r = await fetch(url, { headers: { "Accept": "application/json" }});
          if (!r.ok) continue;
          const j = await r.json();
          if (j && typeof j === 'object') {
            if (j.course && typeof j.course === 'object') return j.course;
            if (Array.isArray(j.courses)) {
              const hit = j.courses.find(c => (c.id || c._id) === courseId);
              return hit || j.courses[0] || null;
            }
            if (j.id || j._id || j.title || j.courseNumber) return j;
          }
        } catch {}
      }
      return null;
    }

    function collectIds(maybe) {
      const ids = [];
      if (Array.isArray(maybe)) {
        for (const v of maybe) {
          if (typeof v === 'string') ids.push(v);
          else if (v && typeof v === 'object') {
            ids.push(v.id || v._id || v.classId || v.value || v.key || null);
          }
        }
      } else if (maybe && typeof maybe === 'object') {
        for (const k of Object.keys(maybe)) {
          const val = maybe[k];
          if (typeof val === 'string') ids.push(val);
          else if (val && typeof val === 'object') {
            ids.push(val.id || val._id || val.classId || k);
          } else {
            ids.push(k);
          }
        }
      }
      return ids.filter(Boolean);
    }

    async function loadCourseEligibleClassIds() {
      eligibleClassIdSet = new Set();
      const course = await fetchCourseObject();
      if (!course) return;

      const candidateFields = [
        'assignedClasses', 'assignedClassIds', 'classIds', 'classes', 'enrolledClasses', 'linkedClasses'
      ];

      for (const field of candidateFields) {
        if (course[field] !== undefined) {
          const ids = collectIds(course[field]);
          ids.forEach(id => eligibleClassIdSet.add(String(id)));
        }
      }

      for (const [k, v] of Object.entries(course)) {
        if (Array.isArray(v) && v.length && (k.toLowerCase().includes('class'))) {
          collectIds(v).forEach(id => eligibleClassIdSet.add(String(id)));
        }
      }
    }

    function classMatchesCourse(c) {
      const id = String(c.id || c._id || c.classId || '');
      if (!id) return false;
      if (eligibleClassIdSet.size > 0 && eligibleClassIdSet.has(id)) return true;
      if (String(c.courseId || '') === courseId) return true;
      if (Array.isArray(c.courseIds) && c.courseIds.map(String).includes(courseId)) return true;
      if (Array.isArray(c.courses)) {
        const ids = c.courses.map(v => typeof v === 'string' ? v : (v?.id || v?._id));
        if (ids.map(String).includes(courseId)) return true;
      }
      return false;
    }

    /* ===== Previews & stage from modal ===== */
    let currentPreviewRevoke = null;
    let previewStageCtx = null; // { mode:'file'|'link', files?:File[], url?:string }
    const stageFromPreviewBtn = document.getElementById('stageFromPreviewBtn');

    function showStageBtn(show, label){
      stageFromPreviewBtn.classList.toggle('d-none', !show);
      if (label) stageFromPreviewBtn.innerHTML = `<i class="bi bi-cloud-plus me-1"></i> ${label}`;
    }

    document.getElementById('filePreviewModal').addEventListener('hidden.bs.modal', ()=>{
      if (typeof currentPreviewRevoke === 'function') { try { currentPreviewRevoke(); } catch {} }
      currentPreviewRevoke = null;
      previewStageCtx = null;
      showStageBtn(false);
    });

    function openPreviewModalWithMeta({url, title='File', mime='', isStaged=false, stageContext=null}){
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      setFileInfoUI(kindFrom({url, name:title, mime}), url);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), {url, name:title, mime, isStaged});
      previewStageCtx = stageContext || null;
      if (previewStageCtx) {
        const label = (previewStageCtx.mode === 'file') ? 'Stage this file' : 'Stage this link';
        showStageBtn(true, label);
      } else {
        showStageBtn(false);
      }
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    stageFromPreviewBtn.addEventListener('click', ()=>{
      if (!previewStageCtx) return;
      const tgt = Number(document.getElementById('targetLessonSelect').value || 0);

      if (previewStageCtx.mode === 'file' && Array.isArray(previewStageCtx.files)) {
        previewStageCtx.files.forEach(f => { f.__uid = Math.random().toString(36).slice(2,10); f.__lesson = tgt; staged.addFiles.push(f); });
        fileInput.value = '';
        renderAttachments();
        bootstrap.Modal.getInstance(document.getElementById('filePreviewModal')).hide();
        showInfo('Staged','File(s) are staged and will be uploaded on Upload.');
      }
      if (previewStageCtx.mode === 'link' && previewStageCtx.url) {
        staged.addLinks.push({ url: previewStageCtx.url, lesson: tgt });
        linkInput.value = '';
        renderAttachments();
        bootstrap.Modal.getInstance(document.getElementById('filePreviewModal')).hide();
        showInfo('Staged','Link will be added on Upload.');
      }
      previewStageCtx = null;
      showStageBtn(false);
    });

    function showInfo(title, body){
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').innerHTML = body;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('infoModal')).show();
    }

    /* ===== DOM refs ===== */
    const form         = document.getElementById("moduleUploadForm");
    const formError    = document.getElementById("formError");
    const submitBtn    = document.getElementById("submitBtn");
    const spinner      = submitBtn.querySelector(".spinner-border");
    const submitText   = submitBtn.querySelector(".submit-text");

    // Publish controls
    const pubNowRadio      = document.getElementById('pubNow');
    const pubScheduleRadio = document.getElementById('pubSchedule');
    const publishAtInput   = document.getElementById('publishAt');

    const fileSection   = document.getElementById('fileSection');
    const linkSection   = document.getElementById('linkSection');
    const stagingCard   = document.getElementById('stagingCard');

    const fileInput      = document.getElementById('fileInput');
    const btnPreviewSelectedFiles = document.getElementById('btnPreviewSelectedFiles');
    const btnStageFiles  = document.getElementById('btnStageFiles');
    const linkInput      = document.getElementById('linkInput');
    const btnPreviewLink = document.getElementById('btnPreviewLink');
    const btnStageLink   = document.getElementById('btnStageLink');
    const filesList      = document.getElementById('filesList');
    const targetLessonSelect = document.getElementById('targetLessonSelect');

    /* ===== Assign-to-Classes (FILTERED) ===== */
    const assignedContainer = document.getElementById("assignedClassesContainer");
    const assignedStatus = document.getElementById("assigned-status");
    const assignedEmpty = document.getElementById("assigned-empty");

    async function loadClasses() {
      try {
        const teacherId = window.currentUser?.userId || window.currentUser?.id || window.currentUser?.uid || '';
        if (!teacherId) {
          assignedStatus.textContent = "Missing teacher ID in your session.";
          assignedStatus.classList.remove('small-muted');
          assignedStatus.classList.add('text-danger');
          return;
        }

        await loadCourseEligibleClassIds();

        const classCandidates = [
          toApiUrl(`/api/classes?teacherId=${encodeURIComponent(teacherId)}&courseId=${encodeURIComponent(courseId||'')}`),
          toApiUrl(`/api/classes?teacherId=${encodeURIComponent(teacherId)}`),
          toApiUrl(`/classes?teacherId=${encodeURIComponent(teacherId)}&courseId=${encodeURIComponent(courseId||'')}`),
          toApiUrl(`/classes?teacherId=${encodeURIComponent(teacherId)}`)
        ];

        let classes = null, success = false, lastErr = null;
        for (const u of classCandidates) {
          try {
            const res = await fetch(u, { headers: { "Accept": "application/json" } });
            if (!res.ok) { lastErr = `HTTP ${res.status}`; continue; }
            const json = await res.json();
            const arr = json?.classes || json?.data || (Array.isArray(json) ? json : null);
            if (Array.isArray(arr)) { classes = arr; success = (json?.success === undefined ? true : !!json.success); break; }
          } catch (e) { lastErr = e?.message || 'fetch error'; }
        }

        assignedContainer.innerHTML = "";
        assignedEmpty.style.display = "none";

        if (!classes) {
          assignedStatus.textContent = "Could not load your classes.";
          assignedStatus.classList.remove('small-muted');
          assignedStatus.classList.add('text-danger');
          if (lastErr) console.error('classes fetch:', lastErr);
          return;
        }
        if (!success) {
          assignedStatus.textContent = "Could not load your classes.";
          assignedStatus.classList.remove('small-muted');
          assignedStatus.classList.add('text-danger');
          return;
        }

        const filtered = classes.filter(classMatchesCourse);

        if (filtered.length === 0) {
          assignedStatus.style.display = "none";
          assignedEmpty.style.display = "block";
          return;
        }

        filtered.forEach(c => {
          const id = c.id || c._id || c.classId || "";
          const name = c.name || c.className || "Untitled Class";
          const grade = c.gradeLevel ?? c.grade ?? "—";
          const section = c.section ?? c.sectionName ?? "—";

          const col = document.createElement("div");
          col.className = "col-12 col-sm-6 col-lg-4";

          const card = document.createElement("div");
          card.className = "card assign-card";
          card.tabIndex = 0;

          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.value = id;
          chk.className = "d-none";

          const body = document.createElement("div");
          body.className = "card-body";
          body.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <h5 class="card-title mb-1">${esc(name)}</h5>
              <i class="bi bi-check2-circle ms-2" style="opacity:.35;"></i>
            </div>
            <div class="small-muted">Grade ${esc(grade)} • Section ${esc(section)}</div>
          `;

          function toggle() {
            const isChecked = !chk.checked;
            chk.checked = isChecked;
            card.classList.toggle("selected", isChecked);
          }

          card.addEventListener("click", e => {
            if (window.getSelection && String(window.getSelection()).length) return;
            toggle();
          });
          card.addEventListener("keydown", e => {
            if (e.key === " " || e.key === "Enter") { e.preventDefault(); toggle(); }
          });

          card.appendChild(chk);
          card.appendChild(body);
          col.appendChild(card);
          assignedContainer.appendChild(col);
        });

        assignedStatus.style.display = "none";
      } catch (e) {
        console.error("Could not load classes:", e);
        assignedStatus.textContent = "Could not load your classes. Please refresh.";
        assignedStatus.classList.remove('small-muted');
        assignedStatus.classList.add('text-danger');
        showInfo('Network Error', 'Could not load your classes. Please refresh and try again.');
      }
    }

    /* ===== Lessons pager ===== */
    const qs = s => document.querySelector(s);
    const create = (tag, cls) => { const el=document.createElement(tag); if(cls) el.className=cls; return el; };

    const pager = { cur: 0, pages: [] };

    function buildLessonPage(index){
      const wrap = create('div','lesson-page card card-body mb-3');
      wrap.dataset.index = index;

      const title = create('input','form-control mb-2 lesson-subtitle');
      title.placeholder = 'Lesson Sub Title (optional)';

      const cont = create('textarea','form-control mb-2 lesson-content');
      cont.rows = 3; cont.placeholder = 'Lesson Content...';

      const modeHelp = create('div','small-muted');
      modeHelp.setAttribute('data-mode-help','');

      wrap.append(title, cont, modeHelp);
      return wrap;
    }

    function renderPager(){
      pager.pages.forEach((p,i)=> p.style.display = (i===pager.cur)?'':'none');
      qs('#pageNow').textContent = pager.cur + 1;
      qs('#pageTotal').textContent = pager.pages.length;

      const dots = qs('#stepDots'); dots.innerHTML='';
      for(let i=0;i<pager.pages.length;i++){
        const d = create('span','dot'+(i===pager.cur?' active':'')); d.addEventListener('click',()=>{ pager.cur=i; renderPager(); });
        dots.appendChild(d);
      }

      targetLessonSelect.innerHTML = '';
      for(let i=0;i<pager.pages.length;i++){
        const opt=document.createElement('option');
        opt.value=String(i);
        opt.textContent=`Lesson ${i+1}`;
        if(i===pager.cur) opt.selected=true;
        targetLessonSelect.appendChild(opt);
      }

      syncLessonModeHelp();
      syncStagingVisibility();
    }

    function syncLessonModeHelp(){
      const type = document.getElementById('moduleType').value;
      pager.pages.forEach(p=>{
        const el = p.querySelector('[data-mode-help]');
        if(!el) return;
        if(type==='file'){ el.textContent='Attachments are staged below and assigned to a lesson via the dropdown.'; }
        else if(type==='text'){ el.textContent='Add links below and assign them to a lesson via the dropdown.'; }
        else { el.textContent='Text-only lesson (no uploads).'; }
      });
    }

    function addLesson(goNew=true){
      const idx=pager.pages.length;
      const page=buildLessonPage(idx);
      pager.pages.push(page);
      document.getElementById('lessonPager').appendChild(page);
      if(goNew) pager.cur=pager.pages.length-1;
      renderPager();
    }
    function removeCurrentLesson(){
      if(pager.pages.length<=1) return;
      const page=pager.pages[pager.cur];
      page.remove();
      pager.pages.splice(pager.cur,1);
      if(pager.cur>=pager.pages.length) pager.cur=pager.pages.length-1;
      renderPager();
    }

    document.getElementById('addLessonBtn').addEventListener('click',()=>addLesson(true));
    document.getElementById('removeLessonBtn').addEventListener('click',removeCurrentLesson);
    document.getElementById('prevBtn').addEventListener('click',()=>{ if(pager.cur>0){pager.cur--; renderPager();} });
    document.getElementById('nextBtn').addEventListener('click',()=>{ if(pager.cur<pager.pages.length-1){pager.cur++; renderPager();} });

    document.getElementById('moduleType').addEventListener('change', ()=>{
      syncLessonModeHelp();
      syncStagingVisibility();
      // Clear irrelevant inputs when switching mode
      if (moduleType.value === 'file') {
        linkInput.value = '';
        staged.addLinks = [];
      } else if (moduleType.value === 'text') {
        fileInput.value = '';
        staged.addFiles = [];
      } else { // textonly
        fileInput.value = '';
        linkInput.value = '';
        staged.addFiles = [];
        staged.addLinks = [];
      }
      renderAttachments();
    });

    // initialize with one lesson
    const moduleType = document.getElementById('moduleType');
    addLesson(false);
    renderPager();

    /* ===== Staging ===== */
    let staged = {
      addFiles: [],      // File[] (with __lesson:number)
      addLinks: []       // {url:string, lesson:number}[]
    };

    function badgeForType(att){
      if (att.type === 'link') return `<span class="badge-soft badge-link"><i class="bi bi-link-45deg"></i> Link</span>`;
      return `<span class="badge-soft badge-file"><i class="bi bi-file-earmark"></i> File</span>`;
    }
    function chip(text, cls=''){ return `<span class="badge-soft ${cls}" style="font-size:.72rem">${esc(text)}</span>`; }

    function getStagedView(){
      const out = [];
      for (const f of staged.addFiles) {
        out.push({ id:`__staged_file_${f.__uid}`, type:'file', __staged:true, __stagedName:f.name, lesson:f.__lesson });
      }
      for (const l of staged.addLinks) {
        out.push({ id:`__staged_link_${btoa(l.url).slice(0,12)}`, type:'link', __staged:true, __stagedName:l.url, url:l.url, lesson:l.lesson });
      }
      return out;
    }

    function renderAttachments(){
      const view = getStagedView();
      if (!view.length) {
        filesList.innerHTML = `<li class="text-muted">Nothing staged yet.</li>`;
        return;
      }
      filesList.innerHTML = view.map(att=>{
        const nameHtml = `<span>${esc(att.__stagedName || '')}</span>`;
        const left = `
          ${badgeForType(att)}
          <div class="file-name">
            <button type="button" class="btn btn-link p-0 align-baseline" data-act="preview" title="Preview">${nameHtml}</button>
          </div>
          ${chip('Lesson '+ String((att.lesson??0)+1))}
        `;
        let controls = `
          <button class="btn btn-outline-secondary btn-sm btn-icon" data-act="preview" title="Preview">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-outline-danger btn-sm btn-icon" data-act="unstage" title="Remove from staging">
            <i class="bi bi-x-lg"></i>
          </button>
        `;
        return `
          <li class="file-item" data-id="${esc(att.id)}" data-type="${att.type}">
            ${left}
            ${chip('Staged','badge-stage')}
            <div class="d-flex align-items-center gap-1">${controls}</div>
          </li>
        `;
      }).join('');
    }

    filesList.addEventListener('click', (e)=>{
      const li = e.target.closest('.file-item'); if (!li) return;
      const id = li.getAttribute('data-id');
      const type = li.getAttribute('data-type');
      const item = getStagedView().find(x => x.id === id);
      if (!item) return;

      if (e.target.closest('[data-act="preview"]')) {
        if (type === 'link') {
          openPreviewModalWithMeta({ url: item.__stagedName, title: item.__stagedName, mime:'', isStaged:true });
          return;
        }
        if (type === 'file') {
          const file = staged.addFiles.find(f => `__staged_file_${f.__uid}` === id);
          if (!file) return showInfo('Preview','Cannot preview this staged file.');
          const url = URL.createObjectURL(file); currentPreviewRevoke = ()=>URL.revokeObjectURL(url);
          openPreviewModalWithMeta({ url, title:file.name, mime:file.type||'', isStaged:true });
          return;
        }
      }

      if (e.target.closest('[data-act="unstage"]')) {
        if (type === 'file') staged.addFiles = staged.addFiles.filter(f => `__staged_file_${f.__uid}` !== id);
        if (type === 'link') {
          const it = getStagedView().find(x => x.id === id);
          if (it?.__stagedName) staged.addLinks = staged.addLinks.filter(l => l.url !== it.__stagedName);
        }
        renderAttachments();
      }
    });

    /* Pre-stage preview buttons */
    btnPreviewSelectedFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType.value !== 'file') return;
      const files = fileInput.files;
      if (!files || !files.length) { showInfo('Nothing selected','Choose one or more files first.'); return; }
      const f = files[0];
      const blobUrl = URL.createObjectURL(f);
      currentPreviewRevoke = ()=>URL.revokeObjectURL(blobUrl);
      openPreviewModalWithMeta({
        url: blobUrl, title: f.name, mime: f.type || '', isStaged:true,
        stageContext: { mode:'file', files: Array.from(files) }
      });
    });

    btnPreviewLink.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType.value !== 'text') return;
      const val = (linkInput.value || '').trim();
      if (!val) { showInfo('No link entered','Paste a URL first.'); return; }
      openPreviewModalWithMeta({
        url: val, title: val, mime:'',
        stageContext: { mode:'link', url: val }
      });
    });

    /* Stage buttons */
    btnStageFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType.value !== 'file') return;
      const files = fileInput.files;
      if (!files || !files.length) { showInfo('Nothing to Stage','Please choose one or more files.'); return; }
      const tooBig = Array.from(files).find(f => f.size > TEACHER_MAX_BYTES);
      if (tooBig) { showInfo('Too large', `${esc(tooBig.name)} exceeds ${TEACHER_MAX_MB} MB.`); return; }
      const tgt = Number(targetLessonSelect.value || 0);
      Array.from(files).forEach(f => { f.__uid = Math.random().toString(36).slice(2,10); f.__lesson = tgt; staged.addFiles.push(f); });
      fileInput.value = '';
      renderAttachments();
      showInfo('Staged','File(s) are staged and will be uploaded on Upload.');
    });

    btnStageLink.addEventListener('click', (e)=>{
      e.preventDefault();
      if (moduleType.value !== 'text') return;
      const val = (linkInput.value || '').trim();
      if (!val) { showInfo('No Link','Please paste a URL.'); return; }
      const tgt = Number(targetLessonSelect.value || 0);
      staged.addLinks.push({ url: val, lesson: tgt });
      linkInput.value = '';
      renderAttachments();
      showInfo('Staged','Link will be added on Upload.');
    });

    /* Auto pre-preview when selecting one file */
    fileInput.addEventListener('change', ()=>{
      if (moduleType.value !== 'file') return;
      const fs = fileInput.files;
      if (fs && fs.length === 1) {
        const f = fs[0];
        if (f.size > TEACHER_MAX_BYTES) { showInfo('Too large', `${esc(f.name)} exceeds ${TEACHER_MAX_MB} MB.`); return; }
        const blobUrl = URL.createObjectURL(f);
        currentPreviewRevoke = ()=>URL.revokeObjectURL(blobUrl);
        openPreviewModalWithMeta({
          url: blobUrl, title: f.name, mime: f.type||'', isStaged:true,
          stageContext: { mode:'file', files: [f] }
        });
      }
    });

    /* ===== Publish UI logic ===== */
    function syncPublishControls(){
      const schedule = pubScheduleRadio.checked;
      publishAtInput.disabled = !schedule;
      syncSubmitLabel();
    }
    function syncSubmitLabel(){
      const schedule = pubScheduleRadio.checked;
      submitText.textContent = schedule ? "Upload & Schedule" : "Upload & Publish";
    }
    pubNowRadio.addEventListener('change', syncPublishControls);
    pubScheduleRadio.addEventListener('change', syncPublishControls);
    syncPublishControls();

    /* ===== Staging visibility rules ===== */
    function syncStagingVisibility(){
      const t = moduleType.value;
      if (t === 'file') {
        stagingCard.style.display = '';
        fileSection.style.display = '';
        linkSection.style.display = 'none';
      } else if (t === 'text') {
        stagingCard.style.display = '';
        fileSection.style.display = 'none';
        linkSection.style.display = '';
      } else { // textonly
        stagingCard.style.display = 'none';
      }
    }

    /* ===== Submit (upload) ===== */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      formError.textContent = "";

      if (!courseId) { formError.textContent = "Missing courseId in URL."; return; }

      const title    = (document.getElementById("moduleTitle").value || '').trim();
      const mode     = moduleType.value;
      const pubMode  = document.querySelector('input[name="pubMode"]:checked')?.value || 'now';
      const schedule = (pubMode === 'schedule');

      if (!title) { formError.textContent = "Please enter a Module Title."; return; }

      // Gather lessons
      const subTitles = [];
      const subDescs  = [];
      pager.pages.forEach(p=>{
        subTitles.push(p.querySelector('.lesson-subtitle').value || '');
        subDescs.push(p.querySelector('.lesson-content').value || '');
      });

      // Gather assigned classes
      const assigned = Array.from(document.querySelectorAll("#assignedClassesContainer input[type='checkbox']:checked")).map(i => i.value);
      if (!assigned.length) { formError.textContent = "Please select at least one class."; return; }

      // Validate based on mode
      if (mode === 'file') {
        const tooLarge = staged.addFiles.find(f => f.size > TEACHER_MAX_BYTES);
        if (tooLarge) { formError.textContent = `Each file must be ≤ ${TEACHER_MAX_MB} MB. Too large: ${tooLarge.name}`; return; }
        if (!staged.addFiles.length) { formError.textContent = "Please stage at least one file."; return; }
      } else if (mode === 'text') {
        if (!staged.addLinks.length) { formError.textContent = "Please stage at least one link."; return; }
      }

      // Validate publishAt if scheduled
      let publishAtISO = "";
      if (schedule) {
        const raw = publishAtInput.value;
        if (!raw) { formError.textContent = "Please choose a publish date/time."; return; }
        const dt = new Date(raw);
        if (isNaN(dt.getTime())) { formError.textContent = "Invalid publish date/time."; return; }
        const now = Date.now();
        if (dt.getTime() < now + 60 * 1000) { formError.textContent = "Publish time must be in the future."; return; }
        publishAtISO = dt.toISOString();
      }

      const fd = new FormData();
      fd.append('moduleTitle', title);
      fd.append('moduleType', mode);
      fd.append('courseId', courseId);
      // For immediate publish, published=true. For schedule, published=false + publishAt
      fd.append('published', String(!schedule));
      if (schedule) fd.append('publishAt', publishAtISO);

      subTitles.forEach(v => fd.append('moduleSubTitles', v));
      subDescs.forEach(v => fd.append('moduleSubDescs', v));
      assigned.forEach(id => fd.append('assignedClasses', id));

      if (mode === 'file' && staged.addFiles.length) {
        staged.addFiles.forEach(f => fd.append('attachmentFiles', f));
        staged.addFiles.forEach(f => fd.append('attachmentLessonIdx', String(f.__lesson || 0)));
        staged.addFiles.forEach(_ => fd.append('attachmentDescs', ''));
      }
      if (mode === 'text' && staged.addLinks.length) {
        staged.addLinks.forEach(l => fd.append('videoUrls', l.url));
        staged.addLinks.forEach(l => fd.append('videoLessonIdx', String(l.lesson || 0)));
        staged.addLinks.forEach(_ => fd.append('videoDesc', ''));
      }

      // UI lock
      submitBtn.disabled = true;
      spinner.classList.remove("visually-hidden");
      submitText.textContent = schedule ? "Uploading & Scheduling…" : "Uploading & Publishing…";

      try {
        const res = await fetch(toApiUrl('/api/upload-module'), { method: "POST", body: fd });
        let js = {}; try { js = await res.json(); } catch {}
        if (!res.ok || js.success === false) {
          const msg = (js && (js.message || js.error)) || `HTTP ${res.status}`;
          formError.textContent = msg || "Failed to upload module.";
          return;
        }
        showInfo('Success', schedule
          ? '✅ Module uploaded and scheduled.'
          : '✅ Module uploaded and published!'
        );
        setTimeout(()=>{ window.location.href = `/TEACHER/modules/module_list.html?courseId=${encodeURIComponent(courseId)}`; }, 900);
      } catch (err) {
        console.error(err);
        formError.textContent = "Server error while uploading module.";
      } finally {
        submitBtn.disabled = false;
        spinner.classList.add("visually-hidden");
        syncPublishControls();
      }
    });

    // First-time visibility and data
    syncStagingVisibility();
    renderAttachments();
    loadClasses();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
