<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EduConnect Teacher – Submission Inbox</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Global teacher styles -->
  <link rel="stylesheet" href="../dashboard/dashboard.css"/>

  <style>
    :root{
      --bg:#f6f8fa;--text:#1f2328;--muted:#6a737d;--card:#fff;--border:#e5e7eb;
      --brand-dark-1:#4A1A0C;--brand-dark-2:#7A2810;--accent-1:#FF6A00;--accent-2:#B03C10;
      --radius:14px;
    }
    html,body{height:100%;background:var(--bg);color:var(--text)}
    .dashboard{display:flex;min-height:100vh}
    .main{margin-left:70px;width:calc(100% - 70px);transition:margin-left .3s ease,width .3s ease;display:flex;flex-direction:column}
    .sidebar:hover ~ .main{margin-left:220px;width:calc(100% - 220px)}

    .header-top{background:linear-gradient(to bottom,var(--brand-dark-1),var(--brand-dark-2));color:#fff}
    .logo-header{height:45px}
    .search-box{position:relative;flex:1;max-width:520px;margin:0 20px}
    .search-box input{border-radius:30px}

    /* Table + status */
    .table thead th{background:#fafbfc;border-bottom:1px solid var(--border)}
    .status-pill{padding:3px 10px;border-radius:999px;font-size:.75rem;display:inline-block;border:1px solid transparent}
    .status-ontime{background:#e6f4ea;color:#1e7e34;border-color:#c6e6cf}
    .status-late{background:#fff2f0;color:#b42318;border-color:#ffd1cc}
    .status-graded{background:#eff6ff;color:#1d4ed8;border-color:#c7dbff}

    .whitespace-prewrap{white-space:pre-wrap}

    /* UI Card (meta + actions + controls) */
    .ui-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden}
    .ui-card-head{
      display:flex;justify-content:space-between;align-items:center;
      background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2));
      color:#FFD8A9;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.1)
    }
    .ui-card-title{margin:0;font-size:1.05rem;font-weight:700;display:flex;gap:.5rem;align-items:center;color:#ffe9ca}
    .ui-card-body{padding:12px 16px}
    .brand-grad{font-size:.95rem;color:#5b2a18}
    .ui-actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn-outline-light{
      --bs-btn-color:#fff;--bs-btn-border-color:rgba(255,255,255,.65);
      --bs-btn-hover-bg:rgba(255,255,255,.12);--bs-btn-hover-color:#fff;--bs-btn-hover-border-color:#fff
    }
    .meta-pill{
      background:#fff;border:1px solid var(--border);
      border-radius:999px;padding:.2rem .6rem;font-size:.75rem;color:#374151
    }

    /* Control polish */
    .form-label{margin-bottom:.25rem;font-weight:600}
    .ui-controls .form-select, .ui-controls .form-control{height:40px}
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box position-relative">
          <input id="searchInput" type="text" class="form-control" placeholder="Search (student, title, module, class)…"/>
          <i class="fas fa-search position-absolute" style="top:50%; right:15px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none" onclick="logoutUser()">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold">Teacher</span>
        </button>
      </header>

      <!-- Page -->
      <section class="content container-fluid p-4 mt-4">
        <h1 class="fw-bold page-title mb-3">Assignment Submission Inbox</h1>

        <!-- UI-CARD: actions + controls + meta -->
        <div class="ui-card mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-inbox"></i> Your Submission Inbox</h2>
            <div class="ui-actions">
              <button class="btn btn-outline-light" id="viewGradedBtn">
                <i class="bi bi-check2-square"></i> View Graded
              </button>
            </div>
          </div>

          <div class="ui-card-body">
            <!-- Row 1: Sort -->
            <div class="row g-2 ui-controls align-items-end mb-2">
              <div class="col-12 col-md-4 col-lg-3">
                <label for="sortBy" class="form-label">Sort</label>
                <select id="sortBy" class="form-select" aria-label="Sort submissions">
                  <option value="submitted_desc" selected>Newest submitted</option>
                  <option value="submitted_asc">Oldest submitted</option>
                  <option value="student_az">Student A → Z</option>
                  <option value="class_az">Class A → Z</option>
                  <option value="module_az">Module A → Z</option>
                  <option value="assignment_az">Assignment A → Z</option>
                  <option value="due_asc">Due soonest</option>
                  <option value="due_desc">Due latest</option>
                  <option value="status">Status (late → graded)</option>
                </select>
              </div>
            </div>

            <!-- Row 2: Filters (apply immediately) -->
            <div class="row g-3 ui-controls align-items-end">
              <div class="col-sm-3">
                <label for="filterClass" class="form-label">Class</label>
                <select id="filterClass" class="form-select">
                  <option value="">All Classes</option>
                </select>
              </div>
              <div class="col-sm-3">
                <label for="filterModule" class="form-label">Module</label>
                <select id="filterModule" class="form-select">
                  <option value="">All Modules</option>
                </select>
              </div>
              <div class="col-sm-3">
                <label for="filterDue" class="form-label">Due Date</label>
                <input type="date" id="filterDue" class="form-control" placeholder="dd/mm/yyyy"/>
              </div>
              <div class="col-sm-3">
                <label for="filterStatus" class="form-label">Status</label>
                <select id="filterStatus" class="form-select">
                  <option value="">All Statuses</option>
                  <option value="on-time">On-time</option>
                  <option value="late">Late</option>
                  <option value="graded">Graded</option>
                </select>
              </div>
            </div>

            <!-- Meta line -->
            <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
              <div class="brand-grad fw-semibold" id="assignmentMetaText">—</div>
              <span class="meta-pill" id="summaryText">—</span>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="submissionTable">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>Class</th>
                <th>Module</th>
                <th>Assignment</th>
                <th>Submitted At</th>
                <th>Due At</th>
                <th>Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="8" class="text-center text-muted py-4">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- View Submission Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-1"></i> Submission Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <div class="fw-semibold" id="vmStudentName">Student</div>
            <div class="small text-muted" id="vmMeta">—</div>
          </div>
          <hr>
          <div id="vmStatusBadge" class="mb-2"></div>
          <div id="vmFiles" class="mb-3"></div>
          <div id="vmNote" class="mb-3"></div>
          <div id="vmGrade" class="mb-1"></div>
        </div>
        <div class="modal-footer">
          <button class="btn-delete" id="vmDeleteBtn"><i class="bi bi-trash me-1"></i> Delete</button>
          <button class="btn btn-primary" id="vmGradeBtn"><i class="bi bi-check2-square me-1"></i> Grade</button>
          <button class="btn-close-footer" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Grade Modal -->
  <div class="modal fade" id="gradeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="gradeForm">
        <div class="modal-header">
          <h5 class="modal-title">Grade Submission</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2"><strong id="gradeStudentName">Student</strong></div>
          <div class="mb-3">
            <label class="form-label" id="gradeLabel">Grade</label>
            <input type="number" min="0" step="1" id="gradeInput" class="form-control" placeholder="e.g., 95" required/>
            <div id="gradeHelp" class="form-text"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Feedback (optional)</label>
            <textarea id="feedbackInput" class="form-control" rows="3" placeholder="Short feedback…"></textarea>
          </div>
          <input type="hidden" id="gradeAssignmentId"/>
          <input type="hidden" id="gradeStudentId"/>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Grade</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmYesBtn">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        });
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Page Logic -->
  <script>
    const API = "http://localhost:5000";

    /* ---------- Auth ---------- */
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user || !user.userId || !user.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
    } else {
      document.getElementById("Username").textContent = user.username || "Teacher";
    }
    function logoutUser(){ localStorage.clear(); sessionStorage.clear(); window.location.href="/TEACHER/login/login.html"; }
    window.logoutUser = logoutUser;

    /* ---------- Params ---------- */
    const url = new URL(location.href);
    const courseId = url.searchParams.get('courseId') || '';
    const assignmentId = url.searchParams.get('assignmentId') || '';
    if (!assignmentId || !courseId) location.href = '/TEACHER/assignment/assignments.html';

    /* ---------- DOM refs ---------- */
    const elSearch   = document.getElementById('searchInput');
    const elClass    = document.getElementById('filterClass');
    const elModule   = document.getElementById('filterModule');
    const elDue      = document.getElementById('filterDue');
    const elStatus   = document.getElementById('filterStatus');
    const elBody     = document.getElementById('tableBody');
    const elSummary  = document.getElementById('summaryText');
    const elMeta     = document.getElementById('assignmentMetaText');
    const viewGradedBtn = document.getElementById('viewGradedBtn');
    const elSortBy   = document.getElementById('sortBy');

    /* ---------- State ---------- */
    let assignmentMeta = null; // { title, points, dueAt, moduleNumber, ... }
    let moduleTitle = '—';
    let submissions = [];
    let filtered = [];

    /* ---------- Modal helpers ---------- */
    function showInfoModal(message, title = 'Notice') {
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').textContent = message;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('infoModal')).show();
    }
    function showConfirmModal(message, title = 'Confirm') {
      return new Promise(resolve => {
        const modalEl = document.getElementById('confirmModal');
        document.getElementById('confirmModalLabel').textContent = title;
        document.getElementById('confirmModalBody').textContent = message;

        const yesBtn = document.getElementById('confirmYesBtn');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        function cleanup() {
          yesBtn.removeEventListener('click', onYes);
          modalEl.removeEventListener('hidden.bs.modal', onHide);
        }
        function onYes() {
          cleanup();
          resolve(true);
          modal.hide();
        }
        function onHide() {
          cleanup();
          resolve(false);
        }

        yesBtn.addEventListener('click', onYes, { once: true });
        modalEl.addEventListener('hidden.bs.modal', onHide, { once: true });

        modal.show();
      });
    }

    /* ---------- Utils ---------- */
    function escapeHTML(str=''){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
    function tsToMs(ts){
      if (!ts) return null;
      if (typeof ts === 'number') return ts;
      if (typeof ts === 'string') { const d=Date.parse(ts); return Number.isNaN(d)?null:d; }
      if (typeof ts?.toMillis === 'function') return ts.toMillis();
      const s = ts._seconds ?? ts.seconds; const ns = ts._nanoseconds ?? ts.nanoseconds ?? 0;
      if (typeof s === 'number') return (s*1000)+Math.floor(ns/1e6);
      return null;
    }
    function toDate(v){ const ms = tsToMs(v); if (ms==null) return null; const d=new Date(ms); return Number.isNaN(d.getTime())?null:d; }
    function fmt(dt){ if (!dt) return '—'; const d=dt instanceof Date?dt:new Date(dt); return isNaN(d.getTime())?'—':d.toLocaleString(); }
    function toApiUrl(pathOrUrl){ return /^https?:\/\//i.test(String(pathOrUrl)) ? String(pathOrUrl) : API + String(pathOrUrl || ""); }

    // Status helpers
    function computeStatus(row){
      if (row.grade != null) return 'graded';
      if (!row.submittedAt || !row.dueAt) return 'on-time';
      return row.submittedAt.getTime() <= row.dueAt.getTime() ? 'on-time' : 'late';
    }
    // Sorting by status: Late → On-time → Graded
    // Sorting by status: Late → On-time (graded not sorted)
    function statusRank(s){
      return s === 'late' ? 0 : (s === 'on-time' ? 1 : 2); // 'graded' will not be sorted specially
    }

    function statusPill(s){
      const map = { 'graded':'status-graded', 'late':'status-late', 'on-time':'status-ontime' };
      const cls = map[s] || 'status-ontime';
      const txt = s === 'graded' ? 'Graded' : s === 'late' ? 'Late' : 'On-time';
      return `<span class="status-pill ${cls}">${txt}</span>`;
    }

    // Class name cache
    const classNameById = new Map();
    async function getClassName(classId) {
      if (!classId) return '—';
      if (classNameById.has(classId)) return classNameById.get(classId);
      try {
        const resp = await fetch(`${API}/api/classes/${encodeURIComponent(classId)}`);
        const js = await resp.json();
        let label = '—';
        if (resp.ok && js) {
          const c = js.class || js;
          const parts = [c.name || c.title, c.section].filter(Boolean);
          label = parts.length ? parts.join(' • ') : (c.name || c.title || classId);
        }
        classNameById.set(classId, label);
        return label;
      } catch {
        classNameById.set(classId, classId);
        return classId;
      }
    }

    // Load assignment meta
    async function loadAssignmentMeta(){
      const r = await fetch(`${API}/api/courses/${encodeURIComponent(courseId)}/assignments`);
      if (!r.ok) return null;
      const js = await r.json();
      if (!js?.success || !Array.isArray(js.assignments)) return null;
      const a = js.assignments.find(x=>x.id===assignmentId) || null;
      if (!a) return null;
      moduleTitle = (typeof a.moduleNumber === 'number') ? `Module ${a.moduleNumber}` : '—';
      return a;
    }

    // Load submissions for this assignment (keep classId, set placeholder className)
    async function loadSubmissions(){
      try {
        const resp = await fetch(`${API}/api/assignments/${encodeURIComponent(assignmentId)}/submissions`);
        if (!resp.ok) return [];
        const js = await resp.json();
        if (!js.success || !Array.isArray(js.submissions)) return [];

        const dueAt = toDate(assignmentMeta?.dueAt);
        return js.submissions.map(s => {
          const submittedAt = toDate(s?.submittedAt) || toDate(s?.createdAt);
          const classId = s.classId || s.classID || s.class || null;

          const item = {
            studentId   : s.studentId,
            studentName : s.studentName || s.studentId,
            classId     : classId,
            className   : s.className || (classId ? 'Loading…' : '—'),
            assignmentId,
            assignmentTitle: assignmentMeta?.title || 'Untitled',
            moduleTitle : moduleTitle,
            submittedAt,
            dueAt,
            grade       : (typeof s.grade === 'number') ? s.grade : null,
            feedback    : s.feedback || '',
            text        : s.text || '',
            files       : Array.isArray(s.files) ? s.files : [],
          };
          item._status = computeStatus(item);
          item.maxPoints = (typeof assignmentMeta?.points === 'number') ? assignmentMeta.points : null;
          return item;
        });
      } catch {
        return [];
      }
    }

    // Resolve missing class names, refresh filters + table
    async function resolveMissingClassNames(list){
      const promises = [];
      for (const row of list) {
        const needsLookup =
          row && row.classId &&
          (!row.className || row.className === '—' || row.className === 'Loading…');
        if (needsLookup) {
          promises.push(
            getClassName(row.classId).then(name => { row.className = name || '—'; })
          );
        }
      }
      if (!promises.length) return;
      await Promise.all(promises);
      populateFilters(submissions);
      applyFilters();
    }

    // Filters
    function populateFilters(list){
      const classSet = new Set(), moduleSet = new Set();
      list.forEach(x => {
        if (x.className && x.className !== '—' && x.className !== 'Loading…') classSet.add(x.className);
        if (x.moduleTitle && x.moduleTitle !== '—') moduleSet.add(x.moduleTitle);
      });
      document.getElementById('filterClass').innerHTML =
        `<option value="">All Classes</option>` +
        [...classSet].sort().map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join('');
      document.getElementById('filterModule').innerHTML =
        `<option value="">All Modules</option>` +
        [...moduleSet].sort().map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join('');
    }

    function applyFilters(){
      const q = (elSearch.value || '').toLowerCase().trim();
      const fClass = elClass.value;
      const fModule = elModule.value;
      const fDue = elDue.value; // yyyy-mm-dd
      const fStatus = elStatus.value; // '', 'on-time', 'late', 'graded'
      const sort = (elSortBy?.value) || 'submitted_desc';

      filtered = submissions.filter(s => {
        if (q){
          const hay = `${s.studentName} ${s.assignmentTitle} ${s.moduleTitle} ${s.className}`.toLowerCase();
          if (!hay.includes(q)) return false;
        }
        if (fClass && s.className !== fClass) return false;
        if (fModule && s.moduleTitle !== fModule) return false;
        if (fDue && s.dueAt){
          const yyyy = s.dueAt.getFullYear();
          const mm = String(s.dueAt.getMonth()+1).padStart(2,'0');
          const dd = String(s.dueAt.getDate()).padStart(2,'0');
          if (`${yyyy}-${mm}-${dd}` !== fDue) return false;
        } else if (fDue && !s.dueAt){
          return false;
        }
        if (fStatus){
          if (fStatus === 'on-time' && s._status !== 'on-time') return false;
          if (fStatus === 'late' && s._status !== 'late') return false;
          if (fStatus === 'graded' && s._status !== 'graded') return false;
        }
        return true;
      });

      // Sorting
      filtered.sort((a,b)=>{
        const subA = a.submittedAt?.getTime()||0, subB = b.submittedAt?.getTime()||0;
        const dueA = a.dueAt?.getTime()||0,       dueB = b.dueAt?.getTime()||0;

        if (sort === 'submitted_asc')  return subA - subB;
        if (sort === 'student_az')     return (a.studentName||'').localeCompare(b.studentName||'');
        if (sort === 'class_az')       return (a.className||'').localeCompare(b.className||'');
        if (sort === 'module_az')      return (a.moduleTitle||'').localeCompare(b.moduleTitle||'');
        if (sort === 'assignment_az')  return (a.assignmentTitle||'').localeCompare(b.assignmentTitle||'');
        if (sort === 'due_asc')        return (dueA || Number.MAX_SAFE_INTEGER) - (dueB || Number.MAX_SAFE_INTEGER);
        if (sort === 'due_desc')       return (dueB || 0) - (dueA || 0);
        if (sort === 'status') {
          // Only sort 'late' and 'on-time', leave 'graded' in place
          const rankA = statusRank(a._status);
          const rankB = statusRank(b._status);
          if (a._status === 'graded' && b._status === 'graded') return 0;
          if (a._status === 'graded') return 1;
          if (b._status === 'graded') return -1;
          return rankA - rankB;
        }
        /* default: newest submitted first */
        return subB - subA || (dueA - dueB);
      });

      renderTable();
      const gradedCount = filtered.filter(x => x._status === 'graded').length;
      const lateCount = filtered.filter(x => x._status === 'late').length;
      const ontimeCount = filtered.filter(x => x._status === 'on-time').length;
      elSummary.textContent = `${filtered.length} shown • ${gradedCount} graded • ${ontimeCount} on-time • ${lateCount} late`;
    }

    function renderTable(){
      if (!filtered.length){
        elBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No submissions yet for this assignment.</td></tr>`;
        return;
      }
      elBody.innerHTML = filtered.map(s => `
        <tr data-assignment-id="${escapeHTML(s.assignmentId)}" data-student-id="${escapeHTML(s.studentId)}">
          <td>${escapeHTML(s.studentName)}</td>
          <td>${escapeHTML(s.className)}</td>
          <td>${escapeHTML(s.moduleTitle)}</td>
          <td>${escapeHTML(s.assignmentTitle)}</td>
          <td>${escapeHTML(fmt(s.submittedAt))}</td>
          <td>${escapeHTML(fmt(s.dueAt))}</td>
          <td>${statusPill(s._status)}</td>
          <td class="text-center">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-sm btn-outline-secondary view-btn">
                <i class="bi bi-eye me-1"></i> View
              </button>
              <button class="btn btn-success grade-btn"><i class="bi bi-check2-square"></i> Grade</button>
            </div>
          </td>
        </tr>
      `).join('');

      // Wire row actions
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const aId = tr.getAttribute('data-assignment-id');
          const sId = tr.getAttribute('data-student-id');
          const row = filtered.find(x => x.assignmentId === aId && x.studentId === sId);
          openViewModal(row);
        });
      });
      document.querySelectorAll('.grade-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const aId = tr.getAttribute('data-assignment-id');
          const sId = tr.getAttribute('data-student-id');
          const row = filtered.find(x => x.assignmentId === aId && x.studentId === sId);
          openGradeModal(row);
        });
      });
    }

    // -------- Modals & actions --------
    const viewModalEl   = document.getElementById('viewModal');
    const gradeModalEl  = document.getElementById('gradeModal');

    function vm(){ return bootstrap.Modal.getOrCreateInstance(viewModalEl); }
    function gm(){ return bootstrap.Modal.getOrCreateInstance(gradeModalEl); }

    const vmStudentName = document.getElementById('vmStudentName');
    const vmMeta        = document.getElementById('vmMeta');
    const vmStatusBadge = document.getElementById('vmStatusBadge');
    const vmFiles       = document.getElementById('vmFiles');
    const vmNote        = document.getElementById('vmNote');
    const vmGrade       = document.getElementById('vmGrade');
    const vmDeleteBtn   = document.getElementById('vmDeleteBtn');
    const vmGradeBtn    = document.getElementById('vmGradeBtn');

    const gradeStudentNameEl = document.getElementById('gradeStudentName');
    const gradeLabelEl       = document.getElementById('gradeLabel');
    const gradeHelpEl        = document.getElementById('gradeHelp');
    const gradeInputEl       = document.getElementById('gradeInput');
    const feedbackInputEl    = document.getElementById('feedbackInput');
    const gradeAssignmentIdEl= document.getElementById('gradeAssignmentId');
    const gradeStudentIdEl   = document.getElementById('gradeStudentId');

    function buildStatusBadge(item){
      const isGraded = typeof item.grade === 'number';
      const isLate = item.dueAt && item.submittedAt && (item.submittedAt > item.dueAt);
      const label = isGraded ? 'Graded' : (isLate ? 'Late' : 'On-time');
      const cls   = isGraded ? 'bg-primary' : (isLate ? 'bg-danger' : 'bg-success');
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function openViewModal(item){
      if (!item) return;

      vmStudentName.textContent = item.studentName || item.studentId || '—';
      const metaParts = [
        item.assignmentTitle || 'Untitled',
        item.moduleTitle && item.moduleTitle !== '—' ? item.moduleTitle : null,
        item.className || null,
        `Submitted: ${fmt(item.submittedAt)}`,
        item.dueAt ? `Due: ${fmt(item.dueAt)}` : null,
      ].filter(Boolean);
      vmMeta.textContent = metaParts.join(' • ');

      vmStatusBadge.innerHTML = buildStatusBadge(item);

      // Files
      if (item.files && item.files.length){
        const fileLis = item.files.map(f => {
          const name = escapeHTML(f.originalName || (f.filePath || '').split('/').pop() || 'file');
          const href = f.filePath ? toApiUrl(f.filePath) : '#';
          const sizeTxt = f.size ? ` (${Math.round(f.size / 1024)} KB)` : '';
          return `<li class="mb-1"><a href="${href}" target="_blank" rel="noopener">${name}</a>${sizeTxt}</li>`;
        }).join('');

        vmFiles.innerHTML = `
          <div class="fw-semibold mb-1"><i class="bi bi-paperclip"></i> Files</div>
          <ul class="ps-3 mb-0">${fileLis}</ul>`;
      } else {
        vmFiles.innerHTML = `
          <div class="fw-semibold mb-1"><i class="bi bi-paperclip"></i> Files</div>
          <div class="text-muted">—</div>`;
      }

      // Note
      vmNote.innerHTML = `
        <div class="fw-semibold mb-1"><i class="bi bi-chat-left-text"></i> Student Note</div>
        <div class="whitespace-prewrap">${escapeHTML(item.text || '').trim() || '—'}</div>`;

      // Grade
      const maxPts = (typeof item.maxPoints === 'number') ? item.maxPoints : null;
      if (typeof item.grade === 'number'){
        vmGrade.innerHTML = `<div class="fw-semibold">Score: ${item.grade}${maxPts != null ? ` / ${maxPts}` : ''}</div>`;
      } else {
        vmGrade.innerHTML = `<div class="text-muted">Not graded</div>`;
      }

      // Actions
      vmDeleteBtn.onclick = () => deleteSubmission(item);
      vmGradeBtn.onclick  = () => {
        openGradeModal(item);
        vm().hide();
      };

      vm().show();
    }

    function openGradeModal(item){
      if (!item) return;
      const maxPts = (typeof item.maxPoints === 'number') ? item.maxPoints : null;
      gradeStudentNameEl.textContent = item.studentName || item.studentId;
      gradeLabelEl.textContent = maxPts!=null ? `Grade (0–${maxPts})` : 'Grade';
      gradeHelpEl.textContent  = maxPts!=null ? `Enter a score between 0 and ${maxPts}.` : 'Enter points.';
      gradeInputEl.value       = (typeof item.grade === 'number') ? item.grade : '';
      feedbackInputEl.value    = item.feedback || '';
      gradeAssignmentIdEl.value= item.assignmentId;
      gradeStudentIdEl.value   = item.studentId;

      gm().show();
    }

    // Save grade
    document.getElementById('gradeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const aId = gradeAssignmentIdEl.value;
      const sId = gradeStudentIdEl.value;
      const grade = Number(gradeInputEl.value);
      const feedback = feedbackInputEl.value.trim();
      if (Number.isNaN(grade)) { showInfoModal('Please enter a valid grade.', 'Invalid Grade'); return; }

      try{
        const res = await fetch(`${API}/api/assignments/${encodeURIComponent(aId)}/submissions/${encodeURIComponent(sId)}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ grade, feedback })
        });
        const js = await res.json();
        if (!res.ok || js.success === false) throw new Error(js.message || `HTTP ${res.status}`);

        const updateLocal = (arr) => {
          const idx = arr.findIndex(x => x.assignmentId === aId && x.studentId === sId);
          if (idx >= 0){
            arr[idx].grade = grade;
            arr[idx].feedback = feedback;
            arr[idx]._status = 'graded';
          }
        };
        updateLocal(submissions);
        updateLocal(filtered);

        applyFilters();
        bootstrap.Modal.getOrCreateInstance(gradeModalEl).hide();
        showInfoModal('Grade saved successfully.', 'Saved');
      }catch(err){
        console.error(err);
        showInfoModal('Failed to save grade. ' + (err.message || 'Unknown error'), 'Error');
      }
    });

    // Delete submission
    async function deleteSubmission(item){
      const ok = await showConfirmModal(
        'Delete this submission? This will allow the student to resubmit.',
        'Delete Submission'
      );
      if (!ok) return;

      try{
        const res = await fetch(`${API}/api/assignments/${encodeURIComponent(item.assignmentId)}/submissions/${encodeURIComponent(item.studentId)}`, {
          method:'DELETE'
        });
        const js = await res.json().catch(()=>({success: res.ok}));
        if (!res.ok || js.success === false) throw new Error(js.message || `HTTP ${res.status}`);

        submissions = submissions.filter(x => !(x.assignmentId === item.assignmentId && x.studentId === item.studentId));
        filtered    = filtered.filter(x => !(x.assignmentId === item.assignmentId && x.studentId === item.studentId));
        applyFilters();

        const inst = bootstrap.Modal.getInstance(viewModalEl) || bootstrap.Modal.getOrCreateInstance(viewModalEl);
        inst.hide();

        showInfoModal('Submission deleted.', 'Deleted');
      }catch(err){
        console.error(err);
        showInfoModal('Failed to delete submission. ' + (err.message || 'Unknown error'), 'Error');
      }
    }

    /* ---------- Events (apply immediately) ---------- */
    elSearch.addEventListener('input', applyFilters);
    elSortBy.addEventListener('change', applyFilters);
    elClass.addEventListener('change', applyFilters);
    elModule.addEventListener('change', applyFilters);
    elStatus.addEventListener('change', applyFilters);
    elDue.addEventListener('change', applyFilters);
    elDue.addEventListener('input', applyFilters);

    viewGradedBtn.addEventListener('click', () => {
      const params = new URLSearchParams();
      params.set('courseId', courseId);
      params.set('assignmentId', assignmentId);
      window.location.href = `/TEACHER/assignment/graded.html?${params.toString()}`;
    });

    /* ---------- Boot ---------- */
    (async function boot(){
      try{
        assignmentMeta = await loadAssignmentMeta();
        const dueStr = assignmentMeta?.dueAt ? new Date(tsToMs(assignmentMeta.dueAt)).toLocaleString() : 'N/A';
        const modLabel = (typeof assignmentMeta?.moduleNumber === 'number') ? ` • Module ${assignmentMeta.moduleNumber}` : '';
        const pts = (typeof assignmentMeta?.points === 'number') ? ` • ${assignmentMeta.points} pts` : '';
        elMeta.textContent = `${assignmentMeta?.title || 'Untitled'}${modLabel}${pts} • Due: ${dueStr}`;
      }catch{}

      try{
        submissions = await loadSubmissions();
        populateFilters(submissions);   // fill Class/Module lists
        applyFilters();                 // initial paint
        resolveMissingClassNames(submissions); // async enrich class names then refresh
      }catch(e){
        console.error(e);
        elBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Failed to load submissions.</td></tr>`;
        elSummary.textContent = 'Failed to load.';
      }
    })();
  </script>
</body>
</html>
