<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EduConnect Teacher – Submission Inbox</title>

  <!-- (Optional) If your backend is on another Railway service/domain, set it here -->
  <!-- <meta name="api-base" content="https://your-backend.up.railway.app"> -->

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Global teacher styles -->
  <link rel="stylesheet" href="grade.css"/>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="searchInput" type="text" class="form-control" placeholder="Search (student, title, module, class)…"/>
          <i class="fas fa-search position-absolute" style="top:50%; right:15px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none" onclick="logoutUser()">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold">T</span>
        </button>
      </header>

      <!-- Page -->
      <section class="content container-fluid p-4 mt-4">
        <h1 class="fw-bold page-title brand mb-3">Assignment Submission Inbox</h1>

        <!-- UI-CARD: actions + controls + meta -->
        <div class="ui-card mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-inbox"></i> Your Submission Inbox</h2>
            <div class="ui-actions">
              <button class="btn btn-outline-light" id="viewGradedBtn">
                <i class="bi bi-check2-square"></i> View Graded
              </button>
            </div>
          </div>

          <div class="ui-card-body">
            <!-- Row 1: Sort -->
            <div class="row g-2 ui-controls align-items-end mb-2">
              <div class="col-12 col-md-4 col-lg-3">
                <label for="sortBy" class="form-label">Sort</label>
                <select id="sortBy" class="form-select" aria-label="Sort submissions">
                  <option value="submitted_desc" selected>Newest submitted</option>
                  <option value="submitted_asc">Oldest submitted</option>
                  <option value="student_az">Student A → Z</option>
                  <option value="class_az">Class A → Z</option>
                  <option value="module_az">Module A → Z</option>
                  <option value="assignment_az">Assignment A → Z</option>
                  <option value="due_asc">Due soonest</option>
                  <option value="due_desc">Due latest</option>
                  <option value="status">Status (late → graded)</option>
                </select>
              </div>
            </div>

            <!-- Row 2: Filters (apply immediately) -->
            <div class="row g-3 ui-controls align-items-end">
              <div class="col-sm-3">
                <label for="filterClass" class="form-label">Class</label>
                <select id="filterClass" class="form-select">
                  <option value="">All Classes</option>
                </select>
              </div>
              <div class="col-sm-3">
                <label for="filterModule" class="form-label">Module</label>
                <select id="filterModule" class="form-select">
                  <option value="">All Modules</option>
                </select>
              </div>
              <div class="col-sm-3">
                <label for="filterDue" class="form-label">Due Date</label>
                <input type="date" id="filterDue" class="form-control" placeholder="dd/mm/yyyy"/>
              </div>
              <div class="col-sm-3">
                <label for="filterStatus" class="form-label">Status</label>
                <select id="filterStatus" class="form-select">
                  <option value="">All Statuses</option>
                  <option value="on-time">On-time</option>
                  <option value="late">Late</option>
                  <option value="graded">Graded</option>
                </select>
              </div>
            </div>

            <!-- Meta line -->
            <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
              <div class="brand-grad fw-semibold" id="assignmentMetaText">—</div>
              <span class="meta-pill" id="summaryText">—</span>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="submissionTable">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>Class</th>
                <th>Module</th>
                <th>Assignment</th>
                <th>Submitted At</th>
                <th>Due At</th>
                <th>Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="8" class="text-center text-muted py-4">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- View Submission Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-1"></i> Submission Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <div class="fw-semibold" id="vmStudentName">Student</div>
            <div class="small text-muted" id="vmMeta">—</div>
          </div>
          <hr>
          <div id="vmStatusBadge" class="mb-2"></div>
          <div id="vmFiles" class="mb-3"></div>
          <div id="vmNote" class="mb-3"></div>
          <div id="vmGrade" class="mb-1"></div>
        </div>
        <div class="modal-footer">
          <button class="btn-delete" id="vmDeleteBtn"><i class="bi bi-trash me-1"></i> Delete</button>
          <button class="btn btn-amber" id="vmGradeBtn"><i class="bi bi-check2-square me-1"></i> Grade</button>
          <button class="btn-close-footer" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Grade Modal -->
  <div class="modal fade" id="gradeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="gradeForm">
        <div class="modal-header">
          <h5 class="modal-title">Grade Submission</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2"><strong id="gradeStudentName">Student</strong></div>
          <div class="mb-3">
            <label class="form-label" id="gradeLabel">Grade</label>
            <input type="number" min="0" step="1" id="gradeInput" class="form-control" placeholder="e.g., 95" required/>
            <div id="gradeHelp" class="form-text"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Feedback (optional)</label>
            <textarea id="feedbackInput" class="form-control" rows="3" placeholder="Short feedback…"></textarea>
          </div>
          <input type="hidden" id="gradeAssignmentId"/>
          <input type="hidden" id="gradeStudentId"/>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-amber">Save Grade</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-amber" id="confirmYesBtn">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>
        <div class="modal-footer" id="filePreviewFooter">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto">
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-close-footer">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        });
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Page Logic -->
  <script>
    /* ===== Railway-friendly API base resolver =====
       1) <meta name="api-base">, 2) window.__API_BASE, 3) localStorage.API_BASE,
       4) same origin on *.railway.app, 5) http://localhost:5000 (dev)
    ================================================= */
    const API = (() => {
      const byMeta = document.querySelector('meta[name="api-base"]')?.getAttribute('content')?.trim();
      const byWindow = (typeof window !== 'undefined' && window.__API_BASE) ? String(window.__API_BASE).trim() : '';
      const byStorage = (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) ? localStorage.getItem('API_BASE').trim() : '';
      const onRailway = /\.railway\.app$/i.test(location.hostname);
      const chosen = byMeta || byWindow || byStorage || (onRailway ? location.origin : 'http://localhost:5000');
      return String(chosen).replace(/\/+$/, '');
    })();

    /* ---------- Auth ---------- */
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user || !user.userId || !user.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
    } else {
      // Initial-only username in header (no other changes)
      const uname =
        (user.username ||
         user.fullName ||
         user.name ||
         (user.email || '').split('@')[0] ||
         'Teacher').trim();
      const initial = (uname.match(/[A-Za-z]/)?.[0] || uname.charAt(0) || 'T').toUpperCase();
      const uEl = document.getElementById("Username");
      uEl.textContent = initial;   // show just the initial
      uEl.title = uname;           // keep full name on hover
    }
    function logoutUser(){ localStorage.clear(); sessionStorage.clear(); window.location.href="/TEACHER/login/login.html"; }
    window.logoutUser = logoutUser;

    /* ---------- Params ---------- */
    const url = new URL(location.href);
    const courseId = url.searchParams.get('courseId') || '';
    const assignmentId = url.searchParams.get('assignmentId') || '';
    if (!assignmentId || !courseId) location.href = '/TEACHER/assignment/assignments.html';

    /* ---------- DOM refs ---------- */
    const elSearch   = document.getElementById('searchInput');
    const elClass    = document.getElementById('filterClass');
    const elModule   = document.getElementById('filterModule');
    theElDue      = document.getElementById('filterDue');
    const elStatus   = document.getElementById('filterStatus');
    const elBody     = document.getElementById('tableBody');
    const elSummary  = document.getElementById('summaryText');
    const elMeta     = document.getElementById('assignmentMetaText');
    const viewGradedBtn = document.getElementById('viewGradedBtn');
    const elSortBy   = document.getElementById('sortBy');

    /* ---------- Modal management: always close others first ---------- */
    function closeAllModals() {
      document.querySelectorAll('.modal.show').forEach(m => {
        try { bootstrap.Modal.getInstance(m)?.hide(); } catch {}
      });
    }

    /* ---------- State ---------- */
    let assignmentMeta = null;
    let moduleTitle = '—';
    let submissions = [];
    let filtered = [];

    /* ---------- Modal helpers ---------- */
    function showInfoModal(message, title = 'Notice') {
      closeAllModals();
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').textContent = message;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('infoModal')).show();
    }
    function showConfirmModal(message, title = 'Confirm') {
      closeAllModals();
      return new Promise(resolve => {
        const modalEl = document.getElementById('confirmModal');
        const content = modalEl.querySelector('.modal-content');
        content.classList.remove('confirm-themed');
        document.getElementById('confirmModalLabel').textContent = title;
        document.getElementById('confirmModalBody').textContent = message;

        const yesBtn = document.getElementById('confirmYesBtn');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        function cleanup() {
          yesBtn.removeEventListener('click', onYes);
          modalEl.removeEventListener('hidden.bs.modal', onHide);
        }
        function onYes() {
          cleanup();
          resolve(true);
          modal.hide();
        }
        function onHide() {
          cleanup();
          resolve(false);
        }

        yesBtn.textContent = 'Yes';
        yesBtn.disabled = false;
        yesBtn.className = 'btn btn-danger';

        yesBtn.addEventListener('click', onYes, { once: true });
        modalEl.addEventListener('hidden.bs.modal', onHide, { once: true });

        modal.show();
      });
    }

    /* ----- Type-to-confirm (hardened) ----- */
    function showTypeToConfirm({ title, expected, hint='Type the Student Name exactly to delete', primaryText='Delete' }){
      closeAllModals();
      return new Promise((resolve)=>{
        const modalEl = document.getElementById('confirmModal');
        const content = modalEl.querySelector('.modal-content');
        content.classList.add('confirm-themed');

        const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;');
        const escAttr = s => String(s).replace(/"/g,'&quot;');

        document.getElementById('confirmModalLabel').textContent = title || 'Confirm';
        const body = document.getElementById('confirmModalBody');

        body.innerHTML = `
          <p class="mb-2 no-copy">${esc(hint)}</p>
          <div class="no-copy pill-danger mb-2" id="ttcPill">
            Type exactly: <strong id="ttcExpected">${esc(expected||'')}</strong>
          </div>
          <div class="mb-1">
            <input id="ttcInput" type="text" class="form-control is-invalid"
                   placeholder="${escAttr('Type here…')}" autocomplete="off"
                   autocapitalize="off" spellcheck="false">
          </div>
          <div id="ttcBad" class="invalid-msg no-copy">
            Input does not match. Please type <strong>${esc(expected||'')}</strong>.
          </div>
          <div id="ttcGood" class="valid-msg d-none">✓ Input matches</div>
        `;

        const okBtn = document.getElementById('confirmYesBtn');
        const cancelBtn = modalEl.querySelector('.btn-close-footer');

        okBtn.textContent = primaryText;
        okBtn.className = 'btn btn-delete';
        okBtn.disabled = true;

        const guardRoots = [modalEl, body.querySelector('#ttcPill'), body.querySelector('#ttcBad')];
        const block = e => e.preventDefault();
        guardRoots.forEach(node=>{
          ['copy','cut','contextmenu','dragstart','dragover','drop'].forEach(evt => node.addEventListener(evt, block));
        });

        const input = body.querySelector('#ttcInput');
        input.addEventListener('paste', block);
        input.addEventListener('beforeinput', e => {
          if ((e.inputType||'').toLowerCase().includes('insertfrompaste')) e.preventDefault();
        });
        input.addEventListener('keydown', e => {
          const k = (e.key||'').toLowerCase();
          if ((e.ctrlKey || e.metaKey) && (k==='v' || k==='x' || k==='c' || k==='a')) e.preventDefault();
        });

        const bad = body.querySelector('#ttcBad');
        const good = body.querySelector('#ttcGood');
        const expectedRaw = String(expected||'');

        function refresh(){
          const ok = (input.value === expectedRaw);
          okBtn.disabled = !ok;
          input.classList.toggle('is-valid', ok);
          input.classList.toggle('is-invalid', !ok);
          bad.classList.toggle('d-none', ok);
          good.classList.toggle('d-none', !ok);
        }
        input.addEventListener('input', refresh);
        setTimeout(()=>input.focus(), 60);

        let confirmed = false;
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        const onOk = () => { if (!okBtn.disabled){ confirmed = true; modal.hide(); } };
        const onCancel = () => { modal.hide(); };
        const onHidden = () => {
          okBtn.removeEventListener('click', onOk);
          cancelBtn && cancelBtn.removeEventListener('click', onCancel);
          modalEl.removeEventListener('hidden.bs.modal', onHidden);
          content.classList.remove('confirm-themed');

          guardRoots.forEach(node=>{
            ['copy','cut','contextmenu','dragstart','dragover','drop'].forEach(evt => node.removeEventListener(evt, block));
          });
          input.removeEventListener('paste', block);

          resolve(confirmed);
        };

        okBtn.addEventListener('click', onOk);
        cancelBtn && cancelBtn.addEventListener('click', onCancel);
        modalEl.addEventListener('hidden.bs.modal', onHidden, { once:true });

        modal.show();
      });
    }

    /* ---------- Utils ---------- */
    function escapeHTML(str=''){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
    function tsToMs(ts){
      if (!ts) return null;
      if (typeof ts === 'number') return ts;
      if (typeof ts === 'string') { const d=Date.parse(ts); return Number.isNaN(d)?null:d; }
      if (typeof ts?.toMillis === 'function') return ts.toMillis();
      const s = ts._seconds ?? ts.seconds; const ns = ts._nanoseconds ?? ts.nanoseconds ?? 0;
      if (typeof s === 'number') return (s*1000)+Math.floor(ns/1e6);
      return null;
    }
    function toDate(v){ const ms = tsToMs(v); if (ms==null) return null; const d=new Date(ms); return Number.isNaN(d.getTime())?'—':d; }
    function fmt(dt){ if (!dt) return '—'; const d=dt instanceof Date?dt:new Date(dt); return isNaN(d.getTime())?'—':d.toLocaleString(); }
    function toApiUrl(pathOrUrl){
      const s = String(pathOrUrl || "");
      if (/^https?:\/\/|^blob:/i.test(s)) return s;
      return API + (s.startsWith('/') ? s : '/' + s);
    }

    // ===== File-kind detection + preview utils (modal) =====
    function getExtFromUrl(url=''){ const clean=String(url).split('?')[0].split('#')[0]; const parts=clean.split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function isYouTubeUrl(url=''){ try{const u=new URL(url);const h=u.hostname.replace(/^www\./,'').toLowerCase();return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);}catch{return false;} }
    function toYouTubeEmbed(url=''){ try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();let id='';let start=u.searchParams.get('start')||u.searchParams.get('t')||'';if(start&&/^\d+s$/.test(start))start=parseInt(start,10);if(start&&/^\d+$/.test(start))start=parseInt(start,10);if(!Number.isFinite(start))start='';if(host==='youtu.be'){id=(u.pathname||'').replace(/^\//,'').split('/')[0];}else{if(u.pathname.startsWith('/embed/'))id=u.pathname.split('/')[2]||'';if(!id)id=u.searchParams.get('v')||'';}if(!id)return null;const base=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;const qs=new URLSearchParams();qs.set('rel','0');if(start)qs.set('start',String(start));return `${base}?${qs.toString()}`;}catch{return null;} }
    function kindFromUrl(url){
      if(isYouTubeUrl(url))return'youtube';
      const ext=getExtFromUrl(url);
      if(['mp4','webm','ogg','ogv','mov'].includes(ext))return'video';
      if(['mp3','wav','m4a','ogg','aac','flac'].includes(ext))return'audio';
      if(['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext))return'image';
      if(ext==='pdf')return'pdf';
      if(['txt','csv','log'].includes(ext))return'text';
      if(['doc','docx','ppt','pptx','xls','xlsx'].includes(ext))return'office';
      return'other';
    }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function setFileInfoUI(kind,url){
      const info=document.getElementById('fileInfoText');
      const hdr=document.getElementById('filePreviewModalLabel');
      const labelMap={youtube:'YouTube',video:'Video',audio:'Audio',image:'Image',pdf:'PDF',text:'Text/CSV',office:'Office Doc',other:'File'};
      const colorMap={youtube:'bg-danger-subtle text-danger',video:'bg-danger-subtle text-danger',audio:'bg-secondary-subtle text-secondary',image:'bg-success-subtle text-success',pdf:'bg-primary-subtle text-primary',text:'bg-info-subtle text-info',office:'bg-warning-subtle text-warning',other:'bg-dark-subtle text-dark'};
      let badge=document.getElementById('fileKindBadge'); if(!badge){badge=document.createElement('span');badge.id='fileKindBadge';badge.className='ms-2 badge rounded-pill';hdr.appendChild(badge);}
      badge.className='ms-2 badge rounded-pill '+(colorMap[kind]||colorMap.other); badge.textContent=labelMap[kind]||'File';
      info.innerHTML=`<span class="text-muted">Type:</span> <strong>${labelMap[kind]||'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href=url||'#';
    }
    function renderFilePreviewInto(container,url){
      container.innerHTML=''; showSpinner(true); const done=()=>showSpinner(false); const kind=kindFromUrl(url);
      const fallback=(msg)=>{ container.innerHTML=`<div class="preview-fallback"><div class="text-muted mb-2">${msg||'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; done(); };

      if(kind==='youtube'){ const embed=toYouTubeEmbed(url); if(embed){container.innerHTML=`<div class="ratio ratio-16x9"><iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin" style="border:0"></iframe></div>`; done(); return;} fallback('Couldn’t embed this YouTube link.'); return; }

      const ext=getExtFromUrl(url);
      if(['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)){ const img=new Image(); img.onload=done; img.onerror=()=>fallback('Image preview failed.'); img.src=url; container.appendChild(img); return; }
      if(ext==='pdf'){ const iframe=document.createElement('iframe'); iframe.title='PDF preview'; iframe.onload=done; iframe.onerror=()=>fallback('PDF preview failed (viewer blocked or CORS).'); iframe.src=url; container.appendChild(iframe); return; }
      if(['mp4','webm','ogg','ogv','mov'].includes(ext)){ const video=document.createElement('video'); video.controls=true; video.onloadeddata=done; video.onerror=()=>fallback('Video preview failed.'); video.src=url; container.appendChild(video); return; }
      if(['mp3','wav','m4a','ogg','aac','flac'].includes(ext)){ const audio=document.createElement('audio'); audio.controls=true; audio.onloadeddata=done; audio.onerror=()=>fallback('Audio preview failed.'); audio.src=url; container.appendChild(audio); return; }
      if(['txt','csv','log'].includes(ext)){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Text preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)){ const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe=document.createElement('iframe'); iframe.title='Document preview'; iframe.onload=done; iframe.onerror=()=>fallback('Office preview failed (Google Viewer blocked or CORS).'); iframe.src=gview; container.appendChild(iframe); return; }

      const obj=document.createElement('object'); obj.data=url; obj.type='application/octet-stream'; obj.onload=done; obj.onerror=()=>fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(done,1200);
    }
    function openPreviewModal(viewUrl, title='File'){
      closeAllModals();
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      setFileInfoUI(kindFromUrl(viewUrl), viewUrl);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), viewUrl);
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    /* ===== Cloud-storage helpers (with signing) ===== */
    function pickHref(obj = {}) {
      return obj.downloadUrl || obj.publicUrl || obj.previewUrl ||
             (obj.url && /^https?:\/\//i.test(obj.url) ? obj.url : '') ||
             (obj.filePath ? toApiUrl(obj.filePath) : '');
    }
    function pickName(obj = {}) {
      const fromPath = (obj.storagePath || obj.filePath || '').split('/').pop();
      const fromUrl  = (obj.url || '').split('/').pop();
      return obj.originalName || fromPath || fromUrl || 'file';
    }
    function extractStoragePath(obj = {}) {
      if (obj.storagePath) return String(obj.storagePath);
      if (obj.gsUri && obj.gsUri.startsWith('gs://')) {
        const parts = obj.gsUri.replace('gs://','').split('/'); parts.shift(); return parts.join('/');
      }
      if (obj.publicUrl && /storage\.googleapis\.com/i.test(obj.publicUrl)) {
        try { const u = new URL(obj.publicUrl); const parts = u.pathname.replace(/^\/+/, '').split('/'); parts.shift(); return parts.join('/'); } catch {}
      }
      if (obj.downloadUrl && /firebasestorage\.googleapis\.com/i.test(obj.downloadUrl)) {
        try { const u = new URL(obj.downloadUrl); if (u.pathname.includes('/o/')) { const enc = u.pathname.split('/o/')[1]; return decodeURIComponent(enc); } } catch {}
      }
      return '';
    }

    async function openPreviewFromObj(obj = {}) {
      const direct = pickHref(obj);
      if (direct && /firebasestorage\.googleapis\.com\/v0\/b\//i.test(direct)) {
        openPreviewModal(direct, pickName(obj));
        return;
      }
      const storagePath = extractStoragePath(obj);
      if (!storagePath) {
        if (direct) openPreviewModal(direct, pickName(obj));
        return;
      }
      try {
        const r = await fetch(`${API}/api/attachments/signed?path=${encodeURIComponent(storagePath)}`);
        const js = await r.json().catch(()=>null);
        if (r.ok && js?.success && js?.url) {
          openPreviewModal(js.url, pickName(obj));
          return;
        }
      } catch {}
      if (direct) openPreviewModal(direct, pickName(obj));
    }

    // Status helpers
    function computeStatus(row){
      if (row.grade != null) return 'graded';
      if (!row.submittedAt || !row.dueAt) return 'on-time';
      return row.submittedAt.getTime() <= row.dueAt.getTime() ? 'on-time' : 'late';
    }
    function statusRank(s){
      return s === 'late' ? 0 : (s === 'on-time' ? 1 : 2);
    }
    function statusPill(s){
      const map = { 'graded':'status-graded', 'late':'status-late', 'on-time':'status-ontime' };
      const cls = map[s] || 'status-ontime';
      const txt = s === 'graded' ? 'Graded' : s === 'late' ? 'Late' : 'On-time';
      return `<span class="status-pill ${cls}">${txt}</span>`;
    }

    // Class name cache
    const classNameById = new Map();
    async function getClassName(classId) {
      if (!classId) return '—';
      if (classNameById.has(classId)) return classNameById.get(classId);
      try {
        const resp = await fetch(`${API}/api/classes/${encodeURIComponent(classId)}`);
        const js = await resp.json();
        let label = '—';
        if (resp.ok && js) {
          const c = js.class || js;
          const parts = [c.name || c.title, c.section].filter(Boolean);
          label = parts.length ? parts.join(' • ') : (c.name || c.title || classId);
        }
        classNameById.set(classId, label);
        return label;
      } catch {
        classNameById.set(classId, classId);
        return classId;
      }
    }

    // Load assignment meta
    async function loadAssignmentMeta(){
      const r = await fetch(`${API}/api/courses/${encodeURIComponent(courseId)}/assignments`);
      if (!r.ok) return null;
      const js = await r.json();
      if (!js?.success || !Array.isArray(js.assignments)) return null;
      const a = js.assignments.find(x=>x.id===assignmentId) || null;
      if (!a) return null;
      moduleTitle = (typeof a.moduleNumber === 'number') ? `Module ${a.moduleNumber}` : '—';
      return a;
    }

    // Load submissions
    async function loadSubmissions(){
      try {
        const resp = await fetch(`${API}/api/assignments/${encodeURIComponent(assignmentId)}/submissions`);
        if (!resp.ok) return [];
        const js = await resp.json();
        if (!js.success || !Array.isArray(js.submissions)) return [];

        const dueAt = toDate(assignmentMeta?.dueAt);
        return js.submissions.map(s => {
          const submittedAt = toDate(s?.submittedAt) || toDate(s?.createdAt);
          const classId = s.classId || s.classID || s.class || null;

          const item = {
            studentId   : s.studentId,
            studentName : s.studentName || s.studentId,
            classId     : classId,
            className   : s.className || (classId ? 'Loading…' : '—'),
            assignmentId,
            assignmentTitle: assignmentMeta?.title || 'Untitled',
            moduleTitle : moduleTitle,
            submittedAt,
            dueAt,
            grade       : (typeof s.grade === 'number') ? s.grade : null,
            feedback    : s.feedback || '',
            text        : s.text || '',
            files       : Array.isArray(s.files) ? s.files : [],
          };
          item._status = computeStatus(item);
          item.maxPoints = (typeof assignmentMeta?.points === 'number') ? assignmentMeta.points : null;
          return item;
        });
      } catch {
        return [];
      }
    }

    // Resolve missing class names
    async function resolveMissingClassNames(list){
      const promises = [];
      for (const row of list) {
        const needsLookup =
          row && row.classId &&
          (!row.className || row.className === '—' || row.className === 'Loading…');
        if (needsLookup) {
          promises.push(
            getClassName(row.classId).then(name => { row.className = name || '—'; })
          );
        }
      }
      if (!promises.length) return;
      await Promise.all(promises);
      populateFilters(submissions);
      applyFilters();
    }

    // Filters
    function populateFilters(list){
      const classSet = new Set(), moduleSet = new Set();
      list.forEach(x => {
        if (x.className && x.className !== '—' && x.className !== 'Loading…') classSet.add(x.className);
        if (x.moduleTitle && x.moduleTitle !== '—') moduleSet.add(x.moduleTitle);
      });
      document.getElementById('filterClass').innerHTML =
        `<option value="">All Classes</option>` +
        [...classSet].sort().map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join('');
      document.getElementById('filterModule').innerHTML =
        `<option value="">All Modules</option>` +
        [...moduleSet].sort().map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join('');
    }

    function applyFilters(){
      const q = (elSearch.value || '').toLowerCase().trim();
      const fClass = elClass.value;
      const fModule = elModule.value;
      const fDue = theElDue.value;
      const fStatus = elStatus.value;
      const sort = (elSortBy?.value) || 'submitted_desc';

      filtered = submissions.filter(s => {
        if (q){
          const hay = `${s.studentName} ${s.assignmentTitle} ${s.moduleTitle} ${s.className}`.toLowerCase();
          if (!hay.includes(q)) return false;
        }
        if (fClass && s.className !== fClass) return false;
        if (fModule && s.moduleTitle !== fModule) return false;
        if (fDue && s.dueAt){
          const yyyy = s.dueAt.getFullYear();
          const mm = String(s.dueAt.getMonth()+1).padStart(2,'0');
          const dd = String(s.dueAt.getDate()).padStart(2,'0');
          if (`${yyyy}-${mm}-${dd}` !== fDue) return false;
        } else if (fDue && !s.dueAt){
          return false;
        }
        if (fStatus){
          if (fStatus === 'on-time' && s._status !== 'on-time') return false;
          if (fStatus === 'late' && s._status !== 'late') return false;
          if (fStatus === 'graded' && s._status !== 'graded') return false;
        }
        return true;
      });

      // Sorting
      filtered.sort((a,b)=>{
        const subA = a.submittedAt?.getTime()||0, subB = b.submittedAt?.getTime()||0;
        const dueA = a.dueAt?.getTime()||0,       dueB = b.dueAt?.getTime()||0;

        if (sort === 'submitted_asc')  return subA - subB;
        if (sort === 'student_az')     return (a.studentName||'').localeCompare(b.studentName||'');
        if (sort === 'class_az')       return (a.className||'').localeCompare(b.className||'');
        if (sort === 'module_az')      return (a.moduleTitle||'').localeCompare(b.moduleTitle||'');
        if (sort === 'assignment_az')  return (a.assignmentTitle||'').localeCompare(b.assignmentTitle||'');
        if (sort === 'due_asc')        return (dueA || Number.MAX_SAFE_INTEGER) - (dueB || Number.MAX_SAFE_INTEGER);
        if (sort === 'due_desc')       return (dueB || 0) - (dueA || 0);
        if (sort === 'status') {
          const rankA = statusRank(a._status);
          const rankB = statusRank(b._status);
          if (a._status === 'graded' && b._status === 'graded') return 0;
          if (a._status === 'graded') return 1;
          if (b._status === 'graded') return -1;
          return rankA - rankB;
        }
        return subB - subA || (dueA - dueB);
      });

      renderTable();
      const gradedCount = filtered.filter(x => x._status === 'graded').length;
      const lateCount = filtered.filter(x => x._status === 'late').length;
      const ontimeCount = filtered.filter(x => x._status === 'on-time').length;
      elSummary.textContent = `${filtered.length} shown • ${gradedCount} graded • ${ontimeCount} on-time • ${lateCount} late`;
    }

    function renderTable(){
      if (!filtered.length){
        elBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No submissions yet for this assignment.</td></tr>`;
        return;
      }
      elBody.innerHTML = filtered.map(s => `
        <tr data-assignment-id="${escapeHTML(s.assignmentId)}" data-student-id="${escapeHTML(s.studentId)}">
          <td>${escapeHTML(s.studentName)}</td>
          <td>${escapeHTML(s.className)}</td>
          <td>${escapeHTML(s.moduleTitle)}</td>
          <td>${escapeHTML(s.assignmentTitle)}</td>
          <td>${escapeHTML(fmt(s.submittedAt))}</td>
          <td>${escapeHTML(fmt(s.dueAt))}</td>
          <td>${statusPill(s._status)}</td>
          <td class="text-center">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-sm btn-outline-secondary view-btn">
                <i class="bi bi-eye me-1"></i> View
              </button>
              <button class="btn btn-success grade-btn"><i class="bi bi-check2-square"></i> Grade</button>
            </div>
          </td>
        </tr>
      `).join('');

      // Wire row actions
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const aId = tr.getAttribute('data-assignment-id');
          const sId = tr.getAttribute('data-student-id');
          const row = filtered.find(x => x.assignmentId === aId && x.studentId === sId);
          openViewModal(row);
        });
      });
      document.querySelectorAll('.grade-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const aId = tr.getAttribute('data-assignment-id');
          const sId = tr.getAttribute('data-student-id');
          const row = filtered.find(x => x.assignmentId === aId && x.studentId === sId);
          openGradeModal(row);
        });
      });
    }

    // -------- Modals & actions --------
    const viewModalEl   = document.getElementById('viewModal');
    const gradeModalEl  = document.getElementById('gradeModal');

    function vm(){ return bootstrap.Modal.getOrCreateInstance(viewModalEl); }
    function gm(){ return bootstrap.Modal.getOrCreateInstance(gradeModalEl); }

    const vmStudentName = document.getElementById('vmStudentName');
    const vmMeta        = document.getElementById('vmMeta');
    const vmStatusBadge = document.getElementById('vmStatusBadge');
    const vmFiles       = document.getElementById('vmFiles');
    const vmNote        = document.getElementById('vmNote');
    const vmGrade       = document.getElementById('vmGrade');
    const vmDeleteBtn   = document.getElementById('vmDeleteBtn');
    const vmGradeBtn    = document.getElementById('vmGradeBtn');

    const gradeStudentNameEl = document.getElementById('gradeStudentName');
    const gradeLabelEl       = document.getElementById('gradeLabel');
    const gradeHelpEl        = document.getElementById('gradeHelp');
    const gradeInputEl       = document.getElementById('gradeInput');
    const feedbackInputEl    = document.getElementById('feedbackInput');
    const gradeAssignmentIdEl= document.getElementById('gradeAssignmentId');
    const gradeStudentIdEl   = document.getElementById('gradeStudentId');

    function buildStatusBadge(item){
      const isGraded = typeof item.grade === 'number';
      const isLate = item.dueAt && item.submittedAt && (item.submittedAt > item.dueAt);
      const label = isGraded ? 'Graded' : (isLate ? 'Late' : 'On-time');
      const cls   = isGraded ? 'bg-primary' : (isLate ? 'bg-danger' : 'bg-success');
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function openViewModal(item){
      if (!item) return;

      closeAllModals();

      vmStudentName.textContent = item.studentName || item.studentId || '—';
      const metaParts = [
        item.assignmentTitle || 'Untitled',
        item.moduleTitle && item.moduleTitle !== '—' ? item.moduleTitle : null,
        item.className || null,
        `Submitted: ${fmt(item.submittedAt)}`,
        item.dueAt ? `Due: ${fmt(item.dueAt)}` : null,
      ].filter(Boolean);
      vmMeta.textContent = metaParts.join(' • ');

      vmStatusBadge.innerHTML = buildStatusBadge(item);

      // Files (open in Preview Modal with signing)
      if (item.files && item.files.length){
        const fileLis = item.files.map(f => {
          const name = escapeHTML(pickName(f));
          const payload = {
            downloadUrl: f.downloadUrl || '',
            publicUrl:   f.publicUrl   || '',
            previewUrl:  f.previewUrl  || '',
            url:         f.url         || '',
            storagePath: f.storagePath || '',
            gsUri:       f.gsUri       || '',
            originalName:f.originalName|| ''
          };
          const safeJson = JSON.stringify(payload).replace(/"/g,'&quot;'); // inline-safe
          return `<li class="mb-1">
                    <button type="button" class="btn btn-link p-0 align-baseline" onclick='openPreviewFromObj(${safeJson})'>
                      ${name}
                    </button>
                  </li>`;
        }).join('');

        vmFiles.innerHTML = `
          <div class="fw-semibold mb-1"><i class="bi bi-paperclip"></i> Files</div>
          <ul class="ps-3 mb-0">${fileLis}</ul>`;
      } else {
        vmFiles.innerHTML = `
          <div class="fw-semibold mb-1"><i class="bi bi-paperclip"></i> Files</div>
          <div class="text-muted">—</div>`;
      }

      // Note
      vmNote.innerHTML = `
        <div class="fw-semibold mb-1"><i class="bi bi-chat-left-text"></i> Student Note</div>
        <div class="whitespace-prewrap">${escapeHTML((item.text || '').trim()) || '—'}</div>`;

      // Grade
      const maxPts = (typeof item.maxPoints === 'number') ? item.maxPoints : null;
      if (typeof item.grade === 'number'){
        vmGrade.innerHTML = `<div class="fw-semibold">Score: ${item.grade}${maxPts != null ? ` / ${maxPts}` : ''}</div>`;
      } else {
        vmGrade.innerHTML = `<div class="text-muted">Not graded</div>`;
      }

      // Actions
      vmDeleteBtn.onclick = () => deleteSubmission(item);
      vmGradeBtn.onclick  = () => {
        openGradeModal(item);
        vm().hide();
      };

      vm().show();
    }

    function openGradeModal(item){
      if (!item) return;

      closeAllModals();

      const maxPts = (typeof item.maxPoints === 'number') ? item.maxPoints : null;
      gradeStudentNameEl.textContent = item.studentName || item.studentId;
      gradeLabelEl.textContent = maxPts!=null ? `Grade (0–${maxPts})` : 'Grade';
      gradeHelpEl.textContent  = maxPts!=null ? `Enter a score between 0 and ${maxPts}.` : 'Enter points.';
      gradeInputEl.value       = (typeof item.grade === 'number') ? item.grade : '';
      feedbackInputEl.value    = item.feedback || '';
      gradeAssignmentIdEl.value= item.assignmentId;
      gradeStudentIdEl.value   = item.studentId;

      gm().show();
    }

    // Save grade
    document.getElementById('gradeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const aId = gradeAssignmentIdEl.value;
      const sId = gradeStudentIdEl.value;
      const grade = Number(gradeInputEl.value);
      const feedback = feedbackInputEl.value.trim();
      if (Number.isNaN(grade)) { showInfoModal('Please enter a valid grade.', 'Invalid Grade'); return; }

      try{
        const res = await fetch(`${API}/api/assignments/${encodeURIComponent(aId)}/submissions/${encodeURIComponent(sId)}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ grade, feedback })
        });
        const js = await res.json();
        if (!res.ok || js.success === false) throw new Error(js.message || `HTTP ${res.status}`);

        const updateLocal = (arr) => {
          const idx = arr.findIndex(x => x.assignmentId === aId && x.studentId === sId);
          if (idx >= 0){
            arr[idx].grade = grade;
            arr[idx].feedback = feedback;
            arr[idx]._status = 'graded';
          }
        };
        updateLocal(submissions);
        updateLocal(filtered);

        applyFilters();
        bootstrap.Modal.getOrCreateInstance(gradeModalEl).hide();
        showInfoModal('Grade saved successfully.', 'Saved');
      }catch(err){
        console.error(err);
        showInfoModal('Failed to save grade. ' + (err.message || 'Unknown error'), 'Error');
      }
    });

    // Delete submission (TYPE-TO-CONFIRM: Student Name)
    async function deleteSubmission(item){
      const expected = (item?.studentName || item?.studentId || '').trim();
      let ok = false;

      if (expected) {
        ok = await showTypeToConfirm({
          title: 'Delete Submission',
          expected,
          hint: 'Confirm deletion by typing the exact Student Name (case-sensitive). This allows the student to resubmit.',
          primaryText: 'Delete'
        });
      } else {
        ok = await showConfirmModal('Delete this submission? This will allow the student to resubmit.','Delete Submission');
      }
      if (!ok) return;

      try{
        const res = await fetch(`${API}/api/assignments/${encodeURIComponent(item.assignmentId)}/submissions/${encodeURIComponent(item.studentId)}`, {
          method:'DELETE'
        });
        const js = await res.json().catch(()=>({success: res.ok}));
        if (!res.ok || js.success === false) throw new Error(js.message || `HTTP ${res.status}`);

        submissions = submissions.filter(x => !(x.assignmentId === item.assignmentId && x.studentId === item.studentId));
        filtered    = filtered.filter(x => !(x.assignmentId === item.assignmentId && x.studentId === item.studentId));
        applyFilters();

        showInfoModal('Submission deleted.', 'Deleted');
      }catch(err){
        console.error(err);
        showInfoModal('Failed to delete submission. ' + (err.message || 'Unknown error'), 'Error');
      }
    }

    /* ---------- Events ---------- */
    elSearch.addEventListener('input', applyFilters);
    elSortBy.addEventListener('change', applyFilters);
    elClass.addEventListener('change', applyFilters);
    elModule.addEventListener('change', applyFilters);
    elStatus.addEventListener('change', applyFilters);
    theElDue.addEventListener('change', applyFilters);
    theElDue.addEventListener('input', applyFilters);

    viewGradedBtn.addEventListener('click', () => {
      const params = new URLSearchParams();
      params.set('courseId', courseId);
      params.set('assignmentId', assignmentId);
      window.location.href = `/TEACHER/assignment/graded.html?${params.toString()}`;
    });

    /* ---------- Boot ---------- */
    (async function boot(){
      try{
        assignmentMeta = await loadAssignmentMeta();
        const dueStr = assignmentMeta?.dueAt ? new Date(tsToMs(assignmentMeta.dueAt)).toLocaleString() : 'N/A';
        const modLabel = (typeof assignmentMeta?.moduleNumber === 'number') ? ` • Module ${assignmentMeta.moduleNumber}` : '';
        const pts = (typeof assignmentMeta?.points === 'number') ? ` • ${assignmentMeta.points} pts` : '';
        elMeta.textContent = `${assignmentMeta?.title || 'Untitled'}${modLabel}${pts} • Due: ${dueStr}`;
      }catch{}

      try{
        submissions = await loadSubmissions();
        populateFilters(submissions);
        applyFilters();
        resolveMissingClassNames(submissions);
      }catch(e){
        console.error(e);
        elBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Failed to load submissions.</td></tr>`;
        elSummary.textContent = 'Failed to load.';
      }
    })();
  </script>
</body>
</html>
