<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EduConnect Teacher – Upload Assignment</title>

  <!-- OPTIONAL: set if backend is a separate Railway service -->
  <!-- <meta name="api-base" content="https://your-backend.up.railway.app"> -->

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="ass_upload.css" rel="stylesheet"/>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative" style="max-width:520px;">
          <input type="text" id="searchBox" class="form-control" placeholder="Search assignments..."/>
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid p-4">
        <h1 class="page-title">Assignment Upload</h1>

        <div class="ui-card card-themed mb-3 mx-auto" style="max-width:1080px;">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-clipboard-plus"></i> Create Assignment</h2>
            <div class="ui-subtext">Pick a course & module, assign to classes, add details, then stage files/links/rubric and create.</div>
          </div>

          <form id="assignmentForm" class="px-3 py-3" enctype="multipart/form-data" novalidate>
            <!-- Row: Course / Module -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Course</label>
                <select id="courseSelect" class="form-select" required>
                  <option value="">Loading courses…</option>
                </select>
                <div id="courseHelp" class="hint mt-1">Shows courses you uploaded. If empty, create a course first.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Module</label>
                <select id="moduleSelect" class="form-select" required disabled>
                  <option value="">Select a course first…</option>
                </select>
                <div id="moduleHelp" class="hint mt-1"></div>
              </div>
            </div>

            <!-- Assign to Classes (filtered by selected Course) -->
            <div class="ui-card mt-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-people"></i> Assign to Classes</h2>
                <div class="ui-subtext">Only classes enrolled in the selected course will appear here.</div>
              </div>
              <div class="p-3">
                <div id="assigned-status" class="small-muted mb-2">Loading your classes…</div>
                <div id="assigned-empty" class="alert alert-warning py-2 px-3 mb-2" style="display:none;">
                  No classes found for the selected course.
                </div>
                <div id="assignedClassesContainer" class="row g-3"></div>
                <div class="small-muted mt-2">Tip: click a card to toggle selection.</div>
              </div>
            </div>

            <!-- Row: Title / Points -->
            <div class="row g-3 mt-1">
              <div class="col-md-8">
                <label class="form-label">Title</label>
                <input id="title" type="text" class="form-control" placeholder="Assignment title" required/>
              </div>
              <div class="col-md-4">
                <label class="form-label">Points</label>
                <input id="points" type="number" min="0" max="100" step="1" class="form-control" placeholder="0–100"/>
                <div class="hint mt-1">
                  Allowed range: 0–100. <strong>Over 100 is not allowed.</strong> Leave blank for ungraded.
                </div>
              </div>
            </div>

            <!-- Content -->
            <div class="mt-3">
              <label class="form-label">Instructions / Content</label>
              <textarea id="content" class="form-control" rows="5" placeholder="Describe the task, rubric, submission format…" required></textarea>
            </div>

            <!-- Dates -->
            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label class="form-label">Publish At</label>
                <input id="publishAt" type="datetime-local" class="form-control"/>
                <div class="hint mt-1">If empty, it will publish immediately.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Due At</label>
                <input id="dueAt" type="datetime-local" class="form-control"/>
              </div>
            </div>

            <!-- Staging UI -->
            <div class="ui-card mt-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-paperclip"></i> Attachments & Rubric</h2>
              </div>
              <div class="p-3">
                <!-- Upload area: files -->
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-md-8">
                    <label class="form-label">Upload file(s)</label>
                    <input id="fileInput" type="file" multiple class="form-control" />
                    <div class="small-muted mt-1">Per-file limit: <strong>300 MB</strong>. You can select multiple; preview before staging.</div>
                  </div>
                  <div class="col-md-4 d-grid d-sm-flex gap-2">
                    <button id="btnPreviewSelectedFiles" class="btn btn-outline-secondary w-100 w-sm-auto">
                      <i class="bi bi-eye"></i> Preview Selected
                    </button>
                    <button id="btnStageFiles" class="btn btn-outline-primary w-100 w-sm-auto">
                      <i class="bi bi-cloud-plus"></i> Stage Files
                    </button>
                  </div>
                </div>

                <!-- Upload area: rubric (single) -->
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-md-8">
                    <label class="form-label">Upload rubric (single file)</label>
                    <input id="rubricInput" type="file" class="form-control" />
                    <div class="small-muted mt-1">Only one rubric; staging a new one replaces the staged rubric.</div>
                  </div>
                  <div class="col-md-4 d-grid d-sm-flex gap-2">
                    <button id="btnPreviewRubric" class="btn btn-outline-secondary w-100 w-sm-auto">
                      <i class="bi bi-eye"></i> Preview
                    </button>
                    <button id="btnStageRubric" class="btn btn-outline-warning w-100 w-sm-auto">
                      <i class="bi bi-clipboard-plus"></i> Stage Rubric
                    </button>
                  </div>
                </div>

                <div class="col-12"><hr class="my-2"></div>

                <!-- Add link -->
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-md-8">
                    <label class="form-label">Add a link</label>
                    <input id="linkInput" type="url" class="form-control" placeholder="https://…" />
                    <div class="small-muted mt-1">Paste a public URL (Docs, YouTube, etc.).</div>
                  </div>
                  <div class="col-md-4 d-grid d-sm-flex gap-2">
                    <button id="btnPreviewLink" class="btn btn-outline-secondary w-100 w-sm-auto">
                      <i class="bi bi-eye"></i> Preview
                    </button>
                    <button id="btnStageLink" class="btn btn-outline-info w-100 w-sm-auto">
                      <i class="bi bi-link-45deg"></i> Stage Link
                    </button>
                  </div>
                </div>

                <!-- Staged list -->
                <ul id="filesList" class="file-list"></ul>
                <div class="form-text mt-2">
                  <strong>Staging:</strong> items marked with
                  <span class="badge-soft badge-stage">Staged</span>
                  will be uploaded/added when you click <strong>Create Assignment</strong>.
                </div>
              </div>
            </div>

            <!-- Error / debug -->
            <div id="formError" class="text-danger mt-3" style="min-height:1.2rem;"></div>

            <!-- Actions -->
            <div class="d-flex justify-content-end gap-2 mt-4">
              <a href="/TEACHER/dashboard/dashboard.html" class="btn btn-amber-outline">← Dashboard</a>
              <button id="submitBtn" type="submit" class="btn btn-amber">
                <span class="submit-text">Create Assignment</span>
                <span class="spinner-border spinner-border-sm ms-2 visually-hidden" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>
        <div class="modal-footer">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto d-flex gap-2">
            <button id="stageFromPreviewBtn" class="btn btn-amber d-none">
              <i class="bi bi-cloud-plus me-1"></i> Stage this file
            </button>
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn-close-footer">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sb = document.querySelector(".sidebar");
          const db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Auth guard + header initials -->
  <script>
    (function initHeaderInitials(){
      try{
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;

        if (!u?.userId || !u?.isTeacher) { window.location.href = "/TEACHER/login/login.html"; return; }
        window.currentUser = u;

        const initials = (function(u){
          const fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
          if(fn&&ln) return (fn[0]+ln[0]).toUpperCase();
          const nameish=(u.username||u.displayName||u.name||'').trim();
          if(nameish){
            const parts=nameish.replace(/[^A-Za-z0-9 _.\-]+/g,' ').split(/[\s._-]+/).filter(Boolean);
            if(parts.length>=2) return (parts[0][0]+parts[1][0]).toUpperCase();
            return parts[0][0].toUpperCase();
          }
          const em=(u.email||'').trim();
          return em?em[0].toUpperCase():'U';
        })(u);

        window.addEventListener("DOMContentLoaded", ()=>{
          const el=document.getElementById("Username");
          if(!el) return;
          el.textContent=initials;
          const full=[u.firstName,u.middleName,u.lastName].filter(Boolean).join(' ').trim() || u.username || u.email || 'Profile';
          el.setAttribute('title', full);
          el.setAttribute('aria-label', full);
        });
      }catch(e){ console.error('initHeaderInitials failed:', e); window.location.href = "/TEACHER/login/login.html"; }
    })();
  </script>

  <!-- Page Logic -->
  <script>
    /* ===== Railway-friendly API resolver ===== */
    function resolveApiBase() {
      const meta = document.querySelector('meta[name="api-base"]');
      if (meta && meta.content) return meta.content.replace(/\/+$/, '');
      if (window.__API_BASE__) return String(window.__API_BASE__).replace(/\/+$/, '');
      const host = location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') return 'http://127.0.0.1:5000';
      return ''; // same-origin (recommended on Railway if serving API under same domain)
    }
    const API_BASE = resolveApiBase();
    const api = (path) => `${API_BASE}${path}`;

    const TEACHER_MAX_MB = 300;
    const TEACHER_MAX_BYTES = TEACHER_MAX_MB * 1024 * 1024;

    /* ===== Utilities ===== */
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toMillis = v => v ? new Date(v).getTime() : null;
    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));

    function extFromUrl(u=''){ const clean=String(u).split('?')[0].split('#')[0]; const parts=clean.split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function extFromName(n=''){ const parts=String(n).split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function isYouTubeUrl(url=''){ try{const u=new URL(url);const h=u.hostname.replace(/^www\./,'').toLowerCase();return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);}catch{return false;} }
    function toYouTubeEmbed(url=''){ try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();let id='';let start=u.searchParams.get('start')||u.searchParams.get('t')||'';if(start&&/^\d+s$/.test(start))start=parseInt(start,10);if(start&&/^\d+$/.test(start))start=parseInt(start,10);if(!Number.isFinite(start))start=''; if(host==='youtu.be'){id=(u.pathname||'').replace(/^\//,'').split('/')[0];} else { if(u.pathname.startsWith('/embed/')) id=u.pathname.split('/')[2]||''; if(!id) id=u.searchParams.get('v')||''; } if(!id) return null; const base=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`; const qs=new URLSearchParams(); qs.set('rel','0'); if(start) qs.set('start', String(start)); return `${base}?${qs.toString()}`; }catch{return null;} }
    function kindFrom({url='', name='', mime=''}) {
      const ext = (extFromUrl(url) || extFromName(name)).toLowerCase();
      if (isYouTubeUrl(url)) return 'youtube';
      if ((mime||'').startsWith('image/') || ['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
      if (mime === 'application/pdf' || ext === 'pdf') return 'pdf';
      if ((mime||'').startsWith('video/') || ['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
      if ((mime||'').startsWith('audio/') || ['mp3','wav','m4a','ogg','aac','flac'].includes(ext)) return 'audio';
      if ((mime||'').startsWith('text/') || ['txt','csv','log'].includes(ext)) return 'text';
      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
      return 'other';
    }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function setFileInfoUI(kind,url){
      const info=document.getElementById('fileInfoText');
      const hdr=document.getElementById('filePreviewModalLabel');
      const labelMap={youtube:'YouTube',video:'Video',audio:'Audio',image:'Image',pdf:'PDF',text:'Text/CSV',office:'Office Doc',other:'File'};
      let badge=document.getElementById('fileKindBadge'); if(!badge){badge=document.createElement('span');badge.id='fileKindBadge';badge.className='ms-2 badge rounded-pill';hdr.appendChild(badge);}
      badge.className='ms-2 badge rounded-pill bg-secondary-subtle text-secondary';
      badge.textContent=labelMap[kind]||'File';
      info.innerHTML=`<span class="text-muted">Type:</span> <strong>${labelMap[kind]||'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href=url||'#';
    }
    function renderFilePreviewInto(container, {url, name='', mime='', isStaged=false}){
      container.innerHTML=''; showSpinner(true);
      const done=()=>showSpinner(false);
      const fallback=(msg)=>{ container.innerHTML=`<div class="preview-fallback"><div class="text-muted mb-2">${msg||'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; done(); };
      const kind = kindFrom({url, name, mime});
      if(kind==='youtube'){ const embed=toYouTubeEmbed(url); if(embed){container.innerHTML=`<div class="ratio ratio-16x9"><iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>`; done(); return;} return fallback('Couldn’t embed this YouTube link.'); }
      if(kind==='image'){ const img=new Image(); img.onload=done; img.onerror=()=>fallback('Image preview failed.'); img.src=url; container.appendChild(img); return; }
      if(kind==='pdf'){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('PDF preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(kind==='video'){ const v=document.createElement('video'); v.controls=true; v.onloadeddata=done; v.onerror=()=>fallback('Video preview failed.'); v.src=url; container.appendChild(v); return; }
      if(kind==='audio'){ const a=document.createElement('audio'); a.controls=true; a.onloadeddata=done; a.onerror=()=>fallback('Audio preview failed.'); a.src=url; container.appendChild(a); return; }
      if(kind==='text'){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Text preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(kind==='office' && url.startsWith('blob:')){ return fallback('Office documents cannot be previewed until they’re uploaded. Please Create first, then preview in Edit.'); }
      if(kind==='office'){ const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Office preview failed (Google Viewer blocked).'); iframe.src=gview; container.appendChild(iframe); return; }
      const obj=document.createElement('object'); obj.data=url; obj.type=mime||'application/octet-stream'; obj.onload=done; obj.onerror=()=>fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(done,1200);
    }

    /* ===== Previews & Stage button context ===== */
    let currentPreviewRevoke = null;
    let previewStageCtx = null; // { mode:'file'|'rubric', files?:File[], file?:File }
    const stageFromPreviewBtn = document.getElementById('stageFromPreviewBtn');

    function showStageBtn(show, label){
      stageFromPreviewBtn.classList.toggle('d-none', !show);
      if (label) stageFromPreviewBtn.innerHTML = `<i class="bi bi-cloud-plus me-1"></i> ${label}`;
    }

    document.getElementById('filePreviewModal').addEventListener('hidden.bs.modal', ()=>{
      if (typeof currentPreviewRevoke === 'function') { try { currentPreviewRevoke(); } catch {} }
      currentPreviewRevoke = null;
      previewStageCtx = null;
      showStageBtn(false);
    });

    function openPreviewModalWithMeta({url, title='File', mime='', isStaged=false, stageContext=null}){
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      setFileInfoUI(kindFrom({url, name:title, mime}), url);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), {url, name:title, mime, isStaged});
      previewStageCtx = stageContext || null;
      if (previewStageCtx) {
        const label = (previewStageCtx.mode === 'rubric') ? 'Stage this rubric' : 'Stage this file';
        showStageBtn(true, label);
      } else {
        showStageBtn(false);
      }
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    stageFromPreviewBtn.addEventListener('click', ()=>{
      if (!previewStageCtx) return;

      if (previewStageCtx.mode === 'file' && Array.isArray(previewStageCtx.files)) {
        previewStageCtx.files.forEach(f => { f.__uid = Math.random().toString(36).slice(2,10); staged.addFiles.push(f); });
        fileInput.value = '';
        renderAttachments();
        bootstrap.Modal.getInstance(document.getElementById('filePreviewModal')).hide();
        showInfo('Staged','File(s) are staged and will be uploaded on Create.');
      }
      if (previewStageCtx.mode === 'rubric' && previewStageCtx.file) {
        const f = previewStageCtx.file;
        f.__uid = Math.random().toString(36).slice(2,10);
        staged.addRubric = f; // replace any previous staged rubric
        rubricInput.value = '';
        renderAttachments();
        bootstrap.Modal.getInstance(document.getElementById('filePreviewModal')).hide();
        showInfo('Staged','Rubric is staged and will be uploaded on Create.');
      }
      previewStageCtx = null;
      showStageBtn(false);
    });

    function showInfo(title, body){
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').innerHTML = body;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('infoModal')).show();
    }

    /* ===== DOM refs ===== */
    const courseSelect = document.getElementById("courseSelect");
    const moduleSelect = document.getElementById("moduleSelect");
    const moduleHelp   = document.getElementById("moduleHelp");
    const form         = document.getElementById("assignmentForm");
    const formError    = document.getElementById("formError");
    const submitBtn    = document.getElementById("submitBtn");
    const spinner      = submitBtn.querySelector(".spinner-border");
    const submitText   = submitBtn.querySelector(".submit-text");

    const fileInput      = document.getElementById('fileInput');
    const btnPreviewSelectedFiles = document.getElementById('btnPreviewSelectedFiles');
    const btnStageFiles  = document.getElementById('btnStageFiles');
    const rubricInput    = document.getElementById('rubricInput');
    const btnPreviewRubric = document.getElementById('btnPreviewRubric');
    const btnStageRubric = document.getElementById('btnStageRubric');
    const linkInput      = document.getElementById('linkInput');
    const btnPreviewLink = document.getElementById('btnPreviewLink');
    const btnStageLink   = document.getElementById('btnStageLink');
    const filesList      = document.getElementById('filesList');
    const pointsInput    = document.getElementById('points');

    // Auto-correct points to [0..100]
    if (pointsInput) {
      pointsInput.addEventListener("change", () => {
        const v = pointsInput.value.trim();
        if (v === "") return;
        const n = parseInt(v, 10);
        if (Number.isNaN(n)) { pointsInput.value = ""; return; }
        pointsInput.value = String(clamp(n, 0, 100));
      });
      pointsInput.addEventListener("input", () => {
        pointsInput.classList.remove("is-invalid");
        formError.textContent = "";
      });
    }

    /* ===== Staging ===== */
    let staged = {
      addFiles: [],      // File[]
      addLinks: [],      // string[]
      addRubric: null    // File | null
    };

    function badgeForType(att){
      if (att.type === 'link') return `<span class="badge-soft badge-link"><i class="bi bi-link-45deg"></i> Link</span>`;
      if (att.type === 'rubrics') return `<span class="badge-soft badge-rubric"><i class="bi bi-clipboard-check"></i> Rubric</span>`;
      return `<span class="badge-soft badge-file"><i class="bi bi-file-earmark"></i> File</span>`;
    }
    function chip(text, cls=''){ return `<span class="badge-soft ${cls}" style="font-size:.72rem">${esc(text)}</span>`; }

    function getStagedView(){
      const out = [];
      for (const f of staged.addFiles) {
        out.push({ id:`__staged_file_${f.__uid}`, type:'file', __staged:true, __stagedName:f.name });
      }
      if (staged.addRubric) {
        out.push({ id:`__staged_rubric_${staged.addRubric.__uid}`, type:'rubrics', __staged:true, __stagedName: staged.addRubric.name });
      }
      for (const link of staged.addLinks) {
        out.push({ id:`__staged_link_${btoa(link).slice(0,12)}`, type:'link', __staged:true, __stagedName: link, url: link });
      }
      return out;
    }

    function renderAttachments(){
      const view = getStagedView();
      if (!view.length) {
        filesList.innerHTML = `<li class="text-muted">Nothing staged yet.</li>`;
        return;
      }
      filesList.innerHTML = view.map(att=>{
        const nameHtml = `<span>${esc(att.__stagedName || '')}</span>`;
        const left = `
          ${badgeForType(att)}
          <div class="file-name">
            <button type="button" class="btn btn-link p-0 align-baseline" data-act="preview" title="Preview">${nameHtml}</button>
          </div>
        `;
        let controls = `
          <button class="btn btn-outline-secondary btn-sm btn-icon" data-act="preview" title="Preview">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-outline-danger btn-sm btn-icon" data-act="unstage" title="Remove from staging">
            <i class="bi bi-x-lg"></i>
          </button>
        `;
        if (att.type === 'rubrics') {
          controls = `
            <label class="btn btn-outline-secondary btn-sm btn-icon mb-0" title="Replace rubric">
              <i class="bi bi-arrow-repeat"></i>
              <input type="file" class="d-none input-replace-rubric"/>
            </label>
            ${controls}
          `;
        }
        return `
          <li class="file-item" data-id="${esc(att.id)}" data-type="${att.type}">
            ${left}
            ${chip('Staged','badge-stage')}
            <div class="d-flex align-items-center gap-1">${controls}</div>
          </li>
        `;
      }).join('');
    }

    filesList.addEventListener('click', (e)=>{
      const li = e.target.closest('.file-item'); if (!li) return;
      const id = li.getAttribute('data-id');
      const type = li.getAttribute('data-type');
      const item = getStagedView().find(x => x.id === id);
      if (!item) return;

      if (e.target.closest('[data-act="preview"]')) {
        if (type === 'link') {
          openPreviewModalWithMeta({ url: item.__stagedName, title: item.__stagedName, mime:'', isStaged:true });
          return;
        }
        if (type === 'file') {
          const file = staged.addFiles.find(f => `__staged_file_${f.__uid}` === id);
          if (!file) return showInfo('Preview','Cannot preview this staged file.');
          const url = URL.createObjectURL(file); currentPreviewRevoke = ()=>URL.revokeObjectURL(url);
          openPreviewModalWithMeta({ url, title:file.name, mime:file.type||'', isStaged:true });
          return;
        }
        if (type === 'rubrics') {
          const f = staged.addRubric;
          if (!f) return showInfo('Preview','No staged rubric to preview.');
          const url = URL.createObjectURL(f); currentPreviewRevoke = ()=>URL.revokeObjectURL(url);
          openPreviewModalWithMeta({ url, title:f.name, mime:f.type||'', isStaged:true });
          return;
        }
      }

      if (e.target.closest('[data-act="unstage"]')) {
        if (type === 'file') staged.addFiles = staged.addFiles.filter(f => `__staged_file_${f.__uid}` !== id);
        if (type === 'rubrics') staged.addRubric = null;
        if (type === 'link') {
          const it = getStagedView().find(x => x.id === id);
          if (it?.__stagedName) staged.addLinks = staged.addLinks.filter(l => l !== it.__stagedName);
        }
        renderAttachments();
      }
    });

    filesList.addEventListener('change', (e)=>{
      if (!e.target.matches('.input-replace-rubric')) return;
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      file.__uid = Math.random().toString(36).slice(2,10);
      staged.addRubric = file;
      e.target.value = '';
      renderAttachments();

      const url = URL.createObjectURL(file); currentPreviewRevoke = ()=>URL.revokeObjectURL(url);
      openPreviewModalWithMeta({ url, title:file.name, mime:file.type||'', isStaged:true });
    });

    /* ===== Pre-stage preview buttons ===== */
    btnPreviewSelectedFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      const files = fileInput.files;
      if (!files || !files.length) { showInfo('Nothing selected','Choose one or more files first.'); return; }
      const f = files[0];
      const blobUrl = URL.createObjectURL(f);
      currentPreviewRevoke = ()=>URL.revokeObjectURL(blobUrl);
      openPreviewModalWithMeta({
        url: blobUrl, title: f.name, mime: f.type || '', isStaged:true,
        stageContext: { mode:'file', files: Array.from(files) }
      });
    });

    btnPreviewRubric.addEventListener('click', (e)=>{
      e.preventDefault();
      const f = rubricInput.files && rubricInput.files[0];
      if (!f) { showInfo('No rubric selected','Choose a rubric file first.'); return; }
      const blobUrl = URL.createObjectURL(f);
      currentPreviewRevoke = ()=>URL.revokeObjectURL(blobUrl);
      openPreviewModalWithMeta({
        url: blobUrl, title: f.name, mime: f.type || '', isStaged:true,
        stageContext: { mode:'rubric', file: f }
      });
    });

    btnPreviewLink.addEventListener('click', (e)=>{
      e.preventDefault();
      const val = (linkInput.value || '').trim();
      if (!val) { showInfo('No link entered','Paste a URL first.'); return; }
      openPreviewModalWithMeta({url: val, title: val, mime:''});
    });

    /* ===== Stage buttons ===== */
    btnStageFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      const files = fileInput.files;
      if (!files || !files.length) { showInfo('Nothing to Stage','Please choose one or more files.'); return; }
      const tooBig = Array.from(files).find(f => f.size > TEACHER_MAX_BYTES);
      if (tooBig) { showInfo('Too large', `${esc(tooBig.name)} exceeds ${TEACHER_MAX_MB} MB.`); return; }
      Array.from(files).forEach(f => { f.__uid = Math.random().toString(36).slice(2,10); staged.addFiles.push(f); });
      fileInput.value = '';
      renderAttachments();
      showInfo('Staged','File(s) are staged and will be uploaded on Create.');
    });

    btnStageRubric.addEventListener('click', (e)=>{
      e.preventDefault();
      const f = rubricInput.files && rubricInput.files[0];
      if (!f) { showInfo('No Rubric Selected','Please choose a rubric file.'); return; }
      if (f.size > TEACHER_MAX_BYTES) { showInfo('Too large', `${esc(f.name)} exceeds ${TEACHER_MAX_MB} MB.`); return; }
      f.__uid = Math.random().toString(36).slice(2,10);
      staged.addRubric = f; // keep only latest
      rubricInput.value = '';
      renderAttachments();
      showInfo('Staged','Rubric is staged and will be uploaded on Create.');
    });

    btnStageLink.addEventListener('click', (e)=>{
      e.preventDefault();
      const val = (linkInput.value || '').trim();
      if (!val) { showInfo('No Link','Please paste a URL.'); return; }
      staged.addLinks.push(val);
      linkInput.value = '';
      renderAttachments();
      showInfo('Staged','Link will be added on Create.');
    });

    /* Auto pre-preview when selecting one file/rubric */
    fileInput.addEventListener('change', ()=>{
      const fs = fileInput.files;
      if (fs && fs.length === 1) {
        const f = fs[0];
        if (f.size > TEACHER_MAX_BYTES) { showInfo('Too large', `${esc(f.name)} exceeds ${TEACHER_MAX_MB} MB.`); return; }
        const blobUrl = URL.createObjectURL(f);
        currentPreviewRevoke = ()=>URL.revokeObjectURL(blobUrl);
        openPreviewModalWithMeta({
          url: blobUrl, title: f.name, mime: f.type||'', isStaged:true,
          stageContext: { mode:'file', files: [f] }
        });
      }
    });
    rubricInput.addEventListener('change', ()=>{
      const f = rubricInput.files && rubricInput.files[0];
      if (f) {
        if (f.size > TEACHER_MAX_BYTES) { showInfo('Too large', `${esc(f.name)} exceeds ${TEACHER_MAX_MB} MB.`); rubricInput.value=''; return; }
        const blobUrl = URL.createObjectURL(f);
        currentPreviewRevoke = ()=>URL.revokeObjectURL(blobUrl);
        openPreviewModalWithMeta({
          url: blobUrl, title: f.name, mime: f.type||'', isStaged:true,
          stageContext: { mode:'rubric', file: f }
        });
      }
    });

    /* ===== Assign-to-Classes (FILTERED BY SELECTED COURSE) ===== */
    const assignedContainer = document.getElementById("assignedClassesContainer");
    const assignedStatus = document.getElementById("assigned-status");
    const assignedEmpty = document.getElementById("assigned-empty");
    let selectedClassIds = new Set();   // working selection

    const DEBUG_CLASSES = false;
    const dlog = (...a) => { if (DEBUG_CLASSES) console.log('[classes]', ...a); };

    function renderClassCards(classes) {
      assignedContainer.innerHTML = "";
      if (!classes.length) {
        assignedStatus.style.display = "none";
        assignedEmpty.style.display = "block";
        assignedEmpty.textContent = "No classes found for the selected course.";
        return;
      }
      classes.forEach(c => {
        const id = String(c.id || c._id || c.classId || "");
        const name = c.name || c.className || "Untitled Class";
        const grade = c.gradeLevel ?? c.grade ?? "—";
        const section = c.section ?? c.sectionName ?? "—";

        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-lg-4";

        const card = document.createElement("div");
        card.className = "card assign-card";
        card.tabIndex = 0;

        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.value = id;
        chk.className = "d-none";
        if (selectedClassIds.has(id)) {
          chk.checked = true;
          card.classList.add("selected");
        }
        card.appendChild(chk);

        const body = document.createElement("div");
        body.className = "card-body";
        body.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="card-title mb-1">${esc(name)}</h5>
            <i class="bi bi-check2-circle ms-2" style="opacity:.35;"></i>
          </div>
          <div class="small-muted">Grade ${esc(grade)} • Section ${esc(section)}</div>
        `;
        card.appendChild(body);

        function toggle() {
          const isChecked = !chk.checked;
          chk.checked = isChecked;
          card.classList.toggle("selected", isChecked);
          if (isChecked) selectedClassIds.add(id);
          else selectedClassIds.delete(id);
        }
        card.addEventListener("click", e => {
          if (window.getSelection && String(window.getSelection()).length) return;
          toggle();
        });
        card.addEventListener("keydown", e => {
          if (e.key === " " || e.key === "Enter") { e.preventDefault(); toggle(); }
        });

        col.appendChild(card);
        assignedContainer.appendChild(col);
      });
      assignedStatus.style.display = "none";
      assignedEmpty.style.display = "none";
    }

    async function fetchFirst(urls, opts) {
      for (const u of urls) {
        try { const res = await fetch(u, opts); if (res.ok) return res; } catch(_) {}
      }
      return fetch(urls[0], opts);
    }

    async function fetchCourseById(courseId) {
      if (!courseId) return null;
      try {
        const res = await fetchFirst(
          [ api(`/api/courses/${encodeURIComponent(courseId)}`),
            api(`/courses/${encodeURIComponent(courseId)}`) ],
          { headers: { Accept: "application/json" } }
        );
        const js = await res.json().catch(()=>null);
        return js?.course || js || null;
      } catch { return null; }
    }

    // Loader: (teacher's classes) ∩ (selected course's assignedClasses)
    async function loadTeacherClassesAndRender(courseIdFromSelect) {
      try {
        assignedStatus.style.display = "";
        assignedStatus.classList.remove('text-danger');
        assignedStatus.classList.add('small-muted');
        assignedStatus.textContent = "Loading your classes…";
        assignedEmpty.style.display = "none";
        assignedContainer.innerHTML = "";

        const teacherId = window.currentUser?.userId || window.currentUser?.id || window.currentUser?.uid || '';
        if (!teacherId) {
          assignedStatus.textContent = "Missing teacher ID in your session.";
          assignedStatus.classList.remove('small-muted'); assignedStatus.classList.add('text-danger');
          return;
        }

        // 1) Teacher classes
        const res = await fetch(api(`/api/classes?teacherId=${encodeURIComponent(teacherId)}`), { headers: { "Accept": "application/json" } });
        const js = await res.json().catch(()=>({ success: false, classes: [] }));
        const teacherClasses = Array.isArray(js?.classes) ? js.classes : [];
        dlog('teacherClasses:', teacherClasses.length);

        // If no course chosen yet, show everything and prompt to pick a course
        const courseId = (courseIdFromSelect || '').trim();
        if (!courseId) {
          renderClassCards(teacherClasses);
          if (teacherClasses.length) {
            assignedStatus.textContent = "Select a course to filter eligible classes.";
          } else {
            assignedStatus.style.display = "none";
            assignedEmpty.style.display = "block";
            assignedEmpty.textContent = "No classes found for your account.";
          }
          return;
        }

        // 2) Course -> assignedClasses
        const course = await fetchCourseById(courseId);
        const assigned = Array.isArray(course?.assignedClasses) ? course.assignedClasses : [];
        const allowedIds = new Set(assigned.map(x => String(x)));
        dlog('course.assignedClasses:', assigned);

        // 3) Intersect
        let filtered = teacherClasses.filter(c => {
          const id = String(c.id || c._id || c.classId || '');
          return allowedIds.size ? allowedIds.has(id) : true;
        });
        dlog('filtered after intersect:', filtered.length);

        // 4) Optional fallback: /courses/:id/classes
        if (filtered.length === 0) {
          try {
            const r2 = await fetch(api(`/courses/${encodeURIComponent(courseId)}/classes`), { headers:{Accept:'application/json'} });
            if (r2.ok) {
              const j2 = await r2.json().catch(()=>({}));
              const classes2 = Array.isArray(j2) ? j2 : (Array.isArray(j2?.classes) ? j2.classes : []);
              filtered = classes2.filter(c => {
                const id = String(c.id || c._id || c.classId || '');
                return allowedIds.size ? allowedIds.has(id) : true;
              });
              dlog('fallback /courses/:id/classes ->', classes2.length, 'after intersect ->', filtered.length);
            }
          } catch {}
        }

        // 5) Trim current selections to visible set (avoid submitting illegal IDs)
        const visibleIds = new Set(filtered.map(c => String(c.id || c._id || c.classId || '')));
        selectedClassIds = new Set([...selectedClassIds].filter(id => visibleIds.has(String(id))));

        if (!filtered.length) {
          assignedContainer.innerHTML = "";
          assignedEmpty.style.display = "block";
          assignedEmpty.textContent = "No classes enrolled in this course.";
          assignedStatus.style.display = "none";
          return;
        }

        renderClassCards(filtered);
        assignedStatus.textContent = `${selectedClassIds.size} selected (eligible for this course)`;
        assignedStatus.style.display = "";
      } catch (e) {
        console.error("Could not load classes:", e);
        assignedStatus.textContent = "Could not load your classes. Please refresh.";
        assignedStatus.classList.remove('small-muted');
        assignedStatus.classList.add('text-danger');
        showInfo('Network Error', 'Could not load your classes. Please refresh and try again.');
      }
    }

    /* ===== Load courses & modules ===== */
    async function loadCourses() {
      courseSelect.innerHTML = `<option value="">Loading courses…</option>`;
      moduleSelect.innerHTML = `<option value="">Select a course first…</option>`;
      moduleSelect.disabled = true;

      try {
        const res = await fetchFirst([
          api(`/api/courses?uploadedBy=${encodeURIComponent((window.currentUser||{}).userId||'')}&includeArchived=false`),
          api(`/courses?uploadedBy=${encodeURIComponent((window.currentUser||{}).userId||'')}`)
        ]);
        const data = await res.json();
        const courses = Array.isArray(data) ? data : Array.isArray(data.courses) ? data.courses : [];
        courses.sort((a,b)=> (a.title||'').localeCompare(b.title||'')); 
        if (!courses.length) {
          courseSelect.innerHTML = `<option value="" selected disabled>No courses yet — create one first</option>`;
          return;
        }
        courseSelect.innerHTML = `<option value="">Select a course…</option>` +
          courses.map(c => {
            const id = c.id || c._id || c.courseId || '';
            const title = c.title || 'Untitled';
            const num = c.courseNumber ? ` (#${esc(c.courseNumber)})` : '';
            return `<option value="${esc(String(id))}">${esc(title)}${num}</option>`;
          }).join('');
      } catch (err) {
        console.error("loadCourses failed:", err);
        courseSelect.innerHTML = `<option value="" selected disabled>(Failed to load)</option>`;
      }
    }

    async function loadModules(courseId) {
      moduleSelect.innerHTML = `<option value="">Loading…</option>`;
      moduleSelect.disabled = true;
      moduleHelp.textContent = "";
      if (!courseId) { moduleSelect.innerHTML = `<option value="">Select a course first…</option>`; return; }

      try {
        const res = await fetchFirst([
          api(`/api/courses/${encodeURIComponent(courseId)}/modules`),
          api(`/courses/${encodeURIComponent(courseId)}/modules`),
        ]);
        const data = await res.json();
        const mods = Array.isArray(data) ? data : Array.isArray(data.modules) ? data.modules : [];
        const sorted = mods.sort((a,b)=>(a.moduleNumber||0)-(b.moduleNumber||0));
        if (!sorted.length) {
          moduleSelect.innerHTML = `<option value="" selected disabled>No modules in this course</option>`;
          moduleHelp.textContent = "Add modules to this course before creating assignments.";
          return;
        }
        moduleSelect.innerHTML = `<option value="">Select a module…</option>`;
        sorted.forEach(m=>{
          const opt=document.createElement('option');
          opt.value=m.id || m._id || m.moduleId || '';
          opt.textContent=`Module ${m.moduleNumber ?? ''}: ${m.title || 'Untitled'}`;
          moduleSelect.appendChild(opt);
        });
        moduleSelect.disabled = false;
      } catch (err) {
        console.error("loadModules failed:", err);
        moduleSelect.innerHTML = `<option value="">Failed to load modules</option>`;
        moduleHelp.textContent = "Please reload the page or check your server.";
      }
    }

    // When course changes: refresh modules and class list (and clear selection)
    courseSelect.addEventListener("change", async (e)=>{
      const cid = e.target.value;
      selectedClassIds = new Set(); // reset selection when switching course
      await loadModules(cid);
      await loadTeacherClassesAndRender(cid);
    });

    /* ===== Submit (create) – sends staged items & assignedClasses ===== */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      formError.textContent = "";

      const courseId = (courseSelect.value || '').trim();
      const moduleId = (moduleSelect.value || '').trim();
      const title    = (document.getElementById("title").value || '').trim();
      const content  = (document.getElementById("content").value || '').trim();

      // Points strict validation
      const pointsV = pointsInput.value.trim();
      let points = null;
      if (pointsV !== "") {
        const n = parseInt(pointsV, 10);
        if (Number.isNaN(n)) {
          formError.textContent = "Points must be a whole number between 0 and 100.";
          pointsInput.classList.add("is-invalid");
          pointsInput.focus();
          return;
        }
        if (n > 100) {
          formError.textContent = "Over 100 is not allowed. Please set Points to 0–100.";
          pointsInput.classList.add("is-invalid");
          pointsInput.focus();
          return;
        }
        if (n < 0) {
          formError.textContent = "Points cannot be negative.";
          pointsInput.classList.add("is-invalid");
          pointsInput.focus();
          return;
        }
        points = n;
      }

      if (!courseId || !moduleId || !title || !content) {
        formError.textContent = "Please complete Course, Module, Title and Content.";
        return;
      }

      // size checks (300MB/file)
      const allFiles = [...staged.addFiles, ...(staged.addRubric ? [staged.addRubric] : [])];
      const tooLarge = allFiles.find(f => f.size > TEACHER_MAX_BYTES);
      if (tooLarge) {
        formError.textContent = `Each file must be ≤ ${TEACHER_MAX_MB} MB. Too large: ${tooLarge.name}`;
        return;
      }

      const publishAtVal = document.getElementById("publishAt").value;
      const dueAtVal     = document.getElementById("dueAt").value;

      const fd = new FormData();
      fd.append("teacherId", (window.currentUser||{}).userId || '');
      fd.append("courseId", courseId);
      fd.append("moduleId", moduleId);
      fd.append("title", title);
      fd.append("content", content);
      if (points !== null && !Number.isNaN(points)) fd.append("points", String(points));
      if (publishAtVal) fd.append("publishAt", String(toMillis(publishAtVal)));
      if (dueAtVal)     fd.append("dueAt", String(toMillis(dueAtVal)));

      // assigned classes
      Array.from(selectedClassIds).forEach(id => fd.append("assignedClasses", id));

      // staged files
      staged.addFiles.forEach(f => fd.append("files", f));
      if (staged.addRubric) fd.append("rubrics", staged.addRubric);
      staged.addLinks.forEach(l => fd.append("links", l)); // server accepts links or links[]

      // UI lock
      submitBtn.disabled = true;
      spinner.classList.remove("visually-hidden");
      submitText.textContent = "Creating…";

      try {
        const res = await fetch(api(`/api/assignments`), { method: "POST", body: fd });
        const raw = await res.text();
        let js = {}; try { js = JSON.parse(raw); } catch {}
        if (!res.ok || js.success === false) {
          const msg = (js && (js.message || js.error)) || `HTTP ${res.status} – ${raw.slice(0,200)}`;
          formError.textContent = msg || "Failed to create assignment.";
          return;
        }
        // Success
        showInfo('Success','✅ Assignment created!');
        setTimeout(()=>{ window.location.href = `/TEACHER/assignment/assignment_list.html?courseId=${encodeURIComponent(courseId)}`; }, 900);
      } catch (err) {
        console.error(err);
        formError.textContent = "Server error while creating assignment.";
      } finally {
        submitBtn.disabled = false;
        spinner.classList.add("visually-hidden");
        submitText.textContent = "Create Assignment";
      }
    });

    // Boot
    (async function init(){
      await loadCourses();
      // Initial: show all teacher classes but prompt to select a course; once selected it filters.
      await loadTeacherClassesAndRender('');
      renderAttachments();
    })();
  </script>

  <!-- Mobile-friendly datetime helper (unchanged) -->
  <script>
    (function enhanceDateTimeForMobile(){
      const isTouch = matchMedia('(hover: none) and (pointer: coarse)').matches;
      if (!isTouch) return;

      function makeSplit(id) {
        const original = document.getElementById(id);
        if (!original) return null;
        original.classList.add('dt-hidden');

        const wrap = document.createElement('div');
        wrap.className = 'dt-split';
        original.insertAdjacentElement('afterend', wrap);

        const date = document.createElement('input');
        date.type = 'date';
        date.className = 'form-control';
        date.id = id + '__date';

        const time = document.createElement('input');
        time.type = 'time';
        time.className = 'form-control';
        time.id = id + '__time';
        time.step = 60;

        wrap.append(date, time);

        if (original.value) {
          const d = new Date(original.value);
          if (!isNaN(d)) {
            date.value = d.toISOString().slice(0,10);
            time.value = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
          }
        }
        return { original, date, time, wrap };
      }

      const pub = makeSplit('publishAt');
      const due = makeSplit('dueAt');

      if (!pub && !due) return;

      function toLocalDatetimeValue(dateVal, timeVal){
        if (!dateVal || !timeVal) return '';
        const [hh, mm] = timeVal.split(':').map(Number);
        const d = new Date(dateVal);
        if (isNaN(d)) return '';
        d.setHours(hh || 0, mm || 0, 0, 0);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const da = String(d.getDate()).padStart(2,'0');
        const h = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${y}-${m}-${da}T${h}:${mi}`;
      }

      function syncOriginals(){
        if (pub) pub.original.value = toLocalDatetimeValue(pub.date.value, pub.time.value);
        if (due) due.original.value = toLocalDatetimeValue(due.date.value, due.time.value);
        if (pub && due) due.date.min = pub.date.value || '';
      }

      ['input','change'].forEach(ev => {
        if (pub){ pub.date.addEventListener(ev, syncOriginals); pub.time.addEventListener(ev, syncOriginals); }
        if (due){ due.date.addEventListener(ev, syncOriginals); due.time.addEventListener(ev, syncOriginals); }
      });

      const form = document.getElementById('assignmentForm');
      if (form) form.addEventListener('submit', syncOriginals, true);

      syncOriginals();
    })();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
