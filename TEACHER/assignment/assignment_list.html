<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduConnect Teacher - Assignments</title>

  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <link rel="stylesheet" href="../assignment/list.css" />

</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="searchBox" type="text" class="form-control" placeholder="Search assignments or modules…" />
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <div class="content container-fluid">
        <h1 class="page-title">Assignments</h1>

        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-journal-check"></i> Your Course Assignments</h2>
            <div class="ui-subtext">Everything shows up right away. Use the filters only if you want to narrow it down.</div>
          </div>

          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-4 col-xl-4">
              <label class="form-label">Course</label>
              <select id="courseSelect" class="form-select" aria-label="Filter by course">
                <option value="">All courses</option>
              </select>
            </div>

            <div class="col-12 col-md-3 col-xl-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort assignments">
                <option value="due" selected>Nearest due date</option>
                <option value="new">Newest first</option>
                <option value="az">Title A → Z</option>
              </select>
            </div>

            <div class="col-12 col-md-5 col-xl-3">
              <label class="form-label">Show</label>
              <div class="segmented" role="tablist" aria-label="Assignment visibility">
                <button id="btnActive" class="seg-btn is-active" role="tab" aria-selected="true">Active</button>
                <button id="btnArchived" class="seg-btn is-archived" role="tab" aria-selected="false">Archived</button>
                <button id="btnAll" class="seg-btn is-all" role="tab" aria-selected="false">All</button>
              </div>
            </div>

            <div class="col-12 col-xl-2 d-flex justify-content-xl-end">
              <button id="newAssignBtn" class="btn btn-amber w-100 w-xl-auto mt-2 mt-xl-0" onclick="goUpload()">
                <i class="bi bi-plus-circle me-1"></i>Create Assignment
              </button>
            </div>
          </div>
        </div>

        <!-- Always-visible count pills -->
        <div class="pill-row">
          <span id="activeCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-check-circle me-1"></i><span id="activeCount">0</span> Active
          </span>
          <span id="archivedCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-archive me-1"></i><span id="archivedCount">0</span> Archived
          </span>
        </div>

        <div id="assignmentGrid" class="row g-3"></div>
      </div>
    </div>
  </div>

  <!-- GENERIC INFO MODAL -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOk">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- GENERIC CONFIRM MODAL (also themed for type-to-confirm) -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Please Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal" id="confirmNoBtn">Cancel</button>
          <button type="button" class="btn btn-amber" id="confirmYesBtn">Yes, proceed</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-fixed">
    <div id="actionToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body fw-semibold">Done.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        });
    });
  </script>

  <!-- Header initials -->
  <script>
    (function initHeaderInitials() {
      try {
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;

        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return;
        }
        window.currentUser = u;

        const initials = getInitials(u);

        window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("Username");
          if (!el) return;
          el.textContent = initials;
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username || u.email || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        });
      } catch (e) {
        console.error('initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
      }

      function getInitials(u) {
        const fn = (u.firstName || '').trim();
        const ln = (u.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          const parts = nameish
            .replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
            .split(/[\s._-]+/).filter(Boolean);

          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }

        const em = (u.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();
  </script>

  <!-- Page logic -->
  <script>
    const API = "http://localhost:5000";

    // Auth
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    if (!userData || !userData.userId || !userData.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
    }
    document.getElementById("Username").textContent = userData.username || "";

    // DOM
    const elCourse = document.getElementById('courseSelect');
    const elGrid = document.getElementById('assignmentGrid');
    const elSort = document.getElementById('sortBy');
    const elSearch = document.getElementById('searchBox');
    const btnActive = document.getElementById('btnActive');
    const btnArchived = document.getElementById('btnArchived');
    const btnAll = document.getElementById('btnAll');

    // Count pills
    const elActiveCount = document.getElementById('activeCount');
    const elArchivedCount = document.getElementById('archivedCount');

    // State
    let coursesList = [];
    let courseMap = new Map();
    let masterAssignments = [];
    let filtered = [];
    let currentCourseId = '';
    let statusFilter = 'active';

    // Cache for module lookups
    const moduleCache = new Map();
    // submission counts cache
    const submissionCountCache = new Map();

    // Utils
    function logoutUser() { localStorage.clear(); sessionStorage.clear(); window.location.href = "/TEACHER/login/login.html"; }
    function escapeHTML(str = '') { return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", "&#039;"); }
    function goUpload() { window.location.href = "/TEACHER/assignment/assignment_upload.html"; }
    function goEdit(courseId, assignmentId) {
      const params = new URLSearchParams({ courseId, assignmentId });
      window.location.href = `/TEACHER/assignment/edit_assignment.html?${params.toString()}`;
    }
    function goToGraded(courseId, assignmentId) {
      const params = new URLSearchParams({ courseId, assignmentId });
      window.location.href = `/TEACHER/assignment/grade_submission.html?${params.toString()}`;
    }
    function tsToMs(ts) {
      if (!ts) return null;
      const s = ts?._seconds ?? ts?.seconds;
      const ns = ts?._nanoseconds ?? ts?.nanoseconds ?? 0;
      if (typeof s === 'number') return (s * 1000) + Math.floor(ns / 1e6);
      if (typeof ts === 'number') return ts;
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d.getTime();
    }
    function fmtDateTime(ms) {
      if (!ms) return 'N/A';
      const d = new Date(ms);
      return isNaN(d.getTime()) ? 'N/A' : d.toLocaleString();
    }
    function showToast(msg, variant = 'success') {
      const el = document.getElementById('actionToast');
      el.className = `toast align-items-center text-bg-${variant} border-0`;
      el.querySelector('.toast-body').textContent = msg;
      const t = bootstrap.Toast.getOrCreateInstance(el, { delay: 1600 });
      t.show();
    }

    // Info/Confirm helpers
    function showInfoModal({ title = 'Notice', html = '', autoHideMs = 0, onHidden = null } = {}) {
      const el = document.getElementById('infoModal');
      document.getElementById('infoModalLabel').textContent = title;
      document.getElementById('infoModalBody').innerHTML = html;
      const modal = new bootstrap.Modal(el);
      if (onHidden) el.addEventListener('hidden.bs.modal', onHidden, { once: true });
      modal.show();
      if (autoHideMs > 0) setTimeout(() => modal.hide(), autoHideMs);
    }
    function showConfirmModal({ title = 'Please Confirm', html = 'Are you sure?', yesText = 'Yes, proceed', noText = 'Cancel' } = {}) {
      return new Promise(resolve => {
        const el = document.getElementById('confirmModal');
        document.getElementById('confirmModalLabel').textContent = title;
        document.getElementById('confirmModalBody').innerHTML = html;
        const yesBtn = document.getElementById('confirmYesBtn');
        const noBtn = document.getElementById('confirmNoBtn');
        yesBtn.textContent = yesText;
        noBtn.textContent = noText;

        // remove themed class if previously added
        el.querySelector('.modal-content').classList.remove('confirm-themed');

        const modal = new bootstrap.Modal(el);
        const cleanup = (val) => {
          yesBtn.removeEventListener('click', onYes);
          noBtn.removeEventListener('click', onNo);
          el.removeEventListener('hidden.bs.modal', onDismiss);
          resolve(val);
        };
        function onYes() { modal.hide(); cleanup(true); }
        function onNo() { modal.hide(); cleanup(false); }
        function onDismiss() { cleanup(false); }

        yesBtn.addEventListener('click', onYes);
        noBtn.addEventListener('click', onNo);
        el.addEventListener('hidden.bs.modal', onDismiss, { once: true });
        modal.show();
      });
    }

    /* ===== Type-to-confirm helper (expects exact text) =====
       Hardened: cannot copy the phrase OR the hint, and input blocks paste/⌘V/drag-drop. */
    function showTypeToConfirm({ title, expected, placeholder='Type here', primaryText='Delete' }){
      return new Promise((resolve)=>{
        const el = document.getElementById('confirmModal');
        const content = el.querySelector('.modal-content');
        content.classList.add('confirm-themed');

        document.getElementById('confirmModalLabel').textContent = title || 'Confirm';
        const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;');
        const escAttr = s => String(s).replace(/"/g,'&quot;');
        const body = document.getElementById('confirmModalBody');

        body.innerHTML = `
          <p class="mb-2">
            Confirm you want to delete this assignment by typing the exact <strong>Assignment Title</strong> (case-sensitive).
          </p>
          <div class="no-copy pill-danger mb-2" id="ttcPill">
            Type exactly: <strong id="ttcExpected">${esc(expected||'')}</strong>
          </div>
          <div class="mb-1">
            <input id="ttcInput" type="text" class="form-control is-invalid" placeholder="${escAttr(placeholder)}" autocomplete="off" autocapitalize="off" spellcheck="false">
          </div>
          <div id="ttcBad" class="invalid-msg no-copy">Input does not match. Please type <strong>${esc(expected||'')}</strong> to proceed.</div>
          <div id="ttcGood" class="valid-msg d-none">✓ Input matches</div>
        `;

        const okBtn = document.getElementById('confirmYesBtn');
        const cancelBtn = document.getElementById('confirmNoBtn');
        okBtn.textContent = primaryText;
        okBtn.className = 'btn btn-danger';
        okBtn.disabled = true;

        // Hardening: block copy/cut/context menu/drag/drop on modal, pill, and hint
        const pill = body.querySelector('#ttcPill');
        const bad = body.querySelector('#ttcBad');
        const guardRoots = [el, pill, bad];
        const block = e => e.preventDefault();
        guardRoots.forEach(node=>{
          ['copy','cut','contextmenu','dragstart','drop','dragover'].forEach(evt => node.addEventListener(evt, block));
        });

        // Hardening: block paste / kb shortcuts / insertFromPaste on the input
        const input = body.querySelector('#ttcInput');
        const good = body.querySelector('#ttcGood');
        const expectedRaw = String(expected||'');
        input.addEventListener('paste', block);
        input.addEventListener('beforeinput', e => {
          if ((e.inputType||'').toLowerCase().includes('insertfrompaste')) e.preventDefault();
        });
        input.addEventListener('keydown', e => {
          const k = (e.key||'').toLowerCase();
          if ((e.ctrlKey || e.metaKey) && (k==='v' || k==='x' || k==='c' || k==='a')) e.preventDefault();
        });

        function refresh(){
          const ok = (input.value === expectedRaw);
          okBtn.disabled = !ok;
          input.classList.toggle('is-valid', ok);
          input.classList.toggle('is-invalid', !ok);
          bad.classList.toggle('d-none', ok);
          good.classList.toggle('d-none', !ok);
        }
        input.addEventListener('input', refresh);
        setTimeout(()=>input.focus(), 60);

        let confirmed = false;
        const modal = bootstrap.Modal.getOrCreateInstance(el);
        const onOk = () => { if (!okBtn.disabled){ confirmed = true; modal.hide(); } };
        const onCancel = () => { modal.hide(); };
        const onHidden = () => {
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
          el.removeEventListener('hidden.bs.modal', onHidden);
          content.classList.remove('confirm-themed');
          // cleanup guards
          guardRoots.forEach(node=>{
            ['copy','cut','contextmenu','dragstart','drop','dragover'].forEach(evt => node.removeEventListener(evt, block));
          });
          input.removeEventListener('paste', block);
          resolve(confirmed);
        };

        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
        el.addEventListener('hidden.bs.modal', onHidden, { once:true });
        modal.show();
      });
    }

    // Load courses
    async function loadCourses() {
      const res = await fetch(`${API}/courses?uploadedBy=${encodeURIComponent(userData.userId)}`);
      const courses = await res.json();
      courses.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      coursesList = courses.map((c, idx) => {
        const n = Number.isFinite(c?.courseNumber) ? c.courseNumber : (idx + 1);
        const title = c.title || c.name || 'Untitled';
        const label = `#${n} — ${title}`;
        courseMap.set(c.id, { title, courseNumber: n, label });
        return { id: c.id, title, courseNumber: n, label };
      });

      const opts = ['<option value="">All courses</option>'];
      coursesList.forEach(c => opts.push(`<option value="${c.id}">${escapeHTML(c.label)}</option>`));
      elCourse.innerHTML = opts.join('');
    }

    // Fetch a module doc and cache it
    async function fetchModuleMeta(moduleId) {
      if (!moduleId) return null;
      if (moduleCache.has(moduleId)) return moduleCache.get(moduleId);
      try {
        const res = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}`);
        const js = await res.json();
        const meta = js && js.id ? { title: js.title || '', moduleNumber: js.moduleNumber ?? null } : null;
        moduleCache.set(moduleId, meta);
        return meta;
      } catch (e) {
        console.warn('Module fetch failed for', moduleId, e);
        moduleCache.set(moduleId, null);
        return null;
      }
    }

    // Enrich assignments list with moduleTitle/moduleNumber
    async function hydrateModulesForAssignments(list) {
      const ids = [...new Set(list.map(a => a.moduleId).filter(Boolean))];
      await Promise.all(ids.map(id => fetchModuleMeta(id)));
      list.forEach(a => {
        const meta = a.moduleId ? moduleCache.get(a.moduleId) : null;
        if (meta) {
          if (!a.moduleTitle) a.moduleTitle = meta.title || '';
          if (a.moduleNumber == null) a.moduleNumber = meta.moduleNumber ?? null;
        }
      });
    }

    // NEW: fetch & cache submission count for an assignment
    async function fetchSubmissionCount(assignmentId) {
      try {
        const r = await fetch(`${API}/api/assignments/${encodeURIComponent(assignmentId)}/submissions`);
        const js = await r.json();
        if (!r.ok || js.success === false || !Array.isArray(js.submissions)) return 0;
        return js.submissions.length;
      } catch {
        return 0;
      }
    }

    async function warmSubmissionCounts(list, limit = 8) {
      const ids = list.map(a => a.id).filter(Boolean).filter(id => !submissionCountCache.has(id));
      let idx = 0;
      async function worker() {
        while (idx < ids.length) {
          const my = idx++;
          const id = ids[my];
          const count = await fetchSubmissionCount(id);
          submissionCountCache.set(id, count);
          const badge = document.querySelector(`[data-assignment-card="${id}"] .js-submission-count`);
          if (badge) badge.textContent = String(count);
        }
      }
      const pool = Array.from({ length: Math.min(limit, ids.length) }, worker);
      await Promise.all(pool);
    }

    // PRELOAD: load assignments across ALL courses (includes archived)
    async function preloadAllAssignments() {
      if (!coursesList.length) return;
      elGrid.innerHTML = `<div class="col-12"><div class="empty text-center">Loading assignments…</div></div>`;

      const promises = coursesList.map(c =>
        fetch(`${API}/api/courses/${encodeURIComponent(c.id)}/assignments?includeArchived=true`)
          .then(r => r.json().catch(() => ({ success: false })))
          .then(js => ({ course: c, payload: js }))
          .catch(() => ({ course: c, payload: { success: false, assignments: [] } }))
      );

      const results = await Promise.all(promises);
      const combined = [];
      results.forEach(({ course, payload }) => {
        const items = (payload && payload.success && Array.isArray(payload.assignments))
          ? payload.assignments : [];
        items.forEach(a => {
          combined.push({
            ...a,
            courseId: course.id,
            courseTitle: course.title,
            courseLabel: course.label,
            _dueMs: tsToMs(a.dueAt),
            _pubMs: tsToMs(a.publishAt),
            _createdMs: tsToMs(a.createdAt),
          });
        });
      });

      masterAssignments = combined;
      await hydrateModulesForAssignments(masterAssignments);

      currentCourseId = '';
      elCourse.value = '';
      elSort.value = 'due';
      elSearch.value = '';
      statusFilter = 'active';
      setSegmentedActive('active'); // will call applyFilters()

      refreshAssignmentPills();
      warmSubmissionCounts(masterAssignments).catch(()=>{});
    }

    function refreshAssignmentPills() {
      const activeCount = masterAssignments.filter(a => a.archived !== true).length;
      const archivedCount = masterAssignments.filter(a => a.archived === true).length;
      if (elActiveCount) elActiveCount.textContent = String(activeCount);
      if (elArchivedCount) elArchivedCount.textContent = String(archivedCount);
    }

    function applyFilters() {
      const q = (elSearch.value || '').toLowerCase().trim();

      const base = currentCourseId
        ? masterAssignments.filter(a => a.courseId === currentCourseId)
        : masterAssignments.slice();

      let list = base.filter(a => {
        const hay = `${a.title || ''} ${a.content || ''} ${a.moduleTitle || ''} ${a.moduleNumber != null ? ('module ' + a.moduleNumber) : ''} ${a.courseTitle || ''}`.toLowerCase();
        return hay.includes(q);
      });

      if (statusFilter === 'active') list = list.filter(a => a.archived !== true);
      if (statusFilter === 'archived') list = list.filter(a => a.archived === true);

      const sort = elSort.value;
      if (sort === 'az') list.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      else if (sort === 'due') list.sort((a, b) => (a._dueMs ?? Infinity) - (b._dueMs ?? Infinity));
      else list.sort((a, b) => (b._createdMs ?? b._pubMs ?? 0) - (a._createdMs ?? a._pubMs ?? 0));

      filtered = list;
      renderGrid();
      warmSubmissionCounts(filtered).catch(()=>{});
    }

    // ---- Archive / Unarchive ----
    async function setArchiveState(id, archived) {
      try {
        const res = await fetch(`${API}/api/assignments/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ archived: !!archived })
        });
        const js = await res.json();
        if (!res.ok || js.success === false) {
          throw new Error(js.message || 'Failed to update archive state.');
        }
        await preloadAllAssignments();
        showToast(archived ? 'Archived. Students can no longer see this.' : 'Unarchived. Students can see this again.', archived ? 'warning' : 'success');
      } catch (e) {
        console.error(e);
        showInfoModal({ title: 'Error', html: escapeHTML(e.message || 'Server error while updating.') });
      }
    }
    function archiveAssignment(id) {
      showConfirmModal({
        title: 'Archive Assignment',
        html: 'Archive this assignment? Students will no longer see it.'
      }).then(ok => { if (ok) setArchiveState(id, true); });
    }
    function unarchiveAssignment(id) { setArchiveState(id, false); }

    /* ===== Delete with TYPE-TO-CONFIRM (Assignment Title) ===== */
    async function deleteAssignment(id) {
      try {
        // Try to get the title for exact match (prefer the already-rendered data first)
        const card = document.querySelector(`[data-assignment-card="${CSS.escape(id)}"] h5`);
        let titleToMatch = card ? card.textContent.trim() : '';

        if (!titleToMatch) {
          // Fallback: fetch the assignment meta
          const metaRes = await fetch(`${API}/api/assignments/${encodeURIComponent(id)}`);
          if (metaRes.ok) {
            const meta = await metaRes.json().catch(() => ({}));
            titleToMatch = meta?.title || '';
          }
        }

        let ok = false;
        if (titleToMatch) {
          ok = await showTypeToConfirm({
            title: 'Delete Assignment',
            expected: String(titleToMatch),
            placeholder: 'Type Assignment Title here',
            primaryText: 'Delete'
          });
        } else {
          ok = await showConfirmModal({
            title: 'Delete Assignment',
            html: '<strong>Permanently delete</strong> this assignment? This cannot be undone.',
            yesText: 'Delete',
            noText: 'Cancel'
          });
        }
        if (!ok) return;

        const res = await fetch(`${API}/api/assignments/${id}`, { method: 'DELETE' });
        const js = await res.json();
        if (!res.ok || !js.success) {
          showInfoModal({ title: 'Delete Failed', html: escapeHTML(js.message || 'Failed to delete assignment.') });
          return;
        }
        showToast('Assignment deleted.', 'warning');
        await preloadAllAssignments();
      } catch (e) {
        console.error(e);
        showInfoModal({ title: 'Server Error', html: 'Server error while deleting.' });
      }
    }

    // Render cards
    function renderGrid() {
      if (!filtered.length) {
        elGrid.innerHTML = `<div class="col-12"><div class="empty text-center">No assignments found.</div></div>`;
        return;
      }
      elGrid.innerHTML = filtered.map(a => {
        const dueStr = fmtDateTime(a._dueMs);
        const pubStr = fmtDateTime(a._pubMs);
        const pts = (typeof a.points === 'number') ? `${a.points} pts` : '';

        const coursePill = a.courseLabel
          ? `<span class="pill pill-course" title="${escapeHTML(a.courseLabel)}">
              <i class="bi bi-collection"></i>
              <span class="pill-text">${escapeHTML(a.courseLabel)}</span>
             </span>`
          : '';

        let moduleLabel = '';
        if (a.moduleNumber != null && (a.moduleTitle || '').trim()) {
          moduleLabel = `Module ${a.moduleNumber} • ${a.moduleTitle}`;
        } else if (a.moduleNumber != null) {
          moduleLabel = `Module ${a.moduleNumber}`;
        } else if ((a.moduleTitle || '').trim()) {
          moduleLabel = a.moduleTitle;
        }

        const modulePill = moduleLabel
          ? `<span class="pill pill-module" title="${escapeHTML(moduleLabel)}">
              <i class="bi bi-box"></i>
              <span class="pill-text">${escapeHTML(moduleLabel)}</span>
             </span>`
          : '';

        const subCount = submissionCountCache.has(a.id) ? String(submissionCountCache.get(a.id)) : '…';

        return `
          <div class="col-12 col-md-6 col-xl-4 col-xxl-3">
            <div class="assignment-card ${a.archived === true ? 'archived' : ''}" data-assignment-card="${escapeHTML(a.id)}">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="m-0">${escapeHTML(a.title || 'Untitled')}</h5>
                <div class="d-flex align-items-center gap-2">
                  ${a.archived === true ? `<span class="pill pill-archived"><i class="bi bi-archive"></i>Archived</span>` : ''}
                  ${pts ? `<span class="badge-soft"><i class="bi bi-award"></i>${pts}</span>` : ``}
                </div>
              </div>

              <div class="mb-2 d-flex flex-wrap gap-1">${coursePill}${modulePill}</div>

              <div class="desc mb-2" title="${escapeHTML(a.content || '')}">
                ${escapeHTML(a.content || '')}
              </div>

              <div class="d-flex flex-column gap-1 small mb-3">
                <span class="text-muted"><i class="bi bi-calendar2-week me-1"></i><strong>Due:</strong> ${dueStr}</span>
                <span class="text-muted"><i class="bi bi-calendar-check me-1"></i><strong>Published:</strong> ${pubStr}</span>
                <span class="text-muted"><i class="bi bi-people me-1"></i><strong>Submissions:</strong> <span class="js-submission-count">${subCount}</span></span>
              </div>

              <div class="card-footer-actions">
                ${a.archived === true
                  ? `<button class="btn btn-sm btn-outline-success" onclick="unarchiveAssignment('${a.id}')">
                       <i class="bi bi-arrow-counterclockwise"></i> Unarchive
                     </button>`
                  : `<button class="btn btn-sm btn-outline-secondary" onclick="archiveAssignment('${a.id}')">
                       <i class="bi bi-archive"></i> Archive
                     </button>`}
                <button class="btn btn-sm btn-outline-warning" onclick="goEdit('${a.courseId}','${a.id}')">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAssignment('${a.id}')">
                  <i class="bi bi-trash"></i> Delete
                </button>
                <button class="btn btn-sm btn-amber" onclick="goToGraded('${a.courseId}','${a.id}')">
                  <i class="bi bi-list-check"></i> Grade
                </button>
              </div>

            </div>
          </div>
        `;
      }).join('');
    }

    // Segmented controls
    function setSegmentedActive(which) {
      statusFilter = which;
      const all = [btnActive, btnArchived, btnAll];
      all.forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected', 'false'); });
      if (which === 'active') { btnActive.classList.add('is-active'); btnActive.setAttribute('aria-selected', 'true'); }
      if (which === 'archived') { btnArchived.classList.add('is-active'); btnArchived.setAttribute('aria-selected', 'true'); }
      if (which === 'all') { btnAll.classList.add('is-active'); btnAll.setAttribute('aria-selected', 'true'); }
      applyFilters();
    }
    btnActive.addEventListener('click', () => setSegmentedActive('active'));
    btnArchived.addEventListener('click', () => setSegmentedActive('archived'));
    btnAll.addEventListener('click', () => setSegmentedActive('all'));

    // Other events
    elCourse.addEventListener('change', () => {
      currentCourseId = elCourse.value || '';
      applyFilters();
    });
    elSort.addEventListener('change', applyFilters);
    elSearch.addEventListener('input', applyFilters);

    // Boot
    (async function init() {
      try {
        await loadCourses();
        const params = new URLSearchParams(location.search);
        const preCourse = params.get('courseId');
        await preloadAllAssignments();
        if (preCourse && courseMap.has(preCourse)) {
          currentCourseId = preCourse;
          elCourse.value = preCourse;
          applyFilters();
        }
      } catch (e) {
        console.error(e);
        elGrid.innerHTML = `<div class="col-12"><div class="empty text-center text-danger">Failed to load assignments.</div></div>`;
      }
    })();

    // Expose for inline buttons
    window.deleteAssignment = deleteAssignment;
    window.goToGraded = goToGraded;
    window.archiveAssignment = archiveAssignment;
    window.unarchiveAssignment = unarchiveAssignment;
    window.goEdit = goEdit;
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
