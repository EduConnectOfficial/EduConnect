<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduConnect Teacher - Assignments</title>

  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Global dashboard CSS -->
  <link rel="stylesheet" href="../dashboard/dashboard.css" />
  <link rel="stylesheet" href="list.css" />

  <!-- Pills (course / module / archived) -->
  <style>
    .pill{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:700;
      border:1px solid var(--border, #e5e7eb);background:#fff;color:#374151;white-space:nowrap;
    }
    .pill .bi{font-size:.9rem}
    .pill-course{
      background:#fff7ed;border-color:#fed7aa;color:#9a3412; /* orange */
    }
    .pill-module{
      background:#ecfdf5;border-color:#a7f3d0;color:#065f46; /* emerald */
    }
    .pill-archived{
      background:#f3f4f6;border-color:#e5e7eb;color:#374151; /* gray */
    }

    /* keep toast anchored */
    .toast-fixed{position:fixed;right:16px;bottom:16px;z-index:1056}
  </style>
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box position-relative">
          <input id="searchBox" type="text" class="form-control" placeholder="Search assignments or modules…" />
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <div class="content container-fluid">
        <h1 class="page-title brand">Assignments</h1>

        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-journal-check"></i> Your Course Assignments</h2>
            <div class="ui-subtext">Everything shows up right away. Use the filters only if you want to narrow it down.</div>
          </div>

          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-4 col-xl-4">
              <label class="form-label">Course</label>
              <select id="courseSelect" class="form-select" aria-label="Filter by course">
                <option value="">All courses</option>
              </select>
            </div>

            <div class="col-12 col-md-3 col-xl-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort assignments">
                <option value="due" selected>Nearest due date</option>
                <option value="new">Newest first</option>
                <option value="az">Title A → Z</option>
              </select>
            </div>

            <!-- 3-button visibility filter -->
            <div class="col-12 col-md-5 col-xl-3">
              <label class="form-label">Show</label>
              <div class="segmented" role="tablist" aria-label="Assignment visibility">
                <button id="btnActive" class="seg-btn is-active" role="tab" aria-selected="true">Active</button>
                <button id="btnArchived" class="seg-btn is-archived" role="tab" aria-selected="false">Archived</button>
                <button id="btnAll" class="seg-btn is-all" role="tab" aria-selected="false">All</button>
              </div>
            </div>

            <!-- Keep Create Assignment -->
            <div class="col-12 col-xl-2 d-flex justify-content-xl-end">
              <button id="newAssignBtn" class="btn btn-amber w-100 w-xl-auto mt-2 mt-xl-0" onclick="goUpload()">
                <i class="bi bi-plus-circle me-1"></i>Create Assignment
              </button>
            </div>
          </div>

        </div>

        <div id="assignmentGrid" class="row g-3"></div>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="modal fade" id="editAssignmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="editForm">
          <div class="modal-header" style="background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2)); color:#FFD8A9;">
            <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Assignment</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">

            <div id="editError" class="text-danger mb-2" style="min-height:1rem;"></div>

            <input type="hidden" id="editAssignmentId" />

            <div class="row g-3">
              <div class="col-md-8">
                <label class="form-label">Title</label>
                <input type="text" id="editTitle" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Points</label>
                <input type="number" id="editPoints" min="0" step="1" class="form-control" />
              </div>
              <div class="col-12">
                <label class="form-label">Content / Instructions</label>
                <textarea id="editContent" rows="5" class="form-control" required></textarea>
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label class="form-label">Publish At</label>
                <input type="datetime-local" id="editPublishAt" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Due At</label>
                <input type="datetime-local" id="editDueAt" class="form-control" />
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-12">
                <label class="form-label">Module</label>
                <select id="editModuleId" class="form-select">
                  <option value="">— Keep current —</option>
                </select>
                <div class="form-text">Change only if you want to move this assignment to another module.</div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="saveEditBtn" type="submit" class="btn btn-amber">
              <span class="save-text">Save Changes</span>
              <span class="spinner-border spinner-border-sm ms-2 visually-hidden" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- /EDIT MODAL -->

  <!-- Toast -->
  <div class="toast-fixed">
    <div id="actionToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body fw-semibold">Done.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        });
    });
  </script>

  <!-- Page logic -->
  <script>
    const API = "http://localhost:5000";

    // Auth
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    if (!userData || !userData.userId || !userData.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
    }
    document.getElementById("Username").textContent = userData.username || "";

    // DOM
    const elCourse = document.getElementById('courseSelect');
    const elGrid = document.getElementById('assignmentGrid');
    const elSort = document.getElementById('sortBy');
    const elSearch = document.getElementById('searchBox');
    const btnActive = document.getElementById('btnActive');
    const btnArchived = document.getElementById('btnArchived');
    const btnAll = document.getElementById('btnAll');

    // Edit modal DOM
    let editModal; // bootstrap modal instance
    const elEditId = document.getElementById('editAssignmentId');
    const elEditTitle = document.getElementById('editTitle');
    const elEditPoints = document.getElementById('editPoints');
    const elEditContent = document.getElementById('editContent');
    const elEditPublish = document.getElementById('editPublishAt');
    const elEditDue = document.getElementById('editDueAt');
    const elEditModule = document.getElementById('editModuleId');
    const elEditForm = document.getElementById('editForm');
    const elEditError = document.getElementById('editError');
    const elSaveBtn = document.getElementById('saveEditBtn');
    const elSaveSpinner = elSaveBtn.querySelector('.spinner-border');
    const elSaveText = elSaveBtn.querySelector('.save-text');

    // State
    let coursesList = [];                // [{id,title,courseNumber}, ...]
    let courseMap = new Map();           // id -> {title, courseNumber, label}
    let masterAssignments = [];          // ALL assignments across courses (preloaded)
    let filtered = [];
    let currentCourseId = '';            // '' means "All courses"
    let statusFilter = 'active';         // 'active' | 'archived' | 'all'

    // Cache for module lookups (moduleId -> { title, moduleNumber })
    const moduleCache = new Map();

    // Utils
    function logoutUser() { localStorage.clear(); sessionStorage.clear(); window.location.href = "/TEACHER/login/login.html"; }
    function escapeHTML(str = '') { return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", "&#039;"); }
    function goUpload() { window.location.href = "/TEACHER/assignment/assignment_upload.html"; }
    function goToGraded(courseId, assignmentId) {
      const params = new URLSearchParams({ courseId, assignmentId });
      window.location.href = `/TEACHER/assignment/grade_submission.html?${params.toString()}`;
    }
    function tsToMs(ts) {
      if (!ts) return null;
      const s = ts._seconds ?? ts.seconds;
      const ns = ts._nanoseconds ?? ts.nanoseconds ?? 0;
      if (typeof s === 'number') return (s * 1000) + Math.floor(ns / 1e6);
      if (typeof ts === 'number') return ts;
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d.getTime();
    }
    function preview(text, n = 120) { const t = (text || '').trim(); return t.length > n ? `${t.slice(0, n)}…` : t; }
    function msToLocalInput(ms) {
      if (!ms) return '';
      const d = new Date(ms);
      const pad = n => String(n).padStart(2, '0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }
    function showToast(msg, variant = 'success') {
      const el = document.getElementById('actionToast');
      el.className = `toast align-items-center text-bg-${variant} border-0`;
      el.querySelector('.toast-body').textContent = msg;
      const t = bootstrap.Toast.getOrCreateInstance(el, { delay: 1600 });
      t.show();
    }

    // Load courses (build map and labels)
    async function loadCourses() {
      const res = await fetch(`${API}/courses?uploadedBy=${encodeURIComponent(userData.userId)}`);
      const courses = await res.json(); // plain array
      courses.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      coursesList = courses.map((c, idx) => {
        const n = Number.isFinite(c?.courseNumber) ? c.courseNumber : (idx + 1);
        const title = c.title || c.name || 'Untitled';
        const label = `#${n} — ${title}`;
        courseMap.set(c.id, { title, courseNumber: n, label });
        return { id: c.id, title, courseNumber: n, label };
      });

      // Build selector (All courses first)
      const opts = ['<option value="">All courses</option>'];
      coursesList.forEach(c => opts.push(`<option value="${c.id}">${escapeHTML(c.label)}</option>`));
      elCourse.innerHTML = opts.join('');
    }

    // Fetch course modules for modal select
    async function loadModulesForCourse(courseId, selectedModuleId) {
      elEditModule.innerHTML = `<option value="">— Keep current —</option>`;
      if (!courseId) return;
      try {
        const res = await fetch(`${API}/api/courses/${encodeURIComponent(courseId)}/modules`);
        const js = await res.json();
        const mods = Array.isArray(js) ? js : (js.modules || []);
        mods.sort((a, b) => (a.moduleNumber || 0) - (b.moduleNumber || 0));
        mods.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = `Module ${m.moduleNumber ?? ''}: ${m.title || 'Untitled'}`;
          if (selectedModuleId && String(selectedModuleId) === String(m.id)) opt.selected = true;
          elEditModule.appendChild(opt);
        });
      } catch (e) {
        console.warn('Failed loading modules for course', e);
      }
    }

    // Fetch a module doc and cache it
    async function fetchModuleMeta(moduleId) {
      if (!moduleId) return null;
      if (moduleCache.has(moduleId)) return moduleCache.get(moduleId);
      try {
        const res = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}`);
        const js = await res.json(); // { id, title, moduleNumber, ... }
        const meta = js && js.id ? { title: js.title || '', moduleNumber: js.moduleNumber ?? null } : null;
        moduleCache.set(moduleId, meta);
        return meta;
      } catch (e) {
        console.warn('Module fetch failed for', moduleId, e);
        moduleCache.set(moduleId, null);
        return null;
      }
    }

    // Enrich assignments list with moduleTitle/moduleNumber
    async function hydrateModulesForAssignments(list) {
      const ids = [...new Set(list.map(a => a.moduleId).filter(Boolean))];
      await Promise.all(ids.map(id => fetchModuleMeta(id)));
      list.forEach(a => {
        const meta = a.moduleId ? moduleCache.get(a.moduleId) : null;
        if (meta) {
          if (!a.moduleTitle) a.moduleTitle = meta.title || '';
          if (a.moduleNumber == null) a.moduleNumber = meta.moduleNumber ?? null;
        }
      });
    }

    // PRELOAD: load assignments across ALL courses (includes archived for teacher control)
    async function preloadAllAssignments() {
      if (!coursesList.length) return;
      elGrid.innerHTML = `<div class="col-12"><div class="empty text-center">Loading assignments…</div></div>`;

      const promises = coursesList.map(c =>
        fetch(`${API}/api/courses/${encodeURIComponent(c.id)}/assignments?includeArchived=true`)
          .then(r => r.json().catch(() => ({ success: false })))
          .then(js => ({ course: c, payload: js }))
          .catch(() => ({ course: c, payload: { success: false, assignments: [] } }))
      );

      const results = await Promise.all(promises);
      const combined = [];
      results.forEach(({ course, payload }) => {
        const items = (payload && payload.success && Array.isArray(payload.assignments))
          ? payload.assignments : [];
        items.forEach(a => {
          combined.push({
            ...a,
            courseId: course.id,
            courseTitle: course.title,
            courseLabel: course.label,
            _dueMs: tsToMs(a.dueAt),
            _pubMs: tsToMs(a.publishAt),
            _createdMs: tsToMs(a.createdAt),
          });
        });
      });

      masterAssignments = combined;
      await hydrateModulesForAssignments(masterAssignments);

      // Reset filters
      currentCourseId = '';
      elCourse.value = '';
      elSort.value = 'due';
      elSearch.value = '';
      statusFilter = 'active';
      setSegmentedActive('active');
      applyFilters();
    }

    // Apply search/sort/filter
    function applyFilters() {
      const q = (elSearch.value || '').toLowerCase().trim();

      const base = currentCourseId
        ? masterAssignments.filter(a => a.courseId === currentCourseId)
        : masterAssignments.slice();

      let list = base.filter(a => {
        const hay = `${a.title || ''} ${a.content || ''} ${a.moduleTitle || ''} ${a.moduleNumber != null ? ('module ' + a.moduleNumber) : ''} ${a.courseTitle || ''}`.toLowerCase();
        return hay.includes(q);
      });

      // Status filter
      if (statusFilter === 'active') list = list.filter(a => a.archived !== true);
      if (statusFilter === 'archived') list = list.filter(a => a.archived === true);

      const sort = elSort.value;
      if (sort === 'az') list.sort((a, b) => (a.title || '').localeCompare(b.title || ''));           // A→Z
      else if (sort === 'due') list.sort((a, b) => (a._dueMs ?? Infinity) - (b._dueMs ?? Infinity)); // nearest due first
      else list.sort((a, b) => (b._createdMs ?? b._pubMs ?? 0) - (a._createdMs ?? a._pubMs ?? 0));   // newest

      filtered = list;
      renderGrid();
    }

    // ---- Archive / Unarchive ----
    async function setArchiveState(id, archived) {
      try {
        const res = await fetch(`${API}/api/assignments/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ archived: !!archived })
        });
        const js = await res.json();
        if (!res.ok || js.success === false) {
          throw new Error(js.message || 'Failed to update archive state.');
        }
        await preloadAllAssignments();
        showToast(archived ? 'Archived. Students can no longer see this.' : 'Unarchived. Students can see this again.', archived ? 'warning' : 'success');
      } catch (e) {
        console.error(e);
        showToast(e.message || 'Server error while updating.', 'danger');
      }
    }
    function archiveAssignment(id) {
      if (!confirm('Archive this assignment? Students will no longer see it.')) return;
      setArchiveState(id, true);
    }
    function unarchiveAssignment(id) {
      setArchiveState(id, false);
    }

    // Edit modal open
    async function openEditModal(assignmentId) {
      elEditError.textContent = '';
      elSaveBtn.disabled = false;
      elSaveSpinner.classList.add('visually-hidden');
      elSaveText.textContent = 'Save Changes';

      try {
        const res = await fetch(`${API}/api/assignments/${assignmentId}`);
        const js = await res.json();
        if (!res.ok || !js.success) throw new Error(js.message || 'Failed to fetch assignment');

        const a = js.assignment || js.data || {};
        elEditId.value = assignmentId;
        elEditTitle.value = a.title || '';
        elEditContent.value = a.content || '';
        elEditPoints.value = (typeof a.points === 'number') ? a.points : '';
        elEditPublish.value = msToLocalInput(tsToMs(a.publishAt));
        elEditDue.value = msToLocalInput(tsToMs(a.dueAt));

        // Load modules list for this course & preselect current
        await loadModulesForCourse(a.courseId, a.moduleId);

        if (!editModal) editModal = new bootstrap.Modal(document.getElementById('editAssignmentModal'));
        editModal.show();
      } catch (e) {
        console.error(e);
        alert('Failed to open editor: ' + e.message);
      }
    }

    // Save edit (PATCH)
    elEditForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      elEditError.textContent = '';

      const id = elEditId.value;
      const title = elEditTitle.value.trim();
      const content = elEditContent.value.trim();
      const pointsStr = elEditPoints.value;
      const publishVal = elEditPublish.value;
      const dueVal = elEditDue.value;
      const moduleId = elEditModule.value;

      if (!title || !content) {
        elEditError.textContent = 'Title and Content are required.';
        return;
      }

      const payload = { title, content };
      if (pointsStr !== '') payload.points = Number(pointsStr);
      if (publishVal) payload.publishAt = String(new Date(publishVal).getTime());
      if (dueVal) payload.dueAt = String(new Date(dueVal).getTime());
      if (moduleId) payload.moduleId = moduleId;

      elSaveBtn.disabled = true;
      elSaveSpinner.classList.remove('visually-hidden');
      elSaveText.textContent = 'Saving…';

      try {
        const res = await fetch(`${API}/api/assignments/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const js = await res.json();
        if (!res.ok || js.success === false) {
          throw new Error(js.message || js.error || 'Failed to save changes.');
        }

        await preloadAllAssignments();   // refresh full list for consistency
        editModal.hide();
      } catch (err) {
        console.error(err);
        elEditError.textContent = err.message || 'Server error while saving.';
      } finally {
        elSaveBtn.disabled = false;
        elSaveSpinner.classList.add('visually-hidden');
        elSaveText.textContent = 'Save Changes';
      }
    });

    // Delete assignment
    async function deleteAssignment(id) {
      if (!confirm("Are you sure you want to delete this assignment? This cannot be undone.")) return;
      try {
        const res = await fetch(`${API}/api/assignments/${id}`, { method: 'DELETE' });
        const js = await res.json();
        if (!res.ok || !js.success) {
          alert(js.message || "Failed to delete assignment.");
          return;
        }
        showToast('Assignment deleted.', 'warning');
        await preloadAllAssignments(); // refresh full list
      } catch (e) {
        console.error(e);
        showToast('Server error while deleting.', 'danger');
      }
    }

    // Render cards with Course + Module pills
    function renderGrid() {
      if (!filtered.length) {
        elGrid.innerHTML = `<div class="col-12"><div class="empty text-center">No assignments found.</div></div>`;
        return;
      }
      elGrid.innerHTML = filtered.map(a => {
        const dueStr = a._dueMs ? new Date(a._dueMs).toLocaleString() : 'N/A';
        const pts = (typeof a.points === 'number') ? `${a.points} pts` : '';

        const coursePill = a.courseLabel
          ? `<span class="pill pill-course"><i class="bi bi-collection"></i>${escapeHTML(a.courseLabel)}</span>`
          : '';

        // Module pill label: "#N — Title" if both exist; otherwise whichever is present
        let moduleLabel = '';
        if (a.moduleNumber != null && (a.moduleTitle || '').trim()) moduleLabel = `#${a.moduleNumber} — ${escapeHTML(a.moduleTitle)}`;
        else if (a.moduleNumber != null) moduleLabel = `#${a.moduleNumber}`;
        else if ((a.moduleTitle || '').trim()) moduleLabel = escapeHTML(a.moduleTitle);

        const modulePill = moduleLabel
          ? `<span class="pill pill-module"><i class="bi bi-box"></i>${moduleLabel}</span>`
          : '';

        return `
          <div class="col-12 col-md-6 col-xl-4 col-xxl-3">
            <div class="assignment-card ${a.archived === true ? 'archived' : ''}">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="m-0">${escapeHTML(a.title || 'Untitled')}</h5>
                <div class="d-flex align-items-center gap-2">
                  ${a.archived === true ? `<span class="pill pill-archived"><i class="bi bi-archive"></i>Archived</span>` : ''}
                  ${pts ? `<span class="badge-soft"><i class="bi bi-award"></i>${pts}</span>` : ``}
                </div>
              </div>

              <div class="mb-2 d-flex flex-wrap gap-1">${coursePill}${modulePill}</div>

              <div class="text-muted small mb-2">${escapeHTML(preview(a.content, 140))}</div>

              <div class="d-flex align-items-center justify-content-between small mb-3">
                <span class="text-muted"><i class="bi bi-calendar2-week me-1"></i><strong>Due:</strong> ${dueStr}</span>
                <span class="text-muted">${a.submissionCount ?? '—'} submissions</span>
              </div>

              <div class="d-flex justify-content-end gap-2">
                ${
                  a.archived === true
                    ? `<button class="btn btn-sm btn-outline-success" onclick="unarchiveAssignment('${a.id}')">
                         <i class="bi bi-arrow-counterclockwise"></i> Unarchive
                       </button>`
                    : `<button class="btn btn-sm btn-outline-secondary" onclick="archiveAssignment('${a.id}')">
                         <i class="bi bi-archive"></i> Archive
                       </button>`
                }
                <button class="btn btn-sm btn-outline-secondary" onclick="openEditModal('${a.id}')">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAssignment('${a.id}')">
                  <i class="bi bi-trash"></i> Delete
                </button>
                <button class="btn btn-sm btn-amber" onclick="goToGraded('${a.courseId}','${a.id}')">
                  <i class="bi bi-list-check"></i> Grade
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Segmented controls
    function setSegmentedActive(which) {
      statusFilter = which;
      const all = [btnActive, btnArchived, btnAll];
      all.forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected', 'false'); });
      if (which === 'active') { btnActive.classList.add('is-active'); btnActive.setAttribute('aria-selected', 'true'); }
      if (which === 'archived') { btnArchived.classList.add('is-active'); btnArchived.setAttribute('aria-selected', 'true'); }
      if (which === 'all') { btnAll.classList.add('is-active'); btnAll.setAttribute('aria-selected', 'true'); }
      applyFilters();
    }
    btnActive.addEventListener('click', () => setSegmentedActive('active'));
    btnArchived.addEventListener('click', () => setSegmentedActive('archived'));
    btnAll.addEventListener('click', () => setSegmentedActive('all'));

    // Other events
    elCourse.addEventListener('change', () => {
      currentCourseId = elCourse.value || '';
      applyFilters();
    });
    elSort.addEventListener('change', applyFilters);
    elSearch.addEventListener('input', applyFilters);

    // Boot
    (async function init() {
      try {
        await loadCourses();
        const params = new URLSearchParams(location.search);
        const preCourse = params.get('courseId');
        await preloadAllAssignments(); // load all (includes archived)
        if (preCourse && courseMap.has(preCourse)) {
          currentCourseId = preCourse;
          elCourse.value = preCourse;
          applyFilters();
        }
      } catch (e) {
        console.error(e);
        elGrid.innerHTML = `<div class="col-12"><div class="empty text-center text-danger">Failed to load assignments.</div></div>`;
      }
    })();

    // Expose for inline buttons
    window.openEditModal = openEditModal;
    window.deleteAssignment = deleteAssignment;
    window.goToGraded = goToGraded;
    window.archiveAssignment = archiveAssignment;
    window.unarchiveAssignment = unarchiveAssignment;
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
