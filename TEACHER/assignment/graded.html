<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Teacher - Graded Submissions</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Global teacher styles -->
  <link rel="stylesheet" href="grade.css"/>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="searchInput" type="text" class="form-control" placeholder="Search graded (student, title, module, class)…"/>
          <i class="fas fa-search position-absolute" style="top:50%; right:15px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold">Teacher Name</span>
        </button>
      </header>

      <section class="content container-fluid p-4 mt-4">
        <h1 class="page-title">Assignment Graded Submissions</h1>

        <!-- THEMED TOOLBAR (UI-CARD) -->
        <div class="ui-card mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-journal-check"></i> Your Graded Queue</h2>
            <div class="ui-actions">
              <button class="btn btn-outline-light" id="viewUngradedBtn">
                <i class="bi bi-inbox-fill"></i> View Ungraded
              </button>
            </div>
          </div>

          <div class="ui-card-body">
            <!-- Sort -->
            <div class="row g-2 ui-controls align-items-end mb-2">
              <div class="col-12 col-md-4 col-lg-3">
                <label for="sortBy" class="form-label">Sort</label>
                <select id="sortBy" class="form-select" aria-label="Sort graded">
                  <option value="graded_desc" selected>Newest graded</option>
                  <option value="graded_asc">Oldest graded</option>
                  <option value="submitted_desc">Newest submitted</option>
                  <option value="submitted_asc">Oldest submitted</option>
                  <option value="student_az">Student A → Z</option>
                  <option value="class_az">Class A → Z</option>
                  <option value="module_az">Module A → Z</option>
                  <option value="title_az">Title A → Z</option>
                  <option value="score_desc">Score high → low</option>
                  <option value="score_asc">Score low → high</option>
                </select>
              </div>
            </div>

            <!-- Filters (instant) -->
            <div class="row g-3 ui-controls align-items-end">
              <div class="col-12 col-lg-3">
                <label for="filterClass" class="form-label">Class</label>
                <select id="filterClass" class="form-select">
                  <option value="">All Classes</option>
                </select>
              </div>
              <div class="col-12 col-lg-3">
                <label for="filterModule" class="form-label">Module</label>
                <select id="filterModule" class="form-select">
                  <option value="">All Modules</option>
                </select>
              </div>
              <div class="col-6 col-lg-3">
                <label for="filterGradedDate" class="form-label">Graded Date</label>
                <input type="date" id="filterGradedDate" class="form-control"/>
              </div>
              <div class="col-6 col-lg-3">
                <label for="filterScore" class="form-label">Min Score</label>
                <input type="number" id="filterScore" class="form-control" placeholder="e.g. 75"/>
              </div>
            </div>

            <!-- Meta line -->
            <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
              <div class="brand-grad fw-semibold" id="assignmentMetaText">—</div>
              <span class="meta-pill" id="summaryText">—</span>
            </div>
          </div>
        </div>
        <!-- /THEMED TOOLBAR -->

        <!-- Graded Table -->
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="gradedTable">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>Class</th>
                <th>Module</th>
                <th>Title</th>
                <th>Submitted At</th>
                <th>Graded At</th>
                <th>Score</th>
                <th>Feedback</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="9" class="text-center text-muted py-4">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="feedbackTitle">Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="feedbackBody" class="whitespace-prewrap"></div>
        </div>
        <div class="modal-footer">
          <button class="btn-close-footer" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Submission Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header brand">
          <h5 class="modal-title">
            <i class="bi bi-file-earmark-text me-1"></i>
            <span id="vmTitle">Submission</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
            <div>
              <div class="small text-uppercase muted">Student</div>
              <div class="fw-semibold" id="vmStudent">—</div>
            </div>
            <div>
              <div class="small text-uppercase muted">Class</div>
              <div id="vmClass">—</div>
            </div>
            <div>
              <div class="small text-uppercase muted">Module</div>
              <div id="vmModule">—</div>
            </div>
          </div>

          <hr/>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-uppercase muted">Submitted</div>
              <div id="vmSubmitted">—</div>
            </div>
            <div class="col-md-6">
              <div class="small text-uppercase muted">Graded</div>
              <div id="vmGraded">—</div>
            </div>
            <div class="col-md-6">
              <div class="small text-uppercase muted">Score</div>
              <div id="vmScore">—</div>
            </div>
            <div class="col-md-6">
              <div class="small text-uppercase muted">Feedback</div>
              <div id="vmFeedback">—</div>
            </div>
          </div>

          <hr/>

          <div class="mb-2">
            <div class="fw-semibold mb-1"><i class="bi bi-paperclip"></i> Files</div>
            <ul id="vmFiles" class="file-list ps-3 mb-0"></ul>
          </div>

          <div class="mt-3">
            <div class="fw-semibold mb-1"><i class="bi bi-chat-left-text"></i> Student Note</div>
            <div id="vmNote" class="whitespace-prewrap">—</div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-delete" id="vmDeleteBtn">
            <i class="bi bi-trash me-1"></i> Delete Submission
          </button>
          <div>
            <button class="btn-close-footer" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal (reused for type-to-confirm) -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-1"></i> Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmDeleteBody">Are you sure you want to delete this submission?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-delete" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Modal -->
  <div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="statusTitle">Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="statusBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>
        <div class="modal-footer" id="filePreviewFooter">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto">
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-close-footer">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"),
                db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        });
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ---- Auth guard + header initials (robust) ----
(function initHeaderInitials(){
  try{
    const raw = localStorage.getItem("user");
    const stored = raw ? JSON.parse(raw) : {};
    const u = stored.user || stored;

    if (!u?.userId || !u?.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
      return;
    }
    window.currentUser = u;

    const initials = getInitials(u);

    window.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("Username");
      if (!el) return;
      el.textContent = initials;
      const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
                      || u.username
                      || u.email
                      || 'Profile';
      el.setAttribute('title', fullLabel);
      el.setAttribute('aria-label', fullLabel);
    });
  }catch(e){
    console.error('initHeaderInitials failed:', e);
    window.location.href = "/TEACHER/login/login.html";
  }

  function getInitials(u){
    const fn = (u.firstName || '').trim();
    const ln = (u.lastName  || '').trim();
    if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

    const nameish = (u.username || u.displayName || u.name || '').trim();
    if (nameish){
      const parts = nameish
        .replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
        .split(/[\s._-]+/)
        .filter(Boolean);

      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return parts[0][0].toUpperCase();
    }

    const em = (u.email || '').trim();
    return em ? em[0].toUpperCase() : 'U';
  }
})();
</script>

  <!-- Page Logic -->
  <script>
    const API = "http://localhost:5000";

    /* -------- Auth -------- */
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user || !user.userId || !user.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
    } else {
      document.getElementById("Username").textContent = user.username || "Teacher";
    }
    function logoutUser(){ localStorage.clear(); sessionStorage.clear(); window.location.href="/TEACHER/login/login.html"; }
    window.logoutUser = logoutUser;

    /* -------- URL params -------- */
    const url = new URL(location.href);
    const paramCourseId = url.searchParams.get('courseId') || '';
    const paramAssignmentId = url.searchParams.get('assignmentId') || '';

    /* -------- Close-any-open-modals helper -------- */
    function closeAllModals(){
      document.querySelectorAll('.modal.show').forEach(m=>{
        try{ bootstrap.Modal.getInstance(m)?.hide(); }catch{}
      });
    }

    /* -------- DOM refs -------- */
    const elSearch  = document.getElementById('searchInput');
    const elClass   = document.getElementById('filterClass');
    const elModule  = document.getElementById('filterModule');
    const elDate    = document.getElementById('filterGradedDate');
    const elScore   = document.getElementById('filterScore');
    const elBody    = document.getElementById('tableBody');
    const elSummary = document.getElementById('summaryText');
    const btnUngraded = document.getElementById('viewUngradedBtn');
    const elSortBy  = document.getElementById('sortBy');
    const elAssignmentMeta = document.getElementById('assignmentMetaText');

    /* -------- View modal refs -------- */
    const vm = {
      modal: new bootstrap.Modal(document.getElementById('viewModal')),
      title: document.getElementById('vmTitle'),
      student: document.getElementById('vmStudent'),
      class: document.getElementById('vmClass'),
      module: document.getElementById('vmModule'),
      submitted: document.getElementById('vmSubmitted'),
      graded: document.getElementById('vmGraded'),
      score: document.getElementById('vmScore'),
      feedback: document.getElementById('vmFeedback'),
      files: document.getElementById('vmFiles'),
      note: document.getElementById('vmNote'),
      deleteBtn: document.getElementById('vmDeleteBtn'),
    };
    let vmCurrent = null;

    /* -------- Confirm & Status (reused with type-to-confirm) -------- */
    const confirmModalEl = document.getElementById('confirmDeleteModal');
    const confirmDeleteModal = new bootstrap.Modal(confirmModalEl);
    const confirmDeleteBody = document.getElementById('confirmDeleteBody');
    const confirmDeleteBtn  = document.getElementById('confirmDeleteBtn');

    const statusModalEl = document.getElementById('statusModal');
    const statusModal = new bootstrap.Modal(statusModalEl);
    const statusTitle = document.getElementById('statusTitle');
    const statusBody  = document.getElementById('statusBody');

    function showStatus(message, {success=true, title} = {}){
      statusTitle.textContent = title || (success ? 'Success' : 'Error');
      statusBody.textContent = message;
      const header = statusModalEl.querySelector('.modal-header');
      header.classList.remove('bg-danger','bg-success','text-white');
      if (success) header.classList.add('bg-success','text-white');
      else header.classList.add('bg-danger','text-white');
      closeAllModals();
      statusModal.show();
    }

    /* ----- Type-to-confirm delete (Student Name, case-sensitive) ----- */
    let pendingDelete = null;
    function openConfirmDelete(item){
      if (!item) return;
      closeAllModals();

      pendingDelete = {
        assignmentId: item.assignmentId,
        studentId: item.studentId,
        studentName: (item.studentName || item.studentId || '').trim()
      };

      const expected = pendingDelete.studentName;
      const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;');

      // Theme modal for TTC
      confirmModalEl.querySelector('.modal-content').classList.add('confirm-themed');

      confirmDeleteBody.innerHTML = `
        <p class="mb-2">Confirm deletion by typing the exact Student Name (case-sensitive). This will let the student resubmit.</p>
        <div class="no-copy pill-danger mb-2">
          Type exactly: <strong id="ttcExpected">${esc(expected)}</strong>
        </div>
        <div class="mb-1">
          <input id="ttcInput" type="text" class="form-control is-invalid" placeholder="Type here…" autocomplete="off" autocapitalize="off" spellcheck="false">
        </div>
        <div id="ttcBad" class="invalid-msg">Input does not match. Please type <strong>${esc(expected)}</strong>.</div>
        <div id="ttcGood" class="valid-msg d-none">✓ Input matches</div>
      `;

      // --- HARDEN: make the hint and expected text impossible to copy/select ---
      const pill = confirmDeleteBody.querySelector('.no-copy');
      const expectedEl = confirmDeleteBody.querySelector('#ttcExpected');
      const kill = e => e.preventDefault();

      // block user actions that could copy/select
      ['copy','cut','contextmenu','dragstart','selectstart','mousedown','pointerdown']
        .forEach(evt => {
          pill.addEventListener(evt, kill);
          expectedEl.addEventListener(evt, kill);
        });

      // if selection lands on the expected text, clear it
      const selClear = () => {
        const sel = window.getSelection?.();
        if (!sel || !sel.rangeCount) return;
        const node = sel.anchorNode;
        if (node && (expectedEl.contains(node) || pill.contains(node))) sel.removeAllRanges();
      };
      document.addEventListener('selectionchange', selClear);

      // Input validation wiring
      const input = confirmDeleteBody.querySelector('#ttcInput');
      const bad = confirmDeleteBody.querySelector('#ttcBad');
      const good = confirmDeleteBody.querySelector('#ttcGood');

      confirmDeleteBtn.textContent = 'Delete';
      confirmDeleteBtn.disabled = true;

      function refresh(){
        const ok = (input.value === expected);
        confirmDeleteBtn.disabled = !ok;
        input.classList.toggle('is-valid', ok);
        input.classList.toggle('is-invalid', !ok);
        bad.classList.toggle('d-none', ok);
        good.classList.toggle('d-none', !ok);
      }
      input.addEventListener('input', refresh);
      setTimeout(()=>input.focus(), 60);

      // cleanup on close
      const onHidden = () => {
        confirmModalEl.querySelector('.modal-content').classList.remove('confirm-themed');
        ['copy','cut','contextmenu','dragstart','selectstart','mousedown','pointerdown']
          .forEach(evt => {
            pill.removeEventListener(evt, kill);
            expectedEl.removeEventListener(evt, kill);
          });
        document.removeEventListener('selectionchange', selClear);
        confirmModalEl.removeEventListener('hidden.bs.modal', onHidden);
      };
      confirmModalEl.addEventListener('hidden.bs.modal', onHidden, { once:true });

      confirmDeleteModal.show();
    }

    /* -------- File preview utils (with signing) -------- */
    function toApiUrl(pathOrUrl){ return /^https?:\/\//i.test(String(pathOrUrl)) ? String(pathOrUrl) : API + String(pathOrUrl || ""); }
    function pickHref(obj = {}) {
      return obj.downloadUrl || obj.publicUrl || obj.previewUrl ||
             (obj.url && /^https?:\/\//i.test(obj.url) ? obj.url : '') ||
             (obj.filePath ? toApiUrl(obj.filePath) : '');
    }
    function pickName(obj = {}) {
      const fromPath = (obj.storagePath || obj.filePath || '').split('/').pop();
      const fromUrl  = (obj.url || '').split('/').pop();
      return obj.originalName || fromPath || fromUrl || 'file';
    }
    function extractStoragePath(obj = {}) {
      if (obj.storagePath) return String(obj.storagePath);
      if (obj.gsUri && obj.gsUri.startsWith('gs://')) {
        const parts = obj.gsUri.replace('gs://','').split('/'); parts.shift(); return parts.join('/');
      }
      if (obj.publicUrl && /storage\.googleapis\.com/i.test(obj.publicUrl)) {
        try { const u = new URL(obj.publicUrl); const parts = u.pathname.replace(/^\/+/, '').split('/'); parts.shift(); return parts.join('/'); } catch {}
      }
      if (obj.downloadUrl && /firebasestorage\.googleapis\.com/i.test(obj.downloadUrl)) {
        try { const u = new URL(obj.downloadUrl); if (u.pathname.includes('/o/')) { const enc = u.pathname.split('/o/')[1]; return decodeURIComponent(enc); } } catch {}
      }
      return '';
    }

    function getExtFromUrl(url=''){ const clean=String(url).split('?')[0].split('#')[0]; const parts=clean.split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function isYouTubeUrl(url=''){ try{const u=new URL(url);const h=u.hostname.replace(/^www\./,'').toLowerCase();return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);}catch{return false;} }
    function toYouTubeEmbed(url=''){ try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();let id='';let start=u.searchParams.get('start')||u.searchParams.get('t')||'';if(start&&/^\d+s$/.test(start))start=parseInt(start,10);if(start&&/^\d+$/.test(start))start=parseInt(start,10);if(!Number.isFinite(start))start='';if(host==='youtu.be'){id=(u.pathname||'').replace(/^\//,'').split('/')[0];}else{if(u.pathname.startsWith('/embed/'))id=u.pathname.split('/')[2]||'';if(!id)id=u.searchParams.get('v')||'';}if(!id)return null;const base=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;const qs=new URLSearchParams();qs.set('rel','0');if(start)qs.set('start',String(start));return `${base}?${qs.toString()}`;}catch{return null;} }
    function kindFromUrl(url){
      if(isYouTubeUrl(url))return'youtube';
      const ext=getExtFromUrl(url);
      if(['mp4','webm','ogg','ogv','mov'].includes(ext))return'video';
      if(['mp3','wav','m4a','ogg','aac','flac'].includes(ext))return'audio';
      if(['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext))return'image';
      if(ext==='pdf')return'pdf';
      if(['txt','csv','log'].includes(ext))return'text';
      if(['doc','docx','ppt','pptx','xls','xlsx'].includes(ext))return'office';
      return'other';
    }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function setFileInfoUI(kind,url){
      const info=document.getElementById('fileInfoText');
      const hdr=document.getElementById('filePreviewModalLabel');
      const labelMap={youtube:'YouTube',video:'Video',audio:'Audio',image:'Image',pdf:'PDF',text:'Text/CSV',office:'Office Doc',other:'File'};
      const colorMap={youtube:'bg-danger-subtle text-danger',video:'bg-danger-subtle text-danger',audio:'bg-secondary-subtle text-secondary',image:'bg-success-subtle text-success',pdf:'bg-primary-subtle text-primary',text:'bg-info-subtle text-info',office:'bg-warning-subtle text-warning',other:'bg-dark-subtle text-dark'};
      let badge=document.getElementById('fileKindBadge'); if(!badge){badge=document.createElement('span');badge.id='fileKindBadge';badge.className='ms-2 badge rounded-pill';hdr.appendChild(badge);}
      badge.className='ms-2 badge rounded-pill '+(colorMap[kind]||colorMap.other); badge.textContent=labelMap[kind]||'File';
      info.innerHTML=`<span class="text-muted">Type:</span> <strong>${labelMap[kind]||'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href=url||'#';
    }
    function renderFilePreviewInto(container,url){
      container.innerHTML=''; showSpinner(true); const done=()=>showSpinner(false); const kind=kindFromUrl(url);
      const fallback=(msg)=>{ container.innerHTML=`<div class="preview-fallback"><div class="text-muted mb-2">${msg||'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; done(); };

      if(kind==='youtube'){ const embed=toYouTubeEmbed(url); if(embed){container.innerHTML=`<div class="ratio ratio-16x9"><iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin" style="border:0"></iframe></div>`; done(); return;} fallback('Couldn’t embed this YouTube link.'); return; }

      const ext=getExtFromUrl(url);
      if(['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)){ const img=new Image(); img.onload=done; img.onerror=()=>fallback('Image preview failed.'); img.src=url; container.appendChild(img); return; }
      if(ext==='pdf'){ const iframe=document.createElement('iframe'); iframe.title='PDF preview'; iframe.onload=done; iframe.onerror=()=>fallback('PDF preview failed (viewer blocked or CORS).'); iframe.src=url; container.appendChild(iframe); return; }
      if(['mp4','webm','ogg','ogv','mov'].includes(ext)){ const video=document.createElement('video'); video.controls=true; video.onloadeddata=done; video.onerror=()=>fallback('Video preview failed.'); video.src=url; container.appendChild(video); return; }
      if(['mp3','wav','m4a','ogg','aac','flac'].includes(ext)){ const audio=document.createElement('audio'); audio.controls=true; audio.onloadeddata=done; audio.onerror=()=>fallback('Audio preview failed.'); audio.src=url; container.appendChild(audio); return; }
      if(['txt','csv','log'].includes(ext)){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Text preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)){ const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe=document.createElement('iframe'); iframe.title='Document preview'; iframe.onload=done; iframe.onerror=()=>fallback('Office preview failed (Google Viewer blocked or CORS).'); iframe.src=gview; container.appendChild(iframe); return; }

      const obj=document.createElement('object'); obj.data=url; obj.type='application/octet-stream'; obj.onload=done; obj.onerror=()=>fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(done,1200);
    }
    function openPreviewModal(viewUrl, title='File'){
      closeAllModals();
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      setFileInfoUI(kindFromUrl(viewUrl), viewUrl);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), viewUrl);
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }
    async function openPreviewFromObj(obj = {}) {
      const direct = pickHref(obj);
      if (direct && /firebasestorage\.googleapis\.com\/v0\/b\//i.test(direct)) { openPreviewModal(direct, pickName(obj)); return; }
      const storagePath = extractStoragePath(obj);
      if (!storagePath) { if (direct) openPreviewModal(direct, pickName(obj)); return; }
      try {
        const r = await fetch(`${API}/api/attachments/signed?path=${encodeURIComponent(storagePath)}`);
        const js = await r.json().catch(()=>null);
        if (r.ok && js?.success && js?.url) { openPreviewModal(js.url, pickName(obj)); return; }
      } catch {}
      if (direct) openPreviewModal(direct, pickName(obj));
    }

    // Legacy open-in-new-tab fallback
    async function openAttachmentWithFallback(obj) {
      const direct = pickHref(obj);
      if (direct && /firebasestorage\.googleapis\.com\/v0\/b\//i.test(direct)) { window.open(direct, '_blank', 'noopener'); return; }
      const storagePath = extractStoragePath(obj);
      if (!storagePath) { if (direct) window.open(direct, '_blank', 'noopener'); return; }
      try {
        const r = await fetch(`${API}/api/attachments/signed?path=${encodeURIComponent(storagePath)}`);
        const js = await r.json().catch(()=>null);
        if (r.ok && js?.success && js?.url) { window.open(js.url, '_blank', 'noopener'); return; }
      } catch {}
      if (direct) window.open(direct, '_blank', 'noopener');
    }

    /* -------- Caches -------- */
    const classNameById = new Map();
    const assignmentMetaById = new Map(); // {title, points, moduleTitle, dueAt}

    async function getClassName(classId){
      if (!classId) return '—';
      if (classNameById.has(classId)) return classNameById.get(classId);
      try{
        const resp = await fetch(`${API}/api/classes/${encodeURIComponent(classId)}`);
        const js = await resp.json();
        let label = '—';
        if (resp.ok && js) {
          const cls = js.class || js;
          const parts = [cls.name || cls.title, cls.section].filter(Boolean);
          label = parts.length ? parts.join(' • ') : (cls.name || cls.title || classId);
        }
        classNameById.set(classId, label);
        return label;
      }catch{
        classNameById.set(classId, classId);
        return classId;
      }
    }

    /* -------- State -------- */
    let allGraded = [];
    let shown = [];

    /* -------- Utils -------- */
    function escapeHTML(str=''){
      return String(str)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }
    function tsToMs(ts){
      if (!ts) return null;
      const s = ts?._seconds ?? ts?.seconds;
      const ns = ts?._nanoseconds ?? ts?.nanoseconds ?? 0;
      if (typeof s === 'number') return (s*1000) + Math.floor(ns/1e6);
      if (typeof ts === 'number') return ts;
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d.getTime();
    }
    function toDate(v){
      if (!v) return null;
      if (v instanceof Date) return v;
      const m = tsToMs(v);
      return m ? new Date(m) : (isNaN(new Date(v)) ? null : new Date(v));
    }
    function fmtDate(dt){
      if (!dt) return '—';
      const d = (dt instanceof Date) ? dt : new Date(dt);
      return isNaN(d.getTime()) ? '—' : d.toLocaleString();
    }

    /* -------- Loaders -------- */
    async function loadCoursesForTeacher(teacherId){
      try{
        const js = await fetch(`${API}/api/teacher/dashboard-stats?teacherId=${encodeURIComponent(teacherId)}`).then(r=>r.json());
        if (js && Array.isArray(js.courses)) {
          return js.courses.map(c => ({ id:c.id, title:c.title || c.name || 'Untitled' }));
        }
      }catch{}
      try{
        const all = await fetch(`${API}/courses`).then(r=>r.json());
        const res = [];
        for (const c of (Array.isArray(all) ? all : [])) {
          try {
            const full = await fetch(`${API}/courses/${c.id}`).then(r=>r.json());
            if (full && full.uploadedBy === teacherId) {
              res.push({ id:c.id, title: full.title || 'Untitled' });
            }
          }catch{}
        }
        return res;
      }catch{ return []; }
    }

    async function loadAssignments(courseId){
      try{
        const js = await fetch(`${API}/api/courses/${courseId}/assignments`).then(r=>r.json());
        const list = (js && js.success) ? (js.assignments || []) : [];
        list.forEach(a=>{
          assignmentMetaById.set(a.id, {
            title: a.title || 'Untitled',
            points: (typeof a.points === 'number') ? a.points : null,
            dueAt: a.dueAt || null,
            moduleTitle: (typeof a.moduleNumber === 'number') ? `Module ${a.moduleNumber}` : (a.moduleTitle || '—')
          });
        });
        return list;
      }catch{ return []; }
    }

    async function loadGradedForAssignment(assignmentId){
      try{
        const resp = await fetch(`${API}/api/assignments/${encodeURIComponent(assignmentId)}/submissions`);
        if (resp.ok){
          const js = await resp.json();
          if (js && js.success && Array.isArray(js.submissions)){
            const meta = assignmentMetaById.get(assignmentId) || {};
            return await Promise.all(
              js.submissions
                .filter(s => s && s.grade != null)
                .map(async s => normalizeSubmission(s, assignmentId, meta))
            );
          }
        }
      }catch{}
      return [];
    }

    function normalizeSubmission(s, assignmentId, meta){
      const submittedAt = toDate(s?.submittedAt) || toDate(s?.createdAt) || null;
      const gradedAt = toDate(s?.gradedAt) || toDate(s?.updatedAt) || null;
      const moduleTitle = meta?.moduleTitle || s?.moduleTitle || '—';

      return {
        studentId: s?.studentId || '',
        studentName: s?.studentName || s?.studentId || '',
        className: s?.className || '—',
        moduleTitle,
        assignmentTitle: meta?.title || s?.assignmentTitle || 'Untitled',
        submittedAt,
        gradedAt,
        dueAt: toDate(meta?.dueAt || s?.dueAt),
        grade: (typeof s?.grade === 'number') ? s.grade : null,
        maxPoints: (typeof meta?.points === 'number') ? meta.points : null,
        feedback: s?.feedback || '',
        assignmentId: assignmentId,
        classId: s?.classId || '',
        files: Array.isArray(s?.files) ? s.files : [],
        text: s?.text || ''
      };
    }

    /* -------- Filters & rendering -------- */
    function populateFilters(list){
      const classSet = new Set();
      const moduleSet = new Set();
      list.forEach(x => {
        if (x.className && x.className !== '—') classSet.add(x.className);
        if (x.moduleTitle && x.moduleTitle !== '—') moduleSet.add(x.moduleTitle);
      });
      elClass.innerHTML =
        `<option value="">All Classes</option>` +
        [...classSet].sort().map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join('');
      elModule.innerHTML =
        `<option value="">All Modules</option>` +
        [...moduleSet].sort().map(v => `<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join('');
    }

    function applyFilters(){
      const q = (elSearch.value || '').toLowerCase().trim();
      const fClass = elClass.value;
      const fModule = elModule.value;
      const fDate = elDate.value; // yyyy-mm-dd
      const minScore = Number(elScore.value);
      const hasMin = !Number.isNaN(minScore) && elScore.value !== '';
      const sort = elSortBy.value || 'graded_desc';

      shown = allGraded.filter(s => {
        if (q){
          const hay = `${s.studentName} ${s.assignmentTitle} ${s.moduleTitle} ${s.className}`.toLowerCase();
          if (!hay.includes(q)) return false;
        }
        if (fClass && s.className !== fClass) return false;
        if (fModule && s.moduleTitle !== fModule) return false;
        if (fDate){
          if (!s.gradedAt) return false;
          const yyyy = s.gradedAt.getFullYear();
          const mm = String(s.gradedAt.getMonth()+1).padStart(2,'0');
          const dd = String(s.gradedAt.getDate()).padStart(2,'0');
          if (`${yyyy}-${mm}-${dd}` !== fDate) return false;
        }
        if (hasMin && (s.grade == null || s.grade < minScore)) return false;
        return true;
      });

      // Sorting
      shown.sort((a,b)=>{
        const gA = a.gradedAt?.getTime()||0, gB = b.gradedAt?.getTime()||0;
        const sA = a.submittedAt?.getTime()||0, sB = b.submittedAt?.getTime()||0;
        const scA = (typeof a.grade==='number') ? a.grade : -Infinity;
        const scB = (typeof b.grade==='number') ? b.grade : -Infinity;
        if (sort === 'graded_asc')     return gA - gB;
        if (sort === 'submitted_desc') return sB - sA;
        if (sort === 'submitted_asc')  return sA - sB;
        if (sort === 'student_az')     return (a.studentName||'').localeCompare(b.studentName||'');
        if (sort === 'class_az')       return (a.className||'').localeCompare(b.className||'');
        if (sort === 'module_az')      return (a.moduleTitle||'').localeCompare(b.moduleTitle||'');
        if (sort === 'title_az')       return (a.assignmentTitle||'').localeCompare(b.assignmentTitle||'');
        if (sort === 'score_desc')     return scB - scA;
        if (sort === 'score_asc')      return scA - scB;
        return gB - gA || sB - sA;
      });

      renderTable();
      elSummary.textContent = `${shown.length} shown • ${allGraded.length} total graded`;
    }

    function renderScoreCell(s){
      if (typeof s.grade === 'number'){
        return (typeof s.maxPoints === 'number')
          ? `<span class="badge bg-success score-badge">${s.grade} / ${s.maxPoints}</span>`
          : `<span class="badge bg-success score-badge">${s.grade}</span>`;
      }
      return '<span class="text-muted">—</span>';
    }

    function renderTable(){
      if (!shown.length){
        elBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">No graded submissions found.</td></tr>`;
        return;
      }
      elBody.innerHTML = shown.map(s => `
        <tr data-assignment-id="${escapeHTML(s.assignmentId)}" data-student-id="${escapeHTML(s.studentId)}">
          <td>${escapeHTML(s.studentName || s.studentId)}</td>
          <td>${escapeHTML(s.className)}</td>
          <td>${escapeHTML(s.moduleTitle)}</td>
          <td>${escapeHTML(s.assignmentTitle)}</td>
          <td>${fmtDate(s.submittedAt)}</td>
          <td>${fmtDate(s.gradedAt)}</td>
          <td>${renderScoreCell(s)}</td>
          <td>${ s.feedback ? `<button class="btn btn-sm btn-outline-primary feedback-btn">View</button>` : `<span class="text-muted">—</span>` }</td>
          <td class="text-center">
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-secondary view-btn"><i class="bi bi-eye me-1"></i> View</button>
              <button class="btn btn-sm btn-danger delete-btn"><i class="bi bi-trash me-1"></i> Delete</button>
            </div>
          </td>
        </tr>
      `).join('');

      document.querySelectorAll('.feedback-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const aId = tr.getAttribute('data-assignment-id');
          const sId = tr.getAttribute('data-student-id');
          const item = shown.find(x => x.assignmentId === aId && x.studentId === sId);
          openFeedback(item);
        });
      });

      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const aId = tr.getAttribute('data-assignment-id');
          const sId = tr.getAttribute('data-student-id');
          const item = shown.find(x => x.assignmentId === aId && x.studentId === sId);
          openViewModal(item);
        });
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tr = e.target.closest('tr');
          const aId = tr.getAttribute('data-assignment-id');
          const sId = tr.getAttribute('data-student-id');
          const item = shown.find(x => x.assignmentId === aId && x.studentId === sId);
          openConfirmDelete(item);
        });
      });
    }

    function openFeedback(item){
      document.getElementById('feedbackTitle').textContent =
        `${item.studentName || item.studentId} • ${item.assignmentTitle}`;
      document.getElementById('feedbackBody').textContent = item.feedback || '—';
      closeAllModals();
      new bootstrap.Modal(document.getElementById('feedbackModal')).show();
    }

    function openViewModal(item){
      if (!item) return;
      vmCurrent = { assignmentId: item.assignmentId, studentId: item.studentId };

      vm.title.textContent = item.assignmentTitle || 'Submission';
      vm.student.textContent = item.studentName || item.studentId || '—';
      vm.class.textContent = item.className || '—';
      vm.module.textContent = item.moduleTitle || '—';
      vm.submitted.textContent = fmtDate(item.submittedAt);
      vm.graded.textContent = fmtDate(item.gradedAt);
      vm.score.innerHTML =
        (typeof item.grade === 'number')
          ? (typeof item.maxPoints === 'number'
              ? `<span class="badge bg-success score-badge">${item.grade} / ${item.maxPoints}</span>`
              : `<span class="badge bg-success score-badge">${item.grade}</span>`)
          : '<span class="text-muted">—</span>';
      vm.feedback.textContent = item.feedback || '—';

      // Files (open in Preview Modal with signing)
      vm.files.innerHTML = (item.files && item.files.length)
        ? item.files.map(f => {
            const name = escapeHTML(pickName(f));
            const payload = {
              downloadUrl: f.downloadUrl || '',
              publicUrl:   f.publicUrl   || '',
              previewUrl:  f.previewUrl  || '',
              url:         f.url         || '',
              storagePath: f.storagePath || '',
              gsUri:       f.gsUri       || '',
              filePath:    f.filePath    || '',
              originalName:f.originalName|| ''
            };
            const safe = JSON.stringify(payload).replace(/"/g,'&quot;');
            return `<li class="mb-1"><i class="bi bi-paperclip"></i>
                      <button type="button" class="btn btn-link p-0 align-baseline" onclick='openPreviewFromObj(${safe})'>${name}</button>
                    </li>`;
          }).join('')
        : `<li class="text-muted">—</li>`;

      vm.note.textContent = (item.text || '').trim() || '—';

      closeAllModals();
      vm.modal.show();
    }

    // View modal -> open type-to-confirm
    document.getElementById('vmDeleteBtn').addEventListener('click', () => {
      if (!vmCurrent) return;
      const item = shown.find(x => x.assignmentId === vmCurrent.assignmentId && x.studentId === vmCurrent.studentId);
      openConfirmDelete(item);
    });

    // Do the deletion
    confirmDeleteBtn.addEventListener('click', async () => {
      if (!pendingDelete) return;
      const { assignmentId, studentId } = pendingDelete;
      confirmDeleteBtn.disabled = true;

      try{
        const res = await fetch(`${API}/api/assignments/${encodeURIComponent(assignmentId)}/submissions/${encodeURIComponent(studentId)}`, { method:'DELETE' });
        const js = await res.json().catch(()=>({success:false}));
        if (!res.ok || js.success === false){
          throw new Error(js?.message || `HTTP ${res.status}`);
        }
        allGraded = allGraded.filter(x => !(x.assignmentId===assignmentId && x.studentId===studentId));
        applyFilters();
        try { confirmDeleteModal.hide(); } catch {}
        try { bootstrap.Modal.getInstance(document.getElementById('viewModal'))?.hide(); } catch {}
        showStatus('Submission deleted. The student can now submit again.', {success:true});
      }catch(err){
        console.error(err);
        try { confirmDeleteModal.hide(); } catch {}
        showStatus('Failed to delete submission: ' + (err.message || 'Unknown error'), {success:false});
      }finally{
        confirmDeleteBtn.disabled = false;
        pendingDelete = null;
      }
    });

    /* -------- Boot -------- */
    async function boot(){
      elBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">Loading…</td></tr>`;
      elSummary.textContent = 'Loading…';
      elAssignmentMeta.textContent = 'Loading…';

      try{
        let graded = [];

        if (paramAssignmentId){
          if (paramCourseId){
            await loadAssignments(paramCourseId); // fills assignmentMetaById
            const meta = assignmentMetaById.get(paramAssignmentId);
            if (meta){
              const dueStr = meta?.dueAt ? new Date(tsToMs(meta.dueAt)).toLocaleString() : 'N/A';
              const parts = [
                meta.title || 'Untitled',
                meta.moduleTitle && meta.moduleTitle !== '—' ? meta.moduleTitle : null,
                typeof meta.points === 'number' ? `${meta.points} pts` : null,
                meta.dueAt ? `Due: ${dueStr}` : null
              ].filter(Boolean);
              elAssignmentMeta.textContent = parts.join(' • ');
            } else {
              elAssignmentMeta.textContent = 'Selected assignment';
            }
          } else {
            elAssignmentMeta.textContent = 'Selected assignment';
          }

          graded = await loadGradedForAssignment(paramAssignmentId);
        } else {
          // All courses / all assignments view
          elAssignmentMeta.textContent = 'All courses • All assignments';
          const courses = await loadCoursesForTeacher(user.userId);
          for (const c of courses){
            const assigns = await loadAssignments(c.id);
            for (const a of assigns){
              const list = await loadGradedForAssignment(a.id);
              graded.push(...list);
            }
          }
        }

        // Enrich missing class names
        for (const g of graded){
          if ((!g.className || g.className === '—') && g.classId){
            g.className = await getClassName(g.classId);
          }
        }

        allGraded = graded;
        populateFilters(allGraded);
        applyFilters();
      }catch(err){
        console.error(err);
        elBody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-4">Failed to load graded submissions.</td></tr>`;
        elSummary.textContent = 'Failed to load.';
        if (elAssignmentMeta.textContent === 'Loading…') {
          elAssignmentMeta.textContent = '—';
        }
      }
    }

    /* -------- Events (instant apply) -------- */
    elSearch.addEventListener('input', applyFilters);
    elClass.addEventListener('change', applyFilters);
    elModule.addEventListener('change', applyFilters);
    elDate.addEventListener('change', applyFilters);
    elScore.addEventListener('input', applyFilters);
    elSortBy.addEventListener('change', applyFilters);

    btnUngraded.addEventListener('click', () => {
      const params = new URLSearchParams();
      if (paramCourseId) params.set('courseId', paramCourseId);
      if (paramAssignmentId) params.set('assignmentId', paramAssignmentId);
      window.location.href = `/TEACHER/assignment/grade_submission.html${params.toString() ? `?${params.toString()}` : ''}`;
    });

    boot();
  </script>
</body>
</html>
