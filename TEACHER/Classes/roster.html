<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Class Roster</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Global (keep your base) -->
  <link rel="stylesheet" href="../Classes/roster.css" />
</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="tableSearch" type="text" class="form-control" placeholder="Search roster..." />
          <i class="fas fa-search position-absolute" style="top:50%; right:15px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <section class="content">
        <div class="ui-card section mb-3 d-flex flex-wrap justify-content-between align-items-center">
          <h1 class="page-title brand mb-2 mb-md-0">Class Roster: <span id="classNameSpan">Loading…</span></h1>
          <div class="d-flex flex-wrap actions-wrap">
            <button class="btn btn-amber" data-bs-toggle="modal" data-bs-target="#enrollStudentModal">
              <i class="bi bi-person-plus-fill me-1"></i> Enroll Student
            </button>
            <button class="btn btn-amber-outline" data-bs-toggle="modal" data-bs-target="#bulkEnrollModal">
              <i class="bi bi-upload me-1"></i> Bulk Enroll
            </button>
            <button id="bulkRemoveBtn" class="btn btn-outline-danger" disabled>
              <i class="bi bi-trash3 me-1"></i> Remove Selected
            </button>
          </div>
        </div>

        <div class="meta-card p-3 mb-4">
          <div class="meta-strip">
            <div class="meta-item">
              <div class="label">Grade Level</div>
              <div class="value" id="metaGrade">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Section</div>
              <div class="value" id="metaSection">—</div>
            </div>
            <div class="meta-item">
              <div class="label">School Year</div>
              <div class="value" id="metaSY">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Semester</div>
              <div class="value" id="metaSem">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Students</div>
              <div class="value" id="metaCount">0</div>
            </div>
          </div>
        </div>

        <div class="ui-card p-2">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0" id="rosterTable">
              <thead>
                <tr>
                  <th style="width:38px;"><input type="checkbox" id="selectAll" class="form-check-input" /></th>
                  <th>Name</th>
                  <th>Student ID</th>
                  <th>Email</th>
                  <th>Last Active</th> <!-- NEW COLUMN -->
                  <th>Status</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="rosterBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Enroll Student Modal -->
  <div class="modal fade" id="enrollStudentModal" tabindex="-1" aria-labelledby="enrollStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="enrollStudentForm">
          <div class="modal-header">
            <h5 class="modal-title" id="enrollStudentModalLabel">Enroll Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="studentQueryInput" class="form-label">Search student</label>
              <input type="text" class="form-control" id="studentQueryInput"
                     placeholder="Type Student ID (e.g., S-2025-00001) or first/last name" required>
              <div class="form-text">Search is case-insensitive and matches by ID or name.</div>
            </div>

            <div id="studentLookupState" class="small mb-2" style="min-height:1.25rem;"></div>

            <div id="studentInfoCard" class="d-none">
              <div id="searchResults" class="d-grid gap-2"></div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-amber">Enroll Selected</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bulk Enroll Modal -->
  <div class="modal fade" id="bulkEnrollModal" tabindex="-1" aria-labelledby="bulkEnrollModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bulkEnrollForm">
          <div class="modal-header">
            <h5 class="modal-title" id="bulkEnrollModalLabel">Bulk Enroll Students (Excel/CSV)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <p class="mb-2">
              Upload an <strong>.xlsx</strong> or <strong>.csv</strong> file with a header column named
              <code>studentId</code>. Each row should have a student’s ID (e.g., <code>S-2025-00001</code>).
            </p>
            <div class="d-flex gap-2 mb-3">
              <button type="button" id="downloadTemplateBtn" class="btn btn-amber-outline btn-sm">
                <i class="bi bi-file-earmark-arrow-down"></i> Download CSV template
              </button>
            </div>

            <div class="mb-3">
              <label for="bulkFile" class="form-label">Select file</label>
              <input type="file" class="form-control" id="bulkFile" accept=".xlsx,.csv" required>
            </div>

            <div id="bulkStatus" class="small text-muted" style="min-height:1.25rem;"></div>
            <div id="bulkResult" class="mt-2 d-none"></div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-amber">
              <i class="bi bi-cloud-upload me-1"></i> Upload & Enroll
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Generic INFO Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic CONFIRM Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cancel"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal" id="confirmCancelBtn">Cancel</button>
          <!-- This text is fine; class will be enforced to btn-danger in JS every time -->
          <button type="button" class="btn btn-danger" id="confirmOkBtn">Yes, remove</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ---- Auth guard + header initials (robust) ---- -->
  <script>
  (function initHeaderInitials(){
    try{
      const raw = localStorage.getItem("user");
      const stored = raw ? JSON.parse(raw) : {};
      const u = stored.user || stored;

      if (!u?.userId || !u?.isTeacher) {
        window.location.href = "/TEACHER/login/login.html";
        return;
      }
      window.currentUser = u;

      const initials = getInitials(u);

      window.addEventListener("DOMContentLoaded", () => {
        const el = document.getElementById("Username");
        if (!el) return;
        el.textContent = initials;
        const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
                        || u.username || u.email || 'Profile';
        el.setAttribute('title', fullLabel);
        el.setAttribute('aria-label', fullLabel);
      });
    }catch(e){
      console.error('initHeaderInitials failed:', e);
      window.location.href = "/TEACHER/login/login.html";
    }

    function getInitials(u){
      const fn = (u.firstName || '').trim();
      const ln = (u.lastName  || '').trim();
      if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
      const nameish = (u.username || u.displayName || u.name || '').trim();
      if (nameish){
        const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ').split(/[\s._-]+/).filter(Boolean);
        if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
        return parts[0][0].toUpperCase();
      }
      const em = (u.email || '').trim();
      return em ? em[0].toUpperCase() : 'U';
    }
  })();
  </script>

  <script>
    const API_BASE = 'http://localhost:5000';
    let classId;
    let _lookupTimer = null;
    let _selectedStudentId = null;

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", "&#39;");
    }

    // --- datetime helpers (handles millis, Firestore Timestamp, ISO) ---
    function toMillis(v){
      if (v == null) return null;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const t = Date.parse(v); return isNaN(t) ? null : t;
      }
      if (v && typeof v === 'object'){
        if (typeof v.toMillis === 'function') return v.toMillis();
        if (v._seconds != null) return v._seconds * 1000;
        if (v.seconds != null)  return v.seconds  * 1000;
      }
      return null;
    }
    function fmtLocal(millis){
      return millis ? new Date(millis).toLocaleString() : '—';
    }
    function getLastActiveMillis(s){
      const cand = s.lastActiveAt ?? s.lastSeenAt ?? s.lastLoginAt ?? s.lastActivityAt ?? s.lastUsedAt ?? s.lastOnlineAt ?? (s.meta && s.meta.lastActiveAt);
      return toMillis(cand);
    }

    // ---------- Modal Helpers ----------
    const infoModalEl = document.getElementById('infoModal');
    const infoModal = new bootstrap.Modal(infoModalEl);
    const infoTitleEl = document.getElementById('infoModalLabel');
    const infoBodyEl = document.getElementById('infoModalBody');

    function showInfo(title = 'Notice', message = '') {
      infoTitleEl.textContent = title;
      infoBodyEl.innerHTML = message;
      infoModal.show();
    }

    const confirmModalEl = document.getElementById('confirmModal');
    const confirmTitleEl = document.getElementById('confirmModalLabel');
    const confirmBodyEl = document.getElementById('confirmModalBody');
    const confirmOkBtn = document.getElementById('confirmOkBtn');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    const confirmModal = new bootstrap.Modal(confirmModalEl);

    // Force the OK button to btn-danger every time (prevents theme overrides)
    function forceDangerOk(){
      confirmOkBtn.className = 'btn btn-danger';
    }

    function showConfirm(title = 'Confirm Action', message = 'Are you sure?') {
      confirmTitleEl.textContent = title;
      confirmBodyEl.innerHTML = message;
      forceDangerOk(); // 👈 ensure red button
      return new Promise((resolve) => {
        const onOk = () => { cleanup(); confirmModal.hide(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };
        function cleanup() {
          confirmOkBtn.removeEventListener('click', onOk);
          confirmCancelBtn.removeEventListener('click', onCancel);
          confirmModalEl.removeEventListener('hidden.bs.modal', onCancel);
        }
        confirmOkBtn.addEventListener('click', onOk, { once: true });
        confirmCancelBtn.addEventListener('click', onCancel, { once: true });
        confirmModalEl.addEventListener('hidden.bs.modal', onCancel, { once: true });
        confirmModal.show();
      });
    }

    // Sidebar
    async function loadSidebar() {
      try {
        const res = await fetch('/components/sidebar.html');
        const html = await res.text();
        document.getElementById('sidebar-container').innerHTML = html;

        const sidebar = document.querySelector('.sidebar');
        const dashboard = document.querySelector('.dashboard');
        if (sidebar && dashboard) {
          sidebar.addEventListener('mouseenter', () => dashboard.classList.add('sidebar-expanded'));
          sidebar.addEventListener('mouseleave', () => dashboard.classList.remove('sidebar-expanded'));
        }

        document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
          toggle.addEventListener('click', e => {
            e.preventDefault();
            const parent = toggle.closest('.has-submenu');
            parent.classList.toggle('open');
            toggle.setAttribute('aria-expanded', parent.classList.contains('open'));
          });
        });
      } catch (err) {
        console.error('Failed to load sidebar:', err);
      }
    }

    async function safeJson(res) {
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) { try { return await res.json(); } catch { } }
      return null;
    }

    // Load class + roster
    async function loadRoster() {
      try {
        const classRes = await fetch(`${API_BASE}/api/classes/${classId}`);
        const classPayload = await safeJson(classRes) || {};
        const cls = classPayload.class || {};
        const name = cls.name || `ID: ${classId}`;
        const classNameSpan = document.getElementById('classNameSpan');
        if (classNameSpan) classNameSpan.textContent = name;
        document.title = `Class Roster: ${name}`;
        document.getElementById('metaGrade').textContent = cls.gradeLevel || '—';
        document.getElementById('metaSection').textContent = cls.section || '—';
        document.getElementById('metaSY').textContent = cls.schoolYear || '—';
        document.getElementById('metaSem').textContent = cls.semester || '—';

        const res = await fetch(`${API_BASE}/api/classes/${classId}/students`);
        const data = await safeJson(res) || {};
        const students = Array.isArray(data.students) ? data.students : [];
        const tbody = document.getElementById('rosterBody');
        tbody.innerHTML = '';

        students.forEach(s => {
          const tr = document.createElement('tr');
          const fullName = escapeHtml(s.fullName || `${s.firstName || ''} ${s.lastName || ''}`.trim());
          const sid = escapeHtml(s.studentId || '');
          const email = escapeHtml(s.email || '');
          const emailCell = email ? `<a href="mailto:${email}">${email}</a>` : '—';
          const statusCell = s.active
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-warning text-dark">Inactive</span>';
          const lastMs = getLastActiveMillis(s);
          const lastCell = lastMs ? `<span title="${new Date(lastMs).toISOString()}">${fmtLocal(lastMs)}</span>` : '—';

          tr.innerHTML = `
            <td><input type="checkbox" class="row-select form-check-input" data-student-id="${sid}"></td>
            <td>${fullName || '—'}</td>
            <td>${sid || '—'}</td>
            <td>${emailCell}</td>
            <td>${lastCell}</td>            <!-- NEW CELL -->
            <td>${statusCell}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger remove-btn" data-student-id="${sid}">Remove</button>
            </td>`;
          tbody.appendChild(tr);
        });

        wireSelectionControls();
        document.getElementById('metaCount').textContent = String(students.length);
      } catch (err) {
        console.error('Error loading roster:', err);
        showInfo('Load Error', 'There was a problem loading the class roster. Please try again.');
      }
    }

    // Remove single
    document.getElementById('rosterBody').addEventListener('click', async (e) => {
      const btn = e.target.closest('.remove-btn');
      if (!btn) return;
      const sid = btn.dataset.studentId;
      await removeStudent(sid);
    });

    async function removeStudent(studentId) {
      if (!studentId) return;
      const ok = await showConfirm('Remove Student', 'Remove this student from the class?');
      if (!ok) return;
      try {
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students/${encodeURIComponent(studentId)}`, { method: 'DELETE' });
        const out = await safeJson(res) || {};
        if (!res.ok || out.success === false) {
          showInfo('Remove Failed', escapeHtml(out.message || 'Failed to remove student.'));
          return;
        }
        await loadRoster();
        showInfo('Removed', 'The student was removed from this class.');
      } catch (err) {
        console.error('Error removing student:', err);
        showInfo('Network Error', 'Network error while removing the student.');
      }
    }

    // Bulk selection
    function wireSelectionControls() {
      const selectAll = document.getElementById('selectAll');
      const rowChecks = Array.from(document.querySelectorAll('.row-select'));
      const bulkBtn = document.getElementById('bulkRemoveBtn');

      const refreshBulkBtn = () => {
        const anyChecked = rowChecks.some(cb => cb.checked);
        bulkBtn.disabled = !anyChecked;
      };

      selectAll.checked = false;
      selectAll.onchange = () => {
        rowChecks.forEach(cb => cb.checked = selectAll.checked);
        refreshBulkBtn();
      };
      rowChecks.forEach(cb => {
        cb.onchange = () => {
          if (!cb.checked) selectAll.checked = false;
          if (rowChecks.every(x => x.checked)) selectAll.checked = true;
          refreshBulkBtn();
        };
      });

      bulkBtn.onclick = async () => {
        const ids = rowChecks.filter(cb => cb.checked).map(cb => cb.dataset.studentId);
        if (!ids.length) return;

        const ok = await showConfirm(
          'Bulk Remove',
          `Remove <strong>${ids.length}</strong> selected student(s) from the class?`
        );
        if (!ok) return;

        let removed = 0, failed = 0;
        for (const sid of ids) {
          try {
            const res = await fetch(`${API_BASE}/api/classes/${classId}/students/${encodeURIComponent(sid)}`, { method: 'DELETE' });
            const out = await safeJson(res) || {};
            if (res.ok && out.success) removed++; else failed++;
          } catch { failed++; }
        }
        await loadRoster();
        showInfo('Bulk Remove Complete', `
          <div><strong>Removed:</strong> ${removed}</div>
          <div><strong>Failed:</strong> ${failed}</div>
        `);
      };

      bulkBtn.disabled = true;
    }

    // ---------- Enroll modal: SEARCH (STRICT: must have studentId) ----------
    const studentQueryInput = () => document.getElementById('studentQueryInput');
    const studentInfoCard = () => document.getElementById('studentInfoCard');
    const lookupStateEl = () => document.getElementById('studentLookupState');
    const searchResults = () => document.getElementById('searchResults');

    function clearSearchUI() {
      _selectedStudentId = null;
      searchResults().innerHTML = '';
      studentInfoCard().classList.add('d-none');
    }

    async function searchStudents(q) {
      if (!q) { clearSearchUI(); lookupStateEl().textContent = ''; return; }
      lookupStateEl().textContent = 'Searching…';
      try {
        const res = await fetch(`${API_BASE}/api/students/search?query=${encodeURIComponent(q)}`);
        const data = await safeJson(res) || {};

        const studentsOnly = Array.isArray(data.students)
          ? data.students.filter(stu => typeof stu.studentId === 'string' && stu.studentId.trim() !== '')
          : [];

        if (data.success && studentsOnly.length) {
          searchResults().innerHTML = studentsOnly.map(stu => {
            const id = escapeHtml(stu.studentId || '');
            const fn = escapeHtml(stu.firstName || '');
            const ln = escapeHtml(stu.lastName || '');
            const em = escapeHtml(stu.email || '');
            return `
              <label class="search-result d-flex align-items-center gap-2">
                <input type="radio" name="studentPick" value="${id}">
                <div>
                  <div><strong>${(fn + ' ' + ln).trim()}</strong></div>
                  <div class="text-muted small">ID: ${id}${em ? ' • ' + em : ''}</div>
                </div>
              </label>`;
          }).join('');
          studentInfoCard().classList.remove('d-none');
          lookupStateEl().textContent = '';
        } else {
          clearSearchUI();
          lookupStateEl().textContent = 'No matching student found.';
        }
      } catch (e) {
        console.error('Search error:', e);
        clearSearchUI();
        lookupStateEl().textContent = 'Error while searching.';
      }
    }

    document.getElementById('studentQueryInput').addEventListener('input', () => {
      clearTimeout(_lookupTimer);
      const val = studentQueryInput().value.trim();
      if (!val) { clearSearchUI(); lookupStateEl().textContent = ''; return; }
      if (val.length < 2) { clearSearchUI(); lookupStateEl().textContent = 'Type at least 2 characters…'; return; }
      _lookupTimer = setTimeout(() => searchStudents(val), 300);
    });

    document.getElementById('studentInfoCard').addEventListener('change', (e) => {
      if (e.target.name === 'studentPick') _selectedStudentId = e.target.value;
    });

    document.getElementById('enrollStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!_selectedStudentId) {
        showInfo('Pick a Student', 'Please select a student from the search results first.');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId: _selectedStudentId })
        });
        const out = await safeJson(res) || {};
        if (!res.ok || !out.success) {
          showInfo('Enroll Failed', escapeHtml(out.message || 'Failed to enroll student.'));
          return;
        }
        e.target.reset(); clearSearchUI(); lookupStateEl().textContent = '';
        const modal = bootstrap.Modal.getInstance(document.getElementById('enrollStudentModal'));
        modal && modal.hide();
        await loadRoster();
        showInfo('Enrolled', 'The student was successfully enrolled in this class.');
      } catch (err) {
        console.error('Enroll error:', err);
        showInfo('Network Error', 'There was a problem enrolling the student. Please try again.');
      }
    });

    // Bulk enroll
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', () => {
      const csv = 'studentId\nS-2025-00001\nS-2025-00002\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'bulk_enroll_template.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    document.getElementById('bulkEnrollForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('bulkFile');
      const statusEl = document.getElementById('bulkStatus');
      const resultEl = document.getElementById('bulkResult');
      if (!fileInput.files || !fileInput.files[0]) {
        showInfo('No File', 'Please select a .csv or .xlsx file first.');
        return;
      }

      statusEl.textContent = 'Uploading and processing…';
      resultEl.classList.add('d-none'); resultEl.innerHTML = '';

      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students/bulk`, { method: 'POST', body: fd });

        const out = await safeJson(res);
        if (res.ok && out) {
          const r = out.report || {};
          statusEl.textContent = 'Done.';
          resultEl.classList.remove('d-none');
          resultEl.innerHTML = `
            <div class="alert alert-info mb-0">
              <div><strong>Total rows:</strong> ${r.total ?? 0}</div>
              <div><strong>Enrolled:</strong> ${r.enrolled ?? 0}</div>
              <div><strong>Already enrolled:</strong> ${r.alreadyEnrolled ?? 0}</div>
              <div><strong>Not found:</strong> ${r.notFound ?? 0}</div>
              <div><strong>Errors:</strong> ${r.errors ?? 0}</div>
            </div>`;
          await loadRoster();
          showInfo('Bulk Enroll Complete', 'Your file has been processed.');
          return;
        }

        statusEl.textContent = '';
        showInfo('Bulk Enroll Failed', escapeHtml(out?.message || `Bulk enroll failed (HTTP ${res.status}).`));
      } catch (err) {
        statusEl.textContent = '';
        console.error('Bulk upload error:', err);
        showInfo('Network Error', 'There was a problem uploading or processing the file.');
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      classId = params.get('classId');

      if (!classId) {
        showInfo('Missing classId', 'Missing classId in URL. You will be redirected to the Class List.');
        infoModalEl.addEventListener('hidden.bs.modal', () => {
          window.location.href = '/TEACHER/Classes/class_list.html';
        }, { once: true });
        return;
      }

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.isTeacher) return (window.location.href = '/TEACHER/login/login.html');

      const nameSlot = document.querySelector('.username');
      if (nameSlot) nameSlot.textContent = user.username || '';

      await loadSidebar();
      await loadRoster();

      // Fixed: wire search to the actual #tableSearch input
      document.getElementById('tableSearch').addEventListener('input', e => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#rosterBody tr').forEach(tr => {
          tr.style.display = tr.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
      });
    });

    function logoutUser() {
      localStorage.removeItem('user');
      window.location.href = '/TEACHER/login/login.html';
    }
  </script>
</body>
</html>
