<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Class Roster</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Global (keep your base) -->
  <link rel="stylesheet" href="../Classes/roster.css" />
</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="tableSearch" type="text" class="form-control" placeholder="Search roster..." />
          <i class="fas fa-search position-absolute" style="top:50%; right:15px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <section class="content">
        <div class="ui-card section mb-3 d-flex flex-wrap justify-content-between align-items-center">
          <h1 class="page-title brand mb-2 mb-md-0">Class Roster: <span id="classNameSpan">Loading…</span></h1>
          <div class="d-flex flex-wrap actions-wrap">
            <button class="btn btn-amber" data-bs-toggle="modal" data-bs-target="#enrollStudentModal">
              <i class="bi bi-person-plus-fill me-1"></i> Enroll Student
            </button>
            <button class="btn btn-amber-outline" data-bs-toggle="modal" data-bs-target="#bulkEnrollModal">
              <i class="bi bi-upload me-1"></i> Bulk Enroll
            </button>
            <button id="bulkRemoveBtn" class="btn btn-outline-danger" disabled>
              <i class="bi bi-trash3 me-1"></i> Remove Selected
            </button>
          </div>
        </div>

        <div class="meta-card p-3 mb-4">
          <div class="meta-strip">
            <div class="meta-item">
              <div class="label">Grade Level</div>
              <div class="value" id="metaGrade">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Section</div>
              <div class="value" id="metaSection">—</div>
            </div>
            <div class="meta-item">
              <div class="label">School Year</div>
              <div class="value" id="metaSY">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Semester</div>
              <div class="value" id="metaSem">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Students</div>
              <div class="value" id="metaCount">0</div>
            </div>
          </div>
        </div>

        <div class="ui-card p-2">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0" id="rosterTable">
              <thead>
                <tr>
                  <th style="width:38px;"><input type="checkbox" id="selectAll" class="form-check-input" /></th>
                  <th>Name</th>
                  <th>Student ID</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="rosterBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Enroll Student Modal (multi-select) -->
  <div class="modal fade" id="enrollStudentModal" tabindex="-1" aria-labelledby="enrollStudentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="enrollStudentForm">
          <div class="modal-header">
            <h5 class="modal-title" id="enrollStudentModalLabel">Enroll Student(s)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="studentQueryInput" class="form-label">Search students</label>
              <input type="text" class="form-control" id="studentQueryInput"
                placeholder="Type Student ID (e.g., S-2025-00001) or first/last name" required>
              <div class="form-text">Search is case-insensitive and matches by ID or name.</div>
            </div>

            <div id="studentLookupState" class="small mb-2 d-none" aria-live="polite"></div>

            <div id="studentInfoCard" class="d-none">
              <div class="results-toolbar">
                <div class="form-check m-0">
                  <input class="form-check-input" type="checkbox" id="pickAll">
                  <label class="form-check-label" for="pickAll">Select All</label>
                </div>
                <span class="count" id="pickedCount">0 selected</span>
              </div>
              <div id="searchResults" class="d-grid gap-2"></div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-amber"><i class="bi bi-person-check me-1"></i> Enroll Selected</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bulk Enroll Modal -->
  <div class="modal fade" id="bulkEnrollModal" tabindex="-1" aria-labelledby="bulkEnrollModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bulkEnrollForm">
          <div class="modal-header">
            <h5 class="modal-title" id="bulkEnrollModalLabel">Bulk Enroll Students (Excel/CSV)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <p class="mb-2">
              Upload an <strong>.xlsx</strong> or <strong>.csv</strong> file with a header column named
              <code>studentId</code>. Each row should have a student’s ID (e.g., <code>S-2025-00001</code>).
            </p>
            <div class="d-flex gap-2 mb-3">
              <button type="button" id="downloadTemplateBtn" class="btn btn-amber-outline btn-sm">
                <i class="bi bi-file-earmark-arrow-down"></i> Download CSV template
              </button>
            </div>

            <div class="mb-3">
              <label for="bulkFile" class="form-label">Select file</label>
              <input type="file" class="form-control" id="bulkFile" accept=".xlsx,.csv" required>
            </div>

            <div id="bulkStatus" class="small text-muted" style="min-height:1.25rem;"></div>
            <div id="bulkResult" class="mt-2 d-none"></div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-amber">
              <i class="bi bi-cloud-upload me-1"></i> Upload & Enroll
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Generic INFO Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic CONFIRM Modal (type-to-delete flows kept) -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content confirm-no-copy">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cancel"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal" id="confirmCancelBtn">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmOkBtn">Yes, remove</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ---- Auth guard + header initials (robust) ---- -->
  <script>
    (function initHeaderInitials() {
      try {
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;

        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return;
        }
        window.currentUser = u;

        const initials = getInitials(u);

        window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("Username");
          if (!el) return;
          el.textContent = initials;
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username || u.email || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        });
      } catch (e) {
        console.error('initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
      }

      function getInitials(u) {
        const fn = (u.firstName || '').trim();
        const ln = (u.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ').split(/[\s._-]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }
        const em = (u.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();
  </script>

  <script>
    const API_BASE = 'http://localhost:5000';
    let classId;
    let _lookupTimer = null;

    // track MULTI selection
    const _selectedStudentIds = new Set();

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", "&#39;");
    }

    // --- datetime helpers ---
    function toMillis(v) {
      if (v == null) return null;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const t = Date.parse(v); return isNaN(t) ? null : t;
      }
      if (v && typeof v === 'object') {
        if (typeof v.toMillis === 'function') return v.toMillis();
        if (v._seconds != null) return v._seconds * 1000;
        if (v.seconds != null) return v.seconds * 1000;
      }
      return null;
    }
    function fmtLocal(millis) { return millis ? new Date(millis).toLocaleString() : '—'; }
    function getLastActiveMillis(s) {
      const cand = s.lastActiveAt ?? s.lastSeenAt ?? s.lastLoginAt ?? s.lastActivityAt ?? s.lastUsedAt ?? s.lastOnlineAt ?? (s.meta && s.meta.lastActiveAt);
      return toMillis(cand);
    }

    // ---------- Info / Confirm helpers ----------
    const infoModalEl = document.getElementById('infoModal');
    const infoModal = new bootstrap.Modal(infoModalEl);
    const infoTitleEl = document.getElementById('infoModalLabel');
    const infoBodyEl = document.getElementById('infoModalBody');
    function showInfo(title = 'Notice', message = '') { infoTitleEl.textContent = title; infoBodyEl.innerHTML = message; infoModal.show(); }

    const confirmModalEl = document.getElementById('confirmModal');
    const confirmTitleEl = document.getElementById('confirmModalLabel');
    const confirmBodyEl = document.getElementById('confirmModalBody');
    const confirmOkBtn = document.getElementById('confirmOkBtn');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    const confirmModal = new bootstrap.Modal(confirmModalEl);
    function forceDangerOk() { confirmOkBtn.className = 'btn btn-danger'; }

    function attachCopyBlockers() {
      const block = (e) => e.preventDefault();
      confirmModalEl.addEventListener('copy', block);
      confirmModalEl.addEventListener('cut', block);
      confirmModalEl.addEventListener('contextmenu', block);
      return () => {
        confirmModalEl.removeEventListener('copy', block);
        confirmModalEl.removeEventListener('cut', block);
        confirmModalEl.removeEventListener('contextmenu', block);
      };
    }

    async function showTypeToConfirm_StudentId(title, expectedId) {
      confirmTitleEl.textContent = title;
      confirmBodyEl.innerHTML = `
        <div class="mb-2">
          Confirm you want to remove this student by typing their <strong>Student ID</strong> (case-sensitive).
        </div>
        <div class="alert alert-danger py-2 small mb-2" title="Copy disabled in this area">
          Type exactly: <code>${escapeHtml(expectedId)}</code>
        </div>
        <input type="text" class="form-control" id="typeToConfirmInput" placeholder="Type Student ID here" autocomplete="off" />
        <div class="invalid-feedback">Input does not match. Please type <strong>${escapeHtml(expectedId)}</strong> to proceed.</div>
        <div class="valid-feedback">✓ Input matches</div>
      `;
      confirmOkBtn.textContent = 'Remove';
      confirmOkBtn.disabled = true;
      forceDangerOk();

      const detach = attachCopyBlockers();

      return new Promise((resolve) => {
        const input = document.getElementById('typeToConfirmInput');
        const onInput = () => {
          const match = (input.value.trim() === expectedId);
          input.classList.toggle('is-valid', match);
          input.classList.toggle('is-invalid', !match);
          confirmOkBtn.disabled = !match;
        };
        const onOk = () => { if (!confirmOkBtn.disabled) { cleanup(); confirmModal.hide(); resolve(true); } };
        const onCancel = () => { cleanup(); resolve(false); };
        function cleanup() {
          confirmOkBtn.removeEventListener('click', onOk);
          confirmCancelBtn.removeEventListener('click', onCancel);
          confirmModalEl.removeEventListener('hidden.bs.modal', onCancel);
          input.removeEventListener('input', onInput);
          detach();
          confirmOkBtn.disabled = false;
          confirmOkBtn.textContent = 'Yes, remove';
        }
        confirmOkBtn.addEventListener('click', onOk);
        confirmCancelBtn.addEventListener('click', onCancel);
        confirmModalEl.addEventListener('hidden.bs.modal', onCancel, { once: true });
        input.addEventListener('input', onInput);
        confirmModal.show();
        setTimeout(() => { input.focus(); onInput(); }, 150);
      });
    }

    async function showTypeToConfirm_BulkRemove(title, count) {
      const expected = `REMOVE ${count}`;
      confirmTitleEl.textContent = title;
      confirmBodyEl.innerHTML = `
        <div class="mb-2">
          You are about to remove <strong>${count}</strong> students from this class.
          To confirm, type <strong>${expected}</strong> exactly (case-sensitive).
        </div>
        <div class="alert alert-danger py-2 small mb-2" title="Copy disabled in this area">
          Type exactly: <code>${expected}</code>
        </div>
        <input type="text" class="form-control" id="typeToConfirmInput" placeholder="Type ${expected}" autocomplete="off" />
        <div class="invalid-feedback">Input does not match. Please type <strong>${expected}</strong> to proceed.</div>
        <div class="valid-feedback">✓ Input matches</div>
      `;
      confirmOkBtn.textContent = 'Remove';
      confirmOkBtn.disabled = true;
      forceDangerOk();
      const detach = attachCopyBlockers();

      return new Promise((resolve) => {
        const input = document.getElementById('typeToConfirmInput');
        const onInput = () => {
          const match = (input.value.trim() === expected);
          input.classList.toggle('is-valid', match);
          input.classList.toggle('is-invalid', !match);
          confirmOkBtn.disabled = !match;
        };
        const onOk = () => { if (!confirmOkBtn.disabled) { cleanup(); confirmModal.hide(); resolve(true); } };
        const onCancel = () => { cleanup(); resolve(false); };
        function cleanup() {
          confirmOkBtn.removeEventListener('click', onOk);
          confirmCancelBtn.removeEventListener('click', onCancel);
          confirmModalEl.removeEventListener('hidden.bs.modal', onCancel);
          input.removeEventListener('input', onInput);
          detach();
          confirmOkBtn.disabled = false;
          confirmOkBtn.textContent = 'Yes, remove';
        }
        confirmOkBtn.addEventListener('click', onOk);
        confirmCancelBtn.addEventListener('click', onCancel);
        confirmModalEl.addEventListener('hidden.bs.modal', onCancel, { once: true });
        input.addEventListener('input', onInput);
        confirmModal.show();
        setTimeout(() => { input.focus(); onInput(); }, 150);
      });
    }

    async function safeJson(res) {
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) { try { return await res.json(); } catch { } }
      return null;
    }

    // ===== Lookup state helper (HIDE when empty) =====
    function setLookupState(msg) {
      const el = lookupStateEl();
      if (!el) return;
      if (!msg) { el.textContent = ''; el.classList.add('d-none'); }
      else { el.textContent = msg; el.classList.remove('d-none'); }
    }

    // Load class + roster
    async function loadRoster() {
      try {
        const classRes = await fetch(`${API_BASE}/api/classes/${classId}`);
        const classPayload = await safeJson(classRes) || {};
        const cls = classPayload.class || {};
        const name = cls.name || `ID: ${classId}`;
        const classNameSpan = document.getElementById('classNameSpan');
        if (classNameSpan) classNameSpan.textContent = name;
        document.title = `Class Roster: ${name}`;
        document.getElementById('metaGrade').textContent = cls.gradeLevel || '—';
        document.getElementById('metaSection').textContent = cls.section || '—';
        document.getElementById('metaSY').textContent = cls.schoolYear || '—';
        document.getElementById('metaSem').textContent = cls.semester || '—';

        const res = await fetch(`${API_BASE}/api/classes/${classId}/students`);
        const data = await safeJson(res) || {};
        const students = Array.isArray(data.students) ? data.students : [];
        const tbody = document.getElementById('rosterBody');
        tbody.innerHTML = '';

        students.forEach(s => {
          const tr = document.createElement('tr');
          const fullName = escapeHtml(s.fullName || `${s.firstName || ''} ${s.lastName || ''}`.trim());

          // IMPORTANT: keep raw vs escaped versions
          const sidRaw = (s.studentId || '');
          const sidEsc = escapeHtml(sidRaw);

          const email = escapeHtml(s.email || '');
          const emailCell = email ? `<a href="mailto:${email}">${email}</a>` : '—';
          const statusCell = s.active
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-warning text-dark">Inactive</span>';
          const lastMs = getLastActiveMillis(s);
          const lastCell = lastMs ? `<span title="${new Date(lastMs).toISOString()}">${fmtLocal(lastMs)}</span>` : '—';

          tr.innerHTML = `
            <td><input type="checkbox" class="row-select form-check-input" data-student-id="${sidRaw}"></td>
            <td>${fullName || '—'}</td>
            <td>${sidEsc || '—'}</td>
            <td>${emailCell}</td>
            
            <td>${statusCell}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger remove-btn" data-student-id="${sidRaw}">Remove</button>
            </td>`;
          tbody.appendChild(tr);
        });

        wireSelectionControls();
        document.getElementById('metaCount').textContent = String(students.length);
      } catch (err) {
        console.error('Error loading roster:', err);
        showInfo('Load Error', 'There was a problem loading the class roster. Please try again.');
      }
    }

    // Remove single (keeps type-to-delete)
    document.getElementById('rosterBody').addEventListener('click', async (e) => {
      const btn = e.target.closest('.remove-btn');
      if (!btn) return;
      const sid = btn.dataset.studentId; // RAW
      if (!sid) return showInfo('Missing ID', 'Could not determine the Student ID for this row.');
      await removeStudent(sid);
    });

    async function removeStudent(studentId) {
      const okTyped = await showTypeToConfirm_StudentId('Remove Student', studentId);
      if (!okTyped) return;
      try {
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students/${encodeURIComponent(studentId)}`, { method: 'DELETE' });
        const out = await safeJson(res) || {};
        if (!res.ok || out.success === false) {
          const msg = out.message || `Failed to remove student (HTTP ${res.status}).`;
          showInfo('Remove Failed', escapeHtml(msg));
          return;
        }
        await loadRoster();
        showInfo('Removed', `Student <code>${escapeHtml(studentId)}</code> was removed from this class.`);
      } catch (err) {
        console.error('Error removing student:', err);
        showInfo('Network Error', 'Network error while removing the student.');
      }
    }

    // Bulk selection in table (kept)
    function wireSelectionControls() {
      const selectAll = document.getElementById('selectAll');
      const rowChecks = Array.from(document.querySelectorAll('.row-select'));
      const bulkBtn = document.getElementById('bulkRemoveBtn');

      const refreshBulkBtn = () => { bulkBtn.disabled = !rowChecks.some(cb => cb.checked); };

      selectAll.checked = false;
      selectAll.onchange = () => { rowChecks.forEach(cb => cb.checked = selectAll.checked); refreshBulkBtn(); };
      rowChecks.forEach(cb => {
        cb.onchange = () => {
          if (!cb.checked) selectAll.checked = false;
          if (rowChecks.every(x => x.checked)) selectAll.checked = true;
          refreshBulkBtn();
        };
      });

      bulkBtn.onclick = async () => {
        const ids = rowChecks.filter(cb => cb.checked).map(cb => cb.dataset.studentId);
        if (!ids.length) return;

        const okTyped = await showTypeToConfirm_BulkRemove('Bulk Remove', ids.length);
        if (!okTyped) return;

        let removed = 0, failed = 0;
        for (const sid of ids) {
          try {
            const res = await fetch(`${API_BASE}/api/classes/${classId}/students/${encodeURIComponent(sid)}`, { method: 'DELETE' });
            const out = await safeJson(res) || {};
            if (res.ok && out.success !== false) removed++; else failed++;
          } catch { failed++; }
        }
        await loadRoster();
        showInfo('Bulk Remove Complete', `<div><strong>Removed:</strong> ${removed}</div><div><strong>Failed:</strong> ${failed}</div>`);
      };

      bulkBtn.disabled = true;
    }

    // ---------- Enroll modal: SEARCH (multi-pick) ----------
    const studentQueryInput = () => document.getElementById('studentQueryInput');
    const studentInfoCard = () => document.getElementById('studentInfoCard');
    const lookupStateEl = () => document.getElementById('studentLookupState');
    const searchResults = () => document.getElementById('searchResults');
    const pickAllEl = () => document.getElementById('pickAll');
    const pickedCountEl = () => document.getElementById('pickedCount');

    function updatePickedCount() {
      const n = _selectedStudentIds.size;
      pickedCountEl().textContent = `${n} selected`;
    }

    function clearSearchUI() {
      _selectedStudentIds.clear();
      updatePickedCount();
      searchResults().innerHTML = '';
      studentInfoCard().classList.add('d-none');
      pickAllEl().checked = false;
    }

    function renderResults(studentsOnly) {
      const html = studentsOnly.map(stu => {
        const idRaw = (stu.studentId || '');
        const idEsc = escapeHtml(idRaw);
        const fn = escapeHtml(stu.firstName || '');
        const ln = escapeHtml(stu.lastName || '');
        const em = escapeHtml(stu.email || '');
        const checked = _selectedStudentIds.has(idRaw) ? 'checked' : '';
        return `
          <label class="search-result d-flex align-items-center gap-2">
            <input type="checkbox" class="form-check-input student-pick" value="${idRaw}" ${checked}>
            <div>
              <div><strong>${(fn + ' ' + ln).trim()}</strong></div>
              <div class="text-muted small">ID: ${idEsc}${em ? ' • ' + em : ''}</div>
            </div>
          </label>`;
      }).join('');
      searchResults().innerHTML = html;

      const allIds = studentsOnly.map(s => s.studentId).filter(Boolean);
      const allChecked = allIds.length > 0 && allIds.every(id => _selectedStudentIds.has(id));
      pickAllEl().checked = allChecked;
      updatePickedCount();
    }

    async function searchStudents(q) {
      if (!q) { clearSearchUI(); setLookupState(''); return; }
      setLookupState('Searching…');
      try {
        const res = await fetch(`${API_BASE}/api/students/search?query=${encodeURIComponent(q)}`);
        const data = await safeJson(res) || {};

        const studentsOnly = Array.isArray(data.students)
          ? data.students.filter(stu => typeof stu.studentId === 'string' && stu.studentId.trim() !== '')
          : [];

        if (data.success && studentsOnly.length) {
          studentInfoCard().classList.remove('d-none');
          renderResults(studentsOnly);
          setLookupState('');
        } else {
          clearSearchUI();
          setLookupState('No matching student found.');
        }
      } catch (e) {
        console.error('Search error:', e);
        clearSearchUI();
        setLookupState('Error while searching.');
      }
    }

    document.getElementById('studentQueryInput').addEventListener('input', () => {
      clearTimeout(_lookupTimer);
      const val = studentQueryInput().value.trim();
      if (!val) { clearSearchUI(); setLookupState(''); return; }
      if (val.length < 2) { clearSearchUI(); setLookupState('Type at least 2 characters…'); return; }
      _lookupTimer = setTimeout(() => searchStudents(val), 300);
    });

    document.getElementById('studentInfoCard').addEventListener('change', (e) => {
      if (e.target.classList.contains('student-pick')) {
        const id = e.target.value; // RAW
        if (e.target.checked) _selectedStudentIds.add(id);
        else _selectedStudentIds.delete(id);
        updatePickedCount();
        const boxes = Array.from(document.querySelectorAll('#searchResults .student-pick'));
        pickAllEl().checked = boxes.length > 0 && boxes.every(b => b.checked);
      }
      if (e.target.id === 'pickAll') {
        const check = e.target.checked;
        const boxes = Array.from(document.querySelectorAll('#searchResults .student-pick'));
        boxes.forEach(b => {
          b.checked = check;
          const id = b.value;
          if (check) _selectedStudentIds.add(id); else _selectedStudentIds.delete(id);
        });
        updatePickedCount();
      }
    });

    document.getElementById('enrollStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (_selectedStudentIds.size === 0) {
        showInfo('Pick Students', 'Please select at least one student from the search results first.');
        return;
      }
      const ids = Array.from(_selectedStudentIds);
      let ok = 0, failed = 0, already = 0;

      try {
        for (const sid of ids) {
          try {
            const res = await fetch(`${API_BASE}/api/classes/${classId}/students`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ studentId: sid })
            });
            const out = await safeJson(res) || {};
            if (res.ok && out.success) ok++;
            else if (out.code === 'ALREADY_ENROLLED') already++;
            else failed++;
          } catch {
            failed++;
          }
        }
        e.target.reset(); clearSearchUI(); setLookupState('');
        const modal = bootstrap.Modal.getInstance(document.getElementById('enrollStudentModal'));
        modal && modal.hide();
        await loadRoster();

        showInfo('Enroll Finished', `
          <div><strong>Enrolled:</strong> ${ok}</div>
          <div><strong>Already enrolled:</strong> ${already}</div>
          <div><strong>Failed:</strong> ${failed}</div>
        `);
      } catch (err) {
        console.error('Enroll error:', err);
        showInfo('Network Error', 'There was a problem enrolling the selected students. Please try again.');
      }
    });

    // Bulk enroll (file)
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', () => {
      const csv = 'studentId\nS-2025-00001\nS-2025-00002\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'bulk_enroll_template.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    document.getElementById('bulkEnrollForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('bulkFile');
      const statusEl = document.getElementById('bulkStatus');
      const resultEl = document.getElementById('bulkResult');
      if (!fileInput.files || !fileInput.files[0]) {
        showInfo('No File', 'Please select a .csv or .xlsx file first.');
        return;
      }

      statusEl.textContent = 'Uploading and processing…';
      resultEl.classList.add('d-none'); resultEl.innerHTML = '';

      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students/bulk`, { method: 'POST', body: fd });

        const out = await safeJson(res);
        if (res.ok && out) {
          const r = out.report || {};
          statusEl.textContent = 'Done.';
          resultEl.classList.remove('d-none');
          resultEl.innerHTML = `
            <div class="alert alert-info mb-0">
              <div><strong>Total rows:</strong> ${r.total ?? 0}</div>
              <div><strong>Enrolled:</strong> ${r.enrolled ?? 0}</div>
              <div><strong>Already enrolled:</strong> ${r.alreadyEnrolled ?? 0}</div>
              <div><strong>Not found:</strong> ${r.notFound ?? 0}</div>
              <div><strong>Errors:</strong> ${r.errors ?? 0}</div>
            </div>`;
          await loadRoster();
          showInfo('Bulk Enroll Complete', 'Your file has been processed.');
          return;
        }

        statusEl.textContent = '';
        showInfo('Bulk Enroll Failed', escapeHtml(out?.message || `Bulk enroll failed (HTTP ${res.status}).`));
      } catch (err) {
        statusEl.textContent = '';
        console.error('Bulk upload error:', err);
        showInfo('Network Error', 'There was a problem uploading or processing the file.');
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      classId = params.get('classId');

      if (!classId) {
        showInfo('Missing classId', 'Missing classId in URL. You will be redirected to the Class List.');
        infoModalEl.addEventListener('hidden.bs.modal', () => {
          window.location.href = '/TEACHER/Classes/class_list.html';
        }, { once: true });
        return;
      }

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.isTeacher) return (window.location.href = '/TEACHER/login/login.html');

      const nameSlot = document.querySelector('.username');
      if (nameSlot) nameSlot.textContent = user.username || '';

      await loadSidebar();
      await loadRoster();

      // Search filter
      document.getElementById('tableSearch').addEventListener('input', e => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#rosterBody tr').forEach(tr => {
          tr.style.display = tr.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
      });
    });

    // Sidebar
    async function loadSidebar() {
      try {
        const res = await fetch('/components/sidebar.html');
        const html = await res.text();
        document.getElementById('sidebar-container').innerHTML = html;

        const sidebar = document.querySelector('.sidebar');
        const dashboard = document.querySelector('.dashboard');
        if (sidebar && dashboard) {
          sidebar.addEventListener('mouseenter', () => dashboard.classList.add('sidebar-expanded'));
          sidebar.addEventListener('mouseleave', () => dashboard.classList.remove('sidebar-expanded'));
        }

        document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
          toggle.addEventListener('click', e => {
            e.preventDefault();
            const parent = toggle.closest('.has-submenu');
            parent.classList.toggle('open');
            toggle.setAttribute('aria-expanded', parent.classList.contains('open'));
          });
        });
      } catch (err) {
        console.error('Failed to load sidebar:', err);
      }
    }

    function logoutUser() {
      localStorage.removeItem('user');
      window.location.href = '/TEACHER/login/login.html';
    }
  </script>
</body>

</html>