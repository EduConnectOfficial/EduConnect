<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Class Roster</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Global (keep your base) -->
  <link rel="stylesheet" href="../Classes/roster.css" />

</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
       <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" id="searchStudent" class="form-control" placeholder="Search students in roster..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <section class="content">
        <div class="ui-card section mb-3 d-flex flex-wrap justify-content-between align-items-center">
          <h1 class="page-title brand mb-2 mb-md-0">Class Roster: <span id="classNameSpan">Loading…</span></h1>
          <div class="d-flex flex-wrap actions-wrap">
            <button class="btn btn-amber" data-bs-toggle="modal" data-bs-target="#enrollStudentModal">
              <i class="bi bi-person-plus-fill me-1"></i> Enroll Student
            </button>
            <button class="btn btn-amber-outline" data-bs-toggle="modal" data-bs-target="#bulkEnrollModal">
              <i class="bi bi-upload me-1"></i> Bulk Enroll
            </button>
            <button id="bulkRemoveBtn" class="btn btn-outline-danger" disabled>
              <i class="bi bi-trash3 me-1"></i> Remove Selected
            </button>
          </div>
        </div>

        <div class="meta-card p-3 mb-4">
          <div class="meta-strip">
            <div class="meta-item">
              <div class="label">Grade Level</div>
              <div class="value" id="metaGrade">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Section</div>
              <div class="value" id="metaSection">—</div>
            </div>
            <div class="meta-item">
              <div class="label">School Year</div>
              <div class="value" id="metaSY">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Semester</div>
              <div class="value" id="metaSem">—</div>
            </div>
            <div class="meta-item">
              <div class="label">Students</div>
              <div class="value" id="metaCount">0</div>
            </div>
          </div>
        </div>


        <div class="ui-card p-2">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0" id="rosterTable">
              <thead>
                <tr>
                  <th style="width:38px;"><input type="checkbox" id="selectAll" class="form-check-input" /></th>
                  <th>Name</th>
                  <th>Student ID</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="rosterBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Enroll Student Modal -->
  <div class="modal fade" id="enrollStudentModal" tabindex="-1" aria-labelledby="enrollStudentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="enrollStudentForm">
          <div class="modal-header">
            <h5 class="modal-title" id="enrollStudentModalLabel">Enroll Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="studentQueryInput" class="form-label">Search student</label>
              <input type="text" class="form-control" id="studentQueryInput"
                placeholder="Type Student ID (e.g., S-2025-00001) or first/last name" required>
              <div class="form-text">Search is case-insensitive and matches by ID or name.</div>
            </div>

            <div id="studentLookupState" class="small mb-2" style="min-height:1.25rem;"></div>

            <div id="studentInfoCard" class="d-none">
              <div id="searchResults" class="d-grid gap-2"></div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-amber-outline" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-amber">Enroll Selected</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bulk Enroll Modal -->
  <div class="modal fade" id="bulkEnrollModal" tabindex="-1" aria-labelledby="bulkEnrollModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bulkEnrollForm">
          <div class="modal-header">
            <h5 class="modal-title" id="bulkEnrollModalLabel">Bulk Enroll Students (Excel/CSV)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <p class="mb-2">
              Upload an <strong>.xlsx</strong> or <strong>.csv</strong> file with a header column named
              <code>studentId</code>. Each row should have a student’s ID (e.g., <code>S-2025-00001</code>).
            </p>
            <div class="d-flex gap-2 mb-3">
              <button type="button" id="downloadTemplateBtn" class="btn btn-amber-outline btn-sm">
                <i class="bi bi-file-earmark-arrow-down"></i> Download CSV template
              </button>
            </div>

            <div class="mb-3">
              <label for="bulkFile" class="form-label">Select file</label>
              <input type="file" class="form-control" id="bulkFile" accept=".xlsx,.csv" required>
            </div>

            <div id="bulkStatus" class="small text-muted" style="min-height:1.25rem;"></div>
            <div id="bulkResult" class="mt-2 d-none"></div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-amber-outline" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-amber">
              <i class="bi bi-cloud-upload me-1"></i> Upload & Enroll
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:5000'; // match the rest of your app
    let classId;
    let _lookupTimer = null;
    let _selectedStudentId = null;

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", "&#39;");
    }

    // Sidebar
    async function loadSidebar() {
      try {
        const res = await fetch('/components/sidebar.html');
        const html = await res.text();
        document.getElementById('sidebar-container').innerHTML = html;

        const sidebar = document.querySelector('.sidebar');
        const dashboard = document.querySelector('.dashboard');
        if (sidebar && dashboard) {
          sidebar.addEventListener('mouseenter', () => dashboard.classList.add('sidebar-expanded'));
          sidebar.addEventListener('mouseleave', () => dashboard.classList.remove('sidebar-expanded'));
        }

        document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
          toggle.addEventListener('click', e => {
            e.preventDefault();
            const parent = toggle.closest('.has-submenu');
            parent.classList.toggle('open');
            toggle.setAttribute('aria-expanded', parent.classList.contains('open'));
          });
        });
      } catch (err) {
        console.error('Failed to load sidebar:', err);
      }
    }

    async function safeJson(res) {
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) { try { return await res.json(); } catch { } }
      return null;
    }

    // Load class + roster
    async function loadRoster() {
      try {
        const classRes = await fetch(`${API_BASE}/api/classes/${classId}`);
        const classPayload = await safeJson(classRes) || {};
        const cls = classPayload.class || {};
        const name = cls.name || `ID: ${classId}`;
        const classNameSpan = document.getElementById('classNameSpan');
        if (classNameSpan) classNameSpan.textContent = name;
        document.title = `Class Roster: ${name}`;
        document.getElementById('metaGrade').textContent = cls.gradeLevel || '—';
        document.getElementById('metaSection').textContent = cls.section || '—';
        document.getElementById('metaSY').textContent = cls.schoolYear || '—';
        document.getElementById('metaSem').textContent = cls.semester || '—';

        const res = await fetch(`${API_BASE}/api/classes/${classId}/students`);
        const data = await safeJson(res) || {};
        const students = Array.isArray(data.students) ? data.students : [];
        const tbody = document.getElementById('rosterBody');
        tbody.innerHTML = '';

        students.forEach(s => {
          const tr = document.createElement('tr');
          const fullName = escapeHtml(s.fullName || `${s.firstName || ''} ${s.lastName || ''}`.trim());
          const sid = escapeHtml(s.studentId || '');
          const email = escapeHtml(s.email || '');
          const emailCell = email ? `<a href="mailto:${email}">${email}</a>` : '—';
          const statusCell = s.active
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-warning text-dark">Inactive</span>';

          tr.innerHTML = `
            <td><input type="checkbox" class="row-select form-check-input" data-student-id="${sid}"></td>
            <td>${fullName || '—'}</td>
            <td>${sid || '—'}</td>
            <td>${emailCell}</td>
            <td>${statusCell}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger remove-btn" data-student-id="${sid}">Remove</button>
            </td>`;
          tbody.appendChild(tr);
        });

        wireSelectionControls();
        document.getElementById('metaCount').textContent = String(students.length);
      } catch (err) {
        console.error('Error loading roster:', err);
      }
    }

    // Remove single
    document.getElementById('rosterBody').addEventListener('click', (e) => {
      const btn = e.target.closest('.remove-btn');
      if (!btn) return;
      const sid = btn.dataset.studentId;
      removeStudent(sid);
    });

    async function removeStudent(studentId) {
      if (!studentId) return;
      if (!confirm('Remove this student from the class?')) return;
      try {
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students/${encodeURIComponent(studentId)}`, { method: 'DELETE' });
        const out = await safeJson(res) || {};
        if (!res.ok || out.success === false) return alert(out.message || 'Failed to remove student.');
        await loadRoster();
      } catch (err) {
        console.error('Error removing student:', err);
        alert('Network error removing student.');
      }
    }

    // Bulk selection
    function wireSelectionControls() {
      const selectAll = document.getElementById('selectAll');
      const rowChecks = Array.from(document.querySelectorAll('.row-select'));
      const bulkBtn = document.getElementById('bulkRemoveBtn');

      const refreshBulkBtn = () => {
        const anyChecked = rowChecks.some(cb => cb.checked);
        bulkBtn.disabled = !anyChecked;
      };

      selectAll.checked = false;
      selectAll.onchange = () => {
        rowChecks.forEach(cb => cb.checked = selectAll.checked);
        refreshBulkBtn();
      };
      rowChecks.forEach(cb => {
        cb.onchange = () => {
          if (!cb.checked) selectAll.checked = false;
          if (rowChecks.every(x => x.checked)) selectAll.checked = true;
          refreshBulkBtn();
        };
      });

      bulkBtn.onclick = async () => {
        const ids = rowChecks.filter(cb => cb.checked).map(cb => cb.dataset.studentId);
        if (!ids.length) return;
        if (!confirm(`Remove ${ids.length} selected student(s) from the class?`)) return;

        let ok = 0, fail = 0;
        for (const sid of ids) {
          try {
            const res = await fetch(`${API_BASE}/api/classes/${classId}/students/${encodeURIComponent(sid)}`, { method: 'DELETE' });
            const out = await safeJson(res) || {};
            if (res.ok && out.success) ok++; else fail++;
          } catch { fail++; }
        }
        alert(`Bulk remove done.\nRemoved: ${ok}\nFailed: ${fail}`);
        await loadRoster();
      };

      bulkBtn.disabled = true;
    }

    // Search & enroll
    const studentQueryInput = () => document.getElementById('studentQueryInput');
    const studentInfoCard = () => document.getElementById('studentInfoCard');
    const lookupStateEl = () => document.getElementById('studentLookupState');
    const searchResults = () => document.getElementById('searchResults');

    function clearSearchUI() {
      _selectedStudentId = null;
      searchResults().innerHTML = '';
      studentInfoCard().classList.add('d-none');
    }

    async function searchStudents(q) {
      if (!q) { clearSearchUI(); lookupStateEl().textContent = ''; return; }
      lookupStateEl().textContent = 'Searching…';
      try {
        const res = await fetch(`${API_BASE}/api/students/search?query=${encodeURIComponent(q)}`);
        const data = await safeJson(res) || {};
        if (data.success && Array.isArray(data.students) && data.students.length) {
          searchResults().innerHTML = data.students.map(stu => {
            const id = escapeHtml(stu.studentId || '');
            const fn = escapeHtml(stu.firstName || '');
            const ln = escapeHtml(stu.lastName || '');
            const em = escapeHtml(stu.email || '');
            return `
              <label class="search-result d-flex align-items-center gap-2">
                <input type="radio" name="studentPick" value="${id}">
                <div>
                  <div><strong>${(fn + ' ' + ln).trim()}</strong></div>
                  <div class="text-muted small">ID: ${id}${em ? ' • ' + em : ''}</div>
                </div>
              </label>`;
          }).join('');
          studentInfoCard().classList.remove('d-none');
          lookupStateEl().textContent = '';
        } else {
          clearSearchUI();
          lookupStateEl().textContent = 'No matching student found.';
        }
      } catch (e) {
        console.error('Search error:', e);
        clearSearchUI();
        lookupStateEl().textContent = 'Error while searching.';
      }
    }

    document.getElementById('studentQueryInput').addEventListener('input', () => {
      clearTimeout(_lookupTimer);
      const val = studentQueryInput().value.trim();
      if (!val) { clearSearchUI(); lookupStateEl().textContent = ''; return; }
      if (val.length < 2) { clearSearchUI(); lookupStateEl().textContent = 'Type at least 2 characters…'; return; }
      _lookupTimer = setTimeout(() => searchStudents(val), 300);
    });

    document.getElementById('studentInfoCard').addEventListener('change', (e) => {
      if (e.target.name === 'studentPick') _selectedStudentId = e.target.value;
    });

    document.getElementById('enrollStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!_selectedStudentId) return alert('Please pick a student from the results.');
      try {
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId: _selectedStudentId })
        });
        const out = await safeJson(res) || {};
        if (!res.ok || !out.success) return alert(out.message || 'Failed to enroll student.');
        e.target.reset(); clearSearchUI(); lookupStateEl().textContent = '';
        const modal = bootstrap.Modal.getInstance(document.getElementById('enrollStudentModal'));
        modal && modal.hide();
        await loadRoster();
      } catch (err) {
        console.error('Enroll error:', err);
        alert('Error enrolling student.');
      }
    });

    // Bulk enroll
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', () => {
      const csv = 'studentId\nS-2025-00001\nS-2025-00002\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'bulk_enroll_template.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    document.getElementById('bulkEnrollForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('bulkFile');
      const statusEl = document.getElementById('bulkStatus');
      const resultEl = document.getElementById('bulkResult');
      if (!fileInput.files || !fileInput.files[0]) return alert('Please select a file.');

      statusEl.textContent = 'Uploading and processing…';
      resultEl.classList.add('d-none'); resultEl.innerHTML = '';

      try {
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        const res = await fetch(`${API_BASE}/api/classes/${classId}/students/bulk`, { method: 'POST', body: fd });

        const out = await safeJson(res);
        if (res.ok && out) {
          const r = out.report || {};
          statusEl.textContent = 'Done.';
          resultEl.classList.remove('d-none');
          resultEl.innerHTML = `
            <div class="alert alert-info mb-0">
              <div><strong>Total rows:</strong> ${r.total ?? 0}</div>
              <div><strong>Enrolled:</strong> ${r.enrolled ?? 0}</div>
              <div><strong>Already enrolled:</strong> ${r.alreadyEnrolled ?? 0}</div>
              <div><strong>Not found:</strong> ${r.notFound ?? 0}</div>
              <div><strong>Errors:</strong> ${r.errors ?? 0}</div>
            </div>`;
          await loadRoster();
          return;
        }

        statusEl.textContent = '';
        alert(out?.message || `Bulk enroll failed (HTTP ${res.status}).`);
      } catch (err) {
        statusEl.textContent = '';
        console.error('Bulk upload error:', err);
        alert('Bulk upload successfully!');
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      classId = params.get('classId');

      if (!classId) {
        alert('Missing classId in URL. Redirecting to class list.');
        return window.location.href = '/TEACHER/Classes/class_list.html';
      }

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.isTeacher) return (window.location.href = '/TEACHER/login/login.html');

      const nameSlot = document.querySelector('.username');
      if (nameSlot) nameSlot.textContent = user.username || '';

      await loadSidebar();
      await loadRoster();

      document.getElementById('searchStudent').addEventListener('input', e => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#rosterBody tr').forEach(tr => {
          tr.style.display = tr.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
      });
    });

    function logoutUser() {
      localStorage.removeItem('user');
      window.location.href = '/TEACHER/login/login.html';
    }
  </script>
</body>

</html>