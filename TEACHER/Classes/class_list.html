<!-- class_list.html -->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Class List</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Your page/theme css -->
  <link rel="stylesheet" href="class_list.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="tableSearch" type="text" class="form-control" placeholder="Search classes..." />
          <i class="fas fa-search position-absolute" style="top:50%; right:15px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Page Content -->
      <section class="content">
        <h1 class="page-title">My Classes</h1>

        <!-- Controls -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-people"></i> Your Classes</h2>
            <div class="ui-subtext">Everything shows up right away. Use filters only if you want to narrow it down.
            </div>
          </div>

          <div class="row g-2 align-items-end">
            <!-- School Year filter -->
            <div class="col-12 col-md-4 col-xl-4">
              <label class="form-label">School Year</label>
              <select id="syFilter" class="form-select" aria-label="Filter by school year">
                <option value="">All years</option>
              </select>
            </div>

            <!-- Sort -->
            <div class="col-12 col-md-3 col-xl-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort classes">
                <option value="sy_new" selected>School Year (newest → oldest)</option>
                <option value="sy_old">School Year (oldest → newest)</option>
                <option value="sem_1_2">Semester (1st → 2nd)</option>
                <option value="sem_2_1">Semester (2nd → 1st)</option>
              </select>
            </div>

            <!-- 3-button visibility filter -->
            <div class="col-12 col-md-5 col-xl-3">
              <label class="form-label">Show</label>
              <div class="segmented" role="tablist" aria-label="Class visibility">
                <button id="btnActive" class="seg-btn is-active" role="tab" aria-selected="true">Active</button>
                <button id="btnArchived" class="seg-btn is-archived" role="tab" aria-selected="false">Archived</button>
                <button id="btnAll" class="seg-btn is-all" role="tab" aria-selected="false">All</button>
              </div>
            </div>

            <!-- Create Class -->
            <div class="col-12 col-xl-2 d-flex justify-content-xl-end">
              <button class="btn btn-amber w-100 w-xl-auto mt-2 mt-xl-0" data-bs-toggle="modal"
                data-bs-target="#createClassModal">
                <i class="bi bi-plus-lg me-1"></i> Add Class
              </button>
            </div>
          </div>
        </div>

        <!-- Count pills -->
        <div class="mb-2 d-flex flex-wrap gap-2">
          <span id="activeCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-check-circle me-1"></i>
            <span id="activeCount">0</span> Active
          </span>
          <span id="archivedCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-archive me-1"></i>
            <span id="archivedCount">0</span> Archived
          </span>
        </div>

        <div class="ui-card p-2">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0" id="classListTable">
              <thead>
                <tr>
                  <th>Class Name</th>
                  <th>Grade Level</th>
                  <th>Section</th>
                  <th>School Year</th>
                  <th>Semester</th>
                  <th>Students</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="classListBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Create Class Modal -->
  <div class="modal fade" id="createClassModal" tabindex="-1" aria-labelledby="createClassModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="createClassForm">
          <div class="modal-header">
            <h5 class="modal-title" id="createClassModalLabel">Create New Class</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="classNameInput" class="form-label">Class Name</label>
              <input type="text" class="form-control" id="classNameInput" placeholder="e.g. STEM-11A" required>
            </div>

            <div class="mb-3">
              <label for="gradeLevelInput" class="form-label">Grade Level</label>
              <select class="form-select" id="gradeLevelInput" required>
                <option value="">Select grade</option>
                <option>11</option>
                <option>12</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="sectionInput" class="form-label">Section</label>
              <input type="text" class="form-control" id="sectionInput" placeholder="e.g. A" required>
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="schoolYearInput" class="form-label">School Year</label>
                <select id="schoolYearInput" class="form-select" required></select>
              </div>
              <div class="col-12 col-md-6">
                <label for="semesterInput" class="form-label">Semester</label>
                <select id="semesterInput" class="form-select" required>
                  <option value="">Select semester</option>
                  <option value="1st Semester">1st Semester</option>
                  <option value="2nd Semester">2nd Semester</option>
                </select>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-upload-footer ">Create Class</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Class Modal -->
  <div class="modal fade" id="editClassModal" tabindex="-1" aria-labelledby="editClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editClassForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editClassModalLabel">Edit Class</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="editClassId">

            <div class="mb-3">
              <label for="editClassNameInput" class="form-label">Class Name</label>
              <input type="text" class="form-control" id="editClassNameInput" placeholder="e.g. STEM-11A" required>
            </div>

            <div class="mb-3">
              <label for="editGradeLevelInput" class="form-label">Grade Level</label>
              <select class="form-select" id="editGradeLevelInput" required>
                <option value="">Select grade</option>
                <option>11</option>
                <option>12</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="editSectionInput" class="form-label">Section</label>
              <input type="text" class="form-control" id="editSectionInput" placeholder="e.g. A" required>
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="editSchoolYearInput" class="form-label">School Year</label>
                <select id="editSchoolYearInput" class="form-select" required></select>
              </div>
              <div class="col-12 col-md-6">
                <label for="editSemesterInput" class="form-label">Semester</label>
                <select id="editSemesterInput" class="form-select" required>
                  <option value="">Select semester</option>
                  <option value="1st Semester">1st Semester</option>
                  <option value="2nd Semester">2nd Semester</option>
                </select>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-upload-footer">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Generic INFO Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="infoModalBody">—</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="infoModalOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content confirm-no-copy">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cancel"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer btn btn-secondary" data-bs-dismiss="modal"
            id="confirmCancelBtn">Cancel</button>
          <button type="button" class="btn btn-upload-footer" id="confirmOkBtn">Yes, continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---- Auth guard + header initials (robust) ----
    (function initHeaderInitials() {
      try {
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;

        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return;
        }
        window.currentUser = u;

        const initials = getInitials(u);

        window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("Username");
          if (!el) return;
          el.textContent = initials;
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username
            || u.email
            || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        });
      } catch (e) {
        console.error('initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
      }

      function getInitials(u) {
        const fn = (u.firstName || '').trim();
        const ln = (u.lastName || '').trim();

        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ').split(/[\s._-]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }
        const em = (u.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();
  </script>

  <script>
    const API_BASE = 'http://localhost:5000';

    /* ================= Modal Helpers ================= */
    const infoModalEl = document.getElementById('infoModal');
    const infoModal = new bootstrap.Modal(infoModalEl);
    const infoTitleEl = document.getElementById('infoModalLabel');
    const infoBodyEl = document.getElementById('infoModalBody');

    function showInfo(title = 'Notice', html = '') {
      infoTitleEl.textContent = title;
      infoBodyEl.innerHTML = html;
      infoModal.show();
    }

    const confirmModalEl = document.getElementById('confirmModal');
    const confirmModal = new bootstrap.Modal(confirmModalEl);
    const confirmTitleEl = document.getElementById('confirmModalLabel');
    const confirmBodyEl = document.getElementById('confirmModalBody');
    const confirmOkBtn = document.getElementById('confirmOkBtn');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');

    // Simple yes/no confirm (kept for other actions)
    function showConfirm(title = 'Confirm Action', html = 'Are you sure?') {
      confirmTitleEl.textContent = title;
      confirmBodyEl.innerHTML = html;
      confirmOkBtn.textContent = 'Yes, continue';
      confirmOkBtn.disabled = false;
      return new Promise((resolve) => {
        const onOk = () => { cleanup(); confirmModal.hide(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };
        function cleanup() {
          confirmOkBtn.removeEventListener('click', onOk);
          confirmCancelBtn.removeEventListener('click', onCancel);
          confirmModalEl.removeEventListener('hidden.bs.modal', onCancel);
        }
        confirmOkBtn.addEventListener('click', onOk, { once: true });
        confirmCancelBtn.addEventListener('click', onCancel, { once: true });
        confirmModalEl.addEventListener('hidden.bs.modal', onCancel, { once: true });
        confirmModal.show();
      });
    }

    // Type-to-confirm (Class Name + Section) — uses Bootstrap validation visibility
    async function showTypeToConfirm_ClassAndSection(title, expectedText) {
      confirmTitleEl.textContent = title;

      // No d-block and no inline display styles on feedback elements
      confirmBodyEl.innerHTML = `
    <div class="mb-2">
      Confirm you want to delete this class and all of its subcollections by typing:
      <strong>Class Name + Section</strong> (case-sensitive).
    </div>
    <div class="alert alert-danger py-2 small mb-2 confirm-no-copy" title="Copy disabled in this area">
      Type exactly: <code>${expectedText}</code>
    </div>
    <input type="text" class="form-control" id="typeToConfirmInput"
           placeholder="Type Class Name + Section here" autocomplete="off" />
    <div class="invalid-feedback" id="typeToConfirmError">
      Input does not match. Please type <strong>${expectedText}</strong> to proceed.
    </div>
    <div class="valid-feedback" id="typeToConfirmOk">
      ✓ Input matches
    </div>
  `;

      confirmOkBtn.textContent = 'Delete';
      confirmOkBtn.disabled = true; // only enabled on exact match

      // Block copying inside the modal body
      const blockCopy = (e) => e.preventDefault();
      confirmModalEl.addEventListener('copy', blockCopy);
      confirmModalEl.addEventListener('cut', blockCopy);
      confirmModalEl.addEventListener('contextmenu', blockCopy);

      return new Promise((resolve) => {
        const input = document.getElementById('typeToConfirmInput');

        // Live validator: toggle Bootstrap classes; feedback visibility follows automatically
        const onInput = () => {
          const match = (input.value.trim() === expectedText);
          input.classList.toggle('is-valid', match);
          input.classList.toggle('is-invalid', !match);
          confirmOkBtn.disabled = !match;
        };

        // OK / Cancel handlers
        const onOk = () => {
          if (!confirmOkBtn.disabled) {
            cleanup();
            confirmModal.hide();
            resolve(true);
          }
        };
        const onCancel = () => { cleanup(); resolve(false); };

        function cleanup() {
          confirmOkBtn.removeEventListener('click', onOk);
          confirmCancelBtn.removeEventListener('click', onCancel);
          confirmModalEl.removeEventListener('hidden.bs.modal', onCancel);
          input.removeEventListener('input', onInput);
          confirmModalEl.removeEventListener('copy', blockCopy);
          confirmModalEl.removeEventListener('cut', blockCopy);
          confirmModalEl.removeEventListener('contextmenu', blockCopy);
          confirmOkBtn.disabled = false;
          confirmOkBtn.textContent = 'Yes, continue';
        }

        confirmOkBtn.addEventListener('click', onOk);
        confirmCancelBtn.addEventListener('click', onCancel);
        confirmModalEl.addEventListener('hidden.bs.modal', onCancel, { once: true });
        input.addEventListener('input', onInput);

        confirmModal.show();
        setTimeout(() => {
          input.focus();
          onInput(); // initialize state (will mark invalid + keep Delete disabled)
        }, 150);
      });
    }

    /* ================= Helpers ================= */
    function currentSchoolYearRange(offsetYears = 0) {
      const now = new Date();
      const y = now.getFullYear() + offsetYears;
      const m = now.getMonth();
      if (m >= 7) return [y, y + 1];
      return [y - 1, y];
    }
    function getDefaultSchoolYear() {
      const [a, b] = currentSchoolYearRange();
      return `${a}-${b}`;
    }
    function getDefaultSemester() {
      const m = new Date().getMonth();
      if (m >= 7 && m <= 11) return '1st Semester';
      if (m >= 0 && m <= 4) return '2nd Semester';
      return '1st Semester';
    }
    function buildSchoolYearOptions(selectEl, years) {
      const unique = Array.from(new Set(years.filter(Boolean)));
      unique.sort((a, b) => parseInt(b) - parseInt(a));
      selectEl.innerHTML = '<option value="">All years</option>' +
        unique.map(sy => `<option value="${sy}">${sy}</option>`).join('');
    }
    function syStart(sy) {
      if (!sy) return NaN;
      const n = parseInt(String(sy).split('-')[0], 10);
      return isNaN(n) ? NaN : n;
    }
    function semesterRank(s) {
      if (s === '1st Semester') return 1;
      if (s === '2nd Semester') return 2;
      return 99;
    }

    /* ================= State ================= */
    let classesData = [];
    let statusFilter = 'active';
    let currentSY = '';
    let currentSort = 'sy_new';

    /* ================= Sidebar loader ================= */
    async function loadSidebar() {
      try {
        const res = await fetch('/components/sidebar.html');
        const html = await res.text();
        document.getElementById('sidebar-container').innerHTML = html;

        const sidebar = document.querySelector('.sidebar');
        const dashboard = document.querySelector('.dashboard');
        if (sidebar && dashboard) {
          sidebar.addEventListener('mouseenter', () => dashboard.classList.add('sidebar-expanded'));
          sidebar.addEventListener('mouseleave', () => dashboard.classList.remove('sidebar-expanded'));
        }

        document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
          toggle.addEventListener('click', e => {
            e.preventDefault();
            const parent = toggle.closest('.has-submenu');
            parent.classList.toggle('open');
            toggle.setAttribute('aria-expanded', parent.classList.contains('open'));
          });
        });
      } catch (err) {
        console.error('Failed to load sidebar:', err);
      }
    }

    /* ================= Pills refresher ================= */
    async function refreshClassPills(teacherId) {
      try {
        const url = `${API_BASE}/api/classes?teacherId=${encodeURIComponent(teacherId)}&archived=include`;
        const res = await fetch(url);
        const data = await res.json();
        const classes = Array.isArray(data.classes) ? data.classes : [];

        const activeCount = classes.filter(c => !c.archived).length;
        const archivedCount = classes.filter(c => c.archived).length;

        document.getElementById('activeCount').textContent = String(activeCount);
        document.getElementById('archivedCount').textContent = String(archivedCount);
      } catch (err) {
        console.error('refreshClassPills failed:', err);
        document.getElementById('activeCount').textContent = '0';
        document.getElementById('archivedCount').textContent = '0';
      }
    }

    /* ================= API load ================= */
    async function loadClasses(teacherId) {
      try {
        const archivedParam =
          statusFilter === 'archived' ? 'only' :
            statusFilter === 'all' ? 'include' : 'exclude';

        const url = `${API_BASE}/api/classes?teacherId=${encodeURIComponent(teacherId)}&archived=${archivedParam}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.success && Array.isArray(data.classes)) {
          classesData = data.classes.slice();
          const years = classesData.map(c => c.schoolYear || '').filter(Boolean);
          buildSchoolYearOptions(document.getElementById('syFilter'), years);
          applyAndRender();
          await refreshClassPills(teacherId);
        } else {
          showInfo('Load Error', data.message || 'Failed to load classes.');
        }
      } catch (err) {
        console.error('Error loading classes:', err);
        showInfo('Network Error', 'There was a problem loading classes. Please try again.');
      }
    }

    /* ================= Filtering / Sorting / Rendering ================= */
    function applyAndRender() {
      const q = (document.getElementById('tableSearch').value || '').toLowerCase().trim();
      let list = classesData.slice();

      if (currentSY) list = list.filter(c => (c.schoolYear || '') === currentSY);

      if (q) {
        list = list.filter(c => {
          const txt = `${c.name || ''} ${c.gradeLevel || ''} ${c.section || ''} ${c.schoolYear || ''} ${c.semester || ''}`.toLowerCase();
          return txt.includes(q);
        });
      }

      if (currentSort === 'sy_new') {
        list.sort((a, b) => (syStart(b.schoolYear) || -Infinity) - (syStart(a.schoolYear) || -Infinity));
      } else if (currentSort === 'sy_old') {
        list.sort((a, b) => (syStart(a.schoolYear) || Infinity) - (syStart(b.schoolYear) || Infinity));
      } else if (currentSort === 'sem_1_2') {
        list.sort((a, b) => semesterRank(a.semester) - semesterRank(b.semester));
      } else if (currentSort === 'sem_2_1') {
        list.sort((a, b) => semesterRank(b.semester) - semesterRank(a.semester));
      }

      renderTable(list);
    }

    function renderTable(rows) {
      const tbody = document.getElementById('classListBody');
      tbody.innerHTML = '';
      if (!rows.length) return;
      rows.forEach(c => appendRow(c));
    }

    /* ================= Row builder (with actions) ================= */
    function appendRow(c) {
      const tbody = document.getElementById('classListBody');
      const tr = document.createElement('tr');
      tr.dataset.id = c.id;

      if (c.archived) {
        tr.classList.add('table-secondary');
        tr.style.opacity = '0.75';
      }

      tr.innerHTML = `
        <td>${c.name}</td>
        <td>${c.gradeLevel}</td>
        <td>${c.section}</td>
        <td>${c.schoolYear || ''}</td>
        <td>${c.semester || ''}</td>
        <td>${(typeof c.students === 'number' ? c.students : (c.studentsCount || 0))}</td>
        <td class="text-center">
          <div class="btn-group">
            <button class="btn btn-sm btn-amber roster-btn"><i class="bi bi-people me-1"></i>Roster</button>
            <button class="btn btn-sm btn-outline-secondary manage-btn" ${c.archived ? 'disabled' : ''}><i class="bi bi-tools me-1"></i>Manage</button>
            ${c.archived
          ? '<button class="btn btn-sm btn-outline-success unarchive-btn"><i class="bi bi-arrow-counterclockwise me-1"></i>Unarchive</button>'
          : '<button class="btn btn-sm btn-outline-warning archive-btn"><i class="bi bi-archive me-1"></i>Archive</button>'}
            <button class="btn btn-sm btn-outline-danger delete-btn"><i class="bi bi-trash3 me-1"></i>Delete</button>
          </div>
        </td>`;

      tbody.appendChild(tr);

      // Manage
      tr.querySelector('.manage-btn').addEventListener('click', () => {
        if (c.archived) return;
        document.getElementById('editClassId').value = c.id;
        document.getElementById('editClassNameInput').value = c.name;
        document.getElementById('editGradeLevelInput').value = c.gradeLevel;
        document.getElementById('editSectionInput').value = c.section;

        const sySel = document.getElementById('editSchoolYearInput');
        const around = [];
        for (let i = -3; i <= 3; i++) {
          const [a, b] = currentSchoolYearRange(i);
          around.push(`${a}-${b}`);
        }
        buildSchoolYearOptions(sySel, around);
        sySel.value = c.schoolYear || getDefaultSchoolYear();

        const semSel = document.getElementById('editSemesterInput');
        semSel.value = c.semester || getDefaultSemester();

        new bootstrap.Modal(document.getElementById('editClassModal')).show();
      });

      // Roster
      tr.querySelector('.roster-btn').addEventListener('click', () => {
        window.location.href = `/TEACHER/Classes/roster.html?classId=${encodeURIComponent(c.id)}`;
      });

      // Archive
      const archBtn = tr.querySelector('.archive-btn');
      if (archBtn) {
        archBtn.addEventListener('click', async () => {
          const ok = await showConfirm('Archive Class', `Archive class "<strong>${c.name}</strong>"? You can unarchive later.`);
          if (!ok) return;
          try {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(c.id)}/archive`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ by: user.userId })
            });
            const out = await res.json();
            if (res.ok && out.success) {
              await loadClasses(user.userId);
              showInfo('Archived', `Class "<strong>${c.name}</strong>" has been archived.`);
            } else {
              showInfo('Archive Failed', out.message || 'Failed to archive.');
            }
          } catch (e) {
            showInfo('Network Error', 'Failed to archive due to a network problem.');
          }
        });
      }

      // Unarchive
      const unarchBtn = tr.querySelector('.unarchive-btn');
      if (unarchBtn) {
        unarchBtn.addEventListener('click', async () => {
          try {
            const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(c.id)}/unarchive`, { method: 'PATCH' });
            const out = await res.json();
            if (res.ok && out.success) {
              const user = JSON.parse(localStorage.getItem('user') || '{}');
              await loadClasses(user.userId);
              showInfo('Unarchived', `Class "<strong>${c.name}</strong>" is active again.`);
            } else {
              showInfo('Unarchive Failed', out.message || 'Failed to unarchive.');
            }
          } catch (e) {
            showInfo('Network Error', 'Failed to unarchive due to a network problem.');
          }
        });
      }

      // Delete — requires typing "Class Name + Section" exactly
      tr.querySelector('.delete-btn').addEventListener('click', async () => {
        const expected = `${c.name} ${c.section}`.trim(); // Class Name + Section
        const typedOk = await showTypeToConfirm_ClassAndSection('Delete Class', expected);
        if (!typedOk) return;

        try {
          const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(c.id)}?cascade=true`, { method: 'DELETE' });
          const out = await res.json();
          if (res.ok && out.success) {
            classesData = classesData.filter(x => x.id !== c.id);
            applyAndRender();
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.userId) refreshClassPills(user.userId);
            showInfo('Deleted', `Class "<strong>${c.name}</strong>" has been deleted.`);
          } else {
            showInfo('Delete Failed', out.message || 'Failed to delete class.');
          }
        } catch (err) {
          showInfo('Network Error', 'Failed to delete class due to a network problem.');
        }
      });
    }

    /* ================= Create / Edit ================= */
    document.getElementById('createClassForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('classNameInput').value.trim();
      const gradeLevel = document.getElementById('gradeLevelInput').value;
      const section = document.getElementById('sectionInput').value.trim();
      const schoolYear = document.getElementById('schoolYearInput').value;
      const semester = document.getElementById('semesterInput').value;

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.userId) return;

      if (!schoolYear || !semester) {
        showInfo('Incomplete', 'Please select <strong>School Year</strong> and <strong>Semester</strong>.');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/classes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, gradeLevel, section, schoolYear, semester, teacherId: user.userId })
        });
        const result = await res.json();
        if (res.ok && result.success && result.class) {
          classesData.push(result.class);
          applyAndRender();
          e.target.reset();
          bootstrap.Modal.getInstance(document.getElementById('createClassModal')).hide();
          refreshClassPills(user.userId);
          showInfo('Created', `Class "<strong>${result.class.name}</strong>" has been created.`);
        } else {
          showInfo('Create Failed', result.message || 'Failed to create class.');
        }
      } catch (err) {
        console.error('Error creating class:', err);
        showInfo('Network Error', 'There was a problem creating the class. Please try again.');
      }
    });

    document.getElementById('editClassForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('editClassId').value;
      const name = document.getElementById('editClassNameInput').value.trim();
      const gradeLevel = document.getElementById('editGradeLevelInput').value;
      const section = document.getElementById('editSectionInput').value.trim();
      const schoolYear = document.getElementById('editSchoolYearInput').value;
      const semester = document.getElementById('editSemesterInput').value;

      if (!schoolYear || !semester) {
        showInfo('Incomplete', 'Please select <strong>School Year</strong> and <strong>Semester</strong>.');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, gradeLevel, section, schoolYear, semester })
        });
        const result = await res.json();
        if (res.ok && result.success) {
          const idx = classesData.findIndex(c => c.id === id);
          if (idx >= 0) {
            classesData[idx] = { ...classesData[idx], name, gradeLevel, section, schoolYear, semester };
          }
          applyAndRender();
          bootstrap.Modal.getInstance(document.getElementById('editClassModal')).hide();
          showInfo('Updated', `Class "<strong>${name}</strong>" has been updated.`);
        } else {
          showInfo('Update Failed', result.message || 'Error updating class.');
        }
      } catch (err) {
        showInfo('Network Error', 'There was a problem updating the class. Please try again.');
      }
    });

    /* ================= Controls wiring ================= */
    function setSegmentedActive(which) {
      statusFilter = which;
      const btnActive = document.getElementById('btnActive');
      const btnArchived = document.getElementById('btnArchived');
      const btnAll = document.getElementById('btnAll');
      [btnActive, btnArchived, btnAll].forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected', 'false'); });
      if (which === 'active') { btnActive.classList.add('is-active'); btnActive.setAttribute('aria-selected', 'true'); }
      if (which === 'archived') { btnArchived.classList.add('is-active'); btnArchived.setAttribute('aria-selected', 'true'); }
      if (which === 'all') { btnAll.classList.add('is-active'); btnAll.setAttribute('aria-selected', 'true'); }

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.userId) loadClasses(user.userId);
    }
    document.getElementById('btnActive').addEventListener('click', () => setSegmentedActive('active'));
    document.getElementById('btnArchived').addEventListener('click', () => setSegmentedActive('archived'));
    document.getElementById('btnAll').addEventListener('click', () => setSegmentedActive('all'));

    document.getElementById('sortBy').addEventListener('change', (e) => { currentSort = e.target.value; applyAndRender(); });
    document.getElementById('syFilter').addEventListener('change', (e) => { currentSY = e.target.value || ''; applyAndRender(); });

    document.getElementById('tableSearch').addEventListener('input', applyAndRender);

    /* ================= Init ================= */
    document.addEventListener('DOMContentLoaded', async () => {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user?.isTeacher) return window.location.href = '/TEACHER/login/login.html';
      document.getElementById('Username').textContent = user.username || '';

      const createModalEl = document.getElementById('createClassModal');
      createModalEl.addEventListener('show.bs.modal', () => {
        const around = [];
        for (let i = -3; i <= 3; i++) {
          const [a, b] = currentSchoolYearRange(i);
          around.push(`${a}-${b}`);
        }
        const sySel = document.getElementById('schoolYearInput');
        sySel.innerHTML = around
          .filter(Boolean)
          .filter((v, i, arr) => arr.indexOf(v) === i)
          .sort((a, b) => parseInt(b) - parseInt(a))
          .map(sy => `<option value="${sy}">${sy}</option>`).join('');
        sySel.value = getDefaultSchoolYear();

        const semSel = document.getElementById('semesterInput');
        semSel.value = getDefaultSemester();
      });

      await loadSidebar();
      await loadClasses(user.userId);
      await refreshClassPills(user.userId);
    });

    function logoutUser() {
      localStorage.removeItem('user');
      window.location.href = '/TEACHER/login/login.html';
    }
  </script>
</body>

</html>