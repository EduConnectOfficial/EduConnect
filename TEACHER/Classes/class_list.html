<!-- class_list.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Teacher - Class List</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Your page/theme css -->
  <link rel="stylesheet" href="class_list.css"/>

  <!-- Minimal helpers in case ui-card / segmented aren't in class_list.css yet -->
  <style>
    :root{
      --bg:#f6f8fa; --text:#1f2328; --muted:#6a737d; --card:#ffffff; --border:#e5e7eb;
      --brand-dark-1:#4A1A0C; --brand-dark-2:#7A2810;
      --brand-accent-1:#FF6A00; --brand-accent-2:#B03C10;
      --radius:14px;
    }
    html,body{height:100%;background:var(--bg);color:var(--text)}
    .dashboard{display:flex;min-height:100vh}
    .main{margin-left:70px;width:calc(100% - 70px);transition:margin-left .3s,width .3s;display:flex;flex-direction:column}
    .sidebar:hover~.main{margin-left:220px;width:calc(100% - 220px)}
    .header-top{
      background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2));
      color:#fff;border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky;top:0;z-index:10;
    }
    .logo-header{height:44px}
    .search-box{max-width:520px;width:100%;position:relative}
    .search-box input{border:none;border-radius:999px;padding:.6rem .9rem .6rem 1rem}
    .search-box i{position:absolute;right:14px;top:50%;transform:translateY(-50%);color:#d7dadf}
    .profile-btn{display:flex;align-items:center;gap:8px;background:none;border:none;color:#fff;font-size:20px}
    .content{padding:24px}
    .page-title{
      font-weight:800;font-size:1.6rem;margin:4px 0 18px;text-align:center;color:transparent;
      background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2));
      -webkit-background-clip:text;background-clip:text;
    }

    /* ui-card themed */
    .ui-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .ui-card.card-themed{
      border-radius:var(--radius);border:1px solid rgba(0,0,0,.06);
      box-shadow:0 10px 24px rgba(0,0,0,.1);overflow:hidden;
    }
    .ui-card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .ui-card.card-themed .ui-card-head{
      margin:-16px -16px 12px -16px;padding:12px 16px;
      background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2));
      color:#FFD8A9;border-bottom:1px solid rgba(255,255,255,.1)
    }
    .ui-card-title{font-size:1.05rem;font-weight:700;margin:0;display:flex;gap:8px;align-items:center}
    .ui-subtext{font-size:1rem;color:#ffe9ca}

    .btn-amber{
      background:linear-gradient(to bottom,var(--brand-accent-1),var(--brand-accent-2));
      color:#fff;border:none;font-size:1rem;padding:.55rem .9rem
    }
    .btn-amber:hover{filter:brightness(1.05);color:#fff}

    /* Segmented buttons */
    .segmented{display:flex;gap:.5rem;flex-wrap:wrap}
    .segmented .seg-btn{
      min-width:110px;padding:.6rem 1rem;font-weight:700;border-radius:10px;border:2px solid var(--border);
      background:#fff;color:#374151;cursor:pointer;text-align:center;user-select:none;
      box-shadow:0 1px 2px rgba(0,0,0,.03);transition:background .15s,border-color .15s,box-shadow .15s,color .15s;
    }
    .segmented .seg-btn:hover{background:#f9fafb;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .segmented .seg-btn.is-active{background:#5f6b77;color:#fff;border-color:#5f6b77}
    .segmented .seg-btn.is-archived{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .segmented .seg-btn.is-all{background:#eef2ff;color:#1e3a8a;border-color:#c7d2fe}
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box position-relative">
          <input id="tableSearch" type="text" class="form-control" placeholder="Search classes..."/>
          <i class="fas fa-search position-absolute" style="top:50%; right:15px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Page Content -->
      <section class="content">
        <h1 class="page-title">My Classes</h1>

        <!-- Controls -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-people"></i> Your Classes</h2>
            <div class="ui-subtext">Everything shows up right away. Use filters only if you want to narrow it down.</div>
          </div>

          <div class="row g-2 align-items-end">
            <!-- School Year filter -->
            <div class="col-12 col-md-4 col-xl-4">
              <label class="form-label">School Year</label>
              <select id="syFilter" class="form-select" aria-label="Filter by school year">
                <option value="">All years</option>
              </select>
            </div>

            <!-- Sort -->
            <div class="col-12 col-md-3 col-xl-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort classes">
                <option value="sy_new" selected>School Year (newest → oldest)</option>
                <option value="sy_old">School Year (oldest → newest)</option>
                <option value="sem_1_2">Semester (1st → 2nd)</option>
                <option value="sem_2_1">Semester (2nd → 1st)</option>
              </select>
            </div>

            <!-- 3-button visibility filter -->
            <div class="col-12 col-md-5 col-xl-3">
              <label class="form-label">Show</label>
              <div class="segmented" role="tablist" aria-label="Class visibility">
                <button id="btnActive"   class="seg-btn is-active"   role="tab" aria-selected="true">Active</button>
                <button id="btnArchived" class="seg-btn is-archived" role="tab" aria-selected="false">Archived</button>
                <button id="btnAll"      class="seg-btn is-all"      role="tab" aria-selected="false">All</button>
              </div>
            </div>

            <!-- Create Class -->
            <div class="col-12 col-xl-2 d-flex justify-content-xl-end">
              <button class="btn btn-amber w-100 w-xl-auto mt-2 mt-xl-0" data-bs-toggle="modal" data-bs-target="#createClassModal">
                <i class="bi bi-plus-lg me-1"></i> Add Class
              </button>
            </div>
          </div>
        </div>

        <!-- Count pills (ALWAYS show) -->
        <div class="mb-2 d-flex flex-wrap gap-2">
          <span id="activeCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-check-circle me-1"></i>
            <span id="activeCount">0</span> Active
          </span>
          <span id="archivedCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-archive me-1"></i>
            <span id="archivedCount">0</span> Archived
          </span>
        </div>

        <div class="ui-card p-2">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0" id="classListTable">
              <thead>
                <tr>
                  <th>Class Name</th>
                  <th>Grade Level</th>
                  <th>Section</th>
                  <th>School Year</th>
                  <th>Semester</th>
                  <th>Students</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="classListBody">
                <!-- Rows loaded dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Create Class Modal -->
  <div class="modal fade" id="createClassModal" tabindex="-1" aria-labelledby="createClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="createClassForm">
          <div class="modal-header">
            <h5 class="modal-title" id="createClassModalLabel">Create New Class</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="classNameInput" class="form-label">Class Name</label>
              <input type="text" class="form-control" id="classNameInput" placeholder="e.g. STEM-11A" required>
            </div>

            <div class="mb-3">
              <label for="gradeLevelInput" class="form-label">Grade Level</label>
              <select class="form-select" id="gradeLevelInput" required>
                <option value="">Select grade</option>
                <option>11</option>
                <option>12</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="sectionInput" class="form-label">Section</label>
              <input type="text" class="form-control" id="sectionInput" placeholder="e.g. A" required>
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="schoolYearInput" class="form-label">School Year</label>
                <select id="schoolYearInput" class="form-select" required></select>
              </div>
              <div class="col-12 col-md-6">
                <label for="semesterInput" class="form-label">Semester</label>
                <select id="semesterInput" class="form-select" required>
                  <option value="">Select semester</option>
                  <option value="1st Semester">1st Semester</option>
                  <option value="2nd Semester">2nd Semester</option>
                </select>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-amber">Create Class</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Class Modal -->
  <div class="modal fade" id="editClassModal" tabindex="-1" aria-labelledby="editClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editClassForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editClassModalLabel">Edit Class</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="editClassId">

            <div class="mb-3">
              <label for="editClassNameInput" class="form-label">Class Name</label>
              <input type="text" class="form-control" id="editClassNameInput" placeholder="e.g. STEM-11A" required>
            </div>

            <div class="mb-3">
              <label for="editGradeLevelInput" class="form-label">Grade Level</label>
              <select class="form-select" id="editGradeLevelInput" required>
                <option value="">Select grade</option>
                <option>11</option>
                <option>12</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="editSectionInput" class="form-label">Section</label>
              <input type="text" class="form-control" id="editSectionInput" placeholder="e.g. A" required>
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="editSchoolYearInput" class="form-label">School Year</label>
                <select id="editSchoolYearInput" class="form-select" required></select>
              </div>
              <div class="col-12 col-md-6">
                <label for="editSemesterInput" class="form-label">Semester</label>
                <select id="editSemesterInput" class="form-select" required>
                  <option value="">Select semester</option>
                  <option value="1st Semester">1st Semester</option>
                  <option value="2nd Semester">2nd Semester</option>
                </select>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-amber">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = 'http://localhost:5000';

    // ===== Helpers =====
    function currentSchoolYearRange(offsetYears = 0) {
      // PH assumption: SY runs Aug -> next year
      const now = new Date();
      const y = now.getFullYear() + offsetYears;
      const m = now.getMonth(); // 0=Jan ... 7=Aug
      if (m >= 7) return [y, y + 1];
      return [y - 1, y];
    }
    function getDefaultSchoolYear() {
      const [a, b] = currentSchoolYearRange();
      return `${a}-${b}`;
    }
    function getDefaultSemester() {
      const m = new Date().getMonth();
      if (m >= 7 && m <= 11) return '1st Semester';
      if (m >= 0 && m <= 4)  return '2nd Semester';
      return '1st Semester';
    }
    function buildSchoolYearOptions(selectEl, years) {
      const unique = Array.from(new Set(years.filter(Boolean)));
      unique.sort((a,b) => parseInt(b) - parseInt(a)); // sort by starting year desc
      selectEl.innerHTML = '<option value="">All years</option>' +
        unique.map(sy => `<option value="${sy}">${sy}</option>`).join('');
    }

    // Parse "YYYY-YYYY" to first year int
    function syStart(sy) {
      if (!sy) return NaN;
      const n = parseInt(String(sy).split('-')[0], 10);
      return isNaN(n) ? NaN : n;
    }
    function semesterRank(s) {
      if (s === '1st Semester') return 1;
      if (s === '2nd Semester') return 2;
      return 99;
    }

    // ===== State =====
    let classesData = [];        // filtered payload from server (based on statusFilter)
    let statusFilter = 'active'; // 'active' | 'archived' | 'all'
    let currentSY = '';          // '' = all
    let currentSort = 'sy_new';

    // ===== Sidebar loader =====
    async function loadSidebar() {
      try {
        const res = await fetch('/components/sidebar.html');
        const html = await res.text();
        document.getElementById('sidebar-container').innerHTML = html;

        const sidebar = document.querySelector('.sidebar');
        const dashboard = document.querySelector('.dashboard');
        if (sidebar && dashboard) {
          sidebar.addEventListener('mouseenter', () => dashboard.classList.add('sidebar-expanded'));
          sidebar.addEventListener('mouseleave', () => dashboard.classList.remove('sidebar-expanded'));
        }

        document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
          toggle.addEventListener('click', e => {
            e.preventDefault();
            const parent = toggle.closest('.has-submenu');
            parent.classList.toggle('open');
            toggle.setAttribute('aria-expanded', parent.classList.contains('open'));
          });
        });
      } catch (err) {
        console.error('Failed to load sidebar:', err);
      }
    }

    // ===== Pills refresher (ALWAYS uses archived=include) =====
    async function refreshClassPills(teacherId){
      try {
        const url = `${API_BASE}/api/classes?teacherId=${encodeURIComponent(teacherId)}&archived=include`;
        const res = await fetch(url);
        const data = await res.json();
        const classes = Array.isArray(data.classes) ? data.classes : [];

        const activeCount   = classes.filter(c => !c.archived).length;
        const archivedCount = classes.filter(c =>  c.archived).length;

        document.getElementById('activeCount').textContent   = String(activeCount);
        document.getElementById('archivedCount').textContent = String(archivedCount);
      } catch (err) {
        console.error('refreshClassPills failed:', err);
        document.getElementById('activeCount').textContent   = '0';
        document.getElementById('archivedCount').textContent = '0';
      }
    }

    // ===== API load (respects statusFilter -> archived param) =====
    async function loadClasses(teacherId) {
      try {
        const archivedParam =
          statusFilter === 'archived' ? 'only' :
          statusFilter === 'all'      ? 'include' : 'exclude';

        const url = `${API_BASE}/api/classes?teacherId=${encodeURIComponent(teacherId)}&archived=${archivedParam}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.success && Array.isArray(data.classes)) {
          classesData = data.classes.slice();

          // populate School Year filter options (from loaded list)
          const years = classesData.map(c => c.schoolYear || '').filter(Boolean);
          buildSchoolYearOptions(document.getElementById('syFilter'), years);

          applyAndRender();

          // ALWAYS update pills from a full snapshot
          await refreshClassPills(teacherId);
        }
      } catch (err) {
        console.error('Error loading classes:', err);
      }
    }

    // ===== Filtering / Sorting / Rendering =====
    function applyAndRender() {
      const q = (document.getElementById('tableSearch').value || '').toLowerCase().trim();

      // 1) base list (current archived mode already handled server-side)
      let list = classesData.slice();

      // 2) school year filter
      if (currentSY) list = list.filter(c => (c.schoolYear || '') === currentSY);

      // 3) search filter
      if (q) {
        list = list.filter(c => {
          const txt = `${c.name||''} ${c.gradeLevel||''} ${c.section||''} ${c.schoolYear||''} ${c.semester||''}`.toLowerCase();
          return txt.includes(q);
        });
      }

      // 4) sort
      if (currentSort === 'sy_new') {
        list.sort((a,b) => (syStart(b.schoolYear) || -Infinity) - (syStart(a.schoolYear) || -Infinity));
      } else if (currentSort === 'sy_old') {
        list.sort((a,b) => (syStart(a.schoolYear) || Infinity) - (syStart(b.schoolYear) || Infinity));
      } else if (currentSort === 'sem_1_2') {
        list.sort((a,b) => semesterRank(a.semester) - semesterRank(b.semester));
      } else if (currentSort === 'sem_2_1') {
        list.sort((a,b) => semesterRank(b.semester) - semesterRank(a.semester));
      }

      // 5) render rows
      renderTable(list);
    }

    function renderTable(rows) {
      const tbody = document.getElementById('classListBody');
      tbody.innerHTML = '';

      if (!rows.length) {
        return; // empty table; pills are independent now
      }

      rows.forEach(c => appendRow(c));
    }

    // ===== Row builder (with actions) =====
    function appendRow(c) {
      const tbody = document.getElementById('classListBody');
      const tr = document.createElement('tr');
      tr.dataset.id = c.id;

      if (c.archived) {
        tr.classList.add('table-secondary');
        tr.style.opacity = '0.75';
      }

      tr.innerHTML = `
        <td>${c.name}</td>
        <td>${c.gradeLevel}</td>
        <td>${c.section}</td>
        <td>${c.schoolYear || ''}</td>
        <td>${c.semester || ''}</td>
        <td>${(typeof c.students === 'number' ? c.students : (c.studentsCount || 0))}</td>
        <td class="text-center">
          <div class="btn-group">
            <button class="btn btn-sm btn-amber roster-btn"><i class="bi bi-people me-1"></i>Roster</button>
            <button class="btn btn-sm btn-outline-secondary manage-btn" ${c.archived ? 'disabled' : ''}><i class="bi bi-tools me-1"></i>Manage</button>
            ${c.archived
              ? '<button class="btn btn-sm btn-outline-success unarchive-btn"><i class="bi bi-arrow-counterclockwise me-1"></i>Unarchive</button>'
              : '<button class="btn btn-sm btn-outline-warning archive-btn"><i class="bi bi-archive me-1"></i>Archive</button>'}
            <button class="btn btn-sm btn-outline-danger delete-btn"><i class="bi bi-trash3 me-1"></i>Delete</button>
          </div>
        </td>`;

      tbody.appendChild(tr);

      // Manage -> open edit modal (disabled if archived)
      tr.querySelector('.manage-btn').addEventListener('click', () => {
        if (c.archived) return;
        document.getElementById('editClassId').value = c.id;
        document.getElementById('editClassNameInput').value = c.name;
        document.getElementById('editGradeLevelInput').value = c.gradeLevel;
        document.getElementById('editSectionInput').value = c.section;

        const sySel = document.getElementById('editSchoolYearInput');
        // build around current range +/- 3 years
        const around = [];
        for (let i=-3;i<=3;i++){
          const [a,b] = currentSchoolYearRange(i);
          around.push(`${a}-${b}`);
        }
        buildSchoolYearOptions(sySel, around);
        sySel.value = c.schoolYear || getDefaultSchoolYear();

        const semSel = document.getElementById('editSemesterInput');
        semSel.value = c.semester || getDefaultSemester();

        new bootstrap.Modal(document.getElementById('editClassModal')).show();
      });

      // Roster -> redirect
      tr.querySelector('.roster-btn').addEventListener('click', () => {
        window.location.href = `/TEACHER/Classes/roster.html?classId=${encodeURIComponent(c.id)}`;
      });

      // Archive
      const archBtn = tr.querySelector('.archive-btn');
      if (archBtn) {
        archBtn.addEventListener('click', async () => {
          if (!confirm(`Archive class "${c.name}"? You can unarchive later.`)) return;
          try {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(c.id)}/archive`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ by: user.userId })
            });
            const out = await res.json();
            if (res.ok && out.success) {
              await loadClasses(user.userId);
            } else {
              alert(out.message || 'Failed to archive.');
            }
          } catch (e) {
            alert('Failed to archive.');
          }
        });
      }

      // Unarchive
      const unarchBtn = tr.querySelector('.unarchive-btn');
      if (unarchBtn) {
        unarchBtn.addEventListener('click', async () => {
          try {
            const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(c.id)}/unarchive`, { method: 'PATCH' });
            const out = await res.json();
            if (res.ok && out.success) {
              const user = JSON.parse(localStorage.getItem('user') || '{}');
              await loadClasses(user.userId);
            } else {
              alert(out.message || 'Failed to unarchive.');
            }
          } catch (e) {
            alert('Failed to unarchive.');
          }
        });
      }

      // Delete
      tr.querySelector('.delete-btn').addEventListener('click', async () => {
        const confirmMsg = `Delete class "${c.name}"? This cannot be undone.`;
        if (!confirm(confirmMsg)) return;

        try {
          const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(c.id)}?cascade=true`, { method: 'DELETE' });
          const out = await res.json();
          if (res.ok && out.success) {
            // Remove locally and re-render
            classesData = classesData.filter(x => x.id !== c.id);
            applyAndRender();
            // Pills remain correct: they are refreshed on next load or you can force refresh:
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.userId) refreshClassPills(user.userId);
          } else {
            alert(out.message || 'Failed to delete class.');
          }
        } catch (err) {
          alert('Failed to delete class.');
        }
      });
    }

    // ===== Create / Edit =====
    document.getElementById('createClassForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('classNameInput').value.trim();
      const gradeLevel = document.getElementById('gradeLevelInput').value;
      const section = document.getElementById('sectionInput').value.trim();
      const schoolYear = document.getElementById('schoolYearInput').value;
      const semester = document.getElementById('semesterInput').value;

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.userId) return;

      if (!schoolYear || !semester) {
        alert('Please select School Year and Semester.');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/classes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, gradeLevel, section, schoolYear, semester, teacherId: user.userId })
        });
        const result = await res.json();
        if (res.ok && result.success && result.class) {
          classesData.push(result.class);
          applyAndRender();
          e.target.reset();
          bootstrap.Modal.getInstance(document.getElementById('createClassModal')).hide();

          // keep the pills correct
          refreshClassPills(user.userId);
        } else {
          alert(result.message || 'Failed to create class.');
        }
      } catch (err) {
        console.error('Error creating class:', err);
      }
    });

    document.getElementById('editClassForm').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('editClassId').value;
      const name = document.getElementById('editClassNameInput').value.trim();
      const gradeLevel = document.getElementById('editGradeLevelInput').value;
      const section = document.getElementById('editSectionInput').value.trim();
      const schoolYear = document.getElementById('editSchoolYearInput').value;
      const semester = document.getElementById('editSemesterInput').value;

      if (!schoolYear || !semester) {
        alert('Please select School Year and Semester.');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, gradeLevel, section, schoolYear, semester })
        });
        const result = await res.json();
        if (res.ok && result.success) {
          // update local snapshot
          const idx = classesData.findIndex(c => c.id === id);
          if (idx >= 0) {
            classesData[idx] = { ...classesData[idx], name, gradeLevel, section, schoolYear, semester };
          }
          applyAndRender();
          bootstrap.Modal.getInstance(document.getElementById('editClassModal')).hide();
        } else {
          alert(result.message || 'Error updating class.');
        }
      } catch (err) {
        alert('Error updating class.');
      }
    });

    // ===== Controls wiring =====
    function setSegmentedActive(which) {
      statusFilter = which;
      const btnActive = document.getElementById('btnActive');
      const btnArchived = document.getElementById('btnArchived');
      const btnAll = document.getElementById('btnAll');
      [btnActive, btnArchived, btnAll].forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected','false'); });
      if (which === 'active')   { btnActive.classList.add('is-active');   btnActive.setAttribute('aria-selected','true'); }
      if (which === 'archived') { btnArchived.classList.add('is-active'); btnArchived.setAttribute('aria-selected','true'); }
      if (which === 'all')      { btnAll.classList.add('is-active');      btnAll.setAttribute('aria-selected','true'); }

      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.userId) loadClasses(user.userId); // reload from API with new archived param
    }
    document.getElementById('btnActive').addEventListener('click', () => setSegmentedActive('active'));
    document.getElementById('btnArchived').addEventListener('click', () => setSegmentedActive('archived'));
    document.getElementById('btnAll').addEventListener('click', () => setSegmentedActive('all'));

    // sort & filter
    document.getElementById('sortBy').addEventListener('change', (e) => { currentSort = e.target.value; applyAndRender(); });
    document.getElementById('syFilter').addEventListener('change', (e) => { currentSY = e.target.value || ''; applyAndRender(); });

    // search
    document.getElementById('tableSearch').addEventListener('input', applyAndRender);

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', async () => {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user?.isTeacher) return window.location.href = '/TEACHER/login/login.html';
      document.getElementById('Username').textContent = user.username || '';

      // Prefill SY + Semester when opening Create modal
      const createModalEl = document.getElementById('createClassModal');
      createModalEl.addEventListener('show.bs.modal', () => {
        // Build a small range around current year
        const around = [];
        for (let i=-3;i<=3;i++){
          const [a,b] = currentSchoolYearRange(i);
          around.push(`${a}-${b}`);
        }
        const sySel = document.getElementById('schoolYearInput');
        buildSchoolYearOptions(sySel, around);
        sySel.value = getDefaultSchoolYear();

        const semSel = document.getElementById('semesterInput');
        semSel.value = getDefaultSemester();
      });

      await loadSidebar();
      await loadClasses(user.userId);    // loads filtered view + refreshes pills
      await refreshClassPills(user.userId); // ensure initial pills in any case
    });

    function logoutUser() {
      localStorage.removeItem('user');
      window.location.href = '/TEACHER/login/login.html';
    }
  </script>
</body>
</html>
