<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Teacher – Choose Course & Class</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Reuse the analytics theme -->
  <link rel="stylesheet" href="analytics.css"/>
  <style>
    .picker-wrap { max-width: 980px; margin: 0 auto; }
    .helper-muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2"
        >
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo"/>
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header"/>
        </div>
        <div class="search-box position-relative d-none d-md-block">
          <input type="text" class="form-control" placeholder="Search..."/>
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <section class="content px-4">
        <h1 class="page-title">Select Class for Analytics</h1>

        <div class="picker-wrap">
          <div class="ui-card card-themed mb-3">
            <div class="ui-card-head">
              <h2 class="ui-card-title w-100 text-center">
                <i class="bi bi-columns-gap me-2"></i> Class Picker
              </h2>
            </div>

            <div class="row g-3 align-items-end">
              <!-- Course -->
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Course</label>
                <select id="courseSelect" class="form-select" disabled>
                  <option value="">Loading courses…</option>
                </select>
                <small class="d-block helper-muted mt-2">Choose your course or view all courses.</small>
              </div>

              <!-- Class -->
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Class</label>
                <select id="classSelect" class="form-select" disabled>
                  <option value="">Select a course first</option>
                </select>
                <small id="classHelp" class="d-block helper-muted mt-2">Classes are filtered by course. You can also pick “All Classes”.</small>
              </div>
            </div>

            <div class="mt-3 d-flex justify-content-end gap-2">
              <button id="openBtn" class="btn btn-amber" disabled>
                <i class="bi bi-graph-up-arrow me-1"></i> Open Analytics
              </button>
              <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(() => {});
    });
  </script>

  <!-- Page Scripts -->
  <script>
    const API_BASE = 'http://localhost:5000';
    const DEST_URL = '/TEACHER/analytics/analytics.html';
    const ALL = '__all__'; // sentinel for "All Courses" / "All Classes"

    // ---- Auth guard + header initials ----
    (function initHeaderInitials() {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;
      if (!u?.userId || !u?.isTeacher) {
        window.location.href = "/TEACHER/login/login.html";
        return;
      }
      window.currentUser = u;

      const nameEl = document.getElementById('Username');
      if (nameEl) {
        const initials = getInitials(u);
        nameEl.textContent = initials;
        const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
          || u.username || u.email || 'Profile';
        nameEl.setAttribute('title', fullLabel);
        nameEl.setAttribute('aria-label', fullLabel);
      }

      function getInitials(user) {
        const fn = (user.firstName || '').trim();
        const ln = (user.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
        const nameish = (user.username || user.displayName || user.name || '').trim();
        if (nameish) {
          const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
            .split(/[\s._-]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }
        const em = (user.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();

    const teacherId =
      new URLSearchParams(location.search).get('teacherId') ||
      (window.currentUser && window.currentUser.userId) ||
      localStorage.getItem('teacherId') ||
      '';

    // Elements
    const courseSelectEl = document.getElementById('courseSelect');
    const classSelectEl  = document.getElementById('classSelect');
    const classHelpEl    = document.getElementById('classHelp');
    const openBtn        = document.getElementById('openBtn');
    const resetBtn       = document.getElementById('resetBtn');

    // Data caches
    let courses = [];            // [{id, title, assignedClasses, ...}]
    let classesById = {};        // { classId: classObj }
    let selectedCourse = null;

    // Helpers
    const getJson = async (url) => {
      const r = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
      if (!r.ok) throw new Error(`${url} -> ${r.status}`);
      return r.json();
    };

    const classLabel = (c) => {
      const gs = [c.gradeLevel, c.section].filter(Boolean).join('-');
      return gs || c.className || c.name || c.id || c.classId || 'Class';
    };

    // Load teacher classes (once), map by id
    async function loadTeacherClasses() {
      const resp = await getJson(`${API_BASE}/api/classes?teacherId=${encodeURIComponent(teacherId)}`);
      const list = resp.classes || [];
      classesById = {};
      list.forEach(c => {
        const id = c.id || c.classId;
        if (id) classesById[id] = { ...c, id, classId: id };
      });
    }

    // Load teacher courses (unarchived)
    async function loadTeacherCourses() {
      // If your API supports includeArchived=false, you can add it; below gets active by default
      courses = await getJson(`${API_BASE}/courses?uploadedBy=${encodeURIComponent(teacherId)}`);
      courses = (Array.isArray(courses) ? courses : []).filter(c => !c.archived);
    }

    /* ========== POPULATE SELECTS (with ALL options) ========== */
    function populateCourseSelect() {
      if (!courses.length) {
        courseSelectEl.innerHTML = `<option value="">No courses found</option>`;
        courseSelectEl.disabled = true;
        classSelectEl.innerHTML = `<option value="">No classes</option>`;
        classSelectEl.disabled = true;
        openBtn.disabled = true;
        return;
      }

      // Sort by courseNumber then title
      const items = courses.slice().sort((a,b) => {
        const an = Number(a.courseNumber || 0), bn = Number(b.courseNumber || 0);
        if (an !== bn) return an - bn;
        return String(a.title || '').localeCompare(String(b.title || ''));
      });

      courseSelectEl.innerHTML = [
        `<option value="${ALL}">All Courses</option>`,
        ...items.map(c => {
          const left = Number.isFinite(+c.courseNumber) && c.courseNumber > 0 ? `#${c.courseNumber} — ` : '';
          return `<option value="${c.id}">${left}${c.title || 'Untitled Course'}</option>`;
        })
      ].join('');

      courseSelectEl.disabled = false;

      // Build initial class list for ALL courses
      populateClassSelectForAll();
    }

    function populateClassSelectForAll() {
      const allClasses = Object.values(classesById)
        .slice()
        .sort((a,b) => classLabel(a).localeCompare(classLabel(b)));

      classSelectEl.innerHTML = [
        `<option value="${ALL}">All Classes</option>`,
        ...allClasses.map(c => `<option value="${c.classId}">${classLabel(c)}</option>`)
      ].join('');

      classSelectEl.disabled = false;
      classHelpEl.textContent = 'Showing all your classes.';
      openBtn.disabled = false; // “All Classes” is a valid choice
      classSelectEl.value = ALL; // default to All Classes
    }

    function populateClassSelectForCourse(course) {
      const ids = Array.isArray(course.assignedClasses) ? course.assignedClasses : [];
      const available = ids
        .map(id => classesById[id])
        .filter(Boolean)
        .sort((a,b) => classLabel(a).localeCompare(classLabel(b)));

      // Always include "All Classes" (but filtered to the course)
      if (!ids.length) {
        classSelectEl.innerHTML = `<option value="">No classes assigned to this course</option>`;
        classSelectEl.disabled = true;
        classHelpEl.textContent = 'This course has no assigned classes.';
        openBtn.disabled = true;
        return;
      }

      if (!available.length) {
        classSelectEl.innerHTML = `<option value="">Assigned classes are not accessible or archived</option>`;
        classSelectEl.disabled = true;
        classHelpEl.textContent = 'No active/accessible classes for this course.';
        openBtn.disabled = true;
        return;
      }

      classSelectEl.innerHTML = [
        `<option value="${ALL}">All Classes</option>`,
        ...available.map(c => `<option value="${c.classId}">${classLabel(c)}</option>`)
      ].join('');

      classSelectEl.disabled = false;
      classHelpEl.textContent = 'Classes are filtered by course.';
      // Default to All Classes for this course
      classSelectEl.value = ALL;
      openBtn.disabled = false;
    }

    /* ========== EVENTS ========== */
    courseSelectEl.addEventListener('change', () => {
      const id = courseSelectEl.value || '';
      selectedCourse = (id && id !== ALL) ? (courses.find(c => c.id === id) || null) : null;

      if (id === ALL) {
        populateClassSelectForAll();
        openBtn.disabled = false;
        return;
      }
      if (!selectedCourse) {
        classSelectEl.innerHTML = `<option value="">Select a course first</option>`;
        classSelectEl.disabled = true;
        openBtn.disabled = true;
        return;
      }
      populateClassSelectForCourse(selectedCourse);
    });

    classSelectEl.addEventListener('change', () => {
      // Valid when a specific class is chosen OR “All Classes”
      openBtn.disabled = !(classSelectEl.value);
    });

    openBtn.addEventListener('click', () => {
      const selectedCourseId = courseSelectEl.value;
      const selectedClassId  = classSelectEl.value;

      if (!selectedCourseId || !selectedClassId) return;

      const url = new URL(DEST_URL, location.origin);
      url.searchParams.set('teacherId', teacherId);

      // Only pass course if a SPECIFIC one is chosen
      if (selectedCourseId !== ALL) {
        const courseObj = courses.find(c => c.id === selectedCourseId);
        url.searchParams.set('course', (courseObj && courseObj.title) ? courseObj.title : selectedCourseId);
      }

      // Pass class
      if (selectedClassId === ALL) {
        // Let analytics aggregate across all classes (it understands __all__)
        url.searchParams.set('classId', ALL);
        url.searchParams.set('classLabel', 'All Classes');
        url.searchParams.set('section', 'All Classes');
      } else {
        const classText = classSelectEl.options[classSelectEl.selectedIndex]?.text || '';
        url.searchParams.set('classId', selectedClassId);
        url.searchParams.set('classLabel', classText);
        url.searchParams.set('section', classText);
      }

      window.location.href = url.toString();
    });

    resetBtn.addEventListener('click', () => {
      // Reset to ALL/ALL defaults
      if (!courses.length) return;
      courseSelectEl.value = ALL;
      populateClassSelectForAll();
      openBtn.disabled = false;
    });

    // Init
    (async () => {
      try {
        await Promise.all([loadTeacherClasses(), loadTeacherCourses()]);
        populateCourseSelect();
        // Default to All Courses -> All Classes
        courseSelectEl.value = ALL;
        populateClassSelectForAll();
        openBtn.disabled = false;
      } catch (e) {
        console.error(e);
        courseSelectEl.innerHTML = `<option value="">Failed to load courses</option>`;
        courseSelectEl.disabled = true;
        classSelectEl.innerHTML = `<option value="">—</option>`;
        classSelectEl.disabled = true;
        openBtn.disabled = true;
        alert('Could not load your courses/classes. Please try again.');
      }
    })();
  </script>
</body>
</html>
