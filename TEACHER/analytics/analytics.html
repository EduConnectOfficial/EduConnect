<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Analytics & Reporting</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="analytics.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2"
        >
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input type="text" class="form-control" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <section class="content px-4">
        <h1 class="page-title">Analytics & Reporting</h1>

        <!-- Selected from Picker -->
        <div id="selectedMeta" class="d-flex flex-wrap align-items-center gap-2 mb-3" style="display:none">
          <span class="badge rounded-pill text-bg-primary">
            <i class="bi bi-journal-text me-1"></i>
            <span id="metaCourse">Course</span>
          </span>
          <span class="badge rounded-pill text-bg-secondary">
            <i class="bi bi-mortarboard me-1"></i>
            <span id="metaClass">Class</span>
          </span>
        </div>

        <!-- THEMED FILTER/SORT BAR -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title w-100 text-center">
              <i class="bi bi-graph-up-arrow me-2"></i> Dashboard Controls
            </h2>
          </div>
          <div class="row g-3 align-items-end">

            <!-- Course Picker -->
            <div class="col-12 col-lg-4">
              <label class="form-label fw-semibold">Course</label>
              <select id="courseSelect" class="form-select" disabled>
                <option value="">Loading courses…</option>
              </select>
              <small id="courseHint" class="text-muted d-block mt-1" style="display:none">
                Preselected from Class Picker.
              </small>
            </div>

            <!-- Class Picker (filtered by course) -->
            <div class="col-12 col-lg-4">
              <label class="form-label fw-semibold">Class</label>
              <select id="classSelect" class="form-select" disabled>
                <option value="">Select a course first</option>
              </select>
              <small id="classHint" class="text-muted d-block mt-1" style="display:none">
                Preselected from Class Picker.
              </small>
            </div>

            <div class="col-12 col-lg-2">
              <label class="form-label fw-semibold">View</label>
              <select id="viewSelect" class="form-select">
                <option value="quiz" selected>Quizzes</option>
                <option value="assignment">Assignments</option>
              </select>
            </div>

            <div class="col-12 col-lg-2">
              <label class="form-label fw-semibold">Sort</label>
              <select id="sortBy" class="form-select">
                <option value="avg_desc" selected>Avg Quiz Score (High → Low)</option>
                <option value="avg_asc">Avg Quiz Score (Low → High)</option>
                <option value="name_az">Name A → Z</option>
                <option value="taken_desc">Quizzes Taken (Most → Least)</option>
                <option value="taken_asc">Quizzes Taken (Least → Most)</option>
                <option value="ontime_desc">On-time % (High → Low)</option>
                <option value="ontime_asc">On-time % (Low → High)</option>
                <option value="modules_desc">Modules Completed (Most → Least)</option>
                <option value="modules_asc">Modules Completed (Least → Most)</option>
                <option value="status_risk">Status (At Risk first)</option>
              </select>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-end">
            <button id="refreshBtn" class="btn btn-amber">
              <i class="bi bi-arrow-repeat"></i> Refresh
            </button>
          </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="subsection">
          <h2 id="dashboardTitle">Quiz Analytics Dashboard</h2>
          <div class="row gy-4">
            <div class="col-md-6">
              <div class="card chart-card">
                <h6 class="chart-title" id="leftChartTitle">Average Quiz Score by Quiz</h6>
                <canvas id="quizAvgChart" height="160"></canvas>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card chart-card">
                <h6 class="chart-title" id="rightChartTitle">Quiz Attempts per Quiz</h6>
                <canvas id="quizAttemptsChart" height="160"></canvas>
              </div>
            </div>
          </div>

          <!-- Summary Cards -->
          <div class="d-flex flex-wrap gap-3 mt-3 summary-cards">
            <div class="card summary-card">
              <h6 id="totalLabel">Total Quizzes</h6>
              <p id="totalQuizzes">—</p>
            </div>
            <div class="card summary-card">
              <h6 id="avgLabel">Average Quiz Score</h6>
              <p id="avgQuizScore">—</p>
            </div>
            <div class="card summary-card">
              <h6 id="midLabel">Pass Rate</h6>
              <p id="passRate">—</p>
            </div>
            <div class="card summary-card">
              <h6>Modules Completed</h6>
              <p id="modulesCompleted">—</p>
            </div>
          </div>
        </div>

        <!-- Student Progress -->
        <div class="subsection mt-5">
          <h2 id="tableTitle">Student Quiz & Module Progress</h2>
          <div class="table-responsive">
            <table class="table table-striped" id="atRiskTable">
              <thead class="table-light">
                <tr id="tableHeadRow">
                  <th>Student</th>
                  <th>ID</th>
                  <th>Avg Quiz Score</th>
                  <th>Quizzes Taken</th>
                  <th>On-time %</th>
                  <th>Modules Completed</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="atRiskTbody">
                <tr>
                  <td colspan="8" class="text-center text-muted">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Export & Share -->
        <div class="subsection mt-5 mb-5">
          <h2>Export & Share</h2>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button id="exportCsvBtn" class="btn btn-outline-primary">
              <i class="bi bi-file-earmark-spreadsheet"></i> Export Current View CSV
            </button>
            <button id="downloadPdfBtn" class="btn btn-outline-secondary">
              <i class="bi bi-file-earmark-pdf"></i> Download Current View PDF
            </button>
            <button id="exportAllCsvBtn" class="btn btn-outline-primary">
              <i class="bi bi-file-earmark-spreadsheet"></i> Export All (Quiz & Assignment) CSV
            </button>
            <button id="downloadAllPdfBtn" class="btn btn-outline-secondary">
              <i class="bi bi-file-earmark-pdf"></i> Download All (Quiz & Assignment) PDF
            </button>
          </div>
          <small class="d-block mt-2 text-muted">Exports reflect the current filter & view, or all analytics for the
            selected class.</small>
        </div>
      </section>
    </div>
  </div>

  <!-- App Alert Modal -->
  <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div id="appAlertHeader" class="modal-header">
          <h5 class="modal-title" id="appAlertTitle">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="appAlertBody" class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert helper -->
  <script>
    function showAppAlert(message, { title = "Notice", variant = "primary", closeOtherModals = true } = {}) {
      const header = document.getElementById("appAlertHeader");
      const titleEl = document.getElementById("appAlertTitle");
      const bodyEl = document.getElementById("appAlertBody");
      const alertEl = document.getElementById("appAlertModal");

      header.className = "modal-header";
      const bg = {
        primary: "bg-primary text-white", success: "bg-success text-white",
        danger: "bg-danger text-white", warning: "bg-warning",
        info: "bg-info", secondary: "bg-secondary text-white",
        dark: "bg-dark text-white", light: "bg-light"
      }[variant] || "bg-primary text-white";
      header.classList.add(...bg.split(" "));

      titleEl.textContent = title;
      bodyEl.textContent = message;

      if (closeOtherModals) {
        document.querySelectorAll(".modal.show").forEach(m => {
          if (m.id !== "appAlertModal") {
            const inst = bootstrap.Modal.getInstance(m);
            if (inst) inst.hide();
          }
        });
      }
      bootstrap.Modal.getOrCreateInstance(alertEl).show();
    }
  </script>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(() => { /* sidebar optional */ });
    });
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <!-- Page Scripts -->
  <script>
    const API_BASE = 'http://localhost:5000';
    const ALL = '__all__'; // sentinel for "All Courses" / "All Classes"

    // ---- Auth guard + header initials (initials-only) ----
    (function initHeaderInitials() {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;
      if (!u?.userId || !u?.isTeacher) {
        window.location.href = "/TEACHER/login/login.html";
        return;
      }
      window.currentUser = u;

      const nameEl = document.getElementById('Username');
      if (nameEl) {
        const initials = getInitials(u);
        nameEl.textContent = initials;
        const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
          || u.username || u.email || 'Profile';
        nameEl.setAttribute('title', fullLabel);
        nameEl.setAttribute('aria-label', fullLabel);
      }

      function getInitials(user) {
        const fn = (user.firstName || '').trim();
        const ln = (user.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

        const nameish = (user.username || user.displayName || user.name || '').trim();
        if (nameish) {
          const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
            .split(/[\s._-]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }
        const em = (user.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();

    // ---- Read params (from Class Picker, optional) ----
    const params = new URLSearchParams(location.search);
    const teacherId =
      params.get('teacherId') ||
      (window.currentUser && window.currentUser.userId) ||
      localStorage.getItem('teacherId') ||
      '';
    const preselectedClassId = params.get('classId') || '';
    const preselectedCourse = params.get('course') || params.get('courseName') || ''; // may be an id or a title
    const preselectedLabel = params.get('classLabel') || params.get('section') || '';

    // Refs
    const courseSelectEl = document.getElementById('courseSelect');
    const courseHintEl = document.getElementById('courseHint');
    const classSelectEl = document.getElementById('classSelect');
    const classHintEl = document.getElementById('classHint');
    const viewSelectEl = document.getElementById('viewSelect');
    const sortByEl = document.getElementById('sortBy');
    const refreshBtn = document.getElementById('refreshBtn');
    const dashboardTitleEl = document.getElementById('dashboardTitle');
    const leftChartTitleEl = document.getElementById('leftChartTitle');
    const rightChartTitleEl = document.getElementById('rightChartTitle');
    const totalLabelEl = document.getElementById('totalLabel');
    const avgLabelEl = document.getElementById('avgLabel');
    const midLabelEl = document.getElementById('midLabel');
    const totalQuizzesEl = document.getElementById('totalQuizzes');
    const avgQuizScoreEl = document.getElementById('avgQuizScore');
    const passRateEl = document.getElementById('passRate');
    const modulesCompletedEl = document.getElementById('modulesCompleted');
    const tableHeadRow = document.getElementById('tableHeadRow');
    const atRiskTbody = document.getElementById('atRiskTbody');

    // Selection badges
    const selectedMetaWrap = document.getElementById('selectedMeta');
    const metaCourseEl = document.getElementById('metaCourse');
    const metaClassEl = document.getElementById('metaClass');

    // Local data
    let ALL_CLASSES = [];
    let ALL_COURSES = []; // fetched from /courses

    // Helpers
    async function getJson(url) {
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
      if (!res.ok) throw new Error(`GET ${url} -> ${res.status}`);
      return res.json();
    }
    const fmtPct = (n) => Number.isFinite(Number(n)) ? `${Math.round(Number(n))}%` : '—';

    function fullClassLabel(c) {
      const className = c.className || c.sectionName || c.name || 'Class';
      const gl = c.gradeLevel ? `${c.gradeLevel}` : '';
      const sec = c.section ? `${c.section}` : '';
      const suffix = (gl || sec) ? ` (${[gl, sec].filter(Boolean).join('-')})` : '';
      return `${className}${suffix}`;
    }

    // ---- Charts ----
    const charts = { left: null, right: null };
    function destroyChart(key) { if (charts[key]?.destroy) charts[key].destroy(); charts[key] = null; }
    function cleanLabel(s, max = 28) {
      if (!s) return '—';
      let t = String(s).replace(/^(Course|Lesson|Unit)\s*\d+\s*:\s*/i, '').replace(/\s*\([^)]*\)\s*$/, '').trim();
      if (t.length > max) t = t.slice(0, max - 1) + '…';
      return t;
    }
    function renderBar(key, id, fullLabels, values, lbl) {
      destroyChart(key);
      const displayLabels = (fullLabels || []).map(l => cleanLabel(l));
      const ctx = document.getElementById(id);
      charts[key] = new Chart(ctx, {
        type: 'bar',
        data: { labels: displayLabels, datasets: [{ label: lbl, data: values }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { tooltip: { callbacks: { title: (items) => (fullLabels || [])[items[0].dataIndex] || items[0].label } } },
          scales: { x: { ticks: { autoSkip: false } } }
        }
      });
    }
    function renderLine(key, id, fullLabels, values, lbl) {
      destroyChart(key);
      const displayLabels = (fullLabels || []).map(l => cleanLabel(l));
      const ctx = document.getElementById(id);
      charts[key] = new Chart(ctx, {
        type: 'line',
        data: { labels: displayLabels, datasets: [{ label: lbl, data: values, fill: false }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { tooltip: { callbacks: { title: (items) => (fullLabels || [])[items[0].dataIndex] || items[0].label } } },
          scales: { x: { ticks: { autoSkip: false } } }
        }
      });
    }

    // ---- Sorting / table rendering ----
    let SORT_BY = 'avg_desc';
    let lastQuizProgress = [];
    let lastAssignmentProgress = [];

    function setSortOptionsForMode(mode) {
      const label = (val, text) => sortByEl.querySelector(`option[value="${val}"]`).textContent = text;
      if (mode === 'assignment') {
        label('avg_desc', 'Avg Assignment Score (High → Low)');
        label('avg_asc', 'Avg Assignment Score (Low → High)');
        label('taken_desc', 'Assignments Submitted (Most → Least)');
        label('taken_asc', 'Assignments Submitted (Least → Most)');
      } else {
        label('avg_desc', 'Avg Quiz Score (High → Low)');
        label('avg_asc', 'Avg Quiz Score (Low → High)');
        label('taken_desc', 'Quizzes Taken (Most → Least)');
        label('taken_asc', 'Quizzes Taken (Least → Most)');
      }
    }

    function sortRows(rows, mode) {
      const norm = (v) => Number.isFinite(+v) ? +v : NaN;
      const modulesRate = (r) => {
        const a = norm(r.modulesCompleted), t = norm(r.totalModules);
        return (Number.isFinite(a) && Number.isFinite(t) && t > 0) ? (a / t) : NaN;
      };
      const get = (r, key) => {
        switch (key) {
          case 'avg': return mode === 'assignment' ? norm(r.avgAssignmentScore) : norm(r.avgQuizScore);
          case 'taken': return mode === 'assignment' ? norm(r.assignmentsSubmitted) : norm(r.quizzesTaken);
          case 'ontime': return norm(r.onTimePct);
          case 'modules': return modulesRate(r);
          case 'name': return String(r.name || '');
          case 'statusRank': {
            const s = String(r.status || '').toLowerCase();
            return (s === 'at risk') ? 0 : (s === 'on track' ? 1 : 2);
          }
        }
      };
      rows.sort((a, b) => {
        const val = SORT_BY;
        if (val === 'name_az') return get(a, 'name').localeCompare(get(b, 'name'));
        if (val === 'status_risk') return get(a, 'statusRank') - get(b, 'statusRank');
        const metric = val.startsWith('avg') ? 'avg'
          : val.startsWith('taken') ? 'taken'
            : val.startsWith('ontime') ? 'ontime'
              : 'modules';
        const asc = val.endsWith('_asc');
        let av = get(a, metric), bv = get(b, metric);
        if (!Number.isFinite(av)) av = asc ? Infinity : -Infinity;
        if (!Number.isFinite(bv)) bv = asc ? Infinity : -Infinity;
        return asc ? (av - bv) : (bv - av);
      });
      return rows;
    }

    function renderQuizTable(rows) {
      const data = Array.isArray(rows) ? rows.slice() : [];
      sortRows(data, 'quiz');
      if (!data.length) { atRiskTbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data</td></tr>'; return; }
      atRiskTbody.innerHTML = data.map(r => `
        <tr>
          <td>${r.name || '—'}</td>
          <td>${r.studentId || '—'}</td>
          <td>${Number.isFinite(+r.avgQuizScore) ? Math.round(+r.avgQuizScore) + '%' : '—'}</td>
          <td>${r.quizzesTaken ?? 0}/${r.totalQuizzes ?? ''}</td>
          <td>${fmtPct(r.onTimePct)}</td>
          <td>${r.modulesCompleted ?? 0}/${r.totalModules ?? ''}</td>
          <td>${statusBadge(r.status)}</td>
          <td><button class="btn btn-sm btn-amber view-analytics" data-student="${encodeURIComponent(r.studentId || '')}">View</button></td>
        </tr>`).join('');
    }
    function renderAssignmentTable(rows) {
      const data = Array.isArray(rows) ? rows.slice() : [];
      sortRows(data, 'assignment');
      if (!data.length) { atRiskTbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data</td></tr>'; return; }
      atRiskTbody.innerHTML = data.map(r => `
        <tr>
          <td>${r.name || '—'}</td>
          <td>${r.studentId || '—'}</td>
          <td>${Number.isFinite(+r.avgAssignmentScore) ? Math.round(+r.avgAssignmentScore) + '%' : '—'}</td>
          <td>${r.assignmentsSubmitted ?? 0}/${r.totalAssignments ?? ''}</td>
          <td>${fmtPct(r.onTimePct)}</td>
          <td>${r.modulesCompleted ?? 0}/${r.totalModules ?? ''}</td>
          <td>${statusBadge(r.status)}</td>
          <td><button class="btn btn-sm btn-primary view-analytics" data-student="${encodeURIComponent(r.studentId || '')}">View</button></td>
        </tr>`).join('');
    }
    function statusBadge(status) {
      const s = (status || '').toLowerCase();
      if (s === 'at risk') return '<span class="badge bg-danger">At Risk</span>';
      if (s === 'on track') return '<span class="badge bg-success">On Track</span>';
      return '<span class="badge bg-secondary">—</span>';
    }

    // Labels + summaries
    function setModeLabels(mode) {
      setSortOptionsForMode(mode);
      if (mode === 'assignment') {
        dashboardTitleEl.textContent = 'Assignment Analytics Dashboard';
        leftChartTitleEl.textContent = 'Average Assignment Score by Assignment';
        rightChartTitleEl.textContent = 'Submissions per Assignment';
        totalLabelEl.textContent = 'Total Assignments';
        avgLabelEl.textContent = 'Average Assignment Score';
        midLabelEl.textContent = 'On-time Rate';
        tableHeadRow.innerHTML = `
          <th>Student</th><th>ID</th><th>Avg Assignment Score</th><th>Assignments Submitted</th>
          <th>On-time %</th><th>Modules Completed</th><th>Status</th><th>Actions</th>`;
      } else {
        dashboardTitleEl.textContent = 'Quiz Analytics Dashboard';
        leftChartTitleEl.textContent = 'Average Quiz Score by Quiz';
        rightChartTitleEl.textContent = 'Quiz Attempts per Quiz';
        totalLabelEl.textContent = 'Total Quizzes';
        avgLabelEl.textContent = 'Average Quiz Score';
        midLabelEl.textContent = 'Pass Rate';
        tableHeadRow.innerHTML = `
          <th>Student</th><th>ID</th><th>Avg Quiz Score</th><th>Quizzes Taken</th>
          <th>On-time %</th><th>Modules Completed</th><th>Status</th><th>Actions</th>`;
      }
    }
    function setSummaryValuesForQuiz(summary, progress) {
      const s = summary || {};
      let avg = s.averageQuizScore != null ? +s.averageQuizScore : null;
      if (avg == null && Array.isArray(progress) && progress.length) {
        const nums = progress.map(r => +r.avgQuizScore).filter(n => Number.isFinite(n));
        avg = nums.length ? Math.round(nums.reduce((a, b) => a + b, 0) / nums.length) : null;
      }
      totalQuizzesEl.textContent = s.totalQuizzes ?? '—';
      avgQuizScoreEl.textContent = Number.isFinite(avg) ? `${avg}%` : '—';
      passRateEl.textContent = Number.isFinite(+s.passRate) ? `${Math.round(+s.passRate)}%` : '—';
      modulesCompletedEl.textContent = s.modulesCompleted ?? '—';
    }
    function setSummaryValuesForAssignment(summary) {
      const s = summary || {};
      totalQuizzesEl.textContent = s.totalAssignments ?? '—';
      avgQuizScoreEl.textContent = Number.isFinite(+s.averageAssignmentScore) ? `${Math.round(+s.averageAssignmentScore)}%` : '—';
      passRateEl.textContent = Number.isFinite(+s.onTimeRate) ? `${Math.round(+s.onTimeRate)}%` : '—';
      modulesCompletedEl.textContent = s.modulesCompleted ?? '—';
    }

    // ===== LOADERS =====
    async function loadClasses() {
      const resp = await getJson(`${API_BASE}/api/classes?teacherId=${encodeURIComponent(teacherId)}`);
      ALL_CLASSES = resp.classes || [];
    }

    async function loadCourses() {
      const includeArchived = false;
      const url = `${API_BASE}/courses?uploadedBy=${encodeURIComponent(teacherId)}&includeArchived=${includeArchived}`;
      ALL_COURSES = await getJson(url);
    }

    function fillCourseOptions() {
      const items = (ALL_COURSES || []).slice().sort((a, b) => {
        const an = Number(a.courseNumber || 0), bn = Number(b.courseNumber || 0);
        if (an !== bn) return an - bn;
        return String(a.title || '').localeCompare(String(b.title || ''));
      });

      if (!items.length) {
        courseSelectEl.innerHTML = `<option value="">No courses found</option>`;
        classSelectEl.innerHTML = `<option value="">No classes</option>`;
        courseSelectEl.disabled = true;
        classSelectEl.disabled = true;
        return;
      }

      courseSelectEl.innerHTML = [
        `<option value="${ALL}">All Courses</option>`,
        ...items.map(c => {
          const left = Number.isFinite(+c.courseNumber) && c.courseNumber > 0 ? `Course ${c.courseNumber}: ` : '';
          const text = `${left}${c.title || 'Untitled Course'}`;
          return `<option value="${c.id}">${text}</option>`;
        })
      ].join('');

      courseSelectEl.disabled = false;
      // default classes list when page loads (we'll set to All later)
      classSelectEl.innerHTML = `<option value="${ALL}">All Classes</option>`;
      classSelectEl.disabled = false;
    }

    function fillClassOptionsForCourse(courseId) {
      // Build list of classes for the selected course (or all)
      let list;
      if (!courseId || courseId === ALL) {
        list = (ALL_CLASSES || []).slice();
      } else {
        const course = (ALL_COURSES || []).find(c => c.id === courseId);
        const ids = course ? (course.assignedClasses || []) : [];
        list = (ALL_CLASSES || []).filter(c => ids.includes(c.id || c.classId));
      }

      const opts = [
        `<option value="${ALL}">All Classes</option>`,
        ...list.map(c => `<option value="${c.id || c.classId}">${fullClassLabel(c)}</option>`)
      ].join('');

      classSelectEl.innerHTML = opts;
      classSelectEl.disabled = list.length === 0 && courseId !== ALL;
    }

    /* ===== Meta Pill updater (COURSE / CLASS) ===== */
    function updateMetaPills() {
      const courseId = courseSelectEl.value;
      const classId = classSelectEl.value;

      // Course text
      let courseText = 'Course';
      if (courseId === ALL) {
        courseText = 'All Courses';
      } else if (courseId) {
        const course = (ALL_COURSES || []).find(c => c.id === courseId);
        if (course) {
          const prefix = Number.isFinite(+course.courseNumber) && course.courseNumber > 0
            ? `Course ${course.courseNumber}: `
            : '';
          courseText = `${prefix}${course.title || 'Course'}`;
        }
      }
      metaCourseEl.textContent = courseText;

      // Class text
      let classText = 'Class';
      if (classId === ALL) {
        classText = 'All Classes';
      } else if (classId) {
        const cls = (ALL_CLASSES || []).find(c => (c.id || c.classId) === classId);
        if (cls) classText = fullClassLabel(cls);
      }
      metaClassEl.textContent = classText;

      // Show both pills when anything selected (including ALL)
      const coursePill = metaCourseEl.closest('.badge');
      const classPill = metaClassEl.closest('.badge');
      coursePill.style.display = courseId ? 'inline-flex' : 'none';
      classPill.style.display = classId ? 'inline-flex' : 'none';

      selectedMetaWrap.style.display = (courseId || classId) ? 'flex' : 'none';
    }

    async function loadQuizAnalytics() {
      setModeLabels('quiz');
      const classId = classSelectEl.value;
      const useClass = classId && classId !== ALL ? `&classId=${classId}` : '';
      const data = await getJson(`${API_BASE}/api/teacher/quiz-analytics?teacherId=${teacherId}${useClass}`);
      const qLabels = data.byQuiz?.labels || [];
      renderBar('left', 'quizAvgChart', qLabels, data.byQuiz?.avgScores || [], 'Average Score (%)');
      renderLine('right', 'quizAttemptsChart', qLabels, data.byQuiz?.attempts || [], 'Attempts');
      setSummaryValuesForQuiz(data.summary, data.progress);
      lastQuizProgress = data.progress || [];
      renderQuizTable(lastQuizProgress);
    }

    async function loadAssignmentAnalytics() {
      setModeLabels('assignment');
      const classId = classSelectEl.value;
      const useClass = classId && classId !== ALL ? `&classId=${classId}` : '';
      const data = await getJson(`${API_BASE}/api/teacher/assignment-analytics?teacherId=${teacherId}${useClass}`);
      const aLabels = data.byAssignment?.labels || [];
      renderBar('left', 'quizAvgChart', aLabels, data.byAssignment?.avgScores || [], 'Average Score (%)');
      renderLine('right', 'quizAttemptsChart', aLabels, data.byAssignment?.submissions || [], 'Submissions');
      setSummaryValuesForAssignment(data.summary);
      lastAssignmentProgress = data.progress || [];
      renderAssignmentTable(lastAssignmentProgress);
    }

    async function loadAnalyticsView() {
      // When "All Classes" is selected, we call the API WITHOUT a classId -> aggregate for teacher
      if (viewSelectEl.value === 'assignment') await loadAssignmentAnalytics();
      else await loadQuizAnalytics();
    }

    // ===== Exports =====
    async function getBothAnalytics(classId) {
      const useClass = classId && classId !== ALL ? `&classId=${classId}` : '';
      const quiz = await getJson(`${API_BASE}/api/teacher/quiz-analytics?teacherId=${teacherId}${useClass}`);
      const assignment = await getJson(`${API_BASE}/api/teacher/assignment-analytics?teacherId=${teacherId}${useClass}`);
      return { quiz, assignment };
    }
    function csvForAnalytics(mode, data, classLabel) {
      let csv = [];
      csv.push('Class,View,Date');
      csv.push(`"${classLabel}","${mode}","${new Date().toLocaleDateString()}"`);
      if (mode === 'assignment') {
        csv.push(''); csv.push('Summary');
        csv.push('Total Assignments,Average Assignment Score,On-time Rate,Modules Completed');
        csv.push(`"${data.summary?.totalAssignments ?? ''}","${data.summary?.averageAssignmentScore ?? ''}","${data.summary?.onTimeRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
      } else {
        csv.push(''); csv.push('Summary');
        csv.push('Total Quizzes,Average Quiz Score,Pass Rate,Modules Completed');
        csv.push(`"${data.summary?.totalQuizzes ?? ''}","${data.summary?.averageQuizScore ?? ''}","${data.summary?.passRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
      }
      csv.push(''); csv.push('Students');
      if (mode === 'assignment') {
        csv.push('Student,ID,Avg Assignment Score,Assignments Submitted,On-time %,Modules Completed,Status');
        (data.progress || []).forEach(r => {
          csv.push(`"${r.name}","${r.studentId}","${r.avgAssignmentScore}","${r.assignmentsSubmitted}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
        });
      } else {
        csv.push('Student,ID,Avg Quiz Score,Quizzes Taken,On-time %,Modules Completed,Status');
        (data.progress || []).forEach(r => {
          csv.push(`"${r.name}","${r.studentId}","${r.avgQuizScore}","${r.quizzesTaken}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
        });
      }
      return csv.join('\r\n');
    }
    async function exportAllCsv() {
      try {
        const classId = classSelectEl.value || ALL;
        const classLabel = classId === ALL ? 'All Classes' : (classSelectEl.options[classSelectEl.selectedIndex]?.text || '');
        const both = await getBothAnalytics(classId);
        let csv = [];
        csv.push(csvForAnalytics('quiz', both.quiz, classLabel));
        csv.push('');
        csv.push(csvForAnalytics('assignment', both.assignment, classLabel));
        const blob = new Blob([csv.join('\r\n')], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `all_analytics_${classId === ALL ? 'all' : classId}.csv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      } catch (e) {
        console.error(e);
        showAppAlert('CSV export failed.');
      }
    }
    async function downloadAllPdf() {
      try {
        if (typeof window.jspdf === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
            s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
          });
        }
        if (typeof window.jspdf?.jsPDF === 'undefined') { showAppAlert('Failed to load jsPDF.'); return; }
        if (typeof window.jspdf?.autoTable === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.0/dist/jspdf.plugin.autotable.min.js';
            s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
          });
        }
        const classId = classSelectEl.value || ALL;
        const classLabel = classId === ALL ? 'All Classes' : (classSelectEl.options[classSelectEl.selectedIndex]?.text || '');
        const both = await getBothAnalytics(classId);
        const doc = new window.jspdf.jsPDF();
        doc.setFont('times', 'bold'); doc.setFontSize(18);
        doc.text('Class Analytics Report (Quiz & Assignment)', 105, 20, { align: 'center' });
        doc.setFontSize(12); doc.setFont('times', 'normal');
        doc.text(`Class: ${classLabel}`, 20, 32);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 40);

        doc.setFont('times', 'bold'); doc.text('Quiz Analytics', 20, 50);
        doc.setFont('times', 'normal');
        doc.autoTable({
          startY: 55,
          head: [['Total Quizzes', 'Average Quiz Score', 'Pass Rate', 'Modules Completed']],
          body: [[both.quiz.summary?.totalQuizzes ?? '', both.quiz.summary?.averageQuizScore ?? '', both.quiz.summary?.passRate ?? '', both.quiz.summary?.modulesCompleted ?? '']],
          theme: 'grid', styles: { font: 'times', fontSize: 11, halign: 'center' }, headStyles: { fillColor: [255, 178, 0], textColor: 0 }
        });
        let y = doc.lastAutoTable.finalY + 8;
        doc.setFont('times', 'bold'); doc.text('Students (Quiz)', 20, y); doc.setFont('times', 'normal'); y += 2;
        doc.autoTable({
          startY: y,
          head: [['Student', 'ID', 'Avg Quiz Score', 'Quizzes Taken', 'On-time %', 'Modules Completed', 'Status']],
          body: (both.quiz.progress || []).map(r => [r.name, r.studentId, r.avgQuizScore, r.quizzesTaken, r.onTimePct, r.modulesCompleted, r.status]),
          theme: 'grid', styles: { font: 'times', fontSize: 10 }, headStyles: { fillColor: [240, 240, 240], textColor: 0 }
        });
        y = doc.lastAutoTable.finalY + 8;

        doc.setFont('times', 'bold'); doc.text('Assignment Analytics', 20, y); doc.setFont('times', 'normal'); y += 2;
        doc.autoTable({
          startY: y,
          head: [['Total Assignments', 'Average Assignment Score', 'On-time Rate', 'Modules Completed']],
          body: [[both.assignment.summary?.totalAssignments ?? '', both.assignment.summary?.averageAssignmentScore ?? '', both.assignment.summary?.onTimeRate ?? '', both.assignment.summary?.modulesCompleted ?? '']],
          theme: 'grid', styles: { font: 'times', fontSize: 11, halign: 'center' }, headStyles: { fillColor: [255, 178, 0], textColor: 0 }
        });
        y = doc.lastAutoTable.finalY + 8;
        doc.setFont('times', 'bold'); doc.text('Students (Assignment)', 20, y); doc.setFont('times', 'normal'); y += 2;
        doc.autoTable({
          startY: y,
          head: [['Student', 'ID', 'Avg Assignment Score', 'Assignments Submitted', 'On-time %', 'Modules Completed', 'Status']],
          body: (both.assignment.progress || []).map(r => [r.name, r.studentId, r.avgAssignmentScore, r.assignmentsSubmitted, r.onTimePct, r.modulesCompleted, r.status]),
          theme: 'grid', styles: { font: 'times', fontSize: 10 }, headStyles: { fillColor: [240, 240, 240], textColor: 0 }
        });
        doc.save(`all_analytics_${classId === ALL ? 'all' : classId}.pdf`);
      } catch (e) {
        console.error(e);
        showAppAlert('PDF download failed.');
      }
    }
    async function exportCsv() {
      try {
        const classId = classSelectEl.value || ALL;
        const mode = viewSelectEl.value;
        const base = mode === 'assignment' ? 'assignment-analytics' : 'quiz-analytics';
        const useClass = classId && classId !== ALL ? `&classId=${classId}` : '';
        const data = await getJson(`${API_BASE}/api/teacher/${mode}-analytics?teacherId=${teacherId}${useClass}`);
        let csv = [];
        csv.push('Class,View,Date');
        const label = classId === ALL ? 'All Classes' : (classSelectEl.options[classSelectEl.selectedIndex]?.text || '');
        csv.push(`"${label}","${mode}","${new Date().toLocaleDateString()}"`);
        if (mode === 'assignment') {
          csv.push(''); csv.push('Summary');
          csv.push('Total Assignments,Average Assignment Score,On-time Rate,Modules Completed');
          csv.push(`"${data.summary?.totalAssignments ?? ''}","${data.summary?.averageAssignmentScore ?? ''}","${data.summary?.onTimeRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
          csv.push(''); csv.push('Students');
          csv.push('Student,ID,Avg Assignment Score,Assignments Submitted,On-time %,Modules Completed,Status');
          (data.progress || []).forEach(r => {
            csv.push(`"${r.name}","${r.studentId}","${r.avgAssignmentScore}","${r.assignmentsSubmitted}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
          });
        } else {
          csv.push(''); csv.push('Summary');
          csv.push('Total Quizzes,Average Quiz Score,Pass Rate,Modules Completed');
          csv.push(`"${data.summary?.totalQuizzes ?? ''}","${data.summary?.averageQuizScore ?? ''}","${data.summary?.passRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
          csv.push(''); csv.push('Students');
          csv.push('Student,ID,Avg Quiz Score,Quizzes Taken,On-time %,Modules Completed,Status');
          (data.progress || []).forEach(r => {
            csv.push(`"${r.name}","${r.studentId}","${r.avgQuizScore}","${r.quizzesTaken}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
          });
        }
        const blob = new Blob([csv.join('\r\n')], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${base}_${classId === ALL ? 'all' : classId}.csv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      } catch (e) {
        console.error(e);
        showAppAlert('CSV export failed.');
      }
    }

    // ===== EVENTS =====
    document.getElementById('exportCsvBtn').addEventListener('click', () => exportCsv().catch(alert));
    document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadAllPdf?.().catch?.(alert));
    document.getElementById('exportAllCsvBtn').addEventListener('click', () => exportAllCsv().catch(alert));
    document.getElementById('downloadAllPdfBtn').addEventListener('click', () => downloadAllPdf().catch(alert));

    // Course → populate classes
    courseSelectEl.addEventListener('change', () => {
      const courseId = courseSelectEl.value;
      fillClassOptionsForCourse(courseId);
      // default class to ALL whenever course changes
      classSelectEl.value = ALL;
      classHintEl.style.display = 'none';
      updateMetaPills();
      loadAnalyticsView().catch(console.error);
    });

    // Class → load analytics
    classSelectEl.addEventListener('change', () => {
      updateMetaPills();
      loadAnalyticsView().catch(alert);
    });

    viewSelectEl.addEventListener('change', () => { setSortOptionsForMode(viewSelectEl.value); loadAnalyticsView().catch(alert); });
    refreshBtn.addEventListener('click', () => loadAnalyticsView().catch(console.error));
    sortByEl.addEventListener('change', (e) => {
      SORT_BY = e.target.value;
      if (viewSelectEl.value === 'assignment') renderAssignmentTable(lastAssignmentProgress);
      else renderQuizTable(lastQuizProgress);
    });
    document.getElementById('atRiskTable').addEventListener('click', (e) => {
      const btn = e.target.closest('.view-analytics');
      if (!btn) return;
      const student = btn.dataset.student;
      if (student) {
        window.location.href = `/TEACHER/analytics/student.html?student=${student}&teacherId=${teacherId}`;
      }
    });

    // Init
    (async () => {
      await loadClasses();
      await loadCourses();
      fillCourseOptions();
      // Default to "All Courses" + "All Classes" unless URL preselects are present
      let appliedCourse = false;

      if (preselectedCourse) {
        let found = ALL_COURSES.find(c => c.id === preselectedCourse)
                || ALL_COURSES.find(c => (c.title || '').trim() === preselectedCourse.trim());
        if (found) {
          courseSelectEl.value = found.id;
          courseHintEl.style.display = 'block';
          appliedCourse = true;
          fillClassOptionsForCourse(found.id);
        }
      }
      if (!appliedCourse && preselectedClassId) {
        const ownerCourse = ALL_COURSES.find(c => (c.assignedClasses || []).includes(preselectedClassId));
        if (ownerCourse) {
          courseSelectEl.value = ownerCourse.id;
          fillClassOptionsForCourse(ownerCourse.id);
        }
      }
      // If nothing preselected, set ALL/ALL
      if (!courseSelectEl.value) {
        courseSelectEl.value = ALL;
        fillClassOptionsForCourse(ALL);
      }

      if (preselectedClassId) {
        const hasIt = Array.from(classSelectEl.options).some(o => o.value === preselectedClassId);
        if (hasIt) {
          classSelectEl.value = preselectedClassId;
          classHintEl.style.display = 'block';
        } else {
          classSelectEl.value = ALL;
        }
      } else if (!classSelectEl.value) {
        classSelectEl.value = ALL;
      }

      setSortOptionsForMode('quiz');
      updateMetaPills();
      await loadAnalyticsView();
    })();
  </script>
</body>
</html>
