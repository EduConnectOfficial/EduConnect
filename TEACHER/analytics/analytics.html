<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Teacher - Analytics & Reporting</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Global & Page CSS -->
  <link rel="stylesheet" href="../dashboard/dashboard.css"/>
  <link rel="stylesheet" href="analytics.css"/>

  <!-- THEME (your exact design CSS) -->
  <style>
    :root {
      --bg:#f6f8fa; --text:#1f2328; --muted:#6a737d; --card:#fff; --border:#e5e7eb;
      --brand-dark-1:#4A1A0C; --brand-dark-2:#7A2810; --brand-accent-1:#FF6A00; --brand-accent-2:#B03C10;
      --radius:14px;
    }
    html,body{height:100%;background:var(--bg);color:var(--text)}
    .dashboard{display:flex;min-height:100vh}
    .main{margin-left:70px;width:calc(100% - 70px);transition:margin-left .3s,width .3s;display:flex;flex-direction:column;background:var(--bg)}
    .sidebar:hover~.main{margin-left:220px;width:calc(100% - 220px)}

    .logo-header{height:44px}
    .search-box{max-width:520px;width:100%;position:relative}
    .search-box input{border:none;border-radius:999px;padding:.6rem .9rem .6rem 1rem;padding-right:36px}
    .search-box i.fas.fa-search{position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none;opacity:.6;font-size:.95rem}
    .profile-btn{color:#fff}

    .content{padding:24px}
    .page-title{
      font-weight:800;font-size:1.6rem;margin:4px 0 18px;text-align:center;color:transparent;
      background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2)); -webkit-background-clip:text;background-clip:text;
    }

    /* ui-card themed controls */
    .ui-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .ui-card.card-themed{border-radius:var(--radius);border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 24px rgba(0,0,0,.1);overflow:hidden}
    .ui-card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .ui-card.card-themed .ui-card-head{
      margin:-16px -16px 12px -16px;padding:12px 16px;background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2));
      color:#FFD8A9;border-bottom:1px solid rgba(255,255,255,.1)
    }
    .ui-card-title{font-size:1.05rem;font-weight:700;margin:0;display:flex;gap:8px;align-items:center}
    .ui-subtext{font-size:1rem;color:#ffe9ca}

    .btn-amber{background:linear-gradient(to bottom,var(--brand-accent-1),var(--brand-accent-2));color:#fff;border:none}
    .btn-amber:hover{filter:brightness(1.06);color:#fff}

    /* Segmented (kept here in case you add segmented toggles later) */
    .segmented{display:flex;gap:.5rem;flex-wrap:wrap}
    .segmented .seg-btn{
      min-width:110px;padding:.6rem 1rem;font-weight:700;border-radius:10px;border:2px solid var(--border);
      background:#fff;color:#374151;cursor:pointer;text-align:center;user-select:none;
      box-shadow:0 1px 2px rgba(0,0,0,.03);transition:background .15s,border-color .15s,box-shadow .15s,color .15s;
    }
    .segmented .seg-btn:hover{background:#f9fafb;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .segmented .seg-btn.is-active{background:#5f6b77;color:#fff;border-color:#5f6b77}
    .segmented .seg-btn.is-archived{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .segmented .seg-btn.is-all{background:#eef2ff;color:#1e3a8a;border-color:#c7d2fe}
  </style>
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2" style="background:linear-gradient(90deg,var(--brand-dark-1),var(--brand-dark-2));color:#fff;">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box position-relative">
          <input type="text" class="form-control" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <section class="content px-4">
        <h1 class="page-title">Analytics & Reporting</h1>

        <!-- THEMED FILTER/SORT BAR -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title w-100 text-center">
              <i class="bi bi-graph-up-arrow me-2"></i> Dashboard Controls
            </h2>
          </div>
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Class</label>
              <select id="classSelect" class="form-select">
                <option value="">All classes</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">View</label>
              <select id="viewSelect" class="form-select">
                <option value="quiz" selected>Quizzes</option>
                <option value="assignment">Assignments</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Sort</label>
              <select id="sortBy" class="form-select">
                <option value="avg_desc" selected>Avg Quiz Score (High → Low)</option>
                <option value="avg_asc">Avg Quiz Score (Low → High)</option>
                <option value="name_az">Name A → Z</option>
                <option value="taken_desc">Quizzes Taken (Most → Least)</option>
                <option value="taken_asc">Quizzes Taken (Least → Most)</option>
                <option value="ontime_desc">On-time % (High → Low)</option>
                <option value="ontime_asc">On-time % (Low → High)</option>
                <option value="modules_desc">Modules Completed (Most → Least)</option>
                <option value="modules_asc">Modules Completed (Least → Most)</option>
                <option value="status_risk">Status (At Risk first)</option>
              </select>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-end">
            <button id="refreshBtn" class="btn btn-amber">
              <i class="bi bi-arrow-repeat"></i> Refresh
            </button>
          </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="subsection">
          <h2 id="dashboardTitle">Quiz Analytics Dashboard</h2>
          <div class="row gy-4">
            <div class="col-md-6">
              <div class="card chart-card">
                <h6 class="chart-title" id="leftChartTitle">Average Quiz Score by Quiz</h6>
                <canvas id="quizAvgChart" height="160"></canvas>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card chart-card">
                <h6 class="chart-title" id="rightChartTitle">Quiz Attempts per Quiz</h6>
                <canvas id="quizAttemptsChart" height="160"></canvas>
              </div>
            </div>
          </div>

          <!-- Summary Cards -->
          <div class="d-flex flex-wrap gap-3 mt-3 summary-cards">
            <div class="card summary-card">
              <h6 id="totalLabel">Total Quizzes</h6>
              <p id="totalQuizzes">—</p>
            </div>
            <div class="card summary-card">
              <h6 id="avgLabel">Average Quiz Score</h6>
              <p id="avgQuizScore">—</p>
            </div>
            <div class="card summary-card">
              <h6 id="midLabel">Pass Rate</h6>
              <p id="passRate">—</p>
            </div>
            <div class="card summary-card">
              <h6>Modules Completed</h6>
              <p id="modulesCompleted">—</p>
            </div>
          </div>
        </div>

        <!-- Student Progress -->
        <div class="subsection mt-5">
          <h2 id="tableTitle">Student Quiz & Module Progress</h2>
          <div class="table-responsive">
            <table class="table table-striped" id="atRiskTable">
              <thead class="table-light">
                <tr id="tableHeadRow">
                  <th>Student</th>
                  <th>ID</th>
                  <th>Avg Quiz Score</th>
                  <th>Quizzes Taken</th>
                  <th>On-time %</th>
                  <th>Modules Completed</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="atRiskTbody">
                <tr>
                  <td colspan="8" class="text-center text-muted">Loading…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Export & Share -->
        <div class="subsection mt-5 mb-5">
          <h2>Export & Share</h2>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button id="exportCsvBtn" class="btn btn-outline-primary">
              <i class="bi bi-file-earmark-spreadsheet"></i> Export Current View CSV
            </button>
            <button id="downloadPdfBtn" class="btn btn-outline-secondary">
              <i class="bi bi-file-earmark-pdf"></i> Download Current View PDF
            </button>
            <button id="exportAllCsvBtn" class="btn btn-outline-primary">
              <i class="bi bi-file-earmark-spreadsheet"></i> Export All (Quiz & Assignment) CSV
            </button>
            <button id="downloadAllPdfBtn" class="btn btn-outline-secondary">
              <i class="bi bi-file-earmark-pdf"></i> Download All (Quiz & Assignment) PDF
            </button>
          </div>
          <small class="d-block mt-2 text-muted">Exports reflect the current filter & view, or all analytics for the selected class.</small>
        </div>
      </section>
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(() => { /* sidebar optional */ });
    });
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <!-- Page Scripts -->
  <script>
    const API_BASE = 'http://localhost:5000';

    // Auth guard
    (function () {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;
      if (!u?.userId || !u?.isTeacher) {
        window.location.href = "/TEACHER/login/login.html";
        return;
      }
      window.currentUser = u;
      const nameEl = document.getElementById('Username');
      if (nameEl) {
        const fullName = [u.firstName, u.middleName, u.lastName]
          .filter(Boolean)
          .join(' ')
          .replace(/\s+/g, ' ')
          .trim();
        nameEl.textContent = fullName || (u.username || 'Teacher').toString().trim();
      }
    })();

    const teacherId =
      new URLSearchParams(location.search).get('teacherId') ||
      (window.currentUser && window.currentUser.userId) ||
      localStorage.getItem('teacherId') ||
      '';

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      location.href = "/TEACHER/login/login.html";
    }

    async function getJson(url) {
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
      if (!res.ok) throw new Error(`GET ${url} -> ${res.status}`);
      return res.json();
    }
    async function getBlob(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`GET ${url} -> ${res.status}`);
      return res.blob();
    }
    const fmtPct = (n) => Number.isFinite(Number(n)) ? `${Math.round(Number(n))}%` : '—';

    // Refs
    const classSelectEl = document.getElementById('classSelect');
    const viewSelectEl = document.getElementById('viewSelect');
    const sortByEl = document.getElementById('sortBy');
    const refreshBtn = document.getElementById('refreshBtn');
    const dashboardTitleEl = document.getElementById('dashboardTitle');
    const leftChartTitleEl = document.getElementById('leftChartTitle');
    const rightChartTitleEl = document.getElementById('rightChartTitle');
    const totalLabelEl = document.getElementById('totalLabel');
    const avgLabelEl = document.getElementById('avgLabel');
    const midLabelEl = document.getElementById('midLabel');
    const totalQuizzesEl = document.getElementById('totalQuizzes');
    const avgQuizScoreEl = document.getElementById('avgQuizScore');
    const passRateEl = document.getElementById('passRate');
    const modulesCompletedEl = document.getElementById('modulesCompleted');
    const tableHeadRow = document.getElementById('tableHeadRow');
    const atRiskTbody = document.getElementById('atRiskTbody');

    // ---- Label shortener (used for BOTH charts) ----
    function cleanLabel(s, max = 28) {
      if (!s) return '—';
      let t = String(s)
        .replace(/^(Course|Lesson|Unit)\s*\d+\s*:\s*/i, '')
        .replace(/\s*\([^)]*\)\s*$/,'')
        .trim();
      if (t.length > max) t = t.slice(0, max - 1) + '…';
      return t;
    }

    // Charts
    const charts = { left: null, right: null };
    function destroyChart(key) { if (charts[key]?.destroy) charts[key].destroy(); charts[key] = null; }

    function renderBar(key, id, fullLabels, values, lbl) {
      destroyChart(key);
      const displayLabels = (fullLabels || []).map(l => cleanLabel(l));
      const ctx = document.getElementById(id);
      charts[key] = new Chart(ctx, {
        type: 'bar',
        data: { labels: displayLabels, datasets: [{ label: lbl, data: values }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { tooltip: { callbacks: { title: (items) => (fullLabels || [])[items[0].dataIndex] || items[0].label } } },
          scales: { x: { ticks: { autoSkip: false } } }
        }
      });
    }

    function renderLine(key, id, fullLabels, values, lbl) {
      destroyChart(key);
      const displayLabels = (fullLabels || []).map(l => cleanLabel(l));
      const ctx = document.getElementById(id);
      charts[key] = new Chart(ctx, {
        type: 'line',
        data: { labels: displayLabels, datasets: [{ label: lbl, data: values, fill: false }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { tooltip: { callbacks: { title: (items) => (fullLabels || [])[items[0].dataIndex] || items[0].label } } },
          scales: { x: { ticks: { autoSkip: false } } }
        }
      });
    }

    // Badge helper
    function statusBadge(status) {
      const s = (status || '').toLowerCase();
      if (s === 'at risk') return '<span class="badge bg-danger">At Risk</span>';
      if (s === 'on track') return '<span class="badge bg-success">On Track</span>';
      return '<span class="badge bg-secondary">—</span>';
    }

    // ===== Sorting =====
    let SORT_BY = 'avg_desc';
    let lastQuizProgress = [];
    let lastAssignmentProgress = [];

    function setSortOptionsForMode(mode) {
      if (!sortByEl) return;
      // update option labels to match the mode, values stay the same
      const label = (val, text) => sortByEl.querySelector(`option[value="${val}"]`).textContent = text;
      if (mode === 'assignment') {
        label('avg_desc','Avg Assignment Score (High → Low)');
        label('avg_asc','Avg Assignment Score (Low → High)');
        label('taken_desc','Assignments Submitted (Most → Least)');
        label('taken_asc','Assignments Submitted (Least → Most)');
      } else {
        label('avg_desc','Avg Quiz Score (High → Low)');
        label('avg_asc','Avg Quiz Score (Low → High)');
        label('taken_desc','Quizzes Taken (Most → Least)');
        label('taken_asc','Quizzes Taken (Least → Most)');
      }
    }

    function sortRows(rows, mode) {
      const norm = (v) => Number.isFinite(+v) ? +v : NaN;
      const modulesRate = (r) => {
        const a = norm(r.modulesCompleted), t = norm(r.totalModules);
        return (Number.isFinite(a) && Number.isFinite(t) && t > 0) ? (a / t) : NaN;
      };
      const get = (r, key) => {
        switch (key) {
          case 'avg':   return mode==='assignment' ? norm(r.avgAssignmentScore) : norm(r.avgQuizScore);
          case 'taken': return mode==='assignment' ? norm(r.assignmentsSubmitted) : norm(r.quizzesTaken);
          case 'ontime':return norm(r.onTimePct);
          case 'modules': return modulesRate(r);
          case 'name':  return String(r.name || '');
          case 'statusRank': {
            const s = String(r.status || '').toLowerCase();
            return (s === 'at risk') ? 0 : (s === 'on track' ? 1 : 2);
          }
        }
      };

      rows.sort((a,b) => {
        const val = SORT_BY;
        if (val === 'name_az') return get(a,'name').localeCompare(get(b,'name'));
        if (val === 'status_risk') return get(a,'statusRank') - get(b,'statusRank');

        const metric = val.startsWith('avg') ? 'avg'
                      : val.startsWith('taken') ? 'taken'
                      : val.startsWith('ontime') ? 'ontime'
                      : 'modules';
        const asc = val.endsWith('_asc');
        let av = get(a, metric), bv = get(b, metric);
        // push NaNs to the end
        if (!Number.isFinite(av)) av = asc ? Infinity : -Infinity;
        if (!Number.isFinite(bv)) bv = asc ? Infinity : -Infinity;
        return asc ? (av - bv) : (bv - av);
      });

      return rows;
    }

    // Tables with View buttons
    function renderQuizTable(rows) {
      const data = Array.isArray(rows) ? rows.slice() : [];
      sortRows(data, 'quiz');
      if (!data.length) { atRiskTbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data</td></tr>'; return; }
      atRiskTbody.innerHTML = data.map(r => `
        <tr>
          <td>${r.name || '—'}</td>
          <td>${r.studentId || '—'}</td>
          <td>${Number.isFinite(+r.avgQuizScore) ? Math.round(+r.avgQuizScore)+'%' : '—'}</td>
          <td>${r.quizzesTaken ?? 0}/${r.totalQuizzes ?? ''}</td>
          <td>${fmtPct(r.onTimePct)}</td>
          <td>${r.modulesCompleted ?? 0}/${r.totalModules ?? ''}</td>
          <td>${statusBadge(r.status)}</td>
          <td><button class="btn btn-sm btn-primary view-analytics" data-student="${encodeURIComponent(r.studentId || '')}">View</button></td>
        </tr>`).join('');
    }
    function renderAssignmentTable(rows) {
      const data = Array.isArray(rows) ? rows.slice() : [];
      sortRows(data, 'assignment');
      if (!data.length) { atRiskTbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data</td></tr>'; return; }
      atRiskTbody.innerHTML = data.map(r => `
        <tr>
          <td>${r.name || '—'}</td>
          <td>${r.studentId || '—'}</td>
          <td>${Number.isFinite(+r.avgAssignmentScore) ? Math.round(+r.avgAssignmentScore)+'%' : '—'}</td>
          <td>${r.assignmentsSubmitted ?? 0}/${r.totalAssignments ?? ''}</td>
          <td>${fmtPct(r.onTimePct)}</td>
          <td>${r.modulesCompleted ?? 0}/${r.totalModules ?? ''}</td>
          <td>${statusBadge(r.status)}</td>
          <td><button class="btn btn-sm btn-primary view-analytics" data-student="${encodeURIComponent(r.studentId || '')}">View</button></td>
        </tr>`).join('');
    }

    // Labels
    function setModeLabels(mode) {
      setSortOptionsForMode(mode);
      if (mode === 'assignment') {
        dashboardTitleEl.textContent = 'Assignment Analytics Dashboard';
        leftChartTitleEl.textContent = 'Average Assignment Score by Assignment';
        rightChartTitleEl.textContent = 'Submissions per Assignment';
        totalLabelEl.textContent = 'Total Assignments';
        avgLabelEl.textContent = 'Average Assignment Score';
        midLabelEl.textContent = 'On-time Rate';
        tableHeadRow.innerHTML = `
          <th>Student</th><th>ID</th><th>Avg Assignment Score</th><th>Assignments Submitted</th>
          <th>On-time %</th><th>Modules Completed</th><th>Status</th><th>Actions</th>`;
      } else {
        dashboardTitleEl.textContent = 'Quiz Analytics Dashboard';
        leftChartTitleEl.textContent = 'Average Quiz Score by Quiz';
        rightChartTitleEl.textContent = 'Quiz Attempts per Quiz';
        totalLabelEl.textContent = 'Total Quizzes';
        avgLabelEl.textContent = 'Average Quiz Score';
        midLabelEl.textContent = 'Pass Rate';
        tableHeadRow.innerHTML = `
          <th>Student</th><th>ID</th><th>Avg Quiz Score</th><th>Quizzes Taken</th>
          <th>On-time %</th><th>Modules Completed</th><th>Status</th><th>Actions</th>`;
      }
    }

    // Summaries
    function setSummaryValuesForQuiz(summary, progress) {
      const s = summary || {};
      let avg = s.averageQuizScore != null ? +s.averageQuizScore : null;
      if (avg == null && Array.isArray(progress) && progress.length) {
        const nums = progress.map(r => +r.avgQuizScore).filter(n => Number.isFinite(n));
        avg = nums.length ? Math.round(nums.reduce((a,b)=>a+b,0)/nums.length) : null;
      }
      totalQuizzesEl.textContent = s.totalQuizzes ?? '—';
      avgQuizScoreEl.textContent = Number.isFinite(avg) ? `${avg}%` : '—';
      passRateEl.textContent = Number.isFinite(+s.passRate) ? `${Math.round(+s.passRate)}%` : '—';
      modulesCompletedEl.textContent = s.modulesCompleted ?? '—';
    }
    function setSummaryValuesForAssignment(summary) {
      const s = summary || {};
      totalQuizzesEl.textContent = s.totalAssignments ?? '—';
      avgQuizScoreEl.textContent = Number.isFinite(+s.averageAssignmentScore) ? `${Math.round(+s.averageAssignmentScore)}%` : '—';
      passRateEl.textContent = Number.isFinite(+s.onTimeRate) ? `${Math.round(+s.onTimeRate)}%` : '—';
      modulesCompletedEl.textContent = s.modulesCompleted ?? '—';
    }

    // Loaders
    async function loadClasses() {
      const resp = await getJson(`${API_BASE}/api/classes?teacherId=${encodeURIComponent(teacherId)}`);
      const classes = resp.classes || [];
      classSelectEl.innerHTML = `<option value="">All classes</option>`;
      classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id || c.classId;
        opt.textContent = `${c.name} (${c.gradeLevel}-${c.section})`;
        classSelectEl.appendChild(opt);
      });
    }
    async function loadQuizAnalytics() {
      setModeLabels('quiz');
      const classId = classSelectEl.value || '';
      const data = await getJson(`${API_BASE}/api/teacher/quiz-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
      const qLabels = data.byQuiz?.labels || [];
      renderBar('left','quizAvgChart',qLabels,data.byQuiz?.avgScores||[],'Average Score (%)');
      renderLine('right','quizAttemptsChart',qLabels,data.byQuiz?.attempts||[],'Attempts');
      setSummaryValuesForQuiz(data.summary,data.progress);
      lastQuizProgress = data.progress || [];
      renderQuizTable(lastQuizProgress);
    }
    async function loadAssignmentAnalytics() {
      setModeLabels('assignment');
      const classId = classSelectEl.value || '';
      const data = await getJson(`${API_BASE}/api/teacher/assignment-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
      const aLabels = data.byAssignment?.labels || [];
      renderBar('left','quizAvgChart',aLabels,data.byAssignment?.avgScores||[],'Average Score (%)');
      renderLine('right','quizAttemptsChart',aLabels,data.byAssignment?.submissions||[],'Submissions');
      setSummaryValuesForAssignment(data.summary);
      lastAssignmentProgress = data.progress || [];
      renderAssignmentTable(lastAssignmentProgress);
    }
    async function loadAnalyticsView() {
      if (viewSelectEl.value === 'assignment') await loadAssignmentAnalytics();
      else await loadQuizAnalytics();
    }

    // Exports
    // Helper to get analytics data for both modes
    async function getBothAnalytics(classId) {
      const quiz = await getJson(`${API_BASE}/api/teacher/quiz-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
      const assignment = await getJson(`${API_BASE}/api/teacher/assignment-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
      return { quiz, assignment };
    }

    function csvForAnalytics(mode, data, classLabel) {
      let csv = [];
      // Header
      csv.push('Class,View,Date');
      csv.push(`"${classLabel}","${mode}","${new Date().toLocaleDateString()}"`);
      // Summary
      if (mode === 'assignment') {
        csv.push('');
        csv.push('Summary');
        csv.push('Total Assignments,Average Assignment Score,On-time Rate,Modules Completed');
        csv.push(`"${data.summary?.totalAssignments ?? ''}","${data.summary?.averageAssignmentScore ?? ''}","${data.summary?.onTimeRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
      } else {
        csv.push('');
        csv.push('Summary');
        csv.push('Total Quizzes,Average Quiz Score,Pass Rate,Modules Completed');
        csv.push(`"${data.summary?.totalQuizzes ?? ''}","${data.summary?.averageQuizScore ?? ''}","${data.summary?.passRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
      }
      // Table
      csv.push('');
      csv.push('Students');
      if (mode === 'assignment') {
        csv.push('Student,ID,Avg Assignment Score,Assignments Submitted,On-time %,Modules Completed,Status');
        (data.progress || []).forEach(r => {
          csv.push(`"${r.name}","${r.studentId}","${r.avgAssignmentScore}","${r.assignmentsSubmitted}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
        });
      } else {
        csv.push('Student,ID,Avg Quiz Score,Quizzes Taken,On-time %,Modules Completed,Status');
        (data.progress || []).forEach(r => {
          csv.push(`"${r.name}","${r.studentId}","${r.avgQuizScore}","${r.quizzesTaken}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
        });
      }
      return csv.join('\r\n');
    }

    async function exportAllCsv() {
      try {
        const classId = classSelectEl.value || '';
        const classLabel = classSelectEl.options[classSelectEl.selectedIndex].text;
        const both = await getBothAnalytics(classId);
        let csv = [];
        csv.push(csvForAnalytics('quiz', both.quiz, classLabel));
        csv.push('');
        csv.push(csvForAnalytics('assignment', both.assignment, classLabel));
        // Download
        const blob = new Blob([csv.join('\r\n')], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `all_analytics_${classId||'all'}.csv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      } catch (e) {
        console.error(e);
        alert('CSV export failed.');
      }
    }

    async function downloadAllPdf() {
      try {
        // Load jsPDF and autoTable if not present
        if (typeof window.jspdf === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }
        if (typeof window.jspdf?.jsPDF === 'undefined') {
          alert('Failed to load jsPDF.');
          return;
        }
        if (typeof window.jspdf?.autoTable === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.0/dist/jspdf.plugin.autotable.min.js';
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }
        const classId = classSelectEl.value || '';
        const classLabel = classSelectEl.options[classSelectEl.selectedIndex].text;
        const both = await getBothAnalytics(classId);
        const doc = new window.jspdf.jsPDF();

        // Formal Header
        doc.setFont('times', 'bold');
        doc.setFontSize(18);
        doc.text('Class Analytics Report (Quiz & Assignment)', 105, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.setFont('times', 'normal');
        doc.text(`Class: ${classLabel}`, 20, 32);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 40);

        // Quiz Summary Table
        doc.setFont('times', 'bold');
        doc.text('Quiz Analytics', 20, 50);
        doc.setFont('times', 'normal');
        doc.autoTable({
          startY: 55,
          head: [['Total Quizzes', 'Average Quiz Score', 'Pass Rate', 'Modules Completed']],
          body: [[both.quiz.summary?.totalQuizzes ?? '', both.quiz.summary?.averageQuizScore ?? '', both.quiz.summary?.passRate ?? '', both.quiz.summary?.modulesCompleted ?? '']],
          theme: 'grid',
          styles: { font: 'times', fontSize: 11, halign: 'center' },
          headStyles: { fillColor: [255, 178, 0], textColor: 0 },
        });
        let y = doc.lastAutoTable.finalY + 8;
        doc.setFont('times', 'bold');
        doc.text('Students (Quiz)', 20, y);
        doc.setFont('times', 'normal');
        y += 2;
        doc.autoTable({
          startY: y,
          head: [['Student', 'ID', 'Avg Quiz Score', 'Quizzes Taken', 'On-time %', 'Modules Completed', 'Status']],
          body: (both.quiz.progress || []).map(r => [r.name, r.studentId, r.avgQuizScore, r.quizzesTaken, r.onTimePct, r.modulesCompleted, r.status]),
          theme: 'grid',
          styles: { font: 'times', fontSize: 10 },
          headStyles: { fillColor: [240,240,240], textColor: 0 },
        });
        y = doc.lastAutoTable.finalY + 8;

        // Assignment Summary Table
        doc.setFont('times', 'bold');
        doc.text('Assignment Analytics', 20, y);
        doc.setFont('times', 'normal');
        y += 2;
        doc.autoTable({
          startY: y,
          head: [['Total Assignments', 'Average Assignment Score', 'On-time Rate', 'Modules Completed']],
          body: [[both.assignment.summary?.totalAssignments ?? '', both.assignment.summary?.averageAssignmentScore ?? '', both.assignment.summary?.onTimeRate ?? '', both.assignment.summary?.modulesCompleted ?? '']],
          theme: 'grid',
          styles: { font: 'times', fontSize: 11, halign: 'center' },
          headStyles: { fillColor: [255, 178, 0], textColor: 0 },
        });
        y = doc.lastAutoTable.finalY + 8;
        doc.setFont('times', 'bold');
        doc.text('Students (Assignment)', 20, y);
        doc.setFont('times', 'normal');
        y += 2;
        doc.autoTable({
          startY: y,
          head: [['Student', 'ID', 'Avg Assignment Score', 'Assignments Submitted', 'On-time %', 'Modules Completed', 'Status']],
          body: (both.assignment.progress || []).map(r => [r.name, r.studentId, r.avgAssignmentScore, r.assignmentsSubmitted, r.onTimePct, r.modulesCompleted, r.status]),
          theme: 'grid',
          styles: { font: 'times', fontSize: 10 },
          headStyles: { fillColor: [240,240,240], textColor: 0 },
        });

        // Download
        doc.save(`all_analytics_${classId||'all'}.pdf`);
      } catch (e) {
        console.error(e);
        alert('PDF download failed.');
      }
    }
    // --- Formal PDF and CSV Export ---
    async function exportCsv() {
      try {
        const classId = classSelectEl.value || '';
        const mode = viewSelectEl.value;
        const base = mode === 'assignment' ? 'assignment-analytics' : 'quiz-analytics';
        // Get analytics data
        let data;
        if (mode === 'assignment') {
          data = await getJson(`${API_BASE}/api/teacher/assignment-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
        } else {
          data = await getJson(`${API_BASE}/api/teacher/quiz-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
        }
        let csv = [];
        // Header
        csv.push('Class,View,Date');
        csv.push(`"${classSelectEl.options[classSelectEl.selectedIndex].text}","${mode}","${new Date().toLocaleDateString()}"`);

        // Summary
        if (mode === 'assignment') {
          csv.push('');
          csv.push('Summary');
          csv.push('Total Assignments,Average Assignment Score,On-time Rate,Modules Completed');
          csv.push(`"${data.summary?.totalAssignments ?? ''}","${data.summary?.averageAssignmentScore ?? ''}","${data.summary?.onTimeRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
        } else {
          csv.push('');
          csv.push('Summary');
          csv.push('Total Quizzes,Average Quiz Score,Pass Rate,Modules Completed');
          csv.push(`"${data.summary?.totalQuizzes ?? ''}","${data.summary?.averageQuizScore ?? ''}","${data.summary?.passRate ?? ''}","${data.summary?.modulesCompleted ?? ''}"`);
        }

        // Table
        csv.push('');
        csv.push('Students');
        if (mode === 'assignment') {
          csv.push('Student,ID,Avg Assignment Score,Assignments Submitted,On-time %,Modules Completed,Status');
          (data.progress || []).forEach(r => {
            csv.push(`"${r.name}","${r.studentId}","${r.avgAssignmentScore}","${r.assignmentsSubmitted}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
          });
        } else {
          csv.push('Student,ID,Avg Quiz Score,Quizzes Taken,On-time %,Modules Completed,Status');
          (data.progress || []).forEach(r => {
            csv.push(`"${r.name}","${r.studentId}","${r.avgQuizScore}","${r.quizzesTaken}","${r.onTimePct}","${r.modulesCompleted}","${r.status}"`);
          });
        }

        // Download
        const blob = new Blob([csv.join('\r\n')], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${base}_${classId||'all'}.csv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      } catch (e) {
        console.error(e);
        alert('CSV export failed.');
      }
    }

    async function downloadPdf() {
      try {
        // Load jsPDF and autoTable if not present
        if (typeof window.jspdf === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }
        if (typeof window.jspdf?.jsPDF === 'undefined') {
          alert('Failed to load jsPDF.');
          return;
        }
        if (typeof window.jspdf?.autoTable === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.0/dist/jspdf.plugin.autotable.min.js';
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }

        const classId = classSelectEl.value || '';
        const mode = viewSelectEl.value;
        const base = mode === 'assignment' ? 'assignment-analytics' : 'quiz-analytics';
        // Get analytics data
        let data;
        if (mode === 'assignment') {
          data = await getJson(`${API_BASE}/api/teacher/assignment-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
        } else {
          data = await getJson(`${API_BASE}/api/teacher/quiz-analytics?teacherId=${teacherId}${classId?`&classId=${classId}`:''}`);
        }
        const doc = new window.jspdf.jsPDF();

        // Formal Header
        doc.setFont('times', 'bold');
        doc.setFontSize(18);
        doc.text('Class Analytics Report', 105, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.setFont('times', 'normal');
        doc.text(`Class: ${classSelectEl.options[classSelectEl.selectedIndex].text}`, 20, 32);
        doc.text(`View: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`, 20, 40);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 48);

        // Summary Table
        if (mode === 'assignment') {
          doc.autoTable({
            startY: 55,
            head: [['Total Assignments', 'Average Assignment Score', 'On-time Rate', 'Modules Completed']],
            body: [[data.summary?.totalAssignments ?? '', data.summary?.averageAssignmentScore ?? '', data.summary?.onTimeRate ?? '', data.summary?.modulesCompleted ?? '']],
            theme: 'grid',
            styles: { font: 'times', fontSize: 11, halign: 'center' },
            headStyles: { fillColor: [255, 178, 0], textColor: 0 },
          });
        } else {
          doc.autoTable({
            startY: 55,
            head: [['Total Quizzes', 'Average Quiz Score', 'Pass Rate', 'Modules Completed']],
            body: [[data.summary?.totalQuizzes ?? '', data.summary?.averageQuizScore ?? '', data.summary?.passRate ?? '', data.summary?.modulesCompleted ?? '']],
            theme: 'grid',
            styles: { font: 'times', fontSize: 11, halign: 'center' },
            headStyles: { fillColor: [255, 178, 0], textColor: 0 },
          });
        }

        let y = doc.lastAutoTable.finalY + 8;

        // Students Table
        doc.setFont('times', 'bold');
        doc.text('Students', 20, y);
        doc.setFont('times', 'normal');
        y += 2;
        if (mode === 'assignment') {
          doc.autoTable({
            startY: y,
            head: [['Student', 'ID', 'Avg Assignment Score', 'Assignments Submitted', 'On-time %', 'Modules Completed', 'Status']],
            body: (data.progress || []).map(r => [r.name, r.studentId, r.avgAssignmentScore, r.assignmentsSubmitted, r.onTimePct, r.modulesCompleted, r.status]),
            theme: 'grid',
            styles: { font: 'times', fontSize: 10 },
            headStyles: { fillColor: [240,240,240], textColor: 0 },
          });
        } else {
          doc.autoTable({
            startY: y,
            head: [['Student', 'ID', 'Avg Quiz Score', 'Quizzes Taken', 'On-time %', 'Modules Completed', 'Status']],
            body: (data.progress || []).map(r => [r.name, r.studentId, r.avgQuizScore, r.quizzesTaken, r.onTimePct, r.modulesCompleted, r.status]),
            theme: 'grid',
            styles: { font: 'times', fontSize: 10 },
            headStyles: { fillColor: [240,240,240], textColor: 0 },
          });
        }

        // Download
        doc.save(`${base}_${classId||'all'}.pdf`);
      } catch (e) {
        console.error(e);
        alert('PDF download failed.');
      }
    }

    // Events
  document.getElementById('exportCsvBtn').addEventListener('click',()=>exportCsv().catch(alert));
  document.getElementById('downloadPdfBtn').addEventListener('click',()=>downloadPdf().catch(alert));
  document.getElementById('exportAllCsvBtn').addEventListener('click',()=>exportAllCsv().catch(alert));
  document.getElementById('downloadAllPdfBtn').addEventListener('click',()=>downloadAllPdf().catch(alert));
    classSelectEl.addEventListener('change',()=>loadAnalyticsView().catch(alert));
    viewSelectEl.addEventListener('change',()=>{ setSortOptionsForMode(viewSelectEl.value); loadAnalyticsView().catch(alert); });
    refreshBtn.addEventListener('click',()=>loadAnalyticsView().catch(console.error));
    sortByEl.addEventListener('change', (e) => {
      SORT_BY = e.target.value;
      if (viewSelectEl.value === 'assignment') renderAssignmentTable(lastAssignmentProgress);
      else renderQuizTable(lastQuizProgress);
    });

    // Delegate clicks for "View Analytics"
    document.getElementById('atRiskTable').addEventListener('click', (e)=>{
      const btn = e.target.closest('.view-analytics');
      if (!btn) return;
      const student = btn.dataset.student;
      if (student) {
        window.location.href = `/TEACHER/analytics/student.html?student=${student}&teacherId=${teacherId}`;
      }
    });

    // Init
    (async ()=>{ await loadClasses(); setSortOptionsForMode('quiz'); await loadAnalyticsView(); })();
  </script>
</body>
</html>
