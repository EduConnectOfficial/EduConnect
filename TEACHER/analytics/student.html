<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Student Analytics</title>

  <!-- OPTIONAL: set this if your API is a separate Railway service -->
  <!-- <meta name="api-base" content="https://your-backend.up.railway.app"> -->

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Global & Page CSS -->
  <link rel="stylesheet" href="../analytics/analytics.css" />
  <style>
    .chart-wrapper{position:relative;height:240px}
    .metric{font-size:1.05rem;font-weight:600}
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input type="text" class="form-control" placeholder="Search..." />
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <section class="content px-4">
        <div class="d-flex align-items-center justify-content-between mt-3 mb-3">
          <h1 class="page-title">Student Analytics</h1>
          <div class="d-flex flex-wrap align-items-end gap-2">
            <!-- Course filter -->
            <div class="me-2" style="min-width:260px">
              <label for="courseFilter" class="form-label mb-1">Course</label>
              <select id="courseFilter" class="form-select form-select-sm" disabled>
                <option value="">Loading courses…</option>
              </select>
            </div>

            <a href="./analytics.html" class="btn btn-outline-secondary">
              <i class="fa fa-arrow-left me-1"></i> Back to Analytics
            </a>
            <button id="exportCsvBtn" class="btn btn-outline-primary">
              <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
            </button>
            <button id="downloadPdfBtn" class="btn btn-outline-secondary">
              <i class="bi bi-file-earmark-pdf"></i> Download PDF
            </button>
          </div>
        </div>

        <!-- Header metrics -->
        <div class="card p-3 mb-3">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <div><span class="text-muted">Student</span>
                <div id="s_name" class="metric">—</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Student ID</span>
                <div id="s_id" class="metric">—</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Avg Quiz</span>
                <div id="s_avg_quiz" class="metric">—</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Avg Assignment</span>
                <div id="s_avg_asg" class="metric">—</div>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Modules Completed</span>
                <div id="s_modules" class="metric">—</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <!-- Quizzes -->
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Quizzes (Best % per Quiz)</h5>
              <div class="chart-wrapper"><canvas id="quizChart"></canvas></div>
              <div class="table-responsive mt-3">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr>
                      <th>Quiz</th><th>Best %</th><th>Attempts</th><th>Last Attempt</th>
                    </tr>
                  </thead>
                  <tbody id="quizTbody">
                    <tr><td colspan="4" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Assignments -->
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Assignments</h5>
              <div class="chart-wrapper"><canvas id="assignChart"></canvas></div>
              <div class="table-responsive mt-3">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>Assignment</th><th>Grade</th><th>Graded At</th></tr>
                  </thead>
                  <tbody id="assignTbody">
                    <tr><td colspan="3" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Essays -->
          <div class="col-md-12">
            <div class="card p-3">
              <h5 class="mb-2">Essay Submissions</h5>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr>
                      <th>Quiz</th><th>Question #</th><th>Status</th><th>Score</th><th>Submitted</th>
                    </tr>
                  </thead>
                  <tbody id="essayTbody">
                    <tr><td colspan="5" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Modules -->
          <div class="col-md-12">
            <div class="card p-3">
              <h5 class="mb-2">Completed Modules</h5>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>Course</th><th>Module</th><th>Percent</th><th>Completed At</th></tr>
                  </thead>
                  <tbody id="modTbody">
                    <tr><td colspan="4" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </section>
    </div>
  </div>

  <!-- App Alert Modal -->
  <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div id="appAlertHeader" class="modal-header">
          <h5 class="modal-title" id="appAlertTitle">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="appAlertBody" class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert helper -->
  <script>
    function showAppAlert(message, { title = "Notice", variant = "primary", closeOtherModals = true } = {}) {
      const header = document.getElementById("appAlertHeader");
      const titleEl = document.getElementById("appAlertTitle");
      const bodyEl = document.getElementById("appAlertBody");
      const alertEl = document.getElementById("appAlertModal");

      header.className = "modal-header";
      const bg = {
        primary: "bg-primary text-white", success: "bg-success text-white",
        danger: "bg-danger text-white", warning: "bg-warning",
        info: "bg-info", secondary: "bg-secondary text-white",
        dark: "bg-dark text-white", light: "bg-light"
      }[variant] || "bg-primary text-white";
      header.classList.add(...bg.split(" "));
      titleEl.textContent = title;
      bodyEl.textContent = message;

      if (closeOtherModals) {
        document.querySelectorAll(".modal.show").forEach(m => {
          if (m.id !== "appAlertModal") {
            const inst = bootstrap.Modal.getInstance(m);
            if (inst) inst.hide();
          }
        });
      }
      bootstrap.Modal.getOrCreateInstance(alertEl).show();
    }
  </script>

  <!-- Robust initials + auth gate -->
  <script>
    (function initHeaderInitials() {
      try {
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        const u = stored.user || stored;
        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return;
        }
        window.currentUser = u;

        const initials = getInitials(u);
        window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("Username");
          if (!el) return;
          el.textContent = initials;
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username || u.email || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        });
      } catch (e) {
        console.error('initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
      }
      function getInitials(u) {
        const fn = (u.firstName || '').trim();
        const ln = (u.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
            .split(/[\s._-]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }
        const em = (u.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();
  </script>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(() => { /* sidebar optional */ });
    });
  </script>

  <!-- Chart.js + Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Page Scripts -->
 <script>
  /* ===== Railway-friendly API resolver ===== */
  function resolveApiBase() {
    const meta = document.querySelector('meta[name="api-base"]');
    if (meta && meta.content) return meta.content.replace(/\/+$/, '');
    if (window.__API_BASE__) return String(window.__API_BASE__).replace(/\/+$/, '');
    const host = location.hostname;
    if (host === 'localhost' || host === '127.0.0.1') return 'http://127.0.0.1:5000';
    // same-origin by default in production (Railway reverse proxy / server routes)
    return '';
  }
  const API_BASE = resolveApiBase();
  const api = (path) => `${API_BASE}${path}`;

  // ---- Auth guard + username display ----
  (function () {
    const stored = JSON.parse(localStorage.getItem('user') || '{}');
    const u = stored.user || stored;

    if (!u?.userId || !u?.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
      return;
    }

    window.currentUser = u;

    const displayName = (u.username || 'Teacher').toString().trim();
    const nameEl = document.getElementById('Username');
    if (nameEl) nameEl.textContent = displayName;
  })();

  // Resolve teacher & student from URL / storage
  const qs = new URLSearchParams(location.search);
  const teacherId =
    qs.get('teacherId') ||
    (window.currentUser && window.currentUser.userId) ||
    localStorage.getItem('teacherId') ||
    '';

  const studentKey =
    qs.get('student') ||
    qs.get('studentId') ||
    qs.get('userId') ||
    '';

  // ---------- utils ----------
  async function getJson(pathOrUrl) {
    const url = pathOrUrl.startsWith('http') ? pathOrUrl : api(pathOrUrl);
    const res = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
    if (!res.ok) {
      const body = await res.text().catch(() => '');
      throw new Error(`GET ${url} -> HTTP ${res.status} — ${body.slice(0, 200)}`);
    }
    return res.json();
  }
  async function tryJson(u) { try { return await getJson(u); } catch { return null; } }

  const el  = (id) => document.getElementById(id);
  const pct = (n) => Number.isFinite(Number(n)) ? `${Math.round(Number(n))}%` : '—';
  const normId = v => String(v ?? '').trim();
  function dt(ts) {
    if (!ts) return '—';
    const ms = ts?._seconds ? ts._seconds * 1000 : (typeof ts === 'number' ? ts : Date.parse(ts));
    if (!Number.isFinite(ms)) return '—';
    return new Date(ms).toLocaleString();
  }

  // ---- NEW: consistent percent for assignments ----
  function calcAssignPercent(a) {
    const p = Number(a?.percent);
    if (Number.isFinite(p)) return p;

    const grade = Number(a?.grade);
    const max =
      Number(a?.maxPoints ?? a?.points ?? a?.assignmentMaxPoints ?? a?.totalPoints);

    if (Number.isFinite(grade) && Number.isFinite(max) && max > 0) {
      return (grade / max) * 100;
    }

    if (Number.isFinite(grade) && grade <= 1) return grade * 100;
    if (Number.isFinite(grade) && grade <= 100) return grade;
    return 0;
  }

  // ---------- charts ----------
  let charts = { quiz: null, assign: null };
  function destroyChart(key) { if (charts[key]?.destroy) charts[key].destroy(); charts[key] = null; }
  function renderBar(key, canvasId, labels, values, datasetLabel) {
    const ctx = document.getElementById(canvasId);
    destroyChart(key);
    charts[key] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: datasetLabel, data: values }] },
      options: {
        responsive: true, maintainAspectRatio: false, resizeDelay: 150,
        animation: { duration: 200 }, plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true, suggestedMax: 100, ticks: { stepSize: 20 } } }
      }
    });
  }

  // ---------- courses ----------
  let COURSES = [];
  let TITLE_TO_ID = {};
  let selectedCourseId = '';

  async function loadCourses() {
    // normalized to /api/courses
    const payload = await tryJson(`/api/courses?uploadedBy=${encodeURIComponent(teacherId)}&includeArchived=false`);
    const arr = Array.isArray(payload) ? payload : (payload?.courses || []);
    const sel = el('courseFilter');

    if (!Array.isArray(arr) || !arr.length) {
      sel.innerHTML = `<option value="">No courses</option>`;
      sel.disabled = true;
      return;
    }

    COURSES = arr
      .map(c => ({
        _id: normId(c.id || c.courseId || c.courseID),
        title: c.title || (c.courseNumber ? `Course ${c.courseNumber}` : 'Untitled Course'),
        courseNumber: c.courseNumber || 0,
        archived: !!c.archived
      }))
      .filter(c => c._id && !c.archived);

    TITLE_TO_ID = {};
    COURSES.forEach(c => { TITLE_TO_ID[c.title.trim().toLowerCase()] = c._id; });

    sel.innerHTML = [
      `<option value="">All Courses</option>`,
      ...COURSES
        .sort((a, b) => (a.courseNumber - b.courseNumber) || a.title.localeCompare(b.title))
        .map(c => `<option value="${c._id}">${c.courseNumber ? `#${c.courseNumber} — ` : ''}${c.title}</option>`)
    ].join('');
    sel.disabled = false;

    const qsCourse = qs.get('courseId') || qs.get('course');
    if (qsCourse) {
      const chosen = COURSES.find(c => c._id === qsCourse) ||
                     COURSES.find(c => c.title.trim().toLowerCase() === String(qsCourse).trim().toLowerCase());
      if (chosen) { selectedCourseId = chosen._id; sel.value = chosen._id; }
    }
  }

  // ---------- helpers for course filtering ----------
  function courseIdFromAny(x) {
    return normId(
      x?.courseId ||
      x?.courseID ||
      x?.quizCourseId ||
      x?.quiz?.courseId ||
      x?.assignment?.courseId ||
      (x?.courseTitle && TITLE_TO_ID[x.courseTitle.trim().toLowerCase()]) ||
      ''
    );
  }
  function filterBySelectedCourse(rows) {
    const wanted = normId(selectedCourseId);
    if (!wanted) return rows || [];
    return (rows || []).filter(r => courseIdFromAny(r) === wanted);
  }

  // ---------- BASE analytics (teacher) ----------
  async function fetchHeaderAndBase() {
    const params = new URLSearchParams({ teacherId, student: studentKey });
    if (selectedCourseId) params.set('courseId', selectedCourseId);
    return await tryJson(`/api/teacher/student-analytics?${params.toString()}`);
  }

  // ---------- Student analytics fallback ----------
  async function fetchStudentAnalyticsFallback() {
    return await tryJson(`/api/student/analytics?student=${encodeURIComponent(studentKey)}`);
  }

  // ---------- REAL quiz analytics ----------
  async function fetchQuizRowsReal() {
    const params = new URLSearchParams({ teacherId, student: studentKey });
    if (selectedCourseId) params.set('courseId', selectedCourseId);
    const data = await tryJson(`/api/teacher/student-quiz-analytics?${params.toString()}`);

    const rows = Array.isArray(data?.quizzes?.rows) ? data.quizzes.rows : [];
    return rows.map(r => ({
      quizId: normId(r.quizId || r.id),
      title: r.title || r.quizTitle || r.quizId || 'Quiz',
      bestPercent: Number(r.bestPercent ?? r.best ?? r.percent ?? r.bestScorePct) || null,
      attemptsUsed: Number(r.attemptsUsed ?? r.attempts ?? r.count) || 0,
      lastSubmittedAt: r.lastSubmittedAt || r.submittedAt || r.lastAttemptAt || null,
      courseId: normId(r.courseId || r.quiz?.courseId || '')
    }));
  }

  // ---------- Fallback quiz analytics (legacy flow) ----------
  const QUIZ_DETAIL_CACHE = new Map();
  async function getQuizCourseId(q) {
    const inline = normId(q.courseId);
    if (inline) return inline;
    const qid = normId(q.id || q.quizId || q.quizID);
    if (!qid) return '';
    if (QUIZ_DETAIL_CACHE.has(qid)) return QUIZ_DETAIL_CACHE.get(qid);
    try {
      const detail = await getJson(`/api/quizzes/${encodeURIComponent(qid)}`);
      const cid = normId(detail?.quiz?.courseId);
      QUIZ_DETAIL_CACHE.set(qid, cid);
      return cid;
    } catch { QUIZ_DETAIL_CACHE.set(qid, ''); return ''; }
  }

  async function fetchQuizzesEnrichedFallback() {
    const data = await tryJson(`/api/quizzes?forStudent=${encodeURIComponent(studentKey)}&includeArchived=false`);
    const allQuizzes = Array.isArray(data?.quizzes) ? data.quizzes : [];
    const enriched = await Promise.all(allQuizzes.map(async q => {
      const courseId = await getQuizCourseId(q);
      return { ...q, courseId };
    }));

    const wanted = normId(selectedCourseId);
    const quizzes = wanted ? enriched.filter(q => normId(q.courseId) === wanted) : enriched;

    if (!quizzes.length) return [];

    const rows = await Promise.all(quizzes.map(async q => {
      const qid = q.id;
      const title = q.title || qid;
      let attempts = 0;
      let bestPercent = null;
      let lastSubmittedAt = null;

      try {
        const r = await getJson(`/api/students/${encodeURIComponent(studentKey)}/quiz-results?quizId=${encodeURIComponent(qid)}`);
        const arr = Array.isArray(r?.attempts) ? r.attempts : [];
        attempts = arr.length;
        if (r?.best && Number.isFinite(Number(r.best.percent))) bestPercent = Number(r.best.percent);
        if (r?.latest?.submittedAt) lastSubmittedAt = r.latest.submittedAt;
      } catch {}

      return { quizId: qid, title, courseId: q.courseId, bestPercent, attemptsUsed: attempts, lastSubmittedAt };
    }));

    return rows;
  }

  // ---------- renderers ----------
  function renderHeader(base) {
    if (base?.profile) {
      el('s_name').textContent = base.profile?.name || 'Student';
      el('s_id').textContent   = base.profile?.studentId || '—';
    }
    el('s_avg_quiz').textContent = pct(base?.summary?.averageQuizScore);
    el('s_avg_asg').textContent  = pct(base?.summary?.averageAssignmentGrade);
    el('s_modules').textContent =
      (base?.summary?.modulesCompleted != null && base?.summary?.totalModules != null)
        ? `${base.summary.modulesCompleted}/${base.summary.totalModules}`
        : (base?.summary?.modulesCompleted ?? '—');
  }

  function renderQuizzes(rows) {
    if (!rows.length) {
      el('quizTbody').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No quiz data</td></tr>';
      destroyChart('quiz');
      return;
    }
    el('quizTbody').innerHTML = rows.map(r => `
      <tr>
        <td>${r.title || r.quizId}</td>
        <td>${pct(r.bestPercent)}</td>
        <td>${r.attemptsUsed ?? 0}</td>
        <td>${dt(r.lastSubmittedAt)}</td>
      </tr>
    `).join('');

    renderBar(
      'quiz',
      'quizChart',
      rows.map(r => r.title || r.quizId),
      rows.map(r => Number(r.bestPercent) || 0),
      'Best %'
    );
  }

  function renderAssignments(base) {
    const all = base?.assignments?.grades || [];
    const arows = filterBySelectedCourse(all);

    if (!arows.length) {
      el('assignTbody').innerHTML = '<tr><td colspan="3" class="text-center text-muted">No assignments</td></tr>';
      destroyChart('assign');
      return;
    }

    const rows = arows.map(a => ({ ...a, _percent: calcAssignPercent(a) }));

    el('assignTbody').innerHTML = rows.map(a => `
      <tr>
        <td>${a.assignmentTitle || a.assignmentId}</td>
        <td>${pct(a._percent)}</td>
        <td>${dt(a.gradedAt)}</td>
      </tr>
    `).join('');

    renderBar(
      'assign',
      'assignChart',
      rows.map(a => a.assignmentTitle || a.assignmentId),
      rows.map(a => Number(a._percent) || 0),
      'Grade %'
    );
  }

  function renderEssaysFrom(baseLike) {
    const all = baseLike?.essays?.submissions || [];
    const erows = filterBySelectedCourse(all);

    el('essayTbody').innerHTML = erows.length
      ? erows.map(e => `
        <tr>
          <td>${e.quizTitle || e.quizId}</td>
          <td>${e.questionIndex != null ? e.questionIndex + 1 : '—'}</td>
          <td>${(e.status || 'pending').toUpperCase()}</td>
          <td>${e.score != null ? (e.score + '/' + (e.maxScore ?? 10)) : '—'}</td>
          <td>${dt(e.createdAt)}</td>
        </tr>
      `).join('')
      : '<tr><td colspan="5" class="text-center text-muted">No essay submissions</td></tr>';
  }

  function renderModulesFrom(baseLike) {
    const all = baseLike?.modules?.completed || [];
    const mrows = filterBySelectedCourse(all);

    el('modTbody').innerHTML = mrows.length
      ? mrows.map(m => `
        <tr>
          <td>${m.courseTitle || m.courseId || ''}</td>
          <td>${m.moduleTitle || m.moduleId || ''}</td>
          <td>${pct(m.percent)}</td>
          <td>${dt(m.completedAt)}</td>
        </tr>
      `).join('')
      : '<tr><td colspan="4" class="text-center text-muted">No modules</td></tr>';
  }

  // ---------- helpers ----------
  function computeAvgQuizFromRows(rows) {
    const vals = (rows || []).map(r => Number(r.bestPercent)).filter(n => Number.isFinite(n));
    if (!vals.length) return null;
    const avg = Math.round(vals.reduce((s,n)=>s+n,0) / vals.length);
    return avg;
  }

  // ---------- load pipeline ----------
  async function loadAll() {
    if (!teacherId || !studentKey) { showAppAlert('Missing teacherId or student id in URL.'); return; }

    // 1) Teacher base
    const base = await fetchHeaderAndBase();
    renderHeader(base || {});
    renderAssignments(base || {});
    renderEssaysFrom(base || {});
    renderModulesFrom(base || {});

    // 2) Quizzes — try REAL endpoint first, fallback to legacy
    el('quizTbody').innerHTML = '<tr><td colspan="4" class="text-muted text-center">Loading…</td></tr>';
    let quizRows = await fetchQuizRowsReal();
    if (!quizRows.length) {
      quizRows = await fetchQuizzesEnrichedFallback();
    }
    renderQuizzes(quizRows);

    // 2a) Patch avg quiz if needed
    const computedAvgQuiz = computeAvgQuizFromRows(quizRows);
    if (computedAvgQuiz != null) {
      el('s_avg_quiz').textContent = pct(computedAvgQuiz);
    }

    // 3) Fallback for essays/modules & header modules summary
    const needFallbackEssays = !(base?.essays?.submissions && base.essays.submissions.length);
    const needFallbackModules = !(base?.modules?.completed && base.modules.completed.length);
    const missingModulesSummary = !(Number.isFinite(+base?.summary?.modulesCompleted) && Number.isFinite(+base?.summary?.totalModules));

    if (needFallbackEssays || needFallbackModules || missingModulesSummary) {
      const studentData = await fetchStudentAnalyticsFallback();

      if (studentData) {
        if (needFallbackEssays) {
          renderEssaysFrom(studentData);
        }
        if (needFallbackModules) {
          renderModulesFrom(studentData);
        }
        if (missingModulesSummary) {
          const mc = studentData?.summary?.modulesCompleted;
          const tm = studentData?.summary?.totalModules;
          if (mc != null && tm != null) {
            el('s_modules').textContent = `${mc}/${tm}`;
          } else if (mc != null) {
            el('s_modules').textContent = `${mc}`;
          }
        }
        if (!Number.isFinite(+base?.summary?.averageAssignmentGrade) && Number.isFinite(+studentData?.summary?.averageAssignmentGrade)) {
          el('s_avg_asg').textContent = pct(studentData.summary.averageAssignmentGrade);
        }
        if ((el('s_avg_quiz').textContent || '—') === '—' && Number.isFinite(+studentData?.summary?.averageQuizScore)) {
          el('s_avg_quiz').textContent = pct(studentData.summary.averageQuizScore);
        }
      }
    }
  }

  // ---------- CSV ----------
  async function exportCsv() {
    try {
      const base = await fetchHeaderAndBase();

      let quizRows = await fetchQuizRowsReal();
      if (!quizRows.length) quizRows = await fetchQuizzesEnrichedFallback();

      let studentData = null;
      if (!(base?.essays?.submissions?.length) || !(base?.modules?.completed?.length)) {
        studentData = await fetchStudentAnalyticsFallback();
      }

      const arows = filterBySelectedCourse(base?.assignments?.grades || []);
      const erows = filterBySelectedCourse(
        (base?.essays?.submissions?.length ? base.essays.submissions : (studentData?.essays?.submissions || []))
      );
      const mrows = filterBySelectedCourse(
        (base?.modules?.completed?.length ? base.modules.completed : (studentData?.modules?.completed || []))
      );

      let csv = [];
      const computedAvgQuiz = computeAvgQuizFromRows(quizRows);
      const avgQuizText = pct( (Number.isFinite(+base?.summary?.averageQuizScore) ? base.summary.averageQuizScore : computedAvgQuiz) );
      const avgAsgText  = pct(base?.summary?.averageAssignmentGrade);
      const modulesText =
        (base?.summary?.modulesCompleted != null && base?.summary?.totalModules != null)
          ? `${base.summary.modulesCompleted}/${base.summary.totalModules}`
          : (studentData?.summary?.modulesCompleted != null && studentData?.summary?.totalModules != null)
            ? `${studentData.summary.modulesCompleted}/${studentData.summary.totalModules}`
            : '—';

      csv.push('Student Name,Student ID,Avg Quiz %,Avg Assignment %,Modules Completed');
      csv.push(`"${el('s_name').textContent}","${el('s_id').textContent}","${avgQuizText}","${avgAsgText}","${modulesText}"`);

      csv.push('');
      csv.push('Quizzes');
      csv.push('Quiz,Best %,Attempts,Last Attempt');
      (quizRows || []).forEach(r => {
        csv.push(`"${r.title || r.quizId}","${pct(r.bestPercent)}","${r.attemptsUsed ?? 0}","${dt(r.lastSubmittedAt)}"`);
      });

      csv.push('');
      csv.push('Assignments');
      csv.push('Assignment,Grade,Graded At');
      arows.forEach(a => {
        const ap = calcAssignPercent(a);
        csv.push(`"${a.assignmentTitle || a.assignmentId}","${pct(ap)}","${dt(a.gradedAt)}"`);
      });

      csv.push('');
      csv.push('Essay Submissions');
      csv.push('Quiz,Question #,Status,Score,Submitted');
      erows.forEach(e => csv.push(`"${e.quizTitle || e.quizId}","${e.questionIndex != null ? (e.questionIndex + 1) : ''}","${(e.status || 'pending').toUpperCase()}","${e.score != null ? `${e.score}/${e.maxScore ?? 10}` : ''}","${dt(e.createdAt)}"`));

      csv.push('');
      csv.push('Completed Modules');
      csv.push('Course,Module,Percent,Completed At');
      mrows.forEach(m => csv.push(`"${m.courseTitle || m.courseId || ''}","${m.moduleTitle || m.moduleId || ''}","${pct(m.percent)}","${dt(m.completedAt)}"`));

      const blob = new Blob([csv.join('\r\n')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `student_analytics_${base?.profile?.studentId || 'student'}${selectedCourseId ? ('_course_' + selectedCourseId) : ''}.csv`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    } catch (e) { console.error(e); showAppAlert('CSV export failed.'); }
  }

  // ---------- PDF ----------
  async function downloadPdf() {
    try {
      if (typeof window.jspdf === 'undefined') {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
          s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
        });
      }
      if (typeof window.jspdf?.jsPDF === 'undefined') { showAppAlert('Failed to load jsPDF.'); return; }
      if (typeof window.jspdf?.autoTable === 'undefined') {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.0/dist/jspdf.plugin.autotable.min.js';
          s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
        });
      }

      const base = await fetchHeaderAndBase();

      let quizRows = await fetchQuizRowsReal();
      if (!quizRows.length) quizRows = await fetchQuizzesEnrichedFallback();

      let studentData = null;
      const needFallbackEssays = !(base?.essays?.submissions && base.essays.submissions.length);
      const needFallbackModules = !(base?.modules?.completed && base.modules.completed.length);
      if (needFallbackEssays || needFallbackModules) {
        studentData = await fetchStudentAnalyticsFallback();
      }

      const arows = filterBySelectedCourse(base?.assignments?.grades || []);
      const erows = filterBySelectedCourse(
        (base?.essays?.submissions?.length ? base.essays.submissions : (studentData?.essays?.submissions || []))
      );
      const mrows = filterBySelectedCourse(
        (base?.modules?.completed?.length ? base.modules.completed : (studentData?.modules?.completed || []))
      );

      const doc = new window.jspdf.jsPDF();
      doc.setFont('times', 'bold'); doc.setFontSize(18);
      doc.text('Student Analytics Report', 105, 20, { align: 'center' });
      doc.setFontSize(12); doc.setFont('times', 'normal');
      doc.text(`Name: ${el('s_name').textContent}`, 20, 32);
      doc.text(`Student ID: ${el('s_id').textContent}`, 20, 40);
      if (selectedCourseId) doc.text(`Course: ${selectedCourseId}`, 20, 48);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 56);

      const computedAvgQuiz = computeAvgQuizFromRows(quizRows);
      const avgQuizVal = Number.isFinite(+base?.summary?.averageQuizScore) ? base.summary.averageQuizScore
                       : (Number.isFinite(+computedAvgQuiz) ? computedAvgQuiz : null);
      const avgAsgVal  = Number.isFinite(+base?.summary?.averageAssignmentGrade) ? base.summary.averageAssignmentGrade : null;

      const mc = (base?.summary?.modulesCompleted != null ? base.summary.modulesCompleted : studentData?.summary?.modulesCompleted);
      const tm = (base?.summary?.totalModules != null ? base.summary.totalModules : studentData?.summary?.totalModules);

      doc.autoTable({
        startY: 63,
        head: [['Avg Quiz %', 'Avg Assignment %', 'Modules Completed']],
        body: [[pct(avgQuizVal), pct(avgAsgVal), (mc != null && tm != null) ? `${mc}/${tm}` : '—']],
        theme: 'grid',
        styles: { font: 'times', fontSize: 11, halign: 'center' },
        headStyles: { fillColor: [255, 178, 0], textColor: 0 }
      });
      let y = doc.lastAutoTable.finalY + 8;

      doc.setFont('times', 'bold'); doc.text('Quizzes', 20, y); y += 2; doc.setFont('times', 'normal');
      doc.autoTable({
        startY: y,
        head: [['Quiz', 'Best %', 'Attempts', 'Last Attempt']],
        body: (quizRows || []).map(r => [r.title || r.quizId, pct(r.bestPercent), r.attemptsUsed ?? 0, dt(r.lastSubmittedAt)]),
        theme: 'grid', styles: { font: 'times', fontSize: 10 },
        headStyles: { fillColor: [240, 240, 240], textColor: 0 }
      });
      y = doc.lastAutoTable.finalY + 8;

      doc.setFont('times', 'bold'); doc.text('Assignments', 20, y); y += 2; doc.setFont('times', 'normal');
      doc.autoTable({
        startY: y,
        head: [['Assignment', 'Grade', 'Graded At']],
        body: arows.map(a => [a.assignmentTitle || a.assignmentId, pct(calcAssignPercent(a)), dt(a.gradedAt)]),
        theme: 'grid', styles: { font: 'times', fontSize: 10 },
        headStyles: { fillColor: [240, 240, 240], textColor: 0 }
      });
      y = doc.lastAutoTable.finalY + 8;

      doc.setFont('times', 'bold'); doc.text('Essay Submissions', 20, y); y += 2; doc.setFont('times', 'normal');
      doc.autoTable({
        startY: y,
        head: [['Quiz', 'Question #', 'Status', 'Score', 'Submitted']],
        body: erows.map(e => [e.quizTitle || e.quizId, e.questionIndex != null ? e.questionIndex + 1 : '', (e.status || 'pending').toUpperCase(), e.score != null ? `${e.score}/${e.maxScore ?? 10}` : '', dt(e.createdAt)]),
        theme: 'grid', styles: { font: 'times', fontSize: 10 },
        headStyles: { fillColor: [240, 240, 240], textColor: 0 }
      });
      y = doc.lastAutoTable.finalY + 8;

      doc.setFont('times', 'bold'); doc.text('Completed Modules', 20, y); y += 2; doc.setFont('times', 'normal');
      doc.autoTable({
        startY: y,
        head: [['Course', 'Module', 'Percent', 'Completed At']],
        body: mrows.map(m => [m.courseTitle || m.courseId || '', m.moduleTitle || m.moduleId || '', pct(m.percent), dt(m.completedAt)]),
        theme: 'grid', styles: { font: 'times', fontSize: 10 },
        headStyles: { fillColor: [240, 240, 240], textColor: 0 }
      });

      doc.save(`student_analytics_${base?.profile?.studentId || 'student'}${selectedCourseId ? ('_course_' + selectedCourseId) : ''}.pdf`);
    } catch (e) { console.error(e); showAppAlert('PDF download failed.'); }
  }

  // ---------- events ----------
  document.getElementById('exportCsvBtn').addEventListener('click', () => exportCsv());
  document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadPdf());
  document.getElementById('courseFilter').addEventListener('change', async (e) => {
    selectedCourseId = (e.target.value || '').trim();
    try { await loadAll(); } catch (err) {
      console.error(err);
      showAppAlert('Failed to load student analytics for selected course.');
    }
  });

  // ---------- boot ----------
  (async () => {
    try { await loadCourses(); } catch (e) { console.error('loadCourses failed:', e); }
    await loadAll().catch(err => { console.error(err); showAppAlert('Failed to load student analytics.'); });
  })();

  // ---------- cleanup ----------
  window.addEventListener('beforeunload', () => { destroyChart('quiz'); destroyChart('assign'); });
  function logoutUser() { localStorage.clear(); sessionStorage.clear(); window.location.href = "/TEACHER/login/login.html"; }
</script>
  
</body>
</html>
