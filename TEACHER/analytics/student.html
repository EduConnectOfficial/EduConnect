<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Teacher - Student Analytics</title>

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Global & Page CSS -->
  <link rel="stylesheet" href="../dashboard/dashboard.css"/>
  <style>
    body { background:#f6f8fb; }
    .card { border:none; box-shadow:0 1px 8px rgba(0,0,0,.06); border-radius:14px; }
    .metric { font-size:1.25rem; font-weight:600; }
    .table td, .table th { vertical-align:middle; }
    /* FIXED chart size */
    .chart-wrapper { position: relative; width: 100%; height: 300px; }
    .chart-wrapper canvas { max-height: 100% !important; }
    .page-title { margin: 0; font-weight: 700; }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header"/>
        <div class="search-box position-relative">
          <input type="text" class="form-control" placeholder="Search..."/>
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <section class="content px-4">
        <div class="d-flex align-items-center justify-content-between mt-3 mb-3">
          <h1 class="page-title">Student Analytics</h1>
          <a href="./analytics.html" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left me-1"></i> Back to Analytics
          </a>
        </div>

        <!-- Header metrics -->
        <div class="card p-3 mb-3">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <div><span class="text-muted">Student</span><div id="s_name" class="metric">—</div></div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Student ID</span><div id="s_id" class="metric">—</div></div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Avg Quiz</span><div id="s_avg_quiz" class="metric">—</div></div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Avg Assignment</span><div id="s_avg_asg" class="metric">—</div></div>
            </div>
            <div class="col-6 col-md-2">
              <div><span class="text-muted">Modules Completed</span><div id="s_modules" class="metric">—</div></div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <!-- Quizzes -->
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Quizzes (Best % per Quiz)</h5>
              <div class="chart-wrapper">
                <canvas id="quizChart"></canvas>
              </div>
              <div class="table-responsive mt-3">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>Quiz</th><th>Best %</th><th>Attempts</th><th>Last Attempt</th></tr>
                  </thead>
                  <tbody id="quizTbody">
                    <tr><td colspan="4" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Assignments -->
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Assignments</h5>
              <div class="chart-wrapper">
                <canvas id="assignChart"></canvas>
              </div>
              <div class="table-responsive mt-3">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>Assignment</th><th>Grade</th><th>Graded At</th></tr>
                  </thead>
                  <tbody id="assignTbody">
                    <tr><td colspan="3" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Essays -->
          <div class="col-md-12">
            <div class="card p-3">
              <h5 class="mb-2">Essay Submissions</h5>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>Quiz</th><th>Question #</th><th>Status</th><th>Score</th><th>Submitted</th></tr>
                  </thead>
                  <tbody id="essayTbody">
                    <tr><td colspan="5" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Modules -->
          <div class="col-md-12">
            <div class="card p-3">
              <h5 class="mb-2">Completed Modules</h5>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead class="table-light">
                    <tr><th>Course</th><th>Module</th><th>Percent</th><th>Completed At</th></tr>
                  </thead>
                  <tbody id="modTbody">
                    <tr><td colspan="4" class="text-muted text-center">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </section>
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(() => { /* sidebar optional */ });
    });
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Page Scripts -->
  <script>
    // ===== Config =====
    const API_BASE = 'http://localhost:5000';

    // ---- Auth guard + username display ----
    (function () {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;

      if (!u?.userId || !u?.isTeacher) {
        window.location.href = "/TEACHER/login/login.html";
        return;
      }

      window.currentUser = u;

      const displayName = (u.username || 'Teacher').toString().trim();
      const nameEl = document.getElementById('Username');
      if (nameEl) nameEl.textContent = displayName;
    })();

    // Resolve teacher & student from URL / storage
    const qs = new URLSearchParams(location.search);
    const teacherId =
      qs.get('teacherId') ||
      (window.currentUser && window.currentUser.userId) ||
      localStorage.getItem('teacherId') ||
      '';

    const studentKey =
      qs.get('student') ||
      qs.get('studentId') ||
      qs.get('userId') ||
      '';

    // Helpers
    async function getJson(url) {
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
      if (!res.ok) {
        const body = await res.text().catch(() => '');
        throw new Error(`GET ${url} -> HTTP ${res.status} — ${body.slice(0, 200)}`);
      }
      return res.json();
    }

    const el = (id) => document.getElementById(id);
    const pct = (n) => Number.isFinite(Number(n)) ? `${Math.round(Number(n))}%` : '—';
    function dt(ts) {
      if (!ts) return '—';
      const ms = ts?._seconds ? ts._seconds * 1000 : (typeof ts === 'number' ? ts : Date.parse(ts));
      if (!Number.isFinite(ms)) return '—';
      return new Date(ms).toLocaleString();
    }

    // Chart instances (so we can destroy safely)
    let charts = { quiz: null, assign: null };

    function destroyChart(key) {
      if (charts[key] && typeof charts[key].destroy === 'function') {
        charts[key].destroy();
      }
      charts[key] = null;
    }

    function renderBar(key, canvasId, labels, values, datasetLabel) {
      const ctx = document.getElementById(canvasId);
      destroyChart(key);
      charts[key] = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: datasetLabel, data: values }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          resizeDelay: 150,
          animation: { duration: 200 },
          plugins: { legend: { display: true } },
          scales: {
            y: { beginAtZero: true, suggestedMax: 100, ticks: { stepSize: 20 } }
          }
        }
      });
    }

    async function loadStudentAnalytics() {
      if (!teacherId || !studentKey) {
        alert('Missing teacherId or student id in URL.'); return;
      }

      const url = `${API_BASE}/api/teacher/student-analytics?teacherId=${encodeURIComponent(teacherId)}&student=${encodeURIComponent(studentKey)}`;
      const data = await getJson(url);

      // Header metrics
      el('s_name').textContent = data.profile?.name || 'Student';
      el('s_id').textContent   = data.profile?.studentId || '—';
      el('s_avg_quiz').textContent = pct(data.summary?.averageQuizScore);
      el('s_avg_asg').textContent  = pct(data.summary?.averageAssignmentGrade);
      el('s_modules').textContent  =
        (data.summary?.modulesCompleted != null && data.summary?.totalModules != null)
        ? `${data.summary.modulesCompleted}/${data.summary.totalModules}`
        : (data.summary?.modulesCompleted ?? '—');

      // Quizzes table + chart
      const qrows = data.quizzes?.perQuiz || [];
      if (!qrows.length) {
        el('quizTbody').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No quiz data</td></tr>';
        destroyChart('quiz');
      } else {
        el('quizTbody').innerHTML = qrows.map(r => `
          <tr>
            <td>${r.title || r.quizId}</td>
            <td>${pct(r.bestPercent)}</td>
            <td>${r.attemptsUsed ?? 0}</td>
            <td>${dt(r.lastSubmittedAt)}</td>
          </tr>
        `).join('');
        renderBar('quiz', 'quizChart',
          qrows.map(r=>r.title || r.quizId),
          qrows.map(r=>Number(r.bestPercent)||0),
          'Best %'
        );
      }

      // Assignments table + chart
      const arows = data.assignments?.grades || [];
      if (!arows.length) {
        el('assignTbody').innerHTML = '<tr><td colspan="3" class="text-center text-muted">No assignments</td></tr>';
        destroyChart('assign');
      } else {
        el('assignTbody').innerHTML = arows.map(a => `
          <tr>
            <td>${a.assignmentTitle || a.assignmentId}</td>
            <td>${pct(a.grade)}</td>
            <td>${dt(a.gradedAt)}</td>
          </tr>
        `).join('');
        renderBar('assign', 'assignChart',
          arows.map(a=>a.assignmentTitle || a.assignmentId),
          arows.map(a=>Number(a.grade)||0),
          'Grade %'
        );
      }

      // Essays
      const erows = data.essays?.submissions || [];
      el('essayTbody').innerHTML = erows.length
        ? erows.map(e => `
          <tr>
            <td>${e.quizTitle || e.quizId}</td>
            <td>${e.questionIndex != null ? e.questionIndex + 1 : '—'}</td>
            <td>${(e.status || 'pending').toUpperCase()}</td>
            <td>${e.score != null ? (e.score + '/' + (e.maxScore ?? 10)) : '—'}</td>
            <td>${dt(e.createdAt)}</td>
          </tr>
        `).join('')
        : '<tr><td colspan="5" class="text-center text-muted">No essay submissions</td></tr>';

      // Modules
      const mrows = data.modules?.completed || [];
      el('modTbody').innerHTML = mrows.length
        ? mrows.map(m => `
          <tr>
            <td>${m.courseTitle || m.courseId || ''}</td>
            <td>${m.moduleTitle || m.moduleId || ''}</td>
            <td>${pct(m.percent)}</td>
            <td>${dt(m.completedAt)}</td>
          </tr>
        `).join('')
        : '<tr><td colspan="4" class="text-center text-muted">No modules</td></tr>';
    }

    // Initial load
    loadStudentAnalytics().catch(err => {
      console.error(err);
      alert('Failed to load student analytics.');
    });

    // Make sure charts don’t multiply on nav/resize
    window.addEventListener('beforeunload', () => {
      destroyChart('quiz');
      destroyChart('assign');
    });
  </script>
</body>
</html>
