<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Quiz • EduConnect</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="edit_quiz.css" />
</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box position-relative">
          <input type="text" class="form-control" id="freeSearch" placeholder="Search…" />
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <section class="content container-fluid p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h1 class="page-title brand mb-0">Edit Quiz</h1>
          <div class="d-flex flex-wrap gap-2">
            <button id="btnBack" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</button>
            <button id="btnArchive" class="btn btn-outline-warning"><i class="bi bi-archive"></i> Archive</button>
            <button id="btnUnarchive" class="btn btn-outline-success d-none"><i class="bi bi-arrow-counterclockwise"></i> Unarchive</button>
            <button id="btnDelete" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Delete</button>
            <button id="btnSave" class="btn btn-amber">
              <span class="save-text">Save Changes</span>
              <span class="spinner-border spinner-border-sm ms-2 visually-hidden" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </div>

        <div class="row g-3">
          <!-- Left -->
          <div class="col-12 col-lg-8">
            <!-- Details -->
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-pencil-square"></i> Details</h2>
              </div>
              <div class="p-3">
                <div id="formError" class="text-danger mb-2" style="min-height:1rem;"></div>
                <div class="row g-3">
                  <div class="col-md-8">
                    <label class="form-label">Title</label>
                    <input type="text" id="titleInput" class="form-control" required />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Attempts Allowed</label>
                    <input type="number" id="attemptsInput" min="0" step="1" class="form-control" placeholder="0 = unlimited" />
                  </div>
                  <div class="col-12">
                    <label class="form-label">Description</label>
                    <textarea id="descInput" rows="4" class="form-control"></textarea>
                  </div>
                </div>

                <div class="row g-3 mt-1">
                  <div class="col-md-6">
                    <label class="form-label">Due At</label>
                    <input type="datetime-local" id="dueInput" class="form-control" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Assign to Classes (NEW, matches assignment editor) -->
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-people"></i> Assign to Classes</h2>
                <div class="ui-card-title fw-normal">Selected classes will have access to this quiz.</div>
              </div>
              <div class="p-3">
                <div id="assigned-status" class="small-muted mb-2">Loading your classes…</div>
                <div id="assigned-empty" class="alert alert-warning py-2 px-3 mb-2" style="display:none;">
                  No classes found for your account.
                </div>
                <div id="assignedClassesContainer" class="row g-3"></div>
                <div class="small-muted mt-2">Tip: click a card to toggle selection.</div>
              </div>
            </div>

            <!-- Settings -->
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-gear"></i> Settings</h2>
              </div>
              <div class="p-3">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="timerEnabled">
                      <label class="form-check-label" for="timerEnabled">Enable Timer</label>
                    </div>
                    <div class="row g-2 mt-1">
                      <div class="col-6">
                        <label class="form-label">Minutes</label>
                        <input type="number" id="timerMinutes" class="form-control" min="1" step="1" placeholder="30" disabled>
                      </div>
                      <div class="col-6">
                        <label class="form-label">Grace (sec)</label>
                        <input type="number" id="graceSeconds" class="form-control" min="0" step="1" placeholder="10" disabled>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="shuffleQuestions">
                      <label class="form-check-label" for="shuffleQuestions">Randomize Questions</label>
                    </div>
                    <div class="form-text small-muted">Off = keep original order.</div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="paginationEnabled">
                      <label class="form-check-label" for="paginationEnabled">Enable Pagination</label>
                    </div>
                    <div class="input-group mt-1">
                      <span class="input-group-text">Per page</span>
                      <input type="number" class="form-control" id="perPage" min="1" step="1" value="1" disabled>
                    </div>
                    <div class="form-text small-muted">Show N questions per page.</div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check form-switch mt-2">
                      <input class="form-check-input" type="checkbox" id="backtrackingAllowed">
                      <label class="form-check-label" for="backtrackingAllowed">Allow Backtracking</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Questions -->
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-ui-checks-grid"></i> Questions</h2>
              </div>
              <div class="p-3">

                <!-- Bulk add -->
                <div class="mb-3">
                  <div class="fw-semibold"><span class="text-muted">Step 1:</span> Download a CSV Template</div>
                  <div class="d-flex flex-wrap gap-2 mt-2">
                    <button type="button" id="downloadCsvTplMcq" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download me-1"></i> CSV: Multiple Choice</button>
                    <button type="button" id="downloadCsvTplTf" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download me-1"></i> CSV: True / False</button>
                    <button type="button" id="downloadCsvTplEssay" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download me-1"></i> CSV: Essay</button>
                    <button type="button" id="downloadCsvTplAll" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download me-1"></i> CSV: All Types</button>
                  </div>
                  <div class="small-muted mt-2">
                    Columns (case-insensitive):
                    <code>type, question, choiceA, choiceB, choiceC, choiceD, correct</code>. For True/False, set
                    <code>correct</code> to <code>TRUE</code> or <code>FALSE</code>.
                  </div>

                  <hr class="my-3">

                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-8">
                      <label class="form-label">Pick a <strong>.csv</strong> file</label>
                      <input type="file" id="bulkFile" class="form-control" accept=".csv" />
                    </div>
                    <div class="col-12 col-md-4">
                      <button type="button" id="parseBulkBtn" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-eye"></i> Preview & Validate
                      </button>
                    </div>
                  </div>

                  <div id="bulkResult" class="mt-3 d-none">
                    <div class="d-flex flex-wrap justify-content-between align-items-center">
                      <div id="bulkSummary" class="small" aria-live="polite"></div>
                      <button type="button" id="addValidBtn" class="btn btn-success btn-sm" disabled>
                        <i class="bi bi-plus-circle me-1"></i> Add valid questions to quiz
                      </button>
                    </div>
                    <div class="preview-table mt-2">
                      <table class="table table-sm table-striped mb-0">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Question</th>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th>D</th>
                            <th>Correct</th>
                            <th>Status</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody id="bulkTbody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label mb-0 fw-bold">Questions</label>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="addQuestionBtn">
                    <i class="bi bi-plus-circle me-1"></i> Add Question
                  </button>
                </div>

                <div id="questionsWrap"></div>
              </div>
            </div>

            <!-- Rubric -->
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-clipboard-check"></i> Rubric</h2>
              </div>
              <div class="p-3">
                <!-- picker (quiet) -->
                <div class="mb-2">
                  <label class="form-label mb-1">Upload rubric (single file)</label>
                  <input id="rubricInput" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.png,.jpg,.jpeg,.gif,.webp" />
                  <div class="drop-hint mt-1">Pick a file to open a <strong>pre-upload preview</strong>. You can stage, replace, or remove before saving.</div>
                </div>

                <!-- single row -->
                <ul id="rubricList" class="list-unstyled m-0"></ul>

                <div class="form-text mt-2">
                  <strong>Staging:</strong> items marked with
                  <span class="badge-soft badge-stage">Staged</span> will be added/replaced on Save.
                  Items marked with <span class="badge-soft badge-removal">Pending removal</span> will be removed on Save.
                </div>
              </div>
            </div>

          </div>

          <!-- Right -->
          <div class="col-12 col-lg-4">
            <div class="ui-card mb-3">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-info-circle"></i> Meta</h2>
              </div>
              <div class="p-3">
                <div class="mb-2"><span class="muted">Course:</span> <span id="metaCourse">—</span></div>
                <div class="mb-2"><span class="muted">Module:</span> <span id="metaModule">—</span></div>
                <div class="mb-2"><span class="muted">Created:</span> <span id="metaCreated">—</span></div>
                <div class="mb-2"><span class="muted">Last Updated:</span> <span id="metaUpdated">—</span></div>
                <div class="mb-2"><span class="muted">Status:</span> <span id="metaStatus" class="badge text-bg-success">Active</span></div>
              </div>
            </div>

            <div class="ui-card">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-lightbulb"></i> Tips</h2>
              </div>
              <div class="p-3">
                <ul class="mb-0">
                  <li>Rubric is optional; upload only if there are Essay questions.</li>
                  <li>Preview the rubric before staging to ensure web compatibility.</li>
                  <li>Changes are staged and applied on Save.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>
        <div class="modal-footer">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto d-flex gap-2">
            <button id="stageFromPreviewBtn" class="btn btn-amber d-none">
              <i class="bi bi-cloud-plus me-1"></i> Stage this file
            </button>
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-close-footer">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info / Confirm -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="infoTitle">Notice</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="infoBody">—</div>
      <div class="modal-footer"><button class="btn btn-amber" data-bs-dismiss="modal">OK</button></div>
    </div></div>
  </div>
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header bg-danger text-white"><h5 class="modal-title" id="confirmTitle">Confirm</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="confirmBody">Are you sure?</div>
      <div class="modal-footer">
        <button class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmYesBtn" class="btn btn-danger">Yes</button>
      </div>
    </div></div>
  </div>

  <!-- App Alert Modal -->
  <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div id="appAlertHeader" class="modal-header">
          <h5 class="modal-title" id="appAlertTitle">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="appAlertBody" class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert helper -->
  <script>
    function showAppAlert(message, { title = "Notice", variant = "primary", closeOtherModals = true } = {}) {
      const header = document.getElementById("appAlertHeader");
      const titleEl = document.getElementById("appAlertTitle");
      const bodyEl = document.getElementById("appAlertBody");
      const alertEl = document.getElementById("appAlertModal");

      header.className = "modal-header";
      const bg = {
        primary: "bg-primary text-white", success: "bg-success text-white",
        danger: "bg-danger text-white", warning: "bg-warning",
        info: "bg-info", secondary: "bg-secondary text-white",
        dark: "bg-dark text-white", light: "bg-light"
      }[variant] || "bg-primary text-white";
      header.classList.add(...bg.split(" "));

      titleEl.textContent = title;
      bodyEl.textContent = message;

      if (closeOtherModals) {
        document.querySelectorAll(".modal.show").forEach(m => {
          if (m.id !== "appAlertModal") {
            const inst = bootstrap.Modal.getInstance(m);
            if (inst) inst.hide();
          }
        });
      }

      bootstrap.Modal.getOrCreateInstance(alertEl).show();
    }
  </script>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <script>
  const API = "http://localhost:5000";

  /* =============================
     Sidebar
  ============================= */
  document.addEventListener("DOMContentLoaded", () => {
    fetch("/components/sidebar.html")
      .then(r => r.text())
      .then(html => {
        document.getElementById("sidebar-container").innerHTML = html;
        const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
        if (sb && db) {
          sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
          sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
        }
        document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
          t.addEventListener('click', e => {
            e.preventDefault();
            const p = t.closest('.has-submenu');
            p.classList.toggle('open');
            t.setAttribute('aria-expanded', p.classList.contains('open'));
          });
        });
      });
  });

  /* =============================
     Auth + initials
  ============================= */
  (function initHeaderInitials() {
    try {
      const raw = localStorage.getItem("user");
      const stored = raw ? JSON.parse(raw) : {};
      const u = stored.user || stored;
      if (!u?.userId || !u?.isTeacher) { window.location.href = "/TEACHER/login/login.html"; return; }
      window.currentUser = u;
      const initials = (function (u) {
        const fn = (u.firstName || '').trim(), ln = (u.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();
        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, ' ').split(/[\s._-]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase(); return parts[0][0].toUpperCase();
        }
        const em = (u.email || '').trim(); return em ? em[0].toUpperCase() : 'U';
      })(u);
      window.addEventListener("DOMContentLoaded", () => {
        const el = document.getElementById("Username"); if (!el) return; el.textContent = initials;
        const full = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim() || u.username || u.email || 'Profile';
        el.setAttribute('title', full); el.setAttribute('aria-label', full);
      });
    } catch (e) { console.error(e); window.location.href = "/TEACHER/login/login.html"; }
  })();

  /* =============================
     Utilities
  ============================= */
  function escapeHTML(str = '') { return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }
  function tsToMs(ts) { if (!ts) return null; const s = ts._seconds ?? ts.seconds; const ns = ts._nanoseconds ?? ts.nanoseconds ?? 0; if (typeof s === 'number') return (s * 1000) + Math.floor(ns / 1e6); if (typeof ts === 'number') return ts; const d = new Date(ts); return isNaN(d.getTime()) ? null : d.getTime(); }
  function msToLocalInput(ms) { if (!ms) return ''; const d = new Date(ms); const pad = n => String(n).padStart(2, '0'); return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function showInfo(title, body) { document.getElementById('infoTitle').textContent = title; document.getElementById('infoBody').innerHTML = body; bootstrap.Modal.getOrCreateInstance(document.getElementById('infoModal')).show(); }
  function confirmDanger(title, body) { return new Promise(resolve => { document.getElementById('confirmTitle').textContent = title; document.getElementById('confirmBody').innerHTML = body; const btn = document.getElementById('confirmYesBtn'); const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal')); const onYes = () => { btn.removeEventListener('click', onYes); modal.hide(); resolve(true); }; const onHide = () => { btn.removeEventListener('click', onYes); resolve(false); }; btn.addEventListener('click', onYes, { once: true }); document.getElementById('confirmModal').addEventListener('hidden.bs.modal', onHide, { once: true }); modal.show(); }); }

  // meta helpers
  async function fetchCourseTitle(courseId) {
    if (!courseId) return '—';
    try {
      const r = await fetch(`${API}/courses/${encodeURIComponent(courseId)}`);
      const js = await r.json();
      const c = js?.course || js;
      const title = c?.title || c?.name || 'Untitled';
      const num = (c?.courseNumber ?? c?.number);
      return (num != null) ? `#${num} — ${title}` : title;
    } catch { return '—'; }
  }
  async function fetchModuleMeta(moduleId) {
    if (!moduleId) return null;
    try {
      const r = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}`);
      const m = await r.json();
      const mm = m?.module || m;
      return { title: mm?.title || 'Untitled', moduleNumber: mm?.moduleNumber ?? null, courseId: mm?.courseId || null };
    } catch { return null; }
  }
  function labelModule(meta) {
    if (!meta) return '—';
    const n = meta.moduleNumber;
    const t = (meta.title || '').trim();
    if (n != null && t) return `Module ${n} • ${t}`;
    if (n != null) return `Module ${n}`;
    return t || '—';
  }

  /* =============================
     Preview helpers (rubric)
  ============================= */
  function extFromUrl(u = '') { const clean = String(u).split('?')[0].split('#')[0]; const parts = clean.split('.'); return parts.length > 1 ? parts.pop().toLowerCase() : ''; }
  function extFromName(n = '') { const parts = String(n).split('.'); return parts.length > 1 ? parts.pop().toLowerCase() : ''; }
  function kindFrom({ url = '', name = '', mime = '' }) {
    const ext = (extFromUrl(url) || extFromName(name)).toLowerCase();
    if ((mime || '').startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) return 'image';
    if (mime === 'application/pdf' || ext === 'pdf') return 'pdf';
    if ((mime || '').startsWith('video/') || ['mp4', 'webm', 'ogg', 'ogv', 'mov'].includes(ext)) return 'video';
    if ((mime || '').startsWith('audio/') || ['mp3', 'wav', 'm4a', 'ogg', 'aac', 'flac'].includes(ext)) return 'audio';
    if ((mime || '').startsWith('text/') || ['txt', 'csv', 'log'].includes(ext)) return 'text';
    if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'csv'].includes(ext)) return 'office';
    return 'other';
  }
  function showSpinner(show) { document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
  function setFileInfoUI(kind, url) {
    const info = document.getElementById('fileInfoText');
    const hdr = document.getElementById('filePreviewModalLabel');
    const labelMap = { video: 'Video', audio: 'Audio', image: 'Image', pdf: 'PDF', text: 'Text/CSV', office: 'Office Doc', other: 'File' };
    let badge = document.getElementById('fileKindBadge'); if (!badge) { badge = document.createElement('span'); badge.id = 'fileKindBadge'; badge.className = 'ms-2 badge rounded-pill'; hdr.appendChild(badge); }
    badge.className = 'ms-2 badge rounded-pill bg-secondary-subtle text-secondary';
    badge.textContent = labelMap[kind] || 'File';
    info.innerHTML = `<span class="text-muted">Type:</span> <strong>${labelMap[kind] || 'File'}</strong>`;
    document.getElementById('openInNewTabBtn').href = url || '#';
  }
  function renderFilePreviewInto(container, { url, name = '', mime = '', isStaged = false }) {
    container.innerHTML = ''; showSpinner(true);
    const done = () => showSpinner(false);
    const fallback = (msg) => { container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">${msg || 'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; done(); };

    const kind = kindFrom({ url, name, mime });
    if (kind === 'image') { const img = new Image(); img.onload = done; img.onerror = () => fallback('Image preview failed.'); img.src = url; container.appendChild(img); return; }
    if (kind === 'pdf') { const iframe = document.createElement('iframe'); iframe.onload = done; iframe.onerror = () => fallback('PDF preview failed.'); iframe.src = url; container.appendChild(iframe); return; }
    if (kind === 'video') { const v = document.createElement('video'); v.controls = true; v.onloadeddata = done; v.onerror = () => fallback('Video preview failed.'); v.src = url; container.appendChild(v); return; }
    if (kind === 'audio') { const a = document.createElement('audio'); a.controls = true; a.onloadeddata = done; a.onerror = () => fallback('Audio preview failed.'); a.src = url; container.appendChild(a); return; }
    if (kind === 'text') { const iframe = document.createElement('iframe'); iframe.onload = done; iframe.onerror = () => fallback('Text preview failed.'); iframe.src = url; container.appendChild(iframe); return; }
    if (kind === 'office' && url.startsWith('blob:')) { return fallback('Office documents cannot be previewed until they’re uploaded. Please Save first, then preview.'); }
    if (kind === 'office') { const gview = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe = document.createElement('iframe'); iframe.onload = done; iframe.onerror = () => fallback('Office preview failed (Google Viewer blocked).'); iframe.src = gview; container.appendChild(iframe); return; }

    const obj = document.createElement('object'); obj.data = url; obj.type = mime || 'application/octet-stream'; obj.onload = done; obj.onerror = () => fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(done, 1200);
  }
  function openPreviewModalWithMeta({ url, title = 'File', mime = '', isStaged = false, stageContext = null }) {
    document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
    const kind = kindFrom({ url, name: title, mime });
    setFileInfoUI(kind, url);
    renderFilePreviewInto(document.getElementById("filePreviewContent"), { url, name: title, mime, isStaged });

    previewStageCtx = stageContext || null;
    showStageBtn(!!previewStageCtx);
    new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
  }

  /* =============================
     DOM refs
  ============================= */
  const titleInput = document.getElementById('titleInput');
  const descInput = document.getElementById('descInput');
  const attemptsInput = document.getElementById('attemptsInput');
  const dueInput = document.getElementById('dueInput');

  const timerEnabled = document.getElementById('timerEnabled');
  const timerMinutes = document.getElementById('timerMinutes');
  const graceSeconds = document.getElementById('graceSeconds');
  const shuffleQuestions = document.getElementById('shuffleQuestions');
  const paginationEnabled = document.getElementById('paginationEnabled');
  const perPage = document.getElementById('perPage');
  const backtrackingAllowed = document.getElementById('backtrackingAllowed');

  const questionsWrap = document.getElementById('questionsWrap');

  const rubricInput = document.getElementById('rubricInput');
  const rubricList = document.getElementById('rubricList');

  const metaCourse = document.getElementById('metaCourse');
  const metaModule = document.getElementById('metaModule');
  const metaCreated = document.getElementById('metaCreated');
  const metaUpdated = document.getElementById('metaUpdated');
  const metaStatus = document.getElementById('metaStatus');

  const btnBack = document.getElementById('btnBack');
  const btnSave = document.getElementById('btnSave');
  const btnArc = document.getElementById('btnArchive');
  const btnUnarc = document.getElementById('btnUnarchive');
  const btnDel = document.getElementById('btnDelete');
  const saveSpinner = btnSave.querySelector('.spinner-border');
  const saveText = btnSave.querySelector('.save-text');
  const formError = document.getElementById('formError');

  // Assign-to-Classes DOM (ensure these exist in your HTML like the Assignment page)
  const assignedContainer = document.getElementById("assignedClassesContainer");
  const assignedStatus    = document.getElementById("assigned-status");
  const assignedEmpty     = document.getElementById("assigned-empty");

  // URL params
  const url = new URL(location.href);
  const quizId = url.searchParams.get('quizId') || '';
  const courseId = url.searchParams.get('courseId') || '';

  // Back button
  btnBack.addEventListener('click', () => {
    if (dirtyGuard()) return;
    const params = new URLSearchParams(); if (courseId) params.set('courseId', courseId);
    window.location.href = `/TEACHER/quizzes/quiz_list.html${params.toString() ? `?${params}` : ''}`;
  });

  // settings enable/disable
  timerEnabled.addEventListener('change', () => {
    const on = timerEnabled.checked;
    timerMinutes.disabled = !on; graceSeconds.disabled = !on;
    if (!on) { timerMinutes.value = ''; graceSeconds.value = ''; }
    markDirty();
  });
  paginationEnabled.addEventListener('change', () => {
    perPage.disabled = !paginationEnabled.checked;
    if (!paginationEnabled.checked) perPage.value = 1;
    markDirty();
  });

  /* =============================
     RUBRIC STAGING
  ============================= */
  let currentRubric = null;
  const rubricStaged = { addRubric: null, removeRubric: false };

  let previewStageCtx = null;
  const stageFromPreviewBtn = document.getElementById('stageFromPreviewBtn');
  function showStageBtn(show) { stageFromPreviewBtn.classList.toggle('d-none', !show); }
  document.getElementById('filePreviewModal').addEventListener('hidden.bs.modal', () => { previewStageCtx = null; showStageBtn(false); });

  stageFromPreviewBtn.addEventListener('click', () => {
    if (!previewStageCtx || !previewStageCtx.file) return;
    rubricStaged.addRubric = previewStageCtx.file;
    rubricStaged.removeRubric = !!currentRubric; // replacing existing
    rubricInput.value = '';
    markDirty(); renderRubric();
    bootstrap.Modal.getInstance(document.getElementById('filePreviewModal')).hide();
    showInfo('Staged', 'Rubric is staged and will be uploaded on Save.');
  });

  function renderRubric() {
    const items = [];

    function rowTemplate({ name, onPreviewAct, rightSideFor, badgesHtml = '', isRemoved = false, isStaged = false, canReplace = true, canDelete = true }) {
      return `
        <li class="rubric-row" data-type="rubrics" data-id="${rightSideFor}">
          <div class="rubric-left">
            <span class="badge-soft"><i class="bi bi-clipboard"></i> Rubric</span>
            <a href="#" class="rubric-link ${isRemoved ? 'name-removed' : ''}" data-act="${onPreviewAct}" title="${escapeHTML(name)}">${escapeHTML(name)}</a>
            ${badgesHtml}
          </div>
          <div class="rubric-right rubric-actions">
            <span class="pill rubric-filename-pill" title="${escapeHTML(name)}">${escapeHTML(name)}</span>
            <button class="btn btn-outline-secondary btn-sm" data-act="${onPreviewAct}" title="Preview"><i class="bi bi-eye"></i></button>
            ${canReplace ? `
              <label class="btn btn-outline-secondary btn-sm mb-0" title="Replace">
                <i class="bi bi-arrow-repeat"></i>
                <input type="file" class="d-none input-replace"/>
              </label>` : ''}
            ${canDelete ? `<button class="btn btn-outline-danger btn-sm ${isStaged ? 'btn-unstage' : 'btn-stage-delete'}" title="${isStaged ? 'Remove staged file' : 'Remove'}"><i class="bi bi-trash"></i></button>` : ''}
          </div>
        </li>
      `;
    }

    if (currentRubric && !rubricStaged.removeRubric) {
      const badges = rubricStaged.addRubric ? `<span class="badge-soft badge-stage">Staged</span>` : '';
      items.push(rowTemplate({
        name: currentRubric.originalName || 'rubric',
        onPreviewAct: 'previewExisting',
        rightSideFor: 'existing',
        badgesHtml: badges
      }));
    }

    if (rubricStaged.addRubric) {
      items.push(rowTemplate({
        name: rubricStaged.addRubric.name,
        onPreviewAct: 'previewStaged',
        rightSideFor: 'staged',
        badgesHtml: `<span class="badge-soft badge-stage">Staged</span>`,
        isStaged: true
      }));
    }

    if (!currentRubric && !rubricStaged.addRubric) {
      items.push(`<li class="text-muted">No rubric uploaded.</li>`);
    }

    if (rubricStaged.removeRubric && !rubricStaged.addRubric) {
      const nm = currentRubric?.originalName || 'rubric';
      items.push(rowTemplate({
        name: nm,
        onPreviewAct: 'previewExisting',
        rightSideFor: 'pending-removal',
        badgesHtml: `<span class="badge-soft badge-removal">Pending removal</span>`,
        isRemoved: true,
        canReplace: false,
        canDelete: false
      }));
    }

    rubricList.innerHTML = items.join('');
  }

  rubricList.addEventListener('click', (e) => {
    const linkPreview = e.target.closest('[data-act="previewExisting"]') || e.target.closest('[data-act="previewStaged"]');
    if (linkPreview) {
      e.preventDefault();
      if (linkPreview.getAttribute('data-act') === 'previewExisting') {
        openPreviewExistingRubric(currentRubric);
      } else {
        const f = rubricStaged.addRubric; if (!f) return;
        const blobUrl = URL.createObjectURL(f);
        currentPreviewRevoke = () => URL.revokeObjectURL(blobUrl);
        openPreviewModalWithMeta({ url: blobUrl, title: f.name, mime: f.type || '', isStaged: true, stageContext: { file: f } });
      }
      return;
    }

    const li = e.target.closest('li'); if (!li) return;

    if (e.target.closest('.btn-stage-delete')) {
      rubricStaged.addRubric = null;
      if (currentRubric) rubricStaged.removeRubric = true;
      markDirty(); renderRubric(); return;
    }
    if (e.target.closest('.btn-unstage')) {
      rubricStaged.addRubric = null;
      rubricStaged.removeRubric = false;
      markDirty(); renderRubric(); return;
    }
  });

  rubricList.addEventListener('change', (e) => {
    if (!e.target.matches('.input-replace')) return;
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const blobUrl = URL.createObjectURL(file);
    currentPreviewRevoke = () => URL.revokeObjectURL(blobUrl);
    openPreviewModalWithMeta({ url: blobUrl, title: file.name, mime: file.type || '', isStaged: true, stageContext: { file } });
    e.target.value = '';
  });

  rubricInput.addEventListener('change', () => {
    const f = rubricInput.files && rubricInput.files[0];
    if (!f) return;
    const blobUrl = URL.createObjectURL(f);
    currentPreviewRevoke = () => URL.revokeObjectURL(blobUrl);
    openPreviewModalWithMeta({ url: blobUrl, title: f.name, mime: f.type || '', isStaged: true, stageContext: { file: f } });
  });

  function openPreviewExistingRubric(att) {
    if (!att) { showInfo('Preview', 'No rubric to preview.'); return; }
    const direct = att.downloadUrl || att.publicUrl || att.url || '';
    const storagePath = att.storagePath || '';
    const open = (u) => openPreviewModalWithMeta({ url: u, title: att.originalName || 'rubric', mime: att.mime || att.contentType || '' });
    if (direct) return open(direct);
    if (!storagePath) return;
    fetch(`${API}/storage/token-url?path=${encodeURIComponent(storagePath)}`)
      .then(r => r.json().catch(() => null).then(js => ({ ok: r.ok, js })))
      .then(({ ok, js }) => { if (ok && js?.success && js?.url) open(js.url); });
  }

  /* =============================
     QUESTIONS
  ============================= */
  function detectQuestionType(qq) {
    if (qq?.type && ['mcq', 'tf', 'essay'].includes(String(qq.type).toLowerCase())) {
      return String(qq.type).toLowerCase();
    }
    const ch = qq?.choices || {};
    const A = String(ch.A ?? '').trim().toLowerCase();
    const B = String(ch.B ?? '').trim().toLowerCase();
    const C = String(ch.C ?? '').trim();
    const D = String(ch.D ?? '').trim();
    const nonEmpty = [ch.A, ch.B, ch.C, ch.D].filter(v => v && String(v).trim() !== '').length;
    if (A === 'true' && B === 'false' && !C && !D) return 'tf';
    if (nonEmpty === 0) return 'essay';
    if (nonEmpty === 1 && (A.includes('essay') || B.includes('essay') || C.includes('essay') || D.includes('essay'))) return 'essay';
    return 'mcq';
  }

  function mcqBody(idx, q = {}) {
    const ch = q.choices || {};
    const correct = q.correctAnswer || q.correct || 'A';
    return `
      <div class="form-label">Choices (pick the correct one)</div>
      ${['A', 'B', 'C', 'D'].map(L => `
        <div class="input-group mb-2">
          <span class="input-group-text">${L}</span>
          <input type="text" class="form-control" name="${L}${idx}" placeholder="Choice ${L}" value="${escapeHTML(ch[L] || '')}" ${L === 'A' || L === 'B' ? 'required' : ''}>
        </div>
      `).join('')}
      <label class="form-label mt-1">Correct Answer</label>
      <select name="correct${idx}" class="form-select">
        ${['A', 'B', 'C', 'D'].map(L => `<option value="${L}" ${correct === L ? 'selected' : ''}>${L}</option>`).join('')}
      </select>
    `;
  }

  function tfBody(idx, q = {}) {
    const isTrue = (q.correctAnswer || q.correct || 'A') === 'A';
    return `
      <div class="form-label">Answer</div>
      <div class="d-flex gap-4 align-items-center">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="tf_correct${idx}" id="tf_true_${idx}" value="true" ${isTrue ? 'checked' : ''} required>
          <label class="form-check-label" for="tf_true_${idx}">True</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="tf_correct${idx}" id="tf_false_${idx}" value="false" ${!isTrue ? 'checked' : ''} required>
          <label class="form-check-label" for="tf_false_${idx}">False</label>
        </div>
      </div>
      <div class="form-text small-muted">Choices are implicitly “True” and “False”.</div>
    `;
  }

  function essayBody() {
    return `<div class="alert alert-info mt-2 mb-0"><strong>Essay / Manual grading.</strong></div>`;
  }

  function makeQEl(idx, type, data = {}) {
    const wrap = document.createElement('div');
    wrap.className = 'q-item';
    wrap.dataset.idx = idx;
    wrap.dataset.type = type;

    const qText = escapeHTML(data.question || '');
    wrap.innerHTML = `
      <div class="q-head">
        <div><label class="form-label mb-0">Question <span class="q-num">${idx + 1}</span></label></div>
        <div>
          <span class="q-chip ${type === 'mcq' ? 'active' : ''}" data-switch="mcq">Multiple Choice</span>
          <span class="q-chip ${type === 'tf' ? 'active' : ''}" data-switch="tf">True / False</span>
          <span class="q-chip ${type === 'essay' ? 'active' : ''}" data-switch="essay">Essay</span>
          <button type="button" class="btn btn-sm btn-outline-danger ms-2" data-remove title="Remove">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>

      <input type="hidden" name="type${idx}" value="${type}">
      <div class="mb-2">
        <input type="text" class="form-control" name="question${idx}" placeholder="Enter question" value="${qText}" required>
      </div>
      <div class="q-body"></div>
    `;
    const body = wrap.querySelector('.q-body');
    if (type === 'mcq') body.innerHTML = mcqBody(idx, data);
    else if (type === 'tf') body.innerHTML = tfBody(idx, data);
    else body.innerHTML = essayBody();

    wrap.querySelectorAll('.q-chip').forEach(ch => {
      ch.addEventListener('click', () => {
        wrap.querySelectorAll('.q-chip').forEach(x => x.classList.remove('active'));
        ch.classList.add('active');
        const t = ch.dataset.switch;
        wrap.dataset.type = t;
        wrap.querySelector(`input[name="type${idx}"]`).value = t;
        if (t === 'mcq') body.innerHTML = mcqBody(idx, {});
        else if (t === 'tf') body.innerHTML = tfBody(idx, {});
        else body.innerHTML = essayBody();
        markDirty();
      });
    });

    wrap.querySelector('[data-remove]').addEventListener('click', () => {
      wrap.remove();
      reindexQuestions();
      markDirty();
    });

    wrap.addEventListener('input', markDirty);
    wrap.addEventListener('change', markDirty);

    return wrap;
  }

  function reindexQuestions() {
    const items = [...questionsWrap.querySelectorAll('.q-item')];
    items.forEach((el, newIdx) => {
      const oldIdx = el.dataset.idx;
      el.dataset.idx = newIdx;
      el.querySelector('.q-num').textContent = String(newIdx + 1);
      el.querySelectorAll('[name]').forEach(inp => {
        inp.name = inp.name.replace(/\d+$/g, newIdx);
        if (inp.id) inp.id = inp.id.replace(/\d+$/g, newIdx);
      });
      const tfTrue = el.querySelector(`#tf_true_${oldIdx}`);
      const tfFalse = el.querySelector(`#tf_false_${oldIdx}`);
      if (tfTrue) { tfTrue.id = `tf_true_${newIdx}`; tfTrue.name = `tf_correct${newIdx}`; el.querySelector(`label[for="tf_true_${oldIdx}"]`)?.setAttribute('for', `tf_true_${newIdx}`); }
      if (tfFalse) { tfFalse.id = `tf_false_${newIdx}`; tfFalse.name = `tf_correct${newIdx}`; el.querySelector(`label[for="tf_false_${oldIdx}"]`)?.setAttribute('for', `tf_false_${newIdx}`); }
    });
  }

  function renderQuestions(list) {
    questionsWrap.innerHTML = '';
    (list || []).forEach((q, i) => {
      const type = detectQuestionType(q);
      questionsWrap.appendChild(makeQEl(i, type, q));
    });
  }

  function addQuestion(type = 'mcq', data = {}) {
    const idx = questionsWrap.querySelectorAll('.q-item').length;
    const el = makeQEl(idx, type, data);
    questionsWrap.appendChild(el);
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function collectQuestions() {
    const qs = [];
    const items = [...questionsWrap.querySelectorAll('.q-item')];
    items.forEach(el => {
      const idx = el.dataset.idx;
      const type = (el.dataset.type || 'mcq').toLowerCase();
      const questionText = el.querySelector(`[name="question${idx}"]`)?.value || '';
      if (type === 'mcq') {
        const A = el.querySelector(`[name="A${idx}"]`)?.value || '';
        const B = el.querySelector(`[name="B${idx}"]`)?.value || '';
        const C = el.querySelector(`[name="C${idx}"]`)?.value || '';
        const D = el.querySelector(`[name="D${idx}"]`)?.value || '';
        const correct = el.querySelector(`[name="correct${idx}"]`)?.value || 'A';
        qs.push({ type: 'mcq', question: questionText, choices: { A, B, C, D }, correctAnswer: correct });
      } else if (type === 'tf') {
        const tf = el.querySelector(`[name="tf_correct${idx}"]:checked`)?.value || 'true';
        qs.push({ type: 'tf', question: questionText, choices: { A: 'True', B: 'False' }, correctAnswer: tf === 'true' ? 'A' : 'B' });
      } else {
        qs.push({ type: 'essay', question: questionText, choices: { A: '(Essay response)' }, correctAnswer: 'A' });
      }
    });
    return qs;
  }

  // CSV helpers (download + preview UI)
  const bulkFileEl = document.getElementById('bulkFile');
  const parseBulkBtn = document.getElementById('parseBulkBtn');
  const bulkResult = document.getElementById('bulkResult');
  const bulkTbody = document.getElementById('bulkTbody');
  const bulkSummary = document.getElementById('bulkSummary');
  const addValidBtn = document.getElementById('addValidBtn');

  function toCSV(rows) {
    return rows.map(r => r.map(v => {
      const s = String(v ?? '');
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
    }).join(',')).join('\n');
  }
  function buildCsvTemplate(kind) {
    const header = ['type', 'question', 'choiceA', 'choiceB', 'choiceC', 'choiceD', 'correct'];
    let rows = [header];
    if (kind === 'mcq') {
      rows.push(['mcq', 'What is 2 + 2?', '4', '3', '5', '2', 'A']);
      rows.push(['mcq', 'Which color is the sky?', 'Blue', 'Green', 'Red', 'Yellow', 'A']);
    } else if (kind === 'tf') {
      rows.push(['tf', 'Light travels faster than sound', '', '', '', '', 'TRUE']);
      rows.push(['tf', 'The Earth is flat', '', '', '', '', 'FALSE']);
    } else if (kind === 'essay') {
      rows.push(['essay', 'Explain the exposure triangle in photography.', '', '', '', '', '']);
      rows.push(['essay', 'Describe Newton’s three laws of motion.', '', '', '', '', '']);
    } else {
      rows.push(['mcq', 'What is 2 + 2?', '4', '3', '5', '2', 'A']);
      rows.push(['tf', 'Light travels faster than sound', '', '', '', '', 'TRUE']);
      rows.push(['essay', 'Explain the exposure triangle in photography.', '', '', '', '', '']);
    }
    return toCSV(rows);
  }
  function downloadCSV(kind, filename) {
    const csv = buildCsvTemplate(kind);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  document.getElementById('downloadCsvTplMcq')?.addEventListener('click', () => downloadCSV('mcq', 'quiz_template_mcq.csv'));
  document.getElementById('downloadCsvTplTf')?.addEventListener('click', () => downloadCSV('tf', 'quiz_template_true_false.csv'));
  document.getElementById('downloadCsvTplEssay')?.addEventListener('click', () => downloadCSV('essay', 'quiz_template_essay.csv'));
  document.getElementById('downloadCsvTplAll')?.addEventListener('click', () => downloadCSV('all', 'quiz_template_all.csv'));

  function normalizeHeader(s) { return String(s || '').trim().toLowerCase(); }
  function normalizeType(t) {
    const x = String(t || '').trim().toLowerCase();
    if (['mcq', 'multiple choice', 'multiple-choice', 'multiplechoice'].includes(x)) return 'mcq';
    if (['tf', 'true/false', 'truefalse', 'true-false'].includes(x)) return 'tf';
    if (['essay', 'open', 'long', 'long answer', 'long-answer'].includes(x)) return 'essay';
    return '';
  }
  function normalizeCorrectForTF(v) {
    const x = String(v || '').trim().toLowerCase();
    if (['true', 't', 'a', '1', 'yes', 'y'].includes(x)) return 'A';
    if (['false', 'f', 'b', '0', 'no', 'n'].includes(x)) return 'B';
    return '';
  }
  function normalizeCorrectForMCQ(v) {
    const x = String(v || '').trim().toUpperCase();
    return ['A', 'B', 'C', 'D'].includes(x) ? x : '';
  }

  function validateBulkRows(rawRows) {
    const normed = rawRows.map(r => {
      const out = {};
      Object.keys(r || {}).forEach(k => out[normalizeHeader(k)] = r[k]);
      return out;
    });

    const items = [];
    let validCount = 0, invalidCount = 0;

    normed.forEach((r) => {
      const type = normalizeType(r.type);
      const question = String(r.question || '').trim();
      const A = String(r.choicea || '').trim();
      const B = String(r.choiceb || '').trim();
      const C = String(r.choicec || '').trim();
      const D = String(r.choiced || '').trim();
      let correct = String(r.correct || '').trim();

      const errors = [];
      if (!type) errors.push('Invalid type');
      if (!question) errors.push('Question required');

      if (type === 'mcq') {
        if (!A || !B || !C || !D) errors.push('MCQ needs all choices A–D');
        correct = normalizeCorrectForMCQ(correct);
        if (!correct) errors.push('Correct must be A/B/C/D');
      } else if (type === 'tf') {
        correct = normalizeCorrectForTF(correct);
        if (!correct) errors.push('Correct must be TRUE/FALSE (or A/B)');
      } else if (type === 'essay') {
        correct = 'A';
      }

      const ok = errors.length === 0;
      if (ok) validCount++; else invalidCount++;

      items.push({
        ok, errors,
        display: { type, question, A, B, C, D, correct },
        excluded: false,
        payload: {
          type, question,
          choices: type === 'mcq' ? { A, B, C, D } :
                   type === 'tf' ? { A: 'True', B: 'False' } :
                                    { A: '(Essay response)' },
          correct
        }
      });
    });

    return { items, validCount, invalidCount, missingHeaders: [] };
  }

  function renderBulkPreview({ items, validCount, invalidCount, missingHeaders }) {
    if (!bulkResult) return;
    bulkResult.classList.remove('d-none');
    bulkTbody.innerHTML = '';
    addValidBtn.disabled = (validCount === 0);

    const maxRows = Math.min(items.length, 200);
    for (let i = 0; i < maxRows; i++) {
      const it = items[i];
      const st = it.ok ? '<span class="badge bg-success">OK</span>' :
        `<span class="badge bg-danger" title="${escapeHTML(it.errors.join('; '))}">Error</span>`;
      const actionBtn = it.ok
        ? `<button type="button" class="btn btn-sm ${it.excluded ? 'btn-outline-secondary' : 'btn-outline-danger'} bulk-toggle"
                    data-idx="${i}" title="${it.excluded ? 'Restore this row' : 'Remove this row'}">
             ${it.excluded ? '<i class="bi bi-arrow-counterclockwise"></i> Restore' : '<i class="bi bi-x-circle"></i> Remove'}
           </button>`
        : `<button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Invalid row">Remove</button>`;

      const trClass = it.excluded ? 'row-excluded' : '';
      bulkTbody.innerHTML += `
        <tr class="${trClass}">
          <td>${i + 1}</td>
          <td>${it.display.type || '—'}</td>
          <td>${escapeHTML(it.display.question || '')}</td>
          <td>${escapeHTML(it.display.A || '')}</td>
          <td>${escapeHTML(it.display.B || '')}</td>
          <td>${escapeHTML(it.display.C || '')}</td>
          <td>${escapeHTML(it.display.D || '')}</td>
          <td>${escapeHTML(it.display.correct || '')}</td>
          <td>${st}</td>
          <td>${actionBtn}</td>
        </tr>
      `;
    }
    const excludedCount = items.filter(x => x.ok && x.excluded).length;
    const addableCount = items.filter(x => x.ok && !x.excluded).length;
    const more = items.length > maxRows ? ` (+${items.length - maxRows} more…)` : '';
    const miss = (missingHeaders && missingHeaders.length) ? ` Missing headers: ${missingHeaders.join(', ')}.` : '';
    bulkSummary.textContent = `Valid: ${validCount} • Invalid: ${invalidCount} • Excluded: ${excludedCount} • Will add: ${addableCount} • Total: ${items.length}${more}.${miss}`;

    addValidBtn.dataset.bulk = JSON.stringify(items);
  }

  bulkTbody?.addEventListener('click', (e) => {
    const btn = e.target.closest('.bulk-toggle');
    if (!btn) return;
    const idx = Number(btn.dataset.idx);
    const items = addValidBtn.dataset.bulk ? JSON.parse(addValidBtn.dataset.bulk) : [];
    if (Number.isInteger(idx) && items[idx] && items[idx].ok) {
      items[idx].excluded = !items[idx].excluded;
      renderBulkPreview({
        items,
        validCount: items.filter(x => x.ok).length,
        invalidCount: items.filter(x => !x.ok).length,
        missingHeaders: []
      });
    }
  });

  parseBulkBtn?.addEventListener('click', async () => {
    const f = bulkFileEl.files && bulkFileEl.files[0];
    if (!f) { showAppAlert?.('Please pick a CSV file first.'); return; }
    const ext = f.name.split('.').pop().toLowerCase();
    if (ext !== 'csv') { showAppAlert?.('Only .csv files are supported.'); return; }

    let rows = [];
    try {
      rows = await new Promise((resolve, reject) => {
        Papa.parse(f, {
          header: true,
          skipEmptyLines: 'greedy',
          complete: (res) => resolve(res.data || []),
          error: reject
        });
      });
    } catch (err) {
      console.error(err);
      showAppAlert?.('Failed to read the CSV. Please check your format.');
      return;
    }

    const result = validateBulkRows(rows);
    renderBulkPreview(result);
  });

  addValidBtn?.addEventListener('click', () => {
    const data = addValidBtn.dataset.bulk ? JSON.parse(addValidBtn.dataset.bulk) : [];
    const validOnly = data.filter(x => x.ok && !x.excluded).map(x => x.payload);
    if (!validOnly.length) { showAppAlert?.('No valid (and not-removed) rows to add.'); return; }

    const LIMIT = 300;
    validOnly.slice(0, LIMIT).forEach(q => {
      if ((q.type || 'mcq') === 'mcq') {
        addQuestion('mcq', { question: q.question, choices: q.choices, correctAnswer: q.correct });
      } else if ((q.type || 'mcq') === 'tf') {
        addQuestion('tf', { question: q.question, choices: q.choices, correctAnswer: q.correct });
      } else {
        addQuestion('essay', { question: q.question });
      }
    });

    if (bulkFileEl) bulkFileEl.value = '';
    bulkResult?.classList.add('d-none');
    if (bulkTbody) bulkTbody.innerHTML = '';
    if (addValidBtn) addValidBtn.disabled = true;
    markDirty();
    showAppAlert?.('Added question(s) to the quiz.');
  });

  document.getElementById('addQuestionBtn')?.addEventListener('click', () => addQuestion('mcq', {}));

  /* =============================
     ASSIGN-TO-CLASSES
  ============================= */
  let selectedClassIds = new Set();   // working selection
  let initialAssigned  = new Set();   // snapshot for dirty checking

  function renderClassCards(classes) {
    if (!assignedContainer) return;
    assignedContainer.innerHTML = "";
    if (!classes.length) {
      if (assignedStatus) assignedStatus.style.display = "none";
      if (assignedEmpty) assignedEmpty.style.display = "block";
      return;
    }
    classes.forEach(c => {
      const id = c.id || c._id || c.classId || "";
      const name = c.name || c.className || "Untitled Class";
      const grade = c.gradeLevel ?? c.grade ?? "—";
      const section = c.section ?? c.sectionName ?? "—";

      const col = document.createElement("div");
      col.className = "col-12 col-sm-6 col-lg-4";

      const card = document.createElement("div");
      card.className = "card assign-card";
      card.tabIndex = 0;

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.value = id;
      chk.className = "d-none";
      if (selectedClassIds.has(id)) { chk.checked = true; card.classList.add("selected"); }
      card.appendChild(chk);

      const body = document.createElement("div");
      body.className = "card-body";
      body.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <h5 class="card-title mb-1">${escapeHTML(name)}</h5>
          <i class="bi bi-check2-circle ms-2" style="opacity:.35;"></i>
        </div>
        <div class="small-muted">Grade ${escapeHTML(grade)} • Section ${escapeHTML(section)}</div>
      `;
      card.appendChild(body);

      function toggle() {
        const isChecked = !chk.checked;
        chk.checked = isChecked;
        card.classList.toggle("selected", isChecked);
        if (isChecked) selectedClassIds.add(id); else selectedClassIds.delete(id);
        const now = [...selectedClassIds].sort().join(',');
        const was = [...initialAssigned].sort().join(',');
        if (now !== was) markDirty();
      }
      card.addEventListener("click", e => {
        if (window.getSelection && String(window.getSelection()).length) return;
        toggle();
      });
      card.addEventListener("keydown", e => {
        if (e.key === " " || e.key === "Enter") { e.preventDefault(); toggle(); }
      });

      col.appendChild(card);
      assignedContainer.appendChild(col);
    });
    if (assignedStatus) assignedStatus.style.display = "none";
    if (assignedEmpty) assignedEmpty.style.display = "none";
  }

  async function loadTeacherClassesAndRender() {
    if (!assignedStatus) return;
    try {
      const teacherId = window.currentUser?.userId || window.currentUser?.id || window.currentUser?.uid || '';
      if (!teacherId) {
        assignedStatus.textContent = "Missing teacher ID in your session.";
        assignedStatus.classList.remove('small-muted'); assignedStatus.classList.add('text-danger');
        return;
      }
      // NOTE: using non-/api path to match your other quiz endpoints
      const res = await fetch(`${API}/classes?teacherId=${encodeURIComponent(teacherId)}`, { headers: { "Accept": "application/json" } });
      const json = await res.json().catch(()=>({success:false, classes:[]}));
      const classes = json?.classes || [];
      if (!json.success && json.success !== undefined) {
        assignedStatus.textContent = "Could not load your classes.";
        assignedStatus.classList.remove('small-muted'); assignedStatus.classList.add('text-danger');
        return;
      }
      renderClassCards(classes);
    } catch (e) {
      console.error("Could not load classes:", e);
      assignedStatus.textContent = "Could not load your classes. Please refresh.";
      assignedStatus.classList.remove('small-muted'); assignedStatus.classList.add('text-danger');
      showInfo('Network Error', 'Could not load your classes. Please refresh and try again.');
    }
  }

  /* =============================
     LOAD / SAVE
  ============================= */
  let initialQuiz = null;
  function updateStatusBadge(archived) {
    metaStatus.textContent = archived ? 'Archived' : 'Active';
    metaStatus.className = `badge ${archived ? 'text-bg-secondary' : 'text-bg-success'}`;
    btnArc.classList.toggle('d-none', archived);
    btnUnarc.classList.toggle('d-none', !archived);
  }

  async function loadQuiz() {
    const res = await fetch(`${API}/quizzes/${encodeURIComponent(quizId)}`);
    const js = await res.json();
    if (!res.ok || js.success === false) throw new Error(js.message || 'Failed to load quiz.');

    const q = js.quiz || {};
    initialQuiz = q;

    titleInput.value = q.title || '';
    descInput.value = q.description || '';
    attemptsInput.value = (q.attemptsAllowed == null || q.attemptsAllowed === 0) ? 0 : q.attemptsAllowed;
    dueInput.value = msToLocalInput(tsToMs(q.dueAt));

    // settings
    const s = q.settings || {};
    timerEnabled.checked = !!s.timerEnabled;
    timerMinutes.disabled = !timerEnabled.checked;
    graceSeconds.disabled = !timerEnabled.checked;
    timerMinutes.value = timerEnabled.checked ? (s.durationMinutes || '') : '';
    graceSeconds.value = timerEnabled.checked ? (s.graceSeconds || 0) : '';

    shuffleQuestions.checked = (s.shuffleQuestions !== false);
    const pagOn = !!(s.pagination && s.pagination.enabled);
    paginationEnabled.checked = pagOn;
    perPage.disabled = !pagOn;
    perPage.value = pagOn ? (s.pagination?.perPage || 1) : 1;
    backtrackingAllowed.checked = (s.backtrackingAllowed !== false);

    // meta times
    metaCreated.textContent = tsToMs(q.createdAt) ? new Date(tsToMs(q.createdAt)).toLocaleString() : '—';
    metaUpdated.textContent = tsToMs(q.updatedAt) ? new Date(tsToMs(q.updatedAt)).toLocaleString() : '—';

    // Course/Module labels
    try {
      const [courseLabel, moduleMeta] = await Promise.all([
        fetchCourseTitle(q.courseId),
        fetchModuleMeta(q.moduleId)
      ]);
      metaCourse.textContent = courseLabel;
      metaModule.textContent = labelModule(moduleMeta);
    } catch { }

    updateStatusBadge(q.archived === true);

    // rubric normalize
    currentRubric = null;
    if (q.rubricFile) {
      currentRubric = {
        id: 'rubric',
        type: 'rubrics',
        originalName: q.rubricFile.originalName || q.rubricFile.name || 'rubric',
        mime: q.rubricFile.mime || q.rubricFile.contentType || '',
        storagePath: q.rubricFile.storagePath || '',
        downloadUrl: q.rubricFile.downloadUrl || '',
        publicUrl: q.rubricFile.publicUrl || '',
        url: q.rubricFile.url || ''
      };
    }
    rubricStaged.addRubric = null;
    rubricStaged.removeRubric = false;
    renderRubric();

    // questions
    renderQuestions(q.questions || []);

    // Assign-to-Classes
    selectedClassIds = new Set(Array.isArray(q.classIds) ? q.classIds.filter(Boolean) : []);
    initialAssigned  = new Set(selectedClassIds);
    await loadTeacherClassesAndRender();

    clearDirty();
  }

  function markDirty() { window.__dirty = true; }
  function clearDirty() { window.__dirty = false; }
  function isDirty() {
    if (!initialQuiz) return false;
    if (window.__dirty) return true;
    if (rubricStaged.addRubric || rubricStaged.removeRubric) return true;
    // class selection delta
    const now = [...selectedClassIds].sort().join(',');
    const was = [...initialAssigned].sort().join(',');
    if (now !== was) return true;
    return false;
  }
  function dirtyGuard() {
    if (!isDirty()) return false;
    const leave = !confirm('You have unsaved changes (including rubric and/or class assignments). Leave without saving?');
    return leave;
  }
  window.addEventListener('beforeunload', (e) => {
    if (!isDirty()) return;
    e.preventDefault();
    e.returnValue = '';
  });

  [titleInput, descInput, attemptsInput, dueInput,
    timerEnabled, timerMinutes, graceSeconds, shuffleQuestions,
    paginationEnabled, perPage, backtrackingAllowed
  ].forEach(el => {
    el?.addEventListener('change', markDirty);
    el?.addEventListener('input', markDirty);
  });

  async function applySave() {
    const title = titleInput.value.trim();
    if (!title) { formError.textContent = 'Title is required.'; return; }
    const description = descInput.value.trim();
    const attemptsAllowed = parseInt(attemptsInput.value || '0', 10);
    const dueAt = dueInput.value;

    const settings = {};
    if (timerEnabled.checked) {
      const mins = parseInt(timerMinutes.value || '0', 10);
      if (!Number.isInteger(mins) || mins < 1) { formError.textContent = 'Timer minutes must be ≥ 1.'; return; }
      const grace = parseInt(graceSeconds.value || '0', 10);
      if (!Number.isInteger(grace) || grace < 0) { formError.textContent = 'Grace seconds must be ≥ 0.'; return; }
      settings.timerEnabled = true;
      settings.durationMinutes = mins;
      settings.graceSeconds = grace;
    } else {
      settings.timerEnabled = false;
    }
    settings.shuffleQuestions = !!shuffleQuestions.checked;
    settings.pagination = { enabled: !!paginationEnabled.checked, perPage: parseInt(perPage.value || '1', 10) || 1 };
    settings.backtrackingAllowed = !!backtrackingAllowed.checked;

    const questions = collectQuestions();
    if (!questions.length) { formError.textContent = 'At least one question is required.'; return; }

    // PUT quiz core (+ classIds)
    const put = await fetch(`${API}/quizzes/${encodeURIComponent(quizId)}`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title, description, dueAt, attemptsAllowed, settings, questions,
        classIds: Array.from(selectedClassIds)
      })
    });
    const putJs = await put.json().catch(() => ({}));
    if (!put.ok || putJs.success === false) throw new Error(putJs.message || 'Failed to save quiz.');

    // Rubric
    if (rubricStaged.addRubric) {
      const form = new FormData();
      form.append('rubric', rubricStaged.addRubric);
      form.append('rubrics', rubricStaged.addRubric); // compat
      const up = await fetch(`${API}/quizzes/${encodeURIComponent(quizId)}/rubric`, { method: 'POST', body: form });
      const upJs = await up.json().catch(() => ({}));
      if (!up.ok || upJs.success === false) throw new Error(upJs.message || 'Failed to upload rubric.');
    } else if (rubricStaged.removeRubric) {
      const del = await fetch(`${API}/quizzes/${encodeURIComponent(quizId)}/rubric`, { method: 'DELETE' });
      const delJs = await del.json().catch(() => ({}));
      if (!del.ok || delJs.success === false) throw new Error(delJs.message || 'Failed to remove rubric.');
    }

    await loadQuiz();
    showInfo('Saved', 'Your changes (including rubric and class assignments) have been saved.');
  }

  btnSave.addEventListener('click', async () => {
    formError.textContent = ''; btnSave.disabled = true; saveSpinner.classList.remove('visually-hidden'); saveText.textContent = 'Saving…';
    try { await applySave(); }
    catch (e) { console.error(e); formError.textContent = e.message || 'Server error while saving.'; }
    finally { btnSave.disabled = false; saveSpinner.classList.add('visually-hidden'); saveText.textContent = 'Save Changes'; }
  });

  btnArchive.addEventListener('click', async () => {
    const ok = await confirmDanger('Archive Quiz', 'Archive this quiz? Students will no longer see it.');
    if (!ok) return;
    try {
      const res = await fetch(`${API}/quizzes/${encodeURIComponent(quizId)}/archive`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ archived: true }) });
      const js = await res.json(); if (!res.ok || js.success === false) throw new Error(js.message || 'Failed to archive.');
      updateStatusBadge(true); showInfo('Archived', 'The quiz is now hidden from students.');
    } catch (e) { showInfo('Error', e.message || 'Failed to archive.'); }
  });
  btnUnarchive.addEventListener('click', async () => {
    try {
      const res = await fetch(`${API}/quizzes/${encodeURIComponent(quizId)}/archive`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ archived: false }) });
      const js = await res.json(); if (!res.ok || js.success === false) throw new Error(js.message || 'Failed to unarchive.');
      updateStatusBadge(false); showInfo('Unarchived', 'Students can see this quiz again.');
    } catch (e) { showInfo('Error', e.message || 'Failed to unarchive.'); }
  });

  btnDelete.addEventListener('click', async () => {
    const ok = await confirmDanger('Delete Quiz', '<strong>Permanently delete</strong> this quiz (including files/rubric and all scores)? This cannot be undone.');
    if (!ok) return;
    try {
      const res = await fetch(`${API}/quizzes/${encodeURIComponent(quizId)}`, { method: 'DELETE' });
      const js = await res.json(); if (!res.ok || js.success === false) throw new Error(js.message || 'Failed to delete.');
      showInfo('Deleted', 'Quiz deleted.');
      setTimeout(() => {
        const params = new URLSearchParams(); if (courseId) params.set('courseId', courseId);
        window.location.href = `/TEACHER/quizzes/quiz_list.html${params.toString() ? `?${params}` : ''}`;
      }, 800);
    } catch (e) { showInfo('Error', e.message || 'Failed to delete.'); }
  });

  // token-url helper for legacy objects used in rubric preview
  let currentPreviewRevoke = null;

  /* =============================
     Boot
  ============================= */
  (async function boot() {
    if (!quizId) { showInfo('Missing ID', 'No quizId provided.'); return; }
    await loadQuiz();
  })();
</script>

</body>

</html>