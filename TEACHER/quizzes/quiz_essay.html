<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher – Essay Grading (Grouped by Quiz)</title>

  <!-- Optional: set your Railway backend base explicitly (overrides auto-detect) -->
  <!-- <meta name="api-base" content="https://your-backend.up.railway.app"> -->

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Shared theme (your brand styles, incl .btn-amber) -->
  <link rel="stylesheet" href="essay.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>

        <div class="search-box position-relative">
          <input type="text" class="form-control" id="freeSearch" placeholder="Search student, quiz, or answer…" />
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold">T</span>
        </button>
      </header>

      <!-- Content -->
      <section class="content px-4 py-3">
        <h1 class="page-title">Essay Grading</h1>

        <!-- THEMED TOOLBAR -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-journal-text"></i> Your Essay Queue</h2>
            <div class="ui-subtext">Everything shows up right away. Use Sort if you want a different order.</div>
          </div>

          <div class="row g-2 align-items-end">
            <!-- Sort -->
            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort list">
                <option value="submitted_desc" selected>Newest submitted</option>
                <option value="submitted_asc">Oldest submitted</option>
                <option value="student_az">Student A → Z</option>
                <option value="course_az">Course A → Z</option>
                <option value="module_az">Module A → Z</option>
                <option value="quiz_az">Quiz A → Z</option>
              </select>
            </div>

            <div class="col-12 col-lg-2">
              <label class="form-label fw-semibold">Status</label>
              <select class="form-select" id="statusSelect">
                <option value="">All</option>
                <option value="pending" selected>Pending</option>
                <option value="graded">Graded</option>
                <option value="needs_review">Needs Review</option>
              </select>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold">Course</label>
              <select class="form-select" id="courseFilter">
                <option value="">All Courses</option>
              </select>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold">Module</label>
              <select class="form-select" id="moduleFilter" disabled>
                <option value="">All Modules</option>
              </select>
            </div>

            <div class="col-6 col-lg-1">
              <label class="form-label fw-semibold">Page</label>
              <select class="form-select" id="pageSizeSelect">
                <option>10</option>
                <option selected>20</option>
                <option>50</option>
                <option>100</option>
              </select>
            </div>

            <div class="col-6 col-lg-0 d-flex justify-content-end">
              <button id="refreshBtn" class="btn btn-outline-secondary w-100">
                <i class="bi bi-arrow-repeat"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <!-- /THEMED TOOLBAR -->

        <!-- List (grouped) -->
        <div class="table-responsive card">
          <table class="table table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>Course</th>
                <th>Module</th>
                <th>Quiz</th>
                <th>Essay Items</th>
                <th>Status</th>
                <th>Submitted</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="essayTbody">
              <tr>
                <td colspan="8" class="text-center text-muted py-4">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pager -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="muted" id="listSummary">—</div>
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" id="prevBtn">Prev</button>
            <span class="btn btn-light btn-sm disabled" id="pageIndicator">1 / 1</span>
            <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Group Grade Modal -->
  <div class="modal fade" id="gradeModal" tabindex="-1" aria-labelledby="gradeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="gradeModalLabel">Grade Submission</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- Sidebar: questions in this submission -->
            <div class="col-12 col-lg-4">
              <div class="card p-3 h-100">
                <div class="sticky-title">
                  <div class="small text-muted" id="modalCourseModuleLine">—</div>
                  <div class="fw-semibold" id="modalStudentLine">Student —</div>
                  <div class="small text-muted" id="modalQuizLine">Quiz —</div>
                  <hr class="mt-2 mb-3" />
                </div>
                <div id="qList" class="d-flex flex-column gap-2"></div>
              </div>
            </div>

            <!-- Main: selected question -->
            <div class="col-12 col-lg-8">
              <div class="card p-3 h-100">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="text-muted mb-2">Question</h6>
                  <div class="small text-muted" id="qIndexLine">1 / 1</div>
                </div>
                <div id="qText" class="quiz-q mb-3"></div>
                <h6 class="text-muted mb-1">Student Answer</h6>
                <div id="ansText" class="student-ans mb-3"></div>

                <form id="gradeForm">
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label fw-semibold">Score</label>
                      <input type="number" step="1" min="0" class="form-control" id="scoreInput" required>
                    </div>
                    <div class="col-6">
                      <label class="form-label fw-semibold">Total Score</label>
                      <input type="number" step="1" min="1" class="form-control" id="maxInput" value="10" required>
                    </div>
                  </div>

                  <div class="mt-2">
                    <label class="form-label fw-semibold">Feedback</label>
                    <textarea class="form-control" rows="4" id="feedbackInput"
                      placeholder="Write helpful feedback…"></textarea>
                  </div>

                  <div class="mt-2">
                    <label class="form-label fw-semibold">Status</label>
                    <select id="statusInput" class="form-select">
                      <option value="graded" selected>Graded</option>
                      <option value="needs_review">Needs Review</option>
                    </select>
                  </div>

                  <div class="d-flex flex-wrap gap-2 mt-3">
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check2-circle"></i> Save This Question
                    </button>
                    <button type="button" id="prevQBtn" class="btn btn-outline-secondary">Prev</button>
                    <button type="button" id="nextQBtn" class="btn btn-outline-secondary">Next</button>
                    <div class="ms-auto"></div>
                  </div>
                </form>

                <div class="small text-muted mt-3" id="metaInfo"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer now has the primary action -->
        <div class="modal-footer border-0">
          <button type="button" id="saveAllBtn" class="btn btn-amber">
            <i class="bi bi-save2"></i> Save All
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- App Alert Modal -->
  <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div id="appAlertHeader" class="modal-header">
          <h5 class="modal-title" id="appAlertTitle">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="appAlertBody" class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;
          const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
          if (sb && db) {
            sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
            sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
          }
          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
            t.addEventListener('click', e => {
              e.preventDefault();
              const p = t.closest('.has-submenu');
              p.classList.toggle('open');
              t.setAttribute('aria-expanded', p.classList.contains('open'));
            });
          });
        })
        .catch(() => { /* silent */ });
    });
  </script>

  <!-- Alert helper (closes any open modal before showing alert) -->
  <script>
    function showAppAlert(message, { title = "Notice", variant = "primary", closeOtherModals = true } = {}) {
      const header = document.getElementById("appAlertHeader");
      const titleEl = document.getElementById("appAlertTitle");
      const bodyEl = document.getElementById("appAlertBody");
      const alertEl = document.getElementById("appAlertModal");

      // Variant styling
      header.className = "modal-header";
      const bg = {
        primary: "bg-primary text-white", success: "bg-success text-white",
        danger: "bg-danger text-white", warning: "bg-warning",
        info: "bg-info", secondary: "bg-secondary text-white",
        dark: "bg-dark text-white", light: "bg-light"
      }[variant] || "bg-primary text-white";
      header.classList.add(...bg.split(" "));

      titleEl.textContent = title;
      bodyEl.textContent = message;

      // Close any other open modals before showing the alert
      if (closeOtherModals) {
        document.querySelectorAll(".modal.show").forEach(m => {
          if (m.id !== "appAlertModal") {
            const inst = bootstrap.Modal.getInstance(m);
            if (inst) inst.hide();
          }
        });
      }

      bootstrap.Modal.getOrCreateInstance(alertEl).show();
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Page Logic (Railway-ready) -->
  <script>
    /* ===== Railway-friendly API base resolver =====
       Priority: 1) <meta name="api-base">, 2) window.__API_BASE, 3) localStorage.API_BASE,
                 4) same-origin when on *.railway.app, 5) http://localhost:5000 (dev)
    ================================================= */
    const API = (() => {
      const byMeta = document.querySelector('meta[name="api-base"]')?.getAttribute('content')?.trim();
      const byWindow = (typeof window !== 'undefined' && window.__API_BASE) ? String(window.__API_BASE).trim() : '';
      const byStorage = (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) ? localStorage.getItem('API_BASE').trim() : '';
      const onRailway = /\.railway\.app$/i.test(location.hostname);
      const chosen = byMeta || byWindow || byStorage || (onRailway ? location.origin : 'http://localhost:5000');
      return String(chosen).replace(/\/+$/, '');
    })();

    function toApiUrl(pathOrUrl = '') {
      const s = String(pathOrUrl || '');
      if (/^https?:\/\/|^blob:/i.test(s)) return s;
      return API + (s.startsWith('/') ? s : '/' + s);
    }

    /* ---------- Initials-only helpers ---------- */
    /* ---------- Initials-only helpers ---------- */
    function getInitials(u = {}) {
      const pick = s => {
        // first Unicode letter (works beyond A–Z)
        const m = String(s || '').trim().match(/\p{L}/u);
        return m ? m[0].toUpperCase() : '';
      };

      const fullName = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim();

      // Prefer explicit first/last
      let fi = pick(u.firstName) || pick(fullName) || pick(u.username) || pick(u.email) || 'T';
      let li = pick(u.lastName);

      // If last still missing, try last token of full name, then username/email local-part
      if (!li && fullName) {
        const lastToken = fullName.split(/\s+/).filter(Boolean).pop();
        li = pick(lastToken);
      }
      if (!li) {
        const local = String(u.username || u.email || '').split('@')[0];
        const parts = local.split(/[._\s-]+/).filter(Boolean);
        if (parts.length > 1) li = pick(parts[parts.length - 1]);
      }

      return (fi + (li || '')).trim() || 'T';
    }

    function setHeaderInitials(u = {}) {
      const el = document.getElementById("Username");
      if (!el) return;
      el.textContent = getInitials(u);
      const full = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(" ").trim()
        || u.username || u.email || "Profile";
      el.setAttribute("title", full);
      el.setAttribute("aria-label", full);
    }

    /* ---------- Auth & header ---------- */
    (function () {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;
      if (!u?.userId || !u?.isTeacher) {
        window.location.href = "/TEACHER/login/login.html";
        return;
      }
      window.currentUser = u;
      setHeaderInitials(u);
    })();

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }

    /* ---------- UI refs ---------- */
    const statusSelectEl = document.getElementById('statusSelect');
    const pageSizeSelectEl = document.getElementById('pageSizeSelect');
    const freeSearchEl = document.getElementById('freeSearch');
    const refreshBtn = document.getElementById('refreshBtn');
    const essayTbody = document.getElementById('essayTbody');
    const pageIndicator = document.getElementById('pageIndicator');
    const listSummary = document.getElementById('listSummary');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const courseFilterEl = document.getElementById('courseFilter');
    const moduleFilterEl = document.getElementById('moduleFilter');
    const sortByEl = document.getElementById('sortBy');

    /* Modal refs */
    const qListEl = document.getElementById('qList');
    const qTextEl = document.getElementById('qText');
    const ansTextEl = document.getElementById('ansText');
    const scoreInput = document.getElementById('scoreInput');
    const maxInput = document.getElementById('maxInput');
    const feedbackInput = document.getElementById('feedbackInput');
    const statusInput = document.getElementById('statusInput');
    const metaInfo = document.getElementById('metaInfo');
    const modalCourseModule = document.getElementById('modalCourseModuleLine');
    const modalStudentLine = document.getElementById('modalStudentLine');
    const modalQuizLine = document.getElementById('modalQuizLine');
    const gradeForm = document.getElementById('gradeForm');
    const qIndexLine = document.getElementById('qIndexLine');
    const prevQBtn = document.getElementById('prevQBtn');
    const nextQBtn = document.getElementById('nextQBtn');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const gradeModalEl = document.getElementById('gradeModal');
    const gradeModal = new bootstrap.Modal(gradeModalEl);

    /* ---------- State ---------- */
    const teacherId =
      new URLSearchParams(location.search).get('teacherId') ||
      (window.currentUser && window.currentUser.userId) || '';

    let page = 1;
    let total = 0;
    let pageSize = parseInt(pageSizeSelectEl.value, 10);
    let lastItems = [];
    let grouped = [];
    let selectedGroup = null;
    let selIndex = 0;

    const courseLabelCache = new Map();
    const moduleLabelCache = new Map();

    /* ---------- fetch helpers (Railway-aware) ---------- */
    function withTeacher(pathOrUrl) {
      const full = toApiUrl(pathOrUrl);
      const u = new URL(full);
      if (!u.searchParams.get('teacherId') && teacherId) u.searchParams.set('teacherId', teacherId);
      return u.toString();
    }

    async function getJson(pathOrUrl) {
      const url = withTeacher(pathOrUrl);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const text = await res.text();
      if (!res.ok) throw new Error(`GET ${url} -> ${res.status}: ${text.slice(0, 200)}`);
      try { return JSON.parse(text); } catch { return {}; }
    }

    async function postJson(pathOrUrl, body) {
      const url = withTeacher(pathOrUrl);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(body || {})
      });
      const text = await res.text();
      let data = {};
      try { data = JSON.parse(text); } catch { }
      if (!res.ok || data.success === false) {
        throw new Error(data.message || `POST ${url} failed`);
      }
      return data;
    }

    /* ---------- misc helpers ---------- */
    function escapeHTML(str = '') {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function statusBadge(s = '') {
      s = s.toLowerCase();
      if (s === 'pending') return '<span class="badge bg-warning text-dark">Pending</span>';
      if (s === 'graded') return '<span class="badge bg-success">Graded</span>';
      if (s === 'needs_review') return '<span class="badge bg-secondary">Needs Review</span>';
      return '<span class="badge bg-light text-dark">—</span>';
    }

    function asDate(v) {
      if (!v) return '—';
      if (v._seconds) return new Date(v._seconds * 1000).toLocaleString();
      const d = new Date(v);
      return isNaN(d.getTime()) ? '—' : d.toLocaleString();
    }
    function toMs(v) { if (!v) return 0; if (v._seconds) return v._seconds * 1000; const d = new Date(v); return isNaN(d.getTime()) ? 0 : d.getTime(); }

    async function getCourseLabel(courseId) {
      if (!courseId) return '—';
      if (courseLabelCache.has(courseId)) return courseLabelCache.get(courseId);
      try {
        const c = await getJson(`/api/courses/${encodeURIComponent(courseId)}`);
        const label = (c && (c.title || c.name)) ? (c.title || c.name) : courseId;
        courseLabelCache.set(courseId, label);
        return label;
      } catch {
        courseLabelCache.set(courseId, courseId);
        return courseId;
      }
    }
    async function getModuleLabel(moduleId) {
      if (!moduleId) return '—';
      if (moduleLabelCache.has(moduleId)) return moduleLabelCache.get(moduleId);
      try {
        const m = await getJson(`/modules/${encodeURIComponent(moduleId)}`);
        const label = (m && (m.title || m.name)) ? (m.title || m.name) : moduleId;
        moduleLabelCache.set(moduleId, label);
        return label;
      } catch {
        moduleLabelCache.set(moduleId, moduleId);
        return moduleId;
      }
    }

    /* ---------- Normalizer ---------- */
    function normalizeListResponse(resp) {
      const rawItems = Array.isArray(resp) ? resp
        : Array.isArray(resp.items) ? resp.items
          : Array.isArray(resp.submissions) ? resp.submissions
            : [];

      const norm = rawItems.map(r => {
        return {
          id: r.id || r.submissionId || r.attemptId || r.docId || r._id,

          questionTitle: r.questionTitle || r.question_text || r.questionText || r.question || '',
          questionText: r.questionText || r.questionTitle || r.question || '',
          answer: r.answer ?? r.studentAnswer ?? r.essay ?? '',
          status: (r.status || r.state || 'pending').toLowerCase(),
          score: (r.score != null) ? Number(r.score) : (r.givenScore != null ? Number(r.givenScore) : null),
          maxScore: (r.maxScore != null) ? Number(r.maxScore) : (r.totalScore != null ? Number(r.totalScore) : 10),
          createdAt: r.createdAt || r.submittedAt || r.created || r.timestamp || null,

          studentName: r.studentName || 'Student',
          studentId: r.studentId || r.uid || r.userId || null,

          quizId: r.quizId || r.quiz_id || '',
          quizTitle: r.quizTitle || r.quiz_name || '',
          attemptId: r.attemptId || r.attempt_id || null,

          courseId: r.courseId || r.course_id || '',
          moduleId: r.moduleId || r.module_id || ''
        };
      });

      const total = Number(resp.total ?? norm.length) || norm.length;
      return { items: norm, total };
    }

    function groupBySubmission(items) {
      const map = new Map();
      for (const x of items) {
        const key = [
          x.studentId || '',
          x.studentName || '',
          x.quizId || '',
          x.attemptId || '',
          x.courseId || '',
          x.moduleId || ''
        ].join('|');

        if (!map.has(key)) {
          map.set(key, {
            key,
            studentName: x.studentName,
            quizId: x.quizId,
            quizTitle: x.quizTitle || '',
            attemptId: x.attemptId,
            courseId: x.courseId,
            moduleId: x.moduleId,
            createdAt: x.createdAt,
            essays: []
          });
        }
        const g = map.get(key);
        g.essays.push(x);
        if (!g.createdAt || (x.createdAt && new Date(x.createdAt) < new Date(g.createdAt))) g.createdAt = x.createdAt;
        if (!g.quizTitle && x.quizTitle) g.quizTitle = x.quizTitle;
      }
      const groups = [...map.values()].map(g => {
        const statuses = g.essays.map(e => e.status);
        let groupStatus = 'graded';
        if (statuses.some(s => s === 'pending')) groupStatus = 'pending';
        else if (statuses.some(s => s === 'needs_review')) groupStatus = 'needs_review';
        return { ...g, status: groupStatus };
      });
      return groups;
    }

    async function loadTeacherCoursesForFilter() {
      try {
        const data = await getJson(`/api/teacher/dashboard-stats?teacherId=${encodeURIComponent(teacherId)}`);
        const courses = Array.isArray(data?.courses) ? data.courses : [];
        courseFilterEl.innerHTML = `<option value="">All Courses</option>` +
          courses.map(c => {
            const id = c.id || c.courseId;
            const title = c.title || c.name || 'Untitled';
            if (id) courseLabelCache.set(id, title);
            return id ? `<option value="${escapeHTML(id)}">${escapeHTML(title)}</option>` : '';
          }).join('');
      } catch { /* silent */ }
    }
    async function loadModulesForCourse(courseId) {
      moduleFilterEl.innerHTML = `<option value="">All Modules</option>`;
      moduleFilterEl.disabled = !courseId;
      if (!courseId) return;
      try {
        const resp = await getJson(`/courses/${encodeURIComponent(courseId)}/modules`);
        const modules = Array.isArray(resp?.modules) ? resp.modules : (Array.isArray(resp) ? resp : []);
        moduleFilterEl.innerHTML = `<option value="">All Modules</option>` +
          modules.map(m => `<option value="${escapeHTML(m.id)}">${escapeHTML(m.title || 'Untitled Module')}</option>`).join('');
        modules.forEach(m => moduleLabelCache.set(m.id, m.title || 'Untitled Module'));
      } catch { /* silent */ }
    }

    async function loadEssays() {
      essayTbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">Loading…</td></tr>`;
      const status = statusSelectEl.value;
      pageSize = parseInt(pageSizeSelectEl.value, 10) || 20;

      // Unified API path (works with same-origin on Railway or explicit API base)
      const base = `/api/teacher/quiz-essays?status=${encodeURIComponent(status)}&page=${page}&pageSize=${pageSize}`;
      try {
        const resp = await getJson(base);
        const { items, total: t } = normalizeListResponse(resp);

        total = t || 0;
        lastItems = items || [];
        grouped = groupBySubmission(lastItems);

        await Promise.all([...new Set(grouped.map(g => g.courseId)).values()].filter(Boolean).map(getCourseLabel));
        await Promise.all([...new Set(grouped.map(g => g.moduleId)).values()].filter(Boolean).map(getModuleLabel));

        applyFiltersAndRender();
      } catch (err) {
        console.error(err);
        essayTbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Failed to load essays.</td></tr>`;
        showAppAlert('Failed to load essays.', { variant: 'danger' });
      }
    }

    function applyFiltersAndRender() {
      const q = (freeSearchEl.value || '').toLowerCase().trim();
      const fCourse = courseFilterEl.value;
      const fModule = moduleFilterEl.value;

      let view = grouped.filter(g => {
        if (fCourse && g.courseId !== fCourse) return false;
        if (fModule && g.moduleId !== fModule) return false;
        if (q) {
          const hay = `${g.studentName} ${g.quizTitle || ''} ${(courseLabelCache.get(g.courseId) || '')} ${(moduleLabelCache.get(g.moduleId) || '')} ${g.essays.map(e => `${e.questionText} ${e.answer}`).join(' ')}`
            .toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      // Sorting
      const sort = sortByEl.value;
      view.sort((a, b) => {
        if (sort === 'submitted_asc') return toMs(a.createdAt) - toMs(b.createdAt);
        if (sort === 'student_az') return (a.studentName || '').localeCompare(b.studentName || '');
        if (sort === 'course_az') return (courseLabelCache.get(a.courseId) || '').localeCompare(courseLabelCache.get(b.courseId) || '');
        if (sort === 'module_az') return (moduleLabelCache.get(a.moduleId) || '').localeCompare(moduleLabelCache.get(b.moduleId) || '');
        if (sort === 'quiz_az') return (a.quizTitle || '').localeCompare(b.quizTitle || '');
        return toMs(b.createdAt) - toMs(a.createdAt); // default newest first
      });

      renderList(view);
      renderPager();
    }

    function renderList(view) {
      if (!view.length) {
        essayTbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No results</td></tr>`;
        return;
      }

      essayTbody.innerHTML = view.map(g => {
        const cLabel = escapeHTML(courseLabelCache.get(g.courseId) || '—');
        const mLabel = escapeHTML(moduleLabelCache.get(g.moduleId) || '—');
        const badge = statusBadge(g.status);
        const submitted = asDate(g.createdAt);
        const quizLabel = escapeHTML(g.quizTitle || '—');
        const count = g.essays.length;

        return `
          <tr>
            <td>${escapeHTML(g.studentName || 'Student')}</td>
            <td>${cLabel}</td>
            <td>${mLabel}</td>
            <td>${quizLabel}</td>
            <td>${count}</td>
            <td>${badge}</td>
            <td>${submitted}</td>
            <td>
              <button class="btn btn-sm btn-amber" data-key="${escapeHTML(g.key)}" data-action="open-group">
                <i class="bi bi-pencil-square"></i> Grade ${count}
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderPager() {
      const pages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.min(Math.max(1, page), pages);
      pageIndicator.textContent = `${page} / ${pages}`;
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= pages;
      listSummary.textContent = `${total} essay item${total === 1 ? '' : 's'} • page size ${pageSize}`;
    }

    /* ---------- Group modal ---------- */
    function fillSidebar(group) {
      qListEl.innerHTML = group.essays.map((e, i) => {
        const preview = (e.answer || '').slice(0, 60).replace(/\n/g, ' ') + ((e.answer || '').length > 60 ? '…' : '');
        const statusSmall = e.status === 'graded' ? 'graded' : (e.status === 'needs_review' ? 'needs review' : 'pending');
        return `
          <div class="q-item ${i === selIndex ? 'active' : ''}" data-idx="${i}">
            <div class="fw-semibold">${i + 1}. ${escapeHTML(e.questionTitle || 'Essay')}</div>
            <div class="small">${escapeHTML(preview)}</div>
            <div class="small">Status: ${escapeHTML(statusSmall)}</div>
          </div>
        `;
      }).join('');
    }

    function loadQuestionIntoForm(group, index) {
      const e = group.essays[index];
      if (!e) return;

      document.querySelectorAll('.q-item').forEach(el => el.classList.remove('active'));
      const active = qListEl.querySelector(`.q-item[data-idx="${index}"]`);
      if (active) active.classList.add('active');

      qIndexLine.textContent = `${index + 1} / ${group.essays.length}`;
      qTextEl.textContent = e.questionText || e.questionTitle || '';
      ansTextEl.textContent = e.answer || '';
      scoreInput.value = (e.score != null ? e.score : '');
      maxInput.value = e.maxScore ?? 10;
      feedbackInput.value = e.feedback || '';
      statusInput.value = (e.status === 'graded' || e.status === 'needs_review') ? e.status : 'graded';
      metaInfo.textContent = `${group.studentName || 'Student'} • Submitted ${asDate(e.createdAt)}`;
    }

    async function openGroupByKey(key) {
      const group = grouped.find(g => g.key === key);
      if (!group) return;

      selectedGroup = group;
      selIndex = 0;

      modalStudentLine.textContent = group.studentName || 'Student';
      modalQuizLine.textContent = `Quiz: ${group.quizTitle || '—'}`;
      const cLabel = courseLabelCache.get(group.courseId) || '—';
      const mLabel = moduleLabelCache.get(group.moduleId) || '—';
      modalCourseModule.textContent = `Course: ${cLabel} • Module: ${mLabel}`;

      fillSidebar(group);
      loadQuestionIntoForm(group, selIndex);

      gradeModal.show();
    }

    async function saveOne(eObj) {
      const body = {
        score: Number(scoreInput.value),
        maxScore: Number(maxInput.value),
        feedback: feedbackInput.value || '',
        status: statusInput.value || 'graded'
      };
      if (!Number.isFinite(body.score) || body.score < 0) { showAppAlert('Score must be a non-negative number.', { variant: 'warning' }); return; }
      if (!Number.isFinite(body.maxScore) || body.maxScore <= 0) { showAppAlert('Total Score must be a positive number.', { variant: 'warning' }); return; }
      await postJson(`/api/teacher/quiz-essays/${encodeURIComponent(eObj.id)}/grade`, body);
      Object.assign(eObj, body); eObj.status = body.status;
    }

    async function saveAll(group) {
      const promises = [];
      const current = group.essays[selIndex];
      if (current) { await saveOne(current); }
      for (const e of group.essays) {
        const payload = {
          score: (e.score != null ? e.score : 0),
          maxScore: (e.maxScore != null ? e.maxScore : 10),
          feedback: (e.feedback || ''),
          status: (e.status || 'graded')
        };
        promises.push(postJson(`/api/teacher/quiz-essays/${encodeURIComponent(e.id)}/grade`, payload));
      }
      await Promise.all(promises);
    }

    /* ---------- Events ---------- */
    essayTbody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action="open-group"]');
      if (!btn) return;
      const key = btn.getAttribute('data-key');
      if (key) openGroupByKey(key).catch(err => {
        console.error(err);
        showAppAlert('Failed to load submission.', { variant: 'danger' });
      });
    });

    qListEl.addEventListener('click', (e) => {
      const box = e.target.closest('.q-item');
      if (!box || !selectedGroup) return;
      const idx = parseInt(box.getAttribute('data-idx'), 10);
      if (!Number.isInteger(idx)) return;
      const cur = selectedGroup.essays[selIndex];
      if (cur) {
        cur.score = (scoreInput.value !== '' ? Number(scoreInput.value) : cur.score);
        cur.maxScore = Number(maxInput.value) || cur.maxScore;
        cur.feedback = feedbackInput.value || cur.feedback;
        cur.status = statusInput.value || cur.status;
      }
      selIndex = idx;
      loadQuestionIntoForm(selectedGroup, selIndex);
    });

    gradeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedGroup) return;
      const essay = selectedGroup.essays[selIndex];
      if (!essay) return;

      const btn = gradeForm.querySelector('button[type="submit"]');
      btn.disabled = true;
      try {
        await saveOne(essay);
        fillSidebar(selectedGroup);
        showAppAlert('Saved.', { variant: 'success' });
      } catch (err) {
        console.error(err);
        showAppAlert('Failed to save grade.', { variant: 'danger' });
      } finally {
        btn.disabled = false;
      }
    });

    prevQBtn.addEventListener('click', () => {
      if (!selectedGroup) return;
      if (selIndex > 0) {
        const cur = selectedGroup.essays[selIndex];
        cur.score = (scoreInput.value !== '' ? Number(scoreInput.value) : cur.score);
        cur.maxScore = Number(maxInput.value) || cur.maxScore;
        cur.feedback = feedbackInput.value || cur.feedback;
        cur.status = statusInput.value || cur.status;

        selIndex -= 1;
        loadQuestionIntoForm(selectedGroup, selIndex);
      }
    });

    nextQBtn.addEventListener('click', () => {
      if (!selectedGroup) return;
      if (selIndex < selectedGroup.essays.length - 1) {
        const cur = selectedGroup.essays[selIndex];
        cur.score = (scoreInput.value !== '' ? Number(scoreInput.value) : cur.score);
        cur.maxScore = Number(maxInput.value) || cur.maxScore;
        cur.feedback = feedbackInput.value || cur.feedback;
        cur.status = statusInput.value || cur.status;

        selIndex += 1;
        loadQuestionIntoForm(selectedGroup, selIndex);
      }
    });

    saveAllBtn.addEventListener('click', async () => {
      if (!selectedGroup) return;
      saveAllBtn.disabled = true;
      try {
        await saveAll(selectedGroup);
        gradeModal.hide();
        await loadEssays();
        showAppAlert('All grades saved.', { variant: 'success' });
      } catch (err) {
        console.error(err);
        showAppAlert('Failed to save all grades.', { variant: 'danger' });
      } finally {
        saveAllBtn.disabled = false;
      }
    });

    statusSelectEl.addEventListener('change', () => { page = 1; loadEssays().catch(console.error); });
    pageSizeSelectEl.addEventListener('change', () => { page = 1; loadEssays().catch(console.error); });
    refreshBtn.addEventListener('click', () => loadEssays().catch(console.error));
    freeSearchEl.addEventListener('input', applyFiltersAndRender);
    sortByEl.addEventListener('change', applyFiltersAndRender);

    courseFilterEl.addEventListener('change', async () => {
      const cid = courseFilterEl.value;
      await loadModulesForCourse(cid);
      moduleFilterEl.value = '';
      applyFiltersAndRender();
    });
    moduleFilterEl.addEventListener('change', applyFiltersAndRender);

    prevBtn.addEventListener('click', () => { if (page > 1) { page--; loadEssays().catch(console.error); } });
    nextBtn.addEventListener('click', () => { page++; loadEssays().catch(console.error); });

    /* ---------- Boot ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
      if (!teacherId) {
        showAppAlert("Missing teacherId. Please log in again.", { variant: 'warning' });
        window.location.href = "/TEACHER/login/login.html";
        return;
      }
      await loadTeacherCoursesForFilter();
      await loadEssays().catch(err => {
        console.error(err);
        essayTbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Failed to load essays.</td></tr>`;
        showAppAlert('Failed to load essays.', { variant: 'danger' });
      });
    });
  </script>
</body>

</html>