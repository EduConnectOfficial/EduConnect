<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher â€“ Quizzes</title>

  <!-- Optional on Railway if your API is on a different host -->
  <!-- <meta name="api-base" content="https://your-api.onrailway.app"> -->

  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Page CSS -->
  <link rel="stylesheet" href="quiz.list.css" />
  <link rel="stylesheet" href="../quizzes/quiz.list.css" />
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="searchBox" type="text" class="form-control" placeholder="Search quizzesâ€¦" />
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <div class="content container-fluid">
        <h1 class="page-title">Quizzes</h1>

        <!-- Controls block -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-ui-checks-grid"></i> Your Course Quizzes</h2>
            <div class="ui-subtext">Everything shows up right away. Use filters only if you want to narrow it down.</div>
          </div>

          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-5 col-xl-4">
              <label class="form-label">Course</label>
              <select id="courseSelect" class="form-select" aria-label="Filter by course">
                <option value="">All courses</option>
              </select>
            </div>
            <div class="col-12 col-md-4 col-xl-3">
              <label class="form-label">Module</label>
              <select id="moduleSelect" class="form-select" aria-label="Filter by module" disabled>
                <option value="">All modules</option>
              </select>
            </div>
            <div class="col-12 col-md-3 col-xl-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select" aria-label="Sort quizzes">
                <option value="due" selected>Nearest due date</option>
                <option value="new">Newest first</option>
                <option value="az">Title A â†’ Z</option>
              </select>
            </div>

            <!-- Segmented Active/Archived/All -->
            <div class="col-12 col-md-5 col-xl-3">
              <label class="form-label">Show</label>
              <div class="segmented" role="tablist" aria-label="Quiz visibility">
                <button id="btnActive" class="seg-btn is-active" role="tab" aria-selected="true">Active</button>
                <button id="btnArchived" class="seg-btn is-archived" role="tab" aria-selected="false">Archived</button>
                <button id="btnAll" class="seg-btn is-all" role="tab" aria-selected="false">All</button>
              </div>
            </div>

            <div class="col-12 col-xl-2 d-flex justify-content-xl-end">
              <button id="newQuizBtn" class="btn btn-amber w-100 w-xl-auto mt-2 mt-xl-0" onclick="goCreateQuiz()">
                <i class="bi bi-plus-circle me-1"></i>Create Quiz
              </button>
            </div>
          </div>
        </div>

        <!-- Always-visible pills -->
        <div class="pill-row">
          <span id="activeCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-check-circle me-1"></i><span id="activeCount">0</span> Active
          </span>
          <span id="archivedCountPill" class="badge rounded-pill text-bg-light">
            <i class="bi bi-archive me-1"></i><span id="archivedCount">0</span> Archived
          </span>
        </div>

        <div id="quizGrid" class="row g-3"></div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Page logic -->
  <script>
    // Railway-friendly API base resolution
    const API = (
      document.querySelector('meta[name="api-base"]')?.content ||
      window.API_BASE ||
      ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:5000' : '/api')
    );

    /* ------- initials-only helper ------- */
    function getInitials(u = {}) {
      const fn = (u.firstName || "").trim();
      const ln = (u.lastName || "").trim();
      if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

      const nameish = (u.username || u.displayName || u.name || "").trim();
      if (nameish) {
        const parts = nameish.replace(/[^A-Za-z0-9 _.\-]+/g, " ")
                             .split(/[\s._-]+/).filter(Boolean);
        if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
        return parts[0][0].toUpperCase();
      }
      const em = (u.email || "").trim();
      return em ? em[0].toUpperCase() : "U";
    }
    function setHeaderInitials(u = {}) {
      const el = document.getElementById("Username");
      if (!el) return;
      el.textContent = getInitials(u);
      const full = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(" ").trim()
                || u.username || u.email || "Profile";
      el.setAttribute("title", full);
      el.setAttribute("aria-label", full);
    }

    // Auth (teacher-only)
    const stored = JSON.parse(localStorage.getItem("user") || "{}");
    const userData = stored.user || stored;
    if (!userData?.userId || !userData?.isTeacher) {
      window.location.href = "/TEACHER/login/login.html";
    }
    setHeaderInitials(userData);
    const TEACHER_ID = userData.userId;

    // DOM
    const elCourse = document.getElementById('courseSelect');
    const elModule = document.getElementById('moduleSelect');
    const elGrid   = document.getElementById('quizGrid');
    const elSort   = document.getElementById('sortBy');
    const elSearch = document.getElementById('searchBox');
    const btnActive   = document.getElementById('btnActive');
    const btnArchived = document.getElementById('btnArchived');
    const btnAll      = document.getElementById('btnAll');
    const elActiveCount   = document.getElementById('activeCount');
    const elArchivedCount = document.getElementById('archivedCount');

    // ---------- Status Modal (reusable) ----------
    const statusModalEl = document.createElement('div');
    statusModalEl.innerHTML = `
      <div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header" id="statusHeader">
              <h5 class="modal-title" id="statusTitle">Notice</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="statusBody">â€”</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-amber" data-bs-dismiss="modal" id="statusOkBtn">OK</button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(statusModalEl.firstElementChild);
    const statusHeader = document.getElementById('statusHeader');
    const statusTitle  = document.getElementById('statusTitle');
    const statusBody   = document.getElementById('statusBody');
    const statusModal  = () => new bootstrap.Modal(document.getElementById('statusModal'));
    function showStatus(message, { title, variant="info" } = {}) {
      statusTitle.textContent = title || (variant === "error" ? "Error" : variant === "success" ? "Success" : "Notice");
      statusBody.textContent  = message;
      statusHeader.className  = "modal-header";
      if (variant === "error")  statusHeader.classList.add('bg-danger','text-white');
      if (variant === "success")statusHeader.classList.add('bg-success','text-white');
      if (variant === "info")   statusHeader.classList.add('bg-info','text-white');
      closeAllModals();
      statusModal().show();
    }

    // ---------- Delete Confirmation Modal ----------
    const deleteModalWrap = document.createElement('div');
    deleteModalWrap.innerHTML = `
      <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true" aria-labelledby="deleteConfirmTitle">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header brandlike">
              <h5 class="modal-title" id="deleteConfirmTitle">Delete Quiz</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p id="deleteInstruction" class="mb-2 no-copy">
                Confirm you want to delete this quiz and all associated data by typing:
                <strong class="no-copy">Quiz Title</strong> (case-sensitive).
              </p>
              <div class="mb-2">
                <div class="form-control confirm-pill no-copy" id="deleteExactPill" aria-hidden="true"
                     style="display:flex;align-items:center;gap:.5rem;">
                  <span class="small text-muted no-copy">Type exactly:</span>
                  <strong id="deleteExactText" class="no-copy">â€”</strong>
                </div>
              </div>
              <label for="confirmDeleteInput" class="form-label small mb-1">Type Quiz Title here</label>
              <input id="confirmDeleteInput" type="text" class="form-control" autocomplete="off"
                     aria-describedby="deleteHelp" placeholder="Exact quiz title"/>
              <div id="deleteHelp" class="invalid-feedback no-copy">
                Input does not match. Please type
                <strong id="deleteExactHint" class="no-copy">â€”</strong> to proceed.
              </div>
              <div id="deleteMatchOk" class="valid-feedback">Title matches. You can proceed.</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="deleteConfirmBtn" disabled>
                <i class="bi bi-trash me-1"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(deleteModalWrap.firstElementChild);

    const deleteConfirmBtn   = document.getElementById('deleteConfirmBtn');
    const confirmDeleteInput = document.getElementById('confirmDeleteInput');
    const deleteExactText    = document.getElementById('deleteExactText');
    const deleteExactHint    = document.getElementById('deleteExactHint');

    // Close any open modal helper
    function closeAllModals() {
      document.querySelectorAll('.modal.show').forEach(m => {
        try { bootstrap.Modal.getInstance(m)?.hide(); } catch {}
      });
    }

    // State
    let coursesList = [];
    const courseMap = new Map();
    let masterQuizzes = [];
    let filtered = [];
    let currentCourseId = '';
    let currentModuleId = '';
    let statusFilter = 'active';
    const moduleCache = new Map();
    let pendingDelete = null; // { id, title, btnEl }

    // Utils
    function goCreateQuiz() { window.location.href = "/TEACHER/quizzes/quiz.html"; }
    function escapeHTML(str = '') { return String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
    function preview(text, n = 160) { const t = (text || '').trim(); return t.length > n ? `${t.slice(0, n)}â€¦` : t; }
    function tsToMs(ts) {
      if (!ts) return null;
      const s = ts._seconds ?? ts.seconds;
      const ns = ts._nanoseconds ?? ts.nanoseconds ?? 0;
      if (typeof s === 'number') return (s * 1000) + Math.floor(ns / 1e6);
      if (typeof ts === 'number') return ts;
      const d = new Date(ts);
      return isNaN(d.getTime()) ? null : d.getTime();
    }
    function withSpinner(btnEl) {
      if (!btnEl || !(btnEl instanceof HTMLElement)) return () => {};
      const original = btnEl.innerHTML;
      btnEl.disabled = true;
      btnEl.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Workingâ€¦';
      return () => { btnEl.disabled = false; btnEl.innerHTML = original; };
    }

    // Load courses (robust)
    async function loadCourses() {
      try {
        const res = await fetch(`${API}/courses?uploadedBy=${encodeURIComponent(TEACHER_ID)}`);
        let courses = await res.json();
        if (!Array.isArray(courses) && Array.isArray(courses?.courses)) courses = courses.courses;
        if (!Array.isArray(courses) || courses.length === 0) {
          try {
            const resAll = await fetch(`${API}/courses`);
            courses = await resAll.json();
            if (!Array.isArray(courses) && Array.isArray(courses?.courses)) courses = courses.courses;
          } catch {}
        }
        if (!Array.isArray(courses)) courses = [];

        courses.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
        coursesList = courses.map((c, idx) => {
          const n = Number.isFinite(c?.courseNumber) ? c.courseNumber : (idx + 1);
          const title = c.title || c.name || 'Untitled';
          const label = `#${n} â€” ${title}`;
          courseMap.set(c.id, { title, courseNumber: n, label });
          return { id: c.id, title, courseNumber: n, label };
        });

        const opts = ['<option value="">All courses</option>'];
        coursesList.forEach(c => opts.push(`<option value="${c.id}">${escapeHTML(c.label)}</option>`));
        elCourse.innerHTML = opts.join('');
      } catch (e) {
        console.error(e);
        elCourse.innerHTML = `<option value="">All courses</option>`;
        coursesList = [];
      }
    }

    // Module meta cache
    async function getModuleMeta(moduleId) {
      if (!moduleId) return null;
      if (moduleCache.has(moduleId)) return moduleCache.get(moduleId);
      try {
        const r = await fetch(`${API}/modules/${encodeURIComponent(moduleId)}`);
        const js = await r.json();
        const meta = js && js.id ? { title: js.title || '', moduleNumber: js.moduleNumber ?? null, courseId: js.courseId } : null;
        moduleCache.set(moduleId, meta);
        return meta;
      } catch {
        moduleCache.set(moduleId, null);
        return null;
      }
    }

    async function populateModuleFilterForCourse(courseId) {
      elModule.disabled = !courseId;
      if (!courseId) {
        elModule.innerHTML = `<option value="">All modules</option>`;
        return;
      }
      try {
        const res = await fetch(`${API}/courses/${encodeURIComponent(courseId)}/modules`);
        const js = await res.json();
        const mods = Array.isArray(js) ? js : (js.modules || []);
        mods.sort((a, b) => (a.moduleNumber || 0) - (b.moduleNumber || 0));
        elModule.innerHTML = `<option value="">All modules</option>` +
          mods.map(m => `<option value="${m.id}">Module ${m.moduleNumber ?? ''}: ${escapeHTML(m.title || 'Untitled')}</option>`).join('');
        elModule.disabled = false;
      } catch {
        elModule.innerHTML = `<option value="">(Failed to load modules)</option>`;
        elModule.disabled = true;
      }
    }

    // PRELOAD all quizzes
    async function preloadAllQuizzes() {
      elGrid.innerHTML = `<div class="col-12"><div class="empty text-center">Loading quizzesâ€¦</div></div>`;
      try {
        const res = await fetch(`${API}/quizzes?includeArchived=1`);
        const data = await res.json();
        const all = Array.isArray(data) ? data : (Array.isArray(data.quizzes) ? data.quizzes : []);

        const allowedCourseIds = new Set((coursesList || []).map(c => c.id));
        const mine = allowedCourseIds.size ? all.filter(q => allowedCourseIds.has(q.courseId)) : all;

        const uniqueModuleIds = [...new Set(mine.map(q => q.moduleId).filter(Boolean))];
        await Promise.all(uniqueModuleIds.map(getModuleMeta));

        masterQuizzes = mine.map(q => {
          const m = q.moduleId ? moduleCache.get(q.moduleId) : null;
          return {
            ...q,
            _archived: !!(q.archived || q.isArchived),
            _dueMs: tsToMs(q.dueAt),
            _createdMs: tsToMs(q.createdAt) ?? 0,
            _course: courseMap.get(q.courseId) || null,
            _module: m
          };
        });

        currentCourseId = '';
        currentModuleId = '';
        elCourse.value = '';
        elModule.innerHTML = `<option value="">All modules</option>`;
        elModule.disabled = true;
        elSort.value = 'due';
        elSearch.value = '';
        setSegmentedActive('active');

        refreshQuizPills();
      } catch (e) {
        console.error(e);
        elGrid.innerHTML = `<div class="col-12"><div class="empty text-center text-danger">Failed to load quizzes.</div></div>`;
      }
    }

    function refreshQuizPills() {
      const activeCount = masterQuizzes.filter(z => !z._archived).length;
      const archivedCount = masterQuizzes.filter(z => z._archived).length;
      if (elActiveCount) elActiveCount.textContent = String(activeCount);
      if (elArchivedCount) elArchivedCount.textContent = String(archivedCount);
    }

    function applyFilters() {
      const q = (elSearch.value || '').toLowerCase().trim();
      let list = masterQuizzes.slice();

      if (currentCourseId) list = list.filter(z => z.courseId === currentCourseId);
      if (currentCourseId && currentModuleId) list = list.filter(z => z.moduleId === currentModuleId);

      if (q) {
        list = list.filter(z => {
          const hay = `${z.title || ''} ${z.description || ''} ${(z._course?.title) || ''} ${(z._module?.title) || ''}`.toLowerCase();
          return hay.includes(q);
        });
      }

      if (statusFilter === 'active') list = list.filter(z => !z._archived);
      if (statusFilter === 'archived') list = list.filter(z => z._archived);

      const s = elSort.value;
      if (s === 'az') list.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      else if (s === 'due') list.sort((a, b) => (a._dueMs ?? Infinity) - (b._dueMs ?? Infinity));
      else list.sort((a, b) => (b._createdMs ?? 0) - (a._createdMs ?? 0));

      filtered = list;
      renderGrid();
    }

    function fmtModule(meta) {
      if (!meta) return 'â€”';
      const n = meta.moduleNumber;
      const t = (meta.title || '').trim();
      if (n != null && t) return `Module ${n} â€¢ ${escapeHTML(t)}`;
      if (n != null) return `Module ${n}`;
      return escapeHTML(t || 'â€”');
    }

    async function setArchive(id, on, btnEl) {
      const restore = withSpinner(btnEl);
      try {
        closeAllModals();
        const res = await fetch(`${API}/quizzes/${id}/archive`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ archived: !!on })
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok || !j.success) {
          showStatus(j.message || 'Archive endpoint not found on server. Please add PATCH /quizzes/:id/archive.', { variant: 'error' });
          return;
        }
        await preloadAllQuizzes();
        applyFilters();
        showStatus(on ? 'Quiz archived.' : 'Quiz unarchived.', { variant: 'success' });
      } catch (e) {
        console.error(e);
        showStatus('Server error while updating archive state.', { variant: 'error' });
      } finally {
        restore();
      }
    }

    // ==== OPEN delete modal (exact title) ====
    async function deleteQuiz(id, title, btnEl) {
      pendingDelete = { id, title: title || '', btnEl };
      closeAllModals();

      const exact = title || 'Untitled';
      deleteExactText.textContent = exact;
      deleteExactHint.textContent = exact;

      confirmDeleteInput.value = '';
      confirmDeleteInput.classList.remove('is-valid', 'is-invalid');
      deleteConfirmBtn.disabled = true;

      const modalEl = document.getElementById('deleteConfirmModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      // HARDEN COPY/SELECTION inside the modal (keep input usable)
      hardenDeleteModal(modalEl);

      setTimeout(() => { try { confirmDeleteInput.focus(); } catch {} }, 200);
    }

    // Live validation (case-sensitive exact match)
    confirmDeleteInput.addEventListener('input', () => {
      const expected = pendingDelete?.title || '';
      const val = confirmDeleteInput.value || '';
      const match = val === expected;

      confirmDeleteInput.classList.toggle('is-valid', match);
      confirmDeleteInput.classList.toggle('is-invalid', !match);
      deleteConfirmBtn.disabled = !match;
    });

    // Allow Enter to confirm if enabled
    confirmDeleteInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !deleteConfirmBtn.disabled) {
        e.preventDefault();
        deleteConfirmBtn.click();
      }
    });

    // Do the deletion
    deleteConfirmBtn.addEventListener('click', async () => {
      const ctx = pendingDelete;
      if (!ctx) return;
      const { id, btnEl } = ctx;
      pendingDelete = null;

      const restore = withSpinner(btnEl);
      try {
        const res = await fetch(`${API}/quizzes/${id}`, { method: 'DELETE' });
        const j = await res.json().catch(() => ({}));
        if (res.ok && j.success) {
          showStatus(j.message || 'Quiz deleted.', { variant: 'success' });
          await preloadAllQuizzes();
          applyFilters();
        } else {
          showStatus(j.message || 'Failed to delete quiz.', { variant: 'error' });
        }
      } catch (e) {
        console.error(e);
        showStatus('Server error while deleting the quiz.', { variant: 'error' });
      } finally {
        restore();
      }
    });

    // ðŸ”¸ open editor page instead of modal
    function openEdit(id) {
      window.location.href = `/TEACHER/quizzes/edit_quiz.html?quizId=${encodeURIComponent(id)}`;
    }
    window.openEdit = openEdit;

    function renderGrid() {
      if (!filtered.length) {
        elGrid.innerHTML = `<div class="col-12"><div class="empty text-center">No quizzes found.</div></div>`;
        return;
      }

      elGrid.innerHTML = filtered.map((qz, idx) => {
        const s = qz.settings || {};
        theTimer = !!s.timerEnabled;
        const timerTxt = theTimer ? `${s.durationMinutes || 0}m + ${s.graceSeconds || 0}s` : 'Disabled';
        const dueTxt = qz._dueMs ? new Date(qz._dueMs).toLocaleString() : 'â€”';
        const attemptsTxt = (qz.attemptsAllowed == null || qz.attemptsAllowed === 0) ? 'Unlimited' : qz.attemptsAllowed;

        const randTxt = (s.shuffleQuestions === false) ? 'Fixed order' : 'Randomized';
        const pageTxt = (s.pagination?.enabled) ? `Paged (${s.pagination.perPage || 1})` : 'No paging';
        const backTxt = (s.backtrackingAllowed === false) ? 'Back locked' : 'Back allowed';

        const courseBadge = qz._course
          ? `<span class="pill pill-course" title="${escapeHTML(qz._course.label)}">
               <i class="bi bi-book"></i>
               <span class="pill-text">${escapeHTML(qz._course.label)}</span>
             </span>` : '';

        const moduleLabel = qz._module ? fmtModule(qz._module) : '';
        const moduleBadge = moduleLabel
          ? `<span class="pill pill-module" title="${escapeHTML(moduleLabel)}">
               <i class="bi bi-box"></i>
               <span class="pill-text">${escapeHTML(moduleLabel)}</span>
             </span>` : '';

        const archivedPill = qz._archived
          ? `<span class="pill pill-archived ms-2"><i class="bi bi-archive"></i>Archived</span>` : '';

        const headerHtml = `
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center gap-2">
              <h5 class="m-0">${escapeHTML(qz.title || ('Quiz ' + (idx + 1)))}</h5>
              ${archivedPill}
            </div>
            <span class="badge-soft"><i class="bi bi-stopwatch"></i>${timerTxt}</span>
          </div>`;

        const titleArg = JSON.stringify(qz.title || '');

        return `
          <div class="col-12 col-md-6 col-xl-4 col-xxl-3">
            <div class="quiz-card">
              ${headerHtml}

              <div class="mb-2 d-flex flex-wrap gap-1">
                ${courseBadge}${moduleBadge ? ` ${moduleBadge}` : ''}
              </div>

              <div class="text-muted small mb-2">${escapeHTML(preview(qz.description || '', 160))}</div>

              <div class="d-flex flex-wrap gap-1 mb-2">
                <span class="badge-soft"><i class="bi bi-shuffle"></i>${randTxt}</span>
                <span class="badge-soft"><i class="bi bi-grid-1x2"></i>${pageTxt}</span>
                <span class="badge-soft"><i class="bi bi-arrow-left-right"></i>${backTxt}</span>
              </div>

              <div class="d-flex align-items-center justify-content-between small-muted">
                <span><i class="bi bi-calendar2-week me-1"></i><strong>Due:</strong> ${dueTxt}</span>
                <span>Attempts: ${attemptsTxt}</span>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-3">
                ${qz._archived
                  ? `<button class="btn btn-sm btn-unarchive" onclick="setArchive('${qz.id}', false, this)">
                       <i class="bi bi-arrow-counterclockwise"></i> Unarchive
                     </button>`
                  : `<button class="btn btn-archive" onclick="setArchive('${qz.id}', true, this)">
                       <i class="bi bi-archive"></i> Archive
                     </button>`}
                <button class="btn btn-sm btn-edit" onclick="openEdit('${qz.id}')">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" title="Also removes student scores/attempts"
                        onclick='deleteQuiz("${qz.id}", ${titleArg}, this)'>
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    // Segmented control
    function setSegmentedActive(which) {
      statusFilter = which;
      [btnActive, btnArchived, btnAll].forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected', 'false'); });
      if (which === 'active')   { btnActive.classList.add('is-active');   btnActive.setAttribute('aria-selected', 'true'); }
      if (which === 'archived') { btnArchived.classList.add('is-active'); btnArchived.setAttribute('aria-selected', 'true'); }
      if (which === 'all')      { btnAll.classList.add('is-active');      btnAll.setAttribute('aria-selected', 'true'); }
      applyFilters();
    }
    btnActive?.addEventListener('click', () => setSegmentedActive('active'));
    btnArchived?.addEventListener('click', () => setSegmentedActive('archived'));
    btnAll?.addEventListener('click', () => setSegmentedActive('all'));

    // Events
    elCourse.addEventListener('change', async () => {
      currentCourseId = elCourse.value || '';
      currentModuleId = '';
      await populateModuleFilterForCourse(currentCourseId);
      applyFilters();
    });
    elModule.addEventListener('change', () => { currentModuleId = elModule.value || ''; applyFilters(); });
    elSort.addEventListener('change', applyFilters);
    elSearch.addEventListener('input', applyFilters);

    // Copy hardening for delete modal
    function hardenDeleteModal(modalEl){
      if (!modalEl) return;
      const bodyEl = modalEl.querySelector('.modal-body');
      modalEl.classList.add('confirm-hardened');

      const blockers = [
        document.getElementById('deleteInstruction'),
        document.getElementById('deleteExactPill'),
        document.getElementById('deleteHelp'),
        document.getElementById('deleteExactText'),
        document.getElementById('deleteExactHint'),
      ].filter(Boolean);

      const kill = (e) => { e.preventDefault(); e.stopPropagation(); };

      const blockClipboard = (e) => {
        if (bodyEl && (bodyEl.contains(e.target))) kill(e);
      };

      modalEl.addEventListener('copy', blockClipboard);
      modalEl.addEventListener('cut', blockClipboard);
      modalEl.addEventListener('contextmenu', blockClipboard);

      const events = ['dragstart','selectstart','mousedown','pointerdown','mouseup','pointerup','contextmenu','copy','cut'];
      blockers.forEach(node => events.forEach(evt => node.addEventListener(evt, kill)));

      const selGuard = () => {
        const sel = window.getSelection && window.getSelection();
        if (!sel || !sel.rangeCount) return;
        const anchor = sel.anchorNode;
        if (anchor && blockers.some(n => n.contains(anchor))) {
          sel.removeAllRanges();
        }
      };
      document.addEventListener('selectionchange', selGuard);

      const onHidden = () => {
        modalEl.classList.remove('confirm-hardened');
        modalEl.removeEventListener('copy', blockClipboard);
        modalEl.removeEventListener('cut', blockClipboard);
        modalEl.removeEventListener('contextmenu', blockClipboard);
        blockers.forEach(node => events.forEach(evt => node.removeEventListener(evt, kill)));
        document.removeEventListener('selectionchange', selGuard);
        modalEl.removeEventListener('hidden.bs.modal', onHidden);
      };
      modalEl.addEventListener('hidden.bs.modal', onHidden, { once:true });
    }

    // Boot
    (async function init() {
      try {
        await loadCourses();
        await preloadAllQuizzes();
        applyFilters();
      } catch (e) {
        console.error(e);
      }
    })();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
