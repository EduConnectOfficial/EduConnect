<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduConnect Teacher - Announcements Board</title>

  <!-- OPTIONAL: If backend is a different Railway service, set this -->
  <!-- <meta name="api-base" content="https://YOUR-BACKEND.up.railway.app"> -->

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Global -->
  <link rel="stylesheet" href="../announcements/announcements.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top d-flex align-items-center justify-content-between px-4 py-2">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box position-relative">
          <input id="searchBox" type="text" class="form-control" placeholder="Search..." />
          <i class="fas fa-search position-absolute" style="top:50%; right:12px; transform:translateY(-50%);"></i>
        </div>
        <button class="profile-btn btn btn-link text-decoration-none">
          <i class="fas fa-user-circle fa-2x"></i>
          <span id="Username" class="username ms-2 fw-semibold"></span>
        </button>
      </header>

      <!-- Content -->
      <section class="content">
        <div class="row align-items-center mb-3">
          <div class="col-md-6">
            <h1 class="page-title brand mb-0">Announcements Board</h1>
          </div>
          <div class="col-md-6 text-md-end mt-2 mt-md-0">
            <button class="btn btn-amber" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
              <i class="bi bi-bell-plus"></i> New Announcement
            </button>
          </div>
        </div>

        <!-- THEMED TOOLBAR (filters + SORT) -->
        <div class="ui-card card-themed mb-4">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-megaphone"></i> Your Announcements</h2>
            <div class="ui-subtext">Everything shows up right away. Use filters or change the order with Sort.</div>
          </div>

          <form id="announcementFilterForm" class="filter-bar">
            <div class="row g-3 align-items-end">
              <div class="col-sm-4">
                <label for="filterClasses" class="form-label">Class</label>
                <select id="filterClasses" multiple class="form-select"></select>
              </div>

              <div class="col-sm-3">
                <label for="filterStatus" class="form-label">Status</label>
                <select id="filterStatus" class="form-select">
                  <option value="">All</option>
                  <option value="published">Published</option>
                  <option value="scheduled">Scheduled</option>
                  <option value="expired">Expired</option>
                  <option value="important">Important</option>
                </select>
              </div>

              <div class="col-sm-3">
                <label for="sortBy" class="form-label">Sort</label>
                <select id="sortBy" class="form-select">
                  <option value="publish_desc" selected>Newest publish date</option>
                  <option value="publish_asc">Oldest publish date</option>
                  <option value="title_az">Title A → Z</option>
                  <option value="status">Status (Published → Scheduled → Expired)</option>
                </select>
              </div>

              <div class="col-sm-2 d-grid">
                <button type="submit" class="btn btn-amber"><i class="bi bi-sliders2-vertical me-1"></i>Apply</button>
              </div>
            </div>
          </form>
        </div>
        <!-- /THEMED TOOLBAR -->

        <!-- Table -->
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-striped align-middle mb-0" id="announcementTable">
              <thead class="table-light">
                <tr>
                  <th>Title</th>
                  <th>Classes</th>
                  <th>Publish At</th>
                  <th>Expires At</th>
                  <th>Status</th>
                  <th>Important</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="modal fade" id="createAnnouncementModal" tabindex="-1" aria-labelledby="createAnnouncementLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="createAnnouncementForm">
          <div class="modal-header">
            <h5 class="modal-title" id="createAnnouncementLabel">New Announcement</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="announcementTitle" class="form-label">Title</label>
                <input type="text" id="announcementTitle" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="announcementClasses" class="form-label">Classes</label>
                <select id="announcementClasses" multiple class="form-select" required></select>
              </div>
              <div class="col-md-6">
                <label for="publishAt" class="form-label">Publish At</label>
                <input type="datetime-local" id="publishAt" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="expiresAt" class="form-label">Expires At</label>
                <input type="datetime-local" id="expiresAt" class="form-control" />
              </div>
              <div class="col-12">
                <label for="announcementContent" class="form-label">Content</label>
                <textarea id="announcementContent" class="form-control" rows="4" required></textarea>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="announcementImportant" />
                  <label class="form-check-label" for="announcementImportant">Mark as <strong>Important</strong></label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-amber">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-labelledby="editAnnouncementLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="editAnnouncementForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editAnnouncementLabel">Edit Announcement</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editAnnouncementId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label for="editTitle" class="form-label">Title</label>
                <input type="text" id="editTitle" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="editClasses" class="form-label">Classes</label>
                <select id="editClasses" multiple class="form-select" required></select>
              </div>
              <div class="col-md-6">
                <label for="editPublishAt" class="form-label">Publish At</label>
                <input type="datetime-local" id="editPublishAt" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="editExpiresAt" class="form-label">Expires At</label>
                <input type="datetime-local" id="editExpiresAt" class="form-control" />
              </div>
              <div class="col-12">
                <label for="editContent" class="form-label">Content</label>
                <textarea id="editContent" class="form-control" rows="4" required></textarea>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editImportant" />
                  <label class="form-check-label" for="editImportant">Important</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-amber">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Reusable Confirm Modal (for Archive/Unarchive) -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cancel"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" id="confirmCancelBtn" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-amber" id="confirmOkBtn">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- App Alert Modal -->
  <div class="modal fade" id="appAlertModal" tabindex="-1" aria-labelledby="appAlertTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div id="appAlertHeader" class="modal-header">
          <h5 class="modal-title" id="appAlertTitle">Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="appAlertBody" class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-amber" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert helper (closes any open modal before showing alert) -->
  <script>
    function showAppAlert(message, { title = "Notice", variant = "primary", closeOtherModals = true } = {}) {
      const header = document.getElementById("appAlertHeader");
      const titleEl = document.getElementById("appAlertTitle");
      const bodyEl = document.getElementById("appAlertBody");
      const alertEl = document.getElementById("appAlertModal");

      // Variant styling
      header.className = "modal-header";
      const bg = {
        primary: "bg-primary text-white", success: "bg-success text-white",
        danger: "bg-danger text-white", warning: "bg-warning",
        info: "bg-info", secondary: "bg-secondary text-white",
        dark: "bg-dark text-white", light: "bg-light"
      }[variant] || "bg-primary text-white";
      header.classList.add(...bg.split(" "));

      titleEl.textContent = title;
      bodyEl.textContent = message;

      // Close any other open modals before showing the alert
      if (closeOtherModals) {
        document.querySelectorAll(".modal.show").forEach(m => {
          if (m.id !== "appAlertModal") {
            const inst = bootstrap.Modal.getInstance(m);
            if (inst) inst.hide();
          }
        });
      }

      bootstrap.Modal.getOrCreateInstance(alertEl).show();
    }
  </script>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/components/sidebar.html").then(r => r.text()).then(html => {
        document.getElementById("sidebar-container").innerHTML = html;
        const sb = document.querySelector(".sidebar"), db = document.querySelector(".dashboard");
        if (sb && db) {
          sb.addEventListener("mouseenter", () => db.classList.add("sidebar-expanded"));
          sb.addEventListener("mouseleave", () => db.classList.remove("sidebar-expanded"));
        }
        document.querySelectorAll('.has-submenu .submenu-toggle').forEach(t => {
          t.addEventListener('click', e => {
            e.preventDefault();
            const p = t.closest('.has-submenu');
            p.classList.toggle('open');
            t.setAttribute('aria-expanded', p.classList.contains('open'));
          });
        });
      });
    });
  </script>

  <!-- Bootstrap JS (bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ---- Auth guard + header initials (robust) ---- -->
  <script>
    (function initHeaderInitials() {
      try {
        const raw = localStorage.getItem("user");
        const stored = raw ? JSON.parse(raw) : {};
        // support both shapes: {user:{...}} or {...}
        const u = stored.user || stored;

        // teacher gate
        if (!u?.userId || !u?.isTeacher) {
          window.location.href = "/TEACHER/login/login.html";
          return;
        }
        window.currentUser = u;

        const initials = getInitials(u);

        window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("Username");
          if (!el) return;
          el.textContent = initials;                           // initials only
          // Helpful tooltip/aria label with full name/username
          const fullLabel = [u.firstName, u.middleName, u.lastName].filter(Boolean).join(' ').trim()
            || u.username
            || u.email
            || 'Profile';
          el.setAttribute('title', fullLabel);
          el.setAttribute('aria-label', fullLabel);
        });
      } catch (e) {
        console.error('initHeaderInitials failed:', e);
        window.location.href = "/TEACHER/login/login.html";
      }

      // --- Helpers ---
      function getInitials(u) {
        const fn = (u.firstName || '').trim();
        const ln = (u.lastName || '').trim();
        if (fn && ln) return (fn[0] + ln[0]).toUpperCase();

        // fall back to username-like fields
        const nameish = (u.username || u.displayName || u.name || '').trim();
        if (nameish) {
          // split on space, dot, underscore, or hyphen
          const parts = nameish
            .replace(/[^A-Za-z0-9 _.\-]+/g, ' ')
            .split(/[\s._-]+/)
            .filter(Boolean);

          if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
          return parts[0][0].toUpperCase();
        }

        // last resort: first letter of email
        const em = (u.email || '').trim();
        return em ? em[0].toUpperCase() : 'U';
      }
    })();
  </script>

  <!-- Main JS (sorting + archive/unarchive) -->
  <script>
    /* ================= API base: Railway-friendly ================= */
    function resolveApiBase() {
      // 1) Explicit meta override
      const meta = document.querySelector('meta[name="api-base"]');
      if (meta && meta.content) return meta.content.replace(/\/+$/, '');

      // 2) Global override (optional)
      if (window.__API_BASE__) return String(window.__API_BASE__).replace(/\/+$/, '');

      // 3) Local dev
      const host = location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:5000';

      // 4) Hosted (Railway or any domain) => same-origin
      // Using empty string means fetch('/api/...') goes to same origin
      return '';
    }
    const API_BASE = resolveApiBase();

    // Auth
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    const TEACHER_ID = (userData.user && userData.user.userId) ? userData.user.userId : (userData.userId || "");
    if (!TEACHER_ID || !(userData.user?.isTeacher || userData.isTeacher)) {
      showAppAlert("Unauthorized. Please log in as a teacher.");
      window.location.href = "/TEACHER/login/login.html";
    }
    // (Header initials script already sets the Username text)

    // ===== Confirm modal helper =====
    const _confirmEl = document.getElementById('confirmModal');
    const _confirm = new bootstrap.Modal(_confirmEl);
    const _confirmT = document.getElementById('confirmModalLabel');
    const _confirmB = document.getElementById('confirmModalBody');
    const _confirmOK = document.getElementById('confirmOkBtn');
    const _confirmCancel = document.getElementById('confirmCancelBtn');

    function showConfirm(title = 'Confirm', html = 'Are you sure?') {
      _confirmT.textContent = title;
      _confirmB.innerHTML = html;
      return new Promise(resolve => {
        const onOk = () => { cleanup(); _confirm.hide(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };

        function cleanup() {
          _confirmOK.removeEventListener('click', onOk);
          _confirmCancel.removeEventListener('click', onCancel);
          _confirmEl.removeEventListener('hidden.bs.modal', onCancel);
        }

        _confirmOK.addEventListener('click', onOk, { once: true });
        _confirmCancel.addEventListener('click', onCancel, { once: true });
        _confirmEl.addEventListener('hidden.bs.modal', onCancel, { once: true });

        _confirm.show();
      });
    }

    // ---------- State ----------
    let CLASS_LIST = [];
    let CLASS_MAP = {};
    let ANNOUNCEMENTS = [];
    let FILTER = { status: "", classIds: [] };
    let SORT_BY = 'publish_desc';

    // ---------- Utils ----------
    const fmtDT = (ts) => {
      if (!ts) return "";
      if (typeof ts === "number") return new Date(ts).toLocaleString();
      if (ts?._seconds) return new Date(ts._seconds * 1000).toLocaleString();
      if (ts?.seconds) return new Date(ts.seconds * 1000).toLocaleString();
      return new Date(ts).toLocaleString();
    };
    const toLocalInputValue = (millis) => {
      if (!millis) return "";
      const d = new Date(millis);
      const pad = n => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const fromInputToMillis = (val) => val ? new Date(val).getTime() : null;

    // --- Class label helpers (handles archived classes too) ---
    function fmtClassLabel(c) {
      const name = [c.name, (c.gradeLevel ? `Grade ${c.gradeLevel}` : null), (c.section ? `Section ${c.section}` : null)]
        .filter(Boolean).join(' - ');
      return name + (c.archived ? ' (Archived)' : '');
    }

    async function fetchClassLabelById(id) {
      try {
        const res = await fetch(`${API_BASE}/api/classes/${encodeURIComponent(id)}`);
        const js = await res.json();
        if (js?.success && js.class) {
          const label = fmtClassLabel(js.class);
          CLASS_MAP[id] = label;
          return label;
        }
      } catch (e) {
        console.warn('fetchClassLabelById failed for', id, e);
      }
      // Last resort cache: prevent repeated fetch attempts
      CLASS_MAP[id] = id;
      return id;
    }

    async function ensureClassLabels(ids) {
      const unique = Array.from(new Set(ids || []));
      const missing = unique.filter(id => !CLASS_MAP[id]);
      if (!missing.length) return;
      await Promise.all(missing.map(fetchClassLabelById));
    }

    // ---------- Data loaders ----------
    async function loadClasses() {
      // Try to include archived classes in one go (if the API supports it)
      let url = `${API_BASE}/api/classes?teacherId=${encodeURIComponent(TEACHER_ID)}&includeArchived=1`;
      let js;

      try {
        let res = await fetch(url);
        js = await res.json();
        if (!js?.success || !Array.isArray(js.classes)) {
          // Fallback to original endpoint (active only)
          url = `${API_BASE}/api/classes?teacherId=${encodeURIComponent(TEACHER_ID)}`;
          res = await fetch(url);
          js = await res.json();
        }
      } catch (e) {
        // Fallback to original endpoint if the first call failed
        const res = await fetch(`${API_BASE}/api/classes?teacherId=${encodeURIComponent(TEACHER_ID)}`);
        js = await res.json();
      }

      if (!js?.success) throw new Error("Failed to load classes");

      CLASS_LIST = js.classes.map(c => ({
        id: c.id,
        label: fmtClassLabel(c),
      }));
      CLASS_MAP = Object.fromEntries(CLASS_LIST.map(c => [c.id, c.label]));

      const filterSel = document.getElementById("filterClasses");
      const createSel = document.getElementById("announcementClasses");
      const editSel = document.getElementById("editClasses");
      [filterSel, createSel, editSel].forEach(sel => {
        sel.innerHTML = "";
        CLASS_LIST.forEach(c => {
          const o = document.createElement("option");
          o.value = c.id; o.textContent = c.label;
          sel.appendChild(o);
        });
      });
    }

    async function loadAnnouncements() {
      const params = new URLSearchParams();
      params.set("teacherId", TEACHER_ID);
      if (FILTER.status) params.set("status", FILTER.status);
      if (FILTER.classIds.length) params.set("classIds", FILTER.classIds.join(","));

      const res = await fetch(`${API_BASE}/api/announcements?${params.toString()}`);
      const js = await res.json();
      if (!js.success) throw new Error("Failed to load announcements");
      ANNOUNCEMENTS = js.announcements || [];

      // Collect all class IDs referenced by announcements (support both classIds and classes)
      const allIds = ANNOUNCEMENTS.flatMap(a => (a.classIds || a.classes || []));
      await ensureClassLabels(allIds);

      renderTable();
    }

    // ---------- Search + Sort ----------
    document.getElementById("searchBox").addEventListener("input", () => renderTable());
    document.getElementById("sortBy").addEventListener("change", (e) => { SORT_BY = e.target.value; renderTable(); });

    function sortAnnouncements(list) {
      const getMs = v => v?.toMillis ? v.toMillis() : (typeof v === 'number' ? v : (v ? new Date(v).getTime() : 0));
      if (SORT_BY === 'publish_asc') return list.sort((a, b) => getMs(a.publishAt) - getMs(b.publishAt));
      if (SORT_BY === 'title_az') return list.sort((a, b) => String(a.title || '').localeCompare(String(b.title || '')));
      if (SORT_BY === 'status') {
        const rank = s => ({ published: 0, scheduled: 1, expired: 2 }[String(s || '').toLowerCase()] ?? 9);
        return list.sort((a, b) => rank(a.status) - rank(b.status));
      }
      // default newest publish date
      return list.sort((a, b) => getMs(b.publishAt) - getMs(a.publishAt));
    }

    function badgeClass(status) {
      switch (status) {
        case 'published': return 'bg-success';
        case 'scheduled': return 'bg-secondary';
        case 'expired': return 'bg-dark';
        default: return 'bg-light text-dark';
      }
    }

    // ---------- Renderer ----------
    function renderTable() {
      const q = (document.getElementById("searchBox").value || "").toLowerCase();
      const tbody = document.querySelector("#announcementTable tbody");
      tbody.innerHTML = "";

      let list = ANNOUNCEMENTS.slice();

      // client-side search
      if (q) {
        list = list.filter(a =>
          (a.title || "").toLowerCase().includes(q) ||
          (a.content || "").toLowerCase().includes(q)
        );
      }

      // client-side sort
      sortAnnouncements(list);

      if (!list.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="7" class="text-center text-muted py-4">No announcements found.</td>`;
        tbody.appendChild(tr);
        return;
      }

      list.forEach(a => {
        const classIds = a.classIds || a.classes || [];
        const classesText = classIds.map(id => CLASS_MAP[id] || id).join(", ");
        const isExpired = String(a.status || '').toLowerCase() === 'expired';
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="fw-semibold">${a.title}</td>
          <td>${classesText || '—'}</td>
          <td>${fmtDT(a.publishAt?.toMillis ? a.publishAt.toMillis() : a.publishAt)}</td>
          <td>${fmtDT(a.expiresAt?.toMillis ? a.expiresAt.toMillis() : a.expiresAt)}</td>
          <td><span class="badge ${badgeClass(a.status)}">${a.status || ''}</span></td>
          <td>${a.important ? '<i class="bi bi-exclamation-circle-fill text-danger"></i>' : ''}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary me-2" data-action="edit" data-id="${a.id}">Edit</button>
            ${isExpired
            ? `<button class="btn btn-sm btn-outline-success" data-action="unarchive" data-id="${a.id}">Unarchive</button>`
            : `<button class="btn btn-sm btn-outline-danger" data-action="archive" data-id="${a.id}">Archive</button>`}
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-action]').forEach(btn => {
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        btn.onclick = async () => {
          if (action === 'edit') return openEdit(id);
          if (action === 'archive') return archiveAnnouncement(id);
          if (action === 'unarchive') return unarchiveAnnouncement(id);
        };
      });
    }

    // ---------- Create ----------
    document.getElementById("createAnnouncementForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("announcementTitle").value.trim();
      const content = document.getElementById("announcementContent").value.trim();
      const classes = Array.from(document.getElementById("announcementClasses").selectedOptions).map(o => o.value);
      const publishAt = fromInputToMillis(document.getElementById("publishAt").value);
      const expiresAt = fromInputToMillis(document.getElementById("expiresAt").value);
      const important = document.getElementById("announcementImportant").checked;

      if (!title || !content || !TEACHER_ID || !classes.length) {
        showAppAlert("Missing fields: title, content, teacherId, classes[] are required.");
        return;
      }

      const payload = { title, content, classes, publishAt, expiresAt, important, teacherId: TEACHER_ID };

      const res = await fetch(`${API_BASE}/api/announcements`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const js = await res.json();
      if (!js.success) {
        showAppAlert(js.message || "Failed to create announcement");
        return;
      }
      bootstrap.Modal.getInstance(document.getElementById("createAnnouncementModal")).hide();
      e.target.reset();
      await loadAnnouncements();
    });

    // ---------- Edit ----------
    function openEdit(id) {
      const a = ANNOUNCEMENTS.find(x => x.id === id);
      if (!a) return;

      document.getElementById("editAnnouncementId").value = a.id;
      document.getElementById("editTitle").value = a.title || "";
      document.getElementById("editContent").value = a.content || "";
      document.getElementById("editImportant").checked = !!a.important;

      const selectedIds = a.classIds || a.classes || [];
      const editSel = document.getElementById("editClasses");
      Array.from(editSel.options).forEach(opt => {
        opt.selected = selectedIds.includes(opt.value);
      });

      const pubMs = a.publishAt?.toMillis ? a.publishAt.toMillis() : (typeof a.publishAt === 'number' ? a.publishAt : null);
      const expMs = a.expiresAt?.toMillis ? a.expiresAt.toMillis() : (typeof a.expiresAt === 'number' ? a.expiresAt : null);
      document.getElementById("editPublishAt").value = toLocalInputValue(pubMs || Date.now());
      document.getElementById("editExpiresAt").value = toLocalInputValue(expMs);

      new bootstrap.Modal(document.getElementById("editAnnouncementModal")).show();
    }

    document.getElementById("editAnnouncementForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editAnnouncementId").value;
      const title = document.getElementById("editTitle").value.trim();
      const content = document.getElementById("editContent").value.trim();
      const classes = Array.from(document.getElementById("editClasses").selectedOptions).map(o => o.value);
      const publishAt = fromInputToMillis(document.getElementById("editPublishAt").value);
      const expiresAt = fromInputToMillis(document.getElementById("editExpiresAt").value);
      const important = document.getElementById("editImportant").checked;

      if (!title || !content || !classes.length) {
        showAppAlert("Please complete the required fields.");
        return;
      }

      const payload = { title, content, classes, publishAt, expiresAt, important };
      const res = await fetch(`${API_BASE}/api/announcements/${encodeURIComponent(id)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const js = await res.json();
      if (!js.success) {
        showAppAlert(js.message || "Failed to update announcement");
        return;
      }
      bootstrap.Modal.getInstance(document.getElementById("editAnnouncementModal")).hide();
      await loadAnnouncements();
    });

    // ---------- Archive / Unarchive ----------
    async function archiveAnnouncement(id) {
      const ok = await showConfirm(
        'Archive Announcement',
        'Archive this announcement? It will be marked as <strong>expired</strong> and hidden from students.'
      );
      if (!ok) return;

      const res = await fetch(`${API_BASE}/api/announcements/${encodeURIComponent(id)}/archive`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      const js = await res.json();
      if (!js.success) { showAppAlert(js.message || "Failed to archive announcement"); return; }
      await loadAnnouncements();
    }

    async function unarchiveAnnouncement(id) {
      const ok = await showConfirm(
        'Unarchive Announcement',
        'Unarchive this announcement? It will become visible again based on its publish date.'
      );
      if (!ok) return;

      const res = await fetch(`${API_BASE}/api/announcements/${encodeURIComponent(id)}/unarchive`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      const js = await res.json();
      if (!js.success) { showAppAlert(js.message || "Failed to unarchive announcement"); return; }
      await loadAnnouncements();
    }

    // ---------- Filters ----------
    document.getElementById("announcementFilterForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const classIds = Array.from(document.getElementById("filterClasses").selectedOptions).map(o => o.value);
      const status = document.getElementById("filterStatus").value.trim();
      FILTER = { status, classIds };
      await loadAnnouncements();
    });

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/TEACHER/login/login.html";
    }

    // ---------- Init ----------
    (async function init() {
      try {
        await loadClasses();
        await loadAnnouncements();
      } catch (e) {
        console.error(e);
        showAppAlert("Failed to initialize announcements page.");
      }
    })();
  </script>

  <!-- Mobile-friendly datetime enhancer -->
  <script>
    (function enhanceDateTimeForMobile() {
      const isTouch = matchMedia('(hover: none) and (pointer: coarse)').matches;
      if (!isTouch) return;

      function makeSplitById(id) {
        const original = document.getElementById(id);
        if (!original) return null;
        original.classList.add('dt-hidden');

        const wrap = document.createElement('div');
        wrap.className = 'dt-split';
        original.insertAdjacentElement('afterend', wrap);

        const date = document.createElement('input');
        date.type = 'date';
        date.className = 'form-control';
        date.id = id + '__date';

        const time = document.createElement('input');
        time.type = 'time';
        time.className = 'form-control';
        time.id = id + '__time';
        time.step = 60;

        wrap.append(date, time);

        function seedFromOriginal() {
          if (!original.value) { date.value = ''; time.value = ''; return; }
          const d = new Date(original.value);
          if (isNaN(d)) { date.value = ''; time.value = ''; return; }
          date.value = d.toISOString().slice(0, 10);
          time.value = String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        }
        seedFromOriginal();

        return { original, date, time, wrap, seedFromOriginal };
      }

      const C_PUB = makeSplitById('publishAt');
      const C_EXP = makeSplitById('expiresAt');
      const E_PUB = makeSplitById('editPublishAt');
      const E_EXP = makeSplitById('editExpiresAt');

      if (!C_PUB && !C_EXP && !E_PUB && !E_EXP) return;

      function toLocalDatetimeValue(dateVal, timeVal) {
        if (!dateVal || !timeVal) return '';
        const [hh, mm] = String(timeVal).split(':').map(Number);
        const d = new Date(dateVal);
        if (isNaN(d)) return '';
        d.setHours(hh || 0, mm || 0, 0, 0);
        const y = d.getFullYear();
        const mo = String(d.getMonth() + 1).padStart(2, '0');
        const da = String(d.getDate()).padStart(2, '0');
        const h = String(d.getHours()).padStart(2, '0');
        const mi = String(d.getMinutes()).padStart(2, '0');
        return `${y}-${mo}-${da}T${h}:${mi}`;
      }

      function syncPair(pub, exp) {
        if (pub) pub.original.value = toLocalDatetimeValue(pub.date.value, pub.time.value);
        if (exp) exp.original.value = toLocalDatetimeValue(exp.date.value, exp.time.value);
        if (pub && exp) exp.date.min = pub.date.value || '';
      }

      function wire(pub, exp) {
        ['input', 'change'].forEach(ev => {
          if (pub) {
            pub.date.addEventListener(ev, () => syncPair(pub, exp));
            pub.time.addEventListener(ev, () => syncPair(pub, exp));
          }
          if (exp) {
            exp.date.addEventListener(ev, () => syncPair(pub, exp));
            exp.time.addEventListener(ev, () => syncPair(pub, exp));
          }
        });
        syncPair(pub, exp);
      }

      wire(C_PUB, C_EXP);
      wire(E_PUB, E_EXP);

      const createForm = document.getElementById('createAnnouncementForm');
      const editForm = document.getElementById('editAnnouncementForm');
      if (createForm) createForm.addEventListener('submit', () => syncPair(C_PUB, C_EXP), true);
      if (editForm) editForm.addEventListener('submit', () => syncPair(E_PUB, E_EXP), true);

      const editModal = document.getElementById('editAnnouncementModal');
      if (editModal) {
        editModal.addEventListener('shown.bs.modal', () => {
          if (E_PUB) { E_PUB.seedFromOriginal(); }
          if (E_EXP) { E_EXP.seedFromOriginal(); }
          syncPair(E_PUB, E_EXP);
        });
      }
    })();
  </script>
</body>

</html>
