<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduConnect Admin - Sign Up</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="signup1.css" />
</head>
<body>
  <div class="main-container">
    <div class="top-logo text-center my-4">
      <img src="/assets/educonnect_logo.png" alt="Digipic Logo" class="logo" />
    </div>
    <div class="left-panel">
      <h2>Create your<br><strong>Account</strong></h2>
      <p>Share your photo work<br>and get projects!</p>
    </div>

    <div class="right-panel">
      <div class="form-box login-box">
        <img src="/assets/signup_text.png" alt="Sign Up" class="img-fluid mb-4" style="max-width:200px"/>

        <form id="signupForm" novalidate>
          <!-- Username -->
          <div class="mb-3 text-start">
            <label for="username" class="form-label">Username</label>
            <input type="text" id="username" class="form-control" placeholder="Choose a username" required />
            <div id="usernameStatus" class="small mt-1"></div>
          </div>

          <!-- First Name -->
          <div class="mb-3 text-start">
            <label for="firstName" class="form-label">First Name</label>
            <input type="text" id="firstName" class="form-control" placeholder="Enter your first name" required />
          </div>

          <!-- Middle Name -->
          <div class="mb-3 text-start">
            <label for="middleName" class="form-label">Middle Name</label>
            <input type="text" id="middleName" class="form-control"
              placeholder="Enter your middle name (optional)" />
          </div>

          <!-- Last Name -->
          <div class="mb-3 text-start">
            <label for="lastName" class="form-label">Last Name</label>
            <input type="text" id="lastName" class="form-control" placeholder="Enter your last name" required />
          </div>

          <!-- Email -->
          <div class="mb-3 text-start">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" class="form-control" placeholder="Enter your email address" required />
            <div id="emailStatus" class="small mt-1"></div>
          </div>

          <!-- Password -->
          <div class="mb-3 text-start">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" class="form-control" placeholder="Create a password" required/>
          </div>

          <!-- Confirm Password -->
          <div class="mb-3 text-start">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input type="password" id="confirmPassword" class="form-control" placeholder="Re-enter your password" required/>
            <ul class="list-unstyled mt-2" id="passwordCriteria">
              <li id="lengthCheck"><i class="bi bi-x-circle text-danger me-2"></i>Minimum 8 characters</li>
              <li id="uppercaseCheck"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 uppercase letter</li>
              <li id="numberCheck"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 number</li>
              <li id="specialCharCheck"><i class="bi bi-x-circle text-danger me-2"></i>At least 1 special character</li>
              <li id="matchCheck"><i class="bi bi-x-circle text-danger me-2"></i>Passwords match</li>
            </ul>
          </div>

          <!-- Show/Hide Password -->
          <div class="form-check text-start mb-3">
            <input class="form-check-input" type="checkbox" id="togglePassword"/>
            <label class="form-check-label" for="togglePassword">Show Password</label>
          </div>

          <!-- Error Messages -->
          <div id="passwordError" class="text-danger mb-2"></div>
          <div id="signupError" class="text-danger mb-3"></div>

          <!-- Submit -->
          <button type="submit" id="submitBtn" class="btn login-btn w-100 mb-3" disabled>Submit</button>
        </form>

        <p class="options text-white">
          Already have an account? <a href="../login/login.html">Login</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    // Element refs
    const username       = document.getElementById('username');
    const usernameStatus = document.getElementById('usernameStatus');
    const email          = document.getElementById('email');
    const emailStatus    = document.getElementById('emailStatus');
    const password       = document.getElementById('password');
    const confirmPass    = document.getElementById('confirmPassword');
    const submitBtn      = document.getElementById('submitBtn');
    const signupForm     = document.getElementById('signupForm');
    const pwError        = document.getElementById('passwordError');
    const signupError    = document.getElementById('signupError');

    const checks = {
      length:        document.getElementById('lengthCheck'),
      uppercase:     document.getElementById('uppercaseCheck'),
      number:        document.getElementById('numberCheck'),
      specialChar:   document.getElementById('specialCharCheck'),
      match:         document.getElementById('matchCheck'),
    };

    // Show/hide password
    document.getElementById('togglePassword').addEventListener('change', () => {
      const t = document.getElementById('togglePassword').checked ? 'text' : 'password';
      password.type = t;
      confirmPass.type = t;
    });

    // Utility: set status text & color
    function setStatus(el, msg, ok) {
      el.textContent = msg;
      el.classList.toggle('text-success', ok);
      el.classList.toggle('text-danger', !ok);
    }

    // Check username/email availability
    async function checkTaken(field, url, statusEl) {
      const val = field.value.trim();
      if (!val) {
        statusEl.textContent = '';
        return false;
      }
      try {
        const res = await fetch(`${url}?${field.id}=${encodeURIComponent(val)}`);
        const js  = await res.json();
        if (js.taken) {
          setStatus(statusEl, `❌ ${field.id.charAt(0).toUpperCase()+field.id.slice(1)} already taken`, false);
          return true;
        } else {
          setStatus(statusEl, `✅ ${field.id.charAt(0).toUpperCase()+field.id.slice(1)} is available`, true);
          return false;
        }
      } catch {
        statusEl.textContent = '';
        return false;
      }
    }

    // Validate entire form to enable/disable submit
    async function validateForm() {
      const uTaken = await checkTaken(username, 'http://localhost:5000/check-username', usernameStatus);
      const eTaken = await checkTaken(email,    'http://localhost:5000/check-email',    emailStatus);
      submitBtn.disabled = uTaken || eTaken;
    }
    username.addEventListener('blur',  validateForm);
    email.addEventListener('blur',     validateForm);

    // Live password criteria
    function updateCheck(el, cond) {
      const icon = el.querySelector('i');
      icon.classList.toggle('bi-check-circle', cond);
      icon.classList.toggle('text-success',    cond);
      icon.classList.toggle('bi-x-circle',     !cond);
      icon.classList.toggle('text-danger',     !cond);
    }
    function livePassword() {
      const p = password.value;
      updateCheck(checks.length,      p.length >= 8);
      updateCheck(checks.uppercase,   /[A-Z]/.test(p));
      updateCheck(checks.number,      /\d/.test(p));
      updateCheck(checks.specialChar, /[^A-Za-z0-9]/.test(p));
      updateCheck(checks.match,       p === confirmPass.value && p !== '');
    }
    password.addEventListener('input', livePassword);
    confirmPass.addEventListener('input', livePassword);

    // Submission
    signupForm.addEventListener('submit', async e => {
      e.preventDefault();

      // block if username/email taken
      if (usernameStatus.textContent.includes('❌') || emailStatus.textContent.includes('❌')) {
        signupError.textContent = 'Fix the above errors before submitting.';
        return;
      }

      // password rules
      const p = password.value, cp = confirmPass.value;
      if (p.length < 8) {
        pwError.textContent = 'Password must be ≥ 8 characters.';
        return;
      } else if (!/[A-Z]/.test(p)) {
        pwError.textContent = 'Include at least one uppercase letter.';
        return;
      } else if (!/[^A-Za-z0-9]/.test(p)) {
        pwError.textContent = 'Include at least one special character.';
        return;
      } else if (!/\d/.test(p)) {
        pwError.textContent = 'Include at least one number.';
        return;
      } else if (p !== cp) {
        pwError.textContent = 'Passwords do not match.';
        return;
      }
      pwError.textContent = '';

      // payload
      const data = {
        firstName:  document.getElementById('firstName').value.trim(),
        middleName: document.getElementById('middleName').value.trim(),
        lastName:   document.getElementById('lastName').value.trim(),
        username:   username.value.trim(),
        email:      email.value.trim(),
        password:   p,
        active:     true,
        isITsupport: true,
        isUser:     false,
        isAdmin:    false
      };

      try {
        const res = await fetch('http://localhost:5000/signup', {
          method:  'POST',
          headers: {'Content-Type':'application/json'},
          body:    JSON.stringify(data)
        });
        const js  = await res.json();
        if (res.ok) {
          sessionStorage.setItem('pendingEmail', data.email);
          sessionStorage.setItem('pendingUserData', JSON.stringify(data));
          alert('Verification code sent to your email!');
          window.location.href = '/digipic_IT/signup/verification.html';
        } else {
          signupError.textContent = js.error || 'Signup failed.';
        }
      } catch {
        signupError.textContent = 'Could not connect to the server.';
      }
    });
  </script>
</body>
</html>
