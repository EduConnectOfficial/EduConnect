<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Grades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- OPTIONAL: If backend is a different Railway service, set this -->
  <!-- <meta name="api-base" content="https://YOUR-BACKEND.up.railway.app"> -->

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Shared student styles -->
  <link rel="stylesheet" href="../grades/grades.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* tiny QoL additions (consistent with other updated pages) */
    .wrap-anywhere{overflow-wrap:anywhere}
    .table-clean thead th{border-bottom:1px solid #e9ecef}
    .table-clean tbody td{border-top:1px solid #f1f3f5}
    .skeleton{position:relative;border-radius:.5rem;background:#eef2f7;overflow:hidden}
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);animation:shimmer 1.3s infinite;transform:translateX(-100%)}
    @keyframes shimmer{100%{transform:translateX(100%)}}
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
   <div id="mobileSidebarBackdrop" class="sidebar-backdrop" hidden></div>
<div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <div class="brand">
  <button id="hamburgerBtn"
          class="hamburger-btn"
          aria-label="Open menu"
          aria-controls="sidebar-container"
          aria-expanded="false">
    <i class="bi bi-list"></i>
  </button>

  <!-- Your existing logos -->
  <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
  <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
</div>

        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <div class="d-flex align-items-center justify-content-between">
          <h1 class="page-title brand">My Analytics</h1>
          <div class="d-flex gap-2">
            <button id="downloadPdf" class="btn btn-amber-outline">
              <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF
            </button>
            <button id="exportCsv" class="btn btn-amber">
              <i class="bi bi-filetype-csv me-1"></i> Export CSV
            </button>
          </div>
        </div>

        <!-- Header metrics -->
        <div class="ui-card mb-3">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <div class="subtle">Student</div>
              <div id="s_name" class="metric">—</div>
              <div id="s_id" class="subtle small mt-1">—</div>
            </div>
            <div class="col-4 col-md-2">
              <div class="subtle">Avg Quiz</div>
              <div id="s_avg_quiz" class="metric">—</div>
            </div>
            <div class="col-4 col-md-2">
              <div class="subtle">Avg Assignment</div>
              <div id="s_avg_asg" class="metric">—</div>
            </div>
            <div class="col-4 col-md-2">
              <div class="subtle">Modules Completed</div>
              <div id="s_modules" class="metric">—</div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="ui-card mb-3">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-8">
              <label for="courseFilter" class="form-label mb-1">Filter by Course</label>
              <select id="courseFilter" class="form-select">
                <option value="__ALL__">All courses</option>
              </select>
            </div>
            <div class="col-12 col-md-4 d-grid">
              <label class="form-label mb-1">&nbsp;</label>
              <button id="applyFilters" class="btn btn-amber">
                <i class="bi bi-funnel me-1"></i> Apply
              </button>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row g-3">
          <div class="col-md-6">
            <div class="ui-card">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-bar-chart"></i>Quizzes (Best % per Quiz)</h2>
              </div>
              <div class="chart-wrap" style="min-height:280px"><canvas id="quizChart"></canvas></div>
              <div class="table-responsive mt-3">
                <table class="table table-sm table-clean align-middle">
                  <thead>
                    <tr>
                      <th>Quiz</th><th>Best %</th><th>Attempts</th><th>Last Attempt</th>
                    </tr>
                  </thead>
                  <tbody id="quizTbody">
                    <tr><td colspan="4" class="text-center text-muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="ui-card">
              <div class="ui-card-head">
                <h2 class="ui-card-title"><i class="bi bi-clipboard2-check"></i>Assignments</h2>
              </div>
              <div class="chart-wrap" style="min-height:280px"><canvas id="assignChart"></canvas></div>
              <div class="table-responsive mt-3">
                <table class="table table-sm table-clean align-middle">
                  <thead>
                    <tr>
                      <th>Assignment</th><th>Grade %</th><th>Graded At</th>
                    </tr>
                  </thead>
                  <tbody id="assignTbody">
                    <tr><td colspan="3" class="text-center text-muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Essay submissions -->
        <div class="ui-card mt-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-journals"></i>Essay Submissions</h2>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-clean align-middle">
              <thead>
                <tr>
                  <th>Quiz</th><th>Question #</th><th>Status</th><th>Score</th><th>Submitted</th>
                </tr>
              </thead>
              <tbody id="essayTbody">
                <tr><td colspan="5" class="text-center text-muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Completed modules -->
        <div class="ui-card mt-3 mb-4">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-mortarboard"></i>Completed Modules</h2>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-clean align-middle">
              <thead>
                <tr>
                  <th>Course</th><th>Module</th><th>Percent</th><th>Completed At</th>
                </tr>
              </thead>
              <tbody id="modTbody">
                <tr><td colspan="4" class="text-center text-muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /content -->
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>
<script>
(function () {
  const dashboard = document.querySelector(".dashboard");
  const sidebarContainer = document.getElementById("sidebar-container");
  const hamburgerBtn = document.getElementById("hamburgerBtn");
  const backdrop = document.getElementById("mobileSidebarBackdrop");
  const isMobile = () => window.matchMedia("(max-width: 480px)").matches;

  // ----- open/close helpers -----
  function openSidebar() {
    dashboard.classList.add("sidebar-open");
    hamburgerBtn?.setAttribute("aria-expanded", "true");
    if (backdrop) backdrop.hidden = false;
    if (isMobile()) {
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }
  }
  function closeSidebar() {
    dashboard.classList.remove("sidebar-open");
    hamburgerBtn?.setAttribute("aria-expanded", "false");
    if (backdrop) backdrop.hidden = true;
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }
  function toggleSidebar() {
    if (dashboard.classList.contains("sidebar-open")) closeSidebar(); else openSidebar();
  }

  // ----- load sidebar partial once -----
  fetch("/STUDENT/components/sidebar.html")
    .then(r => r.text())
    .then(html => {
      sidebarContainer.innerHTML = html;

      // Submenu toggles (works with your .has-submenu/.open)
      sidebarContainer.querySelectorAll(".has-submenu .submenu-toggle").forEach(tg => {
        tg.addEventListener("click", (e) => {
          e.preventDefault();
          const parent = tg.closest(".has-submenu");
          parent.classList.toggle("open");
          const expanded = tg.getAttribute("aria-expanded") === "true";
          tg.setAttribute("aria-expanded", String(!expanded));
        });
      });

      // Desktop hover-expand (ignored on mobile via CSS)
      const sidebar = sidebarContainer.querySelector(".sidebar");
      if (sidebar && dashboard) {
        sidebar.addEventListener("mouseenter", () => { if (!isMobile()) dashboard.classList.add("sidebar-expanded"); });
        sidebar.addEventListener("mouseleave", () => { if (!isMobile()) dashboard.classList.remove("sidebar-expanded"); });
      }
    })
    .catch(err => console.error("Failed to load sidebar:", err));

  // ----- hamburger / backdrop / esc -----
  hamburgerBtn?.addEventListener("click", (e) => { e.preventDefault(); if (isMobile()) toggleSidebar(); });
  backdrop?.addEventListener("click", closeSidebar);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape" && dashboard.classList.contains("sidebar-open")) closeSidebar(); });

  // Clear mobile-open state when resizing to desktop
  window.addEventListener("resize", () => { if (!isMobile()) closeSidebar(); });
})();
</script>
  <!-- Auth + header initials -->
  <script>
    (function guardAndHeader(){
      const raw = JSON.parse(localStorage.getItem("user") || "{}");
      const USER = raw.user || raw;
      if (!USER || (!USER.email && !USER.userId && !USER.uid)) {
        window.location.href = "../login/login.html";
        return;
      }
      function initialsFrom(str){
        if(!str) return "";
        const s=String(str).trim(); if(!s) return "";
        if(s.includes("@")){
          const local=s.split("@")[0];
          const parts=local.split(/[.\-_]+/).filter(Boolean);
          return (parts.length>=2?parts[0][0]+parts[parts.length-1][0]:local.slice(0,2)).toUpperCase();
        }
        const parts=s.split(/[\s\-]+/).filter(Boolean);
        return (parts.length>=2?parts[0][0]+parts[parts.length-1][0]:parts[0].slice(0,2)).toUpperCase();
      }
      const displayName = USER.fullName || USER.username || USER.email || "Student";
      const elU = document.getElementById("Username");
      if (elU) {
        elU.textContent = initialsFrom(displayName) || "?";
        elU.title = displayName;
        elU.setAttribute("aria-label", displayName);
      }
      if (!USER.uid) {
        USER.uid = USER.userId || USER.id || USER.email;
        localStorage.setItem("user", JSON.stringify(USER));
      }
      window.USER = USER; // expose to page
    })();

    function logoutUser() {
      localStorage.clear(); sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Modal Helper -->
  <script>
    let _feedbackModal;
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('feedbackModal');
      if (el) _feedbackModal = new bootstrap.Modal(el);
      const ok = document.getElementById('successOkBtn');
      if (ok) ok.addEventListener('click', () => _feedbackModal?.hide());
    });
    function showModalAlert(title = 'Notice', message = '') {
      const t = document.getElementById('feedbackModalTitle');
      const b = document.getElementById('feedbackModalBody');
      if (t) t.innerHTML = `<i class="bi bi-info-circle"></i> ${title}`;
      if (b) b.innerHTML = message;
      _feedbackModal?.show();
    }
  </script>

  <!-- Page JS (Railway-friendly API resolver + endpoint fallbacks) -->
  <script>
    /* ===================== API BASE (Railway-friendly) ===================== *
     * Priority:
     * 1) <meta name="api-base" ...>
     * 2) window.API_URL (string) if provided globally
     * 3) localStorage.API_BASE (manual override)
     * 4) If not localhost, same-origin ('' => relative calls)
     * 5) Dev fallback: http://localhost:5000
     * Enforce HTTPS on prod (non-local).
     * ====================================================================== */
    (function decideApiBase(){
      const meta = document.querySelector('meta[name="api-base"]');
      const metaBase = meta?.getAttribute('content')?.trim() || null;
      const manual   = (typeof window.API_URL === 'string' && window.API_URL.trim()) ? window.API_URL.trim() : null;
      const store    = (typeof localStorage !== 'undefined' && localStorage.getItem('API_BASE')) ? localStorage.getItem('API_BASE').trim() : null;

      const isLocal  = (h) => ['localhost','127.0.0.1'].includes(h);
      const sanitize = (u) => (u || '').replace(/\/+$/, '');

      let base = metaBase || manual || store || (isLocal(location.hostname) ? 'http://localhost:5000' : '');

      if (!isLocal(location.hostname) && base.startsWith('http://')) {
        base = base.replace(/^http:\/\//i, 'https://');
      }
      window.API_BASE = sanitize(base);
    })();

    const API = {
      url(path) {
        const p = path.startsWith('/') ? path : '/' + path;
        return (window.API_BASE || '') + p;
      },
      endpoints: {
        studentAnalytics(studentKey) {
          const q = `student=${encodeURIComponent(studentKey)}`;
          return [
            API.url(`/api/student-analytics?${q}`),
            API.url(`/student-analytics?${q}`),
            API.url(`/api/student/analytics?${q}`),
          ];
        },
        studentCourses(userId) {
          const q = `visibility=student&courseArchived=exclude&includeTeacher=true`;
          const u = encodeURIComponent(userId);
          return [
            API.url(`/api/students/${u}/courses?${q}`),
            API.url(`/students/${u}/courses?${q}`),
          ];
        },
        quizzes(forStudent) {
          const q = `forStudent=${encodeURIComponent(forStudent)}`;
          return [
            API.url(`/api/quizzes?${q}`),
            API.url(`/quizzes?${q}`),
          ];
        },
        assignments(userId) {
          const u = encodeURIComponent(userId);
          return [
            API.url(`/api/students/${u}/assignments`),
            API.url(`/students/${u}/assignments`),
          ];
        }
      }
    };

    // ===== Helpers =====
    const el = (id) => document.getElementById(id);
    const pct = (n) => (Number.isFinite(+n) ? Math.round(+n) + '%' : '—');
    const dt = (ts) => {
      if (!ts) return '—';
      const ms = ts?._seconds ? ts._seconds * 1000 : (typeof ts === 'number' ? ts : Date.parse(ts));
      return Number.isFinite(ms) ? new Date(ms).toLocaleString() : '—';
    };

    function hint(url, resp){
      let h = '';
      if (!resp) h = 'Network/CORS error. If backend is separate, set <meta name="api-base" ...>.';
      else if (resp.status === 404) h = '404 Not Found – check route/mount path.';
      else if (resp.status === 403) h = '403 Forbidden – CORS/auth.';
      console.warn('[Grades]', { url, status: resp?.status, hint: h });
      return h;
    }

    async function fetchJSONFallback(urls, options) {
      let lastErr = null;
      for (const url of urls) {
        try {
          const res = await fetch(url, { ...options, credentials: 'same-origin', mode: 'cors' });
          if (res.status === 404) { hint(url, res); continue; }
          let json = {};
          try { json = await res.json(); } catch {}
          return { response: res, json };
        } catch (e) {
          lastErr = e; hint(url, null);
        }
      }
      throw lastErr || new Error('All endpoints failed');
    }

    /* =======================
       Robust percent resolver
       ======================= */
    function clamp01pct(n) {
      const x = Number(n);
      if (!Number.isFinite(x)) return null;
      return Math.max(0, Math.min(100, Math.round(x)));
    }
    function firstNum(...vals){
      for (const v of vals) {
        const n = Number(v);
        if (Number.isFinite(n)) return n;
      }
      return null;
    }
    function gradePctFromRow(a = {}) {
      const pre = firstNum(a.percent, a.gradedPercent, a.autoPercent, a.gradePercent);
      if (pre != null) return clamp01pct(pre);

      const raw = firstNum(a.gradeRaw, a.grade, a.score, a.obtained);
      const max = firstNum(a.maxPoints, a.assignmentMaxPoints, a.max, a.maxScore, a.totalPoints, a.points, a.denominator, a.outOf);
      if (raw != null && max != null && max > 0) return clamp01pct((raw / max) * 100);
      if (raw != null && raw <= 1) return clamp01pct(raw * 100);
      if (raw != null && raw <= 100) return clamp01pct(raw);
      return null;
    }

    // ===== Charts =====
    let quizChart, assignChart;
    function destroy(c) { try { c && c.destroy && c.destroy(); } catch {} }
    function renderBar(canvasId, labels, values, label, key) {
      const ctx = document.getElementById(canvasId);
      if (key === 'quiz') destroy(quizChart);
      if (key === 'assign') destroy(assignChart);

      const inst = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label, data: values }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } },
          plugins: { legend: { display: false } }
        }
      });

      if (key === 'quiz') quizChart = inst;
      if (key === 'assign') assignChart = inst;
    }

    // ===== Identity =====
    function getStudentKey() {
      const u = JSON.parse(localStorage.getItem('user') || '{}');
      return u.userId || u.studentId || u.uid || u.id || u.email || '';
    }

    // ===== API wrappers (Railway fallbacks) =====
    async function getAnalyticsJson(student) {
      const { response, json } = await fetchJSONFallback(
        API.endpoints.studentAnalytics(student),
        { method: 'GET' }
      );
      if (!response.ok) throw new Error('Analytics endpoint failed');
      return json || {};
    }

    async function getCoursesForStudent(userId) {
      try {
        const { response, json } = await fetchJSONFallback(
          API.endpoints.studentCourses(userId),
          { method: 'GET' }
        );
        if (response.ok) return json?.courses || [];
      } catch {}
      return [];
    }

    async function getQuizMetaForStudent(forStudent) {
      try {
        const { response, json } = await fetchJSONFallback(
          API.endpoints.quizzes(forStudent),
          { method: 'GET' }
        );
        if (!response.ok) return {};
        const arr = json?.quizzes || [];
        const map = {};
        arr.forEach(q => {
          if (!q || !q.id) return;
          map[q.id] = {
            courseId: q.courseId || null,
            courseTitle: q.courseTitle || null,
            title: q.title || null
          };
        });
        return map;
      } catch { return {}; }
    }

    async function getStudentAssignmentsMeta(userId) {
      try {
        const { response, json } = await fetchJSONFallback(
          API.endpoints.assignments(userId),
          { method: 'GET' }
        );
        if (!response.ok) return {};
        const list = json?.assignments || [];
        const map = {};
        list.forEach(a => {
          if (!a || !a.id) return;
          map[a.id] = {
            courseId: a.courseId || null,
            courseTitle: a.courseTitle || null,
            title: a.title || a.assignmentTitle || null
          };
        });
        return map;
      } catch { return {}; }
    }

    // Enrichment
    async function enrichQuizzesWithCourse(qrows, forStudent) {
      if (!qrows?.length) return qrows || [];
      const metaMap = await getQuizMetaForStudent(forStudent);
      return qrows.map(q => {
        const m = metaMap[q.quizId] || {};
        return {
          ...q,
          title: q.title || m.title || q.quizId,
          courseId: q.courseId || m.courseId || null,
          courseTitle: q.courseTitle || m.courseTitle || null
        };
      });
    }
    async function enrichAssignmentsWithCourse(arows, userId) {
      if (!arows?.length) return arows || [];
      const metaMap = await getStudentAssignmentsMeta(userId);
      return arows.map(a => {
        const m = metaMap[a.assignmentId] || {};
        return {
          ...a,
          assignmentTitle: a.assignmentTitle || m.title || a.assignmentId,
          courseId: a.courseId || m.courseId || null,
          courseTitle: a.courseTitle || m.courseTitle || null
        };
      });
    }

    // Filtering/sorting state
    let _analyticsData = null;
    let _assignmentRows = [];
    let _quizRows = [];
    let _courseOptions = [];

    function buildCourseOptions(courses) {
      const set = new Map();
      (courses || []).forEach(c => {
        const id = c.id || c.courseId || c.courseRefId;
        const title = c.title || c.courseTitle || c.name || id;
        if (id) set.set(id, title);
      });
      const arr = Array.from(set.entries()).map(([id, title]) => ({ id, title }));
      arr.sort((a,b) => String(a.title||'').localeCompare(String(b.title||'')));
      return arr;
    }

    function populateCourseDropdown() {
      const sel = el('courseFilter');
      const keep = sel.value || '__ALL__';
      sel.innerHTML = `<option value="__ALL__">All courses</option>`;
      _courseOptions.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.id; o.textContent = opt.title || opt.id;
        sel.appendChild(o);
      });
      sel.value = (_courseOptions.some(o => o.id === keep) || keep === '__ALL__') ? keep : '__ALL__';
    }

    function filterByCourse(rows, courseId) {
      if (!rows?.length) return [];
      if (!courseId || courseId === '__ALL__') return rows;
      return rows.filter(r => r.courseId === courseId);
    }

    // Sorters
    function sortQuizzesByBestPercent(rows) {
      const p = r => Number.isFinite(+r.bestPercent) ? +r.bestPercent : -1;
      return [...rows].sort((a, b) => p(b) - p(a) || String(a.title||'').localeCompare(String(b.title||'')));
    }
    function sortAssignmentsByPercentDesc(rows) {
      const gradeOf = r => {
        const g = gradePctFromRow(r);
        return (g == null) ? -1 : g;
      };
      const timeOf = r => (r.gradedAt?._seconds ? r.gradedAt._seconds * 1000
                         : (typeof r.gradedAt === 'number' ? r.gradedAt
                         : Date.parse(r.gradedAt) || 0));
      return [...rows].sort((a,b) => gradeOf(b) - gradeOf(a) || timeOf(b) - timeOf(a));
    }

    // Renderers
    function renderQuizzes(qrows) {
      const rows = sortQuizzesByBestPercent(qrows || []);
      if (!rows.length) {
        el('quizTbody').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No quiz data</td></tr>';
        renderBar('quizChart', ['No data'], [0], 'Best %', 'quiz');
      } else {
        el('quizTbody').innerHTML = rows.map(r => `
          <tr>
            <td class="wrap-anywhere">${r.title || r.quizId}</td>
            <td>${pct(r.bestPercent)}</td>
            <td>${r.attemptsUsed ?? 0}</td>
            <td>${dt(r.lastSubmittedAt)}</td>
          </tr>
        `).join('');
        renderBar('quizChart', rows.map(r=>r.title || r.quizId), rows.map(r=>r.bestPercent || 0), 'Best %', 'quiz');
      }
    }

    function renderAssignments(arows) {
      const rows = sortAssignmentsByPercentDesc(arows || []);
      if (!rows.length) {
        el('assignTbody').innerHTML = '<tr><td colspan="3" class="text-center text-muted">No assignments</td></tr>';
        renderBar('assignChart', ['No data'], [0], 'Grade %', 'assign');
        return;
      }
      el('assignTbody').innerHTML = rows.map(a => {
        const gp = gradePctFromRow(a);
        const raw = firstNum(a.gradeRaw, a.grade, a.score, a.obtained);
        const max = firstNum(a.maxPoints, a.assignmentMaxPoints, a.max, a.maxScore, a.totalPoints, a.points, a.denominator, a.outOf);
        const rawInfo = (raw != null && max != null)
          ? `title="Raw: ${raw}/${max}"`
          : '';
        return `
          <tr>
            <td class="wrap-anywhere">${a.assignmentTitle || a.assignmentId}</td>
            <td ${rawInfo}>${gp != null ? gp + '%' : '—'}</td>
            <td>${dt(a.gradedAt)}</td>
          </tr>
        `;
      }).join('');

      const labels = rows.map(a => a.assignmentTitle || a.assignmentId);
      const values = rows.map(a => gradePctFromRow(a) ?? 0);
      renderBar('assignChart', labels, values, 'Grade %', 'assign');
    }

    function applyFiltersAndRender() {
      const selectedCourse = el('courseFilter').value || '__ALL__';
      renderAssignments(filterByCourse(_assignmentRows, selectedCourse));
      renderQuizzes(filterByCourse(_quizRows, selectedCourse));
    }

    // CSV (respects filter)
    async function exportCsv() {
      try {
        const student = getStudentKey();
        const data = _analyticsData || await getAnalyticsJson(student);

        const selectedCourse = el('courseFilter').value || '__ALL__';
        const aSorted = sortAssignmentsByPercentDesc(filterByCourse(_assignmentRows, selectedCourse));
        const qSorted = sortQuizzesByBestPercent(filterByCourse(_quizRows, selectedCourse));

        let csv = [];
        csv.push('Student Name,Student ID,Avg Quiz %,Avg Assignment %,Modules Completed');
        csv.push(`"${el('s_name').textContent}","${el('s_id').textContent}","${el('s_avg_quiz').textContent}","${el('s_avg_asg').textContent}","${el('s_modules').textContent}"`);

        csv.push('');
        csv.push('Quizzes');
        csv.push('Quiz,Best %,Attempts,Last Attempt');
        qSorted.forEach(r => {
          csv.push(`"${(r.title || r.quizId).replace(/"/g,'""')}","${pct(r.bestPercent)}","${r.attemptsUsed ?? 0}","${dt(r.lastSubmittedAt)}"`);
        });

        csv.push('');
        csv.push('Assignments');
        csv.push('Assignment,Grade %,Graded At');
        aSorted.forEach(a => {
          const gp = gradePctFromRow(a);
          csv.push(`"${(a.assignmentTitle || a.assignmentId).replace(/"/g,'""')}","${gp != null ? gp + '%' : ''}","${dt(a.gradedAt)}"`);
        });

        csv.push('');
        csv.push('Essay Submissions');
        csv.push('Quiz,Question #,Status,Score,Submitted');
        (data.essays?.submissions || []).forEach(e => {
          csv.push(`"${(e.quizTitle||'').replace(/"/g,'""')}","${e.questionIndex != null ? (e.questionIndex+1) : ''}","${e.status}","${e.score != null ? `${e.score}/${e.maxScore}` : ''}","${dt(e.createdAt)}"`);
        });

        csv.push('');
        csv.push('Completed Modules');
        csv.push('Course,Module,Percent,Completed At');
        (data.modules?.completed || []).forEach(m => {
          csv.push(`"${(m.courseTitle||'').replace(/"/g,'""')}","${(m.moduleTitle||'').replace(/"/g,'""')}","100%","${dt(m.completedAt)}"`);
        });

        const blob = new Blob([csv.join('\r\n')], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `student_analytics_${student}.csv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      } catch (e) {
        console.error(e);
        showModalAlert('CSV export failed', 'Please check your connection and try again.');
      }
    }

    // PDF (respects filter)
    async function downloadPdf() {
      try {
        if (typeof window.jspdf === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
            s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
          });
        }
        if (typeof window.jspdf?.jsPDF === 'undefined') {
          showModalAlert('PDF download failed', 'Failed to load jsPDF library. Please try again.');
          return;
        }
        if (typeof window.jspdf?.autoTable === 'undefined') {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.0/dist/jspdf.plugin.autotable.min.js';
            s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
          });
        }

        const student = getStudentKey();
        const doc = new window.jspdf.jsPDF();

        // Header
        doc.setFont('times', 'bold'); doc.setFontSize(18);
        doc.text('Student Analytics Report', 105, 20, { align: 'center' });
        doc.setFontSize(12); doc.setFont('times', 'normal');
        doc.text(`Name: ${el('s_name').textContent}`, 20, 32);
        doc.text(`Student ID: ${el('s_id').textContent}`, 20, 40);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 48);

        // Summary
        doc.autoTable({
          startY: 55,
          head: [['Avg Quiz %', 'Avg Assignment %', 'Modules Completed']],
          body: [[el('s_avg_quiz').textContent, el('s_avg_asg').textContent, el('s_modules').textContent]],
          theme: 'grid',
          styles: { font: 'times', fontSize: 11, halign: 'center' },
          headStyles: { fillColor: [255,178,0], textColor: 0 },
        });

        let y = doc.lastAutoTable.finalY + 8;

        // Quizzes
        doc.setFont('times', 'bold'); doc.text('Quizzes', 20, y);
        doc.setFont('times', 'normal'); y += 2;
        const selectedCourse = el('courseFilter').value || '__ALL__';
        const qSorted = sortQuizzesByBestPercent(filterByCourse(_quizRows, selectedCourse));
        doc.autoTable({
          startY: y,
          head: [['Quiz', 'Best %', 'Attempts', 'Last Attempt']],
          body: qSorted.map(r => [r.title || r.quizId, pct(r.bestPercent), r.attemptsUsed ?? 0, dt(r.lastSubmittedAt)]),
          theme: 'grid',
          styles: { font: 'times', fontSize: 10 },
          headStyles: { fillColor: [240,240,240], textColor: 0 },
        });

        // Assignments
        y = doc.lastAutoTable.finalY + 8;
        doc.setFont('times', 'bold'); doc.text('Assignments', 20, y);
        doc.setFont('times', 'normal'); y += 2;
        const aSorted = sortAssignmentsByPercentDesc(filterByCourse(_assignmentRows, selectedCourse));
        doc.autoTable({
          startY: y,
          head: [['Assignment', 'Grade %', 'Graded At']],
          body: aSorted.map(a => {
            const gp = gradePctFromRow(a);
            return [a.assignmentTitle || a.assignmentId, gp != null ? `${gp}%` : '', dt(a.gradedAt)];
          }),
          theme: 'grid',
          styles: { font: 'times', fontSize: 10 },
          headStyles: { fillColor: [240,240,240], textColor: 0 },
        });

        // Essays
        y = doc.lastAutoTable.finalY + 8;
        doc.setFont('times', 'bold'); doc.text('Essay Submissions', 20, y);
        doc.setFont('times', 'normal'); y += 2;
        const data = _analyticsData || {};
        doc.autoTable({
          startY: y,
          head: [['Quiz', 'Question #', 'Status', 'Score', 'Submitted']],
          body: (data.essays?.submissions || []).map(e => [e.quizTitle, e.questionIndex != null ? (e.questionIndex+1) : '', e.status, e.score != null ? `${e.score}/${e.maxScore}` : '', dt(e.createdAt)]),
          theme: 'grid',
          styles: { font: 'times', fontSize: 10 },
          headStyles: { fillColor: [240,240,240], textColor: 0 },
        });

        // Modules
        y = doc.lastAutoTable.finalY + 8;
        doc.setFont('times', 'bold'); doc.text('Completed Modules', 20, y);
        doc.setFont('times', 'normal'); y += 2;
        doc.autoTable({
          startY: y,
          head: [['Course', 'Module', 'Percent', 'Completed At']],
          body: (data.modules?.completed || []).map(m => [m.courseTitle, m.moduleTitle, '100%', dt(m.completedAt)]),
          theme: 'grid',
          styles: { font: 'times', fontSize: 10 },
          headStyles: { fillColor: [240,240,240], textColor: 0 },
        });

        doc.save(`student_analytics_${student}.pdf`);
      } catch (e) {
        console.error(e);
        showModalAlert('PDF download failed', 'We couldn’t generate your PDF. Ensure libraries loaded and the endpoint is reachable.');
      }
    }

    // Initial load
    async function load() {
      const student = getStudentKey();

      // quick skeletons
      el('quizTbody').innerHTML =
        '<tr><td colspan="4"><div class="skeleton" style="height:22px"></div></td></tr>';
      el('assignTbody').innerHTML =
        '<tr><td colspan="3"><div class="skeleton" style="height:22px"></div></td></tr>';

      const [data, courses] = await Promise.all([
        getAnalyticsJson(student),
        getCoursesForStudent(student)
      ]);
      _analyticsData = data;

      // Header
      const first  = (data.profile?.firstName  || '').trim();
      const middle = (data.profile?.middleName || '').trim();
      const last   = (data.profile?.lastName   || '').trim();
      const fullFromApi = [first, middle, last].filter(Boolean).join(' ').trim();
      const fullFromLocal =
        [USER.firstName, USER.middleName, USER.lastName].filter(Boolean).join(' ').trim() ||
        (USER.fullName || '').trim();

      el('s_name').textContent =
        fullFromApi || fullFromLocal || (data.profile?.name || '').trim() ||
        (data.profile?.email || '').trim() || 'Student';

      el('s_id').textContent = data.profile?.studentId || '—';
      el('s_avg_quiz').textContent = pct(data.summary?.averageQuizScore);
      el('s_avg_asg').textContent = pct(data.summary?.averageAssignmentGrade);
      el('s_modules').textContent =
        (data.summary?.modulesCompleted != null && data.summary?.totalModules != null)
          ? `${data.summary.modulesCompleted}/${data.summary.totalModules}`
          : (data.summary?.modulesCompleted ?? '—');

      // Quizzes (enrich with course)
      _quizRows = await enrichQuizzesWithCourse(data.quizzes?.perQuiz || [], student);
      renderQuizzes(_quizRows);

      // Assignments (enrich with course)
      _assignmentRows = await enrichAssignmentsWithCourse(data.assignments?.grades || [], student);

      // Course dropdown
      _courseOptions = buildCourseOptions(courses);
      populateCourseDropdown();

      // Apply filter + render
      applyFiltersAndRender();

      // Essays
      const erows = data.essays?.submissions || [];
      el('essayTbody').innerHTML = erows.length
        ? erows.map(e => `
          <tr>
            <td class="wrap-anywhere">${e.quizTitle || e.quizId || ''}</td>
            <td>${e.questionIndex != null ? (e.questionIndex + 1) : '—'}</td>
            <td><span class="badge ${e.status?.toLowerCase() === 'graded' ? 'bg-success' : 'bg-secondary'}">${(e.status || 'pending').toUpperCase()}</span></td>
            <td>${e.score != null ? `${e.score}/${e.maxScore ?? 10}` : '—'}</td>
            <td>${dt(e.createdAt)}</td>
          </tr>
        `).join('')
        : '<tr><td colspan="5" class="text-center text-muted">No essay submissions</td></tr>';

      // Modules
      const mrows = data.modules?.completed || [];
      el('modTbody').innerHTML = mrows.length
        ? mrows.map(m => `
          <tr>
            <td class="wrap-anywhere">${m.courseTitle || m.courseId || ''}</td>
            <td class="wrap-anywhere">${m.moduleTitle || m.moduleId || ''}</td>
            <td>100%</td>
            <td>${dt(m.completedAt)}</td>
          </tr>
        `).join('')
        : '<tr><td colspan="4" class="text-center text-muted">No modules completed</td></tr>';
    }

    // Wire up UI
    document.getElementById('exportCsv').addEventListener('click', exportCsv);
    document.getElementById('downloadPdf').addEventListener('click', downloadPdf);
    document.getElementById('applyFilters').addEventListener('click', applyFiltersAndRender);
    document.getElementById('courseFilter').addEventListener('change', applyFiltersAndRender);

    load().catch(err => {
      console.error(err);
      showModalAlert('Failed to load analytics', 'The analytics endpoint did not respond. Please refresh and try again.');
    });
  </script>

  <!-- Reusable Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="feedbackModalTitle">
            <i class="bi bi-info-circle"></i> Notice
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="feedbackModalBody">
          Something happened.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
          <button type="button" id="successOkBtn" class="btn">OK</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
