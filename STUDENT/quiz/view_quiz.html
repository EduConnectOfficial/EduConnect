<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Quiz Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Shared styles (optional) -->
  <link rel="stylesheet" href="../quiz/quiz.css" />

  <style>
    .meta-badge { display:inline-flex; align-items:center; gap:.35rem; border:1px solid #e5e7eb; border-radius:9999px; padding:.25rem .6rem; font-size:.85rem; background:#fff; }
    .meta-row { display:flex; flex-wrap:wrap; gap:.5rem; }
    .ui-subtle { color:#6b7280; }
    .rubric-box { border:1px dashed #cbd5e1; border-radius:.5rem; padding:.75rem; background:#f8fafc; }
    .list-check > li { margin:.35rem 0; }
    .guard { border-left:4px solid #0d6efd; padding:.75rem .9rem; background:#f8fbff; }
    .disabled-note { color:#9ca3af; }
    .rubric-preview { border:1px solid #e5e7eb; border-radius:.5rem; overflow:hidden; background:#fff; }
    .rubric-meta { font-size:.875rem; color:#6b7280; }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title brand">Quiz Overview</h1>

        <div id="loadBox" class="text-center py-5">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div class="mt-2">Loading quiz…</div>
        </div>

        <div id="errorBox" class="alert alert-danger d-none">Could not load quiz.</div>
        <div id="notFoundBox" class="alert alert-warning d-none">Quiz not found or unavailable.</div>

        <div id="quizBox" class="ui-card card-themed d-none">
          <div class="ui-card-head d-flex justify-content-between align-items-start">
            <div>
              <h2 id="quizTitle" class="ui-card-title mb-1">—</h2>
              <div id="quizDesc" class="ui-subtext"></div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <span id="statusBadge" class="badge text-bg-secondary">—</span>
              <button id="rubricBtn" type="button" class="btn btn-sm btn-outline-info d-none">
                <i class="bi bi-file-earmark-text"></i> Open Rubric
              </button>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <div class="p-3 border rounded-3 bg-white">
                <h5 class="mb-2">Details</h5>
                <div id="courseModule" class="ui-card-title mb-2">—</div>
                <div class="meta-row mb-3">
                  <span class="meta-badge"><i class="bi bi-list-ol"></i> <span id="qCount">—</span> questions</span>
                  <span class="meta-badge"><i class="bi bi-stopwatch"></i> <span id="duration">—</span></span>
                  <span class="meta-badge"><i class="bi bi-calendar-event"></i> Due: <span id="dueAt">—</span></span>
                  <span class="meta-badge"><i class="bi bi-bar-chart"></i> <span id="difficulty">—</span></span>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <div class="rubric-box h-100">
                      <div class="fw-semibold mb-1"><i class="bi bi-gear"></i> Behavior</div>
                      <ul class="mb-0 list-unstyled small">
                        <li>Backtracking: <span id="backtrack">—</span></li>
                        <li>Shuffling: <span id="shuffle">—</span></li>
                        <li>Pagination: <span id="pagination">—</span></li>
                        <li>Timer: <span id="timerEnabled">—</span></li>
                      </ul>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="rubric-box h-100">
                      <div class="fw-semibold mb-1"><i class="bi bi-repeat"></i> Attempts</div>
                      <div id="attemptsLine" class="small">—</div>
                    </div>
                  </div>
                </div>

                <!-- Rubric section -->
                <div id="rubricSection" class="mt-3 d-none">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="fw-semibold"><i class="bi bi-file-earmark-text"></i> Rubric</div>
                    <div class="rubric-meta" id="rubricMeta"></div>
                  </div>
                  <div id="rubricPreviewWrap" class="rubric-preview d-none">
                    <!-- PDF preview injected here -->
                  </div>
                </div>

                <div id="instructionsWrap" class="mt-3 d-none">
                  <div class="guard rounded-3">
                    <div class="fw-semibold mb-1"><i class="bi bi-info-circle"></i> Instructions</div>
                    <ul id="instructionsList" class="list-check mb-0"></ul>
                  </div>
                </div>

              </div>
            </div>

            <div class="col-12 col-lg-4">
              <div class="p-3 border rounded-3 bg-white h-100">
                <h5 class="mb-2">Ready to start?</h5>
                <div id="startNotes" class="small ui-subtle mb-2">
                  Review the rubric and settings. Your timer (if any) begins once you start.
                </div>

                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="ackCheck">
                  <label class="form-check-label" for="ackCheck">
                    I understand the instructions and I’m ready to start.
                  </label>
                </div>

                <button id="startBtn" class="btn btn-amber w-100" disabled>
                  <i class="bi bi-play-circle"></i> Start Quiz
                </button>

                <div id="blockedMsg" class="mt-3 small text-danger d-none"></div>

                <div class="mt-3">
                  <a href="/STUDENT/quiz/quiz.html" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left"></i> Back to quizzes
                  </a>
                </div>
              </div>
            </div>
          </div>

        </div> <!-- /quizBox -->
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- App -->
  <script>
    const API_BASE = "http://localhost:5000";

    function getParam(name){ const url = new URL(location.href); return url.searchParams.get(name); }
    function ts(v){ if(!v) return null; if(v instanceof Date) return v; if(typeof v === 'number' || typeof v === 'string') return new Date(v); if(v?.toDate) return v.toDate(); if(typeof v?.seconds === 'number') return new Date(v.seconds*1000); if(typeof v?._seconds === 'number') return new Date(v._seconds*1000); return null; }
    function fmtDate(v){ const d=ts(v); return d? d.toLocaleString(): "—"; }
    function initialsFrom(str){
      if(!str) return "";
      const s=String(str).trim(); if(!s) return "";
      if(s.includes("@")){
        const local=s.split("@")[0];
        const parts=local.split(/[.\-_]+/).filter(Boolean);
        return (parts.length>=2?parts[0][0]+parts[parts.length-1][0]:local.slice(0,2)).toUpperCase();
      }
      const parts=s.split(/[\s\-]+/).filter(Boolean);
      return (parts.length>=2?parts[0][0]+parts[parts.length-1][0]:parts[0].slice(0,2)).toUpperCase();
    }

    // Header user initials
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    (function initHeader(){
      const el = document.getElementById("Username");
      const displayName = userData.fullName || userData.username || userData.email || "Student";
      if(el){
        el.textContent = initialsFrom(displayName) || "?";
        el.title = displayName;
        el.setAttribute("aria-label", displayName);
      }
    })();

    const quizId = getParam('id');

    const loadBox = document.getElementById('loadBox');
    const errorBox = document.getElementById('errorBox');
    const notFoundBox = document.getElementById('notFoundBox');
    const quizBox = document.getElementById('quizBox');

    const titleEl = document.getElementById('quizTitle');
    const descEl = document.getElementById('quizDesc');
    const courseModuleEl = document.getElementById('courseModule');
    const statusBadge = document.getElementById('statusBadge');

    const qCountEl = document.getElementById('qCount');
    const durationEl = document.getElementById('duration');
    const dueAtEl = document.getElementById('dueAt');
    const difficultyEl = document.getElementById('difficulty');

    const backtrackEl = document.getElementById('backtrack');
    const shuffleEl = document.getElementById('shuffle');
    const paginationEl = document.getElementById('pagination');
    const timerEnabledEl = document.getElementById('timerEnabled');

    const attemptsLineEl = document.getElementById('attemptsLine');
    const rubricBtn = document.getElementById('rubricBtn');

    const instructionsWrap = document.getElementById('instructionsWrap');
    const instructionsList = document.getElementById('instructionsList');

    const rubricSection = document.getElementById('rubricSection');
    const rubricMeta = document.getElementById('rubricMeta');
    const rubricPreviewWrap = document.getElementById('rubricPreviewWrap');

    const ackCheck = document.getElementById('ackCheck');
    const startBtn = document.getElementById('startBtn');
    const blockedMsg = document.getElementById('blockedMsg');

    function statusOf(quiz){
      const now = Date.now();
      const openAt = ts(quiz.openAt)?.getTime() ?? null;
      const dueAt  = ts(quiz.dueAt)?.getTime() ?? null;
      if (openAt && now < openAt) return "Upcoming";
      if (dueAt && now > dueAt)   return "Closed";
      return "Open";
    }

    function setStatusBadge(st){
      statusBadge.textContent = st;
      statusBadge.className = 'badge ' + (st==='Open' ? 'text-bg-success' : st==='Upcoming' ? 'text-bg-info' : 'text-bg-secondary');
    }

    function yesNo(v){ return v ? 'Enabled' : 'Disabled'; }

    function setStartEnabled(flag, msg){
      startBtn.disabled = !flag || !ackCheck.checked;
      blockedMsg.classList.toggle('d-none', !!flag);
      blockedMsg.textContent = flag ? '' : (msg || '');
    }

    async function fetchAttempts(userId, quizId){
      try{
        const params = new URLSearchParams();
        params.set('quizIds', quizId);
        const res = await fetch(`${API_BASE}/api/students/${encodeURIComponent(userId)}/quiz-attempts?${params.toString()}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const js = await res.json();
        const record = js?.data?.[quizId] || {};
        return {
          used: Number(record.used || 0),
          allowed: record.allowed == null ? null : Number(record.allowed),
          left: record.left == null ? null : Number(record.left),
          lock: !!record.lock
        };
      }catch(err){
        console.warn('attempts error:', err);
        return { used: 0, allowed: null, left: null, lock: false };
      }
    }

    function humanDuration(mins){
      if(!Number.isFinite(mins) || mins <= 0) return 'No limit';
      return `${mins} min`;
    }

    // ---- Rubric helpers ----
    function bytesToNice(bytes){
      if(!Number.isFinite(bytes)) return '';
      const mb = bytes / (1024*1024);
      if (mb >= 1) return `${mb.toFixed(1)} MB`;
      const kb = bytes / 1024;
      if (kb >= 1) return `${kb.toFixed(0)} KB`;
      return `${bytes} B`;
    }

    function resolveRubricFromQuiz(quiz){
      // New path (your route): quiz.rubricFile.filePath (e.g. /uploads/quizzes/rubrics/xxx.pdf)
      if (quiz?.rubricFile?.filePath) {
        const path = String(quiz.rubricFile.filePath);
        const href = path.startsWith('http') ? path : `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
        return {
          url: href,
          mime: quiz.rubricFile.mime || '',
          originalName: quiz.rubricFile.originalName || '',
          size: quiz.rubricFile.size || null
        };
      }

      // Legacy string fields fallback
      const legacyKeys = ['rubricUrl','rubricURL','rubric','rubric_link','rubric_url','rubricLink'];
      for (const k of legacyKeys) {
        const v = quiz?.[k] || quiz?.settings?.[k];
        if (typeof v === 'string' && v.trim()) {
          return { url: v.trim(), mime: '', originalName: '', size: null };
        }
      }
      return null;
    }

    function showRubric(r){
      if (!r) {
        rubricBtn.classList.add('d-none');
        rubricSection.classList.add('d-none');
        return;
      }
      rubricBtn.classList.remove('d-none');
      rubricBtn.onclick = () => window.open(r.url, '_blank', 'noopener');

      rubricSection.classList.remove('d-none');
      const metaBits = [];
      if (r.originalName) metaBits.push(r.originalName);
      if (r.size != null) metaBits.push(bytesToNice(Number(r.size)));
      rubricMeta.textContent = metaBits.join(' • ');

      // If it's a PDF, try to preview inline
      const isPdf = (r.mime || '').toLowerCase().includes('pdf') || r.url.toLowerCase().endsWith('.pdf');
      if (isPdf) {
        rubricPreviewWrap.classList.remove('d-none');
        rubricPreviewWrap.innerHTML = `
          <iframe title="Rubric preview" src="${r.url}" width="100%" height="420" style="border:0;"></iframe>
        `;
      } else {
        rubricPreviewWrap.classList.add('d-none');
        rubricPreviewWrap.innerHTML = '';
      }
    }

    function fillInstructions(settings){
      const list = Array.isArray(settings?.instructions) ? settings.instructions : [];
      if(!list.length){
        instructionsWrap.classList.add('d-none');
        instructionsList.innerHTML = '';
        return;
      }
      instructionsWrap.classList.remove('d-none');
      instructionsList.innerHTML = list.map(t => `<li>${String(t)}</li>`).join('');
    }

    async function boot(){
      if(!quizId){
        loadBox.classList.add('d-none');
        notFoundBox.classList.remove('d-none');
        return;
      }

      try{
        const res = await fetch(`${API_BASE}/quizzes/${encodeURIComponent(quizId)}`);
        const data = await res.json();

        if(!data?.success || !data.quiz){
          loadBox.classList.add('d-none');
          notFoundBox.classList.remove('d-none');
          return;
        }

        const quiz = data.quiz;
        const settings = quiz.settings || {};

        // Header
        titleEl.textContent = quiz.title || 'Untitled Quiz';
        descEl.textContent = quiz.description || '';
        setStatusBadge(statusOf(quiz));

        // Meta
        const totalQ = Array.isArray(quiz.questions) ? quiz.questions.length : (quiz.totalQuestions || 0);
        qCountEl.textContent = String(totalQ || 0);
        durationEl.textContent = humanDuration(Number(settings.durationMinutes));
        dueAtEl.textContent = fmtDate(quiz.dueAt);
        difficultyEl.textContent = quiz.difficulty || '—';

        const courseLabel = quiz.courseTitle || quiz.courseName || 'Course';
        const moduleLabel = quiz.moduleTitle || quiz.moduleName || 'Module';
        courseModuleEl.textContent = `${courseLabel} • ${moduleLabel}`;

        backtrackEl.textContent = settings.backtrackingAllowed === false ? 'Not allowed' : 'Allowed';
        shuffleEl.textContent = (settings.shuffleQuestions === false) ? 'No' : 'Yes';
        const pag = settings.pagination && settings.pagination.enabled ? `Yes (${Number(settings.pagination.perPage)||1}/page)` : 'No';
        paginationEl.textContent = pag;
        timerEnabledEl.textContent = (settings.timerEnabled && Number(settings.durationMinutes) > 0) ? 'Enabled' : 'Disabled';

        // Rubric (from your route)
        const rubric = resolveRubricFromQuiz(quiz);
        showRubric(rubric);
        fillInstructions(settings);

        // Attempts
        const userId = userData?.userId || userData?.uid || userData?.id || userData?.email || '';
        let attempts = { used: 0, allowed: null, left: null, lock: false };
        if(userId){
          attempts = await fetchAttempts(userId, quiz.id);
        }
        const attText = (attempts.allowed == null)
          ? `Unlimited attempts. Used: ${attempts.used}`
          : `Attempts: ${attempts.used}/${attempts.allowed} ${typeof attempts.left==='number' ? `(left: ${Math.max(0, attempts.left)})` : ''}`;
        attemptsLineEl.textContent = attText;

        // Gate start
        const st = statusOf(quiz);
        if(st === 'Upcoming'){
          setStartEnabled(false, `This quiz will open on ${fmtDate(quiz.openAt)}.`);
        }else if(st === 'Closed'){
          setStartEnabled(false, `This quiz closed on ${fmtDate(quiz.dueAt)}.`);
        }else if(attempts.allowed != null && Math.max(0, attempts.left ?? (attempts.allowed - attempts.used)) === 0){
          setStartEnabled(false, 'You have no attempts left for this quiz.');
        }else{
          setStartEnabled(true, '');
        }

        ackCheck.addEventListener('change', () => {
          const okBase = !blockedMsg.textContent;
          startBtn.disabled = !ackCheck.checked || !okBase;
        });

        startBtn.addEventListener('click', () => {
          // proceed to quiz taking page
          window.location.href = `/STUDENT/quiz/take_quiz.html?id=${encodeURIComponent(quiz.id)}`;
        });

        loadBox.classList.add('d-none');
        quizBox.classList.remove('d-none');
      }catch(err){
        console.error(err);
        loadBox.classList.add('d-none');
        errorBox.classList.remove('d-none');
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function logoutUser(){ localStorage.clear(); sessionStorage.clear(); window.location.href='/STUDENT/login/login.html'; }
  </script>
</body>
</html>
