<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Quiz Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Shared styles (optional) -->
  <link rel="stylesheet" href="../quiz/quiz.css" />

  <style>
    .meta-badge { display:inline-flex; align-items:center; gap:.35rem; border:1px solid #e5e7eb; border-radius:9999px; padding:.25rem .6rem; font-size:.85rem; background:#fff; }
    .meta-row { display:flex; flex-wrap:wrap; gap:.5rem; }
    .ui-subtle { color:#6b7280; }
    .rubric-box { border:1px dashed #cbd5e1; border-radius:.5rem; padding:.75rem; background:#f8fafc; }
    .list-check > li { margin:.35rem 0; }
    .guard { border-left:4px solid #0d6efd; padding:.75rem .9rem; background:#f8fbff; }
    .disabled-note { color:#9ca3af; }
    .rubric-preview { border:1px solid #e5e7eb; border-radius:.5rem; overflow:hidden; background:#fff; }
    .rubric-meta { font-size:.875rem; color:#6b7280; }

    /* Long text safety */
    .wrap-anywhere { overflow-wrap:anywhere; word-break:break-word; line-break:anywhere; }
    #quizDesc { white-space:pre-wrap; }

    /* ===== Full-screen-ish File Preview Modal ===== */
    #filePreviewModal .modal-dialog { max-width: 96vw; }
    #filePreviewModal .modal-content { height: 92vh; display: flex; flex-direction: column; }
    #filePreviewModal .modal-body { flex: 1 1 auto; padding: 0; background: #f8fafc; position: relative; }
    .preview-wrap { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .preview-wrap iframe, .preview-wrap embed, .preview-wrap object, .preview-wrap img, .preview-wrap video, .preview-wrap audio {
      width: 100%; height: 100%; border: 0; object-fit: contain; background: #fff;
    }
    .preview-fallback { max-width: 720px; margin: 0 auto; padding: 2rem; text-align: center; }
    #filePreviewFooter { display: flex; gap: .5rem; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .spinner-wrap { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #ffffff; }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title brand">Quiz Overview</h1>

        <div id="loadBox" class="text-center py-5">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div class="mt-2">Loading quiz…</div>
        </div>

        <div id="errorBox" class="alert alert-danger d-none">Could not load quiz.</div>
        <div id="notFoundBox" class="alert alert-warning d-none">Quiz not found or unavailable.</div>

        <div id="quizBox" class="ui-card card-themed d-none">
          <div class="ui-card-head d-flex justify-content-between align-items-start">
            <div>
              <h2 id="quizTitle" class="ui-card-title mb-1 wrap-anywhere">—</h2>
              <div id="quizDesc" class="ui-subtext wrap-anywhere"></div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <span id="statusBadge" class="badge text-bg-secondary">—</span>
              <button id="rubricBtn" type="button" class="btn btn-sm btn-outline-info d-none">
                <i class="bi bi-file-earmark-text"></i> Open Rubric
              </button>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <div class="p-3 border rounded-3 bg-white">
                <h5 class="mb-2">Details</h5>
                <div id="courseModule" class="ui-card-title mb-2 wrap-anywhere">—</div>
                <div class="meta-row mb-3">
                  <span class="meta-badge"><i class="bi bi-list-ol"></i> <span id="qCount">—</span> questions</span>
                  <span class="meta-badge"><i class="bi bi-stopwatch"></i> <span id="duration">—</span></span>
                  <span class="meta-badge"><i class="bi bi-calendar-event"></i> Due: <span id="dueAt">—</span></span>
                  <span class="meta-badge"><i class="bi bi-bar-chart"></i> <span id="difficulty">—</span></span>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <div class="rubric-box h-100">
                      <div class="fw-semibold mb-1"><i class="bi bi-gear"></i> Behavior</div>
                      <ul class="mb-0 list-unstyled small">
                        <li>Backtracking: <span id="backtrack">—</span></li>
                        <li>Shuffling: <span id="shuffle">—</span></li>
                        <li>Pagination: <span id="pagination">—</span></li>
                        <li>Timer: <span id="timerEnabled">—</span></li>
                      </ul>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="rubric-box h-100">
                      <div class="fw-semibold mb-1"><i class="bi bi-repeat"></i> Attempts</div>
                      <div id="attemptsLine" class="small">—</div>
                    </div>
                  </div>
                </div>

                <!-- Rubric section (meta + preview slot; we will open modal instead of inline) -->
                <div id="rubricSection" class="mt-3 d-none">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="fw-semibold"><i class="bi bi-file-earmark-text"></i> Rubric</div>
                    <div class="rubric-meta wrap-anywhere" id="rubricMeta"></div>
                  </div>
                  <div id="rubricPreviewWrap" class="rubric-preview d-none"></div>
                </div>

                <div id="instructionsWrap" class="mt-3 d-none">
                  <div class="guard rounded-3">
                    <div class="fw-semibold mb-1"><i class="bi bi-info-circle"></i> Instructions</div>
                    <ul id="instructionsList" class="list-check mb-0"></ul>
                  </div>
                </div>

              </div>
            </div>

            <div class="col-12 col-lg-4">
              <div class="p-3 border rounded-3 bg-white h-100">
                <h5 class="mb-2">Ready to start?</h5>
                <div id="startNotes" class="small ui-subtle mb-2">
                  Review the rubric and settings. Your timer (if any) begins once you start.
                </div>

                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="ackCheck">
                  <label class="form-check-label" for="ackCheck">
                    I understand the instructions and I’m ready to start.
                  </label>
                </div>

                <button id="startBtn" class="btn btn-amber w-100" disabled>
                  <i class="bi bi-play-circle"></i> Start Quiz
                </button>

                <div id="blockedMsg" class="mt-3 small text-danger d-none"></div>

                <div class="mt-3">
                  <a href="/STUDENT/quiz/quiz.html" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left"></i> Back to quizzes
                  </a>
                </div>
              </div>
            </div>
          </div>

        </div> <!-- /quizBox -->
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>

        <div class="modal-footer" id="filePreviewFooter">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto">
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-amber">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Students-only auth guard + header initials -->
  <script>
    (function guardStudentSession() {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;

      const isValid =
        !!u?.userId &&
        u?.isStudent === true &&
        /^S-/.test(String(u?.studentId || ''));

      if (!isValid) {
        try { localStorage.removeItem('user'); } catch {}
        window.location.replace("../login/login.html"); // page is under /STUDENT/quiz/
        return;
      }

      // Expose for other scripts
      window.currentUser = u;
      window.userData = u;

      // Header initials
      function initialsFrom(str) {
        if (!str) return "";
        const s = String(str).trim();
        if (!s) return "";
        if (s.includes("@")) {
          const local = s.split("@")[0];
          const parts = local.split(/[.\-_]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
          return local.slice(0, 2).toUpperCase();
        }
        const parts = s.split(/[\s\-]+/).filter(Boolean);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        return parts[0].slice(0, 2).toUpperCase();
      }
      const el = document.getElementById("Username");
      if (el) {
        const displayName = u.fullName || u.username || u.email || "Student";
        const initials = initialsFrom(displayName) || "?";
        el.textContent = initials;
        el.title = displayName;
        el.setAttribute("aria-label", displayName);
      }

      // Cross-tab tamper guard
      window.addEventListener("storage", (e) => {
        if (e.key === "user") {
          try {
            const next = JSON.parse(e.newValue || "null");
            const nu = (next && (next.user || next)) || null;
            const ok = !!nu?.userId && nu?.isStudent === true && /^S-/.test(String(nu?.studentId || ''));
            if (!ok) window.location.replace("../login/login.html");
          } catch {
            window.location.replace("../login/login.html");
          }
        }
      });
    })();

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>

  <!-- App -->
  <script>
    const API_BASE = "http://localhost:5000";

    function getParam(name){ const url = new URL(location.href); return url.searchParams.get(name); }
    function ts(v){ if(!v) return null; if(v instanceof Date) return v; if(typeof v === 'number' || typeof v === 'string') return new Date(v); if(v?.toDate) return v.toDate(); if(typeof v?.seconds === 'number') return new Date(v.seconds*1000); if(typeof v?._seconds === 'number') return new Date(v._seconds*1000); return null; }
    function fmtDate(v){ const d=ts(v); return d? d.toLocaleString(): "—"; }

    // Insert zero-width space every 40 chars to allow breaking
    function softWrap(s, limit=40){
      if (!s) return s;
      return String(s).replace(new RegExp(`([^\\s]{${limit}})`, 'g'), '$1\u200B');
    }

    const quizId = getParam('id');

    const loadBox = document.getElementById('loadBox');
    const errorBox = document.getElementById('errorBox');
    const notFoundBox = document.getElementById('notFoundBox');
    const quizBox = document.getElementById('quizBox');

    const titleEl = document.getElementById('quizTitle');
    const descEl = document.getElementById('quizDesc');
    const courseModuleEl = document.getElementById('courseModule');
    const statusBadge = document.getElementById('statusBadge');

    const qCountEl = document.getElementById('qCount');
    const durationEl = document.getElementById('duration');
    const dueAtEl = document.getElementById('dueAt');
    const difficultyEl = document.getElementById('difficulty');

    const backtrackEl = document.getElementById('backtrack');
    const shuffleEl = document.getElementById('shuffle');
    const paginationEl = document.getElementById('pagination');
    const timerEnabledEl = document.getElementById('timerEnabled');

    const attemptsLineEl = document.getElementById('attemptsLine');
    const rubricBtn = document.getElementById('rubricBtn');

    const instructionsWrap = document.getElementById('instructionsWrap');
    const instructionsList = document.getElementById('instructionsList');

    const rubricSection = document.getElementById('rubricSection');
    const rubricMeta = document.getElementById('rubricMeta');
    const rubricPreviewWrap = document.getElementById('rubricPreviewWrap');

    const ackCheck = document.getElementById('ackCheck');
    const startBtn = document.getElementById('startBtn');
    const blockedMsg = document.getElementById('blockedMsg');

    /* ===== PREVIEW HELPERS (modal) ===== */
    function isYouTubeUrl(url=''){ try{const u=new URL(url);const h=u.hostname.replace(/^www\./,'').toLowerCase();return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);}catch{return false;} }
    function toYouTubeEmbed(url=''){ try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();let id='';let start=u.searchParams.get('start')||u.searchParams.get('t')||'';if(start&&/^\d+s$/.test(start))start=parseInt(start,10);if(start&&/^\d+$/.test(start))start=parseInt(start,10);if(!Number.isFinite(start))start='';if(host==='youtu.be'){id=(u.pathname||'').replace(/^\//,'').split('/')[0];}else{if(u.pathname.startsWith('/embed/'))id=u.pathname.split('/')[2]||'';if(!id)id=u.searchParams.get('v')||'';}if(!id)return null;const base=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;const qs=new URLSearchParams();qs.set('rel','0');if(start)qs.set('start',String(start));return `${base}?${qs.toString()}`;}catch{return null;} }
    function getExtFromUrl(url=''){ const clean=String(url).split('?')[0].split('#')[0]; const parts=clean.split('.'); return parts.length>1?parts.pop().toLowerCase():''; }
    function kindFromUrl(url){ if(isYouTubeUrl(url))return'youtube'; const ext=getExtFromUrl(url); if(['mp4','webm','ogg','ogv','mov'].includes(ext))return'video'; if(['mp3','wav','m4a','ogg','aac','flac'].includes(ext))return'audio'; if(['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext))return'image'; if(ext==='pdf')return'pdf'; if(['txt','csv','log'].includes(ext))return'text'; if(['doc','docx','ppt','pptx','xls','xlsx'].includes(ext))return'office'; return'other'; }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function setFileInfoUI(kind,url){
      const info=document.getElementById('fileInfoText');
      const hdr=document.getElementById('filePreviewModalLabel');
      const labelMap={youtube:'YouTube',video:'Video',audio:'Audio',image:'Image',pdf:'PDF',text:'Text/CSV',office:'Office Doc',other:'File'};
      const colorMap={youtube:'bg-danger-subtle text-danger',video:'bg-danger-subtle text-danger',audio:'bg-secondary-subtle text-secondary',image:'bg-success-subtle text-success',pdf:'bg-primary-subtle text-primary',text:'bg-info-subtle text-info',office:'bg-warning-subtle text-warning',other:'bg-dark-subtle text-dark'};
      let badge=document.getElementById('fileKindBadge'); if(!badge){badge=document.createElement('span');badge.id='fileKindBadge';badge.className='ms-2 badge rounded-pill';hdr.appendChild(badge);}
      badge.className='ms-2 badge rounded-pill '+(colorMap[kind]||colorMap.other); badge.textContent=labelMap[kind]||'File';
      info.innerHTML=`<span class="text-muted">Type:</span> <strong>${labelMap[kind]||'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href=url||'#';
    }
    function renderFilePreviewInto(container,url){
      container.innerHTML=''; showSpinner(true); const done=()=>showSpinner(false); const kind=kindFromUrl(url);
      const fallback=(msg)=>{ container.innerHTML=`<div class="preview-fallback"><div class="text-muted mb-2">${msg||'Preview not available.'}</div><a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`; done(); };

      if(kind==='youtube'){ const embed=toYouTubeEmbed(url); if(embed){container.innerHTML=`<div class="ratio ratio-16x9"><iframe src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin" style="border:0"></iframe></div>`; done(); return;} fallback('Couldn’t embed this YouTube link.'); return; }
      const ext=getExtFromUrl(url);

      if(['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)){ const img=new Image(); img.onload=done; img.onerror=()=>fallback('Image preview failed.'); img.src=url; container.appendChild(img); return; }
      if(ext==='pdf'){ const iframe=document.createElement('iframe'); iframe.title='PDF preview'; iframe.onload=done; iframe.onerror=()=>fallback('PDF preview failed (viewer blocked or CORS).'); iframe.src=url; container.appendChild(iframe); return; }
      if(['mp4','webm','ogg','ogv','mov'].includes(ext)){ const video=document.createElement('video'); video.controls=true; video.onloadeddata=done; video.onerror=()=>fallback('Video preview failed.'); video.src=url; container.appendChild(video); return; }
      if(['mp3','wav','m4a','ogg','aac','flac'].includes(ext)){ const audio=document.createElement('audio'); audio.controls=true; audio.onloadeddata=done; audio.onerror=()=>fallback('Audio preview failed.'); audio.src=url; container.appendChild(audio); return; }
      if(['txt','csv','log'].includes(ext)){ const iframe=document.createElement('iframe'); iframe.onload=done; iframe.onerror=()=>fallback('Text preview failed.'); iframe.src=url; container.appendChild(iframe); return; }
      if(['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)){ const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; const iframe=document.createElement('iframe'); iframe.title='Document preview'; iframe.onload=done; iframe.onerror=()=>fallback('Office preview failed (Google Viewer blocked or CORS).'); iframe.src=gview; container.appendChild(iframe); return; }

      const obj=document.createElement('object'); obj.data=url; obj.type='application/octet-stream'; obj.onload=done; obj.onerror=()=>fallback('This file type cannot be previewed here.'); container.appendChild(obj); setTimeout(done,1200);
    }
    function openPreviewModal(viewUrl, title='File'){
      document.getElementById("filePreviewModalLabel").textContent = `${title} – Preview`;
      setFileInfoUI(kindFromUrl(viewUrl), viewUrl);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), viewUrl);
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    function statusOf(quiz){
      const now = Date.now();
      const openAt = ts(quiz.openAt)?.getTime() ?? null;
      const dueAt  = ts(quiz.dueAt)?.getTime() ?? null;
      if (openAt && now < openAt) return "Upcoming";
      if (dueAt && now > dueAt)   return "Closed";
      return "Open";
    }
    function setStatusBadge(st){
      const cls = st==='Open' ? 'text-bg-success' : st==='Upcoming' ? 'text-bg-info' : 'text-bg-secondary';
      statusBadge.className = 'badge ' + cls;
      statusBadge.textContent = st;
    }
    function yesNo(v){ return v ? 'Enabled' : 'Disabled'; }
    function setStartEnabled(flag, msg){
      const ack = document.getElementById('ackCheck').checked;
      startBtn.disabled = !flag || !ack;
      blockedMsg.classList.toggle('d-none', !!flag);
      blockedMsg.textContent = flag ? '' : (msg || '');
    }

    async function fetchAttempts(userId, quizId){
      try{
        const params = new URLSearchParams();
        params.set('quizIds', quizId);
        const res = await fetch(`${API_BASE}/api/students/${encodeURIComponent(userId)}/quiz-attempts?${params.toString()}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const js = await res.json();
        const record = js?.data?.[quizId] || {};
        return {
          used: Number(record.used || 0),
          allowed: record.allowed == null ? null : Number(record.allowed),
          left: record.left == null ? null : Number(record.left),
          lock: !!record.lock
        };
      }catch(err){
        console.warn('attempts error:', err);
        return { used: 0, allowed: null, left: null, lock: false };
      }
    }
    function humanDuration(mins){
      if(!Number.isFinite(mins) || mins <= 0) return 'No limit';
      return `${mins} min`;
    }

    // ---- Rubric helpers ----
    function bytesToNice(bytes){
      if(!Number.isFinite(bytes)) return '';
      const mb = bytes / (1024*1024);
      if (mb >= 1) return `${mb.toFixed(1)} MB`;
      const kb = bytes / 1024;
      if (kb >= 1) return `${kb.toFixed(0)} KB`;
      return `${bytes} B`;
    }
    // Prefer downloadUrl; gracefully fall back to publicUrl or filePath.
    function resolveRubricFromQuiz(quiz){
      const rf = quiz?.rubricFile || null;
      if (!rf) return null;
      if (typeof rf.downloadUrl === 'string' && rf.downloadUrl.trim()) {
        return { url: rf.downloadUrl.trim(), mime: rf.mime || '', originalName: rf.originalName || '', size: rf.size ?? null };
      }
      if (typeof rf.publicUrl === 'string' && rf.publicUrl.trim()) {
        return { url: rf.publicUrl.trim(), mime: rf.mime || '', originalName: rf.originalName || '', size: rf.size ?? null };
      }
      if (typeof rf.filePath === 'string' && rf.filePath.trim()) {
        const path = rf.filePath.trim();
        const href = path.startsWith('http') ? path : `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
        return { url: href, mime: rf.mime || '', originalName: rf.originalName || '', size: rf.size ?? null };
      }
      return null;
    }

    // OPEN RUBRIC IN MODAL
    function showRubric(r){
      rubricSection.classList.remove('d-none');

      if (!r) {
        rubricBtn.classList.add('d-none');
        rubricMeta.textContent = 'Rubric unavailable.';
        rubricPreviewWrap.classList.add('d-none');
        rubricPreviewWrap.innerHTML = '';
        return;
      }

      const metaBits = [];
      if (r.originalName) metaBits.push(r.originalName);
      if (r.size != null) metaBits.push(bytesToNice(Number(r.size)));
      rubricMeta.textContent = metaBits.join(' • ');

      rubricPreviewWrap.classList.add('d-none');
      rubricPreviewWrap.innerHTML = '';

      rubricBtn.classList.remove('d-none');
      rubricBtn.onclick = () => openPreviewModal(r.url, r.originalName || 'Rubric');
    }

    function fillInstructions(settings){
      const list = Array.isArray(settings?.instructions) ? settings.instructions : [];
      if(!list.length){
        instructionsWrap.classList.add('d-none');
        instructionsList.innerHTML = '';
        return;
      }
      instructionsWrap.classList.remove('d-none');
      instructionsList.innerHTML = list.map(t => `<li>${String(t)}</li>`).join('');
    }

    async function boot(){
      if(!quizId){
        loadBox.classList.add('d-none');
        notFoundBox.classList.remove('d-none');
        return;
      }

      try{
        const res = await fetch(`${API_BASE}/quizzes/${encodeURIComponent(quizId)}`);
        const data = await res.json();

        if(!data?.success || !data.quiz){
          loadBox.classList.add('d-none');
          notFoundBox.classList.remove('d-none');
          return;
        }

        const quiz = data.quiz;
        const settings = quiz.settings || {};

        // Header
        document.getElementById('quizTitle').innerText = softWrap(quiz.title || 'Untitled Quiz');
        document.getElementById('quizDesc').innerText = softWrap(quiz.description || '');
        setStatusBadge(statusOf(quiz));

        // Meta
        const totalQ = Array.isArray(quiz.questions) ? quiz.questions.length : (quiz.totalQuestions || 0);
        qCountEl.textContent = String(totalQ || 0);
        durationEl.textContent = humanDuration(Number(settings.durationMinutes));
        dueAtEl.textContent = fmtDate(quiz.dueAt);
        difficultyEl.textContent = quiz.difficulty || '—';

        const courseLabel = quiz.courseTitle || quiz.courseName || 'Course';
        const moduleLabel = quiz.moduleTitle || quiz.moduleName || 'Module';
        courseModuleEl.innerText = `${courseLabel} • ${moduleLabel}`;

        backtrackEl.textContent = settings.backtrackingAllowed === false ? 'Not allowed' : 'Allowed';
        shuffleEl.textContent = (settings.shuffleQuestions === false) ? 'No' : 'Yes';
        const pag = settings.pagination && settings.pagination.enabled ? `Yes (${Number(settings.pagination.perPage)||1}/page)` : 'No';
        paginationEl.textContent = pag;
        timerEnabledEl.textContent = (settings.timerEnabled && Number(settings.durationMinutes) > 0) ? 'Enabled' : 'Disabled';

        // Rubric (downloadUrl preferred, fallback supported)
        const rubric = resolveRubricFromQuiz(quiz);
        showRubric(rubric);
        fillInstructions(settings);

        // Attempts
        const userId = window.userData?.userId || window.userData?.uid || window.userData?.id || window.userData?.email || '';
        let attempts = { used: 0, allowed: null, left: null, lock: false };
        if(userId){
          attempts = await fetchAttempts(userId, quiz.id);
        }
        const attText = (attempts.allowed == null)
          ? `Unlimited attempts. Used: ${attempts.used}`
          : `Attempts: ${attempts.used}/${attempts.allowed} ${typeof attempts.left==='number' ? `(left: ${Math.max(0, attempts.left)})` : ''}`;
        attemptsLineEl.textContent = attText;

        // Gate start
        const st = statusOf(quiz);
        if(st === 'Upcoming'){
          setStartEnabled(false, `This quiz will open on ${fmtDate(quiz.openAt)}.`);
        }else if(st === 'Closed'){
          setStartEnabled(false, `This quiz closed on ${fmtDate(quiz.dueAt)}.`);
        }else if(attempts.allowed != null && Math.max(0, attempts.left ?? (attempts.allowed - attempts.used)) === 0){
          setStartEnabled(false, 'You have no attempts left for this quiz.');
        }else{
          setStartEnabled(true, '');
        }

        ackCheck.addEventListener('change', () => {
          const okBase = !blockedMsg.textContent;
          startBtn.disabled = !ackCheck.checked || !okBase;
        });

        startBtn.addEventListener('click', () => {
          window.location.href = `/STUDENT/quiz/take_quiz.html?id=${encodeURIComponent(quiz.id)}`;
        });

        loadBox.classList.add('d-none');
        quizBox.classList.remove('d-none');
      }catch(err){
        console.error(err);
        loadBox.classList.add('d-none');
        errorBox.classList.remove('d-none');
      }
    }

    document.addEventListener('DOMContentLoaded', boot);

    function logoutUser(){
      localStorage.clear();
      sessionStorage.clear();
      window.location.href='/STUDENT/login/login.html';
    }
  </script>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
