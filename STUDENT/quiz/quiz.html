<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Available Quizzes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Sidebar / shared -->
  <link rel="stylesheet" href="../quiz/quiz.css" />
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title brand">Available Quizzes</h1>

        <!-- Filters -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-question-circle"></i> Filter & Sort</h2>
            <div class="ui-subtext">All quizzes you can access appear below.</div>
          </div>
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-4">
              <label class="form-label text-light">Course</label>
              <select id="courseSelect" class="form-select">
                <option value="">-- All Courses --</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label text-light">Module</label>
              <select id="moduleSelect" class="form-select" disabled>
                <option value="">-- All Modules --</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label text-light">Search</label>
                  <input id="quizSearch" type="search" class="form-control" placeholder="Search quizzes...">
                </div>
                <div class="col-6">
                  <select id="statusFilter" class="form-select">
                    <option value="All">All Status</option>
                    <option value="Open">Open</option>
                    <option value="Upcoming">Upcoming</option>
                    <option value="Closed">Closed</option>
                  </select>
                </div>
                <div class="col-6">
                  <select id="sortBy" class="form-select">
                    <option value="due">Sort: Due Date</option>
                    <option value="az">Sort: A → Z</option>
                    <option value="duration">Sort: Duration</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Status pills -->
        <div class="pill-row">
          <span class="pill pill-open"><i class="bi bi-check2-circle"></i><span class="pill-text"><strong id="countOpen">0</strong> Open</span></span>
          <span class="pill pill-upcoming"><i class="bi bi-calendar-event"></i><span class="pill-text"><strong id="countUpcoming">0</strong> Upcoming</span></span>
          <span class="pill pill-closed"><i class="bi bi-lock"></i><span class="pill-text"><strong id="countClosed">0</strong> Closed</span></span>
        </div>

        <!-- Quiz Cards Grid -->
        <div id="quizCards" class="row g-3"></div>
        <div id="emptyState" class="d-none alert alert-warning text-center">No quizzes found.</div>
        <div id="errorState" class="d-none alert alert-danger text-center">Could not load quizzes. Please try again.</div>
      </div>
    </div>
  </div>

  <!-- Score Modal -->
  <div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="scoreModalLabel">Quiz Results</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div id="scoreLoading" class="text-center py-4">
            <div class="spinner-border" role="status" aria-hidden="true"></div>
            <div class="mt-2">Loading…</div>
          </div>

          <div id="scoreEmpty" class="alert alert-warning d-none">No attempts yet.</div>
          <div id="scoreError" class="alert alert-danger d-none">Could not load results.</div>

          <div id="scoreContent" class="d-none">
            <div class="d-flex flex-wrap gap-3 mb-3">
              <div class="card p-2">
                <div class="small text-muted">Best</div>
                <div id="bestScore" class="fw-bold fs-5">—</div>
              </div>
              <div class="card p-2">
                <div class="small text-muted">Latest</div>
                <div id="latestScore" class="fw-bold fs-5">—</div>
              </div>
              <div class="card p-2">
                <div class="small text-muted">Attempts</div>
                <div id="attemptCount" class="fw-bold fs-5">0</div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Score</th>
                    <th>Percent</th>
                    <th>Time Taken</th>
                  </tr>
                </thead>
                <tbody id="attemptsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Auth / Setup (Students-only S- guard + initials) -->
  <script>
    const API_BASE = "http://localhost:5000";

    (function guardStudentSession() {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;

      const isValid =
        !!u?.userId &&
        u?.isStudent === true &&
        /^S-/.test(String(u?.studentId || ''));

      if (!isValid) {
        try { localStorage.removeItem('user'); } catch {}
        // This page is under /STUDENT/quiz/, so ../login/login.html is correct
        window.location.replace("../login/login.html");
        return;
      }

      // Expose globally for other scripts
      window.currentUser = u;
      window.userData = u;

      // Header initials
      function initialsFrom(str) {
        if (!str) return "";
        const s = String(str).trim();
        if (!s) return "";
        if (s.includes("@")) {
          const local = s.split("@")[0];
          const parts = local.split(/[.\-_]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
          return local.slice(0, 2).toUpperCase();
        }
        const parts = s.split(/[\s\-]+/).filter(Boolean);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        return parts[0].slice(0, 2).toUpperCase();
      }
      const el = document.getElementById("Username");
      if (el) {
        const displayName = u.fullName || u.username || u.email || "Student";
        const initials = initialsFrom(displayName) || "?";
        el.textContent = initials;
        el.title = displayName;
        el.setAttribute("aria-label", displayName);
      }

      // Cross-tab tamper guard
      window.addEventListener("storage", (e) => {
        if (e.key === "user") {
          try {
            const next = JSON.parse(e.newValue || "null");
            const nu = (next && (next.user || next)) || null;
            const ok = !!nu?.userId && nu?.isStudent === true && /^S-/.test(String(nu?.studentId || ''));
            if (!ok) window.location.replace("../login/login.html");
          } catch {
            window.location.replace("../login/login.html");
          }
        }
      });
    })();

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>

  <!-- Main App -->
  <script>
    const courseSelect = document.getElementById("courseSelect");
    const moduleSelect = document.getElementById("moduleSelect");
    const quizCards = document.getElementById("quizCards");
    const emptyState = document.getElementById("emptyState");
    const errorState = document.getElementById("errorState");
    const quizSearch = document.getElementById("quizSearch");
    const statusFilter = document.getElementById("statusFilter");
    const sortBy = document.getElementById("sortBy");

    // Status count pills
    const elCountOpen = document.getElementById("countOpen");
    const elCountUpcoming = document.getElementById("countUpcoming");
    const elCountClosed = document.getElementById("countClosed");

    let allQuizzes = [];
    let currentCourseId = "";
    let currentModuleId = "";

    const attemptsCache = new Map(); // quizId -> { used, allowed, left, lock }

    const coursesById = new Map(); // courseId -> course
    const modulesByCourse = new Map(); // courseId -> Map(moduleId -> module)

    // student classes & courses for assignment filtering (client-side)
    const studentClassIds = new Set();
    const studentCourseIds = new Set();
    let classesLoadedOk = false;
    let coursesLoadedOk = false;

    // ---------- Helpers ----------
    const ts = (obj) => {
      if (!obj) return null;
      if (obj instanceof Date) return obj;
      if (typeof obj === 'string' || typeof obj === 'number') return new Date(obj);
      if (obj && typeof obj.toDate === 'function') return obj.toDate();
      if (typeof obj.seconds === 'number') return new Date(obj.seconds * 1000);
      if (typeof obj._seconds === 'number') return new Date(obj._seconds * 1000);
      return null;
    };
    const fmt = (v) => { const d = ts(v); return d ? d.toLocaleString() : "—"; };
    const fmtDate = (v) => { const d = ts(v); return d ? d.toLocaleDateString() : "—"; };
    const isNum = v => (typeof v === 'number' && !Number.isNaN(v));
    const fmtTime = (sec) => {
      if (sec == null) return "—";
      const s = Math.max(0, parseInt(sec, 10));
      const m = Math.floor(s / 60), ss = s % 60;
      return `${m}m ${ss}s`;
    };
    function isEssayQuestion(q) {
      if (!q) return false;
      if (q.isEssay === true) return true;
      if ((q.type || '').toLowerCase() === 'essay') return true;
      const choices = q.choices || {};
      const nonEmpty = Object.values(choices).filter(v => v && String(v).trim() !== '');
      return nonEmpty.length === 0;
    }
    function pickRubricUrl(obj) {
      if (!obj || typeof obj !== 'object') return '';
      if (obj.rubricFile && typeof obj.rubricFile === 'object') {
        const d = obj.rubricFile.downloadUrl;
        const p = obj.rubricFile.publicUrl;
        if (typeof d === 'string' && d.trim()) return d.trim();
        if (typeof p === 'string' && p.trim()) return p.trim();
      }
      const keys = ['rubricUrl', 'rubricURL', 'rubric', 'rubric_link', 'rubric_url', 'rubricLink'];
      for (const k of keys) { const v = obj[k]; if (typeof v === 'string' && v.trim()) return v.trim(); }
      return '';
    }
    const escapeHTML = (s = '') => String(s)
      .replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;').replaceAll("'", '&#039;');

    // Normalize server quiz shapes to a consistent model
    function normalizeQuiz(raw) {
      const q = { ...raw };

      // id
      q.id = q.id ?? q._id ?? q.quizId ?? q.uid ?? q.key;

      // courseId (flatten)
      q.courseId =
        q.courseId ??
        q.course_id ??
        q.courseID ??
        q.course?.id ??
        q.course?.courseId ??
        q.courseRef ??
        q.courseKey ??
        null;

      // moduleId
      q.moduleId =
        q.moduleId ??
        q.module_id ??
        q.moduleID ??
        q.module?.id ??
        q.module?.moduleId ??
        q.moduleRef ??
        q.moduleKey ??
        null;

      // assigned classes (various field names)
      let ac =
        q.assignedClasses ??
        q.assignedClassIds ??
        q.assigned ??
        q.classes ??
        q.classIds ??
        q.assigned_to ??
        [];
      if (!Array.isArray(ac)) {
        if (ac && typeof ac === 'object') ac = Object.values(ac);
        else ac = [];
      }
      q.assignedClasses = ac.filter(v => v !== null && v !== undefined).map(String);

      return q;
    }

    // Visibility logic for assignment + enrollment
    function isQuizVisibleToStudent(q) {
      const courseOk = q.courseId ? studentCourseIds.has(String(q.courseId)) : false;
      const arr = Array.isArray(q.assignedClasses) ? q.assignedClasses : [];

      if (arr.length === 0) {
        if (coursesLoadedOk && q.courseId) return courseOk;
        return true;
      }
      if (!classesLoadedOk) return false;
      for (const cid of arr) if (studentClassIds.has(String(cid))) return true;
      return false;
    }

    // ---------- Data loaders ----------
    async function loadCourses() {
      courseSelect.innerHTML = `<option value="">-- All Courses --</option>`;
      coursesById.clear();
      studentCourseIds.clear();
      coursesLoadedOk = false;

      const tryEndpoints = [
        `${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/courses?includeTeacher=true`,
        `${API_BASE}/students/${encodeURIComponent(userData.userId)}/courses`,
        `${API_BASE}/api/courses?studentId=${encodeURIComponent(userData.userId)}`
      ];

      for (const url of tryEndpoints) {
        try {
          const res = await fetch(url);
          if (!res.ok) continue;
          const js = await res.json();
          const list = Array.isArray(js?.courses) ? js.courses : (Array.isArray(js) ? js : []);
          if (!list.length) continue;

          list.forEach(c => {
            const cid = c?.id ?? c?.courseId ?? c?._id ?? c?.key;
            if (!cid) return;
            studentCourseIds.add(String(cid));
            coursesById.set(String(cid), c);

            const code = c.courseNumber ?? c.code ?? c.number ?? c.classCode ?? null;
            const title = c.title || "Untitled Course";
            const label = code ? `${code} — ${title}` : title;

            const opt = document.createElement("option");
            opt.value = String(cid);
            opt.textContent = label;
            courseSelect.appendChild(opt);
          });

          coursesLoadedOk = true;
          return;
        } catch {}
      }

      coursesLoadedOk = false;
    }

    async function loadModules(courseId) {
      moduleSelect.innerHTML = '<option value="">-- All Modules --</option>';
      moduleSelect.disabled = !courseId;
      if (!courseId) return;

      try {
        const res = await fetch(`${API_BASE}/courses/${encodeURIComponent(courseId)}/modules`);
        const js = await res.json();
        const modules = Array.isArray(js?.modules) ? js.modules : (Array.isArray(js) ? js : []);

        const map = new Map();
        modules.forEach(m => { const mid = m?.id ?? m?._id ?? m?.moduleId; if (mid) map.set(String(mid), m); });
        modulesByCourse.set(String(courseId), map);

        modules.sort((a, b) => (a.moduleNumber || 0) - (b.moduleNumber || 0));
        modules.forEach(m => {
          const mid = m?.id ?? m?._id ?? m?.moduleId;
          if (!mid) return;
          const label = (typeof m.moduleNumber === 'number')
            ? `Module ${m.moduleNumber}: ${m.title || "Untitled Module"}`
            : (m.title || "Untitled Module");

          const opt = document.createElement("option");
          opt.value = String(mid);
          opt.textContent = label;
          moduleSelect.appendChild(opt);
        });
      } catch (e) {
        console.warn("Modules fetch failed", e);
      }
    }

    async function ensureModulesForCourse(courseId) {
      if (!courseId || modulesByCourse.has(String(courseId))) return;
      try {
        const res = await fetch(`${API_BASE}/courses/${encodeURIComponent(courseId)}/modules`);
        const js = await res.json();
        const modules = Array.isArray(js?.modules) ? js.modules : (Array.isArray(js) ? js : []);
        const map = new Map();
        modules.forEach(m => { const mid = m?.id ?? m?._id ?? m?.moduleId; if (mid) map.set(String(mid), m); });
        modulesByCourse.set(String(courseId), map);
      } catch (e) {
        modulesByCourse.set(String(courseId), new Map());
      }
    }

    async function ensureModulesForCourses(courseIds) {
      const uniq = [...new Set(courseIds)].filter(Boolean);
      await Promise.all(uniq.map(ensureModulesForCourse));
    }

    async function loadStudentClasses() {
      classesLoadedOk = false;
      studentClassIds.clear();

      const tryEndpoints = [
        `${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/classes`,
        `${API_BASE}/classes?studentId=${encodeURIComponent(userData.userId)}`,
        `${API_BASE}/api/classes?studentId=${encodeURIComponent(userData.userId)}`
      ];

      for (const url of tryEndpoints) {
        try {
          const res = await fetch(url);
          if (!res.ok) continue;
          const js = await res.json();
          const list = Array.isArray(js?.classes) ? js.classes : (Array.isArray(js) ? js : []);
          list.forEach(c => {
            const id = c?.id ?? c?.classId ?? c?._id ?? c?.key;
            if (id) studentClassIds.add(String(id));
          });
          classesLoadedOk = true;
          return;
        } catch {}
      }
      classesLoadedOk = false;
    }

    async function loadQuizzes() {
      const uid = encodeURIComponent(userData.userId);
      const params = new URLSearchParams({ forStudent: uid });
      if (currentCourseId) params.set('courseId', currentCourseId);
      if (currentModuleId) params.set('moduleId', currentModuleId);

      const endpoints = [
        `${API_BASE}/api/students/${uid}/quizzes`,
        `${API_BASE}/quizzes?${params.toString()}`,
        `${API_BASE}/api/quizzes?${params.toString()}`,
        `${API_BASE}/quizzes`
      ];

      let raw = [];
      for (const url of endpoints) {
        try {
          const res = await fetch(url);
          if (!res.ok) continue;
          const js = await res.json();
          const list = (Array.isArray(js?.quizzes) ? js.quizzes
                      : Array.isArray(js?.data) ? js.data
                      : Array.isArray(js) ? js
                      : []);
          if (list.length) { raw = list; break; }
          if ('success' in js) { raw = list; break; }
        } catch {}
      }

      const normalized = raw.map(normalizeQuiz);
      allQuizzes = normalized.filter(isQuizVisibleToStudent);
    }

    function statusOf(quiz) {
      const now = Date.now();
      const openAt = ts(quiz.openAt) ? ts(quiz.openAt).getTime() : null;
      const dueAt = ts(quiz.dueAt) ? ts(quiz.dueAt).getTime() : null;
      if (openAt && now < openAt) return "Upcoming";
      if (dueAt && now > dueAt) return "Closed";
      return "Open";
    }

    async function ensureAttemptStatus(quizIds) {
      const missing = quizIds.filter(id => !attemptsCache.has(id));
      if (!missing.length) return;

      try {
        const params = new URLSearchParams();
        params.set('quizIds', missing.join(','));
        const res = await fetch(`${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/quiz-attempts?${params.toString()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const js = await res.json();
        const data = js?.data || {};
        Object.keys(data).forEach(qid => attemptsCache.set(qid, data[qid]));
      } catch {
        missing.forEach(qid => attemptsCache.set(qid, { used: 0, allowed: null, left: null, lock: false }));
      }
    }

    async function fetchQuizResults(quizId) {
      const url = `${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/quiz-results?quizId=${encodeURIComponent(quizId)}`;
      const res = await fetch(url);
      const text = await res.text();
      if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
      return normalizeResults(JSON.parse(text || '{}'));
    }

    function normalizeResults(js) {
      let raw = [];
      if (Array.isArray(js?.attempts)) raw = js.attempts;
      else if (Array.isArray(js?.results)) raw = js.results;
      else if (Array.isArray(js?.data)) raw = js.data;
      else if (Array.isArray(js)) raw = js;

      const attempts = raw.map((r, i) => {
        const toNum = v => (typeof v === 'number' && !Number.isNaN(v)) ? v : null;
        const isNum = v => (typeof v === 'number' && !Number.isNaN(v));

        const autoScore = toNum(r.autoScore) ?? toNum(r.scoreAuto) ?? null;
        const autoTotal = toNum(r.autoTotal) ?? toNum(r.totalAuto) ?? null;
        const autoPercent = toNum(r.autoPercent) ?? null;

        const gradedScore = toNum(r.gradedScore) ?? null;
        const gradedTotal = toNum(r.gradedTotal) ?? null;
        const gradedPercent = toNum(r.gradedPercent) ?? null;

        const score =
          toNum(r.score) ??
          gradedScore ??
          toNum(r.lastScore?.score) ??
          autoScore ?? null;

        const total =
          toNum(r.total) ??
          gradedTotal ??
          toNum(r.lastScore?.total) ??
          autoTotal ?? null;

        const percent =
          toNum(r.percent) ??
          gradedPercent ??
          autoPercent ??
          (isNum(score) && isNum(total) && total > 0 ? Math.round((score / total) * 100) : null);

        const tsObj = r.submittedAt ?? r.createdAt ?? r.timestamp ?? null;

        return {
          n: r.attempt ?? r.n ?? (i + 1),
          submittedAt: tsObj,
          timeTakenSeconds: r.timeTakenSeconds ?? r.durationSeconds ?? r.time ?? null,
          reason: r.reason || 'manual',
          score: isNum(score) ? score : null,
          total: isNum(total) ? total : null,
          percent: isNum(percent) ? percent : null,

          autoScore, autoTotal, autoPercent,
          gradedScore, gradedTotal, gradedPercent
        };
      });

      let latest = attempts.length ? attempts[attempts.length - 1] : null;
      let best = null;
      attempts.forEach(a => {
        if (typeof a.percent === 'number') {
          if (!best || a.percent > best.percent) best = a;
        }
      });

      if (!best && typeof js?.bestPercent === 'number') {
        best = {
          n: '-',
          submittedAt: null,
          score: (js?.lastScore?.score ?? null),
          total: (js?.lastScore?.total ?? null),
          percent: js.bestPercent
        };
      }
      if (!latest && js?.lastScore) {
        latest = {
          n: '-',
          submittedAt: null,
          score: (js.lastScore.score ?? null),
          total: (js.lastScore.total ?? null),
          percent: (typeof js.lastScore.percent === 'number' ? js.lastScore.percent : null)
        };
      }

      return { attempts, best, latest };
    }

    const rubricStorageByQuizId = new Map();
    function computeRubricButtonBits(quiz) {
      const direct = pickRubricUrl(quiz) || pickRubricUrl(quiz?.settings || {});
      if (direct) return { type: 'direct', url: direct };
      const sp = quiz?.rubricFile?.storagePath || quiz?.storagePath || '';
      if (sp) {
        rubricStorageByQuizId.set(String(quiz.id), sp);
        return { type: 'indirect', url: '' };
      }
      return { type: 'none', url: '' };
    }

    async function openRubricForQuiz(quizId) {
      const sp = rubricStorageByQuizId.get(String(quizId));
      if (!sp) return;
      try {
        const res = await fetch(`${API_BASE}/storage/token-url?path=${encodeURIComponent(sp)}`);
        const js = await res.json();
        const url = js?.url;
        if (url) window.open(url, '_blank', 'noopener');
        else alert('Could not open rubric.');
      } catch {
        alert('Could not open rubric.');
      }
    }

    // ---------- Render ----------
    function refreshStatusPills(list) {
      const counts = { Open: 0, Upcoming: 0, Closed: 0 };
      (list || []).forEach(q => counts[statusOf(q)]++);
      if (elCountOpen) elCountOpen.textContent = counts.Open || 0;
      if (elCountUpcoming) elCountUpcoming.textContent = counts.Upcoming || 0;
      if (elCountClosed) elCountClosed.textContent = counts.Closed || 0;
    }

    async function renderQuizzes() {
      quizCards.innerHTML = "";
      errorState.classList.add("d-none");

      let list = allQuizzes.slice();

      if (currentCourseId) list = list.filter(qz => String(qz.courseId) === String(currentCourseId));
      if (currentModuleId) list = list.filter(qz => String(qz.moduleId) === String(currentModuleId));

      const q = (quizSearch.value || "").toLowerCase();
      if (q) {
        list = list.filter(qz =>
          (qz.title || "").toLowerCase().includes(q) ||
          (qz.description || "").toLowerCase().includes(q)
        );
      }

      const st = statusFilter.value;
      if (st !== "All") list = list.filter(qz => statusOf(qz) === st);

      if (sortBy.value === "az") {
        list.sort((a, b) => (a.title || "").localeCompare(b.title || ""));
      } else if (sortBy.value === "duration") {
        const numVal = (v, d = 0) => (typeof v === 'number' && !isNaN(v)) ? v : d;
        list.sort((a, b) => {
          const ad = a.settings?.timerEnabled ? a.settings.durationMinutes : a.durationMinutes;
          const bd = b.settings?.timerEnabled ? b.settings.durationMinutes : b.durationMinutes;
          return numVal(ad) - numVal(bd);
        });
      } else {
        list.sort((a, b) => {
          const ad = ts(a.dueAt) ? ts(a.dueAt).getTime() : Number.POSITIVE_INFINITY;
          const bd = ts(b.dueAt) ? ts(b.dueAt).getTime() : Number.POSITIVE_INFINITY;
          return ad - bd;
        });
      }

      refreshStatusPills(list);

      if (!list.length) {
        emptyState.classList.remove("d-none");
        emptyState.textContent = "No quizzes found.";
        return;
      } else {
        emptyState.classList.add("d-none");
      }

      const listCourseIds = list.map(q => q.courseId);
      await ensureModulesForCourses(listCourseIds);

      await ensureAttemptStatus(list.map(q => q.id));

      list.forEach(quiz => {
        const created = ts(quiz.createdAt);
        const due = ts(quiz.dueAt);
        const status = statusOf(quiz);
        const qs = Array.isArray(quiz.questions) ? quiz.questions.length
          : (quiz.totalQuestions || quiz.questionCount || 0);

        const dur = (quiz.settings?.timerEnabled && isNum(quiz.settings.durationMinutes))
          ? quiz.settings.durationMinutes
          : (isNum(quiz.durationMinutes) ? quiz.durationMinutes : null);

        const diff = quiz.difficulty || "—";

        const course = coursesById.get(String(quiz.courseId));
        const courseCode = course?.courseNumber ?? course?.code ?? course?.number ?? course?.classCode ?? null;
        const courseTitle = course?.title || quiz.courseTitle || quiz.courseName || "Untitled Course";
        const courseLabel = courseCode ? `${courseCode} — ${courseTitle}` : courseTitle;

        const modMap = modulesByCourse.get(String(quiz.courseId));
        const mod = modMap ? modMap.get(String(quiz.moduleId)) : null;
        const moduleTitle = mod?.title || quiz.moduleTitle || quiz.moduleName || "Untitled Module";
        const moduleLabel = (typeof mod?.moduleNumber === 'number')
          ? `Module ${mod.moduleNumber} • ${moduleTitle}`
          : moduleTitle;

        const allowed = quiz.attemptsAllowed ?? null;
        const aStat = attemptsCache.get(quiz.id) || { used: 0, allowed, left: null, lock: false };
        const effAllowed = (aStat.allowed === undefined) ? allowed : aStat.allowed;
        const used = aStat.used ?? 0;
        const left = (effAllowed == null) ? null : Math.max(0, (aStat.left ?? (effAllowed - used)));
        const locked = (effAllowed != null) && (left === 0);

        const attemptsLabel = (effAllowed == null)
          ? "Unlimited attempts"
          : `Attempts: ${used}/${effAllowed}`;

        const hasAutoQuestions = Array.isArray(quiz.questions) && quiz.questions.some(q => !isEssayQuestion(q));
        const essayOnly = Array.isArray(quiz.questions) && quiz.questions.length > 0 && !hasAutoQuestions;

        let rubricBtn = '';
        const directRubric = pickRubricUrl(quiz) || pickRubricUrl(quiz?.settings || {});
        if (directRubric) {
          const safeUrl = String(directRubric).replace(/"/g, '&quot;');
          rubricBtn = `<a class="btn btn-sm btn-outline-info" href="${safeUrl}" target="_blank" rel="noopener" title="View Rubric">
                          <i class="bi bi-file-earmark-text"></i> Show Rubric
                       </a>`;
        } else {
          const sp = quiz?.rubricFile?.storagePath || quiz?.storagePath || '';
          if (sp) {
            rubricStorageByQuizId.set(String(quiz.id), sp);
            rubricBtn = `<button class="btn btn-sm btn-outline-info" data-action="rubric" data-quiz-id="${String(quiz.id)}" title="View Rubric">
                          <i class="bi bi-file-earmark-text"></i> Show Rubric
                         </button>`;
          }
        }

        const coursePill = `
          <span class="pill pill-course" title="${escapeHTML(courseLabel)}">
            <i class="bi bi-collection"></i>
            <span class="pill-text">${escapeHTML(courseLabel)}</span>
          </span>`;

        const modulePill = `
          <span class="pill pill-module" title="${escapeHTML(moduleLabel)}">
            <i class="bi bi-box"></i>
            <span class="pill-text">${escapeHTML(moduleLabel)}</span>
          </span>`;

        const startDisabledReason = (status !== 'Open') ? (status === 'Upcoming' ? 'Not open yet' : 'Closed') : (locked ? 'No attempts left' : '');
        const startDisabled = Boolean(startDisabledReason);
        const startHref = startDisabled ? '#' : `/STUDENT/quiz/view_quiz.html?id=${encodeURIComponent(quiz.id)}`;
        const startBtnClass = startDisabled ? 'btn btn-sm btn-outline-secondary disabled' : 'btn btn-sm btn-amber';
        const startTitle = startDisabledReason || 'See details, rubric, and start';

        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-xl-4";
        col.innerHTML = `
  <div class="quiz-card h-100 d-flex flex-column">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h3 class="quiz-title mb-1">${escapeHTML(quiz.title || "Untitled Quiz")}</h3>
        <div class="quiz-meta">
          Created: ${created ? fmtDate(created) : "—"} • Status:
          <span class="badge ${status === 'Open' ? 'text-bg-success' : status === 'Upcoming' ? 'text-bg-info' : 'text-bg-secondary'}">${status}</span>
          ${locked ? `<span class="badge text-bg-danger ms-1">Max attempts</span>` : ""}
          ${essayOnly ? `<span class="badge text-bg-warning ms-1">Essay-only</span>` : ``}
        </div>
      </div>
      <span class="badge-soft"><i class="bi bi-bar-chart"></i>${escapeHTML(diff)}</span>
    </div>

    <div class="mt-2 mb-1 d-flex flex-wrap gap-1">
      ${coursePill}
      ${modulePill}
    </div>

    <div class="d-flex flex-wrap gap-2 mt-1 mb-2">
      <span class="badge-soft"><i class="bi bi-list-ol"></i> ${qs} questions</span>
      <span class="badge-soft"><i class="bi bi-stopwatch"></i> ${dur ?? "—"} min</span>
      <span class="badge-soft"><i class="bi bi-repeat"></i> ${attemptsLabel}</span>
      <span class="badge-soft"><i class="bi bi-calendar-event"></i> Due: ${due ? fmtDate(due) : "—"}</span>
    </div>

    <div class="desc mb-3" title="${escapeHTML(quiz.description || '')}">
      ${escapeHTML(quiz.description || '')}
    </div>

    <div class="mt-auto d-flex justify-content-end gap-2">
      <button class="btn btn-sm btn-outline-primary"
              data-action="view-score"
              data-quiz-id="${quiz.id}"
              data-quiz-title="${(quiz.title || '').replace(/"/g, '&quot;')}">
        <i class="bi bi-graph-up"></i> View Score
      </button>

      <a class="${startBtnClass}"
         href="${startHref}"
         ${startDisabled ? 'aria-disabled="true"' : ''}
         title="${startTitle}">
         Start
      </a>

      ${rubricBtn}
    </div>

    <div class="mt-2 small text-muted">
      Timed quizzes auto-submit when time is up.
      ${essayOnly ? '<br>Scores for this quiz will appear after your essay is graded.' : ''}
    </div>
  </div>
`;
        quizCards.appendChild(col);
      });
    }

    // ---------- Events ----------
    courseSelect.addEventListener("change", async function () {
      currentCourseId = this.value;
      currentModuleId = "";
      moduleSelect.value = "";
      await loadModules(currentCourseId);
      await loadQuizzes();
      renderQuizzes();
    });

    moduleSelect.addEventListener("change", async function () {
      currentModuleId = this.value;
      await loadQuizzes();
      renderQuizzes();
    });

    quizSearch.addEventListener("input", () => renderQuizzes());
    statusFilter.addEventListener("change", () => renderQuizzes());
    sortBy.addEventListener("change", () => renderQuizzes());

    quizCards.addEventListener('click', async (e) => {
      const rubricBtn = e.target.closest('[data-action="rubric"]');
      if (rubricBtn) {
        const qid = rubricBtn.getAttribute('data-quiz-id');
        if (qid) openRubricForQuiz(qid);
        return;
      }

      const btn = e.target.closest('[data-action="view-score"]');
      if (!btn) return;

      const quizId = btn.getAttribute('data-quiz-id');
      const title = btn.getAttribute('data-quiz-title') || 'Quiz Results';

      document.getElementById('scoreModalLabel').textContent = title;
      document.getElementById('scoreLoading').classList.remove('d-none');
      document.getElementById('scoreEmpty').classList.add('d-none');
      document.getElementById('scoreError').classList.add('d-none');
      document.getElementById('scoreContent').classList.add('d-none');
      document.getElementById('attemptsTbody').innerHTML = '';
      document.getElementById('bestScore').textContent = '—';
      document.getElementById('latestScore').textContent = '—';
      document.getElementById('attemptCount').textContent = '0';

      const scoreModal = new bootstrap.Modal(document.getElementById('scoreModal'));
      scoreModal.show();

      try {
        const res = await fetchQuizResults(quizId);
        document.getElementById('scoreLoading').classList.add('d-none');

        if (!res.attempts || res.attempts.length === 0) {
          document.getElementById('scoreEmpty').classList.remove('d-none');
          return;
        }

        const isNum = v => (typeof v === 'number' && !Number.isNaN(v));
        if (isNum(res.best?.percent)) document.getElementById('bestScore').textContent = `${res.best.percent}%`;
        if (isNum(res.latest?.percent)) document.getElementById('latestScore').textContent = `${res.latest.percent}%`;
        document.getElementById('attemptCount').textContent = String(res.attempts.length);

        const attemptsSorted = [...res.attempts].sort((a, b) => {
          const tA = ts(a.submittedAt)?.getTime() ?? 0;
          const tB = ts(b.submittedAt)?.getTime() ?? 0;
          return tB - tA;
        });

        const rowsHtml = attemptsSorted.map(a => {
          const hasAuto = (a.autoTotal != null && a.autoTotal > 0);
          const hasGraded = (a.gradedTotal != null && a.gradedTotal > 0);

          let score, total;
          if (hasAuto || hasGraded) {
            const autoScore = (a.autoScore ?? 0);
            const gradedScore = (a.gradedScore ?? 0);
            const autoTotal = (hasAuto ? a.autoTotal : 0);
            const gradedTotal = (hasGraded ? a.gradedTotal : 0);
            score = autoScore + gradedScore;
            total = autoTotal + gradedTotal;
          } else if (typeof a.score === 'number' && typeof a.total === 'number') {
            score = a.score;
            total = a.total;
          } else {
            score = null;
            total = null;
          }

          const scoreCell = (score != null && total != null) ? `${score}/${total}` : '—';

          return `
            <tr>
              <td>${a.n ?? ''}</td>
              <td>${fmt(a.submittedAt)}</td>
              <td>${scoreCell}</td>
              <td>${typeof a.percent === 'number' ? `${a.percent}%` : '—'}</td>
              <td>${fmtTime(a.timeTakenSeconds)}</td>
            </tr>`;
        }).join('');

        document.getElementById('attemptsTbody').innerHTML = rowsHtml;
        document.getElementById('scoreContent').classList.remove('d-none');
      } catch (err) {
        console.error(err);
        document.getElementById('scoreLoading').classList.add('d-none');
        document.getElementById('scoreError').classList.remove('d-none');
      }
    });

    // ---------- Boot ----------
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await loadCourses();
        await loadStudentClasses();
        await loadQuizzes();
        renderQuizzes();

        if (!quizCards.children.length && allQuizzes.length === 0) {
          await loadQuizzes();
          renderQuizzes();
        }
      } catch {
        errorState.classList.remove("d-none");
      }
    });
  </script>

  <!-- Small-screen tweak -->
  <style>
    @media (max-width: 768px) {
      .form-select,
      .form-control {
        text-align: center;
      }
    }
  </style>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function logoutUser() {
      localStorage.clear(); sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>
</body>

</html>
