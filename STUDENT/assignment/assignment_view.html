<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EduConnect Student ‚Äì Assignment</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Keep your theme -->
  <link rel="stylesheet" href="../assignment/assignment.css" />

  <style>
    :root {
      --bg: #f6f8fa;
      --text: #1f2328;
      --muted: #6a737d;
      --card: #fff;
      --border: #e5e7eb;
      --brand-dark-1: #4A1A0C;
      --brand-dark-2: #7A2810;
      --brand-accent-1: #FF6A00;
      --brand-accent-2: #B03C10;
      --card-radius: 14px;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text) }
    .dashboard { display: flex; min-height: 100vh }
    .main { margin-left: 70px; width: calc(100% - 70px); transition: margin-left .3s ease, width .3s ease; display: flex; flex-direction: column; min-height: 100vh; background: var(--bg) }
    .sidebar:hover~.main { margin-left: 220px; width: calc(100% - 220px) }

    .header-top { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: linear-gradient(to bottom, #4A1A0C, #7A2810); color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,.1); position: sticky; top: 0; z-index: 10; }
    .logo-header { height: 45px }
    .search-box { position: relative; flex: 1; max-width: 500px; margin: 0 20px }
    .search-box input { width: 100%; padding: 10px 14px; border-radius: 30px; border: none; outline: none }
    .search-box i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999 }
    .profile-btn { background:none; border:none; font-size:1.8rem; color:#fff; cursor:pointer; display:flex; align-items:center; gap:8px }

    .content { padding: 24px }
    .page-title { font-weight: 700; font-size: 1.6rem; margin: 0 0 10px; text-align: left }
    .brand-grad { background: linear-gradient(90deg, var(--brand-dark-1), var(--brand-dark-2)); -webkit-background-clip: text; background-clip: text; color: transparent }

    .ui-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--card-radius); padding: 16px; box-shadow: 0 10px 24px rgba(0,0,0,.10) }
    .muted { color: var(--muted) }
    .badge-soft { display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(176,60,16,.25); border-radius:999px; padding:2px 8px; font-size:.75rem; color:var(--brand-accent-2); background:linear-gradient(90deg, rgba(255,106,0,.12), rgba(176,60,16,.12)) }

    .btn-amber { background:linear-gradient(to bottom, var(--brand-accent-1), var(--brand-accent-2)); color:#fff; border:none }
    .btn-amber:hover { filter:brightness(1.05); color:#fff }
    .btn-amber-outline { background:#fff; color:var(--brand-accent-2); border:1px solid var(--brand-accent-2) }
    .btn-amber-outline:hover { background:linear-gradient(to bottom, var(--brand-accent-1), var(--brand-accent-2)); color:#fff; border-color:transparent }
    .form-control:focus, .form-select:focus { border-color: var(--brand-accent-2); box-shadow: 0 0 0 .2rem rgba(255,106,0,.18) }

    .attachment-list a { text-decoration: none }
    .small-label { font-size: .9rem; color: var(--muted) }

    .file-list { display:flex; flex-direction:column; gap:8px }
    .file-pill { border:1px dashed var(--border); border-radius:10px; padding:10px; background:#fff; display:flex; justify-content:space-between; align-items:center }
    .file-pill.bad { border-color:#fca5a5; background:#fff5f5 }
    .file-pill .size { color:var(--muted); font-size:.85rem }
    .file-pill .warn { color:#b91c1c; font-weight:600; font-size:.85rem }

    .disabled { opacity:.7; pointer-events:none }

    .meta-row { display:flex; flex-wrap:wrap; gap:10px }
    .meta-item { display:flex; flex-direction:column; padding:.5rem .75rem; border:1px solid var(--border); border-radius:10px; background:#fff; min-width:140px }
    .meta-label { font-size:.75rem; color:var(--muted) }
    .meta-value { font-weight:600 }

    .rubric-box { border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff }
    .rubric-title { font-weight:600; display:flex; align-items:center; gap:8px }
    .rubric-item { display:flex; align-items:center; gap:8px; padding:6px 0 }

    .wrap-anywhere { overflow-wrap:anywhere; word-break:break-word; line-break:anywhere; }
    #assignContent { white-space:pre-wrap; }

    .attachment-list, .attachment-list a, #submissionNote .p-2, #submissionFiles, #submissionGrade, #submissionStatusBadge, #submissionTime { overflow-wrap:anywhere; word-break:break-word; }

    /* ===== Full-screen-ish Preview Modal ===== */
    #filePreviewModal .modal-dialog { max-width: 96vw; }
    #filePreviewModal .modal-content { height: 92vh; display: flex; flex-direction: column; }
    #filePreviewModal .modal-body { flex: 1 1 auto; padding: 0; background: #f8fafc; position: relative; }
    .preview-wrap { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .preview-wrap iframe, .preview-wrap embed, .preview-wrap object, .preview-wrap img, .preview-wrap video, .preview-wrap audio { width: 100%; height: 100%; border: 0; object-fit: contain; background: #fff; }
    .preview-fallback { max-width: 720px; margin: 0 auto; padding: 2rem; text-align: center; }
    #filePreviewFooter { display: flex; gap: .5rem; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .spinner-wrap { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #ffffff; }
  </style>
</head>

<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" placeholder="Search‚Ä¶" />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username"></span>
        </button>
      </header>

      <div class="content container-fluid">
        <nav aria-label="breadcrumb" class="mb-2">
          <ol class="breadcrumb wrap-anywhere">
            <li class="breadcrumb-item"><a href="/STUDENT/assignment/assignment.html">Assignments</a></li>
            <li class="breadcrumb-item active" id="bcTitle" aria-current="page">Loading‚Ä¶</li>
          </ol>
        </nav>

        <h1 class="page-title"><span class="brand-grad wrap-anywhere" id="pageTitle">Assignment</span></h1>
        <div class="ui-card mb-3">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div class="wrap-anywhere">
              <div class="badge-soft mb-2" id="courseBadge"><i class="bi bi-journal-text"></i> Course</div>
              <h4 id="assignTitle" class="mb-1">Loading‚Ä¶</h4>
              <div class="small-label">
                <span id="moduleLine"></span>
                <span id="pointsLine"></span>
              </div>
            </div>
            <div class="meta-row">
              <div class="meta-item">
                <span class="meta-label">Due</span>
                <span class="meta-value" id="dueAt">‚Äî</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Status</span>
                <span class="meta-value" id="statusPill">‚Äî</span>
              </div>
            </div>
          </div>
          <hr class="my-3" />
          <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>Instructions</h6>
          <div id="assignContent" class="wrap-anywhere">Loading content‚Ä¶</div>

          <div id="attachmentsWrap" class="mt-3 wrap-anywhere"></div>
        </div>

        <!-- Submission -->
        <div class="ui-card mb-3">
          <h5 class="mb-2"><i class="bi bi-upload me-2"></i>Submit Your Work</h5>
          <p class="small-label mb-2">
            Upload file(s) and/or add a brief note (you may paste a link inside your note).
          </p>
          <div class="small text-muted mb-3">
            <i class="bi bi-info-circle me-1"></i>
            Per-file limit: <strong>100&nbsp;MB</strong>. If a file is too large, compress it (PDF/ZIP) or split into parts.
          </div>

          <form id="submitForm" class="d-grid gap-3" novalidate>
            <div>
              <label class="form-label">File(s)</label>
              <input class="form-control" type="file" id="fileInput" name="files" multiple />
              <div id="fileHint" class="form-text">Supported: documents, images, PDFs, etc.</div>
              <div id="filePreview" class="file-list mt-2 wrap-anywhere"></div>
            </div>

            <div>
              <label class="form-label">Note (optional)</label>
              <textarea class="form-control wrap-anywhere" id="noteInput" name="text" rows="3" placeholder="e.g., 'Please see attached. https://‚Ä¶'"></textarea>
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button id="submitBtn" type="submit" class="btn btn-amber">
                <i class="bi bi-send me-1"></i> Submit
              </button>
              <a href="/STUDENT/assignment/assignment.html" class="btn btn-amber-outline">
                <i class="bi bi-arrow-left me-1"></i> Back to Assignments
              </a>
              <div id="submitStatus" class="small-label ms-auto wrap-anywhere"></div>
            </div>
          </form>

          <div id="alreadySubmitted" class="alert alert-info py-2 px-3 d-none mt-3 wrap-anywhere" role="alert" style="border:1px solid #b6d4fe;">
            <i class="bi bi-info-circle me-1"></i> You have already submitted this assignment. Resubmission is disabled.
          </div>
        </div>

        <!-- Your Submission -->
        <div id="submissionSummary" class="ui-card d-none">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-file-check me-2"></i>Your Submission</h5>
            <span id="submissionTime" class="small-label wrap-anywhere"></span>
          </div>
          <div id="submissionStatusBadge" class="mt-2 wrap-anywhere"></div>
          <div id="submissionFiles" class="mt-2 wrap-anywhere"></div>
          <div id="submissionNote" class="mt-2 wrap-anywhere"></div>
          <div id="submissionGrade" class="mt-2 wrap-anywhere"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-screen-ish File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview‚Ä¶</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>

        <div class="modal-footer" id="filePreviewFooter">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto">
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-amber">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Page Logic -->
  <script>
    // ====== Config ======
    const API_BASE = "http://localhost:5000";
    const STUDENT_MAX_MB = 100;
    const STUDENT_MAX_BYTES = STUDENT_MAX_MB * 1024 * 1024;

    // ====== Auth guard ======
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    if (!userData?.userId || !userData?.isStudent) {
      window.location.href = "/STUDENT/login/login.html";
    }

    // Header initials
    function initialsFrom(str) {
      if (!str) return "";
      const s = String(str).trim();
      if (!s) return "";
      if (s.includes("@")) {
        const local = s.split("@")[0];
        const parts = local.split(/[.\-_]+/).filter(Boolean);
        return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : local.slice(0,2)).toUpperCase();
      }
      const parts = s.split(/[\s\-]+/).filter(Boolean);
      return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : parts[0].slice(0,2)).toUpperCase();
    }
    (() => {
      const el = document.getElementById("Username");
      if (!el) return;
      const displayName = userData.fullName || userData.username || userData.email || "";
      const initials = initialsFrom(displayName) || "?";
      el.textContent = initials;
      el.title = displayName;
      el.setAttribute("aria-label", displayName);
    })();

    // ====== Helpers ======
    const qs = new URLSearchParams(location.search);
    const assignmentId = qs.get("id");

    const escapeHTML = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'",'&#039;');

    function softWrap(s, limit = 40) {
      if (!s) return s;
      return String(s).replace(new RegExp(`([^\\s]{${limit}})`, 'g'), '$1\u200B');
    }
    const fmtDateTime = (ms) => {
      if (!ms) return '‚Äî';
      try { return new Date(ms).toLocaleString(); } catch { return '‚Äî'; }
    };
    function toApiUrl(pathOrUrl){
      return /^https?:\/\//i.test(String(pathOrUrl)) ? String(pathOrUrl) : API_BASE + String(pathOrUrl || "");
    }
    function bytesKB(b){ return Math.round((b || 0)/102.4)/10; } // 1 decimal
    function human(bytes){
      if (!Number.isFinite(bytes)) return '';
      const mb = bytes / (1024 * 1024);
      return mb >= 1024 ? (mb/1024).toFixed(2) + ' GB' : mb.toFixed(1) + ' MB';
    }
    function tsToMs(v){
      if (v == null) return null;
      if (typeof v === 'object'){
        if (typeof v.toMillis === 'function') return v.toMillis();
        if (typeof v._seconds === 'number') return v._seconds * 1000;
      }
      const n = Number(v);
      if (!Number.isNaN(n) && n > 1e9) return n;
      const d = new Date(v);
      return Number.isNaN(d.getTime()) ? null : d.getTime();
    }

    // Cloud-safe URL pickers
    function pickHref(obj = {}) {
      return obj.downloadUrl || obj.publicUrl || obj.previewUrl ||
             (obj.url && /^https?:\/\//i.test(obj.url) ? obj.url : '') ||
             (obj.filePath ? toApiUrl(obj.filePath) : '');
    }
    function pickName(obj = {}) {
      const fromPath = (obj.storagePath || obj.filePath || '').split('/').pop();
      const fromUrl  = (obj.url || '').split('/').pop();
      return obj.originalName || fromPath || fromUrl || 'file';
    }
    function isRubricAttachment(obj = {}) {
      if (obj.type && String(obj.type).toLowerCase() === 'rubrics') return true;
      const n = (obj.originalName || '').toLowerCase();
      return /rubric/.test(n);
    }
    // Extract Storage path for signing
    function extractStoragePath(obj = {}) {
      if (obj.storagePath) return String(obj.storagePath);
      if (obj.gsUri && obj.gsUri.startsWith('gs://')) {
        const parts = obj.gsUri.replace('gs://','').split('/'); parts.shift(); return parts.join('/');
      }
      if (obj.publicUrl && /storage\.googleapis\.com/i.test(obj.publicUrl)) {
        try { const u = new URL(obj.publicUrl); const parts = u.pathname.replace(/^\/+/, '').split('/'); parts.shift(); return parts.join('/'); } catch {}
      }
      if (obj.downloadUrl && /firebasestorage\.googleapis\.com/i.test(obj.downloadUrl)) {
        try { const u = new URL(obj.downloadUrl); if (u.pathname.includes('/o/')) { const enc = u.pathname.split('/o/')[1]; return decodeURIComponent(enc); } } catch {}
      }
      return '';
    }

    // ====== MODAL PREVIEW HELPERS ======
    function isYouTubeUrl(url = '') {
      try {
        const u = new URL(url);
        const h = u.hostname.replace(/^www\./, '').toLowerCase();
        return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);
      } catch { return false; }
    }
    function toYouTubeEmbed(url=''){
      try{
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./,'').toLowerCase();
        let id = '';
        let start = u.searchParams.get('start') || u.searchParams.get('t') || '';
        if (start && /^\d+s$/.test(start)) start = parseInt(start,10);
        if (start && /^\d+$/.test(start)) start = parseInt(start,10);
        if (!Number.isFinite(start)) start = '';
        if (host === 'youtu.be'){ id = (u.pathname || '').replace(/^\//,'').split('/')[0]; }
        else { if (u.pathname.startsWith('/embed/')) id = u.pathname.split('/')[2] || ''; if (!id) id = u.searchParams.get('v') || ''; }
        if (!id) return null;
        const base = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;
        const qs = new URLSearchParams(); qs.set('rel','0'); if (start) qs.set('start', String(start));
        return `${base}?${qs.toString()}`;
      }catch{ return null; }
    }
    function getExtFromUrl(url=''){ const clean = String(url).split('?')[0].split('#')[0]; const parts = clean.split('.'); return parts.length>1 ? parts.pop().toLowerCase() : ''; }
    function kindFromUrl(url){
      if (isYouTubeUrl(url)) return 'youtube';
      const ext = getExtFromUrl(url);
      if (['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
      if (['mp3','wav','m4a','ogg','aac','flac'].includes(ext)) return 'audio';
      if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
      if (ext==='pdf') return 'pdf';
      if (['txt','csv','log'].includes(ext)) return 'text';
      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
      return 'other';
    }
    function setFileInfoUI(kind, url) {
      const info = document.getElementById('fileInfoText');
      const hdr  = document.getElementById('filePreviewModalLabel');
      const badgeId = 'fileKindBadge';
      const labelMap = { youtube:'YouTube', video:'Video', audio:'Audio', image:'Image', pdf:'PDF', text:'Text/CSV', office:'Office Doc', other:'File' };
      const colorMap = {
        youtube:'bg-danger-subtle text-danger', video:'bg-danger-subtle text-danger',
        audio:'bg-secondary-subtle text-secondary', image:'bg-success-subtle text-success',
        pdf:'bg-primary-subtle text-primary', text:'bg-info-subtle text-info',
        office:'bg-warning-subtle text-warning', other:'bg-dark-subtle text-dark'
      };
      let badge = document.getElementById(badgeId);
      if (!badge){ badge = document.createElement('span'); badge.id = badgeId; badge.className = 'ms-2 badge rounded-pill'; hdr.appendChild(badge); }
      badge.className = 'ms-2 badge rounded-pill ' + (colorMap[kind] || colorMap.other);
      badge.textContent = labelMap[kind] || 'File';
      info.innerHTML = `<span class="text-muted">Type:</span> <strong>${labelMap[kind] || 'File'}</strong>`;
      document.getElementById('openInNewTabBtn').href = url || '#';
    }
    function showSpinner(show) { document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }
    function renderFilePreviewInto(container, url) {
      container.innerHTML = '';
      showSpinner(true);
      const done = () => showSpinner(false);
      const kind = kindFromUrl(url);

      if (kind === 'youtube') {
        const embed = toYouTubeEmbed(url);
        if (embed) {
          container.innerHTML = `
            <div class="ratio ratio-16x9">
              <iframe
                src="${embed}"
                title="YouTube video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
                style="border:0"></iframe>
            </div>`;
          done(); return;
        }
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Couldn‚Äôt embed this YouTube link.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
        done(); return;
      }

      const ext = getExtFromUrl(url);

      if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) {
        const img = new Image();
        img.onload = done;
        img.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Image preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
          done();
        };
        img.src = url;
        container.appendChild(img);
        return;
      }

      if (ext === 'pdf') {
        const iframe = document.createElement('iframe');
        iframe.title = 'PDF preview';
        iframe.onload = done;
        iframe.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">PDF preview failed (viewer blocked or CORS).</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
          done();
        };
        iframe.src = url;
        container.appendChild(iframe);
        return;
      }

      if (['mp4','webm','ogg'].includes(ext)) {
        const video = document.createElement('video');
        video.controls = true;
        video.onloadeddata = done;
        video.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Video preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
          done();
        };
        video.src = url;
        container.appendChild(video);
        return;
      }

      if (['mp3','wav','m4a','ogg'].includes(ext)) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.onloadeddata = done;
        audio.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Audio preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
          done();
        };
        audio.src = url;
        container.appendChild(audio);
        return;
      }

      if (['txt','csv','log'].includes(ext)) {
        const iframe = document.createElement('iframe');
        iframe.onload = done;
        iframe.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Text preview failed.</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
          done();
        };
        iframe.src = url;
        container.appendChild(iframe);
        return;
      }

      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) {
        const gview = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;
        const iframe = document.createElement('iframe');
        iframe.title = 'Document preview';
        iframe.onload = done;
        iframe.onerror = () => {
          container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Office preview failed (Google Viewer blocked or CORS).</div>
            <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
          done();
        };
        iframe.src = gview;
        container.appendChild(iframe);
        return;
      }

      const obj = document.createElement('object');
      obj.data = url;
      obj.type = 'application/octet-stream';
      obj.onload = done;
      obj.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">This file type cannot be previewed here.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab</a></div>`;
        done();
      };
      container.appendChild(obj);
      setTimeout(done, 1200);
    }

    async function getSignedViewUrlIfNeeded(obj) {
      const direct = pickHref(obj);
      if (direct && /firebasestorage\.googleapis\.com\/v0\/b\//i.test(direct)) return direct;
      const storagePath = extractStoragePath(obj);
      if (!storagePath) return direct || null;
      try {
        const r = await fetch(`${API_BASE}/api/attachments/signed?path=${encodeURIComponent(storagePath)}`);
        const js = await r.json().catch(()=>null);
        if (r.ok && js?.success && js?.url) return js.url;
      } catch {}
      return direct || null;
    }

    // ====== DOM ======
    const bcTitle = document.getElementById("bcTitle");
    const pageTitle = document.getElementById("pageTitle");
    const courseBadge = document.getElementById("courseBadge");
    const assignTitle = document.getElementById("assignTitle");
    const moduleLine = document.getElementById("moduleLine");
    const pointsLine = document.getElementById("pointsLine");
    const dueAtEl = document.getElementById("dueAt");
    const assignContent = document.getElementById("assignContent");
    const attachmentsWrap = document.getElementById("attachmentsWrap");

    const submitForm = document.getElementById("submitForm");
    const submitBtn = document.getElementById("submitBtn");
    const submitStatus = document.getElementById("submitStatus");
    const noteInput = document.getElementById("noteInput");
    const fileInput = document.getElementById("fileInput");
    const fileHint = document.getElementById("fileHint");
    const filePreview = document.getElementById("filePreview");
    const alreadySubmitted = document.getElementById("alreadySubmitted");
    const statusPill = document.getElementById("statusPill");

    const submissionSummary = document.getElementById("submissionSummary");
    const submissionTime = document.getElementById("submissionTime");
    const submissionStatusBadge = document.getElementById("submissionStatusBadge");
    const submissionFiles = document.getElementById("submissionFiles");
    const submissionNote = document.getElementById("submissionNote");
    const submissionGrade = document.getElementById("submissionGrade");

    // ====== Status ======
    let currentStatus = 'Open';

    // ====== Data fetchers ======
    async function fetchAssignment(id){
      const res = await fetch(`${API_BASE}/api/assignments/${encodeURIComponent(id)}`);
      if (!res.ok) return null;
      const js = await res.json().catch(()=>null);
      return js?.assignment || js;
    }
    async function fetchMySubmission(id){
      try{
        const res = await fetch(`${API_BASE}/api/assignments/${encodeURIComponent(id)}/submissions/${encodeURIComponent(userData.userId)}`);
        if (!res.ok) return null;
        const js = await res.json().catch(()=>null);
        return js?.submission || null;
      }catch{ return null; }
    }

    function normalizeAssignment(a){
      if (!a) return null;
      return {
        id: a.id,
        title: a.title || "Untitled",
        content: a.content || "",
        courseId: a.courseId || null,
        courseTitle: a.courseTitle || "Course",
        moduleNumber: a.moduleNumber ?? null,
        points: a.points ?? null,
        publishAt: tsToMs(a.publishAt),
        dueAt: tsToMs(a.dueAt),
        attachments: Array.isArray(a.attachments) ? a.attachments : []
      };
    }

    function computeStatus(a, mySub){
      const now = Date.now();
      if (mySub?.graded) return 'Graded';
      if (mySub) return 'Submitted';
      if (a.publishAt && now < a.publishAt) return 'Closed';
      if (a.dueAt && now > a.dueAt) return 'Closed';
      return 'Open';
    }

    function setStatusPill(status){
      const map = {
        Open: 'badge bg-success-subtle text-success-emphasis',
        Submitted: 'badge bg-primary-subtle text-primary-emphasis',
        Graded: 'badge bg-success text-white',
        Closed: 'badge bg-danger-subtle text-danger-emphasis'
      };
      statusPill.innerHTML = `<span class="${map[status] || 'badge bg-secondary'}">${status}</span>`;
    }

    // ====== Renderers ======
    function renderAssignment(a){
      bcTitle.innerText = softWrap(a.title);
      pageTitle.innerText = softWrap(a.title);
      assignTitle.innerText = softWrap(a.title);

      const courseText = a.courseTitle || "Course";
      courseBadge.innerHTML = `<i class="bi bi-journal-text"></i> ${escapeHTML(courseText)}`;

      const moduleTxt = a.moduleNumber ? `Module #${a.moduleNumber}` : "";
      moduleLine.innerText = softWrap(moduleTxt);
      pointsLine.innerText = a.points != null ? (moduleTxt ? " ‚Ä¢ " : "") + `${a.points} pts` : "";
      dueAtEl.innerText = a.dueAt ? fmtDateTime(a.dueAt) : "No due date";

      assignContent.innerText = softWrap(a.content || "");

      const atts = Array.isArray(a.attachments) ? a.attachments : [];
      const rubricFiles = atts.filter(x => !x.url && isRubricAttachment(x));
      const otherFiles  = atts.filter(x => !x.url && !isRubricAttachment(x));
      const links       = atts.filter(x => !!x.url);

      let html = '';

      // Rubric box (preview-enabled)
      if (rubricFiles.length) {
        const items = rubricFiles.map(f => {
          const name = softWrap(pickName(f));
          const payload = {
            downloadUrl: f.downloadUrl || '',
            publicUrl: f.publicUrl || '',
            previewUrl: f.previewUrl || '',
            url: f.url || '',
            storagePath: f.storagePath || '',
            gsUri: f.gsUri || '',
            originalName: f.originalName || ''
          };
          const data = escapeHTML(JSON.stringify(payload));
          const size = f.size ? ` ‚Ä¢ ${bytesKB(f.size)} KB` : '';
          return `<div class="rubric-item">
              <i class="bi bi-clipboard-check text-success"></i>
              <button type="button" class="btn btn-link p-0 align-baseline att-preview-btn" data-payload="${data}">
                ${name}
              </button>
              <span class="small-label">${size}</span>
            </div>`;
        }).join('');
        html += `
          <div class="rubric-box mb-3">
            <div class="rubric-title"><i class="bi bi-clipboard2-check-fill text-success"></i> Rubric</div>
            <div class="mt-1">${items}</div>
          </div>`;
      }

      // Other uploaded files (preview-enabled)
      const fileItems = otherFiles.map(f => {
        const name = softWrap(pickName(f));
        const payload = {
          downloadUrl: f.downloadUrl || '',
          publicUrl: f.publicUrl || '',
          previewUrl: f.previewUrl || '',
          url: f.url || '',
          storagePath: f.storagePath || '',
          gsUri: f.gsUri || '',
          originalName: f.originalName || ''
        };
        const data = escapeHTML(JSON.stringify(payload));
        const sizeTxt = f.size ? ` (${bytesKB(f.size)} KB)` : '';
        return `<li class="mb-1"><i class="bi bi-paperclip"></i>
                  <button type="button" class="btn btn-link p-0 align-baseline att-preview-btn" data-payload="${data}">
                    ${name}
                  </button>${sizeTxt}
                </li>`;
      }).join('');

      // External links (preview-enabled; YouTube embeds, etc.)
      const linkItems = links.map(x => {
        const href = x.url || pickHref(x);
        const display = softWrap(x.url || pickName(x));
        const safe = (href || '').replace(/"/g,'&quot;');
        const kind = kindFromUrl(href || '');
        const icon = kind==='youtube' ? '‚ñ∂Ô∏è' : (kind==='video' ? 'üé¨' : 'üîó');
        return `<li class="mb-1">
                  ${icon}
                  <button type="button" class="btn btn-link p-0 align-baseline att-preview-btn" data-external-url="${safe}">
                    ${display}
                  </button>
                </li>`;
      }).join('');

      if (fileItems || linkItems) {
        html += `
          <div class="mt-3">
            <div class="fw-semibold mb-1"><i class="bi bi-paperclip"></i> Attachments</div>
            <ul class="attachment-list ps-3 mb-0">${fileItems}${linkItems}</ul>
          </div>`;
      }

      attachmentsWrap.innerHTML = html || '';

      // Wire preview buttons (delegated)
      attachmentsWrap.onclick = async (ev) => {
        const btn = ev.target.closest('.att-preview-btn');
        if (!btn) return;

        let viewUrl = '';
        let fileName = '';
        if (btn.dataset.externalUrl) {
          viewUrl = btn.dataset.externalUrl;
          fileName = viewUrl.split('/').pop() || 'Link';
        } else if (btn.dataset.payload) {
          try {
            const payload = JSON.parse(btn.dataset.payload);
            fileName = payload.originalName || pickName(payload) || 'File';
            viewUrl = await getSignedViewUrlIfNeeded(payload);
          } catch {}
        }
        if (!viewUrl) return;

        document.getElementById("filePreviewModalLabel").textContent = `${fileName} ‚Äì Preview`;
        setFileInfoUI(kindFromUrl(viewUrl), viewUrl);

        const content = document.getElementById("filePreviewContent");
        renderFilePreviewInto(content, viewUrl);

        new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
      };
    }

    function renderSubmission(sub){
      submissionSummary.classList.remove('d-none');

      const when = tsToMs(sub.submittedAt);
      submissionTime.innerText = when ? `Submitted: ${fmtDateTime(when)}` : '';

      const graded = !!sub.graded;
      submissionStatusBadge.innerHTML = graded
        ? `<span class="badge rounded-pill text-bg-success"><i class="bi bi-patch-check-fill me-1"></i> Graded</span>`
        : `<span class="badge rounded-pill text-bg-primary"><i class="bi bi-cloud-check me-1"></i> Submitted</span>`;

      const files = Array.isArray(sub.files) ? sub.files : [];
      if (files.length){
        const list = files.map(f => {
          const name = softWrap(escapeHTML(pickName(f)));
          const payload = {
            downloadUrl: f.downloadUrl || '',
            publicUrl: f.publicUrl || '',
            previewUrl: f.previewUrl || '',
            url: f.url || '',
            storagePath: f.storagePath || '',
            gsUri: f.gsUri || '',
            originalName: f.originalName || ''
          };
          const data = escapeHTML(JSON.stringify(payload));
          const size = f.size ? ` ‚Ä¢ ${bytesKB(f.size)} KB` : '';
          return `<li class="mb-1"><i class="bi bi-paperclip"></i>
                    <button type="button" class="btn btn-link p-0 align-baseline att-preview-btn" data-payload="${data}">
                      ${name}
                    </button>${size}
                  </li>`;
        }).join('');
        submissionFiles.innerHTML = `
          <div>
            <div class="fw-semibold mb-1"><i class="bi bi-folder2-open"></i> Files</div>
            <ul class="attachment-list ps-3 mb-0">${list}</ul>
          </div>`;
      } else {
        submissionFiles.innerHTML = `<div class="small-label">No files attached.</div>`;
      }

      const text = (sub.text || '').trim();
      submissionNote.innerHTML = text
        ? `<div><div class="fw-semibold mb-1"><i class="bi bi-sticky"></i> Note</div><div class="p-2 border rounded wrap-anywhere" style="white-space:pre-wrap">${escapeHTML(softWrap(text))}</div></div>`
        : `<div class="small-label">No note provided.</div>`;

      if (graded || sub.grade != null || (sub.feedback && String(sub.feedback).trim())){
        const g = (sub.grade != null) ? `<div><span class="fw-semibold">Grade:</span> ${escapeHTML(String(sub.grade))}</div>` : '';
        const fbText = sub.feedback ? escapeHTML(softWrap(String(sub.feedback))) : '';
        const fb = fbText ? `<div class="mt-1"><span class="fw-semibold">Feedback:</span> ${fbText}</div>` : '';
        submissionGrade.innerHTML = `<hr class="my-2"/>${g}${fb}`;
      } else {
        submissionGrade.innerHTML = '';
      }

      // Re-wire preview inside submission area as well
      submissionFiles.onclick = async (ev) => {
        const btn = ev.target.closest('.att-preview-btn');
        if (!btn) return;
        let viewUrl = '';
        let fileName = '';
        if (btn.dataset.payload) {
          try {
            const payload = JSON.parse(btn.dataset.payload);
            fileName = payload.originalName || pickName(payload) || 'File';
            viewUrl = await getSignedViewUrlIfNeeded(payload);
          } catch {}
        }
        if (!viewUrl) return;
        document.getElementById("filePreviewModalLabel").textContent = `${fileName} ‚Äì Preview`;
        setFileInfoUI(kindFromUrl(viewUrl), viewUrl);
        renderFilePreviewInto(document.getElementById("filePreviewContent"), viewUrl);
        new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
      };
    }

    // Locker
    function lockSubmissionUI(reason = 'You have already submitted this assignment. Resubmission is disabled.') {
      [fileInput, noteInput].forEach(el => { if (!el) return; el.disabled = true; el.classList.add('disabled'); });
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<i class="bi bi-lock-fill me-1"></i> Submission Locked`;
        submitBtn.classList.add('disabled');
      }
      alreadySubmitted.classList.remove('d-none');
      alreadySubmitted.innerHTML = `<i class="bi bi-info-circle me-1"></i> ${escapeHTML(softWrap(reason))}`;
    }

    // ====== Load ======
    async function loadPage(){
      if (!assignmentId){
        assignContent.textContent = "Invalid assignment id.";
        return;
      }
      const aRaw = await fetchAssignment(assignmentId);
      const a = normalizeAssignment(aRaw);
      if (!a){
        assignContent.textContent = "Assignment not found.";
        return;
      }
      renderAssignment(a);

      const mySub = await fetchMySubmission(assignmentId);
      const status = computeStatus(a, mySub);
      currentStatus = status;
      setStatusPill(status);

      if (status === 'Closed') {
        lockSubmissionUI('This assignment is closed. Submissions are disabled.');
      } else if (mySub) {
        renderSubmission(mySub);
        lockSubmissionUI();
      }
    }

    // ====== File preview/validation ======
    function summarizeSelection(files){
      if (!files.length) return '';
      let total = 0, max = 0;
      for (const f of files) { total += f.size; if (f.size > max) max = f.size; }
      return `${files.length} file(s) ‚Ä¢ total ${human(total)} ‚Ä¢ largest ${human(max)}`;
    }

    function renderFilePreview(){
      filePreview.innerHTML = '';
      const files = Array.from(fileInput.files || []);
      let anyTooLarge = false;

      files.forEach(f => {
        const tooBig = f.size > STUDENT_MAX_BYTES;
        if (tooBig) anyTooLarge = true;

        const row = document.createElement('div');
        row.className = 'file-pill' + (tooBig ? ' bad' : '');
        row.innerHTML = `
          <div class="d-flex align-items-center gap-2 wrap-anywhere">
            <i class="bi bi-file-earmark${tooBig ? '-x text-danger' : ''}"></i>
            <div>
              <div class="fw-semibold wrap-anywhere">${escapeHTML(softWrap(f.name))}</div>
              <div class="size">${human(f.size)}${tooBig ? ` <span class="warn">(exceeds ${STUDENT_MAX_MB} MB)</span>` : ''}</div>
            </div>
          </div>`;
        filePreview.appendChild(row);
      });

      if (files.length) fileHint.textContent = summarizeSelection(files);
      else fileHint.textContent = 'Supported: documents, images, PDFs, etc.';

      submitBtn.disabled = (currentStatus !== 'Open') || anyTooLarge;
      submitStatus.textContent = anyTooLarge ? `One or more files exceed the ${STUDENT_MAX_MB} MB limit.` : '';
    }
    fileInput.addEventListener('change', renderFilePreview);

    // ====== Submit handler ======
    async function submitAssignment(e){
      e.preventDefault();
      if (!assignmentId) return;

      if (currentStatus !== 'Open') {
        submitStatus.textContent = (currentStatus === 'Closed')
          ? 'This assignment is closed. Submissions are disabled.'
          : 'You have already submitted this assignment.';
        return;
      }

      const files = Array.from(fileInput.files || []);
      const tooLarge = files.find(f => f.size > STUDENT_MAX_BYTES);
      if (tooLarge){
        submitStatus.textContent = `‚Äú${tooLarge.name}‚Äù is ${human(tooLarge.size)} and exceeds the ${STUDENT_MAX_MB} MB limit. Please compress or choose a smaller file.`;
        renderFilePreview();
        return;
      }

      const hasFile = files.length > 0;
      const hasNote = !!noteInput.value.trim();
      if (!hasFile && !hasNote){
        submitStatus.textContent = "Please add at least one file or a note.";
        return;
      }

      const formData = new FormData();
      formData.append("studentId", userData.userId);
      files.forEach(f => formData.append("files", f));
      if (hasNote) formData.append("text", noteInput.value.trim());

      submitStatus.textContent = "Submitting‚Ä¶";
      submitBtn.disabled = true;

      try{
        const url = `${API_BASE}/api/assignments/${encodeURIComponent(assignmentId)}/submissions`;
        const res = await fetch(url, { method:"POST", body: formData });
        const raw = await res.text();
        let js = {};
        try { js = JSON.parse(raw); } catch {}
        if (!res.ok || js.success === false) {
          submitStatus.textContent = js.message ? js.message : `Upload failed (HTTP ${res.status})`;
          submitBtn.disabled = false;
          return;
        }
      }catch(err){
        submitStatus.textContent = "Failed to submit: " + (err?.message || "Unknown error");
        submitBtn.disabled = false;
        return;
      }

      lockSubmissionUI();
      const localSub = {
        text: noteInput.value.trim(),
        files: files.map(f => ({ filePath: '', originalName: f.name, size: f.size })), // local receipt only
        graded: false, grade: null, feedback: null,
        submittedAt: Date.now()
      };
      renderSubmission(localSub);

      window.location.href = "/STUDENT/assignment/assignment.html?submitted=1";
    }

    function logoutUser(){
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }

    (async function init(){
      try{ await loadPage(); }
      catch(e){ console.error(e); assignContent.textContent = "Failed to load assignment details."; }
      submitForm.addEventListener("submit", submitAssignment);
    })();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
