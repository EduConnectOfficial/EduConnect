<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EduConnect Student – Assignments</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../assignment/assignment.css" />

  <style>
    /* ===== Full-screen-ish File Preview Modal (shared look/feel) ===== */
    #filePreviewModal .modal-dialog { max-width: 96vw; }
    #filePreviewModal .modal-content { height: 92vh; display: flex; flex-direction: column; }
    #filePreviewModal .modal-body { flex: 1 1 auto; padding: 0; background: #f8fafc; position: relative; }
    .preview-wrap { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .preview-wrap iframe, .preview-wrap embed, .preview-wrap object, .preview-wrap img, .preview-wrap video, .preview-wrap audio {
      width: 100%; height: 100%; border: 0; object-fit: contain; background: #fff;
    }
    .preview-fallback { max-width: 720px; margin: 0 auto; padding: 2rem; text-align: center; }
    #filePreviewFooter { display: flex; gap: .5rem; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .spinner-wrap { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #ffffff; }

    /* Long token wrapping (titles, meta, etc.) */
    .wrap-anywhere { overflow-wrap:anywhere; word-break:break-word; line-break:anywhere; }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" id="searchBox" placeholder="Search assignments…"/>
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title">My Assignments</h1>

        <!-- Controls -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-clipboard-check"></i> Assigned Work</h2>
            <div class="ui-subtext">Filter by course or status to focus your work.</div>
          </div>
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-4">
              <label class="form-label">Course</label>
              <select id="filterCourse" class="form-select">
                <option value="All">All Courses</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Status</label>
              <select id="filterStatus" class="form-select">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="closed">Closed</option>
                <option value="submitted">Submitted</option>
                <option value="graded">Graded</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select">
                <option value="dueAsc">Due Date ↑</option>
                <option value="dueDesc">Due Date ↓</option>
                <option value="title">Title A–Z</option>
              </select>
            </div>
            <div class="col-12 col-md-2 text-md-end">
              <button id="refreshBtn" class="btn btn-amber w-100"><i class="bi bi-arrow-repeat me-1"></i>Refresh</button>
            </div>
          </div>
        </div>

        <!-- Always-visible status count pills -->
        <div class="pill-row">
          <span class="pill pill-open"><i class="bi bi-check2-circle"></i><span class="pill-text"><strong id="countOpen">0</strong> Open</span></span>
          <span class="pill pill-submitted"><i class="bi bi-upload"></i><span class="pill-text"><strong id="countSubmitted">0</strong> Submitted</span></span>
          <span class="pill pill-graded"><i class="bi bi-patch-check"></i><span class="pill-text"><strong id="countGraded">0</strong> Graded</span></span>
          <span class="pill pill-closed"><i class="bi bi-lock"></i><span class="pill-text"><strong id="countClosed">0</strong> Closed</span></span>
        </div>

        <!-- Submission Success Modal -->
        <div class="modal fade" id="submissionSuccessModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header" style="background:linear-gradient(90deg,#4A1A0C,#7A2810); color:#FFD8A9;">
                <h5 class="modal-title"><i class="bi bi-check2-circle me-2"></i>Assignment submitted</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Your assignment was submitted successfully. You can verify the status in the list.
              </div>
              <div class="modal-footer">
                <button class="btn btn-amber" data-bs-dismiss="modal">OK</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Grid -->
        <div id="assignmentsGrid" class="row g-3"></div>
      </div>
    </div>
  </div>

  <!-- Details-only Modal -->
  <div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title wrap-anywhere" id="modalTitle">Assignment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div id="modalMeta" class="mb-2 muted wrap-anywhere"></div>
          <div id="modalContent" class="mb-3 wrap-anywhere"></div>
          <div id="modalAttachments" class="mt-3 wrap-anywhere"></div>
        </div>

        <div class="modal-footer">
          <span id="modalDueBadge" class="badge-soft me-auto px-2"></span>
          <button type="button" class="btn btn-amber-outline" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-screen-ish File Preview Modal -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">File Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 text-muted small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>

        <div class="modal-footer" id="filePreviewFooter">
          <div class="text-muted small" id="fileInfoText"></div>
          <div class="ms-auto">
            <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-amber">
              <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Page Logic -->
  <script>
  // ========= Config =========
  const API_BASE = "http://localhost:5000";

  // ========= Stronger auth guard (student only) =========
  (function guardStudentSession() {
    const raw = JSON.parse(localStorage.getItem("user") || "{}");
    const u = raw.user || raw;

    const isValid =
      !!u?.userId &&
      u?.isStudent === true &&
      // optional format check if you use S-xxx student IDs
      (u?.studentId ? /^S-/.test(String(u.studentId)) : true);

    if (!isValid) {
      try { localStorage.removeItem("user"); } catch {}
      window.location.replace("/STUDENT/login/login.html");
      return;
    }

    // Expose for rest of script
    window.userData = u;

    // Header initials (initials only)
    function initialsFrom(str) {
      if (!str) return "";
      const s = String(str).trim();
      if (!s) return "";
      if (s.includes("@")) {
        const local = s.split("@")[0];
        const parts = local.split(/[.\-_]+/).filter(Boolean);
        return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : local.slice(0,2)).toUpperCase();
      }
      const parts = s.split(/[\s\-]+/).filter(Boolean);
      return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : parts[0].slice(0,2)).toUpperCase();
    }
    const el = document.getElementById("Username");
    if (el) {
      const displayName = u.fullName || u.username || u.email || "Student";
      const initials = initialsFrom(displayName) || "?";
      el.textContent = initials;
      el.title = displayName;
      el.setAttribute("aria-label", displayName);
    }

    // Cross-tab tamper guard: if user changes to non-student elsewhere, kick back to login
    window.addEventListener("storage", (e) => {
      if (e.key === "user") {
        try {
          const next = JSON.parse(e.newValue || "null");
          const nu = (next && (next.user || next)) || null;
          const ok = !!nu?.userId && nu?.isStudent === true && (nu?.studentId ? /^S-/.test(String(nu.studentId)) : true);
          if (!ok) window.location.replace("/STUDENT/login/login.html");
        } catch {
          window.location.replace("/STUDENT/login/login.html");
        }
      }
    });
  })();

  // ========= DOM refs =========
  const grid = document.getElementById("assignmentsGrid");
  const filterCourse = document.getElementById("filterCourse");
  const filterStatus = document.getElementById("filterStatus");
  const sortBy = document.getElementById("sortBy");
  const searchBox = document.getElementById("searchBox");

  // Count pill DOM
  const elCountOpen = document.getElementById("countOpen");
  const elCountSubmitted = document.getElementById("countSubmitted");
  const elCountGraded = document.getElementById("countGraded");
  const elCountClosed = document.getElementById("countClosed");

  const modalEl = document.getElementById('assignmentModal');
  let assignmentModal = null;
  document.addEventListener('DOMContentLoaded', () => {
    assignmentModal = new bootstrap.Modal(modalEl);
  });

  // ========= State =========
  let courses = [];     // { id, title }
  let assignments = []; // normalized items from API

  // Caches
  const moduleCache = new Map(); // moduleId -> { title, moduleNumber }
  const courseCache = new Map(); // courseId -> { title }

  // ========= Utils =========
  function toApiUrl(pathOrUrl) {
    return /^https?:\/\//i.test(String(pathOrUrl))
      ? String(pathOrUrl)
      : API_BASE + String(pathOrUrl || "");
  }

  const fmtDateTime = (ms) => {
    if (!ms) return 'No due date';
    try { return new Date(ms).toLocaleString(); } catch { return '—'; }
  };

  const escapeHTML = (s='') => String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'",'&#039;');

  // Soft wrap helper (insert zero-width spaces in very long tokens)
  function softWrap(s, limit = 40){
    if (!s) return s;
    return String(s).replace(new RegExp(`([^\\s]{${limit}})`, 'g'), '$1\u200B');
  }

  function computeStatus(a) {
    const now = Date.now();
    const pub = a.publishAt || 0;
    const due = a.dueAt || null;

    if (a.mySubmission?.graded) return 'graded';
    if (a.mySubmission) return 'submitted';

    if (pub && now < pub) return 'closed';
    if (due && now > due) return 'closed';
    return 'open';
  }

  // === Cloud-safe attachment helpers ===
  function pickHref(obj = {}) {
    return obj.downloadUrl || obj.publicUrl || obj.previewUrl ||
           (obj.url && /^https?:\/\//i.test(obj.url) ? obj.url : '') ||
           (obj.filePath ? toApiUrl(obj.filePath) : '');
  }

  function pickName(obj = {}) {
    const fromPath = (obj.storagePath || obj.filePath || '').split('/').pop();
    const fromUrl  = (obj.url || '').split('/').pop();
    return obj.originalName || fromPath || fromUrl || 'file';
  }

  function extractStoragePath(obj = {}) {
    if (obj.storagePath) return String(obj.storagePath);

    if (obj.gsUri && obj.gsUri.startsWith('gs://')) {
      const parts = obj.gsUri.replace('gs://','').split('/');
      parts.shift(); // bucket
      return parts.join('/');
    }

    if (obj.publicUrl && /storage\.googleapis\.com/i.test(obj.publicUrl)) {
      try {
        const u = new URL(obj.publicUrl);
        const parts = u.pathname.replace(/^\/+/, '').split('/');
        parts.shift(); // bucket
        return parts.join('/');
      } catch {}
    }

    if (obj.downloadUrl && /firebasestorage\.googleapis\.com/i.test(obj.downloadUrl)) {
      try {
        const u = new URL(obj.downloadUrl);
        if (u.pathname.includes('/o/')) {
          const enc = u.pathname.split('/o/')[1];
          return decodeURIComponent(enc);
        }
      } catch {}
    }

    return '';
  }

  async function getSignedViewUrlIfNeeded(obj) {
    const direct = pickHref(obj);
    // If it's a Firebase storage v0 endpoint, it's already signed token URL.
    if (direct && /firebasestorage\.googleapis\.com\/v0\/b\//i.test(direct)) return direct;

    const storagePath = extractStoragePath(obj);
    if (!storagePath) return direct || null;

    // Try server signer for inline viewing
    try {
      const r = await fetch(`${API_BASE}/api/attachments/signed?path=${encodeURIComponent(storagePath)}`);
      const js = await r.json().catch(()=>null);
      if (r.ok && js?.success && js?.url) return js.url;
    } catch {}
    return direct || null;
  }

  // --- Fetch module meta & cache ---
  async function fetchModuleMeta(moduleId) {
    if (!moduleId) return null;
    if (moduleCache.has(moduleId)) return moduleCache.get(moduleId);
    try {
      const res = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}`);
      const js = await res.json();
      const meta = js && js.id ? { title: js.title || '', moduleNumber: js.moduleNumber ?? null } : null;
      moduleCache.set(moduleId, meta);
      return meta;
    } catch {
      moduleCache.set(moduleId, null);
      return null;
    }
  }

  // --- Fetch course meta & cache ---
  async function fetchCourseMeta(courseId) {
    if (!courseId) return null;
    if (courseCache.has(courseId)) return courseCache.get(courseId);
    try {
      const res = await fetch(`${API_BASE}/api/courses/${encodeURIComponent(courseId)}`);
      const js = await res.json();
      const data = js && (js.course || js);
      const meta = data && data.id ? { title: data.title || data.name || 'Untitled' } : null;
      courseCache.set(courseId, meta);
      return meta;
    } catch {
      courseCache.set(courseId, null);
      return null;
    }
  }

  // --- Enrich assignments with meta ---
  async function hydrateMetaForAssignments(list) {
    const moduleIds = [...new Set((list || []).map(a => a.moduleId).filter(Boolean))];
    const courseIds = [...new Set((list || []).map(a => a.courseId).filter(Boolean))];

    await Promise.all([
      ...moduleIds.map(id => fetchModuleMeta(id)),
      ...courseIds.map(id => fetchCourseMeta(id)),
    ]);

    (list || []).forEach(a => {
      const m = a.moduleId ? moduleCache.get(a.moduleId) : null;
      if (m) {
        if (!a.moduleTitle) a.moduleTitle = m.title || '';
        if (a.moduleNumber == null) a.moduleNumber = m.moduleNumber ?? null;
      }
      if (!a.courseTitle && a.courseId) {
        const c = courseCache.get(a.courseId);
        if (c) a.courseTitle = c.title || 'Untitled';
      }
    });
  }

  // ========= Data loaders =========
  async function loadCourses() {
    const res = await fetch(`${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/courses?includeTeacher=true`);
    const js = await res.json();
    const list = Array.isArray(js.courses) ? js.courses : [];
    courses = list.map(c => ({ id: c.id, title: c.title || 'Untitled' }));
    courses.forEach(c => courseCache.set(c.id, { title: c.title }));
    filterCourse.innerHTML = `<option value="All">All Courses</option>` +
      courses.map(c => `<option value="${c.id}">${escapeHTML(c.title)}</option>`).join('');
  }

  async function tryLoadAssignmentsDirect() {
    const res = await fetch(`${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/assignments`);
    if (!res.ok) return null;
    const js = await res.json().catch(()=>null);
    if (!js || !js.success || !Array.isArray(js.assignments)) return null;
    return js.assignments;
  }

  async function loadAssignmentsViaCourses() {
    const all = [];
    for (const c of courses) {
      try {
        const res = await fetch(`${API_BASE}/api/courses/${encodeURIComponent(c.id)}/assignments`);
        if (!res.ok) continue;
        const js = await res.json();
        const list = Array.isArray(js.assignments) ? js.assignments : Array.isArray(js) ? js : [];
        list.forEach(a => {
          all.push({
            id: a.id,
            title: a.title || 'Untitled',
            content: a.content || '',
            courseId: c.id,
            courseTitle: c.title,
            moduleId: a.moduleId || null,
            moduleNumber: a.moduleNumber || null,
            moduleTitle: a.moduleTitle || '',
            publishAt: a.publishAt ? (a.publishAt._seconds ? a.publishAt._seconds*1000 : a.publishAt) : null,
            dueAt: a.dueAt ? (a.dueAt._seconds ? a.dueAt._seconds*1000 : a.dueAt) : null,
            points: a.points ?? null,
            mySubmission: a.mySubmission || null,
            attachments: Array.isArray(a.attachments) ? a.attachments : []
          });
        });
      } catch { /* ignore */ }
    }
    return all;
  }

  async function loadAll() {
    await loadCourses();
    let list = await tryLoadAssignmentsDirect();
    if (!list) list = await loadAssignmentsViaCourses();

    assignments = (list || []).map(a => ({
      ...a,
      publishAt: a.publishAt && a.publishAt._seconds ? a.publishAt._seconds*1000 : a.publishAt || null,
      dueAt: a.dueAt && a.dueAt._seconds ? a.dueAt._seconds*1000 : a.dueAt || null,
      attachments: Array.isArray(a.attachments) ? a.attachments : []
    }));

    await hydrateMetaForAssignments(assignments);

    renderGrid();
    refreshStatusPills(assignments);
  }

  // ========= Kind detection & preview helpers =========
  function isYouTubeUrl(url = '') {
    try {
      const u = new URL(url);
      const h = u.hostname.replace(/^www\./, '').toLowerCase();
      return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);
    } catch { return false; }
  }
  function toYouTubeEmbed(url=''){
    try{
      const u = new URL(url);
      const host = u.hostname.replace(/^www\./,'').toLowerCase();
      let id = '';
      let start = u.searchParams.get('start') || u.searchParams.get('t') || '';
      if (start && /^\d+s$/.test(start)) start = parseInt(start,10);
      if (start && /^\d+$/.test(start)) start = parseInt(start,10);
      if (!Number.isFinite(start)) start = '';
      if (host === 'youtu.be'){
        id = (u.pathname || '').replace(/^\//,'').split('/')[0];
      } else {
        if (u.pathname.startsWith('/embed/')) id = u.pathname.split('/')[2] || '';
        if (!id) id = u.searchParams.get('v') || '';
      }
      if (!id) return null;
      const base = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;
      const qs = new URLSearchParams(); qs.set('rel','0'); if (start) qs.set('start', String(start));
      return `${base}?${qs.toString()}`;
    }catch{ return null; }
  }
  function getExtFromUrl(url=''){
    const clean = String(url).split('?')[0].split('#')[0];
    const parts = clean.split('.'); return parts.length>1 ? parts.pop().toLowerCase() : '';
  }
  function kindFromUrl(url){
    if (isYouTubeUrl(url)) return 'youtube';
    const ext = getExtFromUrl(url);
    if (['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
    if (['mp3','wav','ogg','m4a','aac','flac'].includes(ext)) return 'audio';
    if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
    if (ext==='pdf') return 'pdf';
    if (['txt','csv','log'].includes(ext)) return 'text';
    if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
    return 'other';
  }
  function setFileInfoUI(kind, url) {
    const info = document.getElementById('fileInfoText');
    const hdr  = document.getElementById('filePreviewModalLabel');
    const badgeId = 'fileKindBadge';

    const labelMap = {
      youtube:'YouTube', video:'Video', audio:'Audio', image:'Image',
      pdf:'PDF', text:'Text/CSV', office:'Office Doc', other:'File'
    };
    const colorMap = {
      youtube:'bg-danger-subtle text-danger', video:'bg-danger-subtle text-danger',
      audio:'bg-secondary-subtle text-secondary', image:'bg-success-subtle text-success',
      pdf:'bg-primary-subtle text-primary', text:'bg-info-subtle text-info',
      office:'bg-warning-subtle text-warning', other:'bg-dark-subtle text-dark'
    };

    let badge = document.getElementById(badgeId);
    if (!badge){
      badge = document.createElement('span');
      badge.id = badgeId;
      badge.className = 'ms-2 badge rounded-pill';
      hdr.appendChild(badge);
    }
    badge.className = 'ms-2 badge rounded-pill ' + (colorMap[kind] || colorMap.other);
    badge.textContent = labelMap[kind] || 'File';

    info.innerHTML = `<span class="text-muted">Type:</span> <strong>${labelMap[kind] || 'File'}</strong>`;
    document.getElementById('openInNewTabBtn').href = url || '#';
  }
  function showSpinner(show) {
    document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none';
  }
  function renderFilePreviewInto(container, url) {
    container.innerHTML = '';
    showSpinner(true);
    const done = () => showSpinner(false);
    const kind = kindFromUrl(url);

    if (kind === 'youtube') {
      const embed = toYouTubeEmbed(url);
      if (embed) {
        container.innerHTML = `
          <div class="ratio ratio-16x9">
            <iframe
              src="${embed}"
              title="YouTube video"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              referrerpolicy="strict-origin-when-cross-origin"
              style="border:0"></iframe>
          </div>`;
        done();
        return;
      }
      container.innerHTML = `
        <div class="preview-fallback">
          <div class="text-muted mb-2">Couldn’t embed this YouTube link.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a>
        </div>`;
      done();
      return;
    }

    const ext = getExtFromUrl(url);

    if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) {
      const img = new Image();
      img.onload = done;
      img.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Image preview failed.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a></div>`;
        done();
      };
      img.src = url;
      container.appendChild(img);
      return;
    }

    if (ext === 'pdf') {
      const iframe = document.createElement('iframe');
      iframe.title = 'PDF preview';
      iframe.onload = done;
      iframe.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">PDF preview failed (viewer blocked or CORS).</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a></div>`;
        done();
      };
      iframe.src = url;
      container.appendChild(iframe);
      return;
    }

    if (['mp4','webm','ogg','ogv','mov'].includes(ext)) {
      const video = document.createElement('video');
      video.controls = true;
      video.onloadeddata = done;
      video.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Video preview failed.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a></div>`;
        done();
      };
      video.src = url;
      container.appendChild(video);
      return;
    }

    if (['mp3','wav','m4a','ogg','aac','flac'].includes(ext)) {
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.onloadeddata = done;
      audio.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Audio preview failed.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a></div>`;
        done();
      };
      audio.src = url;
      container.appendChild(audio);
      return;
    }

    if (['txt','csv','log'].includes(ext)) {
      const iframe = document.createElement('iframe');
      iframe.onload = done;
      iframe.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Text preview failed.</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a></div>`;
        done();
      };
      iframe.src = url;
      container.appendChild(iframe);
      return;
    }

    if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) {
      const gview = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;
      const iframe = document.createElement('iframe');
      iframe.title = 'Document preview';
      iframe.onload = done;
      iframe.onerror = () => {
        container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">Office preview failed (Google Viewer blocked or CORS).</div>
          <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a></div>`;
        done();
      };
      iframe.src = gview;
      container.appendChild(iframe);
      return;
    }

    // Last-resort object
    const obj = document.createElement('object');
    obj.data = url;
    obj.type = 'application/octet-stream';
    obj.onload = done;
    obj.onerror = () => {
      container.innerHTML = `<div class="preview-fallback"><div class="text-muted mb-2">This file type cannot be previewed here.</div>
        <a class="btn btn-amber" href="${url}" target="_blank" rel="noopener">
          <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
        </a></div>`;
      done();
    };
    container.appendChild(obj);
    setTimeout(done, 1200);
  }

  // ========= Render =========
  function refreshStatusPills(src) {
    const counts = { open:0, submitted:0, graded:0, closed:0 };
    (src || []).forEach(a => {
      const st = computeStatus(a);
      counts[st] = (counts[st] || 0) + 1;
    });
    if (elCountOpen) elCountOpen.textContent = counts.open || 0;
    if (elCountSubmitted) elCountSubmitted.textContent = counts.submitted || 0;
    if (elCountGraded) elCountGraded.textContent = counts.graded || 0;
    if (elCountClosed) elCountClosed.textContent = counts.closed || 0;
  }

  function renderGrid() {
    const q = (searchBox.value || '').toLowerCase();
    const courseFilter = filterCourse.value;
    const statusFilter = filterStatus.value;

    let list = assignments.slice()
      .filter(a => courseFilter === 'All' ? true : a.courseId === courseFilter)
      .filter(a => {
        const hay = `${a.title} ${a.content} ${a.courseTitle || ''} ${a.moduleTitle || ''}`.toLowerCase();
        return hay.includes(q);
      })
      .map(a => ({...a, status: computeStatus(a)}));

    if (statusFilter !== 'all') {
      list = list.filter(a => a.status === statusFilter);
    }

    if (sortBy.value === 'dueAsc') {
      list.sort((a,b) => (a.dueAt||Infinity) - (b.dueAt||Infinity));
    } else if (sortBy.value === 'dueDesc') {
      list.sort((a,b) => (b.dueAt||0) - (a.dueAt||0));
    } else if (sortBy.value === 'title') {
      list.sort((a,b) => (a.title||'').localeCompare(b.title||''));
    }

    refreshStatusPills(list);

    grid.innerHTML = '';
    if (!list.length) {
      grid.innerHTML = `<div class="col-12"><div class="ui-card text-center">No assignments found.</div></div>`;
      return;
    }

    list.forEach(a => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-xl-4';

      const dueTxt = a.dueAt ? fmtDateTime(a.dueAt) : 'No due date';
      const statusBadge = (() => {
        const map = { open:'st-open', closed:'st-closed', submitted:'st-submitted', graded:'st-graded' };
        const cls = map[a.status] || 'st-open';
        const label = a.status.charAt(0).toUpperCase() + a.status.slice(1);
        return `<span class="status-dot ${cls}"></span>${label}`;
      })();

      const courseLabel = (a.courseTitle || '').trim();
      const coursePill = courseLabel
        ? `<span class="pill pill-course" title="${escapeHTML(courseLabel)}">
             <i class="bi bi-collection"></i>
             <span class="pill-text">${escapeHTML(courseLabel)}</span>
           </span>` : '';

      let moduleLabel = '';
      if (a.moduleNumber != null && (a.moduleTitle || '').trim()) {
        moduleLabel = `Module ${a.moduleNumber} • ${a.moduleTitle}`;
      } else if (a.moduleNumber != null) {
        moduleLabel = `Module ${a.moduleNumber}`;
      } else if ((a.moduleTitle || '').trim()) {
        moduleLabel = a.moduleTitle;
      }
      const modulePill = moduleLabel
        ? `<span class="pill pill-module" title="${escapeHTML(moduleLabel)}">
             <i class="bi bi-box"></i>
             <span class="pill-text">${escapeHTML(moduleLabel)}</span>
           </span>` : '';

      col.innerHTML = `
        <div class="assignment-card">
          <div class="d-flex justify-content-between align-items-start mb-1">
            <h5 class="mb-0 wrap-anywhere">${escapeHTML(a.title)}</h5>
            <div class="muted small text-end">${statusBadge}</div>
          </div>

          <div class="mb-2 d-flex flex-wrap gap-1">${coursePill}${modulePill}</div>

          <div class="muted small mb-2">
            Due: <strong>${dueTxt}</strong>
          </div>

          <div class="desc mb-3 wrap-anywhere" title="${escapeHTML(a.content || '')}">
            ${escapeHTML(a.content || '')}
          </div>

          <div class="mt-auto d-flex gap-2">
            <button class="btn btn-sm btn-amber" data-action="view" data-id="${a.id}">
              <i class="bi bi-eye me-1"></i>View
            </button>
            <button class="btn btn-sm btn-amber-outline" data-action="submit" data-id="${a.id}">
              <i class="bi bi-upload me-1"></i>Submit
            </button>
          </div>
        </div>
      `;
      grid.appendChild(col);
    });

    grid.querySelectorAll('button[data-action]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        const a = assignments.find(x => x.id === id);
        if (!a) return;

        if (action === 'view') {
          openAssignmentModal(a);
        } else if (action === 'submit') {
          window.location.href = '/STUDENT/assignment/assignment_view.html?id=' + encodeURIComponent(a.id);
        }
      });
    });
  }

  // ========= Modal (details + attachments with PREVIEW) =========
  function openAssignmentModal(a) {
    document.getElementById('modalTitle').innerText = softWrap(a.title || 'Assignment');

    let moduleLabel = '';
    if (a.moduleNumber != null && (a.moduleTitle || '').trim()) {
      moduleLabel = `Module ${a.moduleNumber} • ${a.moduleTitle}`;
    } else if (a.moduleNumber != null) {
      moduleLabel = `Module ${a.moduleNumber}`;
    } else if ((a.moduleTitle || '').trim()) {
      moduleLabel = a.moduleTitle;
    }

    const metaText = `${a.courseTitle || 'Course'}${moduleLabel ? ' • ' + moduleLabel : ''} • Due: ${fmtDateTime(a.dueAt)}`;
    document.getElementById('modalMeta').innerText = softWrap(metaText);
    document.getElementById('modalContent').innerText = softWrap(a.content || '');

    const attWrap = document.getElementById('modalAttachments');
    const atts = Array.isArray(a.attachments) ? a.attachments : [];
    if (!atts.length) {
      attWrap.innerHTML = '';
    } else {
      const items = atts.map(x => {
        // External link
        if (x.url && /^https?:\/\//i.test(String(x.url))) {
          const display = softWrap(x.url);
          const safe = x.url.replace(/"/g,'&quot;');
          const kind = kindFromUrl(x.url);
          const icon = kind==='youtube' ? '▶️' : (kind==='video' ? '🎬' : '🔗');
          return `<li class="mb-1">
                    ${icon}
                    <button type="button" class="btn btn-link p-0 align-baseline att-preview-btn"
                            data-external-url="${safe}">
                      ${display}
                    </button>
                  </li>`;
        }

        // File-like (cloud upload)
        const payload = {
          downloadUrl: x.downloadUrl || '',
          publicUrl: x.publicUrl || '',
          previewUrl: x.previewUrl || '',
          url: x.url || '',
          storagePath: x.storagePath || '',
          gsUri: x.gsUri || '',
          originalName: x.originalName || ''
        };
        const label = softWrap(pickName(x));
        const data = escapeHTML(JSON.stringify(payload));
        return `<li class="mb-1">
                  <i class="bi bi-paperclip"></i>
                  <button type="button" class="btn btn-link p-0 align-baseline att-preview-btn"
                          data-payload="${data}">
                    ${label}
                  </button>
                </li>`;
      }).join('');

      attWrap.innerHTML = `
        <div class="mt-2">
          <div class="fw-semibold mb-1"><i class="bi bi-paperclip"></i> Attachments</div>
          <ul class="attachment-list ps-3 mb-0">${items}</ul>
        </div>`;
    }

    // Wire preview clicks inside the modal
    attWrap.onclick = async (ev) => {
      const btn = ev.target.closest('.att-preview-btn');
      if (!btn) return;

      let viewUrl = '';
      let fileName = '';
      if (btn.dataset.externalUrl) {
        viewUrl = btn.dataset.externalUrl;
        fileName = viewUrl.split('/').pop() || 'Link';
      } else if (btn.dataset.payload) {
        try {
          const payload = JSON.parse(btn.dataset.payload);
          fileName = payload.originalName || 'File';
          viewUrl = await getSignedViewUrlIfNeeded(payload);
        } catch {}
      }

      if (!viewUrl) return;

      // Set header and footer info
      document.getElementById("filePreviewModalLabel").textContent = `${fileName} – Preview`;
      setFileInfoUI(kindFromUrl(viewUrl), viewUrl);

      // Render into big modal
      const content = document.getElementById("filePreviewContent");
      renderFilePreviewInto(content, viewUrl);

      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    };

    assignmentModal.show();
  }

  // ========= Controls =========
  document.getElementById('refreshBtn').addEventListener('click', loadAll);
  filterCourse.addEventListener('change', renderGrid);
  filterStatus.addEventListener('change', renderGrid);
  sortBy.addEventListener('change', renderGrid);
  searchBox.addEventListener('input', renderGrid);

  function logoutUser() {
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = "/STUDENT/login/login.html";
  }

  // ========= Boot =========
  (async function init(){
    try { await loadAll(); }
    catch (e) {
      console.error(e);
      grid.innerHTML = `<div class="col-12"><div class="ui-card text-center text-danger">Failed to load assignments.</div></div>`;
    }
  })();
  </script>

  <script>
    // Show success modal if redirected with ?submitted=1
    (function(){
      const p = new URLSearchParams(location.search);
      if (p.get("submitted") === "1"){
        const m = new bootstrap.Modal(document.getElementById("submissionSuccessModal"));
        m.show();
        const url = new URL(location.href);
        url.searchParams.delete("submitted");
        window.history.replaceState({}, "", url.toString());
      }
    })();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
