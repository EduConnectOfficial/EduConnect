<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - My Courses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Sidebar / shared -->
  <link rel="stylesheet" href="../courses/courses.css" />
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" id="courseSearch" placeholder="Search enrolled classes..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title brand">My Courses</h1>

        <!-- Controls -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-folder2-open"></i> Enrolled Classes</h2>
          </div>
          <div class="row g-2">
            <div class="col-12 col-md-6 col-xl-5">
              <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                <input id="searchInput" type="search" class="form-control border-start-0" placeholder="Search by class name, teacher..." />
              </div>
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <select id="filterSchoolYear" class="form-select">
                <option value="All">All School Years</option>
              </select>
            </div>
            <div class="col-6 col-md-3 col-xl-2">
              <select id="filterSemester" class="form-select">
                <option value="All">All Semesters</option>
                <option>1st Semester</option>
                <option>2nd Semester</option>
              </select>
            </div>
            <div class="col-12 col-md-3 col-xl-3 ms-auto">
              <select id="sortBy" class="form-select">
                <option value="az">Sort: A → Z</option>
                <option value="sy">Sort: School Year</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Grid -->
        <div id="coursesGrid" class="row g-3"></div>
      </div>
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Auth + Data (UPDATED to match backend) -->
  <script>
    const API_BASE = 'http://localhost:5000';

    // Require logged-in student
    const userData = JSON.parse(localStorage.getItem("user") || "{}");
    if (!userData || !userData.userId || !userData.isStudent) {
      window.location.href = "/STUDENT/login/login.html";
    }

    // === Initials-only header name ===
    function initialsFrom(str) {
      if (!str) return "";
      const s = String(str).trim();
      if (!s) return "";
      if (s.includes("@")) {
        const local = s.split("@")[0];
        const parts = local.split(/[.\-_]+/).filter(Boolean);
        return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : local.slice(0, 2)).toUpperCase();
      }
      const parts = s.split(/[\s\-]+/).filter(Boolean);
      return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : parts[0].slice(0, 2)).toUpperCase();
    }
    (() => {
      const el = document.getElementById("Username");
      if (!el) return;
      const displayName = userData.fullName || userData.username || userData.email || "";
      const initials = initialsFrom(displayName) || "?";
      el.textContent = initials;
      el.title = displayName;
      el.setAttribute("aria-label", displayName);
    })();

    // Local state
    const favKey = 'courseFavs';
    const favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
    let myCourses = [];

    // --- robust timestamp parsing ---
    function toDateMaybe(v) {
      if (v == null && v !== 0) return null;
      if (v && typeof v === 'object') {
        if (typeof v.toDate === 'function') { try { return v.toDate(); } catch {} }
        if (v._seconds != null) {
          return new Date(v._seconds * 1000 + (v._nanoseconds ? Math.floor(v._nanoseconds/1e6) : 0));
        }
        if ('seconds' in v) {
          return new Date((v.seconds || 0) * 1000 + (v.nanoseconds ? Math.floor(v.nanoseconds/1e6) : 0));
        }
      }
      if (typeof v === 'number') return new Date(v < 1e12 ? v * 1000 : v);
      const d = new Date(String(v));
      return isNaN(d.getTime()) ? null : d;
    }

    // Try multiple publish field names (defensive)
    function getPublishDate(course) {
      const fields = [
        'publishAt','scheduledAt','scheduleAt','startAt','startDate',
        'goLiveAt','goLiveDate','publishDate','publishOn'
      ];
      for (const f of fields) {
        if (course && course[f] != null) {
          const d = toDateMaybe(course[f]);
          if (d) return d;
        }
      }
      return null;
    }

    // Fetch courses (server hides scheduled by default for students)
    async function fetchCoursesForStudent() {
      const url = `${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/courses?includeTeacher=true&visibility=student&onlyPublished=true`;
      const res = await fetch(url);
      const js  = await res.json().catch(() => ({}));
      if (!res.ok || !js.success) throw new Error(js.message || 'Failed to load courses');

      const now = Date.now();

      // Normalize + safeguard (still hide any stray scheduled/archived)
      myCourses = (js.courses || [])
        .map(c => {
          const createdAt = toDateMaybe(c.createdAt);
          const publishAt = getPublishDate(c);
          const archived  = !!c.archived;
          return {
            id: c.id,
            title: c.title || 'Untitled Course',
            description: c.description || '',
            category: c.category || 'General',
            teacherName: c.teacherName || 'Teacher',
            courseNumber: c.courseNumber || null,
            createdAt,
            publishAt,
            archived
          };
        })
        .filter(c => !c.archived && !(c.publishAt && c.publishAt.getTime() > now));

      populateSchoolYearFromCategories(myCourses);
      renderGrid();
    }

    // Reuse School Year select to filter by Category
    function populateSchoolYearFromCategories(list) {
      const sel = document.getElementById('filterSchoolYear');
      const cats = Array.from(new Set(list.map(c => c.category))).sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = '<option value="All">All School Years</option>';
      cats.forEach(cat => {
        const o = document.createElement('option');
        o.value = `cat:${cat}`;
        o.textContent = cat;
        sel.appendChild(o);
      });

      const semSel = document.getElementById('filterSemester');
      if (semSel) semSel.value = 'All';
    }

    function renderGrid() {
      const q   = (document.getElementById('searchInput').value || '').toLowerCase();
      const sy  = document.getElementById('filterSchoolYear').value;
      const sort = document.getElementById('sortBy').value;

      let list = myCourses.slice()
        .filter(c => {
          if (sy === 'All') return true;
          if (sy.startsWith('cat:')) {
            const cat = sy.slice(4);
            return c.category === cat;
          }
          return true;
        })
        .filter(c => (c.title + ' ' + c.description + ' ' + c.teacherName).toLowerCase().includes(q));

      if (sort === 'az') {
        list.sort((a,b)=> a.title.localeCompare(b.title));
      } else if (sort === 'sy') {
        list.sort((a,b)=> (a.category || '').localeCompare(b.category || ''));
      }

      const grid = document.getElementById('coursesGrid');
      grid.innerHTML = '';

      if (!list.length) {
        grid.innerHTML = `<div class="col-12"><div class="ui-card text-center">No courses found.</div></div>`;
        return;
      }

      list.forEach(c => {
        const isFav  = favs.has(c.id);
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-xl-4 col-xxl-3';
        col.innerHTML = `
          <div class="course-card">
            <div class="course-head">
              <div class="d-flex align-items-center gap-2">
                <div class="rounded-circle border d-flex align-items-center justify-content-center" style="width:40px;height:40px;background:#fff;">
                  <i class="bi bi-journal-text"></i>
                </div>
                <div>
                  <h3 class="course-title">${escapeHTML(c.title)}</h3>
                  <div class="course-meta">Teacher: ${escapeHTML(c.teacherName)}${c.courseNumber ? ' • #'+c.courseNumber : ''}</div>
                </div>
              </div>
              <button class="favorite ${isFav ? 'active' : ''}" title="Favorite" data-id="${c.id}">
                <i class="bi ${isFav ? 'bi-star-fill' : 'bi-star'} fs-5"></i>
              </button>
            </div>

            <p class="mt-2 mb-2">${escapeHTML(c.description)}</p>

            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="badge-soft"><i class="bi bi-bookmark"></i>${escapeHTML(c.category)}</span>
              <span class="text-muted small">${c.createdAt ? 'Added: ' + c.createdAt.toLocaleDateString() : ''}</span>
            </div>

            <div class="d-flex flex-wrap gap-2">
              <a href="/STUDENT/modules/list.html?id=${encodeURIComponent(c.id)}" class="btn btn-sm btn-amber">Continue</a>
              <a href="/STUDENT/modules/list.html?id=${encodeURIComponent(c.id)}" class="btn btn-sm btn-amber-outline">View Course</a>
            </div>
          </div>
        `;
        grid.appendChild(col);
      });

      // Favorite handlers
      document.querySelectorAll('.favorite').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (favs.has(id)) favs.delete(id); else favs.add(id);
          localStorage.setItem(favKey, JSON.stringify(Array.from(favs)));
          renderGrid();
        });
      });
    }

    function escapeHTML(str='') {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // Boot / Wiring
    document.addEventListener('DOMContentLoaded', async () => {
      const headerSearch = document.getElementById('courseSearch');
      const bodySearch   = document.getElementById('searchInput');
      headerSearch.addEventListener('input', (e) => { bodySearch.value = e.target.value; renderGrid(); });
      bodySearch.addEventListener('input', renderGrid);

      document.getElementById('filterSchoolYear').addEventListener('change', renderGrid);
      document.getElementById('filterSemester').addEventListener('change', renderGrid);
      document.getElementById('sortBy').addEventListener('change', renderGrid);

      try {
        await fetchCoursesForStudent();
      } catch (err) {
        console.error(err);
        const grid = document.getElementById('coursesGrid');
        grid.innerHTML = `<div class="col-12"><div class="ui-card text-center text-danger">Failed to load your courses.</div></div>`;
      }
    });

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
