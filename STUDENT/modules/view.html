<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Module Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Reuse student theme -->
  <link rel="stylesheet" href="../modules/list.css" />
 
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" id="lessonSearch" placeholder="Search lessons in this module..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h1 class="page-title brand mb-0" id="moduleTitle">Module</h1>
          <div class="d-flex gap-2">
            <a id="backToCourseBtn" class="btn btn-sm btn-amber-outline" href="#">
              <i class="bi bi-arrow-left"></i> Back to Modules
            </a>
            <span id="completeBadge" class="badge text-bg-secondary align-self-center" style="display: flex; align-items: center; justify-content: center; min-width: 110px; min-height: 32px;">Not completed</span>
            <button id="completeBtn" class="btn btn-sm btn-amber">
              <i class="bi bi-check2-circle me-1"></i> Mark Module Complete
            </button>
          </div>
        </div>

        <!-- Module meta -->
        <div class="ui-card card-themed mb-3 mt-3" id="moduleMeta" style="display:none;">
          <div class="ui-card-head">
            <h2 class="ui-card-title">
              <i class="bi bi-journal-text"></i>
              <span id="metaTitle">—</span>
            </h2>
            <div class="text-name" id="metaCourse">Course: —</div>
          </div>
          <div class="row g-2">
            <div class="col-12 col-md-8">
              <div class="small text-light" id="metaLessons">Lessons: 0</div>
            </div>
            <div class="col-12 col-md-4 text-md-end">
              <a id="quizBtn" class="btn btn-sm btn-amber-outline d-none">
                <i class="bi bi-ui-checks-grid me-1"></i> Take Quiz
              </a>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <!-- Left: lessons list -->
          <div class="col-12 col-lg-4">
            <div class="card shadow border-0 rounded-4 viewer-card p-3">
              <h5 class="mb-2">Lessons</h5>
              <div id="lessonList" class="d-grid gap-2"></div>
            </div>
          </div>

          <!-- Right: lesson viewer -->
          <div class="col-12 col-lg-8">
            <div class="card shadow border-0 rounded-4 viewer-card p-3">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <span class="badge bg-primary me-2" id="moduleNumberBadge">Module #—</span>
                  <span class="badge lesson-pill" id="lessonIndexBadge">Lesson —</span>
                </div>
                <div class="lesson-nav">
                  <button id="prevLesson" class="btn btn-sm btn-amber-outline"><i class="bi bi-arrow-left"></i> Prev</button>
                  <button id="nextLesson" class="btn btn-sm btn-amber-outline">Next <i class="bi bi-arrow-right"></i></button>
                </div>
              </div>

              <h3 class="mt-3" id="lessonTitle">(No Title)</h3>
              <div class="safe-pre text-secondary" id="lessonBody">(No Content)</div>

              <hr class="my-3" />
              <h6 class="mb-2">Attachments</h6>
              <div id="attachments"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== File Preview Modal (matches teacher) ===== -->
  <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center gap-2" id="filePreviewModalLabel">Open file – Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="spinner-wrap" id="filePreviewSpinner">
            <div class="text-center text-white">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div class="mt-2 small">Preparing preview…</div>
            </div>
          </div>
          <div class="preview-wrap" id="filePreviewContent"></div>
        </div>

        <div class="modal-footer" id="filePreviewFooter">
          <div class="small" id="fileInfoText">Type: <span id="fileTypeText">File</span></div>
          <a id="openInNewTabBtn" href="#" target="_blank" rel="noopener" class="btn btn-amber">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open in New Tab
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Page Logic -->
  <script>
    const API_BASE = 'http://localhost:5000';
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user || !user.userId || !user.isStudent) {
      window.location.href = "/STUDENT/login/login.html";
    }

    // === Initials-only header display ===
    function initialsFrom(str) {
      if (!str) return "";
      const s = String(str).trim();
      if (!s) return "";
      if (s.includes("@")) {
        const local = s.split("@")[0];
        const parts = local.split(/[.\-_]+/).filter(Boolean);
        return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : local.slice(0, 2)).toUpperCase();
      }
      const parts = s.split(/[\s\-]+/).filter(Boolean);
      return (parts.length >= 2 ? parts[0][0] + parts[parts.length - 1][0] : parts[0].slice(0, 2)).toUpperCase();
    }
    (function setUserHeader(){
      const userData = JSON.parse(localStorage.getItem("user") || "{}");
      const userId = userData.userId || userData.uid || userData.id || userData.email;
      if (!userId) { window.location.href = "../login/login.html"; return; }
      const displayName = userData.fullName || userData.username || userData.email || "Student";
      const initials = initialsFrom(displayName) || "?";
      const el = document.getElementById("Username");
      el.textContent = initials;
      el.title = displayName;
      el.setAttribute("aria-label", displayName);
      if (!userData.uid) {
        userData.uid = userId;
        localStorage.setItem("user", JSON.stringify(userData));
      }
    })();

    // === Escape HTML helper ===
    function escapeHTML(str='') {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // === URL / Preview helpers (MATCH TEACHER MODAL) ===
    function isYouTube(url='') {
      try {
        const u = new URL(url);
        const h = u.hostname.replace(/^www\./,'').toLowerCase();
        return ['youtu.be','youtube.com','m.youtube.com','music.youtube.com','youtube-nocookie.com'].includes(h);
      } catch { return false; }
    }
    function ytEmbed(url='') {
      try {
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./,'').toLowerCase();
        let id = '';
        let start = u.searchParams.get('start') || u.searchParams.get('t') || '';
        if (start && /^\d+s$/.test(start)) start = parseInt(start, 10);
        if (start && /^\d+$/.test(start)) start = parseInt(start, 10);
        if (!Number.isFinite(start)) start = '';
        if (host === 'youtu.be') id = u.pathname.replace(/^\//,'').split('/')[0];
        else {
          if (u.pathname.startsWith('/embed/')) id = u.pathname.split('/')[2] || '';
          if (!id) id = u.searchParams.get('v') || '';
        }
        if (!id) return null;
        const base = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}`;
        const qs = new URLSearchParams(); qs.set('rel','0'); if (start) qs.set('start', String(start));
        return `${base}?${qs.toString()}`;
      } catch { return null; }
    }
    function extFromUrl(u=''){ const c=String(u).split('?')[0].split('#')[0]; const p=c.split('.'); return p.length>1?p.pop().toLowerCase():''; }
    function kindFromUrl(url=''){
      if (isYouTube(url)) return 'youtube';
      const ext = extFromUrl(url);
      if (['mp4','webm','ogg','ogv','mov'].includes(ext)) return 'video';
      if (['mp3','wav','m4a','ogg','aac','flac'].includes(ext)) return 'audio';
      if (['jpg','jpeg','png','gif','bmp','webp','svg'].includes(ext)) return 'image';
      if (ext==='pdf') return 'pdf';
      if (['txt','csv','log'].includes(ext)) return 'text';
      if (['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)) return 'office';
      return 'other';
    }

    function setFileInfoUI(kind, url){
      const map = { youtube:'YouTube', video:'Video', audio:'Audio', image:'Image', pdf:'PDF', text:'Text/CSV', office:'Office Doc', other:'Link' };
      document.getElementById('fileTypeText').textContent = map[kind] || 'Link';
      document.getElementById('openInNewTabBtn').href = url || '#';
      // Put/refresh a badge next to the modal title like teacher
      const titleEl = document.getElementById('filePreviewModalLabel');
      let badge = document.getElementById('fileKindBadge');
      if (!badge) {
        badge = document.createElement('span');
        badge.id = 'fileKindBadge';
        badge.className = 'ms-2 badge rounded-pill bg-secondary-subtle text-secondary';
        titleEl.appendChild(badge);
      }
      badge.textContent = map[kind] || 'Link';
    }
    function showSpinner(show){ document.getElementById('filePreviewSpinner').style.display = show ? 'flex' : 'none'; }

    function renderFilePreviewInto(container, url){
      container.innerHTML=''; showSpinner(true);
      const done = ()=>showSpinner(false);
      const kind = kindFromUrl(url);

      if (kind === 'youtube') {
        const embed = ytEmbed(url);
        if (embed) {
          container.innerHTML = `
            <div class="ratio ratio-16x9">
              <iframe
                src="${embed}"
                title="YouTube video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
                style="border:0"></iframe>
            </div>`;
          return done();
        }
      }

      if (kind === 'image') {
        const img = new Image();
        img.onload = done; img.onerror = done; img.src = url; container.appendChild(img); return;
      }
      if (kind === 'pdf') {
        const iframe = document.createElement('iframe'); iframe.onload=done; iframe.onerror=done; iframe.src=url; container.appendChild(iframe); return;
      }
      if (kind === 'video') {
        const v=document.createElement('video'); v.controls=true; v.onloadeddata=done; v.onerror=done; v.src=url; container.appendChild(v); return;
      }
      if (kind === 'audio') {
        const a=document.createElement('audio'); a.controls=true; a.onloadeddata=done; a.onerror=done; a.src=url; container.appendChild(a); return;
      }
      if (kind === 'text') {
        const i=document.createElement('iframe'); i.onload=done; i.onerror=done; i.src=url; container.appendChild(i); return;
      }
      if (kind === 'office') {
        const gview=`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;
        const i=document.createElement('iframe'); i.onload=done; i.onerror=done; i.src=gview; container.appendChild(i); return;
      }

      // Fallback
      const obj=document.createElement('object'); obj.data=url; obj.type='application/octet-stream'; obj.onload=done; obj.onerror=done; container.appendChild(obj);
      setTimeout(done, 1000);
    }

    // For storage/external precedence when choosing URL
    function isStorageDomain(u='') {
      return /firebasestorage\.googleapis\.com|storage\.googleapis\.com/i.test(u);
    }
    function isExternalHttp(u='') {
      return /^https?:\/\//i.test(u) && !isStorageDomain(u) && !/localhost|127\.0\.0\.1:5000/i.test(u);
    }
    function bestFileUrl(att) {
      if (att.url && isExternalHttp(att.url)) return att.url;
      if (att.previewUrl) return att.previewUrl;
      if (att.url)       return att.url;
      if (att.publicUrl) return att.publicUrl;
      if (att.filePath)  return `http://127.0.0.1:5000${att.filePath}`;
      return '';
    }

    function openFilePreview(title, url){
      const kind = kindFromUrl(url);
      const titleEl = document.getElementById("filePreviewModalLabel");
      titleEl.textContent = (title || 'File') + ' – Preview';
      setFileInfoUI(kind, url);
      renderFilePreviewInto(document.getElementById("filePreviewContent"), url);
      new bootstrap.Modal(document.getElementById("filePreviewModal")).show();
    }

    // === Page state
    const params = new URLSearchParams(window.location.search);
    const moduleId = params.get('moduleId');
    const startIdx = parseInt(params.get('subIdx') || '0', 10) || 0;

    let moduleDoc = null;
    let currentIdx = 0;
    let lessonCount = 0;
    let courseId = null;

    async function fetchModule() {
      if (!moduleId) {
        alert('No moduleId provided.');
        window.location.href = '/STUDENT/courses/courses.html';
        return;
      }
      const res = await fetch(`${API_BASE}/modules/${encodeURIComponent(moduleId)}?t=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load module');

      moduleDoc = await res.json();
      courseId = moduleDoc.courseId || null;

      document.getElementById('moduleTitle').textContent = moduleDoc.title || 'Module';
      document.getElementById('metaTitle').textContent = moduleDoc.title || '—';
      document.getElementById('moduleNumberBadge').textContent = `Module #${moduleDoc.moduleNumber || ''}`;

      const back = document.getElementById('backToCourseBtn');
      if (courseId) back.href = `/STUDENT/modules/list.html?id=${encodeURIComponent(courseId)}`;
      else back.href = '/STUDENT/courses/courses.html';

      const subs = Array.isArray(moduleDoc.moduleSubTitles) ? moduleDoc.moduleSubTitles : [];
      const descs = Array.isArray(moduleDoc.moduleSubDescs) ? moduleDoc.moduleSubDescs : [];
      lessonCount = Math.max(moduleDoc.lessonCount || 0, subs.length, descs.length);
      document.getElementById('metaLessons').textContent = `Lessons: ${lessonCount}`;
      document.getElementById('moduleMeta').style.display = '';

      const list = document.getElementById('lessonList');
      list.innerHTML = '';
      for (let i=0; i<lessonCount; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn btn-sm lesson-pill text-start ${i===startIdx ? 'active' : ''}`;
        btn.textContent = `${i+1}. ${subs[i] || '(No Title)'}`;
        btn.addEventListener('click', () => showLesson(i));
        list.appendChild(btn);
      }

      try {
        if (courseId) {
          const cr = await fetch(`${API_BASE}/courses/${encodeURIComponent(courseId)}`);
          if (cr.ok) {
            const c = await cr.json();
            document.getElementById('metaCourse').textContent = `Course: ${c.title || '—'}`;
          }
        }
      } catch {}

      try {
        const qRes = await fetch(`${API_BASE}/quizzes`);
        if (qRes.ok) {
          const qJs = await qRes.json();
          const found = (qJs.quizzes || []).find(q => q.moduleId === moduleId);
          if (found) {
            const quizBtn = document.getElementById('quizBtn');
            quizBtn.classList.remove('d-none');
            const go = `/STUDENT/quiz/quiz.html?quizId=${encodeURIComponent(found.id)}&moduleId=${encodeURIComponent(moduleId)}${courseId ? '&courseId='+encodeURIComponent(courseId) : ''}`;
            quizBtn.href = go;
          }
        }
      } catch {}

      await refreshCompletion();
      showLesson(startIdx < lessonCount ? startIdx : 0);
    }

    async function refreshCompletion() {
      try {
        const r = await fetch(`${API_BASE}/users/${encodeURIComponent(user.email)}/modules/${encodeURIComponent(moduleId)}/isCompleted`);
        const j = await r.json().catch(()=>({completed:false}));
        const badge = document.getElementById('completeBadge');
        const btn = document.getElementById('completeBtn');
        if (j.completed) {
          badge.className = 'badge text-bg-success';
          badge.textContent = 'Completed';
          btn.classList.add('btn-success');
          btn.classList.remove('btn-amber');
          btn.innerHTML = '<i class="bi bi-check2-circle me-1"></i> Completed';
          btn.disabled = true;
        } else {
          badge.className = 'badge text-bg-secondary';
          badge.textContent = 'Not completed';
          btn.classList.remove('btn-success');
          btn.classList.add('btn-amber');
          btn.innerHTML = '<i class="bi bi-check2-circle me-1"></i> Mark Module Complete';
          btn.disabled = false;
        }
      } catch {}
    }

    function showLesson(idx) {
      currentIdx = Math.max(0, Math.min(idx, lessonCount - 1));
      document.querySelectorAll('#lessonList .lesson-pill').forEach((el, i) => {
        el.classList.toggle('active', i === currentIdx);
      });
      document.getElementById('lessonIndexBadge').textContent = `Lesson ${currentIdx + 1}`;

      const subs = moduleDoc.moduleSubTitles || [];
      const descs = moduleDoc.moduleSubDescs || [];
      const title = subs[currentIdx] || '(No Title)';
      const body  = descs[currentIdx] || '(No Content)';
      document.getElementById('lessonTitle').textContent = title;
      document.getElementById('lessonBody').textContent  = body;

      const wrap = document.getElementById('attachments');
      wrap.innerHTML = '';

      const atts = Array.isArray(moduleDoc.attachments)
        ? moduleDoc.attachments.filter(a => (a.lessonIdx ?? 0) === currentIdx)
        : [];

      if (!atts.length) {
        wrap.innerHTML = `<div class="text-muted">No attachments for this lesson.</div>`;
      } else {
        atts.forEach(att => {
          const item = document.createElement('div');
          item.className = 'attachment-item';

          const url = bestFileUrl(att);
          const label = att.originalName || att.description || att.videoDesc || att.url || 'Open file';
          const kind = isYouTube(url || att.url) ? 'Video' : (isExternalHttp(url) ? 'Link' : 'File');

          item.innerHTML = `
            <span class="badge attachment-badge me-2">${kind}</span>
            <button class="btn btn-link p-0 text-decoration-none" type="button">
              ${escapeHTML(label)}
            </button>
            ${
              att.description
                ? `<div class="small text-muted mt-1">${escapeHTML(att.description)}</div>`
                : att.videoDesc ? `<div class="small text-muted mt-1">${escapeHTML(att.videoDesc)}</div>` : ''
            }
          `;

          item.querySelector('button').addEventListener('click', () => openFilePreview(label, url));
          wrap.appendChild(item);
        });
      }

      document.getElementById('prevLesson').disabled = currentIdx <= 0;
      document.getElementById('nextLesson').disabled = currentIdx >= lessonCount - 1;
    }

    async function markComplete() {
      try {
        const res = await fetch(`${API_BASE}/mark-module-complete`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email: user.email, moduleId })
        });
        const js = await res.json().catch(()=>({success:false}));
        if (!js.success) throw new Error(js.message || 'Failed to mark complete');
        await refreshCompletion();
        alert('✅ Module marked complete!');
      } catch (e) {
        console.error(e);
        alert('❌ Could not mark complete.');
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('prevLesson').addEventListener('click', () => showLesson(currentIdx - 1));
      document.getElementById('nextLesson').addEventListener('click', () => showLesson(currentIdx + 1));
      document.getElementById('completeBtn').addEventListener('click', markComplete);

      const searchTop = document.getElementById('lessonSearch');
      searchTop.addEventListener('input', () => {
        const q = searchTop.value.trim().toLowerCase();
        const subs = moduleDoc?.moduleSubTitles || [];
        const idx = subs.findIndex(s => (s || '').toLowerCase().includes(q));
        if (q && idx >= 0) showLesson(idx);
      });

      try {
        await fetchModule();
      } catch (e) {
        console.error(e);
        alert('Failed to load module.');
        window.location.href = '/STUDENT/courses/courses.html';
      }
    });

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
