<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Course Modules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Reuse your student theme -->
  <link rel="stylesheet" href="../modules/list.css" />
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" id="moduleSearch" placeholder="Search modules..." />
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username align-items-center" style="font-size: 14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h1 class="page-title brand mb-0" id="courseTitle">Course Modules</h1>
          <a id="backBtn" class="btn btn-sm btn-amber-outline" href="/STUDENT/courses/courses.html">
            <i class="bi bi-arrow-left"></i> Back to My Courses
          </a>
        </div>

        <!-- Course meta -->
        <div class="ui-card card-themed mb-3 mt-3" id="courseMeta" style="display:none;">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-journal-text"></i> <span id="metaTitle">—</span></h2>
            <div class="text-name" id="metaTeacher">Teacher: —</div>
          </div>
          <div class="row g-2">
            <div class="col-12 col-md-8">
              <div class="small text-light" id="metaDesc">—</div>
            </div>
            <div class="col-6 col-md-2">
              <span class="badge-soft"><i class="bi bi-bookmark"></i><span id="metaCategory" class="ms-1">—</span></span>
            </div>
            <div class="col-6 col-md-2 text-md-end">
              <span class="text-light small" id="metaCreated">Added: —</span>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div class="row g-2 mb-3">
          <div class="col-12 col-md-6 col-xl-4">
            <div class="input-group">
              <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
              <input id="searchInput" type="search" class="form-control border-start-0" placeholder="Search by title or lesson..." />
            </div>
          </div>
          <div class="col-6 col-md-3 col-xl-2">
            <select id="sortBy" class="form-select">
              <option value="num">Sort: Module #</option>
              <option value="az">Sort: A → Z</option>
            </select>
          </div>
        </div>

        <!-- Modules list -->
        <div id="modulesGrid" class="row g-3"></div>
      </div>
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Page Logic -->
  <script>
    const API_BASE = 'http://localhost:5000';

    /* ========== Auth (Students-only, enforce S- prefix, expose global userData) ========== */
    (function guardStudentSession() {
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      const u = stored.user || stored;

      const isValid =
        !!u?.userId &&
        u?.isStudent === true &&
        /^S-/.test(String(u?.studentId || ''));

      if (!isValid) {
        try { localStorage.removeItem('user'); } catch {}
        // This file is under /STUDENT/modules/, go up one level
        window.location.replace('../login/login.html');
        return;
      }

      // Make session available globally
      window.currentUser = u;
      window.userData = u;

      // Header initials
      function initialsFrom(str) {
        if (!str) return "";
        const s = String(str).trim();
        if (!s) return "";
        if (s.includes("@")) {
          const local = s.split("@")[0];
          const parts = local.split(/[.\-_]+/).filter(Boolean);
          if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
          return local.slice(0, 2).toUpperCase();
        }
        const parts = s.split(/[\s\-]+/).filter(Boolean);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        return parts[0].slice(0, 2).toUpperCase();
      }
      const el = document.getElementById("Username");
      if (el) {
        const displayName = u.fullName || u.username || u.email || "Student";
        const initials = initialsFrom(displayName) || "?";
        el.textContent = initials;
        el.title = displayName;
        el.setAttribute("aria-label", displayName);
      }

      // Cross-tab tamper guard
      window.addEventListener("storage", (e) => {
        if (e.key === "user") {
          try {
            const next = JSON.parse(e.newValue || "null");
            const nu = (next && (next.user || next)) || null;
            const ok = !!nu?.userId && nu?.isStudent === true && /^S-/.test(String(nu?.studentId || ''));
            if (!ok) window.location.replace('../login/login.html');
          } catch {
            window.location.replace('../login/login.html');
          }
        }
      });
    })();

    /* ===================== Utility helpers ===================== */
    function escapeHTML(str='') {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // --- Timestamp helpers ---
    function tsToMs(ts){
      if (!ts) return null;
      if (typeof ts === 'number') return ts;
      if (typeof ts === 'string') {
        const t = Date.parse(ts);
        return Number.isFinite(t) ? t : null;
      }
      const s = ts._seconds ?? ts.seconds;
      const ns = ts._nanoseconds ?? ts.nanoseconds ?? 0;
      if (typeof s === 'number') return (s * 1000) + Math.floor(ns / 1e6);
      const d = new Date(ts);
      return Number.isFinite(d.getTime()) ? d.getTime() : null;
    }
    function isPublished(m){
      const at = tsToMs(m.publishAt);
      return at === null || at <= Date.now(); // treat no publishAt as published
    }
    function isVisibleToStudent(m){
      return (m.archived !== true) && isPublished(m);
    }

    /* ===================== Page data ===================== */
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');
    if (!courseId) {
      alert("No course id provided.");
      window.location.href = "/STUDENT/courses/courses.html";
    }

    let modules = [];
    let studentClassIds = [];

    // find all classIds this student is enrolled in
    async function fetchStudentClassIds() {
      try {
        const res = await fetch(
          `${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/enrollments?includeTeacher=true`
        );
        const json = await res.json().catch(() => ({ success:false, enrollments:[] }));
        if (!json || json.success === false || !Array.isArray(json.enrollments)) return [];
        return json.enrollments.map(e => e.id || e.classId).filter(Boolean);
      } catch {
        return [];
      }
    }

    // Fetch course details + decrypted teacher name (via courses endpoint)
    async function fetchCourse() {
      const res = await fetch(`${API_BASE}/courses/${encodeURIComponent(courseId)}`);
      if (!res.ok) throw new Error('Failed to load course');
      const c = await res.json();

      document.getElementById('courseTitle').textContent = c.title || 'Course Modules';
      document.getElementById('metaTitle').textContent = c.title || '—';
      document.getElementById('metaCategory').textContent = c.category || '—';
      document.getElementById('metaDesc').textContent = c.description || '—';
      document.getElementById('metaCreated').textContent =
        c.createdAt && c.createdAt._seconds ? new Date(c.createdAt._seconds*1000).toLocaleDateString() : '—';

      // Decrypted teacher name via student courses API
      try {
        const tcRes = await fetch(
          `${API_BASE}/api/students/${encodeURIComponent(userData.userId)}/courses?includeTeacher=true&courseArchived=include`
        );
        const tcJson = await tcRes.json().catch(() => ({ success:false, courses:[] }));
        let teacherName = '—';
        if (tcJson && tcJson.success && Array.isArray(tcJson.courses)) {
          const match = tcJson.courses.find(x => (x.id || x.courseId) === courseId);
          if (match && match.teacherName) teacherName = match.teacherName;
        }
        document.getElementById('metaTeacher').textContent = `Teacher: ${teacherName}`;
      } catch {
        document.getElementById('metaTeacher').textContent = `Teacher: —`;
      }

      document.getElementById('courseMeta').style.display = '';
    }

    // Fetch only modules assigned to the student's classIds AND pull per-lesson progress
    async function fetchModules() {
      if (!studentClassIds.length) {
        studentClassIds = await fetchStudentClassIds();
      }

      if (!studentClassIds.length) {
        modules = [];
        renderModules();
        return;
      }

      // Fetch per enrolled class
      const perClassFetches = studentClassIds.map(async cid => {
        const res = await fetch(
          `${API_BASE}/courses/${encodeURIComponent(courseId)}/modules?classId=${encodeURIComponent(cid)}`
        );
        if (!res.ok) return [];
        return res.json();
      });

      const results = await Promise.all(perClassFetches);
      // Flatten + de-dupe by module id
      const byId = new Map();
      results.flat().forEach(m => { if (m && m.id) byId.set(m.id, m); });

      // Hide archived or not-yet-published
      const visible = Array.from(byId.values()).filter(isVisibleToStudent);

      // Pull per-lesson progress for each module
      const email = userData.email;
      const withProgress = visible.map(async m => {
        try {
          const r = await fetch(`${API_BASE}/users/${encodeURIComponent(email)}/modules/${encodeURIComponent(m.id)}/lessons/completion`);
          const j = await r.json().catch(()=>({completedIdx:[], lessonCount: m.moduleSubTitles?.length || m.lessonCount || 0}));
          const lessonCount = Number.isFinite(j.lessonCount) ? j.lessonCount : 0;
          const completedCount = Array.isArray(j.completedIdx) ? j.completedIdx.length : 0;
          const pct = lessonCount > 0 ? Math.round((completedCount / lessonCount) * 100) : 0;
          const completed = (lessonCount > 0) && (completedCount === lessonCount);
          return { ...m, __completedLessons: completedCount, __lessonCount: lessonCount, progressPct: pct, completed };
        } catch {
          // On error, fallback to 0% and not completed
          const lc = m.moduleSubTitles?.length || m.lessonCount || 0;
          return { ...m, __completedLessons: 0, __lessonCount: lc, progressPct: 0, completed: false };
        }
      });

      modules = await Promise.all(withProgress);
      renderModules();
    }

    function renderProgressPill(m) {
      const pct = Number.isFinite(m.progressPct) ? m.progressPct : 0;
      const label = (pct === 100) ? 'Completed' : 'In progress';
      const stateClass = (pct === 100) ? 'text-bg-success' : 'text-bg-secondary';
      const countText = (Number.isFinite(m.__completedLessons) && Number.isFinite(m.__lessonCount))
        ? `${m.__completedLessons}/${m.__lessonCount} lessons`
        : '';

      return `
        <div class="progress-wrap text-end">
          <div class="progress progress-xs mb-1" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100" style="height:6px;">
            <div class="progress-bar ${pct===100?'bg-success':''}" style="width:${pct}%"></div>
          </div>
          <div class="progress-label text-muted">
            ${pct}% • ${countText} • <span class="badge ${stateClass}">${label}</span>
          </div>
        </div>
      `;
    }

    function primaryCtaText(m) {
      if (m.progressPct >= 100) return 'Review';
      if (m.progressPct > 0) return 'Continue';
      return 'Start';
    }

    function renderModules() {
      const q = (document.getElementById('searchInput').value || document.getElementById('moduleSearch').value || '').toLowerCase();
      const sort = document.getElementById('sortBy').value;

      let list = modules.slice().filter(m => {
        const hay = `${m.title || ''} ${(m.moduleSubTitles||[]).join(' ')}`.toLowerCase();
        return hay.includes(q);
      });

      if (sort === 'num') list.sort((a,b)=>(a.moduleNumber||0)-(b.moduleNumber||0));
      else if (sort === 'az') list.sort((a,b)=>(a.title||'').localeCompare(b.title||''));

      const grid = document.getElementById('modulesGrid');
      grid.innerHTML = '';

      if (!list.length) {
        grid.innerHTML = `<div class="col-12"><div class="ui-card text-center">No modules yet.</div></div>`;
        return;
      }

      list.forEach(m => {
        const col = document.createElement('div');
        col.className = 'col-12';
        col.innerHTML = `
          <div class="card h-100 shadow border-0 rounded-4" style="background:#f8fafc;">
            <div class="card-body d-flex flex-column flex-md-row align-items-stretch p-4">
              <div class="flex-grow-1 pe-md-4">
                <div class="d-flex align-items-center mb-2">
                  <span class="badge bg-primary me-2" style="font-size:1rem;">Module #${m.moduleNumber || ''}</span>
                  <h4 class="card-title mb-0 text-dark">${escapeHTML(m.title || 'Untitled Module')}</h4>
                </div>
                ${(Array.isArray(m.moduleSubTitles) && m.moduleSubTitles.length)
                  ? `<div class="small text-muted">Lessons: ${m.moduleSubTitles.map(escapeHTML).join(' • ')}</div>`
                  : `<div class="small text-muted">(No lesson subtitles)</div>`
                }
              </div>
              <div class="d-flex flex-column justify-content-between align-items-end ms-md-4 mt-3 mt-md-0">
                ${renderProgressPill(m)}
                <a class="btn btn-amber btn-sm mt-2" href="/STUDENT/modules/view.html?moduleId=${encodeURIComponent(m.id)}">
                  <i class="bi bi-play-circle me-1"></i> ${primaryCtaText(m)}
                </a>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(col);
      });
    }

    // Wiring
    document.addEventListener('DOMContentLoaded', async () => {
      const topSearch = document.getElementById('moduleSearch');
      const bodySearch = document.getElementById('searchInput');
      topSearch.addEventListener('input', renderModules);
      bodySearch.addEventListener('input', renderModules);
      document.getElementById('sortBy').addEventListener('change', renderModules);

      try {
        await fetchCourse();
        studentClassIds = await fetchStudentClassIds();
        await fetchModules();
      } catch (e) {
        console.error(e);
        document.getElementById('modulesGrid').innerHTML =
          `<div class="col-12"><div class="ui-card text-center text-danger">Failed to load modules.</div></div>`;
      }
    });

    function logoutUser() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
