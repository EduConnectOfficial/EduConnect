<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - View Thread</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Page styles -->
  <link rel="stylesheet" href="../forum/forum.css" />

  <style>
    .wrap-anywhere{overflow-wrap:anywhere}
    .skeleton{position:relative;border-radius:.5rem;background:#eef2f7;overflow:hidden;min-height:56px}
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);transform:translateX(-100%);animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
    .empty-state{padding:1rem;border:1px dashed #d9dee3;border-radius:.75rem;color:#6c757d;background:#fafbfc}
    .btn-close-footer{background:#f1f3f5;border:1px solid #dee2e6;border-radius:.5rem;padding:.375rem .75rem}
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- Header -->
      <header class="header-top">
        <div class="brand">
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" placeholder="Search..." aria-label="Search site" />
          <i class="bi bi-search"></i>
        </div>
        <button class="profile-btn" aria-label="Open profile menu">
          <i class="bi bi-person-circle"></i>
          <span id="Username" class="username" style="font-size:14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-10 col-xxl-8">

            <!-- THREAD / ANNOUNCEMENT DETAIL -->
            <div class="ui-card card-themed mb-4" id="threadContainer">
              <div class="p-3 border-bottom" id="threadDetails">
                <div class="skeleton rounded-3 mb-2"></div>
                <div class="skeleton rounded-3"></div>
              </div>
            </div>

            <!-- COMMENTS (hidden when viewing an announcement) -->
            <div class="ui-card card-themed" id="commentsCard">
              <div class="ui-card-head d-flex justify-content-between align-items-center">
                <h2 class="ui-card-title m-0"><i class="bi bi-chat-text"></i> Comments</h2>
                <span class="ui-subtext" id="replyCount">Loading…</span>
              </div>

              <!-- Top-level Comment Form -->
              <form id="replyForm" class="p-3 border-bottom" novalidate>
                <div class="fb-composer">
                  <div class="fb-avatar" id="meAvatar" aria-hidden="true">ME</div>
                  <div class="flex-grow-1">
                    <div class="composer-box">
                      <textarea id="replyText" class="form-control border-0 bg-transparent p-0"
                                rows="1" placeholder="Write a comment..." required
                                style="resize:none"></textarea>
                      <div class="invalid-feedback">Please enter a comment.</div>
                    </div>
                    <div class="composer-actions">
                      <button type="submit" class="btn btn-amber btn-sm mt-2">
                        <i class="bi bi-send me-1"></i> Comment
                      </button>
                    </div>
                  </div>
                </div>
              </form>

              <!-- Replies -->
              <div id="repliesList" class="p-3">
                <div class="skeleton rounded-3"></div>
                <div class="skeleton rounded-3 mt-2"></div>
              </div>
            </div>

          </div>
        </div>
      </div> <!-- /content -->
    </div>
  </div>

  <!-- ========================= -->
  <!-- Modals (Thread + Reply)   -->
  <!-- ========================= -->

  <!-- Thread: Delete Confirm -->
  <div class="modal fade" id="threadDeleteModal" tabindex="-1" aria-labelledby="threadDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="threadDeleteLabel"><i class="bi bi-trash3 me-2 text-danger"></i>Delete Thread</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">This will also remove all comments and cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmThreadDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Thread: Edit -->
  <div class="modal fade" id="threadEditModal" tabindex="-1" aria-labelledby="threadEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="threadEditLabel"><i class="bi bi-pencil-square me-2"></i>Edit Thread</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="threadEditForm" novalidate>
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="editThreadTitle" required minlength="3" />
              <div class="invalid-feedback">Please enter a title (min 3 characters).</div>
            </div>
            <div class="mb-0">
              <label class="form-label">Text</label>
              <textarea class="form-control" id="editThreadText" rows="4" required minlength="5"></textarea>
              <div class="invalid-feedback">Please enter some details (min 5 characters).</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveThreadEditBtn" class="btn btn-amber">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reply: Delete Confirm -->
  <div class="modal fade" id="replyDeleteModal" tabindex="-1" aria-labelledby="replyDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="replyDeleteLabel"><i class="bi bi-trash3 me-2 text-danger"></i>Delete Comment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Are you sure you want to delete this comment?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmReplyDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reply: Edit -->
  <div class="modal fade" id="replyEditModal" tabindex="-1" aria-labelledby="replyEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="replyEditLabel"><i class="bi bi-pencil-square me-2"></i>Edit Comment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="replyEditForm" novalidate>
            <div class="mb-0">
              <label class="form-label">Comment</label>
              <textarea class="form-control" id="editReplyText" rows="3" required minlength="1"></textarea>
              <div class="invalid-feedback">Comment can’t be empty.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-close-footer" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveReplyEditBtn" class="btn btn-amber">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Page Logic -->
  <script>
    /* ===== API base (Railway-safe) ===== */
    function resolveApiBase() {
      const meta = document.querySelector('meta[name="x-api-base"]');
      const override = meta?.content?.trim();
      if (override) return override.replace(/\/+$/, '');
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return 'http://localhost:5000';
      return ''; // same-origin in production
    }
    const BASE = resolveApiBase();
    const API_BASE = `${BASE}/api/forum`;
    const CORE_API = BASE; // /api/announcements lives under core server

    const qs = sel => document.querySelector(sel);

    // Bearer auth (if token is stored)
    function authHeaders(extra = {}) {
      const token = localStorage.getItem("authToken");
      return { ...(token ? { "Authorization": `Bearer ${token}` } : {}), ...extra };
    }

    // Safe helpers
    function escapeHtml(s=''){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])).replace(/'/g,'&#39;');}
    function toLocal(dt){
      if(!dt) return '';
      if(dt._seconds) return new Date(dt._seconds*1000).toLocaleString();
      if(dt.seconds)  return new Date(dt.seconds*1000).toLocaleString();
      if(dt.toMillis) return new Date(dt.toMillis()).toLocaleString();
      const t=Date.parse(dt);
      return Number.isFinite(t)?new Date(t).toLocaleString():'';
    }
    function initialsFrom(str){
      if(!str) return "?";
      const s=String(str).trim();
      if(!s) return "?";
      if(s.includes("@")){
        const local=s.split("@")[0];
        const parts=local.split(/[.\-_]+/).filter(Boolean);
        return (parts.length>=2?(parts[0][0]+parts[parts.length-1][0]):local.slice(0,2)).toUpperCase();
      }
      const parts=s.split(/[\s\-]+/).filter(Boolean);
      return (parts.length>=2?(parts[0][0]+parts[parts.length-1][0]):parts[0].slice(0,2)).toUpperCase();
    }

    // Robust JSON fetch (adds auth + handles non-JSON gracefully)
    async function fetchJSON(url, opts={}){
      const merged = {
        ...opts,
        headers: { ...authHeaders(), ...(opts.headers || {}) }
      };
      const res = await fetch(url, merged);
      const ct = res.headers.get('content-type') || '';
      const text = await res.text();
      let json = {};
      if (ct.includes('application/json')) { try{ json = JSON.parse(text || '{}'); }catch{} }
      if (!res.ok || json.success === false) {
        const msg = json.message || `${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return json;
    }

    // Auth + header initials
    (function auth(){
      const userData = JSON.parse(localStorage.getItem("user") || "{}");
      const userId = userData.userId || userData.uid || userData.id || userData.email;
      if (!userId) { window.location.href = "../login/login.html"; return; }
      const displayName = userData.fullName || userData.username || userData.email || "Student";
      const init = initialsFrom(displayName) || "?";
      const el = document.getElementById("Username");
      el.textContent = init; el.title = displayName; el.setAttribute("aria-label", displayName);
      if (!userData.uid) { userData.uid = userId; localStorage.setItem("user", JSON.stringify(userData)); }
      const meAvatarEl = document.getElementById("meAvatar"); if (meAvatarEl) meAvatarEl.textContent = init;
      window.__user = userData;
    })();

    // Utilities
    const params = new URLSearchParams(location.search);
    const threadId = params.get("id");
    const annId    = params.get("ann");

    const authorDisplayName = o => o?.author?.fullName || o?.authorFullName || o?.author?.username || o?.author?.email || "User";
    const timeHtml = dt => {
      const t = toLocal(dt);
      return `<span class="time" title="${escapeHtml(t)}">${escapeHtml(t)}</span>`;
    };

    // Modal refs + state
    let threadDeleteModal, threadEditModal, replyDeleteModal, replyEditModal;
    let thread = null, currentReply = null, currentReplyId = null;

    document.addEventListener('DOMContentLoaded', () => {
      threadDeleteModal = new bootstrap.Modal(document.getElementById('threadDeleteModal'));
      threadEditModal   = new bootstrap.Modal(document.getElementById('threadEditModal'));
      replyDeleteModal  = new bootstrap.Modal(document.getElementById('replyDeleteModal'));
      replyEditModal    = new bootstrap.Modal(document.getElementById('replyEditModal'));

      document.getElementById('confirmThreadDeleteBtn')?.addEventListener('click', confirmThreadDelete);
      document.getElementById('saveThreadEditBtn')?.addEventListener('click', saveThreadEdit);
      document.getElementById('confirmReplyDeleteBtn')?.addEventListener('click', confirmReplyDelete);
      document.getElementById('saveReplyEditBtn')?.addEventListener('click', saveReplyEdit);
    });

    /* ===========================
       Teacher name lookup (ensures Name, not ID)
    ============================*/
    const teacherNameCache = new Map();
    async function fetchTeacherNameById(teacherId) {
      if (!teacherId) return null;
      if (teacherNameCache.has(teacherId)) return teacherNameCache.get(teacherId);

      // Try /api/teachers/:id
      try {
        const t = await fetchJSON(`${CORE_API}/api/teachers/${encodeURIComponent(teacherId)}`);
        const name = t?.teacher?.fullName || t?.teacher?.name || t?.teacher?.displayName;
        if (name) { teacherNameCache.set(teacherId, name); return name; }
      } catch {}

      // Try /api/users/:id
      try {
        const u = await fetchJSON(`${CORE_API}/api/users/${encodeURIComponent(teacherId)}`);
        const name = u?.user?.fullName || u?.user?.name || u?.user?.displayName;
        if (name) { teacherNameCache.set(teacherId, name); return name; }
      } catch {}

      teacherNameCache.set(teacherId, null);
      return null;
    }

    /* ===========================
       Thread load & render
    ============================*/
    async function loadThread(){
      try{
        const j = await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}`);
        thread = j.data;
        const tAuthorName = authorDisplayName(thread);
        const isOwner = __user?.uid && (String(thread.author?.uid) === String(__user.uid));
        const inits = initialsFrom(tAuthorName);

        const actionHtml = isOwner ? `
          <div class="dropdown ms-2">
            <button class="kebab" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Thread actions">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><button class="dropdown-item action-edit-thread"><i class="bi bi-pencil-square"></i> Edit</button></li>
              <li><button class="dropdown-item text-danger action-delete-thread"><i class="bi bi-trash3"></i> Delete</button></li>
            </ul>
          </div>` : ``;

        qs("#threadDetails").innerHTML = `
          <div class="thread-head">
            <div class="fb-avatar" aria-hidden="true">${escapeHtml(inits)}</div>
            <div class="title-wrap flex-grow-1">
              <h3 class="mb-1 wrap-anywhere">${escapeHtml(thread.title || '')}</h3>
              <div class="meta">
                <strong class="wrap-anywhere">${escapeHtml(tAuthorName)}</strong>
                • <span class="wrap-anywhere">${escapeHtml(thread.courseTitle || '')}</span>
                • ${timeHtml(thread.createdAt)}
              </div>
              <p class="mt-2 mb-0 wrap-anywhere">${escapeHtml(thread.text || '')}</p>
            </div>
            ${actionHtml}
          </div>`;

        if (isOwner) {
          qs(".action-delete-thread")?.addEventListener("click", () => threadDeleteModal?.show());
          qs(".action-edit-thread")?.addEventListener("click", openThreadEditModal);
        }

        await loadReplies();
      }catch(err){
        console.error(err);
        qs("#threadDetails").innerHTML = `<div class="alert alert-danger">Failed to load thread.</div>`;
      }
    }

    /* ===========================
       Announcement DETAIL view (no extra card)
    ============================*/
    async function loadAnnouncementDetail(){
      const userId = __user.uid || __user.userId || __user.email;
      try{
        const j = await fetchJSON(`${CORE_API}/api/announcements/student/${encodeURIComponent(userId)}`);
        const list = Array.isArray(j?.announcements) ? j.announcements : [];
        const a = list.find(x => String(x.id) === String(annId));
        if (!a) {
          qs("#threadDetails").innerHTML = `<div class="alert alert-warning">Announcement not found or not visible.</div>`;
          return;
        }

        // Ensure we show a NAME, not ID
        let poster = a.teacherName || a.teacher || null;
        if (!poster && a.teacherId) {
          const lookedUp = await fetchTeacherNameById(a.teacherId);
          if (lookedUp) poster = lookedUp;
        }
        poster = poster || 'Teacher';

        const published = toLocal(a.publishAt || a.createdAt);
        const expires   = a.expiresAt ? toLocal(a.expiresAt) : '—';

        qs("#threadDetails").innerHTML = `
          <div class="thread-head">
            <div class="fb-avatar" aria-hidden="true">AN</div>
            <div class="title-wrap flex-grow-1">
              <h3 class="mb-1 wrap-anywhere">${escapeHtml(a.title || 'Announcement')}</h3>
              <div class="meta">
                <strong class="wrap-anywhere">${escapeHtml(poster)}</strong>
                • Published: ${escapeHtml(published)}
                • Expires: ${escapeHtml(expires)}
              </div>
              <p class="mt-2 mb-0 wrap-anywhere">${escapeHtml(a.content || '')}</p>
            </div>
          </div>`;

        // Hide comments in announcement mode
        qs('#commentsCard').style.display = 'none';
      }catch(err){
        console.error(err);
        qs("#threadDetails").innerHTML = `<div class="alert alert-danger">Failed to load announcement.</div>`;
      }
    }

    /* ===========================
       Replies (only for thread mode)
    ============================*/
    function buildReplyTree(flat){
      const map = Object.create(null);
      flat.forEach(r => { r.children = []; map[r.id] = r; });
      const roots = [];
      flat.forEach(r => {
        if (r.parentId && map[r.parentId]) map[r.parentId].children.push(r);
        else roots.push(r);
      });
      roots.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      (function sortKids(list){ list.sort((a,b)=> new Date(a.createdAt)-new Date(b.createdAt)); list.forEach(x=>sortKids(x.children)); })(roots);
      return roots;
    }

    function renderRepliesRecursive(list, container, parentName=null){
      list.forEach(r => {
        const name = authorDisplayName(r);
        const inits = initialsFrom(name);
        const isOwn = __user?.uid && (String(r.author?.uid) === String(__user.uid));
        const childCount = r.children?.length || 0;
        const collapseId = `replies-${r.id}`;

        const wrap = document.createElement('div');
        wrap.className = 'fb-comment';
        wrap.innerHTML = `
          <div class="fb-avatar" aria-hidden="true">${escapeHtml(inits)}</div>
          <div class="fb-body">
            <div class="fb-bubble">
              ${isOwn ? `
              <div class="bubble-kebab dropdown">
                <button class="kebab" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Comment actions">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><button class="dropdown-item action-edit-reply"><i class="bi bi-pencil-square"></i> Edit</button></li>
                  <li><button class="dropdown-item text-danger action-delete-reply"><i class="bi bi-trash3"></i> Delete</button></li>
                </ul>
              </div>` : ``}
              <div class="name-line">${escapeHtml(name)} ${timeHtml(r.createdAt)}</div>
              <div class="fb-text wrap-anywhere">${escapeHtml(r.text || '')}</div>
              ${parentName ? `<div class="small text-muted mt-1">↪ Replying to <strong>${escapeHtml(parentName)}</strong></div>` : ``}
            </div>
            <div class="fb-actions">
              <span class="fb-action reply-btn"><i class="bi bi-reply"></i> Reply</span>
              ${childCount ? `<button class="btn btn-sm btn-link p-0 fb-toggle" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false"><i class="bi bi-chevron-down"></i> View ${childCount} repl${childCount>1?'ies':'y'}</button>` : ``}
            </div>
            ${childCount ? `<div class="collapse fb-children" id="${collapseId}"><div class="children-container"></div></div>` : ``}
          </div>`;

        container.appendChild(wrap);

        if (isOwn) {
          wrap.querySelector(".action-delete-reply")?.addEventListener("click", ()=> openReplyDeleteModal(r.id));
          wrap.querySelector(".action-edit-reply")?.addEventListener("click", ()=> openReplyEditModal(r));
        }

        wrap.querySelector(".reply-btn").addEventListener("click", ()=> showInlineReplyForm(r.id, wrap));

        if (childCount) {
          const childWrap = wrap.querySelector(".children-container");
          renderRepliesRecursive(r.children, childWrap, name);
          const toggleBtn = wrap.querySelector(`[data-bs-target="#${collapseId}"]`);
          const collapseEl = wrap.querySelector(`#${collapseId}`);
          collapseEl.addEventListener("show.bs.collapse", ()=>{ toggleBtn.innerHTML = `<i class="bi bi-chevron-up"></i> Hide replies`; });
          collapseEl.addEventListener("hide.bs.collapse", ()=>{ toggleBtn.innerHTML = `<i class="bi bi-chevron-down"></i> View ${childCount} repl${childCount>1?'ies':'y'}`; });
        }
      });
    }

    async function loadReplies(){
      try{
        const j = await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}/replies`);
        const flat = j.data || [];
        const tree = buildReplyTree(flat);
        const wrap = qs("#repliesList");
        const count = qs("#replyCount");
        wrap.innerHTML = '';
        count.textContent = `${flat.length} comment${flat.length===1?'':'s'}`;

        if (!flat.length) {
          wrap.innerHTML = `<div class="empty-state">No comments yet. Be the first to comment!</div>`;
          return;
        }
        renderRepliesRecursive(tree, wrap);
      } catch (e) {
        console.error(e);
        qs("#repliesList").innerHTML = `<div class="alert alert-danger">Failed to load comments.</div>`;
        qs("#replyCount").textContent = '0 comments';
      }
    }

    function showInlineReplyForm(parentId, replyDiv){
      const host = replyDiv.querySelector(".reply-form-container") || (() => {
        const c = document.createElement("div");
        c.className = "reply-form-container mt-2";
        replyDiv.querySelector(".fb-body").appendChild(c);
        return c;
      })();

      if (host.querySelector("form")) { host.innerHTML = ""; return; }

      const meName = __user.fullName || __user.username || __user.email || "Me";
      const meInit = initialsFrom(meName);

      host.innerHTML = `
        <form class="reply-inline-form" novalidate>
          <div class="fb-composer mt-2">
            <div class="fb-avatar" aria-hidden="true">${escapeHtml(meInit)}</div>
            <div class="flex-grow-1">
              <div class="composer-box">
                <textarea class="form-control form-control-sm border-0 bg-transparent p-0" rows="2" placeholder="Write a reply..." required></textarea>
                <div class="invalid-feedback">Please enter a reply.</div>
              </div>
              <div class="composer-actions">
                <button type="submit" class="btn btn-sm btn-amber mt-2">
                  <i class="bi bi-reply-fill me-1"></i> Reply
                </button>
              </div>
            </div>
          </div>
        </form>`;

      host.querySelector("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const ta = host.querySelector("textarea");
        if (!ta.value.trim()) { ta.classList.add('is-invalid'); return; }
        try {
          await postReply(ta.value.trim(), parentId);
          await loadReplies();
          const collapse = replyDiv.querySelector(".collapse");
          if (collapse && !collapse.classList.contains("show")) { new bootstrap.Collapse(collapse, { show: true }); }
        } catch (err) {
          console.error(err);
          alert("Could not post reply.");
        }
      });
    }

    async function postReply(text, parentId=null){
      await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}/replies`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text, parentId, author:{ uid:__user.uid } })
      });
    }

    // ===== Thread modal handlers =====
    function openThreadEditModal(){
      qs('#threadEditForm').classList.remove('was-validated');
      qs('#editThreadTitle').value = thread?.title || '';
      qs('#editThreadText').value  = thread?.text  || '';
      threadEditModal?.show();
    }
    async function saveThreadEdit(){
      const form = qs('#threadEditForm');
      form.classList.add('was-validated');
      const title = qs('#editThreadTitle').value.trim();
      const text  = qs('#editThreadText').value.trim();
      if (!title || title.length < 3 || !text || text.length < 5) return;

      try{
        await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title, text })
        });
        threadEditModal?.hide();
        await loadThread();
      }catch(err){
        console.error(err);
        alert('Failed to save changes.');
      }
    }

    async function confirmThreadDelete(){
      try{
        await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}`,{ method:'DELETE' });
        threadDeleteModal?.hide();
        window.location.href='forum.html';
      }catch(err){
        console.error(err);
        alert('Failed to delete thread.');
      }
    }

    // ===== Reply modal handlers =====
    function openReplyDeleteModal(replyId){ currentReplyId = replyId; replyDeleteModal?.show(); }
    async function confirmReplyDelete(){
      if (!currentReplyId) return;
      try{
        await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}/replies/${encodeURIComponent(currentReplyId)}`,{ method:'DELETE' });
        replyDeleteModal?.hide();
        currentReplyId = null;
        await loadReplies();
      }catch(err){
        console.error(err);
        alert('Failed to delete comment.');
      }
    }

    function openReplyEditModal(reply){
      currentReply = reply;
      qs('#replyEditForm').classList.remove('was-validated');
      qs('#editReplyText').value = reply?.text || '';
      replyEditModal?.show();
    }
    async function saveReplyEdit(){
      const form = qs('#replyEditForm');
      form.classList.add('was-validated');
      const updated = qs('#editReplyText').value.trim();
      if (!updated) return;

      try{
        await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}/replies/${encodeURIComponent(currentReply.id)}`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: updated })
        });
        replyEditModal?.hide();
        currentReply = null;
        await loadReplies();
      }catch(err){
        console.error(err);
        alert('Failed to save comment.');
      }
    }

    // Boot
    document.addEventListener("DOMContentLoaded", async ()=>{
      // Decide mode: thread or announcement
      if (!threadId && !annId) {
        qs('#threadDetails').innerHTML = `<div class="alert alert-warning">Missing thread ID or announcement ID.</div>`;
        qs('#commentsCard').style.display = 'none';
        return;
      }

      if (annId) {
        // Announcement detail mode (no extra announcement card)
        await loadAnnouncementDetail();
      } else {
        // Thread mode
        await loadThread();

        // Comment submit handler only in thread mode
        qs("#replyForm").addEventListener("submit", async (e)=>{
          e.preventDefault();
          const ta = qs("#replyText");
          if (!ta.value.trim()) { ta.classList.add('is-invalid'); return; }
          try {
            await postReply(ta.value.trim(), null);
            e.target.reset();
            ta.classList.remove('is-invalid');
            await loadReplies();
          } catch (err) {
            console.error(err);
            alert("Could not post comment.");
          }
        });
      }
    });

    function logoutUser(){ localStorage.clear(); sessionStorage.clear(); window.location.href = "/STUDENT/login/login.html"; }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
