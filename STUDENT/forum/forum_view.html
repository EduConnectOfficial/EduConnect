<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - View Thread</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="../forum/forum.css" />
  <style>
    /* Threaded Replies */
    .reply { padding: 10px 0; }
    .reply + .reply { border-top: 1px solid #eee; }
    .reply .reply { border-top: none; }
    .reply-thread { margin-top: 8px; border-left: 2px solid #ddd; padding-left: 15px; }
    .reply strong { font-size: 14px; }
    .reply .text-muted.small { font-size: 12px; }
    .reply .btn-link { font-size: 13px; }
  </style>
</head>
<body>
  <div class="dashboard">
    <div id="sidebar-container"></div>

    <div class="main">
      <header class="header-top">
        <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        <div class="search-box">
          <input type="text" placeholder="Search..." />
          <i class="bi bi-search"></i>
        </div>
        <button class="profile-btn">
          <i class="bi bi-person-circle"></i>
          <span id="Username" class="username" style="font-size: 14px;"></span>
        </button>
      </header>

      <div class="content container-fluid">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-10 col-xxl-8">

            <!-- THREAD -->
            <div class="ui-card card-themed mb-4" id="threadContainer">
              <div class="p-3 border-bottom" id="threadDetails">
                <div class="alert alert-info">Loading thread...</div>
              </div>
            </div>

            <!-- Comment Card -->
            <div class="ui-card card-themed">
              <div class="ui-card-head d-flex justify-content-between align-items-center">
                <h2 class="ui-card-title m-0"><i class="bi bi-chat-text"></i> Comments</h2>
                <span class="ui-subtext" id="replyCount"></span>
              </div>

              <!-- Top-level Comment Form -->
              <form id="replyForm" class="p-3 border-bottom">
                <div class="mb-3">
                  <textarea id="replyText" class="form-control" rows="3" placeholder="What are your thoughts?" required></textarea>
                </div>
                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-amber">Comment</button>
                </div>
              </form>

              <!-- Replies -->
              <div id="repliesList" class="p-3">
                <div class="text-muted">No comments yet.</div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar loader -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => { document.getElementById("sidebar-container").innerHTML = html; });
    });
  </script>

  <script>
    const API_BASE = (location.port === '5501')
      ? 'http://localhost:5000/api/forum'
      : '/api/forum';

    const qs = sel => document.querySelector(sel);

    function escapeHtml(str='') {
      return String(str).replace(/[&<>"']/g, s => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
      ));
    }

    function toLocal(dt) {
      if (!dt) return '';
      if (dt._seconds) return new Date(dt._seconds * 1000).toLocaleString();
      return new Date(dt).toLocaleString();
    }

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      let json;
      try { json = await res.json(); } catch { json = {}; }
      if (!res.ok) throw new Error(json.message || `HTTP ${res.status}`);
      return json;
    }

    const userData = JSON.parse(localStorage.getItem("user"));
    if (!userData || !userData.email) {
      window.location.href = "../login/login.html";
    } else {
  // === Initials-only header display ===
function initialsFrom(str) {
  if (!str) return "";
  const s = String(str).trim();
  if (!s) return "";

  // If email, take first + last token from local part
  if (s.includes("@")) {
    const local = s.split("@")[0];
    const parts = local.split(/[.\-_]+/).filter(Boolean);
    return (parts.length >= 2
      ? parts[0][0] + parts[parts.length - 1][0]
      : local.slice(0, 2)
    ).toUpperCase();
  }

  // Names or usernames: first + last token initials
  const parts = s.split(/[\s\-]+/).filter(Boolean);
  return (parts.length >= 2
    ? parts[0][0] + parts[parts.length - 1][0]
    : parts[0].slice(0, 2)
  ).toUpperCase();
}

const userData = JSON.parse(localStorage.getItem("user") || "{}");
const userId = userData.userId || userData.uid || userData.id || userData.email;

if (!userId) {
  window.location.href = "../login/login.html";
} else {
  const displayName = userData.fullName || userData.username || userData.email || "Student";
  const initials = initialsFrom(displayName) || "?";
  const el = document.getElementById("Username");
  el.textContent = initials;
  el.title = displayName;                 // tooltip with full name
  el.setAttribute("aria-label", displayName);

  if (!userData.uid) {
    userData.uid = userId;
    localStorage.setItem("user", JSON.stringify(userData));
  }
}

      if (!userData.uid) {
        userData.uid = userData.email;
        localStorage.setItem("user", JSON.stringify(userData));
      }
    }

    const threadId = new URLSearchParams(window.location.search).get("id");
    let thread = null;

    async function loadThread() {
      try {
        const j = await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}`);
        thread = j.data;

        const isOwner = userData?.uid && (thread.author?.uid === userData.uid);

        qs("#threadDetails").innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div class="me-3">
              <h3 class="mb-2">${escapeHtml(thread.title || '')}</h3>
              <p class="mb-3">${escapeHtml(thread.text || '')}</p>
              <div class="text-muted small">
                Posted by <strong>${escapeHtml(thread.author?.username || 'Unknown')}</strong>
                • ${escapeHtml(thread.courseTitle || '')}
                • ${toLocal(thread.createdAt)}
              </div>
            </div>
            ${isOwner ? `
              <button class="btn btn-outline-danger" id="deleteThreadBtn">
                <i class="bi bi-trash"></i> Delete
              </button>
            ` : ``}
          </div>
        `;

        if (isOwner) {
          qs("#deleteThreadBtn").addEventListener("click", async () => {
            if (!confirm("Delete this thread? This will also remove all comments and cannot be undone.")) return;
            try {
              await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}`, { method: 'DELETE' });
              // Back to list
              window.location.href = 'forum.html';
            } catch (err) {
              console.error(err);
              alert('Failed to delete thread.');
            }
          });
        }

        loadReplies();
      } catch (err) {
        console.error(err);
        qs("#threadDetails").innerHTML = `<div class="alert alert-danger">Failed to load thread.</div>`;
      }
    }

    function buildReplyTree(flat) {
      const map = {};
      flat.forEach(r => { r.children = []; map[r.id] = r; });

      const roots = [];
      flat.forEach(r => {
        if (r.parentId && map[r.parentId]) {
          map[r.parentId].children.push(r);
        } else {
          roots.push(r);
        }
      });

      roots.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
      function sortChildren(arr) {
        arr.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
        arr.forEach(c => sortChildren(c.children));
      }
      roots.forEach(r => sortChildren(r.children));
      return roots;
    }

    function renderRepliesRecursive(replies, container, level=0, parentAuthor=null) {
      replies.forEach(r => {
        const div = document.createElement("div");
        div.className = "reply";
        if (level > 0) div.classList.add("reply-thread");

        const collapseId = "replies-" + r.id;
        const isOwn = userData?.uid && (r.author?.uid === userData.uid);

        div.innerHTML = `
          <div class="mb-1 d-flex justify-content-between align-items-start">
            <div>
              <strong>${escapeHtml(r.author?.username || 'Unknown')}</strong>
              <span class="text-muted small">• ${toLocal(r.createdAt)}</span>
              ${parentAuthor ? `<div class="small text-muted mb-1">↪ Replying to <strong>@${escapeHtml(parentAuthor)}</strong></div>` : ""}
            </div>
            <div class="d-flex gap-2">
              ${isOwn ? `
                <button class="btn btn-sm btn-outline-danger delete-reply-btn" data-id="${r.id}" aria-label="Delete your comment">
                  <i class="bi bi-trash"></i>
                </button>
              ` : ``}
            </div>
          </div>

          <div class="mb-2">${escapeHtml(r.text || '')}</div>

          <button class="btn btn-sm btn-link p-0 text-muted reply-btn" data-id="${r.id}">
            <i class="bi bi-reply"></i> Reply
          </button>
          <div class="reply-form-container mt-2"></div>

          ${r.children.length ? `
            <button class="btn btn-sm btn-link p-0 text-muted mt-1 toggle-replies-btn"
                    data-bs-toggle="collapse"
                    data-bs-target="#${collapseId}"
                    aria-expanded="false">
              <i class="bi bi-chevron-down"></i> View ${r.children.length} repl${r.children.length>1?"ies":"y"}
            </button>
            <div class="collapse mt-2" id="${collapseId}">
              <div class="children-container"></div>
            </div>
          ` : ""}
        `;

        container.appendChild(div);

        // delete own comment
        if (isOwn) {
          div.querySelector(".delete-reply-btn").addEventListener("click", async () => {
            if (!confirm("Delete your comment?")) return;
            try {
              await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}/replies/${encodeURIComponent(r.id)}`, { method: 'DELETE' });
              await loadReplies();
            } catch (err) {
              console.error(err);
              alert("Failed to delete comment.");
            }
          });
        }

        // children
        if (r.children.length) {
          const childWrap = div.querySelector(".children-container");
          renderRepliesRecursive(r.children, childWrap, level+1, r.author?.username);

          const toggleBtn = div.querySelector(".toggle-replies-btn");
          const collapseEl = div.querySelector(`#${collapseId}`);
          collapseEl.addEventListener("show.bs.collapse", () => {
            toggleBtn.innerHTML = `<i class="bi bi-chevron-up"></i> Hide replies`;
          });
          collapseEl.addEventListener("hide.bs.collapse", () => {
            toggleBtn.innerHTML = `<i class="bi bi-chevron-down"></i> View ${r.children.length} repl${r.children.length>1?"ies":"y"}`;
          });
        }

        // reply form
        div.querySelector(".reply-btn").addEventListener("click", () => showReplyForm(r.id, div));
      });
    }

    async function loadReplies() {
      try {
        const j = await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}/replies`);
        const flatReplies = j.data || [];

        const tree = buildReplyTree(flatReplies);
        const wrap = qs("#repliesList");
        const count = qs("#replyCount");
        wrap.innerHTML = '';
        count.textContent = `${flatReplies.length} comment${flatReplies.length===1?'':'s'}`;

        if (!flatReplies.length) {
          wrap.innerHTML = `<div class="text-muted">No comments yet.</div>`;
          return;
        }

        renderRepliesRecursive(tree, wrap);
      } catch (err) {
        console.error(err);
        qs("#repliesList").innerHTML = `<div class="alert alert-danger">Failed to load comments.</div>`;
      }
    }

    function showReplyForm(parentId, replyDiv) {
      const container = replyDiv.querySelector(".reply-form-container");
      if (container.querySelector("form")) { container.innerHTML = ""; return; }
      container.innerHTML = `
        <form class="nested-reply-form">
          <div class="mb-2">
            <textarea class="form-control form-control-sm" rows="2" placeholder="Write a reply..." required></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-sm btn-amber">Reply</button>
          </div>
        </form>
      `;
      container.querySelector("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = e.target.querySelector("textarea").value.trim();
        if (!text) return;
        try {
          await postReply(text, parentId);
          await loadReplies();

          const collapse = replyDiv.querySelector(".collapse");
          if (collapse && !collapse.classList.contains("show")) {
            new bootstrap.Collapse(collapse, { show: true });
          }
        } catch (err) {
          console.error(err);
          alert("Could not post reply.");
        }
      });
    }

    async function postReply(text, parentId = null) {
      await fetchJSON(`${API_BASE}/threads/${encodeURIComponent(threadId)}/replies`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text,
          parentId,
          author: {
            uid: userData.uid,
            username: userData.username,
            email: userData.email
          }
        }),
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (!threadId) { alert('Missing thread ID.'); return; }
      loadThread();
      qs("#replyForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = qs("#replyText").value.trim();
        if (!text) return;
        try {
          await postReply(text);
          e.target.reset();
          await loadReplies();
        } catch (err) {
          console.error(err);
          alert("Could not post comment.");
        }
      });
    });
    function logoutUser() {
      localStorage.clear(); sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
