<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Discussion Forum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional: override if API is a separate Railway service -->
  <!-- <meta name="x-api-base" content="https://your-api.up.railway.app"> -->

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Sidebar / shared styles -->
  <link rel="stylesheet" href="../forum/forum.css" />

  <style>
    .wrap-anywhere{overflow-wrap:anywhere}
    .thread + .thread{margin-top:.75rem}
    .skeleton{position:relative;border-radius:.5rem;background:#eef2f7;overflow:hidden;min-height:56px}
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);transform:translateX(-100%);animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
    .empty-state{padding:1rem;border:1px dashed #d9dee3;border-radius:.75rem;color:#6c757d;background:#fafbfc}
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- HEADER -->
      <header class="header-top">
        <div class="brand">
          <!-- Use relative paths so they work on Railway subpaths -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input id="globalSearch" type="text" placeholder="Search..." aria-label="Search site"/>
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn" aria-label="Open profile menu">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username" style="font-size:14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title">Discussion Forum</h1>

        <!-- Ask a Question -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-question-circle"></i> Ask a Question</h2>
          </div>
          <form id="questionForm" class="px-3 pb-3" novalidate>
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label for="moduleSelect" class="form-label">Course</label>
                <select id="moduleSelect" class="form-select" required>
                  <option value="">-- Choose Course --</option>
                </select>
                <div class="invalid-feedback">Please choose a course you’re enrolled in.</div>
              </div>
              <div class="col-12 col-md-8">
                <label for="questionTitle" class="form-label">Question Title</label>
                <input id="questionTitle" class="form-control" type="text" placeholder="e.g., Confused about Big-O notation" required minlength="3" />
                <div class="invalid-feedback">Title must be at least 3 characters.</div>
              </div>
              <div class="col-12">
                <label for="questionBody" class="form-label">Body</label>
                <textarea id="questionBody" class="form-control" rows="4" placeholder="Describe your question in detail…" required minlength="5"></textarea>
                <div class="form-text">Be clear and include what you’ve tried.</div>
                <div class="invalid-feedback">Body must be at least 5 characters.</div>
              </div>
              <div class="col-12 d-flex justify-content-end">
                <button id="postBtn" type="submit" class="btn btn-amber">
                  <i class="bi bi-send me-1"></i> Post Question
                </button>
              </div>
            </div>
          </form>
        </div>

        <!-- Controls: search + filter + sort -->
        <div class="ui-card card-themed mb-3">
          <div class="row g-2 align-items-end px-3 pb-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="threadSearch">Search Threads</label>
              <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                  <i class="bi bi-search text-muted"></i>
                </span>
                <input id="threadSearch" type="search" class="form-control border-start-0" placeholder="Search by title..." />
              </div>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label" for="courseFilter">Course</label>
              <select id="courseFilter" class="form-select">
                <option value="All">All</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label" for="sortThreads">Sort by</label>
              <select id="sortThreads" class="form-select">
                <option value="newest">Newest</option>
                <option value="replies">Most Replies</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Threads List -->
        <div class="ui-card card-themed">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-chat-dots"></i> Recent Threads</h2>
            <div class="ui-subtext" id="threadCount">Loading…</div>
          </div>
          <div id="forumThreads" class="px-3 pb-3">
            <div class="skeleton rounded-3"></div>
            <div class="skeleton rounded-3 mt-2"></div>
            <div class="skeleton rounded-3 mt-2"></div>
          </div>
        </div>
      </div> <!-- /content -->
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Relative include so it works under Railway subpaths
      fetch("/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

  <!-- Page Logic -->
  <script>
    /* ========= API base (Railway-safe) ========= */
    function resolveApiBase() {
      const meta = document.querySelector('meta[name="x-api-base"]');
      const override = meta?.content?.trim();
      if (override) return override.replace(/\/+$/, '');
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return 'http://localhost:5000';
      return ''; // same-origin in production
    }
    const API_BASE   = resolveApiBase();
    const CORE_API   = API_BASE;                 // core routes (students/courses)
    const FORUM_API  = `${API_BASE}/api/forum`;  // forum routes

    /* ========= Helpers ========= */
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function escapeHtml(str='') {
      return String(str).replace(/[&<>"']/g, s => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
      ));
    }
    function toLocal(dt) {
      if (!dt) return '';
      if (dt._seconds) return new Date(dt._seconds * 1000).toLocaleString();
      return new Date(dt).toLocaleString();
    }
    function debounce(fn, ms=300){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    // Robust fetch that verifies JSON
    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      const text = await res.text();
      const ct = res.headers.get('content-type') || '';
      let json = {};
      if (ct.includes('application/json')) {
        try { json = JSON.parse(text || '{}'); } catch {}
      }
      if (!res.ok || json.success === false) {
        const msg = json.message || `${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return json;
    }

    /* ========= Auth + header initials ========= */
    (function authGuard(){
      const u = JSON.parse(localStorage.getItem("user") || "{}");
      const userId = u.userId || u.uid || u.id || u.email;
      if (!userId) {
        window.location.href = "../login/login.html";
        return;
      }
      function initialsFrom(str) {
        if (!str) return "";
        const s = String(str).trim(); if (!s) return "";
        if (s.includes("@")) {
          const local = s.split("@")[0];
          const parts = local.split(/[.\-_]+/).filter(Boolean);
          return (parts.length >= 2 ? parts[0][0] + parts[parts.length-1][0] : local.slice(0,2)).toUpperCase();
        }
        const parts = s.split(/[\s\-]+/).filter(Boolean);
        return (parts.length >= 2 ? parts[0][0] + parts[parts.length-1][0] : parts[0].slice(0,2)).toUpperCase();
      }
      const elU = document.getElementById("Username");
      const displayName = u.fullName || u.username || u.email || "Student";
      elU.textContent = initialsFrom(displayName) || "?";
      elU.title = displayName;
      elU.setAttribute("aria-label", displayName);
      if (!u.uid) {
        u.uid = userId;
        localStorage.setItem("user", JSON.stringify(u));
      }
      window.__user = u; // expose to rest of page
    })();

    /* ========= State ========= */
    let courses = [];
    const coursesById = new Map();
    const enrolledCourseIds = new Set();
    let threads = [];
    let lastQuery = { courseId:'', q:'', sort:'newest' };

    /* ========= Load ONLY enrolled courses ========= */
    async function loadCourses() {
      const userId = __user.uid || __user.userId || __user.email;
      const j = await fetchJSON(`${CORE_API}/api/students/${encodeURIComponent(userId)}/courses?includeTeacher=true`);
      const list = Array.isArray(j?.courses) ? j.courses
                 : Array.isArray(j?.data)     ? j.data
                 : Array.isArray(j)           ? j
                 : [];

      courses = list;
      coursesById.clear();
      enrolledCourseIds.clear();

      const moduleSelect = $("#moduleSelect");
      const courseFilter = $("#courseFilter");
      moduleSelect.innerHTML = `<option value="">-- Choose Course --</option>`;
      courseFilter.innerHTML = `<option value="All">All</option>`;

      list.forEach(c => {
        if (!c?.id) return;
        enrolledCourseIds.add(c.id);
        coursesById.set(c.id, c);
        const title = c.title || c.name || "Untitled Course";
        moduleSelect.insertAdjacentHTML('beforeend', `<option value="${c.id}">${escapeHtml(title)}</option>`);
        courseFilter.insertAdjacentHTML('beforeend', `<option value="${c.id}">${escapeHtml(title)}</option>`);
      });

      if (list.length === 0) {
        moduleSelect.disabled = true;
        $("#postBtn").disabled = true;
      }
    }

    /* ========= Load threads (server search) and hard-filter to enrolled ========= */
    async function loadThreads() {
      const filterVal = $('#courseFilter').value;
      const courseId = (filterVal && filterVal !== 'All') ? filterVal : '';
      const q = $('#threadSearch').value.trim();
      const sort = $('#sortThreads').value || 'newest';

      const sig = JSON.stringify({ courseId, q, sort });
      if (sig === JSON.stringify(lastQuery) && threads.length) return;
      lastQuery = { courseId, q, sort };

      const params = new URLSearchParams({ courseId, q, sort, limit: '50' });

      const wrap = $('#forumThreads');
      wrap.innerHTML = `<div class="skeleton rounded-3"></div>
                        <div class="skeleton rounded-3 mt-2"></div>`;

      try {
        const j = await fetchJSON(`${FORUM_API}/threads?${params.toString()}`);
        let arr = j.data || [];
        arr = arr.filter(t => enrolledCourseIds.has(t.courseId));
        if (courseId) arr = arr.filter(t => t.courseId === courseId);
        threads = arr;
        renderThreads();
      } catch (e) {
        console.error(e);
        $('#threadCount').textContent = '0 threads';
        wrap.innerHTML = `<div class="empty-state">Forum API unreachable or returned an error.</div>`;
      }
    }

    function renderThreads() {
      const wrap = $('#forumThreads');
      const count = $('#threadCount');
      wrap.innerHTML = '';
      count.textContent = `${threads.length} thread${threads.length !== 1 ? 's' : ''}`;

      if (!threads.length) {
        wrap.innerHTML = `<div class="empty-state">No threads match your filters yet. Be the first to ask a question!</div>`;
        return;
      }

      threads.forEach(t => {
        const followed = Array.isArray(t.followers) && __user?.uid
          ? t.followers.includes(__user.uid) : false;

        const courseTitle = t.courseTitle
          || coursesById.get(t.courseId)?.title
          || coursesById.get(t.courseId)?.name
          || '';

        const div = document.createElement('div');
        div.className = 'thread thread-themed';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-1">
            <h3 class="thread-title wrap-anywhere">${escapeHtml(t.title || '')}</h3>
            <div class="d-flex gap-2">
              <button class="btn btn-amber view-btn" data-id="${t.id}">
                <i class="bi bi-eye"></i> View
              </button>
              <button class="btn btn-sm btn-amber-outline follow-btn ${followed ? 'active' : ''}" data-id="${t.id}">
                <i class="bi ${followed ? 'bi-bookmark-fill' : 'bi-bookmark'} me-1"></i>
                ${followed ? 'Following' : 'Follow'}
              </button>
            </div>
          </div>
          <div class="thread-meta mb-2">
            Course: <strong class="wrap-anywhere">${escapeHtml(courseTitle)}</strong> •
            Replies: ${t.repliesCount || 0} •
            Posted: ${toLocal(t.createdAt)}
          </div>
        `;
        wrap.appendChild(div);
      });

      // follow toggle
      wrap.querySelectorAll('.follow-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const wasActive = btn.classList.contains('active');

          // optimistic UI
          btn.disabled = true;
          btn.classList.toggle('active', !wasActive);
          btn.innerHTML = `<i class="bi ${!wasActive ? 'bi-bookmark-fill' : 'bi-bookmark'} me-1"></i>${!wasActive ? 'Following' : 'Follow'}`;

          try {
            await fetchJSON(`${FORUM_API}/threads/${id}/follow`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ uid: __user.uid }),
            });
          } catch (err) {
            // revert on error
            btn.classList.toggle('active', wasActive);
            btn.innerHTML = `<i class="bi ${wasActive ? 'bi-bookmark-fill' : 'bi-bookmark'} me-1"></i>${wasActive ? 'Following' : 'Follow'}`;
            alert('Could not update follow state.');
          } finally {
            btn.disabled = false;
          }
        });
      });

      // view button redirect
      wrap.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          window.location.href = `forum_view.html?id=${encodeURIComponent(id)}`;
        });
      });
    }

    async function postThread({ courseId, title, body }) {
      if (!enrolledCourseIds.has(courseId)) {
        throw new Error('Please select a course you are enrolled in.');
      }
      await fetchJSON(`${FORUM_API}/threads`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title.trim(),
          text: body.trim(),           // backend expects 'text'
          courseId,
          author: {
            uid: __user.uid,
            username: __user.username,
            email: __user.email
          }
        }),
      });
    }

    // Boot
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadCourses();
        await loadThreads();
      } catch (e) {
        console.error(e);
        $('#forumThreads').innerHTML = `<div class="empty-state">Forum API unreachable.</div>`;
        $('#threadCount').textContent = `0 threads`;
      }

      const debouncedLoad = debounce(loadThreads, 300);
      $('#threadSearch').addEventListener('input', debouncedLoad);
      $('#courseFilter').addEventListener('change', loadThreads);
      $('#sortThreads').addEventListener('change', loadThreads);

      // Ask form
      $('#questionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        form.classList.add('was-validated');

        const courseId = $("#moduleSelect").value;
        const title = ($("#questionTitle").value || '').trim();
        const body  = ($("#questionBody").value  || '').trim();

        if (!courseId || title.length < 3 || body.length < 5) return;

        const btn = $('#postBtn');
        const prevHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Posting…`;

        try {
          await postThread({ courseId, title, body });
          form.reset();
          form.classList.remove('was-validated');
          await loadThreads();
        } catch (err) {
          console.error(err);
          alert(err.message || 'Could not post your question.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = prevHTML;
        }
      });
    });

    // Optional logout hook
    function logoutUser() {
      localStorage.clear(); sessionStorage.clear();
      window.location.href = "login/login.html";
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
