<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduConnect Student - Discussion Forum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Sidebar / shared styles -->
  <link rel="stylesheet" href="../forum/forum.css" />
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main -->
    <div class="main">
      <!-- HEADER -->
      <header class="header-top">
         <div class="brand">
          <!-- CSIS logo beside EduConnect -->
          <img src="/components/CSIS_Logo.png" alt="CSIS Logo" class="school-logo" />
          <img src="/assets/educonnect_logo.png" alt="EduConnect Logo" class="logo-header" />
        </div>
        <div class="search-box">
          <input type="text" placeholder="Search..." aria-label="Search site"/>
          <i class="fas fa-search"></i>
        </div>
        <button class="profile-btn" aria-label="Open profile menu">
          <i class="fas fa-user-circle"></i>
          <span id="Username" class="username" style="font-size:14px;"></span>
        </button>
      </header>

      <!-- Content -->
      <div class="content container-fluid">
        <h1 class="page-title brand">Discussion Forum</h1>

        <!-- Ask a Question -->
        <div class="ui-card card-themed mb-3">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-question-circle"></i> Ask a Question</h2>
          </div>
          <form id="questionForm" class="px-3 pb-3">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label for="moduleSelect" class="form-label">Course</label>
                <select id="moduleSelect" class="form-select" required>
                  <option value="">-- Choose Course --</option>
                </select>
              </div>
              <div class="col-12 col-md-8">
                <label for="questionTitle" class="form-label">Question Title</label>
                <input id="questionTitle" class="form-control" type="text" placeholder="e.g., Confused about Big-O notation" required />
              </div>
              <div class="col-12">
                <label for="questionBody" class="form-label">Body</label>
                <textarea id="questionBody" class="form-control" rows="4" placeholder="Describe your question in detail…" required></textarea>
                <div class="form-text">Be clear and include what you’ve tried.</div>
              </div>
              <div class="col-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-amber">Post Question</button>
              </div>
            </div>
          </form>
        </div>

        <!-- Controls: search + filter + sort -->
        <div class="ui-card card-themed mb-3">
          <div class="row g-2 align-items-end px-3 pb-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="threadSearch">Search Threads</label>
              <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                <input id="threadSearch" type="search" class="form-control border-start-0" placeholder="Search by title or content..." />
              </div>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label" for="courseFilter">Course</label>
              <select id="courseFilter" class="form-select">
                <option value="All">All</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label" for="sortThreads">Sort by</label>
              <select id="sortThreads" class="form-select">
                <option value="newest">Newest</option>
                <option value="replies">Most Replies</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Threads List -->
        <div class="ui-card card-themed">
          <div class="ui-card-head">
            <h2 class="ui-card-title"><i class="bi bi-chat-dots"></i> Recent Threads</h2>
            <div class="ui-subtext" id="threadCount"></div>
          </div>
          <div id="forumThreads" class="px-3 pb-3"></div>
        </div>
      </div> <!-- /content -->
    </div>
  </div>

  <!-- Sidebar Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/STUDENT/components/sidebar.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("sidebar-container").innerHTML = html;

          const sidebar = document.querySelector(".sidebar");
          const dashboard = document.querySelector(".dashboard");
          if (sidebar && dashboard) {
            sidebar.addEventListener("mouseenter", () => dashboard.classList.add("sidebar-expanded"));
            sidebar.addEventListener("mouseleave", () => dashboard.classList.remove("sidebar-expanded"));
          }

          document.querySelectorAll('.has-submenu .submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
              e.preventDefault();
              const parent = toggle.closest('.has-submenu');
              parent.classList.toggle('open');
              const expanded = toggle.getAttribute('aria-expanded') === 'true';
              toggle.setAttribute('aria-expanded', String(!expanded));
            });
          });
        })
        .catch(err => console.error("Failed to load sidebar:", err));
    });
  </script>

<script>
  // API bases
  const FORUM_API = (location.port === '5501')
    ? 'http://localhost:5000/api/forum'
    : '/api/forum';

  // Core API (for student enrollments, same endpoint your quiz page uses)
  const CORE_API = (location.port === '5501')
    ? 'http://localhost:5000'
    : '';

  // Helpers
  const qs = sel => document.querySelector(sel);

  function escapeHtml(str='') {
    return String(str).replace(/[&<>"']/g, s => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
    ));
  }

  function toLocal(dt) {
    if (!dt) return '';
    if (dt._seconds) return new Date(dt._seconds * 1000).toLocaleString();
    return new Date(dt).toLocaleString();
  }

  // Robust fetch that throws if response isn't JSON
  async function fetchJSON(url, opts) {
    const res = await fetch(url, opts);
    const ct = res.headers.get('content-type') || '';
    const text = await res.text();
    if (!ct.includes('application/json')) {
      throw new Error(`Expected JSON, got ${res.status} ${res.statusText}. Body starts with: ${text.slice(0,120)}`);
    }
    const json = JSON.parse(text || '{}');
    if (!res.ok || json.success === false) {
      throw new Error(json.message || `HTTP ${res.status}`);
    }
    return json;
  }

  // Auth (match quiz page style)
  const userData = JSON.parse(localStorage.getItem("user") || "{}");
  const userId = userData.userId || userData.uid || userData.id || userData.email;
  if (!userId) {
    window.location.href = "../login/login.html";
  } else {
    // === Initials-only header display ===
function initialsFrom(str) {
  if (!str) return "";
  const s = String(str).trim();
  if (!s) return "";

  // If email, take first + last token from local part
  if (s.includes("@")) {
    const local = s.split("@")[0];
    const parts = local.split(/[.\-_]+/).filter(Boolean);
    return (parts.length >= 2
      ? parts[0][0] + parts[parts.length - 1][0]
      : local.slice(0, 2)
    ).toUpperCase();
  }

  // Names or usernames: first + last token initials
  const parts = s.split(/[\s\-]+/).filter(Boolean);
  return (parts.length >= 2
    ? parts[0][0] + parts[parts.length - 1][0]
    : parts[0].slice(0, 2)
  ).toUpperCase();
}

const userData = JSON.parse(localStorage.getItem("user") || "{}");
const userId = userData.userId || userData.uid || userData.id || userData.email;

if (!userId) {
  window.location.href = "../login/login.html";
} else {
  const displayName = userData.fullName || userData.username || userData.email || "Student";
  const initials = initialsFrom(displayName) || "?";
  const el = document.getElementById("Username");
  el.textContent = initials;
  el.title = displayName;                 // tooltip with full name
  el.setAttribute("aria-label", displayName);

  if (!userData.uid) {
    userData.uid = userId;
    localStorage.setItem("user", JSON.stringify(userData));
  }
}

    if (!userData.uid) {
      userData.uid = userId; // follow/favorite uses uid
      localStorage.setItem("user", JSON.stringify(userData));
    }
  }

  // State
  let courses = [];
  const coursesById = new Map();
  const enrolledCourseIds = new Set();
  let threads = [];

  // Load ONLY enrolled courses
  async function loadCourses() {
    const j = await fetchJSON(`${CORE_API}/api/students/${encodeURIComponent(userId)}/courses?includeTeacher=true`);
    const list = Array.isArray(j?.courses) ? j.courses
               : Array.isArray(j?.data)     ? j.data
               : Array.isArray(j)           ? j
               : [];

    courses = list;
    coursesById.clear();
    enrolledCourseIds.clear();

    const moduleSelect = qs("#moduleSelect");
    const courseFilter = qs("#courseFilter");

    moduleSelect.innerHTML = `<option value="">-- Choose Course --</option>`;
    courseFilter.innerHTML = `<option value="All">All</option>`;

    list.forEach(c => {
      if (!c?.id) return;
      enrolledCourseIds.add(c.id);
      coursesById.set(c.id, c);

      const title = c.title || c.name || "Untitled Course";
      moduleSelect.insertAdjacentHTML('beforeend', `<option value="${c.id}">${escapeHtml(title)}</option>`);
      courseFilter.insertAdjacentHTML('beforeend', `<option value="${c.id}">${escapeHtml(title)}</option>`);
    });

    if (list.length === 0) {
      moduleSelect.disabled = true;
      qs('#questionForm .btn').disabled = true;
    }
  }

  // Load threads and filter to enrolled courses
  async function loadThreads() {
    const filterVal = qs('#courseFilter').value;
    const courseId = (filterVal && filterVal !== 'All') ? filterVal : '';
    const q = qs('#threadSearch').value || '';
    const sort = qs('#sortThreads').value || 'newest';

    const params = new URLSearchParams({ courseId, q, sort, limit: '50' });
    const j = await fetchJSON(`${FORUM_API}/threads?${params.toString()}`);

    let arr = j.data || [];
    // Ensure we only show threads from courses the student is enrolled in
    arr = arr.filter(t => enrolledCourseIds.has(t.courseId));
    if (courseId) arr = arr.filter(t => t.courseId === courseId);

    threads = arr;
    renderThreads();
  }

function renderThreads() {
  const wrap = qs('#forumThreads');
  const count = qs('#threadCount');
  wrap.innerHTML = '';
  count.textContent = `${threads.length} thread${threads.length !== 1 ? 's' : ''}`;

  threads.forEach(t => {
    const followed = Array.isArray(t.followers) && userData?.uid ? t.followers.includes(userData.uid) : false;

    const courseTitle = t.courseTitle
      || coursesById.get(t.courseId)?.title
      || coursesById.get(t.courseId)?.name
      || '';

    const div = document.createElement('div');
    div.className = 'thread thread-themed';
    div.innerHTML = `
      <div class="d-flex justify-content-between align-items-start mb-1">
        <h3 class="thread-title">${escapeHtml(t.title || '')}</h3>
        <div class="d-flex gap-2">
          <button class="btn btn-amber view-btn" data-id="${t.id}">
            <i class="bi bi-eye"></i> View
          </button>
          <button class="btn btn-sm btn-amber-outline follow-btn ${followed ? 'active' : ''}" data-id="${t.id}">
            <i class="bi ${followed ? 'bi-bookmark-fill' : 'bi-bookmark'} me-1"></i>
            ${followed ? 'Following' : 'Follow'}
          </button>
        </div>
      </div>
      <!-- Removed thread body text -->
      <div class="thread-meta mb-2">
        Course: <strong>${escapeHtml(courseTitle)}</strong> •
        Replies: ${t.repliesCount || 0} •
        Posted: ${toLocal(t.createdAt)}
      </div>
    `;

    wrap.appendChild(div);
  });

  // follow toggle
  wrap.querySelectorAll('.follow-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      try {
        await fetchJSON(`${FORUM_API}/threads/${id}/follow`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: userData.uid }),
        });
        await loadThreads();
      } catch (err) {
        console.error(err);
        alert('Could not update follow state.');
      }
    });
  });

  // view button redirect
  wrap.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      window.location.href = `forum_view.html?id=${id}`;
    });
  });
}


  async function postThread({ courseId, title, body }) {
    if (!enrolledCourseIds.has(courseId)) {
      alert('Please select a course you are enrolled in.');
      return;
    }

    await fetchJSON(`${FORUM_API}/threads`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: title.trim(),
        text: body.trim(),           // backend expects 'text' for the body
        courseId,
        author: {
          uid: userData.uid,
          username: userData.username,
          email: userData.email
        }
      }),
    });
  }

  // Boot
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await loadCourses();   // enrolled only
      await loadThreads();   // filtered to enrolled
    } catch (e) {
      console.error(e);
      qs('#forumThreads').innerHTML = `<div class="alert alert-warning">Forum API unreachable.</div>`;
      qs('#threadCount').textContent = `0 threads`;
    }

    qs('#threadSearch').addEventListener('input', loadThreads);
    qs('#courseFilter').addEventListener('change', loadThreads);
    qs('#sortThreads').addEventListener('change', loadThreads);

    qs('#questionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const courseId = qs("#moduleSelect").value;
      const title = (qs("#questionTitle").value || '').trim();
      const body  = (qs("#questionBody").value  || '').trim();

      if (!courseId) return alert('Please choose a course.');
      if (title.length < 3) return alert('Please enter a longer title (at least 3 characters).');
      if (body.length < 5) return alert('Please add more details to the body (at least 5 characters).');

      try {
        await postThread({ courseId, title, body });
        e.target.reset();
        await loadThreads();
      } catch (err) {
        console.error(err);
        alert('Could not post your question.');
      }
    });
  });
  function logoutUser() {
      localStorage.clear(); sessionStorage.clear();
      window.location.href = "/STUDENT/login/login.html";
    }
</script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
